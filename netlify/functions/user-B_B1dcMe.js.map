{"version":3,"file":"user-B_B1dcMe.js","names":[],"sources":["../../lib/routes/changba/user.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nconst headers = { 'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1' };\r\n\r\nexport const route: Route = {\r\n    path: '/:userid',\r\n    categories: ['social-media'],\r\n    view: ViewType.Audios,\r\n    example: '/changba/skp6hhF59n48R-UpqO3izw',\r\n    parameters: { userid: '用户ID, 可在对应分享页面的 URL 中找到' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: true,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['changba.com/s/:userid'],\r\n        },\r\n    ],\r\n    name: '用户',\r\n    maintainers: ['kt286', 'xizeyoupan', 'pseudoyu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const userid = ctx.req.param('userid');\r\n    const url = `https://changba.com/wap/index.php?s=${userid}`;\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n        headers,\r\n    });\r\n    const data = response.data;\r\n    const $ = load(data);\r\n    const list = $('.user-work .work-info').toArray();\r\n    const author = $('div.user-main-info > span.txt-info > a.uname').text();\r\n    const authorimg = $('div.user-main-info > .poster > img').attr('data-src');\r\n\r\n    let items = await Promise.all(\r\n        list.map((item) => {\r\n            const $ = load(item);\r\n            const link = $('a').attr('href');\r\n            return cache.tryGet(link, async () => {\r\n                const result = await got({\r\n                    method: 'get',\r\n                    url: link,\r\n                    headers,\r\n                });\r\n\r\n                const re = /workid: '\\d+'/;\r\n                let workid;\r\n                try {\r\n                    workid = result.data.match(re)[0];\r\n                } catch {\r\n                    // 没有找到该作品\r\n                    // 这可能是由下列原因造成的：\r\n                    // 该作品已经被原作者删除了\r\n                    // 该作品包含了视频，目前正在审核中，在审核没有通过前无法被播放\r\n                    // 目前服务器压力太大，刚刚上传成功的作品可能需要半个小时后才能被播放\r\n                    return null;\r\n                }\r\n\r\n                workid = workid.split(\"'\")[1];\r\n\r\n                if (!workid) {\r\n                    return null;\r\n                }\r\n                const mp3 = `https://upscuw.changba.com/${workid}.mp3`;\r\n                const description = art(path.join(__dirname, 'templates/work_description.art'), {\r\n                    desc: $('div.des').text(),\r\n                    mp3url: mp3,\r\n                });\r\n                const itunes_item_image = $('div.work-cover').attr('style').replace(')', '').split('url(')[1];\r\n                return {\r\n                    title: $('.work-title').text(),\r\n                    description,\r\n                    link,\r\n                    author,\r\n                    itunes_item_image,\r\n                    enclosure_url: mp3,\r\n                    enclosure_type: 'audio/mpeg',\r\n                };\r\n            });\r\n        })\r\n    );\r\n\r\n    items = items.filter(Boolean);\r\n\r\n    return {\r\n        title: author + ' - 唱吧',\r\n        link: url,\r\n        description: $('meta[name=\"description\"]').attr('content') || author + ' - 唱吧',\r\n        item: items,\r\n        image: authorimg,\r\n        itunes_author: author,\r\n        itunes_category: '唱吧',\r\n    };\r\n}\r\n"],"mappings":"kdAOA,MAAM,EAAU,CAAE,aAAc,2IAEnB,EAAe,CACxB,KAAM,WACN,WAAY,CAAC,gBACb,KAAM,EAAS,OACf,QAAS,kCACT,WAAY,CAAE,OAAQ,2BACtB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,2BAGjB,KAAM,KACN,YAAa,CAAC,QAAS,aAAc,YACrC,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAI,IAAI,MAAM,UACvB,EAAM,uCAAuC,IAC7C,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,MACA,YAEE,EAAO,EAAS,KAChB,EAAI,EAAK,GACT,EAAO,EAAE,yBAAyB,UAClC,EAAS,EAAE,gDAAgD,OAC3D,EAAY,EAAE,sCAAsC,KAAK,YAE3D,EAAQ,MAAM,QAAQ,IACtB,EAAK,IAAK,GAAS,CACf,IAAM,EAAI,EAAK,GACT,EAAO,EAAE,KAAK,KAAK,QACzB,OAAO,EAAM,OAAO,EAAM,SAAY,CAClC,IAAM,EAAS,MAAM,EAAI,CACrB,OAAQ,MACR,IAAK,EACL,YAGE,EAAK,gBACP,EACJ,GAAI,CACA,EAAS,EAAO,KAAK,MAAM,GAAI,QAC3B,CAMJ,OAAO,KAKX,GAFA,EAAS,EAAO,MAAM,KAAK,GAEvB,CAAC,EACD,OAAO,KAEX,IAAM,EAAM,8BAA8B,EAAO,MAC3C,EAAc,EAAI,EAAA,KAAA,EAAA,2CAAwD,CAC5E,KAAM,EAAE,WAAW,OACnB,OAAQ,IAEN,EAAoB,EAAE,kBAAkB,KAAK,SAAS,QAAQ,IAAK,IAAI,MAAM,QAAQ,GAC3F,MAAO,CACH,MAAO,EAAE,eAAe,OACxB,cACA,OACA,SACA,oBACA,cAAe,EACf,eAAgB,mBAQhC,MAFA,GAAQ,EAAM,OAAO,SAEd,CACH,MAAO,EAAS,QAChB,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,YAAc,EAAS,QACvE,KAAM,EACN,MAAO,EACP,cAAe,EACf,gBAAiB"}