{"version":3,"file":"journals-D356KeYe.js","names":["route: Route","got","parser","items","$","code","date","title","cache"],"sources":["../../lib/routes/cnki/journals.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { ProcessItem } from './utils';\r\nimport parser from '@/utils/rss-parser';\r\nimport logger from '@/utils/logger';\r\n\r\nconst rootUrl = 'https://navi.cnki.net';\r\n\r\nexport const route: Route = {\r\n    path: '/journals/:name',\r\n    categories: ['journal'],\r\n    example: '/cnki/journals/LKGP',\r\n    parameters: { name: '期刊缩写，可以在网址中得到' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['navi.cnki.net/knavi/journals/:name/detail'],\r\n        },\r\n    ],\r\n    name: '期刊',\r\n    maintainers: ['Fatpandac', 'Derekmini', 'pseudoyu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const name = ctx.req.param('name');\r\n    const rssUrl = `https://rss.cnki.net/kns/rss.aspx?Journal=${name}&Virtual=knavi`;\r\n\r\n    const rssResponse = await got.get(rssUrl);\r\n\r\n    try {\r\n        const feed = await parser.parseString(rssResponse.data);\r\n\r\n        if (feed.items && feed.items.length !== 0) {\r\n            const items = feed.items.map((item) => ({\r\n                title: item.title,\r\n                description: item.content,\r\n                pubDate: parseDate(item.pubDate),\r\n                link: item.link,\r\n                author: item.author,\r\n            }));\r\n\r\n            return {\r\n                title: feed.title,\r\n                link: feed.link,\r\n                description: feed.description,\r\n                item: items,\r\n            };\r\n        }\r\n    } catch (error) {\r\n        logger.error(error);\r\n    }\r\n\r\n    const journalUrl = `${rootUrl}/knavi/journals/${name}/detail`;\r\n    const title = await got.get(journalUrl).then((res) => load(res.data)('head > title').text());\r\n\r\n    const yearListUrl = `${rootUrl}/knavi/journals/${name}/yearList?pIdx=0`;\r\n\r\n    const { code, date } = await got.get(yearListUrl).then((res) => {\r\n        const $ = load(res.data);\r\n        const code = $('.yearissuepage').find('dl').first().find('dd').find('a').first().attr('value');\r\n        const date = parseDate($('.yearissuepage').find('dl').first().find('dd').find('a').first().attr('id').replace('yq', ''), 'YYYYMM');\r\n        return { code, date };\r\n    });\r\n\r\n    const yearIssueUrl = `${rootUrl}/knavi/journals/${name}/papers?yearIssue=${code}&pageIdx=0&pcode=CJFD,CCJD`;\r\n    const response = await got.post(yearIssueUrl);\r\n\r\n    const $ = load(response.data);\r\n    const publications = $('dd');\r\n\r\n    const list = publications.toArray().map((publication) => {\r\n        const title = $(publication).find('a').first().text();\r\n        const filename = $(publication).find('b').attr('id');\r\n        const link = `https://cnki.net/kcms/detail/detail.aspx?filename=${filename}&dbcode=CJFD`;\r\n\r\n        return {\r\n            title,\r\n            link,\r\n            pubDate: date,\r\n        };\r\n    });\r\n\r\n    const items = await Promise.all(list.map((item) => cache.tryGet(item.link, () => ProcessItem(item))));\r\n\r\n    return {\r\n        title: String(title),\r\n        link: journalUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"8gBASA,MAAM,EAAU,wBAEHA,EAAe,CACxB,KAAM,kBACN,WAAY,CAAC,WACb,QAAS,sBACT,WAAY,CAAE,KAAM,iBACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,+CAGjB,KAAM,KACN,YAAa,CAAC,YAAa,YAAa,YACxC,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,QACrB,EAAS,6CAA6C,EAAK,gBAE3D,EAAc,MAAMC,EAAI,IAAI,GAElC,GAAI,CACA,IAAM,EAAO,MAAMC,EAAO,YAAY,EAAY,MAElD,GAAI,EAAK,OAAS,EAAK,MAAM,SAAW,EAAG,CACvC,IAAMC,EAAQ,EAAK,MAAM,IAAK,IAAU,CACpC,MAAO,EAAK,MACZ,YAAa,EAAK,QAClB,QAAS,EAAU,EAAK,SACxB,KAAM,EAAK,KACX,OAAQ,EAAK,UAGjB,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,YAAa,EAAK,YAClB,KAAMA,UAGT,EAAO,CACZ,EAAO,MAAM,GAGjB,IAAM,EAAa,GAAG,EAAQ,kBAAkB,EAAK,SAC/C,EAAQ,MAAMF,EAAI,IAAI,GAAY,KAAM,GAAQ,EAAK,EAAI,MAAM,gBAAgB,QAE/E,EAAc,GAAG,EAAQ,kBAAkB,EAAK,kBAEhD,CAAE,OAAM,QAAS,MAAMA,EAAI,IAAI,GAAa,KAAM,GAAQ,CAC5D,IAAMG,EAAI,EAAK,EAAI,MACbC,EAAOD,EAAE,kBAAkB,KAAK,MAAM,QAAQ,KAAK,MAAM,KAAK,KAAK,QAAQ,KAAK,SAChFE,EAAO,EAAUF,EAAE,kBAAkB,KAAK,MAAM,QAAQ,KAAK,MAAM,KAAK,KAAK,QAAQ,KAAK,MAAM,QAAQ,KAAM,IAAK,UACzH,MAAO,CAAE,KAAA,EAAM,KAAA,KAGb,EAAe,GAAG,EAAQ,kBAAkB,EAAK,oBAAoB,EAAK,4BAC1E,EAAW,MAAMH,EAAI,KAAK,GAE1B,EAAI,EAAK,EAAS,MAClB,EAAe,EAAE,MAEjB,EAAO,EAAa,UAAU,IAAK,GAAgB,CACrD,IAAMM,EAAQ,EAAE,GAAa,KAAK,KAAK,QAAQ,OACzC,EAAW,EAAE,GAAa,KAAK,KAAK,KAAK,MACzC,EAAO,qDAAqD,EAAS,cAE3E,MAAO,CACH,MAAA,EACA,OACA,QAAS,KAIX,EAAQ,MAAM,QAAQ,IAAI,EAAK,IAAK,GAASC,EAAM,OAAO,EAAK,SAAY,EAAY,MAE7F,MAAO,CACH,MAAO,OAAO,GACd,KAAM,EACN,KAAM"}