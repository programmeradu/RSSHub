{"version":3,"file":"e-hentai-B8PONecN.js","names":[],"sources":["../../lib/routes/e-hentai/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/:what?/:id?/:needTorrents?/:needImages?',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    features: {\r\n        nsfw: true,\r\n    },\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id') ?? '';\r\n    const what = ctx.req.param('what') ?? '';\r\n    const needTorrents = /t|y/i.test(ctx.req.param('needTorrents') ?? 'true');\r\n    const needImages = /t|y/i.test(ctx.req.param('needImages') ?? 'true');\r\n\r\n    const rootUrl = 'https://e-hentai.org';\r\n    const currentUrl = `${rootUrl}/${id ? (what === 'search' ? `?${id}` : what === 'category' ? id : `${what}/${id}`) : what}`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    $('.itd').parent().remove();\r\n\r\n    let items = $('table.gltc tbody tr')\r\n        .slice(1, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) + 1 : needImages ? 16 : 26)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                title: item.find('div.glink').text(),\r\n                author: item.find('td.glhide div a').text(),\r\n                link: item.find('td.glname a').attr('href'),\r\n                pubDate: parseDate(item.find('div.ir').prev().text()),\r\n                category: item\r\n                    .find('div.gt')\r\n                    .toArray()\r\n                    .map((tag) => $(tag).attr('title').replace(/^:/, '')),\r\n                description: needImages ? '' : `<img src=\"${item.find('div.glthumb div img').attr('data-src') ?? item.find('div.glthumb div img').attr('src')}\">`,\r\n                enclosure_url: needTorrents ? (item.find('div.gldown a img[title=\"Show torrents\"]').length > 0 ? item.find('.gldown a').attr('href') : undefined) : undefined,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map(async (item) => {\r\n            if (item.enclosure_url) {\r\n                let forms = '',\r\n                    torrents = await cache.get(item.enclosure_url);\r\n\r\n                if (!torrents) {\r\n                    const torrentResponse = await got({\r\n                        method: 'get',\r\n                        url: item.enclosure_url,\r\n                    });\r\n\r\n                    const torrent = load(torrentResponse.data);\r\n\r\n                    torrent('h1, input[name=\"torrent_info\"]').remove();\r\n                    forms = torrent('form').parent().html();\r\n\r\n                    torrents = torrent('table tbody tr td a')\r\n                        .toArray()\r\n                        .map((t) => {\r\n                            t = torrent(t);\r\n                            return { link: t.attr('href'), title: t.text() };\r\n                        });\r\n                    cache.set(item.enclosure_url, torrents);\r\n                }\r\n                item.description += forms;\r\n                item.enclosure_url = torrents[0].link;\r\n                item.enclosure_type = 'application/x-bittorrent';\r\n            }\r\n\r\n            if (needImages) {\r\n                let images = await cache.get(item.link);\r\n\r\n                if (!images) {\r\n                    const imageResponse = await got({\r\n                        method: 'get',\r\n                        url: item.link,\r\n                    });\r\n\r\n                    const content = load(imageResponse.data);\r\n\r\n                    images = await Promise.all(\r\n                        content('.gdtm a')\r\n                            .toArray()\r\n                            .map((i) =>\r\n                                cache.tryGet(content(i).attr('href'), async () => {\r\n                                    const imageResponse = await got({\r\n                                        method: 'get',\r\n                                        url: content(i).attr('href'),\r\n                                    });\r\n\r\n                                    const image = load(imageResponse.data);\r\n\r\n                                    return image('#img').attr('src');\r\n                                })\r\n                            )\r\n                    );\r\n                    cache.set(item.link, images);\r\n                }\r\n                item.description += art(path.join(__dirname, 'templates/images.art'), { images });\r\n            }\r\n            return item;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `${id || what || 'Front Page'} - E-Hentai Galleries`,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,2CACN,KAAM,UACN,YAAa,GACb,SAAU,CACN,KAAM,IAEV,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,OAAS,GAC5B,EAAO,EAAI,IAAI,MAAM,SAAW,GAChC,EAAe,OAAO,KAAK,EAAI,IAAI,MAAM,iBAAmB,QAC5D,EAAa,OAAO,KAAK,EAAI,IAAI,MAAM,eAAiB,QAGxD,EAAa,wBAAc,EAAM,IAAS,SAAW,IAAI,IAAO,IAAS,WAAa,EAAK,GAAG,EAAK,GAAG,IAAQ,IAE9G,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MAExB,EAAE,QAAQ,SAAS,SAEnB,IAAI,EAAQ,EAAE,uBACT,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,EAAI,EAAa,GAAK,IAClG,UACA,IAAK,IACF,EAAO,EAAE,GAEF,CACH,MAAO,EAAK,KAAK,aAAa,OAC9B,OAAQ,EAAK,KAAK,mBAAmB,OACrC,KAAM,EAAK,KAAK,eAAe,KAAK,QACpC,QAAS,EAAU,EAAK,KAAK,UAAU,OAAO,QAC9C,SAAU,EACL,KAAK,UACL,UACA,IAAK,GAAQ,EAAE,GAAK,KAAK,SAAS,QAAQ,KAAM,KACrD,YAAa,EAAa,GAAK,aAAa,EAAK,KAAK,uBAAuB,KAAK,aAAe,EAAK,KAAK,uBAAuB,KAAK,OAAO,IAC9I,cAAe,GAAgB,EAAK,KAAK,2CAA2C,OAAS,EAAI,EAAK,KAAK,aAAa,KAAK,QAAU,IAAA,MAqEnJ,MAjEA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAI,KAAO,IAAS,CACtB,GAAI,EAAK,cAAe,CACpB,IAAI,EAAQ,GACR,EAAW,MAAM,EAAM,IAAI,EAAK,eAEpC,GAAI,CAAC,EAAU,CACX,IAAM,EAAkB,MAAM,EAAI,CAC9B,OAAQ,MACR,IAAK,EAAK,gBAGR,EAAU,EAAK,EAAgB,MAErC,EAAQ,kCAAkC,SAC1C,EAAQ,EAAQ,QAAQ,SAAS,OAEjC,EAAW,EAAQ,uBACd,UACA,IAAK,IACF,EAAI,EAAQ,GACL,CAAE,KAAM,EAAE,KAAK,QAAS,MAAO,EAAE,UAEhD,EAAM,IAAI,EAAK,cAAe,GAElC,EAAK,aAAe,EACpB,EAAK,cAAgB,EAAS,GAAG,KACjC,EAAK,eAAiB,2BAG1B,GAAI,EAAY,CACZ,IAAI,EAAS,MAAM,EAAM,IAAI,EAAK,MAElC,GAAI,CAAC,EAAQ,CACT,IAAM,EAAgB,MAAM,EAAI,CAC5B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAc,MAEnC,EAAS,MAAM,QAAQ,IACnB,EAAQ,WACH,UACA,IAAK,GACF,EAAM,OAAO,EAAQ,GAAG,KAAK,QAAS,SAAY,CAC9C,IAAM,EAAgB,MAAM,EAAI,CAC5B,OAAQ,MACR,IAAK,EAAQ,GAAG,KAAK,UAGnB,EAAQ,EAAK,EAAc,MAEjC,OAAO,EAAM,QAAQ,KAAK,WAI1C,EAAM,IAAI,EAAK,KAAM,GAEzB,EAAK,aAAe,EAAI,EAAA,KAAA,EAAA,iCAA8C,CAAE,WAE5E,OAAO,KAIR,CACH,MAAO,GAAG,GAAM,GAAQ,aAAa,uBACrC,KAAM,EACN,KAAM"}