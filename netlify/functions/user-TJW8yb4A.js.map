{"version":3,"file":"user-TJW8yb4A.js","names":["route: Route","cache","notes","collect","InvalidParameterError"],"sources":["../../lib/routes/xiaohongshu/user.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport querystring from 'node:querystring';\r\nimport { getUser, renderNotesFulltext, getUserWithCookie } from './util';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport { config } from '@/config';\r\nimport { fallback, queryToBoolean } from '@/utils/readable-social';\r\nexport const route: Route = {\r\n    path: '/user/:user_id/:category/:routeParams?',\r\n    name: '用户笔记/收藏',\r\n    categories: ['social-media'],\r\n    view: ViewType.Articles,\r\n    maintainers: ['lotosbin', 'howerhe', 'rien7', 'dddaniel1', 'pseudoyu'],\r\n    handler,\r\n    radar: [\r\n        {\r\n            source: ['xiaohongshu.com/user/profile/:user_id'],\r\n            target: '/user/:user_id/notes',\r\n        },\r\n    ],\r\n    example: '/xiaohongshu/user/593032945e87e77791e03696/notes',\r\n    features: {\r\n        antiCrawler: true,\r\n        requirePuppeteer: true,\r\n        requireConfig: [\r\n            {\r\n                name: 'XIAOHONGSHU_COOKIE',\r\n                optional: true,\r\n                description: '小红书 cookie 值，可在网络里面看到。',\r\n            },\r\n        ],\r\n    },\r\n    parameters: {\r\n        user_id: 'user id, length 24 characters',\r\n        category: {\r\n            description: 'category, notes or collect',\r\n            options: [\r\n                {\r\n                    value: 'notes',\r\n                    label: 'notes',\r\n                },\r\n                {\r\n                    value: 'collect',\r\n                    label: 'collect',\r\n                },\r\n            ],\r\n            default: 'notes',\r\n        },\r\n        routeParams: {\r\n            description: 'displayLivePhoto,`/user/:user_id/notes/displayLivePhoto=0`,不限时LivePhoto显示为图片,`/user/:user_id/notes/displayLivePhoto=1`,取值不为0时LivePhoto显示为视频',\r\n            default: '0',\r\n        },\r\n    },\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const userId = ctx.req.param('user_id');\r\n    const category = ctx.req.param('category');\r\n    const routeParams = querystring.parse(ctx.req.param('routeParams'));\r\n    const displayLivePhoto = !!fallback(undefined, queryToBoolean(routeParams.displayLivePhoto), false);\r\n    const url = `https://www.xiaohongshu.com/user/profile/${userId}`;\r\n    const cookie = config.xiaohongshu.cookie;\r\n\r\n    if (cookie && category === 'notes') {\r\n        try {\r\n            const urlNotePrefix = 'https://www.xiaohongshu.com/explore';\r\n            const user = await getUserWithCookie(url);\r\n            const notes = await renderNotesFulltext(user.notes, urlNotePrefix, displayLivePhoto);\r\n            return {\r\n                title: `${user.userPageData.basicInfo.nickname} - 笔记 • 小红书 / RED`,\r\n                description: user.userPageData.basicInfo.desc,\r\n                image: user.userPageData.basicInfo.imageb || user.userPageData.basicInfo.images,\r\n                link: url,\r\n                item: notes,\r\n            };\r\n        } catch {\r\n            // Fallback to normal logic if cookie method fails\r\n            return await getUserFeeds(url, category);\r\n        }\r\n    } else {\r\n        return await getUserFeeds(url, category);\r\n    }\r\n}\r\n\r\nasync function getUserFeeds(url: string, category: string) {\r\n    const {\r\n        userPageData: { basicInfo, interactions, tags },\r\n        notes,\r\n        collect,\r\n    } = await getUser(url, cache);\r\n\r\n    const title = `${basicInfo.nickname} - 小红书${category === 'notes' ? '笔记' : '收藏'}`;\r\n    const description = `${basicInfo.desc} ${tags.map((t) => t.name).join(' ')} ${interactions.map((i) => `${i.count} ${i.name}`).join(' ')}`;\r\n    const image = basicInfo.imageb || basicInfo.images;\r\n\r\n    const renderNote = (notes) =>\r\n        notes.flatMap((n) =>\r\n            n.map(({ id, noteCard }) => ({\r\n                title: noteCard.displayTitle,\r\n                link: new URL(noteCard.noteId || id, url).toString(),\r\n                guid: noteCard.displayTitle,\r\n                description: `<img src =\"${noteCard.cover.infoList.pop().url}\"><br>${noteCard.displayTitle}`,\r\n                author: noteCard.user.nickname,\r\n                upvotes: noteCard.interactInfo.likedCount,\r\n            }))\r\n        );\r\n    const renderCollect = (collect) => {\r\n        if (!collect) {\r\n            throw new InvalidParameterError('该用户已设置收藏内容不可见');\r\n        }\r\n        if (collect.code !== 0) {\r\n            throw new Error(JSON.stringify(collect));\r\n        }\r\n        if (!collect.data.notes.length) {\r\n            throw new InvalidParameterError('该用户已设置收藏内容不可见');\r\n        }\r\n        return collect.data.notes.map((item) => ({\r\n            title: item.display_title,\r\n            link: `${url}/${item.note_id}`,\r\n            description: `<img src =\"${item.cover.info_list.pop().url}\"><br>${item.display_title}`,\r\n            author: item.user.nickname,\r\n            upvotes: item.interact_info.likedCount,\r\n        }));\r\n    };\r\n\r\n    return {\r\n        title,\r\n        description,\r\n        image,\r\n        link: url,\r\n        item: category === 'notes' ? renderNote(notes) : renderCollect(collect),\r\n    };\r\n}\r\n"],"mappings":"upBAOA,MAAaA,EAAe,CACxB,KAAM,yCACN,KAAM,UACN,WAAY,CAAC,gBACb,KAAM,EAAS,SACf,YAAa,CAAC,WAAY,UAAW,QAAS,YAAa,YAC3D,UACA,MAAO,CACH,CACI,OAAQ,CAAC,yCACT,OAAQ,yBAGhB,QAAS,mDACT,SAAU,CACN,YAAa,GACb,iBAAkB,GAClB,cAAe,CACX,CACI,KAAM,qBACN,SAAU,GACV,YAAa,4BAIzB,WAAY,CACR,QAAS,gCACT,SAAU,CACN,YAAa,6BACb,QAAS,CACL,CACI,MAAO,QACP,MAAO,SAEX,CACI,MAAO,UACP,MAAO,YAGf,QAAS,SAEb,YAAa,CACT,YAAa,8IACb,QAAS,OAKrB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAI,IAAI,MAAM,WACvB,EAAW,EAAI,IAAI,MAAM,YACzB,EAAc,EAAY,MAAM,EAAI,IAAI,MAAM,gBAC9C,EAAmB,CAAC,CAAC,EAAS,IAAA,GAAW,EAAe,EAAY,kBAAmB,IACvF,EAAM,4CAA4C,IAClD,EAAS,EAAO,YAAY,OAElC,GAAI,GAAU,IAAa,QACvB,GAAI,CACA,IACM,EAAO,MAAM,EAAkB,GAC/B,EAAQ,MAAM,EAAoB,EAAK,MAAO,sCAAe,GACnE,MAAO,CACH,MAAO,GAAG,EAAK,aAAa,UAAU,SAAS,mBAC/C,YAAa,EAAK,aAAa,UAAU,KACzC,MAAO,EAAK,aAAa,UAAU,QAAU,EAAK,aAAa,UAAU,OACzE,KAAM,EACN,KAAM,QAEN,CAEJ,OAAO,MAAM,EAAa,EAAK,QAGnC,OAAO,MAAM,EAAa,EAAK,GAIvC,eAAe,EAAa,EAAa,EAAkB,CACvD,GAAM,CACF,aAAc,CAAE,YAAW,eAAc,QACzC,QACA,WACA,MAAM,EAAQ,EAAKC,GAEjB,EAAQ,GAAG,EAAU,SAAS,QAAQ,IAAa,QAAU,KAAO,OACpE,EAAc,GAAG,EAAU,KAAK,GAAG,EAAK,IAAK,GAAM,EAAE,MAAM,KAAK,KAAK,GAAG,EAAa,IAAK,GAAM,GAAG,EAAE,MAAM,GAAG,EAAE,QAAQ,KAAK,OAC7H,EAAQ,EAAU,QAAU,EAAU,OAEtC,EAAc,GAChBC,EAAM,QAAS,GACX,EAAE,KAAK,CAAE,KAAI,eAAgB,CACzB,MAAO,EAAS,aAChB,KAAM,IAAI,IAAI,EAAS,QAAU,EAAI,GAAK,WAC1C,KAAM,EAAS,aACf,YAAa,cAAc,EAAS,MAAM,SAAS,MAAM,IAAI,QAAQ,EAAS,eAC9E,OAAQ,EAAS,KAAK,SACtB,QAAS,EAAS,aAAa,eAGrC,EAAiB,GAAY,CAC/B,GAAI,CAACC,EACD,MAAM,IAAIC,EAAsB,iBAEpC,GAAID,EAAQ,OAAS,EACjB,MAAU,MAAM,KAAK,UAAUA,IAEnC,GAAI,CAACA,EAAQ,KAAK,MAAM,OACpB,MAAM,IAAIC,EAAsB,iBAEpC,OAAOD,EAAQ,KAAK,MAAM,IAAK,IAAU,CACrC,MAAO,EAAK,cACZ,KAAM,GAAG,EAAI,GAAG,EAAK,UACrB,YAAa,cAAc,EAAK,MAAM,UAAU,MAAM,IAAI,QAAQ,EAAK,gBACvE,OAAQ,EAAK,KAAK,SAClB,QAAS,EAAK,cAAc,eAIpC,MAAO,CACH,QACA,cACA,QACA,KAAM,EACN,KAAM,IAAa,QAAU,EAAW,GAAS,EAAc"}