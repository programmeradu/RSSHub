{"version":3,"file":"gnn-index-D1owSjPY.js","names":["route: Route","got","cache","response","$"],"sources":["../../lib/routes/gamer/gnn-index.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport pMap from 'p-map';\r\n\r\nexport const route: Route = {\r\n    path: '/gnn/:category?',\r\n    categories: ['anime'],\r\n    view: ViewType.Articles,\r\n    example: '/gamer/gnn/1',\r\n    parameters: {\r\n        category: {\r\n            description: '版塊',\r\n            options: [\r\n                { value: '1', label: 'PC' },\r\n                { value: '3', label: 'TV 掌機' },\r\n                { value: '4', label: '手機遊戲' },\r\n                { value: '5', label: '動漫畫' },\r\n                { value: '9', label: '主題報導' },\r\n                { value: '11', label: '活動展覽' },\r\n                { value: '13', label: '電競' },\r\n                { value: 'ns', label: 'Switch' },\r\n                { value: 'ps5', label: 'PS5' },\r\n                { value: 'ps4', label: 'PS4' },\r\n                { value: 'xbone', label: 'XboxOne' },\r\n                { value: 'xbsx', label: 'XboxSX' },\r\n                { value: 'pc', label: 'PC 單機' },\r\n                { value: 'olg', label: 'PC 線上' },\r\n                { value: 'ios', label: 'iOS' },\r\n                { value: 'android', label: 'Android' },\r\n                { value: 'web', label: 'Web' },\r\n                { value: 'comic', label: '漫畫' },\r\n                { value: 'anime', label: '動畫' },\r\n            ],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'GNN 新聞',\r\n    maintainers: ['Arracc', 'ladeng07', 'pseudoyu'],\r\n    handler,\r\n    description: '缺省為首頁',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category');\r\n    let url = '';\r\n    let categoryName = '';\r\n    const categoryTable = {\r\n        1: 'PC',\r\n        3: 'TV 掌機',\r\n        4: '手機遊戲',\r\n        5: '動漫畫',\r\n        9: '主題報導',\r\n        11: '活動展覽',\r\n        13: '電競',\r\n        ns: 'Switch',\r\n        ps5: 'PS5',\r\n        ps4: 'PS4',\r\n        xbone: 'XboxOne',\r\n        xbsx: 'XboxSX',\r\n        pc: 'PC 單機',\r\n        olg: 'PC 線上',\r\n        ios: 'iOS',\r\n        android: 'Android',\r\n        web: 'Web',\r\n        comic: '漫畫',\r\n        anime: '動畫',\r\n    };\r\n    const mainCategory = ['1', '3', '4', '5', '9', '11', '13'];\r\n    if (!category || !Object.keys(categoryTable).includes(category)) {\r\n        url = 'https://gnn.gamer.com.tw/';\r\n    } else {\r\n        categoryName = '-' + categoryTable[category];\r\n        url = mainCategory.includes(category) ? `https://gnn.gamer.com.tw/index.php?k=${category}` : `https://acg.gamer.com.tw/news.php?p=${category}`;\r\n    }\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n    });\r\n    const data = response.data;\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 50;\r\n    const $ = load(data);\r\n\r\n    const list = $('div.BH-lbox.GN-lbox2')\r\n        .children()\r\n        .not('p,a,img,span')\r\n        // <div data-news-id=\"291265\" id=\"291265\"></div>\r\n        .not('[data-news-id]')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            let aLabelNode;\r\n            let tag;\r\n            // a label with div\r\n            if (item.find('h1').length === 0) {\r\n                // a label without div\r\n                aLabelNode = item.find('a');\r\n                tag = item.find('div.platform-tag_list').text();\r\n            } else {\r\n                aLabelNode = item.find('h1').find('a');\r\n                tag = item.find('div.platform-tag_list').text();\r\n            }\r\n\r\n            return {\r\n                title: '[' + tag + ']' + aLabelNode.text(),\r\n                link: aLabelNode.attr('href').replace('//', 'https://'),\r\n            };\r\n        });\r\n\r\n    const items = await pMap(\r\n        list,\r\n        async (item) => {\r\n            item.description = await cache.tryGet(item.link, async () => {\r\n                const response = await got.get(item.link);\r\n                let component = '';\r\n                const urlReg = /window\\.lazySizesConfig/g;\r\n\r\n                let pubInfo;\r\n                let dateStr;\r\n                if (response.body.search(urlReg) >= 0) {\r\n                    const $ = load(response.data);\r\n                    if ($('span.GN-lbox3C').length > 0) {\r\n                        // official publish 1\r\n                        pubInfo = $('span.GN-lbox3C').text().split('）');\r\n                        item.author = pubInfo[0].replace('（', '').replace(' 報導', '');\r\n                        dateStr = pubInfo[1].trim();\r\n                    } else {\r\n                        // official publish 2\r\n                        pubInfo = $('span.GN-lbox3CA').text().split('）');\r\n                        item.author = pubInfo[0].replace('（', '').replace(' 報導', '');\r\n                        dateStr = pubInfo[1].replace('原文出處', '').trim();\r\n                    }\r\n                    component = $('div.GN-lbox3B').html();\r\n                } else {\r\n                    // url redirect\r\n                    const _response = await got.get(item.link);\r\n                    const _$ = load(_response.data);\r\n\r\n                    if (_$('div.MSG-list8C').length > 0) {\r\n                        // personal publish 1\r\n                        pubInfo = _$('span.ST1').text().split('│');\r\n                        item.author = pubInfo[0].replace('作者：', '');\r\n                        dateStr = pubInfo[_$('span.ST1').find('a').length > 0 ? 2 : 1];\r\n                        component = _$('div.MSG-list8C').html();\r\n                    } else {\r\n                        // personal publish 2\r\n                        pubInfo = _$('div.article-intro').text().replaceAll('\\n', '').split('|');\r\n                        item.author = pubInfo[0];\r\n                        dateStr = pubInfo[1];\r\n                        component = _$('div.text-paragraph').html();\r\n                    }\r\n                }\r\n                item.pubDate = timezone(parseDate(dateStr, 'YYYY-MM-DD HH:mm:ss'), +8);\r\n                component = component.replaceAll(/\\b(data-src)\\b/g, 'src');\r\n                return component;\r\n            });\r\n            return item;\r\n        },\r\n        { concurrency: 5 }\r\n    );\r\n\r\n    return {\r\n        title: '巴哈姆特-GNN新聞' + categoryName,\r\n        link: url,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}