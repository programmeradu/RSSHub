{"version":3,"file":"12306-BZ99sANk.js","names":[],"sources":["../../lib/routes/12306/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { config } from '@/config';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nconst rootUrl = 'https://kyfw.12306.cn';\r\n\r\nasync function getJSESSIONID(linkUrl) {\r\n    const res = await got({\r\n        method: 'get',\r\n        url: linkUrl,\r\n        headers: {\r\n            UserAgent: config.ua,\r\n            Referer: 'https://www.12306.cn/index/index.html',\r\n        },\r\n    });\r\n\r\n    return res.headers['set-cookie'].join(',').match(/JSESSIONID=([^;]+);/)[0];\r\n}\r\n\r\nfunction getStationInfo(stationName) {\r\n    return cache.tryGet(stationName, async () => {\r\n        const res = await got({\r\n            method: 'get',\r\n            url: `${rootUrl}/otn/resources/js/framework/station_name.js`,\r\n            headers: {\r\n                UserAgent: config.ua,\r\n                Referer: 'https://kyfw.12306.cn/otn/leftTicket/init',\r\n            },\r\n        });\r\n\r\n        return res.data\r\n            .split('@')\r\n            .map((item) => {\r\n                const itemData = item.split('|');\r\n\r\n                return itemData.includes(stationName)\r\n                    ? {\r\n                          code: itemData[2],\r\n                          name: itemData[1],\r\n                      }\r\n                    : null;\r\n            })\r\n            .find(Boolean);\r\n    });\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/:date/:from/:to/:type?',\r\n    categories: ['travel'],\r\n    example: '/12306/2022-02-19/重庆/永川东',\r\n    parameters: { date: '时间，格式为（YYYY-MM-DD）', from: '始发站', to: '终点站', type: '售票类型，成人和学生可选，默认为成人' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '售票信息',\r\n    maintainers: ['Fatpandac'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const date = ctx.req.param('date');\r\n    const fromStationInfo = await getStationInfo(ctx.req.param('from'));\r\n    const toStationInfo = await getStationInfo(ctx.req.param('to'));\r\n    const type = ctx.req.param('type') ?? 'ADULT';\r\n\r\n    const apiUrl = `${rootUrl}/otn/leftTicket/queryA?leftTicketDTO.train_date=${date}&leftTicketDTO.from_station=${fromStationInfo.code}&leftTicketDTO.to_station=${toStationInfo.code}&purpose_codes=${type}`;\r\n    const linkUrl = `${rootUrl}/otn/leftTicket/init?linktypeid=dc&fs=${fromStationInfo.code}&ts=${toStationInfo.code}&date=${date}&flag=N,N,Y`;\r\n\r\n    const response = await got.get(apiUrl, {\r\n        headers: {\r\n            UserAgent: config.ua,\r\n            Referer: 'https://kyfw.12306.cn/otn/leftTicket/init',\r\n            Cookie: await getJSESSIONID(linkUrl),\r\n        },\r\n    });\r\n    if (response.data.data === undefined || response.data.data.length === 0) {\r\n        throw new InvalidParameterError('没有找到相关车次，请检查参数是否正确');\r\n    }\r\n    const data = response.data.data.result;\r\n    const map = response.data.data.map;\r\n\r\n    const items = data.map((item) => {\r\n        const itemData = item.split('|');\r\n        const trainInfo = {\r\n            trainNo: itemData[3],\r\n            fromStation: map[itemData[6]],\r\n            toStation: map[itemData[7]],\r\n            startTime: itemData[8],\r\n            arriveTime: itemData[9],\r\n            duration: itemData[10],\r\n            today: itemData[11],\r\n            A9: itemData[32],\r\n            M: itemData[31],\r\n            O: itemData[30],\r\n            A6: itemData[29],\r\n            A4: itemData[28],\r\n            F: itemData[27],\r\n            A3: itemData[26],\r\n            A2: itemData[25],\r\n            A1: itemData[24],\r\n            WZ: itemData[23],\r\n            QT: itemData[22],\r\n        };\r\n\r\n        return {\r\n            title: `${trainInfo.fromStation} → ${trainInfo.toStation} ${trainInfo.startTime} ${trainInfo.arriveTime}`,\r\n            description: art(path.join(__dirname, 'templates/train.art'), {\r\n                trainInfo,\r\n            }),\r\n            link: linkUrl,\r\n            guid: Object.values(trainInfo).join('|'),\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `${fromStationInfo.name} → ${toStationInfo.name} ${date}`,\r\n        link: linkUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ieASA,MAAM,EAAU,wBAEhB,eAAe,EAAc,EAAS,CAClC,IAAM,EAAM,MAAM,EAAI,CAClB,OAAQ,MACR,IAAK,EACL,QAAS,CACL,UAAW,EAAO,GAClB,QAAS,2CAIjB,OAAO,EAAI,QAAQ,cAAc,KAAK,KAAK,MAAM,uBAAuB,GAG5E,SAAS,EAAe,EAAa,CACjC,OAAO,EAAM,OAAO,EAAa,SAAY,CACzC,IAAM,EAAM,MAAM,EAAI,CAClB,OAAQ,MACR,IAAK,GAAG,EAAQ,6CAChB,QAAS,CACL,UAAW,EAAO,GAClB,QAAS,+CAIjB,OAAO,EAAI,KACN,MAAM,KACN,IAAK,GAAS,CACX,IAAM,EAAW,EAAK,MAAM,KAE5B,OAAO,EAAS,SAAS,GACnB,CACI,KAAM,EAAS,GACf,KAAM,EAAS,IAEnB,OAET,KAAK,WAIlB,MAAa,EAAe,CACxB,KAAM,0BACN,WAAY,CAAC,UACb,QAAS,2BACT,WAAY,CAAE,KAAM,qBAAsB,KAAM,MAAO,GAAI,MAAO,KAAM,sBACxE,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,aACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,QACrB,EAAkB,MAAM,EAAe,EAAI,IAAI,MAAM,SACrD,EAAgB,MAAM,EAAe,EAAI,IAAI,MAAM,OACnD,EAAO,EAAI,IAAI,MAAM,SAAW,QAEhC,EAAS,GAAG,EAAQ,kDAAkD,EAAK,8BAA8B,EAAgB,KAAK,4BAA4B,EAAc,KAAK,iBAAiB,IAC9L,EAAU,GAAG,EAAQ,wCAAwC,EAAgB,KAAK,MAAM,EAAc,KAAK,QAAQ,EAAK,aAExH,EAAW,MAAM,EAAI,IAAI,EAAQ,CACnC,QAAS,CACL,UAAW,EAAO,GAClB,QAAS,4CACT,OAAQ,MAAM,EAAc,MAGpC,GAAI,EAAS,KAAK,OAAS,IAAA,IAAa,EAAS,KAAK,KAAK,SAAW,EAClE,MAAM,IAAI,EAAsB,sBAEpC,IAAM,EAAO,EAAS,KAAK,KAAK,OAC1B,EAAM,EAAS,KAAK,KAAK,IAEzB,EAAQ,EAAK,IAAK,GAAS,CAC7B,IAAM,EAAW,EAAK,MAAM,KACtB,EAAY,CACd,QAAS,EAAS,GAClB,YAAa,EAAI,EAAS,IAC1B,UAAW,EAAI,EAAS,IACxB,UAAW,EAAS,GACpB,WAAY,EAAS,GACrB,SAAU,EAAS,IACnB,MAAO,EAAS,IAChB,GAAI,EAAS,IACb,EAAG,EAAS,IACZ,EAAG,EAAS,IACZ,GAAI,EAAS,IACb,GAAI,EAAS,IACb,EAAG,EAAS,IACZ,GAAI,EAAS,IACb,GAAI,EAAS,IACb,GAAI,EAAS,IACb,GAAI,EAAS,IACb,GAAI,EAAS,KAGjB,MAAO,CACH,MAAO,GAAG,EAAU,YAAY,KAAK,EAAU,UAAU,GAAG,EAAU,UAAU,GAAG,EAAU,aAC7F,YAAa,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAC1D,cAEJ,KAAM,EACN,KAAM,OAAO,OAAO,GAAW,KAAK,QAI5C,MAAO,CACH,MAAO,GAAG,EAAgB,KAAK,KAAK,EAAc,KAAK,GAAG,IAC1D,KAAM,EACN,KAAM"}