{"version":3,"file":"digest-CafO9-p2.js","names":[],"sources":["../../lib/routes/saraba1st/digest.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { config } from '@/config';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/digest/:tid',\r\n    categories: ['bbs'],\r\n    example: '/saraba1st/digest/forum-6-1',\r\n    parameters: { tid: '论坛 id' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '论坛摘要',\r\n    maintainers: ['shinemoon'],\r\n    handler,\r\n    description: `版面网址如果为 \\`https://stage1st.com/2b/forum-6-1.html\\` 那么论坛 id 就是 \\`forum-6-1\\`。`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const tid = ctx.req.param('tid');\r\n    const cookieString = config.saraba1st.cookie ?? '';\r\n    const host = config.saraba1st.host;\r\n    const res = await got(`${host}/2b/${tid}.html`, {\r\n        headers: {\r\n            Cookie: cookieString,\r\n        },\r\n    });\r\n    const $ = load(res.data);\r\n    const title = $('head title').text().replace(/-.*/, '');\r\n    const list = $('#threadlisttableid tbody[id^=\"normalthread_\"] tr');\r\n    const count = list\r\n        .slice(0, ctx.req.query('limit') ? Number(ctx.req.query('limit')) : 20)\r\n        .toArray()\r\n        .map((each) => {\r\n            each = $(each);\r\n            const floor = each.find('th.new a.s.xst').text();\r\n            const floorUrl = each.find('th.new a.s.xst').attr('href');\r\n            return {\r\n                title: `${title}:${floor}`,\r\n                link: new URL(floorUrl, `${host}/2b/`).href,\r\n                author: each.find('td.by cite').text(),\r\n                pubDate: timezone(parseDate(each.find('td.by em').first().text()), +8),\r\n            };\r\n        });\r\n\r\n    const resultItems = await Promise.all(\r\n        count.map((i) =>\r\n            cache.tryGet(i.link, async () => {\r\n                i.description = await fetchContent(i.link);\r\n                return i;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `Stage1 论坛 - ${title}`,\r\n        link: `${host}/2b/${tid}.html`,\r\n        //        item: await resultItems,\r\n        item: resultItems,\r\n    };\r\n}\r\n\r\nasync function fetchContent(url) {\r\n    // Fetch the subpageinof\r\n    const cookieString = config.saraba1st.cookie ?? '';\r\n    const subres = await got(url, {\r\n        headers: {\r\n            Cookie: cookieString,\r\n        },\r\n    });\r\n    const subind = load(subres.data);\r\n    const stubS = subind('<div>');\r\n    subind('#postlist')\r\n        .find('div[id*=\"post_\"] ')\r\n        .each(function () {\r\n            if (subind(this).find('td[id*=\"postmessage_\"]').length > 0) {\r\n                const section = art(path.join(__dirname, 'templates/digest.art'), {\r\n                    author: {\r\n                        link: subind(this).find('.pls.favatar div.authi a').attr('href'),\r\n                        name: subind(this).find('.pls.favatar div.authi').text(),\r\n                        postinfo: subind(this).find('div.authi em[id*=authorposton]').text(),\r\n                    },\r\n                    msg: subind(this).find('td[id*=\"postmessage_\"]').html(),\r\n                    host: config.saraba1st.host,\r\n                });\r\n                stubS.append(section);\r\n            }\r\n        });\r\n\r\n    stubS.find('img').each(function () {\r\n        const img = subind(this);\r\n        const file = img.attr('file');\r\n        if (file) {\r\n            img.attr('src', file);\r\n            img.removeAttr('zoomfile');\r\n            img.removeAttr('file');\r\n            img.removeAttr('onmouseover');\r\n            img.removeAttr('onclick');\r\n        }\r\n    });\r\n\r\n    return stubS.html();\r\n}\r\n"],"mappings":"2hBAWA,MAAa,EAAe,CACxB,KAAM,eACN,WAAY,CAAC,OACb,QAAS,8BACT,WAAY,CAAE,IAAK,SACnB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,aACd,UACA,YAAa,4EAGjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAM,EAAI,IAAI,MAAM,OACpB,EAAe,EAAO,UAAU,QAAU,GAC1C,EAAO,EAAO,UAAU,KACxB,EAAM,MAAM,EAAI,GAAG,EAAK,MAAM,EAAI,OAAQ,CAC5C,QAAS,CACL,OAAQ,KAGV,EAAI,EAAK,EAAI,MACb,EAAQ,EAAE,cAAc,OAAO,QAAQ,MAAO,IAC9C,EAAO,EAAE,oDACT,EAAQ,EACT,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,EAAI,IAAI,MAAM,UAAY,IACnE,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GACT,IAAM,EAAQ,EAAK,KAAK,kBAAkB,OACpC,EAAW,EAAK,KAAK,kBAAkB,KAAK,QAClD,MAAO,CACH,MAAO,GAAG,EAAM,GAAG,IACnB,KAAM,IAAI,IAAI,EAAU,GAAG,EAAK,OAAO,KACvC,OAAQ,EAAK,KAAK,cAAc,OAChC,QAAS,EAAS,EAAU,EAAK,KAAK,YAAY,QAAQ,QAAS,MAIzE,EAAc,MAAM,QAAQ,IAC9B,EAAM,IAAK,GACP,EAAM,OAAO,EAAE,KAAM,UACjB,EAAE,YAAc,MAAM,EAAa,EAAE,MAC9B,MAKnB,MAAO,CACH,MAAO,eAAe,IACtB,KAAM,GAAG,EAAK,MAAM,EAAI,OAExB,KAAM,GAId,eAAe,EAAa,EAAK,CAE7B,IAAM,EAAe,EAAO,UAAU,QAAU,GAC1C,EAAS,MAAM,EAAI,EAAK,CAC1B,QAAS,CACL,OAAQ,KAGV,EAAS,EAAK,EAAO,MACrB,EAAQ,EAAO,SA8BrB,OA7BA,EAAO,aACF,KAAK,qBACL,KAAK,UAAY,CACd,GAAI,EAAO,MAAM,KAAK,0BAA0B,OAAS,EAAG,CACxD,IAAM,EAAU,EAAI,EAAA,KAAA,EAAA,iCAA8C,CAC9D,OAAQ,CACJ,KAAM,EAAO,MAAM,KAAK,4BAA4B,KAAK,QACzD,KAAM,EAAO,MAAM,KAAK,0BAA0B,OAClD,SAAU,EAAO,MAAM,KAAK,kCAAkC,QAElE,IAAK,EAAO,MAAM,KAAK,0BAA0B,OACjD,KAAM,EAAO,UAAU,OAE3B,EAAM,OAAO,MAIzB,EAAM,KAAK,OAAO,KAAK,UAAY,CAC/B,IAAM,EAAM,EAAO,MACb,EAAO,EAAI,KAAK,QAClB,IACA,EAAI,KAAK,MAAO,GAChB,EAAI,WAAW,YACf,EAAI,WAAW,QACf,EAAI,WAAW,eACf,EAAI,WAAW,cAIhB,EAAM"}