{"version":3,"file":"json-Cy2cdTPb.js","names":["route: Route","ConfigNotFoundError","got"],"sources":["../../lib/routes/rsshub/transform/json.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nfunction jsonGet(obj, attr) {\r\n    if (typeof attr !== 'string') {\r\n        return obj;\r\n    }\r\n    // a.b.c\r\n    // a.b[0].c => a.b.0.c\r\n    for (const key of attr.split('.')) {\r\n        obj = obj[key];\r\n    }\r\n    return obj;\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/transform/json/:url/:routeParams',\r\n    categories: ['other'],\r\n    example: '/rsshub/transform/json/https%3A%2F%2Fapi.github.com%2Frepos%2Fginuerzh%2Fgost%2Freleases/title=Gost%20releases&itemTitle=tag_name&itemLink=html_url&itemDesc=body',\r\n    parameters: { url: '`encodeURIComponent`ed URL address', routeParams: 'Transformation rules, requires URL encode' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Transformation - JSON',\r\n    maintainers: ['ttttmr'],\r\n    handler,\r\n    description: `Specify options (in the format of query string) in parameter \\`routeParams\\` parameter to extract data from JSON.\r\n\r\n| Key                | Meaning                                      | Accepted Values   | Default                                    |\r\n| ------------------ | -------------------------------------------- | ----------------- | ------------------------------------------ |\r\n| \\`title\\`          | The title of the RSS                         | \\`string\\`        | Extracted from home page of current domain |\r\n| \\`item\\`           | The JSON Path as \\`item\\` element            | \\`string\\`        | Entire JSON response                       |\r\n| \\`itemTitle\\`      | The JSON Path as \\`title\\` in \\`item\\`       | \\`string\\`        | None                                       |\r\n| \\`itemLink\\`       | The JSON Path as \\`link\\` in \\`item\\`        | \\`string\\`        | None                                       |\r\n| \\`itemLinkPrefix\\` | Optional Prefix for \\`itemLink\\` value       | \\`string\\`        | None                                       |\r\n| \\`itemDesc\\`       | The JSON Path as \\`description\\` in \\`item\\` | \\`string\\`        | None                                       |\r\n| \\`itemPubDate\\`    | The JSON Path as \\`pubDate\\` in \\`item\\`     | \\`string\\`        | None                                       |\r\n\r\n::: tip\r\nJSON Path only supports format like \\`a.b.c\\`. if you need to access arrays, like \\`a[0].b\\`, you can write it as \\`a.0.b\\`.\r\n:::\r\n\r\n  Parameters parsing in the above example:\r\n\r\n| Parameter     | Value                                                                    |\r\n| ------------- | ------------------------------------------------------------------------ |\r\n| \\`url\\`         | \\`https://api.github.com/repos/ginuerzh/gost/releases\\`                    |\r\n| \\`routeParams\\` | \\`title=Gost releases&itemTitle=tag_name&itemLink=html_url&itemDesc=body\\` |\r\n\r\n  Parsing of \\`routeParams\\` parameter:\r\n\r\n| Parameter   | Value           |\r\n| ----------- | --------------- |\r\n| \\`title\\`     | \\`Gost releases\\` |\r\n| \\`itemTitle\\` | \\`tag_name\\`      |\r\n| \\`itemLink\\`  | \\`html_url\\`      |\r\n| \\`itemDesc\\`  | \\`body\\`          |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.feature.allow_user_supply_unsafe_domain) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n    const url = ctx.req.param('url');\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n    });\r\n\r\n    const routeParams = new URLSearchParams(ctx.req.param('routeParams'));\r\n    let rssTitle = routeParams.get('title');\r\n    if (!rssTitle) {\r\n        const resp = await got({\r\n            method: 'get',\r\n            url: new URL(url).origin,\r\n        });\r\n        const $ = load(resp.data);\r\n        rssTitle = $('title').text();\r\n    }\r\n\r\n    const items = jsonGet(response.data, routeParams.get('item')).map((item) => {\r\n        let link = jsonGet(item, routeParams.get('itemLink')).trim();\r\n        const linkPrefix = routeParams.get('itemLinkPrefix');\r\n\r\n        if (link && linkPrefix) {\r\n            link = `${linkPrefix}${link}`;\r\n        }\r\n        // 补全绝对链接\r\n        if (link && !link.startsWith('http')) {\r\n            link = `${new URL(url).origin}${link}`;\r\n        }\r\n        return {\r\n            title: jsonGet(item, routeParams.get('itemTitle')),\r\n            link,\r\n            description: routeParams.get('itemDesc') ? jsonGet(item, routeParams.get('itemDesc')) : '',\r\n            pubDate: routeParams.get('itemPubDate') ? jsonGet(item, routeParams.get('itemPubDate')) : '',\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: rssTitle,\r\n        link: url,\r\n        description: `Proxy ${url}`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"0VAMA,SAAS,EAAQ,EAAK,EAAM,CACxB,GAAI,OAAO,GAAS,SAChB,OAAO,EAIX,IAAK,IAAM,KAAO,EAAK,MAAM,KACzB,EAAM,EAAI,GAEd,OAAO,EAGX,MAAaA,EAAe,CACxB,KAAM,oCACN,WAAY,CAAC,SACb,QAAS,oKACT,WAAY,CAAE,IAAK,qCAAsC,YAAa,6CACtE,SAAU,CACN,cAAe,CACX,CACI,KAAM,kCACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,wBACN,YAAa,CAAC,UACd,UACA,YAAa,0jEAiCjB,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,QAAQ,gCAChB,MAAM,IAAIC,EAAoB,mFAElC,IAAM,EAAM,EAAI,IAAI,MAAM,OACpB,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,QAGE,EAAc,IAAI,gBAAgB,EAAI,IAAI,MAAM,gBAClD,EAAW,EAAY,IAAI,SAC/B,GAAI,CAAC,EAAU,CACX,IAAM,EAAO,MAAMA,EAAI,CACnB,OAAQ,MACR,IAAK,IAAI,IAAI,GAAK,SAEhB,EAAI,EAAK,EAAK,MACpB,EAAW,EAAE,SAAS,OAG1B,IAAM,EAAQ,EAAQ,EAAS,KAAM,EAAY,IAAI,SAAS,IAAK,GAAS,CACxE,IAAI,EAAO,EAAQ,EAAM,EAAY,IAAI,aAAa,OAChD,EAAa,EAAY,IAAI,kBASnC,OAPI,GAAQ,IACR,EAAO,GAAG,IAAa,KAGvB,GAAQ,CAAC,EAAK,WAAW,UACzB,EAAO,GAAG,IAAI,IAAI,GAAK,SAAS,KAE7B,CACH,MAAO,EAAQ,EAAM,EAAY,IAAI,cACrC,OACA,YAAa,EAAY,IAAI,YAAc,EAAQ,EAAM,EAAY,IAAI,aAAe,GACxF,QAAS,EAAY,IAAI,eAAiB,EAAQ,EAAM,EAAY,IAAI,gBAAkB,MAIlG,MAAO,CACH,MAAO,EACP,KAAM,EACN,YAAa,SAAS,IACtB,KAAM"}