{"version":3,"file":"util-TgCRvXgW.js","names":["got"],"sources":["../../lib/routes/cyzone/util.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst rootUrl = 'https://www.cyzone.cn';\r\nconst apiRootUrl = 'https://api1.cyzone.cn';\r\nconst apiShowUrl = new URL('v2/content/app_content/show', apiRootUrl).href;\r\n\r\n/**\r\n * Retrieves information from a given URL using a provided tryGet function.\r\n * @param {string} url        - The URL to retrieve information from.\r\n * @param {Function} tryGet   - The tryGet function that handles the retrieval process.\r\n * @returns {Promise<Object>} - A promise that resolves to an object containing the retrieved information.\r\n */\r\nconst getInfo = (url, tryGet) =>\r\n    tryGet(url, async () => {\r\n        const { data: response } = await got(url);\r\n\r\n        const $ = load(response);\r\n\r\n        const avatar = $('img.avatar')?.prop('src')?.split('?')[0] ?? undefined;\r\n        const icon = new URL($('link[rel=\"icon\"]')?.prop('href'), rootUrl).href;\r\n        const image = new URL($('div.logo img')?.prop('src'), rootUrl).href;\r\n\r\n        return {\r\n            title: $('title').text(),\r\n            link: url,\r\n            description: $('meta[name=\"description\"]').prop('content'),\r\n            language: 'zh-cn',\r\n            image: avatar || image,\r\n            icon,\r\n            logo: icon,\r\n            subtitle: $('meta[name=\"keywords\"]').prop('content'),\r\n            author: $('meta[name=\"app-mobile-web-app-title\"]').prop('content'),\r\n        };\r\n    });\r\n\r\n/**\r\n * Process the item list and return the resulting array.\r\n * @param {string} apiUrl          - The URL of the API.\r\n * @param {number} limit           - The limit of the results.\r\n * @param {function} tryGet        - The tryGet function that handles the retrieval process.\r\n * @param {...Object} searchParams - The search parameter objects.\r\n * @returns {Promise<Array>}       - The processed item array.\r\n */\r\nconst processItems = async (apiUrl, limit, tryGet, ...params) => {\r\n    // Merge search parameters\r\n    let searchParams = {\r\n        size: limit,\r\n    };\r\n    for (const param of params) {\r\n        searchParams = {\r\n            ...searchParams,\r\n            ...param,\r\n        };\r\n    }\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams,\r\n    });\r\n\r\n    let items = (response.data?.article ?? response.data?.data ?? response.data).slice(0, limit).map((item) => {\r\n        item = item.item ?? item;\r\n\r\n        return {\r\n            title: item.title,\r\n            link: /^\\/\\//.test(item.url) ? `https:${item.url}` : item.url,\r\n            description: item.description,\r\n            category: [item.category_name, ...(item.tags?.split(',') ?? [])],\r\n            guid: item.content_id,\r\n            pubDate: parseDate(item.published_at * 1000),\r\n            upvotes: item.votes ?? 0,\r\n        };\r\n    });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            tryGet(`cyzone-${item.guid}`, async () => {\r\n                const { data: detailResponse } = await got.post(apiShowUrl, {\r\n                    json: {\r\n                        content_id: item.guid,\r\n                    },\r\n                });\r\n\r\n                const data = detailResponse.data;\r\n\r\n                const categories = [data.category, ...item.category, ...(data.tags?.split(',') ?? [])];\r\n\r\n                const content = load(data.content);\r\n\r\n                content('img').each(function () {\r\n                    if (content(this).prop('src')) {\r\n                        content(this).prop('src', content(this).prop('src').split('?')[0]);\r\n                    } else {\r\n                        content(this).remove();\r\n                    }\r\n                });\r\n\r\n                item.title = data.title;\r\n                // api 返回的 link_url 数据可能是空, 所有最好自己通过 id 拼接 url\r\n                item.link = `${rootUrl}/article/${item.guid}.html`;\r\n                item.description = content.html();\r\n                item.author = data.author_name ?? data.author;\r\n                item.category = [...new Set(categories)].filter(Boolean);\r\n                item.guid = `cyzone-${item.guid}`;\r\n                item.pubDate = parseDate(data.published_at * 1000);\r\n                item.upvotes = data.votes ?? 0;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return items;\r\n};\r\n\r\nexport { rootUrl, apiRootUrl, getInfo, processItems };\r\n"],"mappings":"oIAIA,MAAM,EAAU,wBACV,EAAa,yBACb,EAAa,IAAI,IAAI,8BAA+B,GAAY,KAQhE,GAAW,EAAK,IAClB,EAAO,EAAK,SAAY,CACpB,GAAM,CAAE,KAAM,GAAa,MAAMA,EAAI,GAE/B,EAAI,EAAK,GAET,EAAS,EAAE,eAAe,KAAK,QAAQ,MAAM,KAAK,IAAM,IAAA,GACxD,EAAO,IAAI,IAAI,EAAE,qBAAqB,KAAK,QAAS,GAAS,KAC7D,EAAQ,IAAI,IAAI,EAAE,iBAAiB,KAAK,OAAQ,GAAS,KAE/D,MAAO,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,QACV,MAAO,GAAU,EACjB,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,OAAQ,EAAE,yCAAyC,KAAK,cAY9D,EAAe,MAAO,EAAQ,EAAO,EAAQ,GAAG,IAAW,CAE7D,IAAI,EAAe,CACf,KAAM,GAEV,IAAK,IAAM,KAAS,EAChB,EAAe,CACX,GAAG,EACH,GAAG,GAIX,GAAM,CAAE,KAAM,GAAa,MAAMA,EAAI,EAAQ,CACzC,iBAGA,GAAS,EAAS,MAAM,SAAW,EAAS,MAAM,MAAQ,EAAS,MAAM,MAAM,EAAG,GAAO,IAAK,IAC9F,EAAO,EAAK,MAAQ,EAEb,CACH,MAAO,EAAK,MACZ,KAAM,QAAQ,KAAK,EAAK,KAAO,SAAS,EAAK,MAAQ,EAAK,IAC1D,YAAa,EAAK,YAClB,SAAU,CAAC,EAAK,cAAe,GAAI,EAAK,MAAM,MAAM,MAAQ,IAC5D,KAAM,EAAK,WACX,QAAS,EAAU,EAAK,aAAe,KACvC,QAAS,EAAK,OAAS,KA0C/B,MAtCA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAO,UAAU,EAAK,OAAQ,SAAY,CACtC,GAAM,CAAE,KAAM,GAAmB,MAAMA,EAAI,KAAK,EAAY,CACxD,KAAM,CACF,WAAY,EAAK,QAInB,EAAO,EAAe,KAEtB,EAAa,CAAC,EAAK,SAAU,GAAG,EAAK,SAAU,GAAI,EAAK,MAAM,MAAM,MAAQ,IAE5E,EAAU,EAAK,EAAK,SAoB1B,OAlBA,EAAQ,OAAO,KAAK,UAAY,CACxB,EAAQ,MAAM,KAAK,OACnB,EAAQ,MAAM,KAAK,MAAO,EAAQ,MAAM,KAAK,OAAO,MAAM,KAAK,IAE/D,EAAQ,MAAM,WAItB,EAAK,MAAQ,EAAK,MAElB,EAAK,KAAO,GAAG,EAAQ,WAAW,EAAK,KAAK,OAC5C,EAAK,YAAc,EAAQ,OAC3B,EAAK,OAAS,EAAK,aAAe,EAAK,OACvC,EAAK,SAAW,CAAC,GAAG,IAAI,IAAI,IAAa,OAAO,SAChD,EAAK,KAAO,UAAU,EAAK,OAC3B,EAAK,QAAU,EAAU,EAAK,aAAe,KAC7C,EAAK,QAAU,EAAK,OAAS,EAEtB,MAKZ"}