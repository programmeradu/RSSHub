{"version":3,"file":"cfr-CHSnUTWt.js","names":["cache","ofetch","dataItem: DataItem","route: Route","ofetch","selectorMap: {\r\n        [key: string]: string;\r\n    }"],"sources":["../../lib/routes/cfr/utils.ts","../../lib/routes/cfr/index.ts"],"sourcesContent":["import { type Cheerio, type CheerioAPI, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport ofetch from '@/utils/ofetch';\r\nimport type { DataItem } from '@/types';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport cache from '@/utils/cache';\r\nimport type { LinkData, VideoSetup } from './types';\r\n\r\nexport function getDataItem(href: string) {\r\n    const origin = 'https://www.cfr.org';\r\n    const link = `${origin}${href}`;\r\n\r\n    return cache.tryGet(link, async () => {\r\n        const prefix = href?.split('/')[1];\r\n        const res = await ofetch(link);\r\n        const $ = load(res);\r\n\r\n        let dataItem: DataItem;\r\n\r\n        switch (prefix) {\r\n            case 'article':\r\n                dataItem = parseArticle($);\r\n                break;\r\n            case 'blog':\r\n                dataItem = parseBlog($);\r\n                break;\r\n            case 'book':\r\n                dataItem = parseBook($);\r\n                break;\r\n            case 'conference-calls':\r\n                dataItem = parseConferenceCalls($);\r\n                break;\r\n            case 'event':\r\n                dataItem = parseEvent($);\r\n                break;\r\n            case 'backgrounder':\r\n                dataItem = parseBackgrounder($);\r\n                break;\r\n            case 'podcasts':\r\n                dataItem = parsePodcasts($);\r\n                break;\r\n            case 'task-force-report':\r\n                dataItem = parseTaskForceReport($);\r\n                break;\r\n            case 'timeline':\r\n                dataItem = parseTimeline($);\r\n                break;\r\n            case 'video':\r\n                dataItem = parseVideo($);\r\n                break;\r\n            default:\r\n                dataItem = parseDefault($);\r\n        }\r\n\r\n        return {\r\n            ...dataItem,\r\n            link,\r\n        };\r\n    }) as Promise<DataItem>;\r\n}\r\n\r\nfunction parseArticle($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    let description = parseDescription($('.body-content'), $);\r\n    const $articleHeader = $('.article-header__image');\r\n    if ($articleHeader.length) {\r\n        description = `<figure>${$articleHeader.html()}</figure><br>${description}`;\r\n    }\r\n    return {\r\n        title: linkData?.title ?? $('.article-header__title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseBlog($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    let description = parseDescription($('.body-content'), $);\r\n    const figure = $('.article-header-blog__figure');\r\n    if (figure.length) {\r\n        description = `<figure>${figure.html()}</figure><br>${description}`;\r\n    }\r\n    return {\r\n        title: linkData?.title ?? $('.article-header-blog__title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseBook($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    let description = parseDescription($('.body-content'), $);\r\n    const sectionTop = $('.article-header__section-top');\r\n    description = `${sectionTop.html()}<br>${description}`;\r\n\r\n    return {\r\n        title: linkData?.title ?? $('.article-header__title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseConferenceCalls($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    const description = parseDescription($('.podcast-body').last(), $);\r\n    return {\r\n        title: linkData?.title ?? $('head title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseEvent($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    let description = parseDescription($('.body-content'), $);\r\n    const videoIfame = getVideoIframe($('.msp-event-video'));\r\n    if (videoIfame) {\r\n        description = `${videoIfame}<br>${description}`;\r\n    }\r\n\r\n    return {\r\n        title: linkData?.title ?? $('.msp-event-header-past__title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseBackgrounder($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    let description = parseDescription($('.main-wrapper__article-body .body-content'), $);\r\n    const summary = $('.main-wrapper__article-body .summary').html();\r\n    if (summary) {\r\n        description = `${summary}<br>${description}`;\r\n    }\r\n    const figure = $('.article-header-backgrounder__figure');\r\n    if (figure.length) {\r\n        description = `<figure>${figure.html()}</figure><br>${description}`;\r\n    }\r\n\r\n    return {\r\n        title: linkData?.title ?? $('.article-header-backgrounder__title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parsePodcasts($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    let description = $('.body-content').first().html() ?? '';\r\n    const audioSrc = $('#player-default').attr('src');\r\n    if (audioSrc) {\r\n        description = `<audio controls src=\"${audioSrc}\"></audio><br>${description}`;\r\n    }\r\n    return {\r\n        title: linkData?.title ?? $('head title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n        enclosure_url: audioSrc,\r\n        enclosure_type: 'audio/mpeg',\r\n    };\r\n}\r\n\r\nfunction parseTaskForceReport($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n\r\n    let description = '';\r\n\r\n    $('.main-content').each((_, ele) => {\r\n        const $ele = $(ele);\r\n        const content = $ele.find('.content_area').html() ?? '';\r\n        description += `${content}<br>`;\r\n    });\r\n\r\n    return {\r\n        title: linkData?.title ?? $('.hero__title').remove('.subtitle').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseTimeline($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n\r\n    const $description = $('.timeline-slides');\r\n    $description.find('.timeline-slide__shadow').remove();\r\n    $description.find('.field--image').each((_, ele) => {\r\n        $(ele).replaceWith($(ele).find('img'));\r\n    });\r\n    let description = $description.find('.timeline-intro__description').html() ?? '';\r\n    for (const item of $description.find('.timeline-slide__content').toArray()) {\r\n        const $item = $(item);\r\n        $item.find('.timeline-slide__dates-header').replaceWith('<h1>' + $item.find('.timeline-slide__dates-header').text() + '</h1>');\r\n        $item.find('.timeline-slide__dates').replaceWith('<h2>' + $item.find('.timeline-slide__dates').text() + '</h2>');\r\n        description += `<br>${$item.html()}`;\r\n    }\r\n    return {\r\n        title: linkData?.title ?? $('.timeline-header__title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseVideo($: CheerioAPI): DataItem {\r\n    const linkData = parseLinkData($);\r\n    let description = parseDescription($('.body-content'), $);\r\n    const $articleHeader = $('.article-header__image');\r\n    const videoIfame = getVideoIframe($articleHeader);\r\n    if (videoIfame) {\r\n        description = `${videoIfame}<br>${description}`;\r\n    }\r\n\r\n    return {\r\n        title: linkData?.title ?? $('.article-header__title').text(),\r\n        pubDate: linkData?.pubDate,\r\n        description,\r\n    };\r\n}\r\n\r\nfunction parseDefault($): DataItem {\r\n    if ($('.body-content').length) {\r\n        return parseArticle($);\r\n    }\r\n    const linkData = parseLinkData($);\r\n    return {\r\n        title: linkData?.title ?? $('head title').text(),\r\n        pubDate: linkData?.pubDate,\r\n    };\r\n}\r\n\r\nfunction parseLinkData($: CheerioAPI) {\r\n    try {\r\n        const data = (<LinkData>JSON.parse($('script[type=\"application/ld+json\"]').text()))['@graph'][0];\r\n\r\n        return {\r\n            title: data.name,\r\n            pubDate: parseDate(data.dateModified),\r\n        };\r\n    } catch {\r\n        // ignore\r\n    }\r\n}\r\n\r\nfunction getVideoIframe($ele: Cheerio<Element>) {\r\n    const setup = $ele.find('video').data('setup') as VideoSetup;\r\n    if (setup) {\r\n        const youtubeSource = setup.sources.find((i) => i.type === 'video/youtube');\r\n        if (youtubeSource) {\r\n            const videoId = youtubeSource.src.match(/\\?v=([^&]+)/)?.[1];\r\n            if (videoId) {\r\n                return `<iframe src=\"https://www.youtube-nocookie.com/embed/${videoId}\" width=\"640\" height=\"360\" frameborder=\"0\" allowfullscreen></iframe>`;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nfunction parseDescription($description: Cheerio<Element>, $: CheerioAPI) {\r\n    $description.find('.desktop-only').remove();\r\n    $description.find('.mobile-only').remove();\r\n    $description.find('.newsletter-tout').remove();\r\n    $description.find('.carousel-gallery').remove();\r\n    $description.find('svg').remove();\r\n    $description.find('.field--image').each((_, ele) => {\r\n        $(ele).replaceWith($(ele).find('img'));\r\n    });\r\n    $description.find('.video-embed').each((_, ele) => {\r\n        const $ele = $(ele);\r\n        const videoIframe = getVideoIframe($ele);\r\n        if (videoIframe) {\r\n            $ele.replaceWith(videoIframe);\r\n        }\r\n    });\r\n\r\n    const description = $description.html() ?? '';\r\n\r\n    return description;\r\n}\r\n","import type { Data, Route } from '@/types';\r\nimport type { Context } from 'hono';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { getDataItem } from './utils';\r\nimport pMap from 'p-map';\r\n\r\nexport const route: Route = {\r\n    path: '/:category/:subCategory?',\r\n    categories: ['traditional-media'],\r\n    parameters: {\r\n        category: 'category, find it in the URL',\r\n        subCategory: 'sub-category, find it in the URL',\r\n    },\r\n    example: '/cfr/asia',\r\n    name: 'News',\r\n    maintainers: ['KarasuShin'],\r\n    handler,\r\n    radar: [\r\n        {\r\n            source: ['www.cfr.org/:category', 'www.cfr.org/:category/:subCategory'],\r\n            target: '/:category/:subCategory?',\r\n        },\r\n    ],\r\n    features: {\r\n        antiCrawler: true,\r\n    },\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const { category, subCategory } = ctx.req.param();\r\n\r\n    const origin = 'https://www.cfr.org';\r\n    let link = `${origin}/${category}`;\r\n    if (subCategory) {\r\n        link += `/${subCategory}`;\r\n    }\r\n    const res = await ofetch(link);\r\n\r\n    const $ = load(res);\r\n\r\n    const selectorMap: {\r\n        [key: string]: string;\r\n    } = {\r\n        podcasts: '.episode-content__title a',\r\n        blog: '.card-series__content-link',\r\n        'books-reports': '.card-article__link',\r\n    };\r\n\r\n    const listSelector = selectorMap[category] ?? '.card-article-large__link';\r\n\r\n    const items = await pMap($(listSelector).toArray(), (item) => getDataItem($(item).attr('href')!), { concurrency: 5 });\r\n\r\n    return {\r\n        title: $('head title').text().replace(' | Council on Foreign Relations', ''),\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}