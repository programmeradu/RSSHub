{"version":3,"file":"category-DsN8UJko.js","names":["route: Route","InvalidParameterError","parser","cache","got"],"sources":["../../lib/routes/gamme/category.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport parser from '@/utils/rss-parser';\r\nimport { isValidHost } from '@/utils/valid-host';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/:domain/:category?',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { domain = 'news', category } = ctx.req.param();\r\n    if (!isValidHost(domain)) {\r\n        throw new InvalidParameterError('Invalid domain');\r\n    }\r\n    const baseUrl = `https://${domain}.gamme.com.tw`;\r\n    const feed = await parser.parseURL(`${baseUrl + (category ? `/category/${category}` : '')}/feed`);\r\n\r\n    const items = await Promise.all(\r\n        feed.items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data } = await got(item.link);\r\n                const $ = load(data);\r\n\r\n                $('.entry img').each((_, img) => {\r\n                    if (img.attribs['data-original'] || img.attribs['data-src']) {\r\n                        img.attribs.src = img.attribs['data-original'] || img.attribs['data-src'];\r\n                        delete img.attribs['data-original'];\r\n                        delete img.attribs['data-src'];\r\n                    }\r\n                });\r\n\r\n                item.author = $('.author_name').text().trim();\r\n                item.category = $('.tags a')\r\n                    .toArray()\r\n                    .map((tag) => $(tag).text());\r\n                $('.social_block, .tags').remove();\r\n                item.description = $('.entry').html();\r\n\r\n                delete item.content;\r\n                delete item.contentSnippet;\r\n                delete item.isoDate;\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: feed.title,\r\n        link: feed.link,\r\n        image: domain === 'news' ? `${baseUrl}/blogico.ico` : `${baseUrl}/favicon.ico`,\r\n        description: feed.description,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ofAQA,MAAaA,EAAe,CACxB,KAAM,sBACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,SAAS,OAAQ,YAAa,EAAI,IAAI,QAC9C,GAAI,CAAC,EAAY,GACb,MAAM,IAAIC,EAAsB,kBAEpC,IAAM,EAAU,WAAW,EAAO,eAC5B,EAAO,MAAMC,EAAO,SAAS,GAAG,GAAW,EAAW,aAAa,IAAa,IAAI,QAEpF,EAAQ,MAAM,QAAQ,IACxB,EAAK,MAAM,IAAK,GACZC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,QAAS,MAAMC,EAAI,EAAK,MAC1B,EAAI,EAAK,GAoBf,OAlBA,EAAE,cAAc,MAAM,EAAG,IAAQ,EACzB,EAAI,QAAQ,kBAAoB,EAAI,QAAQ,eAC5C,EAAI,QAAQ,IAAM,EAAI,QAAQ,kBAAoB,EAAI,QAAQ,YAC9D,OAAO,EAAI,QAAQ,iBACnB,OAAO,EAAI,QAAQ,eAI3B,EAAK,OAAS,EAAE,gBAAgB,OAAO,OACvC,EAAK,SAAW,EAAE,WACb,UACA,IAAK,GAAQ,EAAE,GAAK,QACzB,EAAE,wBAAwB,SAC1B,EAAK,YAAc,EAAE,UAAU,OAE/B,OAAO,EAAK,QACZ,OAAO,EAAK,eACZ,OAAO,EAAK,QACL,MAKnB,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,MAAO,IAAW,OAAS,GAAG,EAAQ,cAAgB,GAAG,EAAQ,cACjE,YAAa,EAAK,YAClB,KAAM"}