{"version":3,"file":"programme-CZU2uFe4.js","names":[],"sources":["../../lib/routes/sctv/programme.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/programme/:id?/:limit?/:isFull?',\r\n    categories: ['traditional-media'],\r\n    example: '/sctv/programme/1',\r\n    parameters: { id: '节目 id，可在对应节目页中找到，默认为 `1`，即四川新闻联播', limit: '期数，默认为 15，即单次获取最新 15 期', isFull: '是否仅获取完整视频，填写 true/yes 表示是、false/no 表示否，默认是' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '电视回放',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `::: tip\r\n  参数 **是否仅获取完整视频** 设置为 \\`true\\` \\`yes\\` \\`t\\` \\`y\\` 等值后，路由仅返回当期节目的完整视频，而不会返回节目所提供的节选视频。\r\n\r\n  查看更多电视节目请前往 [电视回放](https://www.sctv.com/column/list)\r\n:::\r\n\r\n| 节目                   | id      |\r\n| ---------------------- | ------- |\r\n| 四川新闻联播           | 1       |\r\n| 早安四川               | 2       |\r\n| 今日视点               | 3       |\r\n| 龙门阵摆四川           | 10523   |\r\n| 非常话题               | 1014756 |\r\n| 新闻现场               | 8385    |\r\n| 黄金三十分             | 8386    |\r\n| 全媒直播间             | 8434    |\r\n| 晚报十点半             | 8435    |\r\n| 现场快报               | 8436    |\r\n| 四川乡村新闻           | 3673    |\r\n| 四川文旅报道           | 8174    |\r\n| 乡村会客厅             | 3674    |\r\n| 金字招牌               | 3675    |\r\n| 问您所 “？”            | 3677    |\r\n| 蜀你最能               | 3679    |\r\n| 美丽乡村印象           | 3678    |\r\n| 美丽乡村               | 3676    |\r\n| 乡村大篷车             | 3680    |\r\n| 华西论健               | 3681    |\r\n| 乡村聚乐部             | 3682    |\r\n| 医保近距离             | 6403    |\r\n| 音你而来               | 7263    |\r\n| 吃八方                 | 7343    |\r\n| 世界那么大             | 7344    |\r\n| 风云川商               | 7345    |\r\n| 麻辣烫                 | 7346    |\r\n| 财经快报               | 7473    |\r\n| 医生来了               | 7873    |\r\n| 安逸的旅途             | 8383    |\r\n| 运动 +                 | 8433    |\r\n| 好戏连台               | 9733    |\r\n| 防癌大讲堂             | 1018673 |\r\n| 消费新观察             | 1017153 |\r\n| 天天耍大牌             | 1014753 |\r\n| 廉洁四川               | 1014754 |\r\n| 看世界                 | 1014755 |\r\n| 金熊猫说教育（资讯版） | 1014757 |\r\n| 她说                   | 1014759 |\r\n| 嗨宝贝                 | 1014762 |\r\n| 萌眼看世界             | 1014764 |\r\n| 乡村大讲堂             | 1014765 |\r\n| 四川党建               | 1014766 |\r\n| 健康四川               | 1014767 |\r\n| 技能四川               | 12023   |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id') ?? '1';\r\n    const limit = ctx.req.param('limit') ? Number.parseInt(ctx.req.param('limit')) : 15;\r\n    const isFull = /t|y/i.test(ctx.req.param('isFull') ?? 'true');\r\n\r\n    const rootUrl = 'https://www.sctv.com';\r\n    const apiRootUrl = 'https://kscgc.sctv-tf.com';\r\n    const apiUrl = `${apiRootUrl}/sctv/lookback/${id}/date.json`;\r\n    const listUrl = `${apiRootUrl}/sctv/lookback/index/lookbackList.json`;\r\n    const currentUrl = `${rootUrl}/column/detail?programmeIndex=/sctv/lookback/${id}/index.json`;\r\n\r\n    let response = await got({\r\n        method: 'get',\r\n        url: apiUrl,\r\n    });\r\n\r\n    let items = [];\r\n\r\n    const array = response.data.data.programmeArray.slice(0, limit).map((list) => ({\r\n        guid: list.id,\r\n        link: `${apiRootUrl}${list.programmeListUrl}`,\r\n    }));\r\n\r\n    await Promise.all(\r\n        array.map((list) =>\r\n            cache.tryGet(list.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: list.link,\r\n                });\r\n\r\n                const currentItems = detailResponse.data.data.programmeList.map((item) => ({\r\n                    guid: item.id,\r\n                    title: item.programmeTitle,\r\n                    link: item.programmeUrl,\r\n                    pubDate: timezone(parseDate(item.pubTime), +8),\r\n                    description: art(path.join(__dirname, 'templates/description.art'), {\r\n                        cover: item.programmeImage,\r\n                        video: item.programmeUrl,\r\n                    }),\r\n                }));\r\n\r\n                let currentFullItems = [];\r\n\r\n                if (isFull) {\r\n                    currentFullItems = currentItems.filter((item) => /（\\d{4}(?:\\.\\d{2}){2}）/.test(item.title));\r\n                }\r\n\r\n                items = [...items, ...(currentFullItems.length === 0 ? currentItems : currentFullItems)];\r\n            })\r\n        )\r\n    );\r\n\r\n    response = await got({\r\n        method: 'get',\r\n        url: listUrl,\r\n    });\r\n\r\n    let name, cover;\r\n    for (const p of response.data.data.programme_official) {\r\n        if (p.programmeId === id) {\r\n            name = p.programmeName;\r\n            cover = p.programmeCover;\r\n            break;\r\n        }\r\n    }\r\n\r\n    return {\r\n        title: `四川广播电视台 - ${name}`,\r\n        link: currentUrl,\r\n        item: items.slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 100),\r\n        image: cover,\r\n    };\r\n}\r\n"],"mappings":"2eASA,MAAa,EAAe,CACxB,KAAM,mCACN,WAAY,CAAC,qBACb,QAAS,oBACT,WAAY,CAAE,GAAI,mCAAoC,MAAO,yBAA0B,OAAQ,8CAC/F,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mCAuDjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,OAAS,IAC5B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,GAC3E,EAAS,OAAO,KAAK,EAAI,IAAI,MAAM,WAAa,QAGhD,EAAa,4BACb,EAAS,GAAG,EAAW,iBAAiB,EAAG,YAC3C,EAAU,GAAG,EAAW,wCACxB,EAAa,oEAA0D,EAAG,aAE5E,EAAW,MAAM,EAAI,CACrB,OAAQ,MACR,IAAK,IAGL,EAAQ,GAEN,EAAQ,EAAS,KAAK,KAAK,eAAe,MAAM,EAAG,GAAO,IAAK,IAAU,CAC3E,KAAM,EAAK,GACX,KAAM,GAAG,IAAa,EAAK,sBAG/B,MAAM,QAAQ,IACV,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAe,EAAe,KAAK,KAAK,cAAc,IAAK,IAAU,CACvE,KAAM,EAAK,GACX,MAAO,EAAK,eACZ,KAAM,EAAK,aACX,QAAS,EAAS,EAAU,EAAK,SAAU,GAC3C,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,EAAK,eACZ,MAAO,EAAK,kBAIhB,EAAmB,GAEnB,IACA,EAAmB,EAAa,OAAQ,GAAS,wBAAwB,KAAK,EAAK,SAGvF,EAAQ,CAAC,GAAG,EAAO,GAAI,EAAiB,SAAW,EAAI,EAAe,OAKlF,EAAW,MAAM,EAAI,CACjB,OAAQ,MACR,IAAK,IAGT,IAAI,EAAM,EACV,IAAK,IAAM,KAAK,EAAS,KAAK,KAAK,mBAC/B,GAAI,EAAE,cAAgB,EAAI,CACtB,EAAO,EAAE,cACT,EAAQ,EAAE,eACV,MAIR,MAAO,CACH,MAAO,aAAa,IACpB,KAAM,EACN,KAAM,EAAM,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,KACxF,MAAO"}