{"version":3,"file":"jwc-DwDDce-O.js","names":["got","route: Route","cache"],"sources":["../../lib/routes/sjtu/jwc.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst urlRoot = 'https://jwc.sjtu.edu.cn';\r\n\r\nasync function getFullArticle(link) {\r\n    const response = await got(link).catch(() => null);\r\n    if (!response) {\r\n        return null;\r\n    }\r\n    const $ = load(response.body);\r\n    const content = $('.content-con');\r\n    if (content.length === 0) {\r\n        return null;\r\n    }\r\n    // resolve links of <img> and <a>\r\n    content.find('img').each((_, e) => {\r\n        const relativeLink = $(e).attr('src');\r\n        const absLink = new URL(relativeLink, urlRoot).href;\r\n        $(e).attr('src', absLink);\r\n    });\r\n    content.find('a').each((_, e) => {\r\n        const relativeLink = $(e).attr('href');\r\n        const absLink = new URL(relativeLink, urlRoot).href;\r\n        $(e).attr('href', absLink);\r\n    });\r\n    return content.html() + ($('.Newslist2').length ? $('.Newslist2').html() : '');\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/jwc/:type?',\r\n    categories: ['university'],\r\n    example: '/sjtu/jwc',\r\n    parameters: { type: '默认为 notice' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '教务处通知公告',\r\n    maintainers: ['SeanChao'],\r\n    handler,\r\n    description: `| 新闻中心 | 通知通告 | 教学运行  | 注册学务 | 研究办 | 教改办 | 综合办 | 语言文字 | 工会与支部 | 通识教育 | 面向学生的通知 |\r\n| -------- | -------- | --------- | -------- | ------ | ------ | ------ | -------- | ---------- | -------- |\r\n| news     | notice   | operation | affairs  | yjb    | jgb    | zhb    | language | party      | ge       | students  |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const type = ctx.req.param('type') ?? 'notice';\r\n    const config = {\r\n        all: {\r\n            section: '通知通告',\r\n            link: '/xwtg/tztg.htm',\r\n        },\r\n        news: {\r\n            link: '/xwtg/xwzx.htm',\r\n            section: '新闻中心',\r\n        },\r\n        notice: {\r\n            link: '/xwtg/tztg.htm',\r\n            section: '通知通告',\r\n        },\r\n        operation: {\r\n            link: '/xwtg/jxyx.htm',\r\n            section: '教学运行',\r\n        },\r\n        affairs: {\r\n            link: '/xwtg/zcxw.htm',\r\n            section: '注册学务',\r\n        },\r\n        yjb: {\r\n            link: '/xwtg/yjb.htm',\r\n            section: '研究办',\r\n        },\r\n        jgb: {\r\n            link: '/xwtg/jgb.htm',\r\n            section: '教改办',\r\n        },\r\n        zhb: {\r\n            link: '/xwtg/zhb.htm',\r\n            section: '综合办',\r\n        },\r\n        language: {\r\n            link: '/xwtg/yywz.htm',\r\n            section: '语言文字',\r\n        },\r\n        party: {\r\n            link: '/xwtg/ghyzb.htm',\r\n            section: '工会与支部',\r\n        },\r\n        ge: {\r\n            link: '/xwtg/tsjy.htm',\r\n            section: '通识教育',\r\n        },\r\n        students: {\r\n            link: '/index/mxxsdtz.htm',\r\n            section: '面向学生的通知',\r\n        },\r\n    };\r\n\r\n    const sectionLink = urlRoot + config[type].link;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: sectionLink,\r\n    });\r\n\r\n    const $ = load(response.body);\r\n\r\n    const out = await Promise.all(\r\n        $('body > div.list-box > div.container > div > div.ny_right > div > div.ny_right_con > div > ul')\r\n            .find('li')\r\n            .toArray()\r\n            .map((e) => {\r\n                const info = $(e).find('.wz');\r\n                const relativeLink = info.find('a').attr('href');\r\n                const link = new URL(relativeLink, sectionLink).href;\r\n                const title = info.find('a > h2').text();\r\n                const timeElement = $(e).find('.sj');\r\n                const day = timeElement.find('h2').text();\r\n                const yearAndMonth = timeElement.find('p').text();\r\n                const pubDate = parseDate(`${yearAndMonth}.${day}`, 'YYYY.MM.DD');\r\n                return cache.tryGet(link, async () => {\r\n                    const description = await getFullArticle(link);\r\n                    return {\r\n                        title,\r\n                        link,\r\n                        pubDate,\r\n                        description,\r\n                    };\r\n                });\r\n            })\r\n    );\r\n\r\n    return {\r\n        title: '上海交通大学教务处 ' + config[type].section,\r\n        link: sectionLink,\r\n        item: out,\r\n    };\r\n}\r\n"],"mappings":"wWAMA,MAAM,EAAU,0BAEhB,eAAe,EAAe,EAAM,CAChC,IAAM,EAAW,MAAMA,EAAI,GAAM,UAAY,MAC7C,GAAI,CAAC,EACD,OAAO,KAEX,IAAM,EAAI,EAAK,EAAS,MAClB,EAAU,EAAE,gBAelB,OAdI,EAAQ,SAAW,EACZ,MAGX,EAAQ,KAAK,OAAO,MAAM,EAAG,IAAM,CAC/B,IAAM,EAAe,EAAE,GAAG,KAAK,OACzB,EAAU,IAAI,IAAI,EAAc,GAAS,KAC/C,EAAE,GAAG,KAAK,MAAO,KAErB,EAAQ,KAAK,KAAK,MAAM,EAAG,IAAM,CAC7B,IAAM,EAAe,EAAE,GAAG,KAAK,QACzB,EAAU,IAAI,IAAI,EAAc,GAAS,KAC/C,EAAE,GAAG,KAAK,OAAQ,KAEf,EAAQ,QAAU,EAAE,cAAc,OAAS,EAAE,cAAc,OAAS,KAG/E,MAAaC,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,cACb,QAAS,YACT,WAAY,CAAE,KAAM,cACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,UACN,YAAa,CAAC,YACd,UACA,YAAa;;2HAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,SAChC,EAAS,CACX,IAAK,CACD,QAAS,OACT,KAAM,kBAEV,KAAM,CACF,KAAM,iBACN,QAAS,QAEb,OAAQ,CACJ,KAAM,iBACN,QAAS,QAEb,UAAW,CACP,KAAM,iBACN,QAAS,QAEb,QAAS,CACL,KAAM,iBACN,QAAS,QAEb,IAAK,CACD,KAAM,gBACN,QAAS,OAEb,IAAK,CACD,KAAM,gBACN,QAAS,OAEb,IAAK,CACD,KAAM,gBACN,QAAS,OAEb,SAAU,CACN,KAAM,iBACN,QAAS,QAEb,MAAO,CACH,KAAM,kBACN,QAAS,SAEb,GAAI,CACA,KAAM,iBACN,QAAS,QAEb,SAAU,CACN,KAAM,qBACN,QAAS,YAIX,EAAc,EAAU,EAAO,GAAM,KAErC,EAAW,MAAMD,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MAElB,EAAM,MAAM,QAAQ,IACtB,EAAE,gGACG,KAAK,MACL,UACA,IAAK,GAAM,CACR,IAAM,EAAO,EAAE,GAAG,KAAK,OACjB,EAAe,EAAK,KAAK,KAAK,KAAK,QACnC,EAAO,IAAI,IAAI,EAAc,GAAa,KAC1C,EAAQ,EAAK,KAAK,UAAU,OAC5B,EAAc,EAAE,GAAG,KAAK,OACxB,EAAM,EAAY,KAAK,MAAM,OAC7B,EAAe,EAAY,KAAK,KAAK,OACrC,EAAU,EAAU,GAAG,EAAa,GAAG,IAAO,cACpD,OAAOE,EAAM,OAAO,EAAM,SAAY,CAClC,IAAM,EAAc,MAAM,EAAe,GACzC,MAAO,CACH,QACA,OACA,UACA,oBAMpB,MAAO,CACH,MAAO,aAAe,EAAO,GAAM,QACnC,KAAM,EACN,KAAM"}