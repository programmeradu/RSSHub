import{config as e}from"./config-Dl8a1sIg.js";import{logger_default as t}from"./logger-CWOoofbD.js";import{cache_default as n}from"./cache-kimkMTWJ.js";import{got_default as r}from"./got-CdvI2yKX.js";import{getPuppeteerPage as i}from"./puppeteer-f0D6AISB.js";import{utils_default as a}from"./utils-BY2D8TfT.js";import{load as o}from"cheerio";import{JSDOM as s}from"jsdom";const c=(r=!1)=>{if(Object.keys(e.bilibili.cookies).length>0&&!r){for(let t of Object.keys(e.bilibili.cookies)){let n=e.bilibili.cookies[t];if(n){let r=n.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${a.lsid()}`);e.bilibili.cookies[t]=r}}return e.bilibili.cookies[Object.keys(e.bilibili.cookies)[Math.floor(Math.random()*Object.keys(e.bilibili.cookies).length)]]}return n.tryGet(`bili-cookie`,async()=>{let e=new Promise(e=>{e(``)}),{destory:n}=await i(`https://space.bilibili.com/1/dynamic`,{onBeforeLoad:t=>{e=new Promise(e=>{t.on(`requestfinished`,async n=>{if(n.url()===`https://api.bilibili.com/x/internal/gaia-gateway/ExClimbWuzhi`){let n=await t.cookies(),r=n.map(e=>`${e.name}=${e.value}`).join(`; `);r=r.replace(/b_lsid=[0-9A-F]+_[0-9A-F]+/,`b_lsid=${a.lsid()}`),e(r)}})})}}),r=await e;return t.debug(`Got bilibili cookie: ${r}`),await n(),r})},l=e=>n.tryGet(`bili-web-render-data`,async()=>{let t=await c(),{data:n}=await r(`https://space.bilibili.com/${e}`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:t}}),i=new s(n),a=i.window.document,o=a.querySelector(`#__RENDER_DATA__`),l=o&&o.textContent||`{}`,u=JSON.parse(decodeURIComponent(l)),d=u.access_id;return d}),u=()=>n.tryGet(`bili-wbi-verify-string`,async()=>{let e=await c(),{data:t}=await r(`https://api.bilibili.com/x/web-interface/nav`,{headers:{Referer:`https://www.bilibili.com/`,Cookie:e}}),n=t.data.wbi_img.img_url,i=t.data.wbi_img.sub_url,a=n.substring(n.lastIndexOf(`/`)+1,n.length).split(`.`)[0]+i.substring(i.lastIndexOf(`/`)+1,i.length).split(`.`)[0],{body:o}=await r(`https://s1.hdslb.com/bfs/seed/laputa-header/bili-header.umd.js`,{headers:{Referer:`https://space.bilibili.com/1`}}),s=JSON.parse(o.match(/\[(?:\d+,){63}\d+]/)),l=[];for(let e of s)a.charAt(e)&&l.push(a.charAt(e));return l.join(``).slice(0,32)}),d=e=>{let t=`bili-username-from-uid-`+e;return n.tryGet(t,async()=>{let t=await c(),n=await u(),i=a.addWbiVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,n),{data:o}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${i}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:t}});return o.data?o.data.name:void 0})},f=async e=>{let i=`bili-username-from-uid-`+e,o=`bili-userface-from-uid-`+e,s=await n.get(i),d=await n.get(o);if(!s||!d){let f=await c(),p=await u(),m=a.getDmImgList(),h=await l(e),g=a.addWbiVerifyInfo(a.addRenderData(a.addDmVerifyInfo(`mid=${e}&token=&platform=web&web_location=1550101`,m),h),p),{data:_}=await r(`https://api.bilibili.com/x/space/wbi/acc/info?${g}`,{headers:{Referer:`https://space.bilibili.com/${e}/`,Cookie:f}});_.data.name?(s=_.data.name,d=_.data.face,n.set(i,_.data.name),n.set(o,_.data.face)):t.error(`Error when visiting /x/space/wbi/acc/info: ${JSON.stringify(_)}`)}return[s,d]},p=e=>{let t=`bili-liveID-from-shortID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.room_id})},m=e=>{let t=`bili-userinfo-from-liveID-${e}`;return n.tryGet(t,async()=>{let{data:t}=await r(`https://api.live.bilibili.com/live_user/v1/UserInfo/get_anchor_in_room?roomid=${e}`,{headers:{Referer:`https://live.bilibili.com/${e}`}});return t.data.info})},h=(e,t)=>{let i=`bili-videoname-from-id-${t||e}`;return n.tryGet(i,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view`,{searchParams:{aid:e||void 0,bvid:t||void 0},referer:`https://www.bilibili.com/video/${t||`av${e}`}`});return n.data.title})},g=(e,t,i)=>{let a=`bili-cid-from-id-${i||e}-${t}`;return n.tryGet(a,async()=>{let{data:n}=await r(`https://api.bilibili.com/x/web-interface/view?${i?`bvid=${i}`:`aid=${e}`}`,{referer:`https://www.bilibili.com/video/${i||`av${e}`}`});return n.data.pages[t-1].cid})};function _(e){let t=new Date(e*1e3),n=String(t.getUTCHours()).padStart(2,`0`),r=String(t.getUTCMinutes()).padStart(2,`0`),i=String(t.getUTCSeconds()).padStart(2,`0`),a=String(t.getUTCMilliseconds()).padStart(3,`0`);return`${n}:${r}:${i},${a}`}function v(e){return e.map((e,t)=>{let n=_(e.from),r=_(e.to);return`${t+1}\n${n} --> ${r}\n${e.content}\n`}).join(`
`)}const y=async e=>{if(!e)return[];let t=await g(void 0,1,e),i=await c();return n.tryGet(`bili-video-subtitle-${e}`,async()=>{let a=await r(`https://api.bilibili.com/x/player/wbi/v2?bvid=${e}&cid=${t}`,{headers:{Referer:`https://www.bilibili.com/video/${e}`,Cookie:i}}),o=a?.data?.data?.subtitle?.subtitles||[];return await Promise.all(o.map(async e=>{let t=`https:${e.subtitle_url}`,i=await n.tryGet(t,async()=>{let e=await r(t);return v(e?.data?.body||[])});return{content:i,lan_doc:e.lan_doc}}))})},b=async e=>{let t=await y(e);return t.map(e=>({url:`data:text/plain;charset=utf-8,${e.content}`,mime_type:`text/srt`,title:`字幕 - ${e.lan_doc}`}))},x=async e=>{let t=`bili-cid-from-bvid-${e}`,i=await n.get(t);if(!i){let a=await r(`https://api.bilibili.com/x/web-interface/view?bvid=${e}`,{headers:{Referer:`https://www.bilibili.com/video/${e}`}});a.data&&a.data.data&&a.data.data.aid&&(i=a.data.data.aid),n.set(t,i)}return i},S=async(e,t)=>{let i=`https://www.bilibili.com/read/cv${e}/`,a=await n.tryGet(i,async()=>(await r({method:`get`,url:i,headers:{Referer:`https://space.bilibili.com/${t}/`}})).data),s=o(a),c=s(`#read-article-holder`).html();if(!c)try{let e=JSON.parse(s(`script:contains("window.__INITIAL_STATE__")`).text().match(/window\.__INITIAL_STATE__\s*=\s*(.*?);\(/)[1]);if(e?.readInfo?.opus?.content?.paragraphs){c=``;for(let t of e.readInfo.opus.content.paragraphs){if(t.para_type===1)for(let e of t.text.nodes)e?.word?.words&&(c+=`<p>${e.word.words}</p>`);if(t.para_type===2)for(let e of t.pic.pics)c+=`<p ><img src="${e.url}@progressive.webp"></p>`;t.para_type===3&&t.line?.pic?.url&&(c+=`<figure><img src="${t.line.pic.url}"></figure>`)}}}catch{}return{url:i,description:c}};var C={getCookie:c,getWbiVerifyString:u,getUsernameFromUID:d,getUsernameAndFaceFromUID:f,getLiveIDFromShortID:p,getUserInfoFromLiveID:m,getVideoNameFromId:h,getCidFromId:g,getAidFromBvid:x,getArticleDataFromCvid:S,getRenderData:l,getVideoSubtitle:y,getVideoSubtitleAttachment:b};export{C as cache_default};
//# sourceMappingURL=cache-CIkWqAo6.js.map