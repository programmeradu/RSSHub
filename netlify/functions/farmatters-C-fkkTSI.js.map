{"version":3,"file":"farmatters-C-fkkTSI.js","names":[],"sources":["../../lib/routes/farmatters/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport MarkdownIt from 'markdown-it';\r\nconst md = MarkdownIt({\r\n    html: true,\r\n});\r\n\r\nconst ids = {\r\n    1: 0,\r\n    2: 2,\r\n    3: 1,\r\n};\r\n\r\nexport const route: Route = {\r\n    path: ['/exclusive/:locale?', '/news/:locale?', '/:locale?', '/:type/:id/:locale?'],\r\n    categories: ['new-media'],\r\n    example: '/farmatters/exclusive',\r\n    parameters: { locale: 'Locale, `zh-CN` or `en-US`, `zh-CN` by default' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['farmatters.com/exclusive'],\r\n            target: '/exclusive',\r\n        },\r\n    ],\r\n    name: 'Exclusive',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    url: 'farmatters.com/news',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { type, id, locale = 'zh-CN' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 50;\r\n\r\n    const searchParams = {\r\n        locale,\r\n        page: 0,\r\n        pagesize: limit,\r\n    };\r\n\r\n    if (type === 'wiki' && id) {\r\n        searchParams.subCatalogId = id;\r\n    } else if (type && id) {\r\n        searchParams[type] = id;\r\n    }\r\n\r\n    const rootUrl = 'https://farmatters.com';\r\n    const apiUrl = new URL('api/v1/doc/list', rootUrl).href;\r\n    const currentUrl = new URL(`${locale === 'zh-CN' ? '' : 'en/'}${type ? (type === 'wiki' ? 'wiki' : `tag/${id}`) : 'news'}`, rootUrl).href;\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams,\r\n        https: {\r\n            rejectUnauthorized: false,\r\n        },\r\n    });\r\n\r\n    const items = response.data.list.slice(0, limit).map((item) => ({\r\n        title: item.title,\r\n        link: new URL(`doc/${item.id}`, rootUrl).href,\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            image: item.headImageUrl\r\n                ? {\r\n                      src: item.headImageUrl,\r\n                      alt: item.title,\r\n                  }\r\n                : undefined,\r\n            description: md.render(item.content ?? item.summary),\r\n        }),\r\n        author: item.author,\r\n        category: [item.catalogName, item.subCatalogName ?? undefined, ...(item.tags?.map((t) => t.tagName) ?? [])].filter(Boolean),\r\n        guid: `farmatters-${item.id}`,\r\n        pubDate: timezone(parseDate(item.createdAt), +8),\r\n    }));\r\n\r\n    const { data: currentResponse } = await got(currentUrl, {\r\n        https: {\r\n            rejectUnauthorized: false,\r\n        },\r\n    });\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const subtitle = `${$('h4').first().text()}${type === 'wiki' ? ` - ${$('div.css-6f6728 div.MuiBox-root').eq(ids[id]).text()}` : ''}`;\r\n    const icon = new URL('favicon.ico', rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: `${$('title').text().split(/-/)[0].trim()} - ${subtitle}`,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image: new URL($('img').first().prop('src'), rootUrl).href,\r\n        icon,\r\n        logo: icon,\r\n        subtitle,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"ifASA,MAAM,EAAK,EAAW,CAClB,KAAM,KAGJ,EAAM,CACR,EAAG,EACH,EAAG,EACH,EAAG,GAGM,EAAe,CACxB,KAAM,CAAC,sBAAuB,iBAAkB,YAAa,uBAC7D,WAAY,CAAC,aACb,QAAS,wBACT,WAAY,CAAE,OAAQ,kDACtB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,4BACT,OAAQ,eAGhB,KAAM,YACN,YAAa,CAAC,WACd,UACA,IAAK,uBAGT,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAM,KAAI,SAAS,SAAY,EAAI,IAAI,QACzC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAe,CACjB,SACA,KAAM,EACN,SAAU,GAGV,IAAS,QAAU,EACnB,EAAa,aAAe,EACrB,GAAQ,IACf,EAAa,GAAQ,GAGzB,IAAM,EAAU,yBACV,EAAS,IAAI,IAAI,kBAAmB,GAAS,KAC7C,EAAa,IAAI,IAAI,GAAG,IAAW,QAAU,GAAK,QAAQ,EAAQ,IAAS,OAAS,OAAS,OAAO,IAAQ,SAAU,GAAS,KAE/H,CAAE,KAAM,GAAa,MAAM,EAAI,EAAQ,CACzC,eACA,MAAO,CACH,mBAAoB,MAItB,EAAQ,EAAS,KAAK,KAAK,MAAM,EAAG,GAAO,IAAK,IAAU,CAC5D,MAAO,EAAK,MACZ,KAAM,IAAI,IAAI,OAAO,EAAK,KAAM,GAAS,KACzC,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,EAAK,aACN,CACI,IAAK,EAAK,aACV,IAAK,EAAK,OAEd,IAAA,GACN,YAAa,EAAG,OAAO,EAAK,SAAW,EAAK,WAEhD,OAAQ,EAAK,OACb,SAAU,CAAC,EAAK,YAAa,EAAK,gBAAkB,IAAA,GAAW,GAAI,EAAK,MAAM,IAAK,GAAM,EAAE,UAAY,IAAK,OAAO,SACnH,KAAM,cAAc,EAAK,KACzB,QAAS,EAAS,EAAU,EAAK,WAAY,MAG3C,CAAE,KAAM,GAAoB,MAAM,EAAI,EAAY,CACpD,MAAO,CACH,mBAAoB,MAItB,EAAI,EAAK,GAET,EAAW,GAAG,EAAE,MAAM,QAAQ,SAAS,IAAS,OAAS,MAAM,EAAE,kCAAkC,GAAG,EAAI,IAAK,SAAW,KAC1H,EAAO,IAAI,IAAI,cAAe,GAAS,KAE7C,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAE,SAAS,OAAO,MAAM,KAAK,GAAG,OAAO,KAAK,IACtD,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,EAAE,QAAQ,KAAK,QACzB,MAAO,IAAI,IAAI,EAAE,OAAO,QAAQ,KAAK,OAAQ,GAAS,KACtD,OACA,KAAM,EACN,WACA,WAAY"}