{"version":3,"file":"huanbao-CIWpXhGn.js","names":["route: Route","got","cache","result"],"sources":["../../lib/routes/bjx/huanbao.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport pMap from 'p-map';\r\n\r\nexport const route: Route = {\r\n    path: '/huanbao',\r\n    categories: ['traditional-media'],\r\n    example: '/bjx/huanbao',\r\n    parameters: {},\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['huanbao.bjx.com.cn/yw', 'huanbao.bjx.com.cn/'],\r\n        },\r\n    ],\r\n    name: '环保要闻',\r\n    maintainers: ['zsimple'],\r\n    handler,\r\n    url: 'huanbao.bjx.com.cn/yw',\r\n};\r\n\r\nasync function handler() {\r\n    const listURL = 'https://huanbao.bjx.com.cn/yw/';\r\n    const response = await got(listURL);\r\n\r\n    const $ = load(response.data);\r\n    let items = $('.cc-layout-3 .cc-list-content li')\r\n        .toArray()\r\n        .map((e) => {\r\n            e = $(e);\r\n            return {\r\n                title: e.find('a').attr('title'),\r\n                link: e.find('a').attr('href'),\r\n                pubDate: parseDate(e.find('span').text()),\r\n            };\r\n        });\r\n\r\n    items = await pMap(\r\n        // 服务器禁止单个IP大并发访问，只能少返回几条\r\n        items,\r\n        (item) => fetchPage(item.link),\r\n        { concurrency: 3 }\r\n    );\r\n\r\n    return {\r\n        title: '北极星环保 - 环保行业垂直门户网站',\r\n        link: listURL,\r\n        item: items,\r\n    };\r\n}\r\n\r\nconst fetchPage = (link) =>\r\n    cache.tryGet(link, async () => {\r\n        // 可能一篇文章过长会分成多页\r\n        const pages = [];\r\n\r\n        const result = await got(link);\r\n        const $page = load(result.data);\r\n        pages.push($page);\r\n\r\n        // 如果是有分页链接，则使用顺序加载以保证顺序\r\n        const pagelinks = $page('#article_cont .cc-paging a');\r\n\r\n        if (pagelinks.length > 0) {\r\n            for (const pagelink of pagelinks) {\r\n                const $a = $page(pagelink);\r\n                if (!/^\\d+$/.test($a.text().trim())) {\r\n                    continue;\r\n                }\r\n                const sublink = new URL($a.attr('href'), link).href;\r\n                /* eslint-disable no-await-in-loop */\r\n                const result = await got(sublink);\r\n                pages.push(load(result.data));\r\n            }\r\n        }\r\n\r\n        const item = {\r\n            title: $page('title').text(),\r\n            description: pages.reduce((desc, $p) => desc + $p('.cc-article').html(), ''),\r\n            pubDate: timezone(parseDate($page('.cc-headline .box p span').eq(0).text()), +8),\r\n            link,\r\n            author: $page('.cc-headline .box p span').eq(1).text(),\r\n        };\r\n        return item;\r\n    });\r\n"],"mappings":"+aAQA,MAAaA,EAAe,CACxB,KAAM,WACN,WAAY,CAAC,qBACb,QAAS,eACT,WAAY,GACZ,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,wBAAyB,yBAG1C,KAAM,OACN,YAAa,CAAC,WACd,UACA,IAAK,yBAGT,eAAe,GAAU,CACrB,IAAM,EAAU,iCACV,EAAW,MAAMC,EAAI,GAErB,EAAI,EAAK,EAAS,MACpB,EAAQ,EAAE,oCACT,UACA,IAAK,IACF,EAAI,EAAE,GACC,CACH,MAAO,EAAE,KAAK,KAAK,KAAK,SACxB,KAAM,EAAE,KAAK,KAAK,KAAK,QACvB,QAAS,EAAU,EAAE,KAAK,QAAQ,WAW9C,MAPA,GAAQ,MAAM,EAEV,EACC,GAAS,EAAU,EAAK,MACzB,CAAE,YAAa,IAGZ,CACH,MAAO,qBACP,KAAM,EACN,KAAM,GAId,MAAM,EAAa,GACfC,EAAM,OAAO,EAAM,SAAY,CAE3B,IAAM,EAAQ,GAER,EAAS,MAAMD,EAAI,GACnB,EAAQ,EAAK,EAAO,MAC1B,EAAM,KAAK,GAGX,IAAM,EAAY,EAAM,8BAExB,GAAI,EAAU,OAAS,EACnB,IAAK,IAAM,KAAY,EAAW,CAC9B,IAAM,EAAK,EAAM,GACjB,GAAI,CAAC,QAAQ,KAAK,EAAG,OAAO,QACxB,SAEJ,IAAM,EAAU,IAAI,IAAI,EAAG,KAAK,QAAS,GAAM,KAEzCE,EAAS,MAAMF,EAAI,GACzB,EAAM,KAAK,EAAKE,EAAO,OAI/B,IAAM,EAAO,CACT,MAAO,EAAM,SAAS,OACtB,YAAa,EAAM,QAAQ,EAAM,IAAO,EAAO,EAAG,eAAe,OAAQ,IACzE,QAAS,EAAS,EAAU,EAAM,4BAA4B,GAAG,GAAG,QAAS,GAC7E,OACA,OAAQ,EAAM,4BAA4B,GAAG,GAAG,QAEpD,OAAO"}