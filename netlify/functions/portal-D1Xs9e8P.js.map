{"version":3,"file":"portal-D1Xs9e8P.js","names":["ofetch","cache","response","$","item","url","route: Route"],"sources":["../../lib/routes/chiphell/portal.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport type { Context } from 'hono';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport * as cheerio from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nconst handler = async (ctx: Context) => {\r\n    const { catId = '1' } = ctx.req.param();\r\n    const url = `https://www.chiphell.com/portal.php?mod=list&catid=${catId}`;\r\n\r\n    const response = await ofetch(url);\r\n    const $ = cheerio.load(response);\r\n\r\n    const list = $('dl.cl')\r\n        .toArray()\r\n        .map((item) => {\r\n            const $item = $(item);\r\n            const a = $item.find('a.xi2');\r\n\r\n            return {\r\n                title: a.text(),\r\n                link: `https://www.chiphell.com/${a.attr('href')}`,\r\n                category: [$item.find('dd label').text()],\r\n                pubDate: timezone(parseDate($item.find('span.xg1').text()), +8),\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch(item.link);\r\n                const $ = cheerio.load(response);\r\n\r\n                $('#article_content div br').parent().remove();\r\n                let description = $('#article_content').html();\r\n\r\n                if ($('.pg').length) {\r\n                    const urls = $('.pg a')\r\n                        .toArray()\r\n                        .map((item) => {\r\n                            const $item = $(item);\r\n                            return `https://www.chiphell.com/${$item.attr('href')}`;\r\n                        })\r\n                        .slice(0, -1);\r\n                    const responses = await Promise.all(urls.map((url) => ofetch(url)));\r\n                    const $pages = responses.map((item) => cheerio.load(item));\r\n                    const contents = $pages.map(($item) => {\r\n                        $item('#article_content div br').parent().remove();\r\n                        return $item('#article_content').html();\r\n                    });\r\n                    description = [description, ...contents].join('');\r\n                }\r\n\r\n                item.description = description;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('head title').text(),\r\n        description: $('head meta[name=\"description\"]').attr('content'),\r\n        link: url,\r\n        item: items,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/portal/:catId?',\r\n    name: '分类',\r\n    categories: ['bbs'],\r\n    example: '/chiphell/portal/1',\r\n    parameters: {\r\n        catId: '分类 ID，可在 URL 中找到，默认为 1',\r\n    },\r\n    maintainers: ['tylinux'],\r\n    handler,\r\n};\r\n"],"mappings":"gWASA,MAAM,EAAU,KAAO,IAAiB,CACpC,GAAM,CAAE,QAAQ,KAAQ,EAAI,IAAI,QAC1B,EAAM,sDAAsD,IAE5D,EAAW,MAAMA,EAAO,GACxB,EAAI,EAAQ,KAAK,GAEjB,EAAO,EAAE,SACV,UACA,IAAK,GAAS,CACX,IAAM,EAAQ,EAAE,GACV,EAAI,EAAM,KAAK,SAErB,MAAO,CACH,MAAO,EAAE,OACT,KAAM,4BAA4B,EAAE,KAAK,UACzC,SAAU,CAAC,EAAM,KAAK,YAAY,QAClC,QAAS,EAAS,EAAU,EAAM,KAAK,YAAY,QAAS,MAIlE,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAMC,EAAW,MAAMF,EAAO,EAAK,MAC7BG,EAAI,EAAQ,KAAKD,GAEvB,EAAE,2BAA2B,SAAS,SACtC,IAAI,EAAcC,EAAE,oBAAoB,OAExC,GAAIA,EAAE,OAAO,OAAQ,CACjB,IAAM,EAAOA,EAAE,SACV,UACA,IAAK,GAAS,CACX,IAAM,EAAQA,EAAEC,GAChB,MAAO,4BAA4B,EAAM,KAAK,YAEjD,MAAM,EAAG,IACR,EAAY,MAAM,QAAQ,IAAI,EAAK,IAAK,GAAQJ,EAAOK,KACvD,EAAS,EAAU,IAAK,GAAS,EAAQ,KAAKD,IAC9C,EAAW,EAAO,IAAK,IACzB,EAAM,2BAA2B,SAAS,SACnC,EAAM,oBAAoB,SAErC,EAAc,CAAC,EAAa,GAAG,GAAU,KAAK,IAKlD,MAFA,GAAK,YAAc,EAEZ,MAKnB,MAAO,CACH,MAAO,EAAE,cAAc,OACvB,YAAa,EAAE,iCAAiC,KAAK,WACrD,KAAM,EACN,KAAM,IAIDE,EAAe,CACxB,KAAM,kBACN,KAAM,KACN,WAAY,CAAC,OACb,QAAS,qBACT,WAAY,CACR,MAAO,0BAEX,YAAa,CAAC,WACd"}