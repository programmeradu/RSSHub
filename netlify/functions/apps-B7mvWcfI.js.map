{"version":3,"file":"apps-B7mvWcfI.js","names":["route: Route","got"],"sources":["../../lib/routes/apple/apps.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst platformIds = {\r\n    osx: 'macOS',\r\n    ios: 'iOS',\r\n    appletvos: 'tvOS',\r\n};\r\n\r\nconst platforms = {\r\n    macos: 'osx',\r\n    ios: 'ios',\r\n    tvos: 'appletvos',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/apps/update/:country/:id/:platform?',\r\n    categories: ['program-update'],\r\n    view: ViewType.Notifications,\r\n    example: '/apple/apps/update/us/id408709785',\r\n    parameters: {\r\n        country: 'App Store Country, obtain from the app URL, see below',\r\n        id: 'App id, obtain from the app URL',\r\n        platform: {\r\n            description: 'App Platform, see below, all by default',\r\n            options: [\r\n                {\r\n                    value: 'All',\r\n                    label: 'all',\r\n                },\r\n                {\r\n                    value: 'iOS',\r\n                    label: 'iOS',\r\n                },\r\n                {\r\n                    value: 'macOS',\r\n                    label: 'macOS',\r\n                },\r\n                {\r\n                    value: 'tvOS',\r\n                    label: 'tvOS',\r\n                },\r\n            ],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['apps.apple.com/:country/app/:appSlug/:id', 'apps.apple.com/:country/app/:id'],\r\n            target: '/apps/update/:country/:id',\r\n        },\r\n    ],\r\n    name: 'App Update',\r\n    maintainers: ['EkkoG', 'nczitzk'],\r\n    handler,\r\n    description: `\r\n::: tip\r\n  For example, the URL of [GarageBand](https://apps.apple.com/us/app/messages/id408709785) in the App Store is \\`https://apps.apple.com/us/app/messages/id408709785\\`. In this case, the \\`App Store Country\\` parameter for the route is \\`us\\`, and the \\`App id\\` parameter is \\`id1146560473\\`. So the route should be [\\`/apple/apps/update/us/id408709785\\`](https://rsshub.app/apple/apps/update/us/id408709785).\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { country, id } = ctx.req.param();\r\n    let { platform } = ctx.req.param();\r\n\r\n    let platformId;\r\n\r\n    if (platform && platform !== 'all') {\r\n        platform = platform.toLowerCase();\r\n        platformId = Object.hasOwn(platforms, platform) ? platforms[platform] : platform;\r\n    }\r\n    platform = undefined;\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 100;\r\n\r\n    const rootUrl = 'https://apps.apple.com';\r\n    const currentUrl = new URL(`${country}/app/${id}`, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    const appData = JSON.parse(Object.values(JSON.parse($('script#shoebox-media-api-cache-apps').text()))[0]);\r\n    const attributes = appData.d[0].attributes;\r\n\r\n    const appName = attributes.name;\r\n    const artistName = attributes.artistName;\r\n    const platformAttributes = attributes.platformAttributes;\r\n\r\n    let items = [];\r\n    let title = '';\r\n    let description = '';\r\n\r\n    if (platformId && Object.hasOwn(platformAttributes, platformId)) {\r\n        platform = Object.hasOwn(platformIds, platformId) ? platformIds[platformId] : platformId;\r\n\r\n        const platformAttribute = platformAttributes[platformId];\r\n\r\n        items = platformAttribute.versionHistory;\r\n        title = `${appName}${platform ? ` for ${platform} ` : ' '}`;\r\n        description = platformAttribute.description.standard;\r\n    } else {\r\n        title = appName;\r\n        for (const pid of Object.keys(platformAttributes)) {\r\n            const platformAttribute = platformAttributes[pid];\r\n            items = [\r\n                ...items,\r\n                ...platformAttribute.versionHistory.map((v) => ({\r\n                    ...v,\r\n                    platformId: pid,\r\n                })),\r\n            ];\r\n            description += platformAttribute.description.standard;\r\n        }\r\n    }\r\n\r\n    items = items.slice(0, limit).map((item) => {\r\n        const pid = item.platformId ?? platformId;\r\n        const p = platform ?? (Object.hasOwn(platformIds, pid) ? platformIds[pid] : pid);\r\n\r\n        return {\r\n            title: `${appName} ${item.versionDisplay} for ${p}`,\r\n            link: currentUrl,\r\n            description: item.releaseNotes?.replace(/\\n/g, '<br>'),\r\n            category: [p],\r\n            guid: `apple/apps/${country}/${id}/${pid}#${item.versionDisplay}`,\r\n            pubDate: parseDate(item.releaseTimestamp),\r\n        };\r\n    });\r\n\r\n    const icon = new URL('favicon.ico', rootUrl).href;\r\n\r\n    ctx.set('json', {\r\n        appData,\r\n    });\r\n\r\n    return {\r\n        item: items,\r\n        title: `${title} - Apple App Store`,\r\n        link: currentUrl,\r\n        description: description?.replace(/\\n/g, ' '),\r\n        language: $('html').prop('lang'),\r\n        image: $('meta[property=\"og:image\"]').prop('content'),\r\n        icon,\r\n        logo: icon,\r\n        subtitle: appName,\r\n        author: artistName,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"mWAKA,MAAM,EAAc,CAChB,IAAK,QACL,IAAK,MACL,UAAW,QAGT,EAAY,CACd,MAAO,MACP,IAAK,MACL,KAAM,aAGGA,EAAe,CACxB,KAAM,uCACN,WAAY,CAAC,kBACb,KAAM,EAAS,cACf,QAAS,oCACT,WAAY,CACR,QAAS,wDACT,GAAI,kCACJ,SAAU,CACN,YAAa,0CACb,QAAS,CACL,CACI,MAAO,MACP,MAAO,OAEX,CACI,MAAO,MACP,MAAO,OAEX,CACI,MAAO,QACP,MAAO,SAEX,CACI,MAAO,OACP,MAAO,WAKvB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,2CAA4C,mCACrD,OAAQ,8BAGhB,KAAM,aACN,YAAa,CAAC,QAAS,WACvB,UACA,YAAa,gaAMjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,UAAS,MAAO,EAAI,IAAI,QAC5B,CAAE,YAAa,EAAI,IAAI,QAEvB,EAEA,GAAY,IAAa,QACzB,EAAW,EAAS,cACpB,EAAa,OAAO,OAAO,EAAW,GAAY,EAAU,GAAY,GAE5E,EAAW,IAAA,GAEX,IAAM,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,IAE/E,EAAU,yBACV,EAAa,IAAI,IAAI,GAAG,EAAQ,OAAO,IAAM,GAAS,KAEtD,CAAE,KAAM,GAAa,MAAMC,EAAI,GAE/B,EAAI,EAAK,GAET,EAAU,KAAK,MAAM,OAAO,OAAO,KAAK,MAAM,EAAE,uCAAuC,SAAS,IAChG,EAAa,EAAQ,EAAE,GAAG,WAE1B,EAAU,EAAW,KACrB,EAAa,EAAW,WACxB,EAAqB,EAAW,mBAElC,EAAQ,GACR,EAAQ,GACR,EAAc,GAElB,GAAI,GAAc,OAAO,OAAO,EAAoB,GAAa,CAC7D,EAAW,OAAO,OAAO,EAAa,GAAc,EAAY,GAAc,EAE9E,IAAM,EAAoB,EAAmB,GAE7C,EAAQ,EAAkB,eAC1B,EAAQ,GAAG,IAAU,EAAW,QAAQ,EAAS,GAAK,MACtD,EAAc,EAAkB,YAAY,aACzC,CACH,EAAQ,EACR,IAAK,IAAM,KAAO,OAAO,KAAK,GAAqB,CAC/C,IAAM,EAAoB,EAAmB,GAC7C,EAAQ,CACJ,GAAG,EACH,GAAG,EAAkB,eAAe,IAAK,IAAO,CAC5C,GAAG,EACH,WAAY,MAGpB,GAAe,EAAkB,YAAY,UAIrD,EAAQ,EAAM,MAAM,EAAG,GAAO,IAAK,GAAS,CACxC,IAAM,EAAM,EAAK,YAAc,EACzB,EAAI,IAAa,OAAO,OAAO,EAAa,GAAO,EAAY,GAAO,GAE5E,MAAO,CACH,MAAO,GAAG,EAAQ,GAAG,EAAK,eAAe,OAAO,IAChD,KAAM,EACN,YAAa,EAAK,cAAc,QAAQ,MAAO,QAC/C,SAAU,CAAC,GACX,KAAM,cAAc,EAAQ,GAAG,EAAG,GAAG,EAAI,GAAG,EAAK,iBACjD,QAAS,EAAU,EAAK,qBAIhC,IAAM,EAAO,IAAI,IAAI,cAAe,GAAS,KAM7C,OAJA,EAAI,IAAI,OAAQ,CACZ,YAGG,CACH,KAAM,EACN,MAAO,GAAG,EAAM,oBAChB,KAAM,EACN,YAAa,GAAa,QAAQ,MAAO,KACzC,SAAU,EAAE,QAAQ,KAAK,QACzB,MAAO,EAAE,6BAA6B,KAAK,WAC3C,OACA,KAAM,EACN,SAAU,EACV,OAAQ,EACR,WAAY"}