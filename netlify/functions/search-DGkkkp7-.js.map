{"version":3,"file":"search-DGkkkp7-.js","names":[],"sources":["../../lib/routes/syosetu/types/search.ts","../../lib/routes/syosetu/search.ts"],"sourcesContent":["export enum SyosetuSub {\r\n    YOMOU = 'yomou',\r\n    NOCTURNE = 'noc',\r\n    MOONLIGHT = 'mnlt',\r\n    MIDNIGHT = 'mid',\r\n}\r\n\r\nexport const syosetuSubToJapanese = {\r\n    [SyosetuSub.YOMOU]: '小説を読もう',\r\n    [SyosetuSub.NOCTURNE]: 'ノクターン',\r\n    [SyosetuSub.MOONLIGHT]: 'ムーンライト',\r\n    [SyosetuSub.MIDNIGHT]: 'ミッドナイト',\r\n} as const;\r\n\r\nexport interface NarouSearchParams {\r\n    /**\r\n     * 作品種別の絞り込み Work Type Filter\r\n     *\r\n     * t 短編 Short\r\n     * r 連載中 Ongoing Series\r\n     * er 完結済連載作品 Completed Series\r\n     * re すべての連載作品 (連載中および完結済) Series and Completed Series\r\n     * ter 短編と完結済連載作品 Completed Works (Including Short and Series)\r\n     *\r\n     * tr 短編と連載中小説 Short and Ongoing Series\r\n     * all 全ての種別 (Default) All Types\r\n     *\r\n     * Note: While the official documentation describes 5 values, all 7 values above are functional.\r\n     */\r\n    type?: 't' | 'r' | 'er' | 're' | 'ter' | 'tr' | 'all';\r\n\r\n    /** 検索ワード Search Keywords */\r\n    word?: string;\r\n\r\n    /** 除外ワード Excluded Keywords */\r\n    notword?: string;\r\n\r\n    /**\r\n     * 検索範囲指定 Search Range Specifications\r\n     *\r\n     * - 読了時間 Reading Time\r\n     * - 文字数 Character Count\r\n     * - 総合ポイント Total Points\r\n     * - 最新掲載日（年月日）Latest Update Date (Year/Month/Day)\r\n     * - 初回掲載日（年月日）First Publication Date (Year/Month/Day)\r\n     */\r\n    mintime?: number;\r\n    maxtime?: number;\r\n    minlen?: number;\r\n    maxlen?: number;\r\n    min_globalpoint?: number;\r\n    max_globalpoint?: number;\r\n    minlastup?: string;\r\n    maxlastup?: string;\r\n    minfirstup?: string;\r\n    maxfirstup?: string;\r\n\r\n    /**\r\n     * 抽出条件の指定 Extraction Conditions\r\n     *\r\n     * - 挿絵のある作品 Works with Illustrations\r\n     * - 小説 PickUp！対象作品 Featured Novels\r\n     *\r\n     * 作品に含まれる要素：Elements Included in Works:\r\n     * - 残酷な描写あり Contains Cruel Content\r\n     * - ボーイズラブ Boys' Love\r\n     * - ガールズラブ Girls' Love\r\n     * - 異世界転生 Reincarnation in Another World\r\n     * - 異世界転移 Transportation to Another World\r\n     */\r\n    sasie?: string;\r\n    ispickup?: boolean;\r\n    iszankoku?: boolean;\r\n    isbl?: boolean;\r\n    isgl?: boolean;\r\n    istensei?: boolean;\r\n    istenni?: boolean;\r\n\r\n    /**\r\n     * 除外条件の指定 Exclusion Conditions\r\n     *\r\n     * - 長期連載停止中の作品 Works on Long-term Hiatus\r\n     *\r\n     * 作品に含まれる要素：Elements to Exclude:\r\n     * - 残酷な描写あり Cruel Content\r\n     * - ボーイズラブ Boys' Love\r\n     * - ガールズラブ Girls' Love\r\n     * - 異世界転生 Reincarnation in Another World\r\n     * - 異世界転移 Transportation to Another World\r\n     */\r\n    stop?: boolean;\r\n    notzankoku?: boolean;\r\n    notbl?: boolean;\r\n    notgl?: boolean;\r\n    nottensei?: boolean;\r\n    nottenni?: boolean;\r\n\r\n    /**\r\n     * ワード検索範囲指定 Word Search Scope\r\n     * すべてのチェックを解除した場合、すべての項目がワード検索の対象となります。\r\n     * If all boxes are unchecked, all items will become targets for word search.\r\n     *\r\n     * 作品タイトル Work Title\r\n     * あらすじ Synopsis\r\n     * キーワード Keywords\r\n     * 作者名 Author Name\r\n     */\r\n    title?: boolean;\r\n    ex?: boolean;\r\n    keyword?: boolean;\r\n    wname?: boolean;\r\n\r\n    /**\r\n     * 並び順 Sort Order\r\n     * - new: 新着更新順 (Default) Latest Updates\r\n     * - weekly: 週間ユニークアクセスが多い順 Most Weekly Unique Access\r\n     * - favnovelcnt: ブックマーク登録の多い順 Most Bookmarks\r\n     * - reviewcnt: レビューの多い順 Most Reviews\r\n     * - hyoka: 総合ポイントの高い順 Highest Total Points\r\n     * - dailypoint: 日間ポイントの高い順 Highest Daily Points\r\n     * - weeklypoint: 週間ポイントの高い順 Highest Weekly Points\r\n     * - monthlypoint: 月間ポイントの高い順 Highest Monthly Points\r\n     * - quarterpoint: 四半期ポイントの高い順 Highest Quarterly Points\r\n     * - yearlypoint: 年間ポイントの高い順 Highest Yearly Points\r\n     * - hyokacnt: 評価者数の多い順 Most Ratings\r\n     * - lengthdesc: 文字数の多い順 Most Characters\r\n     * - generalfirstup: 初回掲載順 First Publication Order\r\n     * - ncodedesc: N コード降順 Ncode Descending\r\n     * - old: 更新が古い順 Oldest Updates\r\n     */\r\n    order?: 'new' | 'weekly' | 'favnovelcnt' | 'reviewcnt' | 'hyoka' | 'dailypoint' | 'weeklypoint' | 'monthlypoint' | 'quarterpoint' | 'yearlypoint' | 'hyokacnt' | 'lengthdesc' | 'generalfirstup' | 'ncodedesc' | 'old';\r\n\r\n    /** ジャンル Genre */\r\n    genre?: string;\r\n\r\n    /** 掲載サイト指定 Site */\r\n    nocgenre?: number;\r\n}\r\n","import { Route, Data } from '@/types';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { Context } from 'hono';\r\nimport { Genre, GenreNotation, NarouNovelFetch, NovelTypeParam, Order, R18Site, SearchBuilder, SearchBuilderR18, SearchParams } from 'narou';\r\nimport queryString from 'query-string';\r\nimport { Join } from 'narou/util/type';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport { SyosetuSub, NarouSearchParams, syosetuSubToJapanese } from './types/search';\r\n\r\nexport const route: Route = {\r\n    path: '/search/:sub/:query',\r\n    categories: ['reading'],\r\n    example: '/syosetu/search/noc/word=ハーレム&notword=&type=r&mintime=&maxtime=&minlen=30000&maxlen=&min_globalpoint=&max_globalpoint=&minlastup=&maxlastup=&minfirstup=&maxfirstup=&isgl=1&notbl=1&order=new?limit=5',\r\n    parameters: {\r\n        sub: {\r\n            description: 'The target Syosetu subsite.',\r\n            options: Object.entries(SyosetuSub).map(([, value]) => ({\r\n                value,\r\n                label: syosetuSubToJapanese[value],\r\n            })),\r\n        },\r\n        query: 'Search parameters in Syosetu format.',\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Search',\r\n    maintainers: ['SnowAgar25'],\r\n    handler,\r\n};\r\n\r\nconst setIfExists = (value) => value ?? undefined;\r\n\r\n/**\r\n * This function converts query string generated by Syosetu website into API-compatible format.\r\n * It is not intended for users to freely adjust values.\r\n *\r\n * @see https://deflis.github.io/node-narou/index.html\r\n * @see https://dev.syosetu.com/man/api/\r\n */\r\nfunction mapToSearchParams(query: string, limit: number): SearchParams {\r\n    const params = queryString.parse(query) as NarouSearchParams;\r\n\r\n    const searchParams: SearchParams = {\r\n        gzip: 5,\r\n        lim: limit,\r\n    };\r\n\r\n    searchParams.word = setIfExists(params.word);\r\n    searchParams.notword = setIfExists(params.notword);\r\n\r\n    searchParams.title = setIfExists(params.title);\r\n    searchParams.ex = setIfExists(params.ex);\r\n    searchParams.keyword = setIfExists(params.keyword);\r\n    searchParams.wname = setIfExists(params.wname);\r\n\r\n    searchParams.sasie = setIfExists(params.sasie);\r\n    searchParams.iszankoku = setIfExists(params.iszankoku);\r\n    searchParams.isbl = setIfExists(params.isbl);\r\n    searchParams.isgl = setIfExists(params.isgl);\r\n    searchParams.istensei = setIfExists(params.istensei);\r\n    searchParams.istenni = setIfExists(params.istenni);\r\n\r\n    searchParams.stop = setIfExists(params.stop);\r\n    searchParams.notzankoku = setIfExists(params.notzankoku);\r\n    searchParams.notbl = setIfExists(params.notbl);\r\n    searchParams.notgl = setIfExists(params.notgl);\r\n    searchParams.nottensei = setIfExists(params.nottensei);\r\n    searchParams.nottenni = setIfExists(params.nottenni);\r\n\r\n    searchParams.minlen = setIfExists(params.minlen);\r\n    searchParams.maxlen = setIfExists(params.maxlen);\r\n\r\n    searchParams.type = setIfExists(params.type as NovelTypeParam);\r\n    searchParams.order = setIfExists(params.order as Order);\r\n    searchParams.genre = setIfExists(params.genre as Join<Genre> | Genre);\r\n    searchParams.nocgenre = setIfExists(params.nocgenre as Join<R18Site> | R18Site);\r\n\r\n    if (params.mintime || params.maxtime) {\r\n        searchParams.time = `${params.mintime || ''}-${params.maxtime || ''}`;\r\n    }\r\n\r\n    return searchParams;\r\n}\r\n\r\nconst isGeneral = (sub: string): boolean => sub === SyosetuSub.YOMOU;\r\n\r\nfunction createNovelSearchBuilder(sub: string, searchParams: SearchParams) {\r\n    if (isGeneral(sub)) {\r\n        return new SearchBuilder(searchParams, new NarouNovelFetch());\r\n    }\r\n\r\n    const r18Params = { ...searchParams };\r\n\r\n    switch (sub) {\r\n        case SyosetuSub.NOCTURNE:\r\n            r18Params.nocgenre = R18Site.Nocturne;\r\n            break;\r\n        case SyosetuSub.MOONLIGHT:\r\n            // If either 女性向け/BL is chosen, nocgenre will be in query string\r\n            // If no specific genre selected, include both\r\n            if (!r18Params.nocgenre) {\r\n                r18Params.nocgenre = [R18Site.MoonLight, R18Site.MoonLightBL].join('-') as Join<R18Site>;\r\n            }\r\n            break;\r\n        case SyosetuSub.MIDNIGHT:\r\n            r18Params.nocgenre = R18Site.Midnight;\r\n            break;\r\n        default:\r\n            throw new InvalidParameterError('Invalid Syosetu subsite.\\nValid subsites are: yomou, noc, mnlt, mid');\r\n    }\r\n\r\n    return new SearchBuilderR18(r18Params, new NarouNovelFetch());\r\n}\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const { sub, query } = ctx.req.param();\r\n    const searchUrl = `https://${sub}.syosetu.com/search/search/search.php?${query}`;\r\n\r\n    const limit = Math.min(Number(ctx.req.query('limit') ?? 40), 40);\r\n    const searchParams = mapToSearchParams(query, limit);\r\n    const builder = createNovelSearchBuilder(sub, searchParams);\r\n    const result = await builder.execute();\r\n\r\n    const items = result.values.map((novel) => ({\r\n        title: novel.title,\r\n        link: `https://${isGeneral(sub) ? 'ncode' : 'novel18'}.syosetu.com/${String(novel.ncode).toLowerCase()}`,\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            novel,\r\n            genreText: GenreNotation[novel.genre],\r\n        }),\r\n        // Skip pubDate - search results prioritize search sequence over timestamps\r\n        // pubDate: novel.general_lastup,\r\n        author: novel.writer,\r\n        // Split by whitespace characters(\\s), slash(/), full-width slash(／)\r\n        category: novel.keyword.split(/[\\s/\\uFF0F]/).filter(Boolean),\r\n    }));\r\n\r\n    const searchTerms: string[] = [];\r\n    if (searchParams.word) {\r\n        searchTerms.push(searchParams.word);\r\n    }\r\n    if (searchParams.notword) {\r\n        searchTerms.push(`-${searchParams.notword}`);\r\n    }\r\n\r\n    return {\r\n        title: searchTerms.length > 0 ? `Syosetu Search: ${searchTerms.join(' ')}` : 'Syosetu Search',\r\n        link: searchUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}