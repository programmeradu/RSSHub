{"version":3,"file":"utils-CP64t50q.js","names":[],"sources":["../../lib/routes/nintendo/utils.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { JSDOM } from 'jsdom';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport dayjs from 'dayjs';\r\nimport localizedFormat from 'dayjs/plugin/localizedFormat.js';\r\nimport 'dayjs/locale/zh-cn.js';\r\ndayjs.extend(localizedFormat);\r\n\r\nfunction nuxtReader(data) {\r\n    let nuxt = {};\r\n    try {\r\n        const dom = new JSDOM(data, {\r\n            runScripts: 'dangerously',\r\n        });\r\n        nuxt = dom.window.__NUXT__.data[0];\r\n    } catch {\r\n        throw new Error('Nuxt 框架信息提取失败，请报告这个问题');\r\n    }\r\n\r\n    return nuxt;\r\n}\r\n\r\nfunction generateImageLink(link) {\r\n    return `<img src=\"${link}\"><br/>`;\r\n}\r\n\r\nasync function loadContent(link) {\r\n    const response = await got(link);\r\n\r\n    const data = response.data;\r\n\r\n    const $ = load(data); // 使用 cheerio 加载返回的 HTML\r\n    const description = $('.description').html();\r\n\r\n    return {\r\n        content: description,\r\n    };\r\n}\r\n\r\nasync function loadNews(link) {\r\n    const response = await got(link);\r\n\r\n    const data = response.data;\r\n\r\n    const $ = load(data);\r\n    let description = $('.detail-body-container').html();\r\n    const date = $('.topics-articleHead__date').text();\r\n    description = description.replaceAll('src=\"/topics/', 'src=\"https://www.nintendo.com.hk/topics/');\r\n    return {\r\n        content: description,\r\n        pubDate: parseDate(date, 'YYYY.M.D'),\r\n    };\r\n}\r\n\r\nconst ProcessItem = (list, caches) =>\r\n    Promise.all(\r\n        list.map(async (item) => {\r\n            const other = await caches.tryGet(item.link, () => loadContent(item.link));\r\n            return { ...item, ...other };\r\n        })\r\n    );\r\n\r\nconst ProcessNews = (list, caches) =>\r\n    Promise.all(\r\n        list.map(async (item) => {\r\n            const other = await caches.tryGet(item.url, () => loadNews('https://www.nintendo.com.hk' + item.url));\r\n            return { ...item, ...other };\r\n        })\r\n    );\r\n\r\n/*\r\n    Software Item Example\r\n{\r\n    \"nsUid\": \"70010000027088\",\r\n    \"gameProductCode\": \"HAC-P-ADALB\",\r\n    \"name\": \"新 超级马力欧兄弟U 豪华版\",\r\n    \"price\": \"299\",\r\n    \"currency\": \"CNY\",\r\n    \"images\": [\"//switch-cn.gtgres.com/global-images/c247f0e0-1654-11ea-9b40-236e671bca9e.png\", \"//switch-cn.gtgres.com/global-images/c62e52d0-1654-11ea-9b40-236e671bca9e.jpg\", \"//switch-cn.gtgres.com/global-images/c8ec6160-1654-11ea-9b40-236e671bca9e.jpg\", \"//switch-cn.gtgres.com/global-images/cb84e690-1654-11ea-9b40-236e671bca9e.jpg\", \"//switch-cn.gtgres.com/global-images/cdc1b730-1654-11ea-9b40-236e671bca9e.jpg\", \"//switch-cn.gtgres.com/global-images/cfd57c00-1654-11ea-9b40-236e671bca9e.jpg\", \"//switch-cn.gtgres.com/global-images/d1fe4f70-1654-11ea-9b40-236e671bca9e.jpg\"],\r\n    \"movies\": [],\r\n    \"purchaseUrls\": [{\r\n        \"key\": \"JD\",\r\n        \"url\": \"https://item.jd.com/100010400326.html\"\r\n    }, {\r\n        \"key\": \"TM\",\r\n        \"url\": \"https://detail.tmall.com/item.htm?id=608916438547\"\r\n    }],\r\n    \"descriptionTitle\": \"2D超级马力欧全新体验，同享欢乐时光\",\r\n    \"descriptionContent\": \"《新 超级马力欧兄弟U 豪华版》是2D超级马力欧横版卷轴动作游戏。\\\\n\\\\n游戏包括《新 超级路易吉U》和《新 超级马力欧兄弟U》共164个关卡，马力欧一行需要前往被酷霸王占领的桃花公主城堡，利用多种新奇的能力强化，与可靠有趣的伙伴，在丰富多彩的世界中展开冒险。在《新 超级路易吉U》中，关卡难度更高，限时更短，角色跳跃能力更强但也更易打滑，非常适合喜欢挑战的玩家。\\\\n\\\\n游戏中有“马力欧”、“路易吉”、“奇诺比奥”、“偷天兔”和“奇诺比珂”5个角色供你选择，其中“奇诺比珂”与“偷天兔”拥有非常适合新手的特殊能力，即使不擅长动作游戏，也可以轻松游玩。\\\\n\\\\n除了故事模式外，游戏还提供课题模式、加倍模式和金币对战多种丰富的玩法。游戏支持最多4人一起游玩，快与伙伴分享Joy-Con™，一起趣玩吧！\",\r\n    \"sizeNum\": \"2.1\",\r\n    \"sizeUnit\": \"GB\",\r\n    \"playMode\": [\"tv\", \"tabletop\", \"handheld\"],\r\n    \"normalPlayersNum\": {\r\n        \"min\": 1,\r\n        \"max\": 4\r\n    },\r\n    \"localPlayersNum\": {\r\n        \"min\": 0,\r\n        \"max\": 0\r\n    },\r\n    \"internatPlayersNum\": {\r\n        \"min\": 0,\r\n        \"max\": 0\r\n    },\r\n    \"handleSupport\": \"Nintendo Switch专业手柄\",\r\n    \"platform\": \"Nintendo Switch\",\r\n    \"developer\": \"Nintendo\",\r\n    \"publisher\": \"任天堂\",\r\n    \"genre\": [\"动作\", \"冒险\", \"家庭\", \"多人\"],\r\n    \"releaseDatetime\": 1575907200000,\r\n    \"supportLanguages\": [\"简体中文\"],\r\n    \"colors\": {\r\n        \"words\": \"3c3c3c\",\r\n        \"entrance\": \"e60012\",\r\n        \"background\": \"e8ebef\"\r\n    },\r\n    \"copyright\": {\r\n        \"publishCompany\": \"上海电子出版有限公司\",\r\n        \"operateCompany\": \"深圳市腾讯计算机系统有限公司\",\r\n        \"copyrightNotice\": \"© 2012-2019 Nintendo\",\r\n        \"isbn\": \"978-7-498-06914-6\",\r\n        \"gapp\": \"国新出审[2019]2990号\",\r\n        \"copyrightNumber\": \"电出字09-2019-031\"\r\n    }\r\n}\r\n*/\r\nconst ProcessItemChina = (list, cache) =>\r\n    Promise.all(\r\n        list.map(async (item) => {\r\n            if (!item.link.startsWith('https://www.nintendoswitch.com.cn/software/')) {\r\n                return item;\r\n            }\r\n            const n = await cache.tryGet(item.link, async () => nuxtReader((await got(item.link)).data));\r\n            const software = n.data;\r\n            return {\r\n                ...item,\r\n                category: [...software.supportLanguages, ...software.genre, ...software.playMode],\r\n                description: art(path.join(__dirname, 'templates/eshop_cn.art'), {\r\n                    item,\r\n                    software,\r\n                    releaseDatetime: dayjs(software.releaseDatetime).locale('zh-cn').format('lll'),\r\n                }),\r\n            };\r\n        })\r\n    );\r\n\r\nconst ProcessNewsChina = (list, cache) =>\r\n    Promise.all(\r\n        list.map(async (item) => {\r\n            const n = await cache.tryGet(item.link, async () => nuxtReader((await got(item.link)).data));\r\n            return {\r\n                ...item,\r\n                description: item.description + n.newsData.content,\r\n                category: n.newsData.category,\r\n                pubDate: parseDate(n.newsData.releaseTime, 'x'),\r\n            };\r\n        })\r\n    );\r\n\r\nexport default { ProcessItem, ProcessNews, ProcessNewsChina, ProcessItemChina, nuxtReader, generateImageLink };\r\n"],"mappings":"oZASA,EAAM,OAAO,GAEb,SAAS,EAAW,EAAM,CACtB,IAAI,EAAO,GACX,GAAI,CACA,IAAM,EAAM,IAAI,EAAM,EAAM,CACxB,WAAY,gBAEhB,EAAO,EAAI,OAAO,SAAS,KAAK,QAC5B,CACJ,MAAU,MAAM,yBAGpB,OAAO,EAGX,SAAS,EAAkB,EAAM,CAC7B,MAAO,aAAa,EAAK,SAG7B,eAAe,EAAY,EAAM,CAC7B,IAAM,EAAW,MAAM,EAAI,GAErB,EAAO,EAAS,KAEhB,EAAI,EAAK,GACT,EAAc,EAAE,gBAAgB,OAEtC,MAAO,CACH,QAAS,GAIjB,eAAe,EAAS,EAAM,CAC1B,IAAM,EAAW,MAAM,EAAI,GAErB,EAAO,EAAS,KAEhB,EAAI,EAAK,GACX,EAAc,EAAE,0BAA0B,OACxC,EAAO,EAAE,6BAA6B,OAE5C,MADA,GAAc,EAAY,WAAW,gBAAiB,4CAC/C,CACH,QAAS,EACT,QAAS,EAAU,EAAM,aAIjC,MAAM,GAAe,EAAM,IACvB,QAAQ,IACJ,EAAK,IAAI,KAAO,IAAS,CACrB,IAAM,EAAQ,MAAM,EAAO,OAAO,EAAK,SAAY,EAAY,EAAK,OACpE,MAAO,CAAE,GAAG,EAAM,GAAG,MAI3B,GAAe,EAAM,IACvB,QAAQ,IACJ,EAAK,IAAI,KAAO,IAAS,CACrB,IAAM,EAAQ,MAAM,EAAO,OAAO,EAAK,QAAW,EAAS,8BAAgC,EAAK,MAChG,MAAO,CAAE,GAAG,EAAM,GAAG,MA4D3B,GAAoB,EAAM,IAC5B,QAAQ,IACJ,EAAK,IAAI,KAAO,IAAS,CACrB,GAAI,CAAC,EAAK,KAAK,WAAW,+CACtB,OAAO,EAEX,IAAM,EAAI,MAAM,EAAM,OAAO,EAAK,KAAM,SAAY,GAAY,MAAM,EAAI,EAAK,OAAO,OAChF,EAAW,EAAE,KACnB,MAAO,CACH,GAAG,EACH,SAAU,CAAC,GAAG,EAAS,iBAAkB,GAAG,EAAS,MAAO,GAAG,EAAS,UACxE,YAAa,EAAI,EAAA,KAAA,EAAA,mCAAgD,CAC7D,OACA,WACA,gBAAiB,EAAM,EAAS,iBAAiB,OAAO,SAAS,OAAO,aAMtF,GAAoB,EAAM,IAC5B,QAAQ,IACJ,EAAK,IAAI,KAAO,IAAS,CACrB,IAAM,EAAI,MAAM,EAAM,OAAO,EAAK,KAAM,SAAY,GAAY,MAAM,EAAI,EAAK,OAAO,OACtF,MAAO,CACH,GAAG,EACH,YAAa,EAAK,YAAc,EAAE,SAAS,QAC3C,SAAU,EAAE,SAAS,SACrB,QAAS,EAAU,EAAE,SAAS,YAAa,SAK3D,IAAA,EAAe,CAAE,cAAa,cAAa,mBAAkB,mBAAkB,aAAY"}