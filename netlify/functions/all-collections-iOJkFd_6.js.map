{"version":3,"file":"all-collections-iOJkFd_6.js","names":["route: Route","got","items","cache","response"],"sources":["../../lib/routes/zhihu/all-collections.ts"],"sourcesContent":["import { Route, ViewType, Collection, CollectionItem } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { header } from './utils';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/people/allCollections/:id',\r\n    categories: ['social-media'],\r\n    view: ViewType.Articles,\r\n    example: '/zhihu/people/allCollections/87-44-49-67',\r\n    parameters: { id: '作者 id，可在用户主页 URL 中找到' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'ZHIHU_COOKIES',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.zhihu.com/people/:id'],\r\n            // target: 'people/allCollections/:id',\r\n        },\r\n    ],\r\n    name: '用户全部收藏内容',\r\n    maintainers: ['Healthyyue'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const apiPath = `https://api.zhihu.com/people/${id}/collections`;\r\n\r\n    const response = await got(apiPath, {\r\n        headers: {\r\n            cookie: config.zhihu.cookies,\r\n            Referer: `https://www.zhihu.com/people/${id}/collections`,\r\n        },\r\n    });\r\n\r\n    const collections = response.data.data as Collection[];\r\n\r\n    const allCollectionItems = await Promise.all(\r\n        collections.map(async (collection) => {\r\n            const firstPageResponse = await got(`https://www.zhihu.com/api/v4/collections/${collection.id}/items?offset=0&limit=20`, {\r\n                headers: {\r\n                    ...header,\r\n                    cookie: config.zhihu.cookies,\r\n                    Referer: `https://www.zhihu.com/collection/${collection.id}`,\r\n                },\r\n            });\r\n\r\n            const {\r\n                data: items,\r\n                paging: { totals },\r\n            } = firstPageResponse.data;\r\n\r\n            if (totals > 20) {\r\n                const offsetList = Array.from({ length: Math.ceil(totals / 20) - 1 }, (_, index) => (index + 1) * 20);\r\n\r\n                const otherPages = await Promise.all(\r\n                    offsetList.map((offset) =>\r\n                        cache.tryGet(`https://www.zhihu.com/api/v4/collections/${collection.id}/items?offset=${offset}&limit=20`, async () => {\r\n                            const response = await got(`https://www.zhihu.com/api/v4/collections/${collection.id}/items?offset=${offset}&limit=20`, {\r\n                                headers: {\r\n                                    ...header,\r\n                                    cookie: config.zhihu.cookies,\r\n                                    Referer: `https://www.zhihu.com/collection/${collection.id}`,\r\n                                },\r\n                            });\r\n                            return response.data.data;\r\n                        })\r\n                    )\r\n                );\r\n\r\n                items.push(...otherPages.flat());\r\n            }\r\n\r\n            return {\r\n                collectionId: collection.id,\r\n                collectionTitle: collection.title,\r\n                items,\r\n            };\r\n        })\r\n    );\r\n\r\n    const items = allCollectionItems.flatMap(\r\n        (collection) =>\r\n            collection.items.map((item) => ({\r\n                ...item,\r\n                collectionTitle: collection.collectionTitle,\r\n            })) as CollectionItem[]\r\n    );\r\n\r\n    return {\r\n        title: `${collections[0].creator.name}的知乎收藏`,\r\n        link: `https://www.zhihu.com/people/${id}/collections`,\r\n        item: items.map((item) => {\r\n            const content = item.content;\r\n\r\n            return {\r\n                title: content.type === 'article' || content.type === 'zvideo' ? content.title : content.question.title,\r\n                link: content.url,\r\n                description: content.type === 'zvideo' ? `<img src=${content.video.url}/>` : content.content,\r\n                pubDate: parseDate((content.type === 'article' ? content.updated : content.updated_time) * 1000),\r\n                category: [item.collectionTitle],\r\n            };\r\n        }),\r\n    };\r\n}\r\n"],"mappings":"gdAOA,MAAaA,EAAe,CACxB,KAAM,6BACN,WAAY,CAAC,gBACb,KAAM,EAAS,SACf,QAAS,2CACT,WAAY,CAAE,GAAI,wBAClB,SAAU,CACN,cAAe,CACX,CACI,KAAM,gBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,8BAIjB,KAAM,WACN,YAAa,CAAC,cACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAU,gCAAgC,EAAG,cAE7C,EAAW,MAAMC,EAAI,EAAS,CAChC,QAAS,CACL,OAAQ,EAAO,MAAM,QACrB,QAAS,gCAAgC,EAAG,iBAI9C,EAAc,EAAS,KAAK,KAE5B,EAAqB,MAAM,QAAQ,IACrC,EAAY,IAAI,KAAO,IAAe,CAClC,IAAM,EAAoB,MAAMA,EAAI,4CAA4C,EAAW,GAAG,0BAA2B,CACrH,QAAS,CACL,GAAG,EACH,OAAQ,EAAO,MAAM,QACrB,QAAS,oCAAoC,EAAW,QAI1D,CACF,KAAMC,EACN,OAAQ,CAAE,WACV,EAAkB,KAEtB,GAAI,EAAS,GAAI,CACb,IAAM,EAAa,MAAM,KAAK,CAAE,OAAQ,KAAK,KAAK,EAAS,IAAM,IAAM,EAAG,KAAW,EAAQ,GAAK,IAE5F,EAAa,MAAM,QAAQ,IAC7B,EAAW,IAAK,GACZC,EAAM,OAAO,4CAA4C,EAAW,GAAG,gBAAgB,EAAO,WAAY,SAAY,CAClH,IAAMC,EAAW,MAAMH,EAAI,4CAA4C,EAAW,GAAG,gBAAgB,EAAO,WAAY,CACpH,QAAS,CACL,GAAG,EACH,OAAQ,EAAO,MAAM,QACrB,QAAS,oCAAoC,EAAW,QAGhE,OAAOG,EAAS,KAAK,SAKjC,EAAM,KAAK,GAAG,EAAW,QAG7B,MAAO,CACH,aAAc,EAAW,GACzB,gBAAiB,EAAW,MAC5B,MAAA,MAKN,EAAQ,EAAmB,QAC5B,GACG,EAAW,MAAM,IAAK,IAAU,CAC5B,GAAG,EACH,gBAAiB,EAAW,oBAIxC,MAAO,CACH,MAAO,GAAG,EAAY,GAAG,QAAQ,KAAK,OACtC,KAAM,gCAAgC,EAAG,cACzC,KAAM,EAAM,IAAK,GAAS,CACtB,IAAM,EAAU,EAAK,QAErB,MAAO,CACH,MAAO,EAAQ,OAAS,WAAa,EAAQ,OAAS,SAAW,EAAQ,MAAQ,EAAQ,SAAS,MAClG,KAAM,EAAQ,IACd,YAAa,EAAQ,OAAS,SAAW,YAAY,EAAQ,MAAM,IAAI,IAAM,EAAQ,QACrF,QAAS,GAAW,EAAQ,OAAS,UAAY,EAAQ,QAAU,EAAQ,cAAgB,KAC3F,SAAU,CAAC,EAAK"}