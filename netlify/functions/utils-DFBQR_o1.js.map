{"version":3,"file":"utils-DFBQR_o1.js","names":["got","cache"],"sources":["../../lib/routes/nua/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { fetchArticle } from '@/utils/wechat-mp';\r\n\r\nconst pageType = (href) => {\r\n    if (!href.startsWith('http')) {\r\n        return 'in-nua';\r\n    }\r\n    const url = new URL(href);\r\n    if (url.hostname === 'mp.weixin.qq.com') {\r\n        return 'wechat-mp';\r\n    } else if (url.hostname === 'www.nua.edu.cn') {\r\n        return 'nua';\r\n    } else {\r\n        return 'unknown';\r\n    }\r\n};\r\n\r\nfunction arti_link(text, href) {\r\n    return `<a href=\"${href}\">${text}</a>`;\r\n}\r\n\r\nasync function ProcessList(newsUrl, baseUrl, listName, listDate, webPageName) {\r\n    const result = await got(newsUrl, { https: { rejectUnauthorized: false } });\r\n    const $ = load(result.data);\r\n\r\n    const pageName = $(webPageName).text().trim();\r\n\r\n    const items = $(listName)\r\n        .toArray()\r\n        .map((item) => {\r\n            const href = $(item).find('a').attr('href');\r\n            const type = pageType(href);\r\n\r\n            return {\r\n                link: type === 'in-nua' ? baseUrl + href : href,\r\n                title: $(item).find('a').attr('title'),\r\n                pubDate: timezone(parseDate($(item).find(listDate).first().text(), 'YYYY-MM-DD'), +8),\r\n                type,\r\n            };\r\n        });\r\n\r\n    return [items, pageName];\r\n}\r\n\r\nconst ProcessFeed = (items, artiContent) =>\r\n    Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                switch (item.type) {\r\n                    case 'in-nua':\r\n                    case 'nua': {\r\n                        const result = await got(item.link, { https: { rejectUnauthorized: false } });\r\n                        const $ = load(result.data);\r\n                        item.author = $('.arti_publisher').text() + '  ' + $('.arti_views').text();\r\n                        item.description = $(artiContent).html();\r\n                        return item;\r\n                    }\r\n                    case 'wechat-mp':\r\n                        return fetchArticle(item.link);\r\n                    case 'unknown':\r\n                    default:\r\n                        item.description = `暂不支持解析该内容，请点击 ${arti_link('原文', item.link)}`;\r\n                        return item;\r\n                }\r\n            })\r\n        )\r\n    );\r\n\r\nexport default { ProcessList, ProcessFeed };\r\n"],"mappings":"iSAOA,MAAM,EAAY,GAAS,CACvB,GAAI,CAAC,EAAK,WAAW,QACjB,MAAO,SAEX,IAAM,EAAM,IAAI,IAAI,GAMhB,OALA,EAAI,WAAa,mBACV,YACA,EAAI,WAAa,iBACjB,MAEA,WAIf,SAAS,EAAU,EAAM,EAAM,CAC3B,MAAO,YAAY,EAAK,IAAI,EAAK,MAGrC,eAAe,EAAY,EAAS,EAAS,EAAU,EAAU,EAAa,CAC1E,IAAM,EAAS,MAAMA,EAAI,EAAS,CAAE,MAAO,CAAE,mBAAoB,MAC3D,EAAI,EAAK,EAAO,MAEhB,EAAW,EAAE,GAAa,OAAO,OAEjC,EAAQ,EAAE,GACX,UACA,IAAK,GAAS,CACX,IAAM,EAAO,EAAE,GAAM,KAAK,KAAK,KAAK,QAC9B,EAAO,EAAS,GAEtB,MAAO,CACH,KAAM,IAAS,SAAW,EAAU,EAAO,EAC3C,MAAO,EAAE,GAAM,KAAK,KAAK,KAAK,SAC9B,QAAS,EAAS,EAAU,EAAE,GAAM,KAAK,GAAU,QAAQ,OAAQ,cAAe,GAClF,UAIZ,MAAO,CAAC,EAAO,GAGnB,MAAM,GAAe,EAAO,IACxB,QAAQ,IACJ,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,OAAQ,EAAK,KAAb,CACI,IAAK,SACL,IAAK,MAAO,CACR,IAAM,EAAS,MAAMD,EAAI,EAAK,KAAM,CAAE,MAAO,CAAE,mBAAoB,MAC7D,EAAI,EAAK,EAAO,MAGtB,MAFA,GAAK,OAAS,EAAE,mBAAmB,OAAS,KAAO,EAAE,eAAe,OACpE,EAAK,YAAc,EAAE,GAAa,OAC3B,EAEX,IAAK,YACD,OAAO,EAAa,EAAK,MAC7B,IAAK,UACL,QAEI,MADA,GAAK,YAAc,iBAAiB,EAAU,KAAM,EAAK,QAClD,OAM/B,IAAA,EAAe,CAAE,cAAa"}