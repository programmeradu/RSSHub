{"version":3,"file":"djradio-UFz_HmGb.js","names":[],"sources":["../../lib/routes/163/music/djradio.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/music/djradio/:id/:info?',\r\n    categories: ['multimedia'],\r\n    example: '/163/music/djradio/347317067',\r\n    parameters: { id: '节目 id, 可在电台节目页 URL 中找到', info: '默认在正文尾部显示节目相关信息，任意值为不显示' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: true,\r\n        supportScihub: false,\r\n    },\r\n    name: '电台节目',\r\n    maintainers: ['magic-akari'],\r\n    handler,\r\n};\r\n\r\nconst ProcessFeed = (id, limit, offset) =>\r\n    cache.tryGet(\r\n        `163:music:djradio:${id}:${limit}:${offset}`,\r\n        async () =>\r\n            await got.post('https://music.163.com/api/dj/program/byradio', {\r\n                headers: {\r\n                    Referer: 'https://music.163.com/',\r\n                },\r\n                form: {\r\n                    radioId: id,\r\n                    limit,\r\n                    offset,\r\n                },\r\n            }),\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const info = !ctx.req.param('info');\r\n\r\n    const response = await ProcessFeed(id, 1, 0);\r\n\r\n    const programs = response.data.programs || [];\r\n    const { radio, dj } = programs[0] || { radio: {}, dj: {} };\r\n    const count = response.data.count || 0;\r\n\r\n    const countPage = Array.from({ length: Math.ceil(count / 500) }, (_, i) => i);\r\n\r\n    const items = await Promise.all(\r\n        countPage.map(async (item) => {\r\n            const response = await ProcessFeed(id, 500, item * 500);\r\n            const programs = response.data.programs || [];\r\n            const list = programs.map((pg) => {\r\n                const description = (pg.description || '').split('\\n').map((p) => p);\r\n                const duration = Math.trunc(pg.duration / 1000);\r\n                const mm_ss_duration = `${(duration / 60).toFixed(0).padStart(2, '0')}:${(duration % 60).toFixed(0).padStart(2, '0')}`;\r\n\r\n                const html = art(path.join(__dirname, '../templates/music/djradio-content.art'), {\r\n                    pg,\r\n                    description,\r\n                    itunes_duration: mm_ss_duration,\r\n                    info,\r\n                });\r\n\r\n                return {\r\n                    title: pg.name,\r\n                    link: 'https://music.163.com/program/' + pg.id,\r\n                    pubDate: parseDate(pg.createTime),\r\n                    published: parseDate(pg.createTime),\r\n                    author: pg.dj.nickname,\r\n                    description: html,\r\n                    content: { html },\r\n                    itunes_item_image: pg.coverUrl,\r\n                    enclosure_url: `https://music.163.com/song/media/outer/url?id=${pg.mainTrackId}.mp3`,\r\n                    enclosure_type: 'audio/mpeg',\r\n                    itunes_duration: duration,\r\n                };\r\n            });\r\n            return list;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: radio.name,\r\n        link: `https://music.163.com/djradio?id=${id}`,\r\n        subtitle: radio.desc,\r\n        description: radio.desc,\r\n        author: dj.nickname,\r\n        updated: radio.lastProgramCreateTime,\r\n        icon: radio.picUrl,\r\n        image: radio.picUrl,\r\n        itunes_author: dj.nickname,\r\n        itunes_category: radio.category,\r\n        item: items.flat(),\r\n    };\r\n}\r\n"],"mappings":"0cASA,MAAa,EAAe,CACxB,KAAM,4BACN,WAAY,CAAC,cACb,QAAS,+BACT,WAAY,CAAE,GAAI,yBAA0B,KAAM,2BAClD,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,eACd,WAGE,GAAe,EAAI,EAAO,IAC5B,EAAM,OACF,qBAAqB,EAAG,GAAG,EAAM,GAAG,IACpC,SACI,MAAM,EAAI,KAAK,+CAAgD,CAC3D,QAAS,CACL,QAAS,0BAEb,KAAM,CACF,QAAS,EACT,QACA,YAGZ,EAAO,MAAM,YACb,IAGR,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAO,CAAC,EAAI,IAAI,MAAM,QAEtB,EAAW,MAAM,EAAY,EAAI,EAAG,GAEpC,EAAW,EAAS,KAAK,UAAY,GACrC,CAAE,QAAO,MAAO,EAAS,IAAM,CAAE,MAAO,GAAI,GAAI,IAChD,EAAQ,EAAS,KAAK,OAAS,EAE/B,EAAY,MAAM,KAAK,CAAE,OAAQ,KAAK,KAAK,EAAQ,OAAS,EAAG,IAAM,GAErE,EAAQ,MAAM,QAAQ,IACxB,EAAU,IAAI,KAAO,IAAS,CAC1B,IAAM,EAAW,MAAM,EAAY,EAAI,IAAK,EAAO,KAC7C,EAAW,EAAS,KAAK,UAAY,GACrC,EAAO,EAAS,IAAK,GAAO,CAC9B,IAAM,GAAe,EAAG,aAAe,IAAI,MAAM;GAAM,IAAK,GAAM,GAC5D,EAAW,KAAK,MAAM,EAAG,SAAW,KACpC,EAAiB,IAAI,EAAW,IAAI,QAAQ,GAAG,SAAS,EAAG,KAAK,IAAI,EAAW,IAAI,QAAQ,GAAG,SAAS,EAAG,OAE1G,EAAO,EAAI,EAAA,KAAA,EAAA,0CAAgE,CAC7E,KACA,cACA,gBAAiB,EACjB,SAGJ,MAAO,CACH,MAAO,EAAG,KACV,KAAM,iCAAmC,EAAG,GAC5C,QAAS,EAAU,EAAG,YACtB,UAAW,EAAU,EAAG,YACxB,OAAQ,EAAG,GAAG,SACd,YAAa,EACb,QAAS,CAAE,QACX,kBAAmB,EAAG,SACtB,cAAe,iDAAiD,EAAG,YAAY,MAC/E,eAAgB,aAChB,gBAAiB,KAGzB,OAAO,KAIf,MAAO,CACH,MAAO,EAAM,KACb,KAAM,oCAAoC,IAC1C,SAAU,EAAM,KAChB,YAAa,EAAM,KACnB,OAAQ,EAAG,SACX,QAAS,EAAM,sBACf,KAAM,EAAM,OACZ,MAAO,EAAM,OACb,cAAe,EAAG,SAClB,gBAAiB,EAAM,SACvB,KAAM,EAAM"}