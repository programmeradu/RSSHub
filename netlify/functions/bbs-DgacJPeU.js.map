{"version":3,"file":"bbs-DgacJPeU.js","names":["route: Route","ConfigNotFoundError","ofetch","items","cache"],"sources":["../../lib/routes/uestc/bbs.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport ofetch from '@/utils/ofetch'; // 统一使用的请求库\r\nimport { parseDate } from '@/utils/parse-date'; // 解析日期的工具函数\r\nimport timezone from '@/utils/timezone';\r\nimport { config } from '@/config';\r\nimport { load } from 'cheerio';\r\nimport cache from '@/utils/cache';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/bbs/:types?',\r\n    name: '清水河畔',\r\n    maintainers: ['huyyi'],\r\n    categories: ['university'],\r\n    url: 'bbs.uestc.edu.cn',\r\n    example: '/uestc/bbs/newthread',\r\n    parameters: { types: '选择内容类型(多选`,`分割），可选值：[newreply,newthread,digest,life,hotlist]。默认为所有。' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'UESTC_BBS_COOKIE',\r\n                optional: false,\r\n                description: '河畔的cookie',\r\n            },\r\n            {\r\n                name: 'UESTC_BBS_AUTH_KEY',\r\n                optional: false,\r\n                description: '河畔Header中的authorization字段',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    description: `\r\n::: tip\r\n仅支持自建，您需要设置以下配置才能正常使用：\r\n-   河畔cookie: \\`UESTC_BBS_COOKIE\\`\r\n-   Header中的授权字段: \\`UESTC_BBS_AUTH_KEY\\`\r\n:::\r\n`,\r\n    radar: [\r\n        {\r\n            source: ['bbs.uestc.edu.cn/*'],\r\n            target: '/bbs/newthread',\r\n        },\r\n    ],\r\n    handler: async (ctx) => {\r\n        const { bbsCookie, bbsAuthStr } = config.uestc;\r\n        if (!bbsCookie || !bbsAuthStr) {\r\n            throw new ConfigNotFoundError('未配置 Cookie 或 Authorization。请检查配置。');\r\n        }\r\n        const { types = 'newreply,newthread,digest,life,hotlist' } = ctx.req.param();\r\n        const data = await ofetch(`https://bbs.uestc.edu.cn/star/api/v1/index?top_list=${types}`, {\r\n            headers: {\r\n                Cookie: bbsCookie,\r\n                Referer: 'https://bbs.uestc.edu.cn/new',\r\n                authorization: bbsAuthStr,\r\n            },\r\n        });\r\n        const itemsRaw = Object.entries(data.data.top_list).flatMap(([label, items]) => items.map((item) => ({ ...item, label })));\r\n        const items = await Promise.all(\r\n            itemsRaw.map((item) =>\r\n                cache.tryGet(`https://bbs.uestc.edu.cn/forum.php?mod=viewthread&tid=${item.thread_id}`, async () => {\r\n                    const response = await ofetch(`https://bbs.uestc.edu.cn/forum.php?mod=viewthread&tid=${item.thread_id}`, {\r\n                        headers: {\r\n                            Cookie: bbsCookie,\r\n                            Referer: 'https://bbs.uestc.edu.cn',\r\n                            authorization: bbsAuthStr,\r\n                        },\r\n                    });\r\n                    const $ = load(response);\r\n                    item.description = $('div#postlist').html();\r\n                    return {\r\n                        title: item.subject,\r\n                        link: `https://bbs.uestc.edu.cn/thread/${item.thread_id}`,\r\n                        author: item.author,\r\n                        category: item.label,\r\n                        img: item.icon,\r\n                        pubDate: timezone(parseDate(item.dateline), +8),\r\n                        description: item.description,\r\n                    };\r\n                })\r\n            )\r\n        );\r\n        return {\r\n            // 源标题\r\n            title: '清水河畔',\r\n            // 源链接\r\n            link: 'https://bbs.uestc.edu.cn/new',\r\n            // 源文章\r\n            item: items,\r\n        };\r\n    },\r\n};\r\n"],"mappings":"gcASA,MAAaA,EAAe,CACxB,KAAM,eACN,KAAM,OACN,YAAa,CAAC,SACd,WAAY,CAAC,cACb,IAAK,mBACL,QAAS,uBACT,WAAY,CAAE,MAAO,uEACrB,SAAU,CACN,cAAe,CACX,CACI,KAAM,mBACN,SAAU,GACV,YAAa,aAEjB,CACI,KAAM,qBACN,SAAU,GACV,YAAa,8BAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,YAAa;;;;;;EAOb,MAAO,CACH,CACI,OAAQ,CAAC,sBACT,OAAQ,mBAGhB,QAAS,KAAO,IAAQ,CACpB,GAAM,CAAE,YAAW,cAAe,EAAO,MACzC,GAAI,CAAC,GAAa,CAAC,EACf,MAAM,IAAIC,EAAoB,qCAElC,GAAM,CAAE,QAAQ,0CAA6C,EAAI,IAAI,QAC/D,EAAO,MAAMC,EAAO,uDAAuD,IAAS,CACtF,QAAS,CACL,OAAQ,EACR,QAAS,+BACT,cAAe,KAGjB,EAAW,OAAO,QAAQ,EAAK,KAAK,UAAU,SAAS,CAAC,EAAOC,KAAWA,EAAM,IAAK,IAAU,CAAE,GAAG,EAAM,YAC1G,EAAQ,MAAM,QAAQ,IACxB,EAAS,IAAK,GACVC,EAAM,OAAO,yDAAyD,EAAK,YAAa,SAAY,CAChG,IAAM,EAAW,MAAMF,EAAO,yDAAyD,EAAK,YAAa,CACrG,QAAS,CACL,OAAQ,EACR,QAAS,2BACT,cAAe,KAGjB,EAAI,EAAK,GAEf,MADA,GAAK,YAAc,EAAE,gBAAgB,OAC9B,CACH,MAAO,EAAK,QACZ,KAAM,mCAAmC,EAAK,YAC9C,OAAQ,EAAK,OACb,SAAU,EAAK,MACf,IAAK,EAAK,KACV,QAAS,EAAS,EAAU,EAAK,UAAW,GAC5C,YAAa,EAAK,iBAKlC,MAAO,CAEH,MAAO,OAEP,KAAM,+BAEN,KAAM"}