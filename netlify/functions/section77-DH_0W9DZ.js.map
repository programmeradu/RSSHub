{"version":3,"file":"section77-DH_0W9DZ.js","names":["route: Route","got","cache","response","$"],"sources":["../../lib/routes/parliament/section77.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { CookieJar } from 'tough-cookie';\r\n\r\nexport const route: Route = {\r\n    path: '/section77/:type?',\r\n    categories: ['government'],\r\n    example: '/parliament/section77',\r\n    parameters: { type: 'Type of hearing status, see below' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: \"Thailand Parliament Draft of Law's public hearing system\",\r\n    maintainers: ['itpcc'],\r\n    handler,\r\n    description: `| Presented by MP \\*       | Presented by People \\* | Hearing Ongoing     | Hearing ended   | Hearing result reported  | Waiting for PM approval | Assigned into the session | Processed  | PM Rejected   |\r\n| ------------------------ | ---------------------- | ------------------- | --------------- | ------------------------ | ----------------------- | ------------------------- | ---------- | ------------- |\r\n| presentbymp              | presentbyperson        | openwsu             | closewsu        | reportwsu                | substatus1              | substatus2                | substatus3 | closewsubypm  |\r\n| เสนอโดยสมาชิกสภาผู้แทนราษฏร | เสนอโดยประชาชน         | กำลังเปิดรับฟังความคิดเห็น | ปิดรับฟังความคิดเห็น | รายงานผลการรับฟังความคิดเห็น | รอคำรับรองจากนายกรัฐมนตรี   | บรรจุเข้าระเบียบวาระ         | พิจารณาแล้ว  | นายกฯ ไม่รับรอง |\r\n\r\n  *Note:* For \\`presentbymp\\` and \\`presentbyperson\\`, it can also add:\r\n\r\n  -   \\`-m\\` for the draft which Speaker of Parliament considered as a monetary draft (ประธานสภาผู้แทนราษฎรวินิจฉัยว่า เป็นร่างการเงิน), or\r\n  -   \\`-nm\\` for non-monetary one (ประธานสภาผู้แทนราษฎรวินิจฉัยว่า ไม่เป็นร่างการเงิน).`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const baseUrl = 'https://www.parliament.go.th/section77';\r\n    const { type = '' } = ctx.req.param();\r\n    const cookieJar = new CookieJar();\r\n\r\n    let title = 'ร่างพระราชบัญญัติที่เปิดรับฟังความคิดเห็นตามมาตรา 77 ของรัฐธรรมนูญ';\r\n\r\n    if (type) {\r\n        const [presenter, isMonetaryAct = ''] = type.split('-');\r\n\r\n        title +=\r\n            {\r\n                presentbymp: 'ที่เสนอโดยสมาชิกสภาผู้แทนราษฏร',\r\n                presentbyperson: 'ที่เสนอโดยประชาชน',\r\n                openwsu: 'ที่กำลังเปิดรับฟังความคิดเห็น',\r\n                closewsu: 'ที่ปิดรับฟังความคิดเห็น',\r\n                reportwsu: ' รายงานผลการรับฟังความคิดเห็น',\r\n                substatus1: 'ซึ่งรอคำรับรองจากนายกรัฐมนตรี',\r\n                substatus2: 'ที่บรรจุเข้าระเบียบวาระ',\r\n                substatus3: 'ที่พิจารณาแล้ว',\r\n                closewsubypm: 'ที่นายกฯ ไม่รับรอง',\r\n            }[presenter] ?? '';\r\n\r\n        title +=\r\n            {\r\n                m: ' (ประธานสภาผู้แทนราษฎรวินิจฉัยว่า เป็นร่างการเงิน)',\r\n                nm: ' (ประธานสภาผู้แทนราษฎรวินิจฉัยว่า ไม่เป็นร่างการเงิน)',\r\n            }[isMonetaryAct] ?? '';\r\n    }\r\n\r\n    const result = {\r\n        title,\r\n        link: `${baseUrl}/survey_more_news.php${type ? '?type=' + type : ''}`,\r\n        language: 'th-th',\r\n        item: [],\r\n    };\r\n\r\n    const queryParams = {\r\n        page: 1,\r\n        type,\r\n    };\r\n    if (type) {\r\n        queryParams.type = type;\r\n    }\r\n\r\n    const url = `${baseUrl}/ajax/pagination.php?${new URLSearchParams(queryParams).toString()}`;\r\n    const { data: response } = await got({\r\n        url,\r\n        cookieJar,\r\n    });\r\n    const $ = load(response);\r\n\r\n    if ($.text() === 'ยังไม่มีข้อมูล') {\r\n        return result;\r\n    }\r\n\r\n    const actList = $('div.item-77')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.find('a').text(),\r\n                link: `${baseUrl}/${item.find('a').attr('href')}`,\r\n                category: item\r\n                    .find('label')\r\n                    .toArray()\r\n                    .map((l) => $(l).text()),\r\n            };\r\n        });\r\n\r\n    if (!actList.length) {\r\n        return result;\r\n    }\r\n\r\n    const actListFull = await Promise.all(\r\n        actList.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: response } = await got({\r\n                    url: item.link,\r\n                    cookieJar,\r\n                });\r\n                const $ = load(response);\r\n\r\n                // Select the first element with the class name 'comment-body'\r\n                item.title = $('.title h5').first().text();\r\n                item.author = $('.present-by')\r\n                    .first()\r\n                    .text()\r\n                    .replaceAll(/^\\s*เสนอโดย\\s*/g, '');\r\n                item.description = $('.des').first().html();\r\n\r\n                // Act draft status\r\n                const [, presenter, monetaryType] = $('.type77 h5').text().split(' ');\r\n                item.category = [\r\n                    ...item.category,\r\n                    $('.container-fluid .bg-status .col-md-8.p-0 h5 span,a')\r\n                        .toArray()\r\n                        .map((statusElem) => $(statusElem).text()),\r\n                    presenter,\r\n                    monetaryType,\r\n                ];\r\n\r\n                const voteText = $('.row.bg-status .col-md-4.text-right').text().trim();\r\n                const voteRegex = /^ผู้แสดงความคิดเห็น\\s*(\\d+)\\s*คน\\s*(\\d+(?:\\.\\d+)?)%\\s*(\\d+(?:\\.\\d+)?)%/g.exec(voteText);\r\n\r\n                if (voteRegex) {\r\n                    const voteTotal = Number.parseInt(voteRegex[0]);\r\n                    const upvotePercent = Number.parseFloat(voteRegex[1]);\r\n                    const downvotePercent = Number.parseFloat(voteRegex[2]);\r\n\r\n                    item.upvotes = Number.parseInt((upvotePercent / 100) * voteTotal);\r\n                    item.downvotes = Number.parseInt((downvotePercent / 100) * voteTotal);\r\n                }\r\n\r\n                const dateText = $('.banner-detail .banner-detail-caption .blockquote p:last-child').text();\r\n                const dateRegex = /^รับฟังตั้งแต่วันที่\\s(\\d{1,2})\\s*([\\u0E00-\\u0E7F]+)\\s*(\\d{4})/g.exec(dateText);\r\n\r\n                if (dateRegex) {\r\n                    item.pubDate = timezone(\r\n                        new Date(\r\n                            Number.parseInt(dateRegex[3]) - 543,\r\n                            {\r\n                                มกราคม: 0,\r\n                                กุมภาพันธ์: 1,\r\n                                มีนาคม: 2,\r\n                                เมษายน: 3,\r\n                                พฤษภาคม: 4,\r\n                                มิถุนายน: 5,\r\n                                กรกฎาคม: 6,\r\n                                สิงหาคม: 7,\r\n                                กันยายน: 8,\r\n                                ตุลาคม: 9,\r\n                                พฤศจิกายน: 10,\r\n                                ธันวาคม: 11,\r\n                            }[dateRegex[2].trim()],\r\n                            Number.parseInt(dateRegex[1])\r\n                        ),\r\n                        +7\r\n                    );\r\n                }\r\n\r\n                // Every property of a list item defined above is reused here\r\n                // and we add a new property 'description'\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    if (!actListFull.length) {\r\n        return result;\r\n    }\r\n\r\n    result.item = actListFull;\r\n\r\n    return result;\r\n}\r\n"],"mappings":"8YAOA,MAAaA,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,cACb,QAAS,wBACT,WAAY,CAAE,KAAM,qCACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,2DACN,YAAa,CAAC,SACd,UACA,YAAa;;;;;;;;2FAWjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,yCACV,CAAE,OAAO,IAAO,EAAI,IAAI,QACxB,EAAY,IAAI,EAElB,EAAQ,qEAEZ,GAAI,EAAM,CACN,GAAM,CAAC,EAAW,EAAgB,IAAM,EAAK,MAAM,KAEnD,GACI,CACI,YAAa,iCACb,gBAAiB,oBACjB,QAAS,gCACT,SAAU,0BACV,UAAW,gCACX,WAAY,gCACZ,WAAY,0BACZ,WAAY,iBACZ,aAAc,sBAChB,IAAc,GAEpB,GACI,CACI,EAAG,qDACH,GAAI,yDACN,IAAkB,GAG5B,IAAM,EAAS,CACX,QACA,KAAM,GAAG,EAAQ,uBAAuB,EAAO,SAAW,EAAO,KACjE,SAAU,QACV,KAAM,IAGJ,EAAc,CAChB,KAAM,EACN,QAEA,IACA,EAAY,KAAO,GAGvB,IAAM,EAAM,GAAG,EAAQ,uBAAuB,IAAI,gBAAgB,GAAa,aACzE,CAAE,KAAM,GAAa,MAAMC,EAAI,CACjC,MACA,cAEE,EAAI,EAAK,GAEf,GAAI,EAAE,SAAW,iBACb,OAAO,EAGX,IAAM,EAAU,EAAE,eACb,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,KAAK,KAAK,OACtB,KAAM,GAAG,EAAQ,GAAG,EAAK,KAAK,KAAK,KAAK,UACxC,SAAU,EACL,KAAK,SACL,UACA,IAAK,GAAM,EAAE,GAAG,WAIjC,GAAI,CAAC,EAAQ,OACT,OAAO,EAGX,IAAM,EAAc,MAAM,QAAQ,IAC9B,EAAQ,IAAK,GACTC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAMC,GAAa,MAAMF,EAAI,CACjC,IAAK,EAAK,KACV,cAEEG,EAAI,EAAKD,GAGf,EAAK,MAAQC,EAAE,aAAa,QAAQ,OACpC,EAAK,OAASA,EAAE,eACX,QACA,OACA,WAAW,kBAAmB,IACnC,EAAK,YAAcA,EAAE,QAAQ,QAAQ,OAGrC,GAAM,EAAG,EAAW,GAAgBA,EAAE,cAAc,OAAO,MAAM,KACjE,EAAK,SAAW,CACZ,GAAG,EAAK,SACRA,EAAE,uDACG,UACA,IAAK,GAAeA,EAAE,GAAY,QACvC,EACA,GAGJ,IAAM,EAAWA,EAAE,uCAAuC,OAAO,OAC3D,EAAY,0EAA0E,KAAK,GAEjG,GAAI,EAAW,CACX,IAAM,EAAY,OAAO,SAAS,EAAU,IACtC,EAAgB,OAAO,WAAW,EAAU,IAC5C,EAAkB,OAAO,WAAW,EAAU,IAEpD,EAAK,QAAU,OAAO,SAAU,EAAgB,IAAO,GACvD,EAAK,UAAY,OAAO,SAAU,EAAkB,IAAO,GAG/D,IAAM,EAAWA,EAAE,kEAAkE,OAC/E,EAAY,kEAAkE,KAAK,GA4BzF,OA1BI,IACA,EAAK,QAAU,EACX,IAAI,KACA,OAAO,SAAS,EAAU,IAAM,IAChC,CACI,OAAQ,EACR,WAAY,EACZ,OAAQ,EACR,OAAQ,EACR,QAAS,EACT,SAAU,EACV,QAAS,EACT,QAAS,EACT,QAAS,EACT,OAAQ,EACR,UAAW,GACX,QAAS,IACX,EAAU,GAAG,QACf,OAAO,SAAS,EAAU,KAE9B,IAMD,MAWnB,OANK,EAAY,SAIjB,EAAO,KAAO,GAHH"}