{"version":3,"file":"news-CDkyobyO.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/wallstreetcn/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst titles = {\r\n    global: '最新',\r\n    shares: '股市',\r\n    bonds: '债市',\r\n    commodities: '商品',\r\n    forex: '外汇',\r\n    enterprise: '公司',\r\n    'asset-manage': '资管',\r\n    tmt: '科技',\r\n    estate: '地产',\r\n    car: '汽车',\r\n    medicine: '医药',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/news/:category?',\r\n    categories: ['finance'],\r\n    example: '/wallstreetcn/news',\r\n    radar: [\r\n        {\r\n            source: ['wallstreetcn.com/news/:category', 'wallstreetcn.com/'],\r\n        },\r\n    ],\r\n    name: '资讯',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| id           | 分类 |\r\n| ------------ | ---- |\r\n| global       | 最新 |\r\n| shares       | 股市 |\r\n| bonds        | 债市 |\r\n| commodities  | 商品 |\r\n| forex        | 外汇 |\r\n| enterprise   | 公司 |\r\n| asset-manage | 资管 |\r\n| tmt          | 科技 |\r\n| estate       | 地产 |\r\n| car          | 汽车 |\r\n| medicine     | 医药 |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category') ?? 'global';\r\n\r\n    const rootUrl = 'https://wallstreetcn.com';\r\n    const apiRootUrl = 'https://api-one.wallstcn.com';\r\n    const currentUrl = `${rootUrl}/news/${category}`;\r\n    const apiUrl = `${apiRootUrl}/apiv1/content/information-flow?channel=${category}-channel&accept=article&limit=${ctx.req.query('limit') ?? 25}`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: apiUrl,\r\n    });\r\n\r\n    let items = response.data.data.items\r\n        .filter((item) => item.resource_type !== 'ad')\r\n        .map((item) => ({\r\n            type: item.resource_type,\r\n            guid: item.resource.id,\r\n            link: item.resource.uri,\r\n            pubDate: parseDate(item.resource.display_time * 1000),\r\n        }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: `${apiRootUrl}/apiv1/content/${item.type === 'live' ? `lives/${item.guid}` : `articles/${item.guid}?extract=0`}`,\r\n                });\r\n\r\n                const responseData = detailResponse.data;\r\n\r\n                // 处理 { code: 60301, message: '内容不存在或已被删除', data: {} }\r\n                if (responseData.code !== 20000) {\r\n                    return null;\r\n                }\r\n\r\n                const data = responseData.data;\r\n\r\n                item.title = data.title || data.content_text;\r\n                item.author = data.source_name ?? data.author.display_name;\r\n                item.description = data.content + (data.content_more ?? '');\r\n                item.category = data.asset_tags?.map((t) => t.name) ?? [];\r\n\r\n                if (data.audio_uri) {\r\n                    item.enclosure_type = 'audio/mpeg';\r\n                    item.enclosure_url = data.audio_uri;\r\n                    item.itunes_item_image = data.image?.uri ?? '';\r\n                    item.itunes_duration = data.audio_info?.duration ?? '';\r\n                }\r\n\r\n                delete item.type;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    items = items.filter((item) => item !== null);\r\n\r\n    return {\r\n        title: `华尔街见闻 - 资讯 - ${titles[category]}`,\r\n        link: currentUrl,\r\n        item: items,\r\n        itunes_author: '华尔街见闻',\r\n        image: 'https://static.wscn.net/wscn/_static/favicon.png',\r\n    };\r\n}\r\n"],"mappings":"yUAKA,MAAM,EAAS,CACX,OAAQ,KACR,OAAQ,KACR,MAAO,KACP,YAAa,KACb,MAAO,KACP,WAAY,KACZ,eAAgB,KAChB,IAAK,KACL,OAAQ,KACR,IAAK,KACL,SAAU,MAGDA,EAAe,CACxB,KAAM,mBACN,WAAY,CAAC,WACb,QAAS,qBACT,MAAO,CACH,CACI,OAAQ,CAAC,kCAAmC,uBAGpD,KAAM,KACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;;;;;;;wBAejB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,aAAe,SAGxC,EAAa,+BACb,EAAa,iCAAmB,IAChC,EAAS,GAAG,EAAW,0CAA0C,EAAS,gCAAgC,EAAI,IAAI,MAAM,UAAY,KAEpI,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,IAGL,EAAQ,EAAS,KAAK,KAAK,MAC1B,OAAQ,GAAS,EAAK,gBAAkB,MACxC,IAAK,IAAU,CACZ,KAAM,EAAK,cACX,KAAM,EAAK,SAAS,GACpB,KAAM,EAAK,SAAS,IACpB,QAAS,EAAU,EAAK,SAAS,aAAe,QAyCxD,MAtCA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAMD,EAAI,CAC7B,OAAQ,MACR,IAAK,GAAG,EAAW,iBAAiB,EAAK,OAAS,OAAS,SAAS,EAAK,OAAS,YAAY,EAAK,KAAK,gBAGtG,EAAe,EAAe,KAGpC,GAAI,EAAa,OAAS,IACtB,OAAO,KAGX,IAAM,EAAO,EAAa,KAgB1B,MAdA,GAAK,MAAQ,EAAK,OAAS,EAAK,aAChC,EAAK,OAAS,EAAK,aAAe,EAAK,OAAO,aAC9C,EAAK,YAAc,EAAK,SAAW,EAAK,cAAgB,IACxD,EAAK,SAAW,EAAK,YAAY,IAAK,GAAM,EAAE,OAAS,GAEnD,EAAK,YACL,EAAK,eAAiB,aACtB,EAAK,cAAgB,EAAK,UAC1B,EAAK,kBAAoB,EAAK,OAAO,KAAO,GAC5C,EAAK,gBAAkB,EAAK,YAAY,UAAY,IAGxD,OAAO,EAAK,KAEL,MAKnB,EAAQ,EAAM,OAAQ,GAAS,IAAS,MAEjC,CACH,MAAO,gBAAgB,EAAO,KAC9B,KAAM,EACN,KAAM,EACN,cAAe,QACf,MAAO"}