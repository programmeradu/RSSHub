{"version":3,"file":"nytimes-BGfdfL_q.js","names":["cache","route: Route","puppeteer","parser","cache","response","got","utils"],"sources":["../../lib/routes/nytimes/utils.ts","../../lib/routes/nytimes/index.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst ProcessImage = ($, e) => {\r\n    const photo = $(e).find('figure').find('picture').find('img');\r\n\r\n    let cover = `<figure><img src='${photo.attr('src')}'><br><figcaption>`;\r\n\r\n    const caption = $(e).find('figcaption');\r\n\r\n    cover += `${$(caption[0]).text().trim()}</figcaption></figure>`;\r\n\r\n    return cover;\r\n};\r\n\r\nconst PuppeterGetter = async (ctx, browser, link) => {\r\n    const result = await cache.tryGet(`nyt: ${link}`, async () => {\r\n        const page = await browser.newPage();\r\n        await page.setRequestInterception(true);\r\n        page.on('request', (request) => {\r\n            request.resourceType() === 'document' ? request.continue() : request.abort();\r\n        });\r\n        await page.goto(link, {\r\n            waitUntil: 'domcontentloaded',\r\n        });\r\n        const response = await page.evaluate(() => document.querySelector('body').innerHTML);\r\n        return response;\r\n    });\r\n    return result;\r\n};\r\n\r\nconst ProcessFeed = (data, hasEnVersion = false) => {\r\n    const $ = load(data);\r\n\r\n    let content;\r\n    const result = {};\r\n\r\n    // 处理 www.nytimes.com\r\n    if (hasEnVersion) {\r\n        content = $('section[name=\"articleBody\"]');\r\n        result.title = `「英」${$('h1').text().trim()}`;\r\n        result.author = $('article#story span[itemprop=\"name\"]').text();\r\n\r\n        // 处理封面图片\r\n        $('article#story > header')\r\n            .find('div[data-testid=\"photoviewer-wrapper\"]')\r\n            .each((i, e) => {\r\n                const cover = ProcessImage($, e);\r\n\r\n                $(cover).insertBefore(content[0].firstChild);\r\n            });\r\n\r\n        // 处理图片\r\n        content.find('div[data-testid=\"photoviewer-wrapper\"]').each((i, e) => {\r\n            const cover = ProcessImage($, e);\r\n            $(cover).insertBefore(e);\r\n            $(e).remove();\r\n        });\r\n\r\n        // remove ad\r\n        content.find('#CNB').each((i, e) => {\r\n            $(e).next().remove();\r\n        });\r\n\r\n        content.find('div[id]').each((i, e) => {\r\n            $(e).remove();\r\n        });\r\n        // remove useless DOMs\r\n        content.find('aside').each((i, e) => {\r\n            $(e).remove();\r\n        });\r\n    }\r\n    // 处理 cn.nytimes.com\r\n    else {\r\n        content = $('section.article-body');\r\n\r\n        // remove useless DOMs\r\n        content.find('div.big_ad, div.article-body-aside').each((i, e) => {\r\n            $(e).remove();\r\n        });\r\n\r\n        // divide paragraphs with <p>\r\n        content.find('div.article-paragraph').each((i, e) => {\r\n            $(e).html(`<p>${$(e).html()}</p>`);\r\n        });\r\n\r\n        if ($('figure.article-span-photo').length > 0) {\r\n            // there is a cover photo\r\n            const cover = $('figure.article-span-photo');\r\n            $(cover).insertBefore(content[0].firstChild);\r\n        }\r\n\r\n        if ($('footer.author-info').length > 0) {\r\n            // credit to original author and translators\r\n            const footer = $('footer.author-info');\r\n            $(footer).insertAfter(content[0].lastChild);\r\n        }\r\n    }\r\n\r\n    const time = $('time').attr('datetime');\r\n    if (time) {\r\n        result.pubDate = parseDate(time);\r\n    }\r\n\r\n    result.description = content.html();\r\n\r\n    return result;\r\n};\r\n\r\nexport default { ProcessFeed, PuppeterGetter };\r\n","import { Route, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport parser from '@/utils/rss-parser';\r\nimport utils from './utils';\r\nimport { load } from 'cheerio';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nexport const route: Route = {\r\n    path: '/:lang?',\r\n    categories: ['traditional-media'],\r\n    view: ViewType.Articles,\r\n    example: '/nytimes/dual',\r\n    parameters: {\r\n        lang: {\r\n            description: 'language, default to Chinese',\r\n            options: [\r\n                { value: 'dual', label: 'Chinese-English' },\r\n                { value: 'en', label: 'English' },\r\n                { value: 'traditionalchinese', label: 'Traditional Chinese' },\r\n                { value: 'dual-traditionalchinese', label: 'Chinese-English (Traditional Chinese)' },\r\n            ],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['nytimes.com/'],\r\n            target: '',\r\n        },\r\n    ],\r\n    name: 'News',\r\n    maintainers: ['HenryQW', 'pseudoyu'],\r\n    handler,\r\n    url: 'nytimes.com/',\r\n    description: `By extracting the full text of articles, we provide a better reading experience (full text articles) over the official one.`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    let { lang = '' } = ctx.req.param();\r\n    lang = lang.toLowerCase();\r\n\r\n    let title = '纽约时报中文网';\r\n    let rssUrl = 'https://cn.nytimes.com/rss/';\r\n\r\n    switch (lang) {\r\n        case 'dual':\r\n            title += ' - 中英对照版';\r\n\r\n            break;\r\n\r\n        case 'en':\r\n            title += ' - 英文原版';\r\n\r\n            break;\r\n\r\n        case 'traditionalchinese':\r\n            title = '紐約時報中文網';\r\n            rssUrl = new URL('zh-hant', rssUrl).href;\r\n\r\n            break;\r\n\r\n        case 'dual-traditionalchinese':\r\n            title = '紐約時報中文網 - 中英對照版';\r\n            rssUrl = new URL('zh-hant', rssUrl).href;\r\n            lang = 'dual';\r\n\r\n            break;\r\n\r\n        default:\r\n        // Do nothing\r\n    }\r\n\r\n    const browser = await puppeteer();\r\n    const feed = await parser.parseURL(rssUrl);\r\n    const items = await Promise.all(\r\n        feed.items.splice(0, 10).map(async (item) => {\r\n            let link = item.link;\r\n\r\n            let response,\r\n                hasEnVersion = false,\r\n                dual = false;\r\n\r\n            if (lang === 'dual') {\r\n                link = link.replace('/?utm_source=RSS', '') + '/dual';\r\n\r\n                try {\r\n                    response = await cache.tryGet(`nyt: ${link}`, async () => {\r\n                        const response = await got(link);\r\n\r\n                        return response.data;\r\n                    });\r\n\r\n                    dual = true;\r\n                } catch {\r\n                    response = await cache.tryGet(`nyt: ${item.link}`, async () => {\r\n                        const response = await got(item.link);\r\n\r\n                        return response.data;\r\n                    });\r\n                }\r\n            } else {\r\n                response = await cache.tryGet(`nyt: ${item.link}`, async () => {\r\n                    const response = await got(item.link);\r\n\r\n                    return response.data;\r\n                });\r\n\r\n                if (lang === 'en') {\r\n                    const $ = load(response);\r\n                    if ($('.dual-btn').length > 0) {\r\n                        hasEnVersion = true;\r\n                        link = $('.dual-btn a').last().attr().href;\r\n\r\n                        response = await utils.PuppeterGetter(ctx, browser, link);\r\n                    }\r\n                }\r\n            }\r\n\r\n            const single = {\r\n                title: item.title,\r\n                pubDate: item.pubDate,\r\n                link,\r\n                author: item['dc:creator'],\r\n            };\r\n\r\n            const result = utils.ProcessFeed(response, hasEnVersion);\r\n\r\n            // Match 感谢|謝.*?cn.letters@nytimes.com。\r\n            const ending = /&#x611F;(&#x8C22|&#x8B1D);.*?cn\\.letters@nytimes\\.com&#x3002;/g;\r\n\r\n            single.description = result.description?.replace(ending, '');\r\n\r\n            if (hasEnVersion) {\r\n                single.title = result.title;\r\n                single.author = result.author;\r\n            }\r\n\r\n            if (dual) {\r\n                single.title = `「中英」${single.title}`;\r\n            }\r\n\r\n            return single;\r\n        })\r\n    );\r\n\r\n    await browser.close();\r\n\r\n    return {\r\n        title,\r\n        link: 'https://cn.nytimes.com',\r\n        description: title,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}