{"version":3,"file":"wgj-CpJxlQ61.js","names":[],"sources":["../../lib/routes/gov/sh/wgj/wgj.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: ['/sh/wgj/:page?', '/shanghai/wgj/:page?'],\r\n    categories: ['government'],\r\n    example: '/gov/sh/wgj',\r\n    parameters: { page: '页数，默认第 1 页' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['wsbs.wgj.sh.gov.cn/'],\r\n            target: '/sh/wgj',\r\n        },\r\n    ],\r\n    name: '上海市文旅局审批公告',\r\n    maintainers: ['gideonsenku'],\r\n    handler,\r\n    url: 'wsbs.wgj.sh.gov.cn/',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const baseUrl = 'http://wsbs.wgj.sh.gov.cn';\r\n    const currentUrl = `${baseUrl}/shwgj_ywtb/core/web/welcome/index!toResultNotice.action`;\r\n    const page = ctx.req.param('page') ?? 1;\r\n    const searchParams = {\r\n        flag: 1,\r\n        'pageDoc.pageNo': page,\r\n    };\r\n    const response = await got({\r\n        method: 'post',\r\n        url: currentUrl,\r\n        searchParams,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n    const list = $('#div_md > table > tbody > tr > td:nth-child(1) > a')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.prop('innerText').replaceAll(/\\s/g, ''),\r\n                link: item.attr('href'),\r\n            };\r\n        });\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: baseUrl + item.link,\r\n                });\r\n                const $ = load(detailResponse.data);\r\n                const dateElement = $('div[align=\"right\"][style*=\"padding: 10px\"]').last();\r\n                const dateText = dateElement.text().trim();\r\n                const hostingUnit = $('td:contains(\"举办单位：\")').next().text().trim();\r\n                const licenseNumber = $('td:contains(\"许可证号：\")').next().text().trim();\r\n                const performanceName = $('td:contains(\"演出名称:\")').next().text().trim();\r\n                const performanceDate = $('td:contains(\"演出日期：\")').next().text().trim();\r\n                const performanceVenue = $('td:contains(\"演出场所：\")').next().text().trim();\r\n                const mainActors = $('td:contains(\"主要演员：\")').next().text().trim();\r\n                const actorCount = $('td:contains(\"演员人数：\")').next().text().trim();\r\n                const showCount = $('td:contains(\"场次：\")').next().text().trim();\r\n\r\n                item.description = art(path.join(__dirname, './templates/wgj.art'), {\r\n                    hostingUnit,\r\n                    licenseNumber,\r\n                    performanceName,\r\n                    performanceDate,\r\n                    performanceVenue,\r\n                    mainActors,\r\n                    actorCount,\r\n                    showCount,\r\n                });\r\n                item.pubDate = parseDate(dateText);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,CAAC,iBAAkB,wBACzB,WAAY,CAAC,cACb,QAAS,cACT,WAAY,CAAE,KAAM,cACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,uBACT,OAAQ,YAGhB,KAAM,aACN,YAAa,CAAC,eACd,UACA,IAAK,uBAGT,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,4BACV,EAAa,GAAG,EAAQ,0DACxB,EAAO,EAAI,IAAI,MAAM,SAAW,EAChC,EAAe,CACjB,KAAM,EACN,iBAAkB,GAEhB,EAAW,MAAM,EAAI,CACvB,OAAQ,OACR,IAAK,EACL,iBAGE,EAAI,EAAK,EAAS,MAClB,EAAO,EAAE,sDACV,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,KAAK,aAAa,WAAW,MAAO,IAChD,KAAM,EAAK,KAAK,WAGtB,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAU,EAAK,OAElB,EAAI,EAAK,EAAe,MACxB,EAAc,EAAE,8CAA8C,OAC9D,EAAW,EAAY,OAAO,OAC9B,EAAc,EAAE,wBAAwB,OAAO,OAAO,OACtD,EAAgB,EAAE,wBAAwB,OAAO,OAAO,OACxD,EAAkB,EAAE,wBAAwB,OAAO,OAAO,OAC1D,EAAkB,EAAE,wBAAwB,OAAO,OAAO,OAC1D,EAAmB,EAAE,wBAAwB,OAAO,OAAO,OAC3D,EAAa,EAAE,wBAAwB,OAAO,OAAO,OACrD,EAAa,EAAE,wBAAwB,OAAO,OAAO,OACrD,EAAY,EAAE,sBAAsB,OAAO,OAAO,OAcxD,MAZA,GAAK,YAAc,EAAI,EAAA,KAAA,EAAA,8BAA6C,CAChE,cACA,gBACA,kBACA,kBACA,mBACA,aACA,aACA,cAEJ,EAAK,QAAU,EAAU,GAElB,MAKnB,MAAO,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM"}