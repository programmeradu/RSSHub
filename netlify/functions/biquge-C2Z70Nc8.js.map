{"version":3,"file":"biquge-C2Z70Nc8.js","names":["route: Route","ConfigNotFoundError","got","cache"],"sources":["../../lib/routes/biquge/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport { getSubPath } from '@/utils/common-utils';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport iconv from 'iconv-lite';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nconst allowHost = new Set([\r\n    'www.xbiquwx.la',\r\n    'www.biqu5200.net',\r\n    'www.xbiquge.so',\r\n    'www.biqugeu.net',\r\n    'www.b520.cc',\r\n    'www.ahfgb.com',\r\n    'www.ibiquge.la',\r\n    'www.biquge.tv',\r\n    'www.bswtan.com',\r\n    'www.biquge.co',\r\n    'www.bqzhh.com',\r\n    'www.biqugse.com',\r\n    'www.ibiquge.info',\r\n    'www.ishuquge.com',\r\n    'www.mayiwxw.com',\r\n]);\r\n\r\nexport const route: Route = {\r\n    path: '*',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const rootUrl = getSubPath(ctx).split('/').slice(1, 4).join('/');\r\n    const currentUrl = getSubPath(ctx).slice(1);\r\n    if (!config.feature.allow_user_supply_unsafe_domain && !allowHost.has(new URL(rootUrl).hostname)) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n        responseType: 'buffer',\r\n        https: {\r\n            rejectUnauthorized: false,\r\n        },\r\n    });\r\n\r\n    const isGBK = /charset=\"?'?gb/i.test(response.data.toString());\r\n    const encoding = isGBK ? 'gbk' : 'utf-8';\r\n\r\n    const $ = load(iconv.decode(response.data, encoding));\r\n    const author = $('meta[property=\"og:novel:author\"]').attr('content');\r\n    const pubDate = timezone(parseDate($('meta[property=\"og:novel:update_time\"]').attr('content')), +8);\r\n\r\n    let items = $('dl dd a')\r\n        .toArray()\r\n        .toReversed()\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 1)\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            let link = '';\r\n            const url = item.attr('href');\r\n            if (url.startsWith('http')) {\r\n                link = url;\r\n            } else if (/^\\//.test(url)) {\r\n                link = `${rootUrl}${url}`;\r\n            } else {\r\n                link = `${currentUrl}/${url}`;\r\n            }\r\n\r\n            return {\r\n                title: item.text(),\r\n                link,\r\n                author,\r\n                pubDate,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                    responseType: 'buffer',\r\n                    https: {\r\n                        rejectUnauthorized: false,\r\n                    },\r\n                });\r\n\r\n                const content = load(iconv.decode(detailResponse.data, encoding));\r\n\r\n                item.description = content('#content').html();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${$('meta[property=\"og:title\"]').attr('content')} - 笔趣阁`,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ukBAUA,MAAM,EAAY,IAAI,IAAI,CACtB,iBACA,mBACA,iBACA,kBACA,cACA,gBACA,iBACA,gBACA,iBACA,gBACA,gBACA,kBACA,mBACA,mBACA,oBAGSA,EAAe,CACxB,KAAM,IACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,EAAW,GAAK,MAAM,KAAK,MAAM,EAAG,GAAG,KAAK,KACtD,EAAa,EAAW,GAAK,MAAM,GACzC,GAAI,CAAC,EAAO,QAAQ,iCAAmC,CAAC,EAAU,IAAI,IAAI,IAAI,GAAS,UACnF,MAAM,IAAIC,EAAoB,mFAGlC,IAAM,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,EACL,aAAc,SACd,MAAO,CACH,mBAAoB,MAItB,EAAQ,kBAAkB,KAAK,EAAS,KAAK,YAC7C,EAAW,EAAQ,MAAQ,QAE3B,EAAI,EAAK,EAAM,OAAO,EAAS,KAAM,IACrC,EAAS,EAAE,oCAAoC,KAAK,WACpD,EAAU,EAAS,EAAU,EAAE,yCAAyC,KAAK,YAAa,GAE5F,EAAQ,EAAE,WACT,UACA,aACA,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,GAC5E,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAI,EAAO,GACL,EAAM,EAAK,KAAK,QAStB,MARA,CAKI,EALA,EAAI,WAAW,QACR,EACA,MAAM,KAAK,GACX,GAAG,IAAU,IAEb,GAAG,EAAW,GAAG,IAGrB,CACH,MAAO,EAAK,OACZ,OACA,SACA,aAyBZ,MArBA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAMD,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,KACV,aAAc,SACd,MAAO,CACH,mBAAoB,MAItB,EAAU,EAAK,EAAM,OAAO,EAAe,KAAM,IAIvD,MAFA,GAAK,YAAc,EAAQ,YAAY,OAEhC,MAKZ,CACH,MAAO,GAAG,EAAE,6BAA6B,KAAK,WAAW,QACzD,KAAM,EACN,KAAM"}