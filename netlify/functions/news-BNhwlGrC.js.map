{"version":3,"file":"news-BNhwlGrC.js","names":[],"sources":["../../lib/routes/whu/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nimport { domain, processMeta, getMeta, processItems } from './util';\r\n\r\nexport const route: Route = {\r\n    path: '/news/:category{.+}?',\r\n    categories: ['university'],\r\n    example: '/whu/news',\r\n    parameters: { category: '新闻栏目，可选' },\r\n    name: '新闻网',\r\n    maintainers: [],\r\n    handler,\r\n    description: `\r\ncategory 参数可选，范围如下:\r\n\r\n| 新闻栏目 | 武大资讯 | 学术动态 | 珞珈影像 | 武大视频 |\r\n| -------- | -------- | -------- | -------- | -------- |\r\n| 参数     |  0 或 \\`wdzx/wdyw\\`  | 1 或 \\`kydt\\` | 2 或 \\`stkj/ljyx\\` | 3 或 \\`stkj/wdsp\\` |\r\n\r\n此外 route 后可以加上 \\`?limit=n\\` 的查询参数，表示只获取前 n 条新闻；如果不指定默认为 10。\r\n`,\r\n};\r\n\r\nconst parseCategory = (category: string | number) => {\r\n    const outputs = ['wdzx/wdyw', 'kydt', 'stkj/ljyx', 'stkj/wdsp'];\r\n    if (['0', '1', '2', '3'].includes(category)) {\r\n        return outputs[category];\r\n    }\r\n    if (outputs.includes(category)) {\r\n        return category;\r\n    }\r\n    return 'wdzx/wdyw';\r\n};\r\n\r\nasync function handler(ctx) {\r\n    let { category } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 10;\r\n\r\n    category = parseCategory(category);\r\n\r\n    const rootUrl = `https://news.${domain}`;\r\n    const currentUrl = new URL(`${category}.htm`, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    // The elements where the information is located vary with the category.\r\n    // 武大资讯 https://news.whu.edu.cn/wdzx/wdyw.htm => ul.wdzxList li a[title]\r\n    // 学术动态 https://news.whu.edu.cn/kydt.htm      => ul.xsdtList li a\r\n    // 珞珈影像 https://news.whu.edu.cn/stkj/ljyx.htm => div.topPic a[title], ul.nypicList li a[title]\r\n    // 武大视频 https://news.whu.edu.cn/stkj/wdsp.htm => div.topVid a[title], ul.nyvidList li a[title]\r\n    let items = $('ul.wdzxList li a[title], ul.xsdtList li a, div.topPic a[title], ul.nypicList li a[title], div.topVid a[title], ul.nyvidList li a[title]')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const image = item.find('div.img img');\r\n\r\n            return {\r\n                title: item.prop('title') ?? item.find('h4.eclips').text(),\r\n                link: new URL(item.prop('href'), rootUrl).href,\r\n                pubDate: parseDate(item.find('time').text(), ['YYYY.MM.DD', 'DDYYYY.MM']),\r\n                description: art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: item.find('div.txt p').html(),\r\n                    image: image.prop('src')\r\n                        ? {\r\n                              src: new URL(image.prop('src'), rootUrl).href,\r\n                              alt: image.prop('alt'),\r\n                          }\r\n                        : undefined,\r\n                }),\r\n            };\r\n        });\r\n\r\n    items = await processItems(items, cache.tryGet, rootUrl);\r\n\r\n    const meta = processMeta(response);\r\n    const siteName = getMeta(meta, 'SiteName');\r\n    const columnName = getMeta(meta, 'ColumnName');\r\n\r\n    const icon = new URL($('link[rel=\"shortcut icon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: `${siteName} - ${columnName}`,\r\n        link: currentUrl,\r\n        description: getMeta(meta, 'description'),\r\n        language: $('html').prop('lang'),\r\n        image: new URL($('div.logo img').prop('src'), rootUrl).href,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: columnName,\r\n        author: siteName,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"mlBAWA,MAAa,EAAe,CACxB,KAAM,uBACN,WAAY,CAAC,cACb,QAAS,YACT,WAAY,CAAE,SAAU,WACxB,KAAM,MACN,YAAa,GACb,UACA,YAAa,2QAWX,EAAiB,GAA8B,CACjD,IAAM,EAAU,CAAC,YAAa,OAAQ,YAAa,aAOnD,MANI,CAAC,IAAK,IAAK,IAAK,KAAK,SAAS,GACvB,EAAQ,GAEf,EAAQ,SAAS,GACV,EAEJ,aAGX,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAE,YAAa,EAAI,IAAI,QACrB,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAErF,EAAW,EAAc,GAEzB,IAAM,EAAU,gBAAgB,IAC1B,EAAa,IAAI,IAAI,GAAG,EAAS,MAAO,GAAS,KAEjD,CAAE,KAAM,GAAa,MAAM,EAAI,GAE/B,EAAI,EAAK,GAOX,EAAQ,EAAE,2IACT,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAQ,EAAK,KAAK,eAExB,MAAO,CACH,MAAO,EAAK,KAAK,UAAY,EAAK,KAAK,aAAa,OACpD,KAAM,IAAI,IAAI,EAAK,KAAK,QAAS,GAAS,KAC1C,QAAS,EAAU,EAAK,KAAK,QAAQ,OAAQ,CAAC,aAAc,cAC5D,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,YAAa,EAAK,KAAK,aAAa,OACpC,MAAO,EAAM,KAAK,OACZ,CACI,IAAK,IAAI,IAAI,EAAM,KAAK,OAAQ,GAAS,KACzC,IAAK,EAAM,KAAK,QAEpB,IAAA,QAKtB,EAAQ,MAAM,EAAa,EAAO,EAAM,OAAQ,GAEhD,IAAM,EAAO,EAAY,GACnB,EAAW,EAAQ,EAAM,YACzB,EAAa,EAAQ,EAAM,cAE3B,EAAO,IAAI,IAAI,EAAE,6BAA6B,KAAK,QAAS,GAAS,KAE3E,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAS,KAAK,IACxB,KAAM,EACN,YAAa,EAAQ,EAAM,eAC3B,SAAU,EAAE,QAAQ,KAAK,QACzB,MAAO,IAAI,IAAI,EAAE,gBAAgB,KAAK,OAAQ,GAAS,KACvD,OACA,KAAM,EACN,SAAU,EACV,OAAQ,EACR,WAAY"}