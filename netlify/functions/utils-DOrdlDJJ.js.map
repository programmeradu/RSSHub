{"version":3,"file":"utils-DOrdlDJJ.js","names":[],"sources":["../../lib/routes/thepaper/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate, parseRelativeDate } from '@/utils/parse-date';\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst defaultRssItem = (item) => ({\r\n    title: item.name,\r\n    link: item.link,\r\n    description: item.name,\r\n    pubDate: parseDate(item.pubTimeLong),\r\n    media: {\r\n        content: {\r\n            url: item.pic,\r\n        },\r\n    },\r\n});\r\n\r\nexport default {\r\n    ProcessItem: (item, ctx) => {\r\n        const useOldMode = ctx.req.query('old') === 'yes';\r\n        if (item.link) {\r\n            // external link\r\n            return defaultRssItem(item);\r\n        }\r\n        const itemUrl = `https://m.thepaper.cn/${item.cornerLabelDesc && item.cornerLabelDesc === '短剧' ? 'series' : 'detail'}/${item.contId}`;\r\n        return cache.tryGet(`${itemUrl}${useOldMode ? ':old' : ''}`, async () => {\r\n            const res = await got(itemUrl);\r\n            const data = JSON.parse(load(res.data)('#__NEXT_DATA__').html());\r\n            const detailData = data.props.pageProps.detailData;\r\n            const contentDetail = detailData.contentDetail || detailData.liveDetail || detailData.specialDetail?.specialInfo;\r\n            if (!contentDetail) {\r\n                return defaultRssItem(item);\r\n            }\r\n            let description = contentDetail.content || contentDetail.summary || contentDetail.desc || '';\r\n\r\n            if (contentDetail.videos) {\r\n                description = description + contentDetail.summary;\r\n            }\r\n            if (useOldMode) {\r\n                if (contentDetail.videos) {\r\n                    description =\r\n                        art(path.join(__dirname, 'templates/video_detail.art'), {\r\n                            // see https://nanmu.me/zh-cn/posts/2020/strange-html-video-tag-behavior-in-wechat/\r\n                            // for video tag details\r\n                            videos: contentDetail.videos,\r\n                        }) + description;\r\n                }\r\n                if (contentDetail.images) {\r\n                    description =\r\n                        art(path.join(__dirname, 'templates/image_detail.art'), {\r\n                            images: contentDetail.images,\r\n                        }) + description;\r\n                }\r\n            }\r\n\r\n            let pubDate = parseDate(item.pubTimeLong || contentDetail.publishTime);\r\n            if (Number.isNaN(pubDate)) {\r\n                pubDate = parseRelativeDate(contentDetail.pubTime);\r\n            }\r\n\r\n            const rss_item = {\r\n                title: contentDetail.name || contentDetail.shareName,\r\n                link: itemUrl,\r\n                description,\r\n                category: [...(contentDetail.tagList?.map((t) => t.tag) ?? []), contentDetail?.nodeInfo?.name ?? []],\r\n                pubDate,\r\n                author: contentDetail.author || '',\r\n                media: {\r\n                    content: {\r\n                        url: item.pic || contentDetail.videos?.coverUrl || contentDetail.bigPic,\r\n                    },\r\n                    thumbnails: {\r\n                        url: item.sharePic || contentDetail.sharePic,\r\n                    },\r\n                },\r\n            };\r\n            if (contentDetail.voiceInfo?.isHaveVoice) {\r\n                rss_item.enclosure_type = 'audio/mpeg';\r\n                rss_item.enclosure_url = contentDetail.voiceInfo.voiceSrc;\r\n                rss_item.itunes_item_image = item.pic || contentDetail.videos?.coverUrl;\r\n            }\r\n            return rss_item;\r\n        });\r\n    },\r\n    ChannelIdToName: (nodeId, next_data) => next_data.props.appProps.menu.channelList.find((c) => c.nodeId.toString() === nodeId.toString()).name,\r\n    ListIdToName: (listId, next_data) => next_data.props.appProps.menu.channelList.flatMap((c) => c.childNodeList || []).find((l) => l.nodeId.toString() === listId.toString())?.name,\r\n    ExtractLogo: (response) => 'https://m.thepaper.cn' + load(response.data)('img.imageCover').attr('src'),\r\n};\r\n"],"mappings":"+VAOA,MAAM,EAAkB,IAAU,CAC9B,MAAO,EAAK,KACZ,KAAM,EAAK,KACX,YAAa,EAAK,KAClB,QAAS,EAAU,EAAK,aACxB,MAAO,CACH,QAAS,CACL,IAAK,EAAK,QAKtB,IAAA,EAAe,CACX,aAAc,EAAM,IAAQ,CACxB,IAAM,EAAa,EAAI,IAAI,MAAM,SAAW,MAC5C,GAAI,EAAK,KAEL,OAAO,EAAe,GAE1B,IAAM,EAAU,yBAAyB,EAAK,iBAAmB,EAAK,kBAAoB,KAAO,SAAW,SAAS,GAAG,EAAK,SAC7H,OAAO,EAAM,OAAO,GAAG,IAAU,EAAa,OAAS,KAAM,SAAY,CACrE,IAAM,EAAM,MAAM,EAAI,GAChB,EAAO,KAAK,MAAM,EAAK,EAAI,MAAM,kBAAkB,QACnD,EAAa,EAAK,MAAM,UAAU,WAClC,EAAgB,EAAW,eAAiB,EAAW,YAAc,EAAW,eAAe,YACrG,GAAI,CAAC,EACD,OAAO,EAAe,GAE1B,IAAI,EAAc,EAAc,SAAW,EAAc,SAAW,EAAc,MAAQ,GAEtF,EAAc,SACd,GAA4B,EAAc,SAE1C,IACI,EAAc,SACd,EACI,EAAI,EAAA,KAAA,EAAA,uCAAoD,CAGpD,OAAQ,EAAc,SACrB,GAET,EAAc,SACd,EACI,EAAI,EAAA,KAAA,EAAA,uCAAoD,CACpD,OAAQ,EAAc,SACrB,IAIjB,IAAI,EAAU,EAAU,EAAK,aAAe,EAAc,aACtD,OAAO,MAAM,KACb,EAAU,EAAkB,EAAc,UAG9C,IAAM,EAAW,CACb,MAAO,EAAc,MAAQ,EAAc,UAC3C,KAAM,EACN,cACA,SAAU,CAAC,GAAI,EAAc,SAAS,IAAK,GAAM,EAAE,MAAQ,GAAK,GAAe,UAAU,MAAQ,IACjG,UACA,OAAQ,EAAc,QAAU,GAChC,MAAO,CACH,QAAS,CACL,IAAK,EAAK,KAAO,EAAc,QAAQ,UAAY,EAAc,QAErE,WAAY,CACR,IAAK,EAAK,UAAY,EAAc,YAShD,OALI,EAAc,WAAW,cACzB,EAAS,eAAiB,aAC1B,EAAS,cAAgB,EAAc,UAAU,SACjD,EAAS,kBAAoB,EAAK,KAAO,EAAc,QAAQ,UAE5D,KAGf,iBAAkB,EAAQ,IAAc,EAAU,MAAM,SAAS,KAAK,YAAY,KAAM,GAAM,EAAE,OAAO,aAAe,EAAO,YAAY,KACzI,cAAe,EAAQ,IAAc,EAAU,MAAM,SAAS,KAAK,YAAY,QAAS,GAAM,EAAE,eAAiB,IAAI,KAAM,GAAM,EAAE,OAAO,aAAe,EAAO,aAAa,KAC7K,YAAc,GAAa,wBAA0B,EAAK,EAAS,MAAM,kBAAkB,KAAK"}