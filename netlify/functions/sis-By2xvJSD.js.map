{"version":3,"file":"sis-By2xvJSD.js","names":["got","cache","route: Route"],"sources":["../../lib/routes/zju/sis/index.ts"],"sourcesContent":["import { DataItem, Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst base = 'http://www.sis.zju.edu.cn/sischinese/';\r\n\r\n/**\r\n * Map of category types to their corresponding IDs and titles\r\n * Used to generate URLs and titles for different news categories\r\n */\r\nconst categoryMap = new Map([\r\n    [0, { id: '12614/list.htm', title: '浙江大学外国语学院-重要公告' }],\r\n    [1, { id: '12616/list.htm', title: '浙江大学外国语学院-最新通知' }],\r\n    [2, { id: '12617/list.htm', title: '浙江大学外国语学院-教育教学' }],\r\n    [3, { id: '12618/list.htm', title: '浙江大学外国语学院-科学研究' }],\r\n    [4, { id: '12619/list.htm', title: '浙江大学外国语学院-新闻动态' }],\r\n    [5, { id: '12620/list.htm', title: '浙江大学外国语学院-联系我们' }],\r\n    [6, { id: '12554/list.htm', title: '浙江大学外国语学院-党政管理' }],\r\n    [7, { id: '12563/list.htm', title: '浙江大学外国语学院-组织人事' }],\r\n    [8, { id: '12572/list.htm', title: '浙江大学外国语学院-科学研究' }],\r\n    [9, { id: '12577/list.htm', title: '浙江大学外国语学院-本科教育' }],\r\n    [10, { id: '12541/list.htm', title: '浙江大学外国语学院-研究生教育' }],\r\n    [11, { id: '12542/list.htm', title: '浙江大学外国语学院-学生思政' }],\r\n    [12, { id: 'xyll/list.htm', title: '浙江大学外国语学院-校友联络' }],\r\n    [13, { id: '12609/list.htm', title: '浙江大学外国语学院-对外交流' }],\r\n]);\r\n\r\n/**\r\n * Fetches and parses news items from a specific category page\r\n * @param categoryId - The category ID to fetch news from\r\n * @returns Promise<DataItem[]> - Array of news items with basic information\r\n */\r\nasync function fetchNewsItemsByCategory(categoryId: string): Promise<DataItem[]> {\r\n    const response = await got({\r\n        method: 'get',\r\n        url: `${base}${categoryId}`,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n    const newsItems = $('.news_list').find('li');\r\n\r\n    return newsItems.toArray().map((item) => {\r\n        const element = $(item);\r\n        const href = element.find('a').attr('href');\r\n        let title = element.find('a').attr('title');\r\n        if (!title) {\r\n            // If the title is not found, try to extract it from the link text\r\n            title = element.find('a').text().trim();\r\n        }\r\n\r\n        return {\r\n            title,\r\n            pubDate: parseDate(element.find('.news_meta').text()),\r\n            link: href ? new URL(href, base).href : undefined,\r\n        };\r\n    });\r\n}\r\n\r\n/**\r\n * Enriches a news item with detailed content by fetching its full page\r\n * @param item - The basic news item to enrich\r\n * @param refererUrl - The referer URL to use when fetching the item details\r\n * @returns Promise<DataItem> - The enriched news item with description, author, and full title\r\n */\r\nasync function enrichNewsItemWithDetails(item: DataItem, refererUrl: string): Promise<DataItem> {\r\n    // If the item doesn't have a link, return the item as-is\r\n    if (!item.link) {\r\n        return item;\r\n    }\r\n\r\n    return await cache.tryGet(item.link, async () => {\r\n        try {\r\n            // Some news items may link to pages that require ZJU private network access\r\n            // or university account authentication. We'll handle these gracefully.\r\n            const response = await got({\r\n                method: 'get',\r\n                url: item.link,\r\n                headers: {\r\n                    Referer: refererUrl,\r\n                },\r\n            });\r\n\r\n            const $ = load(response.data);\r\n\r\n            // Extract and set the full article content as description\r\n            const description = $('.wp_articlecontent').html();\r\n            if (description) {\r\n                item.description = description;\r\n            }\r\n\r\n            // Extract and clean the author information\r\n            let author = $('.arti_metas').find('.arti_publisher').text();\r\n            // Remove the '发布者：' (Publisher:) prefix and trim whitespace\r\n            author = author.replace('发布者：', '').trim();\r\n            if (author) {\r\n                item.author = author;\r\n            }\r\n\r\n            return item;\r\n        } catch {\r\n            // If there's an error accessing the page (network issues, authentication required, etc.),\r\n            // return the item with only the basic information we already have\r\n            return item;\r\n        }\r\n    });\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/sis/:type',\r\n    categories: ['university'],\r\n    example: '/zju/sis/0',\r\n    parameters: { type: '分类，见下表' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '外国语学院',\r\n    description: `| 重要公告 | 最新通知 | 教育教学 | 科学研究 | 新闻动态 | 联系我们 | 党政管理 | 组织人事 | 科学研究 | 本科教育 | 研究生教育 | 学生思政 | 校友联络 | 对外交流 |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| 0        | 1        | 2        | 3        | 4        | 5        | 6        | 7            | 8            | 9       | 10       | 11       | 12       | 13       |\r\n`,\r\n    maintainers: ['Alex222222222222'],\r\n    handler: handleSisRequest,\r\n    url: 'www.sis.zju.edu.cn',\r\n};\r\n\r\n/**\r\n * Main handler function for processing SIS (School of International Studies) news requests\r\n * @param ctx - The request context containing route parameters\r\n * @returns Promise with RSS feed data including title, link, and news items\r\n */\r\nasync function handleSisRequest(ctx: { req: { param: (arg0: string) => string } }) {\r\n    const requestedType = Number.parseInt(ctx.req.param('type'));\r\n    const categoryInfo = categoryMap.get(requestedType);\r\n\r\n    // Validate the requested category type\r\n    if (!categoryInfo) {\r\n        const validTypes = [...categoryMap.keys()].join(', ');\r\n        throw new Error(`Invalid type: ${requestedType}. Valid types are: ${validTypes}`);\r\n    }\r\n\r\n    const categoryUrl = `${base}${categoryInfo.id}`;\r\n\r\n    // Fetch news items from all relevant categories\r\n    const allNewsItems = await fetchNewsItemsByCategory(categoryInfo.id);\r\n\r\n    // Enrich each news item with detailed content\r\n    const enrichedItems = await Promise.all(allNewsItems.map((item) => enrichNewsItemWithDetails(item, categoryUrl)));\r\n\r\n    return {\r\n        title: categoryInfo.title,\r\n        link: categoryUrl,\r\n        item: enrichedItems,\r\n    };\r\n}\r\n"],"mappings":"wWAMA,MAAM,EAAO,wCAMP,EAAc,IAAI,IAAI,CACxB,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,EAAG,CAAE,GAAI,iBAAkB,MAAO,mBACnC,CAAC,GAAI,CAAE,GAAI,iBAAkB,MAAO,oBACpC,CAAC,GAAI,CAAE,GAAI,iBAAkB,MAAO,mBACpC,CAAC,GAAI,CAAE,GAAI,gBAAiB,MAAO,mBACnC,CAAC,GAAI,CAAE,GAAI,iBAAkB,MAAO,qBAQxC,eAAe,EAAyB,EAAyC,CAC7E,IAAM,EAAW,MAAMA,EAAI,CACvB,OAAQ,MACR,IAAK,GAAG,IAAO,MAGb,EAAI,EAAK,EAAS,MAClB,EAAY,EAAE,cAAc,KAAK,MAEvC,OAAO,EAAU,UAAU,IAAK,GAAS,CACrC,IAAM,EAAU,EAAE,GACZ,EAAO,EAAQ,KAAK,KAAK,KAAK,QAChC,EAAQ,EAAQ,KAAK,KAAK,KAAK,SAMnC,OALK,IAED,EAAQ,EAAQ,KAAK,KAAK,OAAO,QAG9B,CACH,QACA,QAAS,EAAU,EAAQ,KAAK,cAAc,QAC9C,KAAM,EAAO,IAAI,IAAI,EAAM,GAAM,KAAO,IAAA,MAWpD,eAAe,EAA0B,EAAgB,EAAuC,CAM5F,OAJK,EAAK,KAIH,MAAMC,EAAM,OAAO,EAAK,KAAM,SAAY,CAC7C,GAAI,CAGA,IAAM,EAAW,MAAMD,EAAI,CACvB,OAAQ,MACR,IAAK,EAAK,KACV,QAAS,CACL,QAAS,KAIX,EAAI,EAAK,EAAS,MAGlB,EAAc,EAAE,sBAAsB,OACxC,IACA,EAAK,YAAc,GAIvB,IAAI,EAAS,EAAE,eAAe,KAAK,mBAAmB,OAOtD,MALA,GAAS,EAAO,QAAQ,OAAQ,IAAI,OAChC,IACA,EAAK,OAAS,GAGX,OACH,CAGJ,OAAO,KAnCJ,EAwCf,MAAaE,EAAe,CACxB,KAAM,aACN,WAAY,CAAC,cACb,QAAS,aACT,WAAY,CAAE,KAAM,UACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,QACN,YAAa;;;EAIb,YAAa,CAAC,oBACd,QAAS,EACT,IAAK,sBAQT,eAAe,EAAiB,EAAmD,CAC/E,IAAM,EAAgB,OAAO,SAAS,EAAI,IAAI,MAAM,SAC9C,EAAe,EAAY,IAAI,GAGrC,GAAI,CAAC,EAAc,CACf,IAAM,EAAa,CAAC,GAAG,EAAY,QAAQ,KAAK,MAChD,MAAU,MAAM,iBAAiB,EAAc,qBAAqB,KAGxE,IAAM,EAAc,GAAG,IAAO,EAAa,KAGrC,EAAe,MAAM,EAAyB,EAAa,IAG3D,EAAgB,MAAM,QAAQ,IAAI,EAAa,IAAK,GAAS,EAA0B,EAAM,KAEnG,MAAO,CACH,MAAO,EAAa,MACpB,KAAM,EACN,KAAM"}