{"version":3,"file":"utils-B7U_YfVd.js","names":["ofetch","cache","response","$"],"sources":["../../lib/routes/gxmzu/utils/index.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch'; // 使用ofetch库代替got\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nasync function getNoticeList(ctx, url, host, titleSelector, dateSelector, contentSelector) {\r\n    const response = await ofetch(url, { rejectUnauthorized: false }).catch(() => null);\r\n    if (!response) {\r\n        return [];\r\n    }\r\n    const $ = load(response);\r\n\r\n    const list = $(`tr[height=20]`)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.find(titleSelector).attr('title'),\r\n                link: new URL(item.find(titleSelector).attr('href'), host).href,\r\n                pubDate: timezone(parseDate(item.find(dateSelector).text().trim(), 'YYYY-MM-DD'), +8),\r\n            };\r\n        });\r\n\r\n    const out = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                if (item.link.includes('.jsp')) {\r\n                    // 特殊处理.jsp文件，直接显示消息而不尝试爬取\r\n                    return {\r\n                        ...item,\r\n                        description: '该通知无法直接预览，请点击原文链接↑查看',\r\n                    };\r\n                }\r\n                const response = await ofetch(item.link, { rejectUnauthorized: false }).catch(() => null);\r\n                if (!response || (response.status >= 300 && response.status < 400)) {\r\n                    item.description = '该通知无法直接预览，请点击原文链接↑查看';\r\n                } else {\r\n                    const $ = load(response);\r\n\r\n                    item.title = $(contentSelector.title).text();\r\n                    const hasEmbeddedPDFScript = $('script:contains(\"showVsbpdfIframe\")').length > 0;\r\n\r\n                    if (hasEmbeddedPDFScript) {\r\n                        item.description = '该通知无法直接预览，请点击原文链接↑查看';\r\n                    } else {\r\n                        const $content = load($(contentSelector.content).html());\r\n                        $content('a').each(function () {\r\n                            const a = $(this);\r\n                            const href = a.attr('href');\r\n                            if (href && !href.startsWith('http')) {\r\n                                a.attr('href', new URL(href, host).href);\r\n                            }\r\n                        });\r\n                        item.description = $content.html();\r\n                    }\r\n                    const preDate = $(contentSelector.date).text().replaceAll(/年|月/g, '-').replaceAll('日', '');\r\n                    item.pubDate = timezone(parseDate(preDate), +8);\r\n                }\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return out;\r\n}\r\n\r\nexport { getNoticeList };\r\n"],"mappings":"gPAMA,eAAe,EAAc,EAAK,EAAK,EAAM,EAAe,EAAc,EAAiB,CACvF,IAAM,EAAW,MAAMA,EAAO,EAAK,CAAE,mBAAoB,KAAS,UAAY,MAC9E,GAAI,CAAC,EACD,MAAO,GAEX,IAAM,EAAI,EAAK,GAET,EAAO,EAAE,iBACV,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,KAAK,GAAe,KAAK,SACrC,KAAM,IAAI,IAAI,EAAK,KAAK,GAAe,KAAK,QAAS,GAAM,KAC3D,QAAS,EAAS,EAAU,EAAK,KAAK,GAAc,OAAO,OAAQ,cAAe,MAIxF,EAAM,MAAM,QAAQ,IACtB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,EAAK,KAAK,SAAS,QAEnB,MAAO,CACH,GAAG,EACH,YAAa,wBAGrB,IAAMC,EAAW,MAAMF,EAAO,EAAK,KAAM,CAAE,mBAAoB,KAAS,UAAY,MACpF,GAAI,CAACE,GAAaA,EAAS,QAAU,KAAOA,EAAS,OAAS,IAC1D,EAAK,YAAc,2BAChB,CACH,IAAMC,EAAI,EAAKD,GAEf,EAAK,MAAQC,EAAE,EAAgB,OAAO,OACtC,IAAM,EAAuBA,EAAE,uCAAuC,OAAS,EAE/E,GAAI,EACA,EAAK,YAAc,2BAChB,CACH,IAAM,EAAW,EAAKA,EAAE,EAAgB,SAAS,QACjD,EAAS,KAAK,KAAK,UAAY,CAC3B,IAAM,EAAIA,EAAE,MACN,EAAO,EAAE,KAAK,QAChB,GAAQ,CAAC,EAAK,WAAW,SACzB,EAAE,KAAK,OAAQ,IAAI,IAAI,EAAM,GAAM,QAG3C,EAAK,YAAc,EAAS,OAEhC,IAAM,EAAUA,EAAE,EAAgB,MAAM,OAAO,WAAW,OAAQ,KAAK,WAAW,IAAK,IACvF,EAAK,QAAU,EAAS,EAAU,GAAU,GAEhD,OAAO,MAKnB,OAAO"}