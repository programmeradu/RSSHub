{"version":3,"file":"thread-DLWLjxY7.js","names":["route: Route","ofetch","cache","item: DataItem"],"sources":["../../lib/routes/deepin/thread.ts"],"sourcesContent":["import { Route, DataItem } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/threads/:type?',\r\n    categories: ['bbs'],\r\n    example: '/deepin/threads/latest',\r\n    parameters: {\r\n        type: {\r\n            description: '主题类型',\r\n            options: [\r\n                {\r\n                    value: 'hot',\r\n                    label: '最热主题',\r\n                },\r\n                {\r\n                    value: 'latest',\r\n                    label: '最新主题',\r\n                },\r\n            ],\r\n        },\r\n    },\r\n    name: '首页主题列表',\r\n    maintainers: ['myml'],\r\n    radar: [\r\n        {\r\n            source: ['bbs.deepin.org'],\r\n            target: '/threads/latest',\r\n        },\r\n    ],\r\n    handler,\r\n};\r\n\r\ninterface ThreadIndexResult {\r\n    ThreadIndex: {\r\n        id: number;\r\n        subject: string;\r\n        created_at: string;\r\n        user: { nickname: string };\r\n        forum: { name: string };\r\n    }[];\r\n}\r\ninterface ThreadInfoResult {\r\n    data: {\r\n        id: number;\r\n        subject: string;\r\n        created_at: string;\r\n        user: { nickname: string };\r\n        post: { message: string };\r\n    };\r\n}\r\n\r\nconst TypeMap = {\r\n    hot: { where: 'hot_value', title: '最热主题' },\r\n    latest: { where: 'id', title: '最新主题' },\r\n};\r\n\r\nasync function handler(ctx) {\r\n    let type = TypeMap.latest;\r\n    if (ctx.req.param('type') === 'hot') {\r\n        type = TypeMap.hot;\r\n    }\r\n    const res = await ofetch<ThreadIndexResult>('https://bbs.deepin.org.cn/api/v1/thread/index', {\r\n        query: {\r\n            languages: 'zh_CN',\r\n            order: 'updated_at',\r\n            where: type.where,\r\n        },\r\n        headers: {\r\n            accept: 'application/json',\r\n        },\r\n    });\r\n    const items = await Promise.all(\r\n        res.ThreadIndex.map((thread) => {\r\n            const link = 'https://bbs.deepin.org.cn/post/' + thread.id;\r\n            return cache.tryGet(link, async () => {\r\n                const item: DataItem = {\r\n                    id: String(thread.id),\r\n                    title: thread.subject,\r\n                    link,\r\n                    pubDate: parseDate(thread.created_at),\r\n                    author: thread.user.nickname,\r\n                    category: [thread.forum.name],\r\n                    description: '',\r\n                };\r\n                const cacheData = await ofetch<ThreadInfoResult>('https://bbs.deepin.org.cn/api/v1/thread/info?id=' + item.id);\r\n                if (cacheData) {\r\n                    const info = cacheData as ThreadInfoResult;\r\n                    item.description = info.data.post.message;\r\n                }\r\n                return item;\r\n            }) as Promise<DataItem>;\r\n        })\r\n    );\r\n    return {\r\n        title: 'deepin论坛主页 - ' + type.title,\r\n        link: 'https://bbs.deepin.org',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"oRAKA,MAAaA,EAAe,CACxB,KAAM,kBACN,WAAY,CAAC,OACb,QAAS,yBACT,WAAY,CACR,KAAM,CACF,YAAa,OACb,QAAS,CACL,CACI,MAAO,MACP,MAAO,QAEX,CACI,MAAO,SACP,MAAO,WAKvB,KAAM,SACN,YAAa,CAAC,QACd,MAAO,CACH,CACI,OAAQ,CAAC,kBACT,OAAQ,oBAGhB,WAsBE,EAAU,CACZ,IAAK,CAAE,MAAO,YAAa,MAAO,QAClC,OAAQ,CAAE,MAAO,KAAM,MAAO,SAGlC,eAAe,EAAQ,EAAK,CACxB,IAAI,EAAO,EAAQ,OACf,EAAI,IAAI,MAAM,UAAY,QAC1B,EAAO,EAAQ,KAEnB,IAAM,EAAM,MAAMC,EAA0B,gDAAiD,CACzF,MAAO,CACH,UAAW,QACX,MAAO,aACP,MAAO,EAAK,OAEhB,QAAS,CACL,OAAQ,sBAGV,EAAQ,MAAM,QAAQ,IACxB,EAAI,YAAY,IAAK,GAAW,CAC5B,IAAM,EAAO,kCAAoC,EAAO,GACxD,OAAOC,EAAM,OAAO,EAAM,SAAY,CAClC,IAAMC,EAAiB,CACnB,GAAI,OAAO,EAAO,IAClB,MAAO,EAAO,QACd,OACA,QAAS,EAAU,EAAO,YAC1B,OAAQ,EAAO,KAAK,SACpB,SAAU,CAAC,EAAO,MAAM,MACxB,YAAa,IAEX,EAAY,MAAMF,EAAyB,mDAAqD,EAAK,IAC3G,GAAI,EAAW,CACX,IAAM,EAAO,EACb,EAAK,YAAc,EAAK,KAAK,KAAK,QAEtC,OAAO,OAInB,MAAO,CACH,MAAO,gBAAkB,EAAK,MAC9B,KAAM,yBACN,KAAM"}