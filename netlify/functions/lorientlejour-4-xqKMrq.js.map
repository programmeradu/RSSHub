{"version":3,"file":"lorientlejour-4-xqKMrq.js","names":[],"sources":["../../lib/routes/lorientlejour/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { FetchError } from 'ofetch';\r\nimport { load } from 'cheerio';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst key = '3d5_f6A(S$G_FD=2S(Dr6%7BW_h37@rE';\r\n\r\nexport const route: Route = {\r\n    path: '/:category?',\r\n    categories: ['traditional-media'],\r\n    example: '/lorientlejour/977-lebanon',\r\n    parameters: {\r\n        category: 'Category from the last segment of the URL of the corresponding site, see below for more information, /977-Lebanon by default',\r\n    },\r\n    features: {\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n        requireConfig: [\r\n            {\r\n                name: 'LORIENTLEJOUR_USERNAME',\r\n                optional: true,\r\n                description: `L'Orient-Le Jour/L'Orient Today Email or Username`,\r\n            },\r\n            {\r\n                name: 'LORIENTLEJOUR_PASSWORD',\r\n                optional: true,\r\n                description: `L'Orient-Le Jour/L'Orient Today Password`,\r\n            },\r\n            {\r\n                name: 'LORIENTLEJOUR_TOKEN',\r\n                optional: true,\r\n                description: `To obtain a token, log into L'Orient-Le Jour/L'Orient Today App and inspect the connection request to find the token parameter from the request URL`,\r\n            },\r\n        ],\r\n    },\r\n    name: 'Category',\r\n    maintainers: ['quiniapiezoelectricity'],\r\n    handler,\r\n    description: `  ::: tip\r\nFor example, the path for the sites https://today.lorientlejour.com/section/977-lebanon and https://www.lorientlejour.com/rubrique/1-liban would be /lorientlejour/977-lebanon and /lorientlejour/1-liban respectively.\r\nMultiple categories seperated by '|' is also supported, e.g. /lorientlejour/977-lebanon|1-liban.\r\n:::`,\r\n    radar: [\r\n        {\r\n            source: ['www.lorientlejour.com/*/:category'],\r\n            target: '/:category',\r\n        },\r\n        {\r\n            source: ['www.lorientlejour.com'],\r\n            target: '/1-Liban',\r\n        },\r\n        {\r\n            source: ['today.lorientlejour.com/*/:category'],\r\n            target: '/:category',\r\n        },\r\n        {\r\n            source: ['today.lorientlejour.com'],\r\n            target: '/977-Lebanon',\r\n        },\r\n    ],\r\n};\r\n\r\nasync function viewCategory(category: string) {\r\n    const url = `https://www.lorientlejour.com/cmsapi/categories.php?key=${key}&action=view&categoryId=${category}`;\r\n    const response = await cache.tryGet(\r\n        url,\r\n        async () =>\r\n            await got({\r\n                method: 'get',\r\n                url,\r\n            }),\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n    return response.data.data[0];\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const categoryId = (ctx.req.param('category') ?? '977-Lebanon').split('|').map((item) => item.match(/^(\\d+)/i)[0] ?? item);\r\n    const limit = ctx.req.query('limit') ?? 25;\r\n\r\n    let token;\r\n    const cacheIn = await cache.get('lorientlejour:token');\r\n    if (cacheIn) {\r\n        token = cacheIn;\r\n    } else if (config.lorientlejour.token) {\r\n        token = config.lorientlejour.token;\r\n        cache.set('lorientlejour:token', token);\r\n    } else if (config.lorientlejour.username && config.lorientlejour.password) {\r\n        const loginUrl = `https://www.lorientlejour.com/cmsapi/visitors.php?key=${key}&action=login&loginName=${config.lorientlejour.username}&password=${config.lorientlejour.password}`;\r\n        const loginResponse = await got(loginUrl);\r\n        token = loginResponse.data.data.token;\r\n        cache.set('lorientlejour:token', token);\r\n    }\r\n\r\n    if (token) {\r\n        try {\r\n            await got(`https://www.lorientlejour.com/cmsapi/visitors.php?key=${key}&action=login_token&token=${token}`);\r\n        } catch (error) {\r\n            if (error instanceof FetchError && error.statusCode === 403) {\r\n                await cache.set('lorientlejour:token', '');\r\n            }\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    let title = `L'Orient Le Jour/L'Orient Today`;\r\n    let description = '';\r\n    let link = 'https://www.lorientlejour.com';\r\n    let language = '';\r\n\r\n    if (categoryId.length === 1) {\r\n        const categoryInfo = await viewCategory(categoryId[0]);\r\n        if (categoryInfo.typeId.locale) {\r\n            language = categoryInfo.typeId.locale;\r\n        } else {\r\n            language = categoryInfo.typeId.name === 'English' ? 'en-US' : 'fr-FR';\r\n        }\r\n        title = language === 'en-US' ? `L'Orient Today - ${categoryInfo.name}` : `L'Orient Le Jour - ${categoryInfo.name}`;\r\n        description = categoryInfo.description;\r\n        link = categoryInfo.url;\r\n    }\r\n\r\n    const subcategories = await Promise.all(\r\n        categoryId.map(async (id) => {\r\n            // get all subcategories of the selected category\r\n            const contents = await viewCategory(id);\r\n            return contents.children.map((child) => child.id);\r\n        })\r\n    );\r\n    const categoriesParam = [...new Set([...categoryId, ...subcategories.flat()])];\r\n    // merge all subcategories with the selected categories to get all contents of the selected category and its subcategories\r\n\r\n    let url = `https://www.lorientlejour.com/cmsapi/content.php?text=clean&key=${key}&action=search&category=${encodeURIComponent(JSON.stringify(categoriesParam))}&limit=${limit}&text=false&page=1`;\r\n    if (token) {\r\n        url = url + `&token=${token}`;\r\n    }\r\n    const response = await got(url);\r\n    const items = response.data.data.map((item) => {\r\n        item.link = item.url;\r\n        item.author = item.authors.map((author) => author.name).join(', ');\r\n        item.pubDate = timezone(parseDate(item.firstPublished), +3);\r\n        item.updated = timezone(parseDate(item.lastUpdate), +3);\r\n        item.category = item.categories.map((itemCategory) => itemCategory.name);\r\n        const contents = item.contents;\r\n        const $ = load(contents);\r\n        const article = $('html');\r\n        article.find('.inline-embeded-article').remove();\r\n        article.find('.relatedArticles').remove();\r\n        if (item.inline_attachments) {\r\n            article.find('.inlineImage').each(function () {\r\n                const inlineImageSrc = $(this).attr('src');\r\n                const inlineAttachment = item.inline_attachments.find((inlineAttachment) => inlineAttachment.url === inlineImageSrc);\r\n                if (inlineAttachment && inlineAttachment.description) {\r\n                    $(this).wrap('<figure></figure>');\r\n                    $(this).after(`<figcaption>${inlineAttachment.description}</figcaption>`);\r\n                }\r\n            });\r\n        }\r\n        item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n            summary: item.summary,\r\n            attachments: item.attachments,\r\n            article: article.html(),\r\n        });\r\n        return item;\r\n    });\r\n\r\n    return {\r\n        title,\r\n        description,\r\n        language,\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}