import"./esm-shims-Dqvxr0BZ.js";import{config as e}from"./config-Dl8a1sIg.js";import{logger_default as t}from"./logger-CWOoofbD.js";import"./proxy-D7ccvALx.js";import"./dist-IvUHtNe1.js";import"./helpers-DzX-lcQO.js";import"./cache-kimkMTWJ.js";import"./render-CxhTJIsl.js";import"./md5-4BNsOP-F.js";import"./ofetch-Bzt0BXUH.js";import{got_default as n}from"./got-CdvI2yKX.js";import{config_not_found_default as r}from"./config-not-found-BVqhRP9D.js";import"./puppeteer-f0D6AISB.js";import{fallback as i,queryToBoolean as a}from"./readable-social-D7TWDGpz.js";import{utils_default as o}from"./utils-BY2D8TfT.js";import{cache_default as s}from"./cache-CIkWqAo6.js";import c from"json-bigint";import l from"node:querystring";const u={path:`/followings/dynamic/:uid/:routeParams?`,categories:[`social-media`],example:`/bilibili/followings/dynamic/109937383`,parameters:{uid:`用户 id, 可在 UP 主主页中找到`,routeParams:`
| 键         | 含义                              | 接受的值       | 默认值 |
| ---------- | --------------------------------- | -------------- | ------ |
| showEmoji  | 显示或隐藏表情图片                | 0/1/true/false | false  |
| embed      | 默认开启内嵌视频                  | 0/1/true/false |  true  |
| useAvid    | 视频链接使用 AV 号 (默认为 BV 号) | 0/1/true/false | false  |
| directLink | 使用内容直链                      | 0/1/true/false | false  |
| hideGoods  | 隐藏带货动态                      | 0/1/true/false | false  |

用例：\`/bilibili/followings/dynamic/2267573/showEmoji=1&embed=0&useAvid=1\``},features:{requireConfig:[{name:`BILIBILI_COOKIE_*`,description:"BILIBILI_COOKIE_{uid}: 用于用户关注动态系列路由，对应 uid 的 b 站用户登录后的 Cookie 值，`{uid}` 替换为 uid，如 `BILIBILI_COOKIE_2267573`，获取方式：\n    1.  打开 [https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8](https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8)\n    2.  打开控制台，切换到 Network 面板，刷新\n    3.  点击 dynamic_new 请求，找到 Cookie\n    4.  视频和专栏，UP 主粉丝及关注只要求 `SESSDATA` 字段，动态需复制整段 Cookie"}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`用户关注动态`,maintainers:[`TigerCubDen`,`JimenezLi`],handler:d,description:`::: warning
  用户动态需要 b 站登录后的 Cookie 值，所以只能自建，详情见部署页面的配置模块。
:::`};async function d(u){let d=String(u.req.param(`uid`)),f=l.parse(u.req.param(`routeParams`)),p=i(void 0,a(f.showEmoji),!1),m=i(void 0,a(f.embed),!0),h=i(void 0,a(f.displayArticle),!1),g=await s.getUsernameFromUID(d),_=e.bilibili.cookies[d];if(_===void 0)throw new r(`缺少对应 uid 的 Bilibili 用户登录后的 Cookie 值`);let v=await n({method:`get`,url:`https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=${d}&type_list=268435455`,headers:{Referer:`https://space.bilibili.com/${d}/`,Cookie:_}});if(v.data.code===-6)throw new r(`对应 uid 的 Bilibili 用户的 Cookie 已过期`);if(v.data.code===41e5)throw new r(`对应 uid 的 Bilibili 用户 请求失败`);let y=c.parse(v.body).data.cards,b=e=>e&&(e.title||e.description||e.content||e.vest&&e.vest.content)||``,x=e=>e.dynamic||e.desc||e.description||e.content||e.summary||(e.vest&&e.vest.content)+(e.sketch&&`<br>${e.sketch.title}<br>${e.sketch.desc_text}`)||e.intro||``,S=e=>e&&(e.apiSeasonInfo&&e.apiSeasonInfo.title&&`//转发自: ${e.apiSeasonInfo.title}`)+(e.index_title&&`<br>${e.index_title}`)||``,C=e=>e.uname||e.author&&e.author.name||e.upper&&e.upper.name||e.user&&(e.user.uname||e.user.name)||e.owner&&e.owner.name||``,w=e=>e.title?`${e.title}<br>`:``,T=e=>{if(!m)return``;let t=e?.aid,n=e?.bvid;return t===void 0&&n===void 0?``:o.renderUGCDescription(m,``,``,t,void 0,n)},E=e=>{let t=``;if(e.pictures)for(let n=0;n<e.pictures.length;n++)t+=`<img src="${e.pictures[n].img_src}">`;if(e.image_urls)for(let n=0;n<e.image_urls.length;n++)t+=`<img src="${e.image_urls[n]}">`;return e.pic&&(t+=`<img src="${e.pic}">`),e.cover&&e.cover.unclipped?t+=`<img src="${e.cover.unclipped}">`:e.cover&&(t+=`<img src="${e.cover}">`),e.sketch&&e.sketch.cover_url&&(t+=`<img src="${e.sketch.cover_url}">`),t},D=await Promise.all(y.map(async e=>{let n=c.parse(e.card),r=n.apiSeasonInfo||(b(n.item)?n.item:n),i=n.origin;if(i)try{i=c.parse(i)}catch{t.warn(`card.origin '${i}' is not falsy-valued or a JSON string, fall back to unparsed value`)}let a=``;a+=E(r),i&&(a+=E(i.item||i));let o=``;r.video_playurl&&(o+=`<video width="${r.width}" height="${r.height}" controls><source src="${unescape(r.video_playurl).replace(/^http:/,`https:`)}"><source src="${unescape(r.video_playurl)}"></video>`);let l=``;r.dynamic_id?l=`https://t.bilibili.com/${r.dynamic_id}`:e.desc?.dynamic_id&&(l=`https://t.bilibili.com/${e.desc.dynamic_id}`);let u=x(r);if(e.display&&e.display.emoji_info&&p){let t=e.display.emoji_info.emoji_details;for(let e of t)u=u.replaceAll(RegExp(`\\${e.text}`,`g`),`<img alt="${e.text}" src="${e.url}"style="margin: -1px 1px 0px; display: inline-block; width: 20px; height: 20px; vertical-align: text-bottom;" title="" referrerpolicy="no-referrer">`)}let f=``;return e.desc?.user_profile&&(f=e.desc.user_profile.info.uname),r.image_urls&&h&&(u=(await s.getArticleDataFromCvid(r.id,d)).description),{title:b(r),author:f,description:(()=>{let e=n.new_desc||u||x(r),t=i&&C(i)?`<br><br>//转发自: @${C(i)}: ${w(i.item||i)}${x(i.item||i)}`:S(i),s=a?`<br>${a}`:``,c=o?`<br>${o}`:``;return`${e}${t}${T(r)}${T(i)}${s}${c}`})(),pubDate:new Date(e.desc?.timestamp*1e3).toUTCString(),link:l}}));return{title:`${g} 关注的动态`,link:`https://t.bilibili.com`,description:`${g} 关注的动态`,item:D}}export{u as route};
//# sourceMappingURL=followings-dynamic-H_zxjol4.js.map