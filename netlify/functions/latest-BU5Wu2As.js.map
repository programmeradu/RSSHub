{"version":3,"file":"latest-BU5Wu2As.js","names":["ofetch","route: Route","got","cache"],"sources":["../../lib/routes/caixin/utils-fulltext.ts","../../lib/routes/caixin/latest.ts"],"sourcesContent":["import crypto from 'node:crypto';\r\nimport { hextob64, KJUR } from 'jsrsasign';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { config } from '@/config';\r\n\r\n// The following constant is extracted from this script: https://file.caixin.com/pkg/cx-pay-layer/js/wap.js?v=5.15.421933 . It is believed to contain no sensitive information.\r\n// Refer to this discussion for further explanation: https://github.com/DIYgod/RSSHub/pull/17231\r\nconst rsaPrivateKey =\r\n    '-----BEGIN PRIVATE KEY-----MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCLci8q2u3NGFyFlMUwjCP91PsvGjHdRAq9fmqZLxvue+n+RhzNxnKKYOv35pLgFKWXsGq2TV+5Xrv6xZgNx36IUkqbmrO+eCa8NFmti04wvMfG3DCNdKA7Lue880daNiK3BOhlQlZPykUXt1NftMNS/z+e70W+Vpv1ZxCx5BipqZkdoceM3uin0vUQmqmHqjxi5qKUuov90dXLaMxypCA0TDsIDnX8RPvPtqKff1p2TMW2a0XYe7CPYhRggaQMpmo0TcFutgrM1Vywyr2TPxYR+H/tpuuWRET7tUIQykBYoO1WKfL2dX6cxarjAJfnYnod3sMzppHouyp8Pt7gHVG7AgMBAAECggEAEFshSy6IrADKgWSUyH/3jMNZfwnchW6Ar/9O847CAPQJ2yhQIpa/Qpnhs58Y5S2myqcHrUBgFPcWp3BbyGn43naAh8XahWHEcVjWl/N6BV9vM1UKYN0oGikDR3dljCBDbCIoPBBO3WcFOaXoIpaqPmbwCG1aSdwQyPUA0UzG08eDbuHK6L5jvbe3xv5kLpWTVddrocW+SakbZRAX1Ykp7IujOce235nM7GOfoq4b8jmK5CLg6VIZGQV20wnn9YxuFOndRSjneFberzfzBMhVLpPsQ16M2xDLpZaDTggZnq2L6nZygds8Hda++ga3WbD3TcgjJNYuENu1S88IowYhSQKBgQDFqRA+38mo6KsxVDCNWcuEk2hSq8NEUzRHJpS7/QjZmEIYpFzDXgSGwhZJ0WNsQtaxJeBbc7B/OOqh8TL1reLl5AdTimS1OLHWVf/MUsLVS7Y82hx/hpYWxZnRSq41oI3P8FO/53FiQMYo2wbwqF6uQjB1y8h58aqL3OYpTH/5xQKBgQC0mobALJ+bU4nCPzkVDZuD6RyNWPwS1aE3+925wDSN2rJ0iLIb4N5czWZmHb66VlAtfGbp2q+amsCV4r6UR19A/y8k9SFB0mdtxix6mjEfaGhVJm4B1mkvsn0OHMAanKkohUvCjROQc3sziyp2gqSEQ98G7//VMPx/3dhgyQpVfwKBgQCycsqu6N0n+D6t/0MCKiJaI7bYhCd7JN8aqVM4UN5PjG2Hz8PLwbK2cr0qkbaAA+vN7NMb3Vtn0FvMLnUCZqVlRTP0EQqQrYmoZuXUcpdhd8QkNgnqe/g+wND4qcKTucquA1uo8mtj9/Su5+bhGDC6hBk6D+uDZFHDiX/loyIavQKBgQCXF6AcLjjpDZ52b8Yloti0JtXIOuXILAlQeNoqiG5vLsOVUrcPM7VUFlLQo5no8kTpiOXgRyAaS9VKkAO4sW0zR0n9tUY5dvkokV6sw0rNZ9/BPQFTcDlXug99OvhMSzwJtlqHTNdNRg+QM6E2vF0+ejmf6DEz/mN/5e0cK5UFqQKBgCR2hVfbRtDz9Cm/P8chPqaWFkH5ulUxBpc704Igc6bVH5DrEoWo6akbeJixV2obAZO3sFyeJqBUqaCvqG17Xei6jn3Hc3WMz9nLrAJEI9BTCfwvuxCOyY0IxqAAYT28xYv42I4+ADT/PpCq2Dj5u43X0dapAjZBZDfVVis7q1Bw-----END PRIVATE KEY-----';\r\n\r\nexport async function getFulltext(url: string) {\r\n    if (!config.caixin.cookie) {\r\n        return;\r\n    }\r\n    if (!/(\\d+)\\.html/.test(url)) {\r\n        return;\r\n    }\r\n    const articleID = url.match(/(\\d+)\\.html/)[1];\r\n\r\n    const nonce = crypto.randomUUID().replaceAll('-', '').toUpperCase();\r\n\r\n    const userID = config.caixin.cookie\r\n        .split(';')\r\n        .find((e) => e.includes('SA_USER_UID'))\r\n        ?.split('=')[1]; //\r\n\r\n    const rawString = `id=${articleID}&uid=${userID}&${nonce}=nonce`;\r\n\r\n    const sig = new KJUR.crypto.Signature({ alg: 'SHA256withRSA' });\r\n    sig.init(rsaPrivateKey);\r\n    sig.updateString(rawString);\r\n    const sigValueHex = hextob64(sig.sign());\r\n\r\n    const isWeekly = url.includes('weekly');\r\n    const res = await ofetch(`https://gateway.caixin.com/api/newauth/checkAuthByIdJsonp`, {\r\n        params: {\r\n            type: 1,\r\n            page: isWeekly ? 0 : 1,\r\n            rand: Math.random(),\r\n            id: articleID,\r\n        },\r\n        headers: {\r\n            'X-Sign': encodeURIComponent(sigValueHex),\r\n            'X-Nonce': encodeURIComponent(nonce),\r\n            Cookie: config.caixin.cookie,\r\n        },\r\n    });\r\n\r\n    const { content = '', pictureList } = JSON.parse(res.data.match(/resetContentInfo\\((.*)\\)/)[1]);\r\n    return content + (pictureList ? pictureList.map((e) => `<img src=\"${e.url}\" id=\"picture_${e.id}\" alt=\"${e.desc}\"><dl><dt>${e.desc}</dt></dl>`).join('') : '');\r\n}\r\n","import { Route, ViewType } from '@/types';\r\nimport { getFulltext } from './utils-fulltext';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseArticle } from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/latest',\r\n    categories: ['traditional-media'],\r\n    view: ViewType.Articles,\r\n    example: '/caixin/latest',\r\n    parameters: {},\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['caixin.com/'],\r\n        },\r\n    ],\r\n    name: '最新文章',\r\n    maintainers: ['tpnonthealps'],\r\n    handler,\r\n    url: 'caixin.com/',\r\n    description: `说明：此 RSS feed 会自动抓取财新网的最新文章，但不包含 FM 及视频内容。订阅用户可根据文档设置环境变量后，在url传入\\`fulltext=\\`以解锁全文。`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { data } = await got('https://gateway.caixin.com/api/dataplatform/scroll/index');\r\n\r\n    const list = data.data.articleList\r\n        .map((e) => ({\r\n            title: e.title,\r\n            link: e.url,\r\n            pubDate: e.time,\r\n            category: e.channelObject.name,\r\n        }))\r\n        .filter((item) => !item.link.startsWith('https://fm.caixin.com/') && !item.link.startsWith('https://video.caixin.com/') && !item.link.startsWith('https://datanews.caixin.com/')); // content filter\r\n\r\n    const rss = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(`caixin:latest:${item.link}`, async () => {\r\n                // desc\r\n                const desc = await parseArticle(item);\r\n\r\n                if (ctx.req.query('fulltext') === 'true') {\r\n                    const authorizedFullText = await getFulltext(item.link);\r\n                    item.description = authorizedFullText === '' ? desc.description : authorizedFullText;\r\n                } else {\r\n                    item.description = desc.description;\r\n                }\r\n                // prevent cache coliision with /caixin/article and /caixin/:column/:category\r\n                // since those have podcasts\r\n                item.guid = `caixin:latest:${item.link}`;\r\n\r\n                return { ...desc, ...item };\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: '财新网 - 最新文章',\r\n        link: 'https://www.caixin.com/',\r\n        item: rss,\r\n    };\r\n}\r\n"],"mappings":"ugBAUA,eAAsB,EAAY,EAAa,CAI3C,GAHI,CAAC,EAAO,OAAO,QAGf,CAAC,cAAc,KAAK,GACpB,OAEJ,IAAM,EAAY,EAAI,MAAM,eAAe,GAErC,EAAQ,EAAO,aAAa,WAAW,IAAK,IAAI,cAEhD,EAAS,EAAO,OAAO,OACxB,MAAM,KACN,KAAM,GAAM,EAAE,SAAS,iBACtB,MAAM,KAAK,GAEX,EAAY,MAAM,EAAU,OAAO,EAAO,GAAG,EAAM,QAEnD,EAAM,IAAI,EAAK,OAAO,UAAU,CAAE,IAAK,kBAC7C,EAAI,KAAK,gpDACT,EAAI,aAAa,GACjB,IAAM,EAAc,EAAS,EAAI,QAE3B,EAAW,EAAI,SAAS,UACxB,EAAM,MAAMA,EAAO,4DAA6D,CAClF,OAAQ,CACJ,KAAM,EACN,KAAM,EAAW,EAAI,EACrB,KAAM,KAAK,SACX,GAAI,GAER,QAAS,CACL,SAAU,mBAAmB,GAC7B,UAAW,mBAAmB,GAC9B,OAAQ,EAAO,OAAO,UAIxB,CAAE,UAAU,GAAI,eAAgB,KAAK,MAAM,EAAI,KAAK,MAAM,4BAA4B,IAC5F,OAAO,GAAW,EAAc,EAAY,IAAK,GAAM,aAAa,EAAE,IAAI,gBAAgB,EAAE,GAAG,SAAS,EAAE,KAAK,YAAY,EAAE,KAAK,aAAa,KAAK,IAAM,IC1C9J,MAAaC,EAAe,CACxB,KAAM,UACN,WAAY,CAAC,qBACb,KAAM,EAAS,SACf,QAAS,iBACT,WAAY,GACZ,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,iBAGjB,KAAM,OACN,YAAa,CAAC,gBACd,UACA,IAAK,cACL,YAAa,sFAGjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,QAAS,MAAMC,EAAI,4DAErB,EAAO,EAAK,KAAK,YAClB,IAAK,IAAO,CACT,MAAO,EAAE,MACT,KAAM,EAAE,IACR,QAAS,EAAE,KACX,SAAU,EAAE,cAAc,QAE7B,OAAQ,GAAS,CAAC,EAAK,KAAK,WAAW,2BAA6B,CAAC,EAAK,KAAK,WAAW,8BAAgC,CAAC,EAAK,KAAK,WAAW,iCAE/I,EAAM,MAAM,QAAQ,IACtB,EAAK,IAAK,GACNC,EAAM,OAAO,iBAAiB,EAAK,OAAQ,SAAY,CAEnD,IAAM,EAAO,MAAM,EAAa,GAEhC,GAAI,EAAI,IAAI,MAAM,cAAgB,OAAQ,CACtC,IAAM,EAAqB,MAAM,EAAY,EAAK,MAClD,EAAK,YAAc,IAAuB,GAAK,EAAK,YAAc,OAElE,EAAK,YAAc,EAAK,YAM5B,MAFA,GAAK,KAAO,iBAAiB,EAAK,OAE3B,CAAE,GAAG,EAAM,GAAG,OAKjC,MAAO,CACH,MAAO,aACP,KAAM,0BACN,KAAM"}