{"version":3,"file":"topic-BDrPKoOj.js","names":["route: Route","got","description","link","title","id","cache","response"],"sources":["../../lib/routes/douban/other/topic.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\n\r\nexport const route: Route = {\r\n    path: '/topic/:id/:sort?',\r\n    categories: ['social-media'],\r\n    example: '/douban/topic/48823',\r\n    parameters: { id: '话题id', sort: '排序方式，hot或new，默认为new' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '话题',\r\n    maintainers: ['LogicJake', 'pseudoyu', 'haowenwu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const sort = ctx.req.param('sort') || 'new';\r\n\r\n    const link = `https://www.douban.com/gallery/topic/${id}/?sort=${sort}`;\r\n\r\n    const api = `https://m.douban.com/rexxar/api/v2/gallery/topic/${id}/items?sort=${sort}&start=0&count=10&status_full_text=1`;\r\n    const response = await got({\r\n        method: 'GET',\r\n        url: api,\r\n        headers: {\r\n            Referer: link,\r\n        },\r\n    });\r\n\r\n    const data = response.data.items;\r\n\r\n    let title = id;\r\n    let description = '';\r\n\r\n    if (data[0].topic !== null) {\r\n        title = data[0].topic.name;\r\n        description = data[0].topic.introduction;\r\n    }\r\n\r\n    const out = await Promise.all(\r\n        data.map(async (item) => {\r\n            const type = item.target.type;\r\n            let author;\r\n            let date;\r\n            let description;\r\n            let link;\r\n            let title;\r\n            if (type === 'status') {\r\n                link = item.target.status.sharing_url.split('&')[0];\r\n                author = item.target.status.author.name;\r\n                title = author + '的广播';\r\n                date = item.target.status.create_time;\r\n                description = item.target.status.text;\r\n                const images = item.target.status.images;\r\n                if (images) {\r\n                    let i;\r\n                    for (i in images) {\r\n                        description += `<br><img src=\"${images[i].normal.url}\" />`;\r\n                    }\r\n                }\r\n            } else if (type === 'topic') {\r\n                link = item.target.sharing_url;\r\n                author = item.target.author.name;\r\n                title = item.target.title;\r\n                date = item.target.create_time;\r\n                description = item.target.abstract;\r\n                const images = item.target.photos;\r\n                if (images) {\r\n                    let i;\r\n                    for (i in images) {\r\n                        description += `<br><img src=\"${images[i].src}\" />`;\r\n                    }\r\n                }\r\n            } else {\r\n                link = item.target.sharing_url;\r\n                author = item.target.author.name;\r\n                title = author + '的日记';\r\n                date = item.target.create_time;\r\n\r\n                const id = item.target.id;\r\n                const itemUrl = `https://www.douban.com/j/note/${id}/full`;\r\n\r\n                const cacheIn = await cache.get(link);\r\n                if (cacheIn) {\r\n                    return JSON.parse(cacheIn);\r\n                }\r\n                const response = await got.get(itemUrl);\r\n                description = response.data.html;\r\n            }\r\n            const single = {\r\n                title,\r\n                link,\r\n                author,\r\n                pubDate: new Date(date).toUTCString(),\r\n                description,\r\n            };\r\n\r\n            if (type !== 'status') {\r\n                cache.set(link, JSON.stringify(single));\r\n            }\r\n            return single;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `${title}-豆瓣话题`,\r\n        description,\r\n        link,\r\n        item: out,\r\n    };\r\n}\r\n"],"mappings":"oRAIA,MAAaA,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,gBACb,QAAS,sBACT,WAAY,CAAE,GAAI,OAAQ,KAAM,uBAChC,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,YAAa,WAAY,YACvC,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAO,EAAI,IAAI,MAAM,SAAW,MAEhC,EAAO,wCAAwC,EAAG,SAAS,IAE3D,EAAM,oDAAoD,EAAG,cAAc,EAAK,sCAChF,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,EACL,QAAS,CACL,QAAS,KAIX,EAAO,EAAS,KAAK,MAEvB,EAAQ,EACR,EAAc,GAEd,EAAK,GAAG,QAAU,OAClB,EAAQ,EAAK,GAAG,MAAM,KACtB,EAAc,EAAK,GAAG,MAAM,cAGhC,IAAM,EAAM,MAAM,QAAQ,IACtB,EAAK,IAAI,KAAO,IAAS,CACrB,IAAM,EAAO,EAAK,OAAO,KACrB,EACA,EACAC,EACAC,EACAC,EACJ,GAAI,IAAS,SAAU,CACnB,EAAO,EAAK,OAAO,OAAO,YAAY,MAAM,KAAK,GACjD,EAAS,EAAK,OAAO,OAAO,OAAO,KACnC,EAAQ,EAAS,MACjB,EAAO,EAAK,OAAO,OAAO,YAC1B,EAAc,EAAK,OAAO,OAAO,KACjC,IAAM,EAAS,EAAK,OAAO,OAAO,OAClC,GAAI,EAAQ,CACR,IAAI,EACJ,IAAK,KAAK,EACN,GAAe,iBAAiB,EAAO,GAAG,OAAO,IAAI,eAGtD,IAAS,QAAS,CACzB,EAAO,EAAK,OAAO,YACnB,EAAS,EAAK,OAAO,OAAO,KAC5B,EAAQ,EAAK,OAAO,MACpB,EAAO,EAAK,OAAO,YACnB,EAAc,EAAK,OAAO,SAC1B,IAAM,EAAS,EAAK,OAAO,OAC3B,GAAI,EAAQ,CACR,IAAI,EACJ,IAAK,KAAK,EACN,GAAe,iBAAiB,EAAO,GAAG,IAAI,WAGnD,CACH,EAAO,EAAK,OAAO,YACnB,EAAS,EAAK,OAAO,OAAO,KAC5B,EAAQ,EAAS,MACjB,EAAO,EAAK,OAAO,YAEnB,IAAMC,EAAK,EAAK,OAAO,GACjB,EAAU,iCAAiCA,EAAG,OAE9C,EAAU,MAAMC,EAAM,IAAIH,GAChC,GAAI,EACA,OAAO,KAAK,MAAM,GAEtB,IAAMI,EAAW,MAAMN,EAAI,IAAI,GAC/B,EAAcM,EAAS,KAAK,KAEhC,IAAM,EAAS,CACX,MAAA,EACA,KAAA,EACA,SACA,QAAS,IAAI,KAAK,GAAM,cACxB,YAAA,GAMJ,OAHI,IAAS,UACT,EAAM,IAAIJ,EAAM,KAAK,UAAU,IAE5B,KAIf,MAAO,CACH,MAAO,GAAG,EAAM,OAChB,cACA,OACA,KAAM"}