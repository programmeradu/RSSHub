{"version":3,"file":"thread-BbQ2nijp.js","names":["route: Route","got"],"sources":["../../lib/routes/saraba1st/thread.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport queryString from 'query-string';\r\nimport { config } from '@/config';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nexport const route: Route = {\r\n    path: '/thread/:tid',\r\n    categories: ['bbs'],\r\n    example: '/saraba1st/thread/751272',\r\n    parameters: { tid: '帖子 id' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '帖子',\r\n    maintainers: ['zengxs'],\r\n    handler,\r\n    description: `帖子网址如果为 \\`https://stage1st.com/2b/thread-751272-1-1.html\\` 那么帖子 id 就是 \\`751272\\`。`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const tid = ctx.req.param('tid');\r\n    const cookieString = config.saraba1st.cookie ?? '';\r\n    const host = config.saraba1st.host;\r\n\r\n    const res = await got(`${host}/2b/forum.php`, {\r\n        searchParams: queryString.stringify({\r\n            mod: 'viewthread',\r\n            tid,\r\n            ordertype: 1,\r\n        }),\r\n        headers: {\r\n            Cookie: cookieString,\r\n        },\r\n    });\r\n\r\n    const $ = load(res.data);\r\n    const title = $('#thread_subject').text();\r\n\r\n    const list = $('#postlist > div[id^=post_]:not(:first-of-type)');\r\n    const count = [];\r\n\r\n    for (let i = 0; i < Math.min(list.length, 20); i++) {\r\n        count.push(i);\r\n    }\r\n\r\n    const staticUrl = new URL('/image/common/none.gif', host);\r\n    staticUrl.hostname = `static.${staticUrl.hostname.split('.').slice(-2).join('.')}`;\r\n    const resultItems = count.map((i) => {\r\n        const each = $(list[i]);\r\n        const floor = each.find('td.plc .pi a > em').text();\r\n        const floorUrl = each.find('td.plc .pi a').attr('href');\r\n        const contentHtml = $(each.find('td.t_f'));\r\n        const imgsHtml = contentHtml.find('img');\r\n        for (const element of imgsHtml) {\r\n            if (element.attribs.src === staticUrl.href) {\r\n                element.attribs.src = element.attribs.file;\r\n                const imgHtml = $(element);\r\n                imgHtml.removeAttr('zoomfile');\r\n                imgHtml.removeAttr('file');\r\n                imgHtml.removeAttr('onmouseover');\r\n                imgHtml.removeAttr('onclick');\r\n            }\r\n        }\r\n        contentHtml.find('div.aimg_tip').remove();\r\n        return {\r\n            title: `${title} #${floor}`,\r\n            link: new URL(floorUrl, `${host}/2b/`).href,\r\n            description: contentHtml.html(),\r\n            author: each.find('.authi .xw1').text(),\r\n            pubDate: timezone(parseDate(each.find('.authi em').text()), +8),\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `Stage1 论坛 - ${title}`,\r\n        link: `${host}/2b/thread-${tid}-1-1.html`,\r\n        item: resultItems,\r\n    };\r\n}\r\n"],"mappings":"mZAQA,MAAaA,EAAe,CACxB,KAAM,eACN,WAAY,CAAC,OACb,QAAS,2BACT,WAAY,CAAE,IAAK,SACnB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,UACd,UACA,YAAa,iFAGjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAM,EAAI,IAAI,MAAM,OACpB,EAAe,EAAO,UAAU,QAAU,GAC1C,EAAO,EAAO,UAAU,KAExB,EAAM,MAAMC,EAAI,GAAG,EAAK,eAAgB,CAC1C,aAAc,EAAY,UAAU,CAChC,IAAK,aACL,MACA,UAAW,IAEf,QAAS,CACL,OAAQ,KAIV,EAAI,EAAK,EAAI,MACb,EAAQ,EAAE,mBAAmB,OAE7B,EAAO,EAAE,kDACT,EAAQ,GAEd,IAAK,IAAI,EAAI,EAAG,EAAI,KAAK,IAAI,EAAK,OAAQ,IAAK,IAC3C,EAAM,KAAK,GAGf,IAAM,EAAY,IAAI,IAAI,yBAA0B,GACpD,EAAU,SAAW,UAAU,EAAU,SAAS,MAAM,KAAK,MAAM,IAAI,KAAK,OAC5E,IAAM,EAAc,EAAM,IAAK,GAAM,CACjC,IAAM,EAAO,EAAE,EAAK,IACd,EAAQ,EAAK,KAAK,qBAAqB,OACvC,EAAW,EAAK,KAAK,gBAAgB,KAAK,QAC1C,EAAc,EAAE,EAAK,KAAK,WAC1B,EAAW,EAAY,KAAK,OAClC,IAAK,IAAM,KAAW,EAClB,GAAI,EAAQ,QAAQ,MAAQ,EAAU,KAAM,CACxC,EAAQ,QAAQ,IAAM,EAAQ,QAAQ,KACtC,IAAM,EAAU,EAAE,GAClB,EAAQ,WAAW,YACnB,EAAQ,WAAW,QACnB,EAAQ,WAAW,eACnB,EAAQ,WAAW,WAI3B,OADA,EAAY,KAAK,gBAAgB,SAC1B,CACH,MAAO,GAAG,EAAM,IAAI,IACpB,KAAM,IAAI,IAAI,EAAU,GAAG,EAAK,OAAO,KACvC,YAAa,EAAY,OACzB,OAAQ,EAAK,KAAK,eAAe,OACjC,QAAS,EAAS,EAAU,EAAK,KAAK,aAAa,QAAS,MAIpE,MAAO,CACH,MAAO,eAAe,IACtB,KAAM,GAAG,EAAK,aAAa,EAAI,WAC/B,KAAM"}