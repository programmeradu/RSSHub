{"version":3,"file":"workshop-search-EQKGsxy_.js","names":[],"sources":["../../lib/routes/steam/workshop-search.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/workshopsearch/:appid?/:routeParams?',\r\n    categories: ['game'],\r\n    example: '/steam/workshopsearch/730',\r\n    parameters: {\r\n        appid: 'Steam appid, can be found on the community hub page or store page URL, 730 by default.',\r\n        routeParams: 'Route parameters, can be found on the search result page URL. Route parameters located after the appid.',\r\n    },\r\n    radar: [\r\n        {\r\n            title: 'Workshop Search Results',\r\n            source: ['steamcommunity.com/app/:appid/workshop/'],\r\n            target: '/workshopsearch/:appid',\r\n        },\r\n    ],\r\n    description: `Steam Community Workshop Search Results.\r\nThe parameter 'l=language' changes the language of search results(if possible).\r\nFor example, route \\`/workshopsearch/730/l=schinese\\` will display the simplified Chinese descriptions of the entry.\r\n\r\nLanguage Parameter:\r\n\r\n| English | 简体中文 | 繁體中文 | 日本語   | 한국어  | ภาษาไทย | български | čeština | dansk  | Deutsch | español | latam | ελληνικά | français | italiano | Bahasa Indonesia | magyar    | Nederlands | norsk     | polski | português  | brasileiro | română   | русский | suomi   | svenska | Türkçe  | Tiếng Việt | українська |\r\n| ------- | -------- | -------- | -------- | ------- | ------- | --------- | ------- | ------ | ------- | ------- | ----- | -------- | -------- | -------- | ---------------- | --------- | ---------- | --------- | ------ | ---------- | ---------- | -------- | ------- | ------- | ------- | ------- | ---------- | ---------- |\r\n| english | schinese | tchinese | japanese | koreana | thai    | bulgarian | czech   | danish | german  | spanish | latam | greek    | french   | italian  | indonesian       | hungarian | dutch      | norwegian | polish | portuguese | brazilian  | romanian | russian | finnish | swedish | turkish | vietnamese | ukrainian  |\r\n\r\n`,\r\n    name: 'Community Workshop Search',\r\n    maintainers: ['NyaaaDoge'],\r\n\r\n    handler: async (ctx) => {\r\n        const { appid = 730, routeParams } = ctx.req.param();\r\n\r\n        const url = `https://steamcommunity.com/workshop/browse/?appid=${appid}${routeParams ? `&${routeParams}` : ''}`;\r\n        const response = await ofetch(url);\r\n        const $ = load(response);\r\n\r\n        const appName = $('div.apphub_AppName').first().text();\r\n        const workshopDescription = $('div.customBrowseText').first().text();\r\n        const appIcon = $('div.apphub_AppIcon').children('img').attr('src');\r\n\r\n        const items = $('div.workshopBrowseItems .workshopItem')\r\n            .toArray()\r\n            .map((item) => {\r\n                item = $(item);\r\n                const publishedFileId = item.find('a').first().attr('data-publishedfileid');\r\n                const entryTitle = item.find('.workshopItemTitle').first().text();\r\n                const authorNickName = item.find('.workshop_author_link').first().text();\r\n                const previewImage = item.find('.workshopItemPreviewImage').first().attr('src');\r\n                const ratingImage = item.find('.fileRating').first().attr('src');\r\n                // Some items are flaged as 'accepted for game' and 'incompatible item'\r\n                const checkMarkImages: string[] = [];\r\n                $(item)\r\n                    .find('.workshop_checkmark')\r\n                    .each((index, element) => {\r\n                        const checkMarkElement = $(element);\r\n                        const style = checkMarkElement.attr('style');\r\n                        // Only add checkmark image if it is not set to 'display: none'\r\n                        if (!style || !style.includes('display: none;')) {\r\n                            checkMarkImages.push(checkMarkElement.attr('src') || '');\r\n                        }\r\n                    });\r\n                // const script_tag = item.next('script');\r\n                // console.log(`script_tag:${script_tag.text()}`);\r\n                const hoverContent = item.next('script').text();\r\n                const regex = /SharedFileBindMouseHover\\(\\s*\"sharedfile_\\d+\",\\s*(?:true|false),\\s*({.*?})\\s*\\);/;\r\n                const match = hoverContent.match(regex);\r\n\r\n                let entryDescription = '';\r\n\r\n                if (match) {\r\n                    const jsonString = match[1];\r\n                    // console.log(jsonString);\r\n                    const data = JSON.parse(jsonString);\r\n                    if (data.id === publishedFileId) {\r\n                        entryDescription = data.description;\r\n                    }\r\n                }\r\n\r\n                return {\r\n                    title: entryTitle,\r\n                    link: `https://steamcommunity.com/sharedfiles/filedetails/?id=${publishedFileId}`,\r\n                    description: art(path.join(__dirname, 'templates/workshop-search-description.art'), {\r\n                        image: previewImage,\r\n                        rating: ratingImage,\r\n                        checkmark: checkMarkImages,\r\n                        description: entryDescription,\r\n                    }),\r\n                    author: authorNickName,\r\n                };\r\n            });\r\n\r\n        return {\r\n            title: `${appName} Steam Workshop Content`,\r\n            link: `https://steamcommunity.com/workshop/browse/?appid=${appid}${routeParams ? `&${routeParams}` : ''}`,\r\n            item: items,\r\n            icon: appIcon,\r\n            description: workshopDescription,\r\n        };\r\n    },\r\n};\r\n"],"mappings":"0TAOA,MAAa,EAAe,CACxB,KAAM,wCACN,WAAY,CAAC,QACb,QAAS,4BACT,WAAY,CACR,MAAO,yFACP,YAAa,2GAEjB,MAAO,CACH,CACI,MAAO,0BACP,OAAQ,CAAC,2CACT,OAAQ,2BAGhB,YAAa;;;;;;;;;;EAWb,KAAM,4BACN,YAAa,CAAC,aAEd,QAAS,KAAO,IAAQ,CACpB,GAAM,CAAE,QAAQ,IAAK,eAAgB,EAAI,IAAI,QAEvC,EAAM,qDAAqD,IAAQ,EAAc,IAAI,IAAgB,KACrG,EAAW,MAAM,EAAO,GACxB,EAAI,EAAK,GAET,EAAU,EAAE,sBAAsB,QAAQ,OAC1C,EAAsB,EAAE,wBAAwB,QAAQ,OACxD,EAAU,EAAE,sBAAsB,SAAS,OAAO,KAAK,OAEvD,EAAQ,EAAE,yCACX,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GACT,IAAM,EAAkB,EAAK,KAAK,KAAK,QAAQ,KAAK,wBAC9C,EAAa,EAAK,KAAK,sBAAsB,QAAQ,OACrD,EAAiB,EAAK,KAAK,yBAAyB,QAAQ,OAC5D,EAAe,EAAK,KAAK,6BAA6B,QAAQ,KAAK,OACnE,EAAc,EAAK,KAAK,eAAe,QAAQ,KAAK,OAEpD,EAA4B,GAClC,EAAE,GACG,KAAK,uBACL,MAAM,EAAO,IAAY,CACtB,IAAM,EAAmB,EAAE,GACrB,EAAQ,EAAiB,KAAK,UAEhC,CAAC,GAAS,CAAC,EAAM,SAAS,oBAC1B,EAAgB,KAAK,EAAiB,KAAK,QAAU,MAKjE,IAAM,EAAe,EAAK,KAAK,UAAU,OACnC,EAAQ,mFACR,EAAQ,EAAa,MAAM,GAE7B,EAAmB,GAEvB,GAAI,EAAO,CACP,IAAM,EAAa,EAAM,GAEnB,EAAO,KAAK,MAAM,GACpB,EAAK,KAAO,IACZ,EAAmB,EAAK,aAIhC,MAAO,CACH,MAAO,EACP,KAAM,0DAA0D,IAChE,YAAa,EAAI,EAAA,KAAA,EAAA,sDAAmE,CAChF,MAAO,EACP,OAAQ,EACR,UAAW,EACX,YAAa,IAEjB,OAAQ,KAIpB,MAAO,CACH,MAAO,GAAG,EAAQ,yBAClB,KAAM,qDAAqD,IAAQ,EAAc,IAAI,IAAgB,KACrG,KAAM,EACN,KAAM,EACN,YAAa"}