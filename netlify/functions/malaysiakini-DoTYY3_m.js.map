{"version":3,"file":"malaysiakini-DoTYY3_m.js","names":["route: Route","cache","got","parser"],"sources":["../../lib/routes/malaysiakini/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport parser from '@/utils/rss-parser';\r\nimport { config } from '@/config';\r\nimport { FetchError } from 'ofetch';\r\n\r\nexport const route: Route = {\r\n    path: '/:lang/:category?',\r\n    categories: ['new-media'],\r\n    example: '/malaysiakini/en',\r\n    parameters: {\r\n        lang: 'Language, see below',\r\n        category: 'Category, see below, news by default',\r\n    },\r\n    features: {\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n        requireConfig: [\r\n            {\r\n                name: 'MALAYSIAKINI_EMAIL',\r\n                optional: true,\r\n                description: 'Malaysiakini Email or Username',\r\n            },\r\n            {\r\n                name: 'MALAYSIAKINI_PASSWORD',\r\n                optional: true,\r\n                description: 'Malaysiakini Password',\r\n            },\r\n            {\r\n                name: 'MALAYSIAKINI_REFRESHTOKEN',\r\n                optional: true,\r\n                description: 'To obtain the refresh token, log into Malaysiakini and look for the cookie `nl____refreshToken` within document.cookie in the browser console. The token is the value of the cookie.',\r\n            },\r\n        ],\r\n    },\r\n    name: 'News',\r\n    maintainers: ['quiniapiezoelectricity'],\r\n    handler,\r\n    description: `\r\n| Language | English | Bahasa Malaysia | 华文     |\r\n| -------- | ------ | ------- | ------ | \r\n| \\`:lang\\`  | \\`en\\`    | \\`my\\`   | \\`zh\\`    |\r\n\r\n| Category               | \\`:category\\` |\r\n| ---------------------- | ------------- |\r\n| News                   | \\`news\\`      |\r\n| Columns                | \\`columns\\`   |\r\n| From Our Readers       | \\`letters\\`   |`,\r\n    radar: [\r\n        {\r\n            source: ['malaysiakini.com/'],\r\n            target: '/en',\r\n        },\r\n        {\r\n            source: ['malaysiakini.com/:lang'],\r\n            target: '/:lang',\r\n        },\r\n        {\r\n            source: ['www.malaysiakini.com/:lang/latest/:category'],\r\n            target: '/:lang/:category',\r\n        },\r\n    ],\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const lang = ctx.req.param('lang');\r\n    const category = ctx.req.param('category') ?? 'news';\r\n    const apiKey = 'UFXL7F1EL53S8DZ5SGJUMG5IIFVRY4WI'; // Assuming the apiKey is static\r\n\r\n    const key = {\r\n        email: config.malaysiakini.email,\r\n        password: config.malaysiakini.password,\r\n        apiKey,\r\n    };\r\n    const body = JSON.stringify(key);\r\n\r\n    let cookie;\r\n\r\n    const cacheIn = await cache.get('malaysiakini:cookie');\r\n    if (cacheIn) {\r\n        cookie = cacheIn;\r\n    }\r\n\r\n    if (cookie === undefined && config.malaysiakini.email && config.malaysiakini.password) {\r\n        const login = await got.post('https://membership.malaysiakini.com/api/v1/auth/local', {\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                Accept: '*/*',\r\n                Connection: 'keep-alive',\r\n            },\r\n            body,\r\n        });\r\n        if (login.data.accessToken && login.data.refreshToken) {\r\n            cookie = `nl____accessToken=${login.data.accessToken}; nl____refreshToken=${login.data.refreshToken};`;\r\n            // Refresh token should be sufficient for authenticating for full text, but access token is included for good measure.\r\n            cache.set('malaysiakini:cookie', cookie);\r\n        }\r\n    }\r\n\r\n    if (cookie === undefined && config.malaysiakini.refreshToken) {\r\n        cookie = `nl____refreshToken=${config.malaysiakini.refreshToken};`;\r\n        cache.set('malaysiakini:cookie', cookie);\r\n    }\r\n\r\n    const link = `https://www.malaysiakini.com/rss/${lang}/${category}.rss`;\r\n    const feed = await parser.parseURL(link);\r\n\r\n    if (cookie) {\r\n        // Testing the cookie with the first item of the feed\r\n        try {\r\n            await got({\r\n                method: 'get',\r\n                url: `https://www.malaysiakini.com/api/full_content/${feed.items[0].guid}`,\r\n                headers: {\r\n                    Cookie: cookie,\r\n                },\r\n            });\r\n        } catch (error) {\r\n            if (error instanceof FetchError && error.statusCode === 401) {\r\n                await cache.set('malaysiakini:cookie', '');\r\n            }\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    const items = await Promise.all(\r\n        feed.items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await got(`https://www.malaysiakini.com/api/content/${item.guid}`);\r\n                if (response.data.stories.content) {\r\n                    item.description = response.data.stories.content;\r\n                } else {\r\n                    item.description = response.data.stories.teaser;\r\n                    if (cookie) {\r\n                        let fullResponse;\r\n                        try {\r\n                            fullResponse = await got({\r\n                                method: 'get',\r\n                                url: `https://www.malaysiakini.com/api/full_content/${item.guid}`,\r\n                                headers: {\r\n                                    Cookie: cookie,\r\n                                },\r\n                            });\r\n                        } finally {\r\n                            if (fullResponse) {\r\n                                item.description = fullResponse.data.content;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                if (response.data.stories.image_feat) {\r\n                    const cover = response.data.stories.image_feat;\r\n                    if (cover.length > 0) {\r\n                        item.description = `<img src=${cover[0]}>` + item.description;\r\n                    }\r\n                }\r\n                if (response.data.stories.author) {\r\n                    item.author = response.data.stories.author;\r\n                }\r\n                if (response.data.stories.tags) {\r\n                    item.category = response.data.stories.tags;\r\n                }\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: feed.title,\r\n        link: feed.link,\r\n        description: feed.description,\r\n        language: lang,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"uYAOA,MAAaA,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,aACb,QAAS,mBACT,WAAY,CACR,KAAM,sBACN,SAAU,wCAEd,SAAU,CACN,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,GACf,cAAe,CACX,CACI,KAAM,qBACN,SAAU,GACV,YAAa,kCAEjB,CACI,KAAM,wBACN,SAAU,GACV,YAAa,yBAEjB,CACI,KAAM,4BACN,SAAU,GACV,YAAa,0LAIzB,KAAM,OACN,YAAa,CAAC,0BACd,UACA,YAAa,kWAUb,MAAO,CACH,CACI,OAAQ,CAAC,qBACT,OAAQ,OAEZ,CACI,OAAQ,CAAC,0BACT,OAAQ,UAEZ,CACI,OAAQ,CAAC,+CACT,OAAQ,sBAKpB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,QACrB,EAAW,EAAI,IAAI,MAAM,aAAe,OAGxC,EAAM,CACR,MAAO,EAAO,aAAa,MAC3B,SAAU,EAAO,aAAa,SAC9B,2CAEE,EAAO,KAAK,UAAU,GAExB,EAEE,EAAU,MAAMC,EAAM,IAAI,uBAKhC,GAJI,IACA,EAAS,GAGT,IAAW,IAAA,IAAa,EAAO,aAAa,OAAS,EAAO,aAAa,SAAU,CACnF,IAAM,EAAQ,MAAMC,EAAI,KAAK,wDAAyD,CAClF,QAAS,CACL,eAAgB,mBAChB,OAAQ,MACR,WAAY,cAEhB,SAEA,EAAM,KAAK,aAAe,EAAM,KAAK,eACrC,EAAS,qBAAqB,EAAM,KAAK,YAAY,uBAAuB,EAAM,KAAK,aAAa,GAEpG,EAAM,IAAI,sBAAuB,IAIrC,IAAW,IAAA,IAAa,EAAO,aAAa,eAC5C,EAAS,sBAAsB,EAAO,aAAa,aAAa,GAChE,EAAM,IAAI,sBAAuB,IAGrC,IAAM,EAAO,oCAAoC,EAAK,GAAG,EAAS,MAC5D,EAAO,MAAMC,EAAO,SAAS,GAEnC,GAAI,EAEA,GAAI,CACA,MAAMD,EAAI,CACN,OAAQ,MACR,IAAK,iDAAiD,EAAK,MAAM,GAAG,OACpE,QAAS,CACL,OAAQ,WAGX,EAAO,CAIZ,MAHI,aAAiB,GAAc,EAAM,aAAe,KACpD,MAAMD,EAAM,IAAI,sBAAuB,IAErC,EAId,IAAM,EAAQ,MAAM,QAAQ,IACxB,EAAK,MAAM,IAAK,GACZA,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAMC,EAAI,4CAA4C,EAAK,QAC5E,GAAI,EAAS,KAAK,QAAQ,QACtB,EAAK,YAAc,EAAS,KAAK,QAAQ,gBAEzC,EAAK,YAAc,EAAS,KAAK,QAAQ,OACrC,EAAQ,CACR,IAAI,EACJ,GAAI,CACA,EAAe,MAAMA,EAAI,CACrB,OAAQ,MACR,IAAK,iDAAiD,EAAK,OAC3D,QAAS,CACL,OAAQ,YAGV,CACF,IACA,EAAK,YAAc,EAAa,KAAK,UAKrD,GAAI,EAAS,KAAK,QAAQ,WAAY,CAClC,IAAM,EAAQ,EAAS,KAAK,QAAQ,WAChC,EAAM,OAAS,IACf,EAAK,YAAc,YAAY,EAAM,GAAG,GAAK,EAAK,aAS1D,OANI,EAAS,KAAK,QAAQ,SACtB,EAAK,OAAS,EAAS,KAAK,QAAQ,QAEpC,EAAS,KAAK,QAAQ,OACtB,EAAK,SAAW,EAAS,KAAK,QAAQ,MAEnC,MAKnB,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,YAAa,EAAK,YAClB,SAAU,EACV,KAAM"}