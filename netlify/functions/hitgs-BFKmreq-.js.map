{"version":3,"file":"hitgs-BFKmreq-.js","names":[],"sources":["../../lib/routes/hit/hitgs.ts"],"sourcesContent":["import { type Data, type DataItem, type Route, ViewType } from '@/types';\r\n\r\nimport { art } from '@/utils/render';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nimport { type CheerioAPI, type Cheerio, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport { type Context } from 'hono';\r\nimport path from 'node:path';\r\n\r\nexport const handler = async (ctx: Context): Promise<Data> => {\r\n    const { id = 'tzgg' } = ctx.req.param();\r\n    const limit: number = Number.parseInt(ctx.req.query('limit') ?? '10', 10);\r\n\r\n    const baseUrl: string = 'https://hitgs.hit.edu.cn';\r\n    const targetUrl: string = new URL(`${id}/list.htm`, baseUrl).href;\r\n\r\n    const response = await ofetch(targetUrl);\r\n    const $: CheerioAPI = load(response);\r\n    const language = $('html').attr('lang') ?? 'zh';\r\n\r\n    let items: DataItem[] = [];\r\n\r\n    items = $('li.news, div.tbt17')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((el): Element => {\r\n            const $el: Cheerio<Element> = $(el);\r\n\r\n            const title: string = $el.find('div.news_title, span.div.news_title, div.bttb2').text();\r\n            const description: string | undefined = art(path.join(__dirname, 'templates/description.art'), {\r\n                intro: $el.find('div.news_text, div.jj5').text(),\r\n            });\r\n            const pubDateStr: string | undefined = $('span.news_meta').text() || ($('span.news_days').text() ? `${$('span.news_days').text()}-${$('span.news_year').text()}` : `${$('div.tm-3').text()}-${$('div.tm-1').text()}`);\r\n            const linkUrl: string | undefined = $el.find('div.news_title a').attr('href') ?? $el.find('div.bttb2 a').attr('href') ?? $el.find('a').attr('href');\r\n            const upDatedStr: string | undefined = pubDateStr;\r\n\r\n            const processedItem: DataItem = {\r\n                title,\r\n                description,\r\n                pubDate: parseDate(pubDateStr),\r\n                link: linkUrl ? new URL(linkUrl, baseUrl).href : undefined,\r\n                content: {\r\n                    html: description,\r\n                    text: description,\r\n                },\r\n                updated: parseDate(upDatedStr),\r\n                language,\r\n            };\r\n\r\n            return processedItem;\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) => {\r\n            if (!item.link) {\r\n                return item;\r\n            }\r\n\r\n            return cache.tryGet(item.link, async (): Promise<DataItem> => {\r\n                const detailResponse = await ofetch(item.link);\r\n                const $$: CheerioAPI = load(detailResponse);\r\n\r\n                const title: string = $$('h1.arti_title').text() + $$('h2.arti_title').text();\r\n                const description: string | undefined = art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: $$('div.wp_articlecontent').html(),\r\n                });\r\n                const pubDateStr: string | undefined = $$('span.arti_update').text().split(/：/).pop()?.trim();\r\n                const upDatedStr: string | undefined = pubDateStr;\r\n\r\n                let processedItem: DataItem = {\r\n                    title,\r\n                    description,\r\n                    pubDate: pubDateStr ? parseDate(pubDateStr) : item.pubDate,\r\n                    content: {\r\n                        html: description,\r\n                        text: description,\r\n                    },\r\n                    updated: upDatedStr ? parseDate(upDatedStr) : item.updated,\r\n                    language,\r\n                };\r\n\r\n                const $enclosureEl: Cheerio<Element> = $$('a[sudyfile-attr]')\r\n                    .filter((_, el) => {\r\n                        const $el: Cheerio<Element> = $$(el);\r\n\r\n                        return !$el.attr('href')?.endsWith('htm');\r\n                    })\r\n                    .first();\r\n\r\n                const enclosureUrl: string | undefined = $enclosureEl.attr('href');\r\n\r\n                if (enclosureUrl) {\r\n                    const enclosureType: string = `application/${enclosureUrl.split(/\\./).pop() || 'octet-stream'}`;\r\n                    const enclosureTitle: string | undefined = $enclosureEl.attr('sudyfile-attr')?.match(/'title':'(.*?)'/)?.[1];\r\n\r\n                    processedItem = {\r\n                        ...processedItem,\r\n                        enclosure_url: new URL(enclosureUrl, baseUrl).href,\r\n                        enclosure_type: enclosureType,\r\n                        enclosure_title: enclosureTitle || title,\r\n                    };\r\n                }\r\n\r\n                return {\r\n                    ...item,\r\n                    ...processedItem,\r\n                };\r\n            });\r\n        })\r\n    );\r\n\r\n    const title: string = $('title').text();\r\n    const author: string = $('p.copyright span').first().text().split(/©/).pop() ?? '';\r\n\r\n    return {\r\n        title: `${author ? `${author} - ` : ''}${title}`,\r\n        description: title,\r\n        link: targetUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: $('div.foot-logo img').attr('src'),\r\n        author,\r\n        language,\r\n        id: targetUrl,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/hitgs/:id?',\r\n    name: '研究生院',\r\n    url: 'hitgs.hit.edu.cn',\r\n    maintainers: ['hlmu', 'nczitzk'],\r\n    handler,\r\n    example: '/hit/hitgs/tzgg',\r\n    parameters: {\r\n        category: {\r\n            description: '分类，默认为 `tzgg`，即通知公告，可在对应分类页 URL 中找到',\r\n            options: [\r\n                {\r\n                    label: '通知公告',\r\n                    value: 'tzgg',\r\n                },\r\n                {\r\n                    label: '综合新闻',\r\n                    value: 'zhxw',\r\n                },\r\n                {\r\n                    label: '高水平课程与学术交流',\r\n                    value: 'gspkcyxsjl',\r\n                },\r\n                {\r\n                    label: '国家政策',\r\n                    value: 'gjzc',\r\n                },\r\n                {\r\n                    label: '规章制度',\r\n                    value: '17546',\r\n                },\r\n                {\r\n                    label: '办事流程',\r\n                    value: '17547',\r\n                },\r\n                {\r\n                    label: '常见问题',\r\n                    value: '17548',\r\n                },\r\n                {\r\n                    label: '常见下载',\r\n                    value: '17549',\r\n                },\r\n            ],\r\n        },\r\n    },\r\n    description: `:::tip\r\n订阅 [通知公告](https://hitgs.hit.edu.cn/tzgg/list.htm)，其源网址为 \\`https://hitgs.hit.edu.cn/tzgg/list.htm\\`，请参考该 URL 指定部分构成参数，此时路由为 [\\`/hit/hitgs/tzgg\\`](https://rsshub.app/hit/hitgs/tzgg)。\r\n:::\r\n\r\n<details>\r\n  <summary>更多栏目</summary>\r\n\r\n| 栏目 | ID |\r\n| - | - |\r\n| [通知公告](https://hitgs.hit.edu.cn/tzgg/list.htm) | [tzgg](https://rsshub.app/hit/hitgs/tzgg) |\r\n| [综合新闻](https://hitgs.hit.edu.cn/zhxw/list.htm) | [zhxw](https://rsshub.app/hit/hitgs/zhxw) |\r\n| [高水平课程与学术交流](https://hitgs.hit.edu.cn/gspkcyxsjl/list.htm) | [gspkcyxsjl](https://rsshub.app/hit/hitgs/gspkcyxsjl) |\r\n| [国家政策](https://hitgs.hit.edu.cn/gjzc/list.htm) | [gjzc](https://rsshub.app/hit/hitgs/gjzc) |\r\n| [规章制度](https://hitgs.hit.edu.cn/17546/list.htm) | [17546](https://rsshub.app/hit/hitgs/17546) |\r\n| [办事流程](https://hitgs.hit.edu.cn/17547/list.htm) | [17547](https://rsshub.app/hit/hitgs/17547) |\r\n| [常见问题](https://hitgs.hit.edu.cn/17548/list.htm) | [17548](https://rsshub.app/hit/hitgs/17548) |\r\n| [常见下载](https://hitgs.hit.edu.cn/17549/list.htm) | [17549](https://rsshub.app/hit/hitgs/17549) |\r\n\r\n</details>\r\n`,\r\n    categories: ['university'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['hitgs.hit.edu.cn', 'hitgs.hit.edu.cn/:id/list.htm'],\r\n            target: (params) => {\r\n                const id: string = params.id;\r\n\r\n                return `/hit/hitgs${id ? `/${id}` : ''}`;\r\n            },\r\n        },\r\n        {\r\n            title: '通知公告',\r\n            source: ['hitgs.hit.edu.cn/tzgg/list.htm'],\r\n            target: '/hitgs/tzgg',\r\n        },\r\n        {\r\n            title: '综合新闻',\r\n            source: ['hitgs.hit.edu.cn/zhxw/list.htm'],\r\n            target: '/hitgs/zhxw',\r\n        },\r\n        {\r\n            title: '高水平课程与学术交流',\r\n            source: ['hitgs.hit.edu.cn/gspkcyxsjl/list.htm'],\r\n            target: '/hitgs/gspkcyxsjl',\r\n        },\r\n        {\r\n            title: '国家政策',\r\n            source: ['hitgs.hit.edu.cn/gjzc/list.htm'],\r\n            target: '/hitgs/gjzc',\r\n        },\r\n        {\r\n            title: '规章制度',\r\n            source: ['hitgs.hit.edu.cn/17546/list.htm'],\r\n            target: '/hitgs/17546',\r\n        },\r\n        {\r\n            title: '办事流程',\r\n            source: ['hitgs.hit.edu.cn/17547/list.htm'],\r\n            target: '/hitgs/17547',\r\n        },\r\n        {\r\n            title: '常见问题',\r\n            source: ['hitgs.hit.edu.cn/17548/list.htm'],\r\n            target: '/hitgs/17548',\r\n        },\r\n        {\r\n            title: '常见下载',\r\n            source: ['hitgs.hit.edu.cn/17549/list.htm'],\r\n            target: '/hitgs/17549',\r\n        },\r\n    ],\r\n    view: ViewType.Articles,\r\n};\r\n"],"mappings":"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"}