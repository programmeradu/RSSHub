{"version":3,"file":"keylol-DU5eKglY.js","names":["route: Route","parser","got","cache","descriptionList: string[]"],"sources":["../../lib/routes/keylol/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate, parseRelativeDate } from '@/utils/parse-date';\r\nimport parser from '@/utils/rss-parser';\r\nimport queryString from 'query-string';\r\n\r\nconst threadIdRegex = /(\\d+)-\\d+-\\d+/;\r\nconst header = {\r\n    Cookie: config.keylol.cookie ?? undefined,\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:path',\r\n    name: '论坛',\r\n    parameters: { path: '路径，默认为热点聚焦' },\r\n    categories: ['game'],\r\n    example: '/keylol/f161-1',\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'KEYLOL_COOKIE',\r\n                optional: true,\r\n                description: `配置后可抓取具有阅读权限的帖子內容`,\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['keylol.com/:path'],\r\n            target: (params, url) => url.replaceAll('forum.php?', ''),\r\n        },\r\n    ],\r\n    maintainers: ['nczitzk', 'kennyfong19931'],\r\n    handler,\r\n    description: `::: tip\r\n  若订阅 [热点聚焦](https://keylol.com/f161-1)，网址为 \\`https://keylol.com/f161-1\\`。截取 \\`https://keylol.com/\\` 到末尾的部分 \\`f161-1\\` 作为参数，此时路由为 [\\`/keylol/f161-1\\`](https://rsshub.app/keylol/f161-1)。\r\n  若订阅子分类 [试玩免费 - 热点聚焦](https://keylol.com/forum.php?mod=forumdisplay&fid=161&filter=typeid&typeid=459)，网址为 \\`https://keylol.com/forum.php?mod=forumdisplay&fid=161&filter=typeid&typeid=459\\`。提取\\`fid\\`及\\`typeid\\` 作为参数，此时路由为 [\\`/keylol/fid=161&typeid=459\\`](https://rsshub.app/keylol/fid=161&typeid=459)。注意不要包括\\`filter\\`，会调用[全局的内容过滤](https://docs.rsshub.app/guide/parameters#filtering)。\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    let queryParams = {};\r\n    const path = ctx.req.param('path');\r\n    if (/^f\\d+-\\d+/.test(path)) {\r\n        queryParams.fid = path.match(/^f(\\d+)-\\d+/)[1];\r\n    } else {\r\n        queryParams = queryString.parse(path);\r\n    }\r\n    queryParams.mod = 'forumdisplay';\r\n    queryParams.orderby = 'dateline';\r\n    queryParams.filter = 'author';\r\n\r\n    // get real author name from official rss feed\r\n    let authorNameMap;\r\n    try {\r\n        const feed = await parser.parseURL(`https://keylol.com/forum.php?mod=rss&fid=${queryParams.fid}&auth=0`);\r\n        authorNameMap = feed.items.map((item) => ({\r\n            threadId: item.link.match(threadIdRegex)[1],\r\n            author: item.author,\r\n        }));\r\n    } catch {\r\n        authorNameMap = [];\r\n    }\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 30;\r\n\r\n    const rootUrl = 'https://keylol.com';\r\n    const currentUrl = queryString.stringifyUrl({ url: `${rootUrl}/forum.php`, query: queryParams });\r\n\r\n    const { data: response } = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n        headers: header,\r\n    });\r\n\r\n    const $ = load(response);\r\n\r\n    let items = $('tbody[id^=\"normalthread_\"]')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                title: item.find('a.xst').text(),\r\n                link: new URL(item.find(' a.xst').prop('href').split('&extra=')[0], rootUrl).href,\r\n                author: item.find('td.by-author cite').text(),\r\n                pubDate: parseRelativeDate(item.find('td.by-author em').text().replaceAll(' 发表', '')),\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const threadId = threadIdRegex.test(item.link) ? item.link.match(threadIdRegex)[1] : queryString.parseUrl(item.link).query.tid;\r\n                const { data: detailResponse } = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                    headers: header,\r\n                });\r\n\r\n                const content = load(detailResponse);\r\n\r\n                let descriptionList: string[] = [];\r\n                const indexDiv = content('div#threadindex');\r\n                if (indexDiv.length > 0) {\r\n                    // post with page\r\n                    const postId = content('div.t_fsz > script')\r\n                        .text()\r\n                        .match(/show_threadindex\\((\\d+),/)[1];\r\n                    descriptionList = await Promise.all(\r\n                        indexDiv.find('a').map((i, a) => {\r\n                            const pageTitle = $(a).text();\r\n                            const page = $(a).attr('page');\r\n                            return getPage(\r\n                                `${rootUrl}/forum.php?${queryString.stringify({\r\n                                    mod: 'viewthread',\r\n                                    tid: threadId,\r\n                                    viewpid: postId,\r\n                                    cp: page,\r\n                                })}`,\r\n                                pageTitle\r\n                            );\r\n                        })\r\n                    );\r\n                } else {\r\n                    // normal post\r\n                    descriptionList.push(getDescription(content));\r\n                }\r\n\r\n                item.description = descriptionList.join('<br/>');\r\n                const realAuthorName = authorNameMap.find((a) => a.threadId === threadId);\r\n                if (realAuthorName) {\r\n                    item.author = realAuthorName.author;\r\n                }\r\n                item.category = content('#keyloL_thread_tags a')\r\n                    .toArray()\r\n                    .map((c) => content(c).text());\r\n\r\n                const pubDateEm = content('img.authicn').first().next();\r\n                const pubDateText = pubDateEm.find('span').prop('title') ?? pubDateEm.text();\r\n                const pubDateMatches = pubDateText.match(/(\\d{4}(?:-\\d{1,2}){2} (?:\\d{2}:){2}\\d{2})/) ?? undefined;\r\n                if (pubDateMatches) {\r\n                    item.pubDate = timezone(parseDate(pubDateMatches[1], 'YYYY-M-D HH:mm:ss'), +8);\r\n                }\r\n\r\n                const updatedMatches =\r\n                    content('i.pstatus')\r\n                        .text()\r\n                        .match(/(\\d{4}(?:-\\d{1,2}){2} (?:\\d{2}:){2}\\d{2})/) ?? undefined;\r\n                if (updatedMatches) {\r\n                    item.updated = timezone(parseDate(updatedMatches[1], 'YYYY-M-D HH:mm:ss'), +8);\r\n                }\r\n\r\n                item.comments = content('div.subforum_right_title_left_down').text() ? Number.parseInt(content('div.subforum_right_title_left_down').text(), 10) : 0;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const icon = $('link[rel=\"apple-touch-icon\"]').prop('href');\r\n\r\n    return {\r\n        item: items,\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: 'zh-cn',\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"application-name\"]').prop('content'),\r\n        author: $('meta[name=\"author\"]').prop('content'),\r\n    };\r\n}\r\n\r\nfunction getDescription($) {\r\n    const descriptionEl = $('td.t_f');\r\n    descriptionEl.find('div.rnd_ai_pr').remove(); // remove ad image\r\n\r\n    // handle lazyload image\r\n    descriptionEl.find('img').each((_, img) => {\r\n        img = $(img);\r\n        if (img.attr('src')?.endsWith('none.gif') && img.attr('file')) {\r\n            img.attr('src', img.attr('file'));\r\n            img.removeAttr('file');\r\n            img.removeAttr('zoomfile');\r\n        }\r\n    });\r\n\r\n    return descriptionEl.length > 0 ? descriptionEl.html() : $('div.alert_info').html();\r\n}\r\n\r\nasync function getPage(url, pageTitle) {\r\n    const { data: detailResponse } = await got({\r\n        method: 'get',\r\n        url,\r\n        headers: header,\r\n    });\r\n\r\n    const $ = load(detailResponse, { xmlMode: true });\r\n    const content = $('root').text();\r\n    return '<h3>' + pageTitle + '</h3>' + getDescription(load(content));\r\n}\r\n"],"mappings":"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"}