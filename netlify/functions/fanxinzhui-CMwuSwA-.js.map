{"version":3,"file":"fanxinzhui-CMwuSwA-.js","names":[],"sources":["../../lib/routes/fanxinzhui/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/',\r\n    name: '最近更新',\r\n    url: 'fanxinzhui.com/lastest',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/fanxinzhui',\r\n    categories: ['multimedia'],\r\n\r\n    radar: [\r\n        {\r\n            source: ['fanxinzhui.com/lastest'],\r\n            target: '/',\r\n        },\r\n    ],\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 30;\r\n\r\n    const rootUrl = 'https://www.fanxinzhui.com';\r\n    const currentUrl = new URL('lastest', rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    let items = $('a.la')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const season = item.find('span.season').text();\r\n            const name = item.find('span.name').text();\r\n            const link = new URL(item.prop('href'), rootUrl).href;\r\n\r\n            return {\r\n                title: `${season} ${name}`,\r\n                link,\r\n                guid: `${link}#${season}`,\r\n                pubDate: timezone(parseDate(item.find('span.time').text()), +8),\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                item.author = undefined;\r\n                item.category = [];\r\n\r\n                content('div.info ul li').each((_, el) => {\r\n                    el = content(el);\r\n\r\n                    const key = el.find('span').text().split(/:/)[0];\r\n                    const value = el.contents().last().text().trim();\r\n\r\n                    if (key === '类型') {\r\n                        item.category = [...item.category, ...value.split(/\\//)];\r\n                    } else if (key === '首播日期') {\r\n                        return;\r\n                    } else {\r\n                        item.author = `${item.author ? `${item.author}/` : ''}${value}`;\r\n                        item.category = [...item.category, ...value.split(/\\//)].filter((c) => c !== '等');\r\n                    }\r\n                });\r\n\r\n                content('div.image').each((_, el) => {\r\n                    el = content(el);\r\n\r\n                    const image = el.find('img').prop('src');\r\n\r\n                    el.replaceWith(\r\n                        art(path.join(__dirname, 'templates/description.art'), {\r\n                            images: image\r\n                                ? [\r\n                                      {\r\n                                          src: image.replace(/@\\d+,\\d+\\.\\w+$/, ''),\r\n                                          alt: content('div.resource_title h2').text(),\r\n                                      },\r\n                                  ]\r\n                                : undefined,\r\n                        })\r\n                    );\r\n                });\r\n\r\n                content('a.password').each((_, el) => {\r\n                    el = content(el);\r\n\r\n                    el.replaceWith(el.text());\r\n                });\r\n\r\n                item.description = content('div.middle_box').html();\r\n                item.enclosure_url = content('p.way span a').prop('href');\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const title = $('title').text();\r\n    const image = new URL($('img.logo').prop('src'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: 'zh',\r\n        image,\r\n        author: title.split(/_/).pop(),\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"0gBASA,MAAa,EAAe,CACxB,KAAM,IACN,KAAM,OACN,IAAK,yBACL,YAAa,CAAC,WACd,UACA,QAAS,cACT,WAAY,CAAC,cAEb,MAAO,CACH,CACI,OAAQ,CAAC,0BACT,OAAQ,OAKpB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,6BACV,EAAa,IAAI,IAAI,UAAW,GAAS,KAEzC,CAAE,KAAM,GAAa,MAAM,EAAI,GAE/B,EAAI,EAAK,GAEX,EAAQ,EAAE,QACT,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAS,EAAK,KAAK,eAAe,OAClC,EAAO,EAAK,KAAK,aAAa,OAC9B,EAAO,IAAI,IAAI,EAAK,KAAK,QAAS,GAAS,KAEjD,MAAO,CACH,MAAO,GAAG,EAAO,GAAG,IACpB,OACA,KAAM,GAAG,EAAK,GAAG,IACjB,QAAS,EAAS,EAAU,EAAK,KAAK,aAAa,QAAS,MAIxE,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GAiDrB,MA/CA,GAAK,OAAS,IAAA,GACd,EAAK,SAAW,GAEhB,EAAQ,kBAAkB,MAAM,EAAG,IAAO,CACtC,EAAK,EAAQ,GAEb,IAAM,EAAM,EAAG,KAAK,QAAQ,OAAO,MAAM,KAAK,GACxC,EAAQ,EAAG,WAAW,OAAO,OAAO,OAE1C,GAAI,IAAQ,KACR,EAAK,SAAW,CAAC,GAAG,EAAK,SAAU,GAAG,EAAM,MAAM,eAC3C,IAAQ,OACf,YAEA,EAAK,OAAS,GAAG,EAAK,OAAS,GAAG,EAAK,OAAO,GAAK,KAAK,IACxD,EAAK,SAAW,CAAC,GAAG,EAAK,SAAU,GAAG,EAAM,MAAM,OAAO,OAAQ,GAAM,IAAM,OAIrF,EAAQ,aAAa,MAAM,EAAG,IAAO,CACjC,EAAK,EAAQ,GAEb,IAAM,EAAQ,EAAG,KAAK,OAAO,KAAK,OAElC,EAAG,YACC,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACnD,OAAQ,EACF,CACI,CACI,IAAK,EAAM,QAAQ,iBAAkB,IACrC,IAAK,EAAQ,yBAAyB,SAG9C,IAAA,QAKlB,EAAQ,cAAc,MAAM,EAAG,IAAO,CAClC,EAAK,EAAQ,GAEb,EAAG,YAAY,EAAG,UAGtB,EAAK,YAAc,EAAQ,kBAAkB,OAC7C,EAAK,cAAgB,EAAQ,gBAAgB,KAAK,QAE3C,MAKnB,IAAM,EAAQ,EAAE,SAAS,OACnB,EAAQ,IAAI,IAAI,EAAE,YAAY,KAAK,OAAQ,GAAS,KAE1D,MAAO,CACH,KAAM,EACN,QACA,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,KACV,QACA,OAAQ,EAAM,MAAM,KAAK,MACzB,WAAY"}