import"./esm-shims-Dqvxr0BZ.js";import{config as e}from"./config-Dl8a1sIg.js";import"./logger-CWOoofbD.js";import"./proxy-D7ccvALx.js";import"./dist-IvUHtNe1.js";import{parseDuration as t}from"./helpers-DzX-lcQO.js";import{cache_default as n}from"./cache-kimkMTWJ.js";import"./render-CxhTJIsl.js";import{parseDate as r}from"./parse-date-Bgabdhlb.js";import"./md5-4BNsOP-F.js";import"./ofetch-Bzt0BXUH.js";import{got_default as i}from"./got-CdvI2yKX.js";import{ViewType as a}from"./types-A5bA50Mg.js";import"./puppeteer-f0D6AISB.js";import{fallback as o,queryToBoolean as s}from"./readable-social-D7TWDGpz.js";import{getLiveUrl as c,getVideoUrl as l,utils_default as u}from"./utils-BY2D8TfT.js";import{cache_default as d}from"./cache-CIkWqAo6.js";import{captcha_default as f}from"./captcha-D9zPeElr.js";import p from"json-bigint";const m={path:`/user/dynamic/:uid/:routeParams?`,categories:[`social-media`],view:a.SocialMedia,example:`/bilibili/user/dynamic/2267573`,parameters:{uid:`用户 id, 可在 UP 主主页中找到`,routeParams:`
| 键         | 含义                              | 接受的值       | 默认值 |
| ---------- | --------------------------------- | -------------- | ------ |
| showEmoji  | 显示或隐藏表情图片                | 0/1/true/false | false  |
| embed      | 默认开启内嵌视频                  | 0/1/true/false |  true  |
| useAvid    | 视频链接使用 AV 号 (默认为 BV 号) | 0/1/true/false | false  |
| directLink | 使用内容直链                      | 0/1/true/false | false  |
| hideGoods  | 隐藏带货动态                      | 0/1/true/false | false  |
| offset     | 偏移状态                         | string         | ""  |

用例：\`/bilibili/user/dynamic/2267573/showEmoji=1&embed=0&useAvid=1\``},features:{requireConfig:[{name:`BILIBILI_COOKIE_*`,optional:!0,description:"如果没有此配置，那么必须开启 puppeteer 支持；BILIBILI_COOKIE_{uid}: 用于用户关注动态系列路由，对应 uid 的 b 站用户登录后的 Cookie 值，`{uid}` 替换为 uid，如 `BILIBILI_COOKIE_2267573`，获取方式：\n1.  打开 [https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8](https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8)\n2.  打开控制台，切换到 Network 面板，刷新\n3.  点击 dynamic_new 请求，找到 Cookie\n4.  视频和专栏，UP 主粉丝及关注只要求 `SESSDATA` 字段，动态需复制整段 Cookie"}],requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},radar:[{source:[`space.bilibili.com/:uid`],target:`/user/dynamic/:uid`}],name:`UP 主动态`,maintainers:[`DIYgod`,`zytomorrow`,`CaoMeiYouRen`,`JimenezLi`],handler:C},h=e=>{let t=e.module_dynamic?.major;if(!t)return``;if(t.none)return t.none.tips;if(t.courses)return`${t.courses?.title} - ${t.courses?.sub_title}`;if(t.live_rcmd?.content)return JSON.parse(t.live_rcmd.content)?.live_play_info?.title;let n=t.type.replace(`MAJOR_TYPE_`,``).toLowerCase();return t[n]?.title},g=e=>{let t=``;e.module_dynamic?.desc?.text&&(t+=e.module_dynamic.desc.text);let n=e.module_dynamic?.major;if(!n)return t;if(n?.common?.desc)return t+=t?`<br>//转发自: ${n.common.desc}`:n.common.desc,t;if(n?.live)return`${n.live?.desc_first}<br>${n.live?.desc_second}`;if(n.live_rcmd?.content){let e=JSON.parse(n.live_rcmd.content)?.live_play_info;return`${e?.area_name}·${e?.watched_show?.text_large}`}if(n?.opus)return n?.opus?.summary?.text;let r=n.type.replace(`MAJOR_TYPE_`,``).toLowerCase();return n[r]?.desc},_=e=>e&&h(e),v=e=>e&&g(e),y=e=>e?.module_author?.name,b=(e,t=!0)=>{if(!t)return``;let n=e?.module_dynamic?.major?.archive?.aid,r=e?.module_dynamic?.major?.archive?.bvid;return n===void 0&&r===void 0?``:u.renderUGCDescription(t,``,``,n,void 0,r)},x=e=>{let t=[],n=e?.module_dynamic?.major;if(!n)return``;n.opus?.pics?.length&&t.push(...n.opus.pics.map(e=>e.url)),n.article?.covers?.length&&t.push(...n.article.covers),n.draw?.items?.length&&t.push(...n.draw.items.map(e=>e.src)),n.live_rcmd?.content&&t.push(JSON.parse(n.live_rcmd.content)?.live_play_info?.cover);let r=n.type.replace(`MAJOR_TYPE_`,``).toLowerCase();return n[r]?.cover&&t.push(n[r].cover),t.filter(Boolean).map(e=>`<img src="${e}">`).join(``)},S=(e,t=!1)=>{let n=e?.modules;if(!n)return null;let r=``,i=``,a,o=n.module_dynamic?.major;if(!o)return null;switch(o?.type){case`MAJOR_TYPE_UGC_SEASON`:r=o?.ugc_season?.jump_url||``,i=`合集地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_ARTICLE`:r=`https://www.bilibili.com/read/cv${o?.article?.id}`,i=`专栏地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_ARCHIVE`:{let e=o?.archive,n=t?`av${e?.aid}`:e?.bvid;r=`https://www.bilibili.com/video/${n}`,i=`视频地址：<a href=${r}>${r}</a>`,a=l(e?.bvid);break}case`MAJOR_TYPE_COMMON`:r=o?.common?.jump_url||``,i=`地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_OPUS`:e?.type===`DYNAMIC_TYPE_ARTICLE`?(r=`https:${o?.opus?.jump_url}`,i=`专栏地址：<a href=${r}>${r}</a>`):e?.type===`DYNAMIC_TYPE_DRAW`&&(r=`https:${o?.opus?.jump_url}`,i=`图文地址：<a href=${r}>${r}</a>`);break;case`MAJOR_TYPE_PGC`:{let e=o?.pgc;r=`https://www.bilibili.com/bangumi/play/ep${e?.epid}&season_id=${e?.season_id}`,i=`剧集地址：<a href=${r}>${r}</a>`;break}case`MAJOR_TYPE_COURSES`:r=`https://www.bilibili.com/cheese/play/ss${o?.courses?.id}`,i=`课程地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_MUSIC`:r=`https://www.bilibili.com/audio/au${o?.music?.id}`,i=`音频地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_LIVE`:r=`https://live.bilibili.com/${o?.live?.id}`,i=`直播间地址：<a href=${r}>${r}</a>`;break;case`MAJOR_TYPE_LIVE_RCMD`:{let e=JSON.parse(o.live_rcmd?.content||`{}`)?.live_play_info;r=`https://live.bilibili.com/${e?.room_id}`,a=c(e?.room_id),i=`直播间地址：<a href=${r}>${r}</a>`;break}default:return null}return{url:r,text:i,videoPageUrl:a}};async function C(a){let c=a.req.param(`uid`),l=Object.fromEntries(new URLSearchParams(a.req.param(`routeParams`))),m=o(void 0,s(l.showEmoji),!1),C=o(void 0,s(l.embed),!1),w=a.req.query(`mode`)===`fulltext`,T=o(void 0,l.offset,``),E=o(void 0,s(l.useAvid),!1),D=o(void 0,s(l.directLink),!1),O=o(void 0,s(l.hideGoods),!1),k=async e=>{let t=u.addDmVerifyInfo(`offset=${T}&host_mid=${c}&platform=web&features=itemOpusStyle,listOnlyfans,opusBigCover,onlyfansVote`,u.getDmImgList()),n=await i(`https://api.bilibili.com/x/polymer/web-dynamic/v1/feed/space?${t}`,{headers:{Referer:`https://space.bilibili.com/${c}/`,Cookie:e}}),r=p.parse(n.body);return r},A,j=await d.getCookie();if(A=await k(j),A?.code===-352){let e=await d.getCookie(!0);if(A=await k(e),A?.code===-352)throw n.set(`bili-cookie`,``),new f(`遇到源站风控校验，请稍后再试`)}let M=A?.data?.items,N=M[0]?.modules?.module_author?.name,P=M[0]?.modules?.module_author?.face;if(!P||!N){let e=await d.getUsernameAndFaceFromUID(c);N=e[0]||M[0]?.modules?.module_author?.name,P=e[1]||M[0]?.modules?.module_author?.face}else n.set(`bili-username-from-uid-${c}`,N),n.set(`bili-userface-from-uid-${c}`,P);let F=await Promise.all(M.filter(e=>O?e.modules.module_dynamic?.additional?.type!==`ADDITIONAL_TYPE_GOODS`:!0).map(async n=>{let i=n.modules,a=n?.orig?.modules,o=i?.module_dynamic?.major?.archive?.bvid,s=``;n.id_str&&(s=`https://t.bilibili.com/${n.id_str}`);let l=g(i)||``,u=l,f=h(i),p=[];if(i.module_dynamic?.desc?.rich_text_nodes?.length){let e=i.module_dynamic.desc.rich_text_nodes;for(let t of e){if(m&&t?.emoji){let e=t.emoji;u=u.replaceAll(e.text,`<img alt="${e.text}" src="${e.icon_url}" style="margin: -1px 1px 0px; display: inline-block; width: 20px; height: 20px; vertical-align: text-bottom;" title="" referrerpolicy="no-referrer">`)}if(t?.pics?.length){let{pics:e,text:n}=t;u=u.replaceAll(n,e.map(e=>`<img alt="${n}" src="${e.src}" style="margin: 0px 0px 0px; display: inline-block; width: ${e.width}px; height: ${e.height}px; vertical-align: text-bottom;" title="" referrerpolicy="no-referrer">`).join(`<br>`))}t?.type===`RICH_TEXT_NODE_TYPE_TOPIC`&&p.push(t.text.match(/#(\S+)#/)?.[1]||``)}}if(i.module_dynamic?.major?.opus?.summary?.rich_text_nodes?.length){let e=i.module_dynamic.major.opus.summary.rich_text_nodes;for(let t of e)t?.type===`RICH_TEXT_NODE_TYPE_TOPIC`&&p.push(t.text.match(/#(\S+)#/)?.[1]||``)}if(i.module_dynamic?.topic?.name&&p.push(i.module_dynamic.topic.name),n.type===`DYNAMIC_TYPE_ARTICLE`&&w){let e=i.module_dynamic?.major?.opus?.jump_url?.match?.(/cv(\d+)/)?.[0];e&&(u=(await d.getArticleDataFromCvid(e,c)).description||``)}let T=S(n,E),O=T?.text;T&&D&&(s=T.url);let k=S(n?.orig,E),A=k?.text;k&&D&&(s=k.url);let j=``,M=y(a),P=_(a),F=v(a);M&&(j+=`//转发自: @${y(a)}: `),P&&(j+=P),F&&(j+=`<br>${F}`),u=u.replaceAll(`\r
`,`<br>`).replaceAll(`
`,`<br>`),j=j.replaceAll(`\r
`,`<br>`).replaceAll(`
`,`<br>`);let I=[f,u,b(i,C),x(i),O,j,b(a,C),x(a),A].map(e=>e?.trim()).filter(Boolean).join(`<br>`),L=!e.bilibili.excludeSubtitles&&o?await d.getVideoSubtitleAttachment(o):[];return{title:f||l,description:I,pubDate:i.module_author?.pub_ts?r(i.module_author.pub_ts,`X`):void 0,link:s,author:N,category:p.length?[...new Set(p)]:void 0,attachments:T?.videoPageUrl||k?.videoPageUrl?[{url:T?.videoPageUrl||k?.videoPageUrl,mime_type:`text/html`,duration_in_seconds:i.module_dynamic?.major?.archive?.duration_text?t(i.module_dynamic.major.archive.duration_text):void 0},...L]:void 0}}));return{title:`${N} 的 bilibili 动态`,link:`https://space.bilibili.com/${c}/dynamic`,description:`${N} 的 bilibili 动态`,image:P,logo:P,icon:P,item:F}}export{m as route};
//# sourceMappingURL=dynamic-eh_wKLjH.js.map