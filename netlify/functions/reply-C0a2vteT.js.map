{"version":3,"file":"reply-C0a2vteT.js","names":["route: Route","ofetch"],"sources":["../../lib/routes/bangumi.tv/group/reply.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nexport const route: Route = {\r\n    path: '/topic/:id',\r\n    categories: ['anime'],\r\n    example: '/bangumi.tv/topic/367032',\r\n    parameters: { id: '话题 id, 在话题页面地址栏查看' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['bgm.tv/group/topic/:id'],\r\n        },\r\n    ],\r\n    name: '小组话题的新回复',\r\n    maintainers: ['ylc395'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    // bangumi.tv未提供获取小组话题的API，因此仍需要通过抓取网页来获取\r\n    const topicID = ctx.req.param('id');\r\n    const link = `https://bgm.tv/group/topic/${topicID}`;\r\n    const html = await ofetch(link);\r\n    const $ = load(html);\r\n    const title = $('#pageHeader h1').text();\r\n    const latestReplies = $('.row_reply')\r\n        .toArray()\r\n        .map((el) => {\r\n            const $el = $(el);\r\n            return {\r\n                id: $el.attr('id'),\r\n                author: $el.find('.userInfo .l').text(),\r\n                content: $el.find('.reply_content .message').html(),\r\n                date: $el.children().first().find('small').children().remove().end().text().slice(3),\r\n            };\r\n        });\r\n    const latestSubReplies = $('.sub_reply_bg')\r\n        .toArray()\r\n        .map((el) => {\r\n            const $el = $(el);\r\n            return {\r\n                id: $el.attr('id'),\r\n                author: $el.find('.userName .l').text(),\r\n                content: $el.find('.cmt_sub_content').html(),\r\n                date: $el.children().first().find('small').children().remove().end().text().slice(3),\r\n            };\r\n        });\r\n    const finalLatestReplies = [...latestReplies, ...latestSubReplies].sort((a, b) => (a.id < b.id ? 1 : -1));\r\n\r\n    const postTopic = {\r\n        title,\r\n        description: $('.postTopic .topic_content').html(),\r\n        author: $('.postTopic .inner strong a').first().text(),\r\n        pubDate: timezone(parseDate($('.postTopic .re_info small').text().trim().slice(5)), +8),\r\n        link,\r\n    };\r\n\r\n    return {\r\n        title: `${title}的最新回复`,\r\n        link,\r\n        item: [\r\n            ...finalLatestReplies.map((c) => ({\r\n                title: `${c.author} 回复了小组话题《${title}》`,\r\n                description: c.content,\r\n                pubDate: timezone(parseDate(c.date), +8),\r\n                author: c.author,\r\n                link: `${link}#${c.id}`,\r\n            })),\r\n            postTopic,\r\n        ],\r\n    };\r\n}\r\n"],"mappings":"iTAMA,MAAaA,EAAe,CACxB,KAAM,aACN,WAAY,CAAC,SACb,QAAS,2BACT,WAAY,CAAE,GAAI,qBAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,4BAGjB,KAAM,WACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CAExB,IAAM,EAAU,EAAI,IAAI,MAAM,MACxB,EAAO,8BAA8B,IACrC,EAAO,MAAMC,EAAO,GACpB,EAAI,EAAK,GACT,EAAQ,EAAE,kBAAkB,OAC5B,EAAgB,EAAE,cACnB,UACA,IAAK,GAAO,CACT,IAAM,EAAM,EAAE,GACd,MAAO,CACH,GAAI,EAAI,KAAK,MACb,OAAQ,EAAI,KAAK,gBAAgB,OACjC,QAAS,EAAI,KAAK,2BAA2B,OAC7C,KAAM,EAAI,WAAW,QAAQ,KAAK,SAAS,WAAW,SAAS,MAAM,OAAO,MAAM,MAGxF,EAAmB,EAAE,iBACtB,UACA,IAAK,GAAO,CACT,IAAM,EAAM,EAAE,GACd,MAAO,CACH,GAAI,EAAI,KAAK,MACb,OAAQ,EAAI,KAAK,gBAAgB,OACjC,QAAS,EAAI,KAAK,oBAAoB,OACtC,KAAM,EAAI,WAAW,QAAQ,KAAK,SAAS,WAAW,SAAS,MAAM,OAAO,MAAM,MAGxF,EAAqB,CAAC,GAAG,EAAe,GAAG,GAAkB,MAAM,EAAG,IAAO,EAAE,GAAK,EAAE,GAAK,EAAI,IAE/F,EAAY,CACd,QACA,YAAa,EAAE,6BAA6B,OAC5C,OAAQ,EAAE,8BAA8B,QAAQ,OAChD,QAAS,EAAS,EAAU,EAAE,6BAA6B,OAAO,OAAO,MAAM,IAAK,GACpF,QAGJ,MAAO,CACH,MAAO,GAAG,EAAM,OAChB,OACA,KAAM,CACF,GAAG,EAAmB,IAAK,IAAO,CAC9B,MAAO,GAAG,EAAE,OAAO,WAAW,EAAM,GACpC,YAAa,EAAE,QACf,QAAS,EAAS,EAAU,EAAE,MAAO,GACrC,OAAQ,EAAE,OACV,KAAM,GAAG,EAAK,GAAG,EAAE,QAEvB"}