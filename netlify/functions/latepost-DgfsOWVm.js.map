{"version":3,"file":"latepost-DgfsOWVm.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/latepost/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate, parseRelativeDate } from '@/utils/parse-date';\r\n\r\n/**\r\n * Convert an array into a dictionary object.\r\n * The keys of the dictionary object are the `id` properties of the elements in the array,\r\n * and the values are the remaining properties of each element.\r\n * @param {Array} arr - The array to be converted.\r\n * @returns {Object} - The converted dictionary object.\r\n */\r\nconst arrayToDictionary = (arr) =>\r\n    Object.fromEntries(\r\n        arr.map(({ id, ...rest }) => [\r\n            id,\r\n            {\r\n                ...rest,\r\n            },\r\n        ])\r\n    );\r\n\r\nexport const route: Route = {\r\n    path: '/:proma?',\r\n    categories: ['new-media'],\r\n    example: '/latepost',\r\n    parameters: { proma: '栏目 id，见下表，默认为最新报道' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '报道',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 最新报道 | 晚点独家 | 人物访谈 | 晚点早知道 | 长报道 |\r\n| -------- | -------- | -------- | ---------- | ------ |\r\n|          | 1        | 2        | 3          | 4      |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const proma = ctx.req.param('proma');\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 5;\r\n\r\n    const title = '晚点';\r\n    const defaultTitle = '最新报道';\r\n    const exclusiveCategory = '晚点独家';\r\n\r\n    const rootUrl = 'https://www.latepost.com';\r\n    const currentUrl = new URL(proma ? `news/index?proma=${proma}` : '', rootUrl).href;\r\n\r\n    const apiColumnUrl = new URL('site/get-column', rootUrl).href;\r\n    const apiCommentUrl = new URL('news/get-comment', rootUrl).href;\r\n    const apiUrl = new URL(proma ? 'news/get-news-data' : 'site/index', rootUrl).href;\r\n\r\n    const { data: columnResponse } = await got(apiColumnUrl);\r\n    const columns = arrayToDictionary(columnResponse?.data ?? []);\r\n\r\n    const { data: response } = await got.post(apiUrl, {\r\n        form: {\r\n            page: 1,\r\n            limit,\r\n            programa: Number.parseInt(proma, 10),\r\n        },\r\n    });\r\n\r\n    let items = response.data.slice(0, limit).map((item) => ({\r\n        title: item.title,\r\n        link: new URL(item.detail_url, rootUrl).href,\r\n        category: [item.is_dj ? exclusiveCategory : undefined, item.programa ? columns[item.programa]?.title : undefined, ...item.label.map((c) => c.label)],\r\n        guid: item.id,\r\n        pubDate: parseDate(item.release_time, ['MM月DD日', 'YYYY年MM月DD日']),\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const { data: commentResponse } = await got.post(apiCommentUrl, {\r\n                    news_id: item.guid,\r\n                    page: 1,\r\n                    limit: Infinity,\r\n                    sort: 1,\r\n                    delete_num: 0,\r\n                });\r\n\r\n                const content = load(detailResponse);\r\n\r\n                item.title = item.title ?? content('div.article-header-title').text();\r\n                item.description = content('#select-main').html().replaceAll('<p><br></p>', '');\r\n                item.author = content('div.article-header-author div.author-link a.label').first().text();\r\n                item.category = item.category.filter(Boolean);\r\n                item.guid = `latepost-${item.guid}`;\r\n\r\n                const pubDate = content('div.article-header-date').text();\r\n\r\n                if (pubDate) {\r\n                    item.pubDate = /\\d+月\\d+日/.test(pubDate) ? parseDate(pubDate, ['YYYY年MM月DD日 HH:mm', 'MM月DD日 HH:mm']) : parseRelativeDate(pubDate);\r\n                }\r\n\r\n                item.pubDate = timezone(item.pubDate, +8);\r\n                item.comments = commentResponse.data?.length() ?? 0;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const icon = new URL('favicon.ico', rootUrl).href;\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    return {\r\n        item: items,\r\n        title: `${title} - ${proma ? columns[proma].title : defaultTitle}`,\r\n        link: currentUrl,\r\n        description: $('div.logo-txt').first().text(),\r\n        language: 'zh-cn',\r\n        image: new URL($('div.logo-txt img').prop('src'), rootUrl).href,\r\n        icon,\r\n        logo: icon,\r\n        author: title,\r\n    };\r\n}\r\n"],"mappings":"ibAcA,MAAM,EAAqB,GACvB,OAAO,YACH,EAAI,KAAK,CAAE,KAAI,GAAG,KAAW,CACzB,EACA,CACI,GAAG,MAKNA,EAAe,CACxB,KAAM,WACN,WAAY,CAAC,aACb,QAAS,YACT,WAAY,CAAE,MAAO,qBACrB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,WACd,UACA,YAAa;;2DAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAQ,EAAI,IAAI,MAAM,SACtB,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,EAE/E,EAAQ,KAIR,EAAU,2BACV,EAAa,IAAI,IAAI,EAAQ,oBAAoB,IAAU,GAAI,GAAS,KAExE,EAAe,IAAI,IAAI,kBAAmB,GAAS,KACnD,EAAgB,IAAI,IAAI,mBAAoB,GAAS,KACrD,EAAS,IAAI,IAAI,EAAQ,qBAAuB,aAAc,GAAS,KAEvE,CAAE,KAAM,GAAmB,MAAMC,EAAI,GACrC,EAAU,EAAkB,GAAgB,MAAQ,IAEpD,CAAE,KAAM,GAAa,MAAMA,EAAI,KAAK,EAAQ,CAC9C,KAAM,CACF,KAAM,EACN,QACA,SAAU,OAAO,SAAS,EAAO,OAIrC,EAAQ,EAAS,KAAK,MAAM,EAAG,GAAO,IAAK,IAAU,CACrD,MAAO,EAAK,MACZ,KAAM,IAAI,IAAI,EAAK,WAAY,GAAS,KACxC,SAAU,CAAC,EAAK,MAAQ,OAAoB,IAAA,GAAW,EAAK,SAAW,EAAQ,EAAK,WAAW,MAAQ,IAAA,GAAW,GAAG,EAAK,MAAM,IAAK,GAAM,EAAE,QAC7I,KAAM,EAAK,GACX,QAAS,EAAU,EAAK,aAAc,CAAC,SAAU,mBAGrD,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAMD,EAAI,EAAK,MAE1C,CAAE,KAAM,GAAoB,MAAMA,EAAI,KAAK,EAAe,CAC5D,QAAS,EAAK,KACd,KAAM,EACN,MAAO,IACP,KAAM,EACN,WAAY,IAGV,EAAU,EAAK,GAErB,EAAK,MAAQ,EAAK,OAAS,EAAQ,4BAA4B,OAC/D,EAAK,YAAc,EAAQ,gBAAgB,OAAO,WAAW,cAAe,IAC5E,EAAK,OAAS,EAAQ,qDAAqD,QAAQ,OACnF,EAAK,SAAW,EAAK,SAAS,OAAO,SACrC,EAAK,KAAO,YAAY,EAAK,OAE7B,IAAM,EAAU,EAAQ,2BAA2B,OASnD,OAPI,IACA,EAAK,QAAU,WAAW,KAAK,GAAW,EAAU,EAAS,CAAC,oBAAqB,iBAAmB,EAAkB,IAG5H,EAAK,QAAU,EAAS,EAAK,QAAS,GACtC,EAAK,SAAW,EAAgB,MAAM,UAAY,EAE3C,MAKnB,IAAM,EAAO,IAAI,IAAI,cAAe,GAAS,KAEvC,CAAE,KAAM,GAAoB,MAAMA,EAAI,GAEtC,EAAI,EAAK,GAEf,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAM,KAAK,EAAQ,EAAQ,GAAO,MAAQ,SACpD,KAAM,EACN,YAAa,EAAE,gBAAgB,QAAQ,OACvC,SAAU,QACV,MAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,OAAQ,GAAS,KAC3D,OACA,KAAM,EACN,OAAQ"}