import"./esm-shims-Dqvxr0BZ.js";import"./config-Dl8a1sIg.js";import"./logger-CWOoofbD.js";import"./dist-IvUHtNe1.js";import"./helpers-DzX-lcQO.js";import{request_in_progress_default as e}from"./request-in-progress-B_B8LLYR.js";import{cache_default as t}from"./cache-kimkMTWJ.js";import{parseDate as n}from"./parse-date-Bgabdhlb.js";import"./ofetch-Bzt0BXUH.js";import{got_default as r}from"./got-CdvI2yKX.js";import{timezone as i}from"./timezone-BrNu6iXe.js";import{wait_default as a}from"./wait-baJzjFxf.js";import{finishArticleItem as o}from"./wechat-mp-BwNEdjlr.js";import{load as s}from"cheerio";const c=(e,t,r)=>{let a=e.find(t),o=a.text(),s=a.attr(`href`),c=i(n(e.find(r).text(),`YYYY-MM-DD HH:mm`),8);return{title:o,link:s,pubDate:c}},l={path:`/data258/:id?`,radar:[{source:[`mp.data258.com/`,`mp.data258.com/article/category/:id`]}],name:`Unknown`,maintainers:[`Rongronggg9`],handler:u,url:`mp.data258.com/`};async function u(n){if(await t.get(`data258:lock`,!1)===`1`)throw new e(`Another request is in progress, please try again later.`);let i=n.req.param(`id`),l=n.req.query(`limit`)?Number.parseInt(n.req.query(`limit`)):5,u=`https://mp.data258.com`,d=i?`${u}/article/category/${i}`:u,f=await r(d),p=s(f.data),m=p(`head title`).text(),h=p(`meta[name="description"]`).attr(`content`),g=p(`ul.fly-list`),_=g&&g.length?p(g).find(`li`).toArray().map(e=>c(p(e),`h2 a`,`.fly-list-info span`)):p(`ul.jie-row li`).toArray().map(e=>c(p(e),`a.jie-title`,`.layui-hide-xs`));if(_=_.slice(0,l),await t.get(`data258:lock`,!1)===`1`)throw new e(`Another request is in progress, please try again later.`);await t.set(`data258:lock`,`1`,60);let v;for(let e of _){let n=e.link.match(/id=([\da-f]+)/)[1];e.link=e.link.startsWith(`http`)?e.link:`${u}${e.link}`;let i=await t.tryGet(`data258:${n}`,async()=>{try{await a(1e3);let t=await r.get(e.link,{headers:{Referer:d}});if(t.data.includes(`今日浏览次数已达上限`))return v=new r.RequestError(t.data,{},t.request),null;let n=s(t.data),i=n(`script`).filter((e,t)=>n(t).html().includes(`location.href`)).html();return i.match(/location\.href='([^']+)'/)[1]}catch(e){return v=e,null}});if(i)e.link=i;else break}if(await t.set(`data258:lock`,`0`,1),_=_.filter(e=>e.link.match(/^https?:\/\/mp\.weixin\.qq\.com\/s/)),_.length===0&&v)throw v;return await Promise.all(_.map(e=>o(e,!!g))),{title:m,link:d,description:h,item:_}}export{l as route};
//# sourceMappingURL=data258-DrWzlhAX.js.map