{"version":3,"file":"joneslanglasalle-D1XPYGwj.js","names":[],"sources":["../../lib/routes/joneslanglasalle/index.ts"],"sourcesContent":["import path from 'node:path';\r\n\r\nimport { type CheerioAPI, type Cheerio, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport { type Context } from 'hono';\r\n\r\nimport { type DataItem, type Route, type Data, ViewType } from '@/types';\r\n\r\nimport { art } from '@/utils/render';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst cleanHtml = (html: string, preservedTags: string[]): string => {\r\n    const $ = load(html);\r\n\r\n    $('div.informationbox').remove();\r\n    $('div.contributors').remove();\r\n\r\n    $('*')\r\n        .not(preservedTags.join(', '))\r\n        .contents()\r\n        .filter((_, el) => el.type === 'text')\r\n        .remove();\r\n\r\n    $('*')\r\n        .not(preservedTags.join(', '))\r\n        .filter((_, el) => $(el).children().length === 0)\r\n        .remove();\r\n\r\n    return $.html() || '';\r\n};\r\n\r\nexport const handler = async (ctx: Context): Promise<Data> => {\r\n    const { language: lang = 'zh', category = 'trends-and-insights' } = ctx.req.param();\r\n    // default limit is 12\r\n    const limit: number = Number.parseInt(ctx.req.query('limit') ?? '12', 10);\r\n\r\n    const rootUrl: string = 'https://www.joneslanglasalle.com.cn';\r\n    const targetUrl: string = new URL(`${lang}/${category}`, rootUrl).href;\r\n\r\n    const response = await ofetch(targetUrl);\r\n    const $: CheerioAPI = load(response);\r\n    const language: string = $('html').prop('lang') ?? 'en';\r\n\r\n    let items: DataItem[] = $('div.ti-title')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item): DataItem => {\r\n            const $item: Cheerio<Element> = $(item);\r\n            const aEl = $item.closest('a');\r\n\r\n            const title: string = $item.text();\r\n            const link: string | undefined = aEl.prop('href');\r\n\r\n            const description: string = art(path.join(__dirname, 'templates/description.art'), {\r\n                intro: aEl.find('p.ti-teaser').text(),\r\n            });\r\n\r\n            const image: string | undefined = aEl.find('div.ti-image-container img').prop('src') ? new URL(aEl.find('div.ti-image-container img').prop('src') as string, rootUrl).href : undefined;\r\n\r\n            return {\r\n                title,\r\n                description,\r\n                pubDate: parseDate(aEl.find('span.ti-date').text(), ['MM月DD日', 'MMMM DD']),\r\n                link: link ? new URL(link, rootUrl).href : undefined,\r\n                category: [aEl.find('span.ti-type').text()].filter(Boolean),\r\n                content: {\r\n                    html: description,\r\n                    text: aEl.find('p.ti-teaser').text(),\r\n                },\r\n                image,\r\n                banner: image,\r\n                language,\r\n            };\r\n        });\r\n\r\n    items = (\r\n        await Promise.all(\r\n            items.map((item) => {\r\n                if (!item.link && typeof item.link !== 'string') {\r\n                    return item;\r\n                }\r\n\r\n                return cache.tryGet(item.link, async (): Promise<DataItem> => {\r\n                    try {\r\n                        const detailResponse = await ofetch(item.link);\r\n                        const $$: CheerioAPI = load(detailResponse);\r\n\r\n                        const title: string = $$('meta[property=\"og:title\"]').prop('content');\r\n                        const guid: string = $$('meta[property=\"og:url\"]').prop('content');\r\n                        const image: string | undefined = $$('meta[property=\"og:image\"]').prop('content');\r\n\r\n                        const pubDate: Date = parseDate($$('div.publicationdate').text().trim(), ['YYYY 年MM 月DD 日', 'MMMM DD, YYYY']);\r\n\r\n                        const author: DataItem['author'] = $$('div.contributors ul li')\r\n                            .toArray()\r\n                            .map((el) => ({\r\n                                name: $$(el).text(),\r\n                            }));\r\n\r\n                        const media: Record<string, Record<string, string>> = {};\r\n\r\n                        $$('picture').each((_, el) => {\r\n                            const $$el = $$(el);\r\n\r\n                            const src = $$el.find('source').last().prop('srcset') ? new URL($$el.find('source').last().prop('srcset') as string, rootUrl).href : undefined;\r\n\r\n                            if (src) {\r\n                                $$el.replaceWith(\r\n                                    art(path.join(__dirname, 'templates/description.art'), {\r\n                                        images: [\r\n                                            {\r\n                                                src,\r\n                                            },\r\n                                        ],\r\n                                    })\r\n                                );\r\n\r\n                                const mediaType: string | undefined = src.split(/\\./).pop();\r\n\r\n                                if (mediaType) {\r\n                                    media[mediaType] = { url: src };\r\n                                }\r\n                            }\r\n                        });\r\n\r\n                        const extraLinks = $$('div.related-content a.content-card')\r\n                            .toArray()\r\n                            .map((el) => {\r\n                                const $$el: Cheerio<Element> = $$(el);\r\n\r\n                                return {\r\n                                    url: new URL($$el.prop('href') as string, rootUrl).href,\r\n                                    type: 'related',\r\n                                    content_html: $$el.find('div.content-card__body').html(),\r\n                                };\r\n                            })\r\n                            .filter((link): link is { url: string; type: string; content_html: string } => true);\r\n\r\n                        const description: string = art(path.join(__dirname, 'templates/description.art'), {\r\n                            description: cleanHtml($$('div.page-section').eq(1).html() ?? $$('div.copy-block').html() ?? '', ['div.richtext p', 'h3', 'h4', 'h5', 'h6', 'figure', 'img', 'ul', 'li', 'span', 'b']),\r\n                        });\r\n\r\n                        return {\r\n                            title,\r\n                            description,\r\n                            pubDate,\r\n                            category: $$('meta[property=\"article:tag\"]').prop('content').split(/,\\s/),\r\n                            author,\r\n                            guid,\r\n                            id: guid,\r\n                            content: {\r\n                                html: description,\r\n                                text: description,\r\n                            },\r\n                            image,\r\n                            banner: image,\r\n                            language,\r\n                            media: Object.keys(media).length > 0 ? media : undefined,\r\n                            _extra: {\r\n                                links: extraLinks.length > 0 ? extraLinks : undefined,\r\n                            },\r\n                        };\r\n                    } catch {\r\n                        return item;\r\n                    }\r\n                });\r\n            })\r\n        )\r\n    ).filter((_): _ is DataItem => true);\r\n\r\n    const title = $('title').text();\r\n    const feedImage = $('img.logo').prop('src') ? new URL($('img.logo').prop('src') as string, rootUrl).href : undefined;\r\n\r\n    return {\r\n        title,\r\n        description: $('meta[property=\"og:description\"]').prop('content'),\r\n        link: targetUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: feedImage,\r\n        author: title.split(/\\|/).pop(),\r\n        language,\r\n        id: $('meta[property=\"og:url\"]').prop('content'),\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:language?/:category{.+}?',\r\n    name: 'Trends & Insights',\r\n    url: 'joneslanglasalle.com.cn',\r\n    maintainers: ['nczitzk', 'pseudoyu'],\r\n    handler,\r\n    example: '/joneslanglasalle/en/trends-and-insights',\r\n    parameters: {\r\n        language: 'Language, `zh` by default',\r\n        category: 'Category, `trends-and-insights` by default',\r\n    },\r\n    description: `::: tip\r\nIf you subscribe to [Trends & Insights](https://www.joneslanglasalle.com.cn/en/trends-and-insights)，where the URL is \\`https://www.joneslanglasalle.com.cn/en/trends-and-insights\\`, extract the part \\`https://joneslanglasalle.com.cn/\\` to the end. Use \\`zh\\` and \\`trends-and-insights\\` as the parameters to fill in. Therefore, the route will be [\\`/joneslanglasalle/en/trends-and-insights\\`](https://rsshub.app/joneslanglasalle/en/trends-and-insights).\r\n:::\r\n\r\n| Category  | ID                            |\r\n| --------- | ----------------------------- |\r\n| Latest    | trends-and-insights           |\r\n| Workplace | trends-and-insights/workplace |\r\n| Investor  | trends-and-insights/investor  |\r\n| Cities    | trends-and-insights/cities    |\r\n| Research  | trends-and-insights/research  |\r\n`,\r\n    categories: ['new-media'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['joneslanglasalle.com.cn/:language/:category'],\r\n            target: (params) => {\r\n                const language = params.language;\r\n                const category = params.category;\r\n\r\n                return language ? `/${language}${category ? `/${category}` : ''}` : '';\r\n            },\r\n        },\r\n        {\r\n            title: 'Latest',\r\n            source: ['joneslanglasalle.com.cn/en/trends-and-insights'],\r\n            target: '/en/trends-and-insights',\r\n        },\r\n        {\r\n            title: 'Workplace',\r\n            source: ['joneslanglasalle.com.cn/en/trends-and-insights/workplace'],\r\n            target: '/en/trends-and-insights/workplace',\r\n        },\r\n        {\r\n            title: 'Investor',\r\n            source: ['joneslanglasalle.com.cn/en/trends-and-insights/investor'],\r\n            target: '/en/trends-and-insights/investor',\r\n        },\r\n        {\r\n            title: 'Cities',\r\n            source: ['joneslanglasalle.com.cn/en/trends-and-insights/cities'],\r\n            target: '/en/trends-and-insights/cities',\r\n        },\r\n        {\r\n            title: 'Research',\r\n            source: ['joneslanglasalle.com.cn/en/trends-and-insights/research'],\r\n            target: '/en/trends-and-insights/research',\r\n        },\r\n        {\r\n            title: '房地产趋势与洞察',\r\n            source: ['joneslanglasalle.com.cn/zh/trends-and-insights'],\r\n            target: '/zh/trends-and-insights',\r\n        },\r\n        {\r\n            title: '办公空间',\r\n            source: ['joneslanglasalle.com.cn/zh/trends-and-insights/workplace'],\r\n            target: '/zh/trends-and-insights/workplace',\r\n        },\r\n        {\r\n            title: '投资者',\r\n            source: ['joneslanglasalle.com.cn/zh/trends-and-insights/investor'],\r\n            target: '/zh/trends-and-insights/investor',\r\n        },\r\n        {\r\n            title: '城市',\r\n            source: ['joneslanglasalle.com.cn/zh/trends-and-insights/cities'],\r\n            target: '/zh/trends-and-insights/cities',\r\n        },\r\n        {\r\n            title: '研究报告',\r\n            source: ['joneslanglasalle.com.cn/zh/trends-and-insights/research'],\r\n            target: '/zh/trends-and-insights/research',\r\n        },\r\n    ],\r\n    view: ViewType.Articles,\r\n\r\n    zh: {\r\n        path: '/:language?/:category{.+}?',\r\n        name: '房地产趋势与洞察',\r\n        url: 'joneslanglasalle.com.cn',\r\n        maintainers: ['nczitzk'],\r\n        handler,\r\n        example: '/joneslanglasalle/zh/trends-and-insights',\r\n        parameters: {\r\n            language: '语言，默认为 `zh`，可在对应分类页 URL 中找到',\r\n            category: '分类，默认为 `trends-and-insights`，可在对应分类页 URL 中找到',\r\n        },\r\n        description: `::: tip\r\n若订阅 [房地产趋势与洞察](https://www.joneslanglasalle.com.cn/zh/trends-and-insights)，网址为 \\`https://www.joneslanglasalle.com.cn/zh/trends-and-insights\\`，请截取 \\`https://joneslanglasalle.com.cn/\\` 到末尾的部分 \\`zh\\` 和 \\`trends-and-insights\\` 作为 \\`language\\` 和 \\`category\\` 参数填入，此时目标路由为 [\\`/joneslanglasalle/zh/trends-and-insights\\`](https://rsshub.app/joneslanglasalle/zh/trends-and-insights)。\r\n:::\r\n\r\n| 分类名称   | 分类 ID                       |\r\n| ---------- | ----------------------------- |\r\n| 趋势及洞察 | trends-and-insights           |\r\n| 办公空间   | trends-and-insights/workplace |\r\n| 投资者     | trends-and-insights/investor  |\r\n| 城市       | trends-and-insights/cities    |\r\n| 研究报告   | trends-and-insights/research  |\r\n`,\r\n    },\r\n};\r\n"],"mappings":"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"}