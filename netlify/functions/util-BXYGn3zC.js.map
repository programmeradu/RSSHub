{"version":3,"file":"util-BXYGn3zC.js","names":["rootUrl: string","processItems: ($: CheerioAPI, targetEl: Cheerio<Element>, limit: number) => Promise<DataItem[]>","items: DataItem[]","$item: Cheerio<Element>","aEl: Cheerio<Element>","title: string","link: string | undefined","pubDateStr: string | undefined","authorEl: Cheerio<Element>","author: DataItem['author']","cache","ofetch","$$: CheerioAPI","isAnswer: boolean","description: string","metaStr: string"],"sources":["../../lib/routes/jisilu/util.ts"],"sourcesContent":["import { type CheerioAPI, type Cheerio, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\n\r\nimport { type DataItem } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nconst rootUrl: string = 'https://www.jisilu.cn';\r\n\r\nconst processItems: ($: CheerioAPI, targetEl: Cheerio<Element>, limit: number) => Promise<DataItem[]> = async ($: CheerioAPI, targetEl: Cheerio<Element>, limit: number) => {\r\n    const items: DataItem[] = targetEl\r\n        .find('div.aw-item')\r\n        .toArray()\r\n        .map((item): DataItem => {\r\n            const $item: Cheerio<Element> = $(item);\r\n\r\n            const aEl: Cheerio<Element> = $item.find('h4 a');\r\n\r\n            const title: string = aEl.text();\r\n            const link: string | undefined = aEl.prop('href');\r\n\r\n            const pubDateStr: string | undefined = $item\r\n                .find('.aw-text-color-999')\r\n                .text()\r\n                .match(/(\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2})/)?.[1];\r\n\r\n            const authorEl: Cheerio<Element> = $item.find('a.aw-user-name');\r\n            const author: DataItem['author'] = authorEl.prop('href')\r\n                ? [\r\n                      {\r\n                          name: authorEl.text(),\r\n                          url: authorEl.prop('href'),\r\n                      },\r\n                  ]\r\n                : authorEl.text();\r\n\r\n            return {\r\n                title,\r\n                pubDate: pubDateStr ? timezone(parseDate(pubDateStr), +8) : undefined,\r\n                link,\r\n                category: $item\r\n                    .find('span.aw-question-tags a, a.aw-topic-name')\r\n                    .toArray()\r\n                    .map((c) => $(c).text()),\r\n                author,\r\n            };\r\n        });\r\n\r\n    return (\r\n        await Promise.all(\r\n            items.map((item) => {\r\n                if (!item.link && typeof item.link !== 'string') {\r\n                    return item;\r\n                }\r\n\r\n                return cache.tryGet(item.link, async (): Promise<DataItem> => {\r\n                    const detailResponse = await ofetch(item.link);\r\n                    const $$: CheerioAPI = load(detailResponse);\r\n\r\n                    const title: string = $$('div.aw-mod-head h1').text();\r\n\r\n                    if (!title) {\r\n                        return item;\r\n                    }\r\n\r\n                    const isAnswer: boolean = item.link ? /answer_id/.test(item.link) : false;\r\n\r\n                    const description: string = (isAnswer ? $$('div.markitup-box').last() : $$('div.markitup-box').first()).html() ?? '';\r\n\r\n                    const metaStr: string = $$(isAnswer ? 'div.aw-dynamic-topic-meta' : 'div.aw-question-detail-meta')\r\n                        .find('span.aw-text-color-999')\r\n                        .text();\r\n\r\n                    const pubDateStr = metaStr.match(isAnswer ? /(\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2})/ : /发表时间\\s(\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2})/)?.[1];\r\n                    const updatedStr = metaStr.match(/最后修改时间\\s(\\d{4}-\\d{2}-\\d{2}\\s\\d{2}:\\d{2})/)?.[1];\r\n\r\n                    const authorEl: Cheerio<Element> = $$(isAnswer ? 'p.publisher a.aw-user-name' : 'div.aw-side-bar-mod-body a.aw-user-name').first();\r\n                    const author: DataItem['author'] = authorEl.prop('href')\r\n                        ? [\r\n                              {\r\n                                  name: authorEl.text(),\r\n                                  url: authorEl.prop('href'),\r\n                                  avatar: authorEl.parent().parent().find('img').first().prop('src'),\r\n                              },\r\n                          ]\r\n                        : authorEl.text();\r\n\r\n                    return {\r\n                        title,\r\n                        description,\r\n                        pubDate: pubDateStr ? timezone(parseDate(pubDateStr), +8) : item.pubDate,\r\n                        link: item.link,\r\n                        category: item.category,\r\n                        author,\r\n                        content: {\r\n                            html: description,\r\n                            text: $$('div.aw-question-detail-txt').first().text(),\r\n                        },\r\n                        updated: updatedStr ? timezone(parseDate(updatedStr), +8) : item.updated,\r\n                    };\r\n                });\r\n            })\r\n        )\r\n    )\r\n        .filter((_): _ is DataItem => true)\r\n        .slice(0, limit);\r\n};\r\n\r\nexport { rootUrl, processItems };\r\n"],"mappings":"gPAUA,MAAMA,EAAkB,wBAElBC,EAAkG,MAAO,EAAe,EAA4B,IAAkB,CACxK,IAAMC,EAAoB,EACrB,KAAK,eACL,UACA,IAAK,GAAmB,CACrB,IAAMC,EAA0B,EAAE,GAE5BC,EAAwB,EAAM,KAAK,QAEnCC,EAAgB,EAAI,OACpBC,EAA2B,EAAI,KAAK,QAEpCC,EAAiC,EAClC,KAAK,sBACL,OACA,MAAM,sCAAsC,GAE3CC,EAA6B,EAAM,KAAK,kBACxCC,EAA6B,EAAS,KAAK,QAC3C,CACI,CACI,KAAM,EAAS,OACf,IAAK,EAAS,KAAK,UAG3B,EAAS,OAEf,MAAO,CACH,QACA,QAAS,EAAa,EAAS,EAAU,GAAa,GAAM,IAAA,GAC5D,OACA,SAAU,EACL,KAAK,4CACL,UACA,IAAK,GAAM,EAAE,GAAG,QACrB,YAIZ,OACI,MAAM,QAAQ,IACV,EAAM,IAAK,GACH,CAAC,EAAK,MAAQ,OAAO,EAAK,MAAS,SAC5B,EAGJC,EAAM,OAAO,EAAK,KAAM,SAA+B,CAC1D,IAAM,EAAiB,MAAMC,EAAO,EAAK,MACnCC,EAAiB,EAAK,GAEtBP,EAAgB,EAAG,sBAAsB,OAE/C,GAAI,CAAC,EACD,OAAO,EAGX,IAAMQ,EAAoB,EAAK,KAAO,YAAY,KAAK,EAAK,MAAQ,GAE9DC,GAAuB,EAAW,EAAG,oBAAoB,OAAS,EAAG,oBAAoB,SAAS,QAAU,GAE5GC,EAAkB,EAAG,EAAW,4BAA8B,+BAC/D,KAAK,0BACL,OAEC,EAAa,EAAQ,MAAM,EAAW,mCAAqC,4CAA4C,GACvH,EAAa,EAAQ,MAAM,8CAA8C,GAEzEP,EAA6B,EAAG,EAAW,6BAA+B,2CAA2C,QACrHC,EAA6B,EAAS,KAAK,QAC3C,CACI,CACI,KAAM,EAAS,OACf,IAAK,EAAS,KAAK,QACnB,OAAQ,EAAS,SAAS,SAAS,KAAK,OAAO,QAAQ,KAAK,SAGpE,EAAS,OAEf,MAAO,CACH,QACA,cACA,QAAS,EAAa,EAAS,EAAU,GAAa,GAAM,EAAK,QACjE,KAAM,EAAK,KACX,SAAU,EAAK,SACf,SACA,QAAS,CACL,KAAM,EACN,KAAM,EAAG,8BAA8B,QAAQ,QAEnD,QAAS,EAAa,EAAS,EAAU,GAAa,GAAM,EAAK,cAMhF,OAAQ,GAAqB,IAC7B,MAAM,EAAG"}