import"./esm-shims-Dqvxr0BZ.js";import{config as e}from"./config-Dl8a1sIg.js";import{logger_default as t}from"./logger-CWOoofbD.js";import{proxy_default as n}from"./proxy-D7ccvALx.js";import"./dist-IvUHtNe1.js";import r,{FormData as i,Headers as a,Request as o,Response as s}from"undici";import c from"node:http";import l from"node:https";import{RateLimiterMemory as u,RateLimiterQueue as d}from"rate-limiter-flexible";const f=new u({points:10,duration:1,execEvenly:!0}),p=new d(f,{maxQueueSize:4800}),m=async(i,a)=>{let s=new o(i,a),c={};if(t.debug(`Outgoing request: ${s.method} ${s.url}`),s.headers.get(`user-agent`)||s.headers.set(`user-agent`,e.ua),s.headers.get(`accept`)||s.headers.set(`accept`,`*/*`),!s.headers.get(`referer`))try{let e=new URL(s.url);s.headers.set(`referer`,e.origin)}catch{}let l=!1;if(s.headers.get(`x-prefer-proxy`)&&(l=!0,s.headers.delete(`x-prefer-proxy`)),e.enableRemoteDebugging&&s.headers,!a?.dispatcher&&(n.proxyObj.strategy!==`on_retry`||l)){let e=new RegExp(n.proxyObj.url_regex),r;try{r=new URL(s.url)}catch{}if(e.test(s.url)&&s.url.startsWith(`http`)&&!(r&&r.host===n.proxyUrlHandler?.host)){let e=n.getCurrentProxy();if(e){let r=n.getDispatcherForProxy(e);r&&(c.dispatcher=r,t.debug(`Proxying request via ${e.uri}: ${s.url}`))}}}await p.removeTokens(1);let u=n.multiProxy?.allProxies.length||1,d=async e=>{try{return await r.fetch(s,c)}catch(r){if(c.dispatcher&&n.multiProxy&&e<u-1){let i=n.getCurrentProxy();if(i){t.warn(`Request failed with proxy ${i.uri}, trying next proxy: ${r}`),n.markProxyFailed(i.uri);let a=n.getCurrentProxy();if(a&&a.uri!==i.uri){let r=n.getDispatcherForProxy(a);return r&&(c.dispatcher=r),t.debug(`Retrying request with proxy ${a.uri}: ${s.url}`),d(e+1)}else return t.warn(`No more proxies available, trying without proxy`),delete c.dispatcher,d(e+1)}}throw r}};return d(0)};var h=m;const g=r=>function(...i){let a,o={},s;if(typeof i[0]==`string`||i[0]instanceof URL)a=new URL(i[0]),typeof i[1]==`object`?(o=i[1],s=i[2]):typeof i[1]==`function`&&(o={},s=i[1]);else{o=i[0];try{a=new URL(o.href||`${o.protocol||`http:`}//${o.hostname||o.host}${o.path}${o.search||(o.query?`?${o.query}`:``)}`)}catch{a=null}typeof i[1]==`function`&&(s=i[1])}if(!a)return Reflect.apply(r,this,i);t.debug(`Outgoing request: ${o.method||`GET`} ${a}`),o.headers=o.headers||{};let c=new Set(Object.keys(o.headers).map(e=>e.toLowerCase()));if(c.has(`user-agent`)||(o.headers[`user-agent`]=e.ua),c.has(`accept`)||(o.headers.accept=`*/*`),c.has(`referer`)||(o.headers.referer=a.origin),!o.agent&&n.agent){let t=new RegExp(n.proxyObj.url_regex);t.test(a.toString())&&a.protocol.startsWith(`http`)&&a.host!==n.proxyUrlHandler?.host&&a.host!==`localhost`&&!a.host.startsWith(`127.`)&&!(e.puppeteerWSEndpoint?.includes(a.host)??!1)&&(o.agent=n.agent)}return Reflect.apply(r,this,[a,o,s])};var _=g;Object.defineProperties(globalThis,{fetch:{value:h},Headers:{value:a},FormData:{value:i},Request:{value:o},Response:{value:s}}),c.get=_(c.get),c.request=_(c.request),l.get=_(l.get),l.request=_(l.request);const v=()=>{t.info(`Initializing RSSHub for Netlify Functions environment`),process.env.NO_LOGFILES=`true`,process.env.CACHE_TYPE||(process.env.CACHE_TYPE=e.redis.url&&e.redis.url!==`redis://localhost:6379/`?`redis`:`memory`),process.env.REQUEST_TIMEOUT||(process.env.REQUEST_TIMEOUT=`25000`),process.env.ENABLE_CLUSTER=`false`,process.env.MEMORY_MAX||(process.env.MEMORY_MAX=`64`),t.info(`Netlify environment configuration applied`)};v();var y=(await import(`./app-bootstrap-C35_wkV9.js`)).default;export{y as default};
//# sourceMappingURL=netlify-server.js.map