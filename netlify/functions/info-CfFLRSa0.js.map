{"version":3,"file":"info-CfFLRSa0.js","names":["route: Route","got"],"sources":["../../lib/routes/hpoi/info.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseRelativeDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/info/:type?/:catType?',\r\n    categories: ['anime'],\r\n    example: '/hpoi/info/all/hobby|model',\r\n    parameters: {\r\n        type: {\r\n            description: '情报类型',\r\n            options: [\r\n                { value: 'all', label: '全部' },\r\n                { value: 'confirm', label: '制作' },\r\n                { value: 'official_pic', label: '官图更新' },\r\n                { value: 'preorder', label: '开订' },\r\n                { value: 'delay', label: '延期' },\r\n                { value: 'release', label: '出荷' },\r\n                { value: 'reorder', label: '再版' },\r\n                { value: 'hobby', label: '手办(拟废弃, 无效果)' },\r\n                { value: 'model', label: '动漫模型(拟废弃, 无效果)' },\r\n            ],\r\n            default: 'all',\r\n        },\r\n        catType: {\r\n            description: '手办分类过滤, 使用|分割, 支持的分类见下表',\r\n            default: 'all',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '情报',\r\n    maintainers: ['sanmmm DIYgod'],\r\n    description: `::: tip\r\n  情报类型中的*手办*、*模型*只是为了兼容, 实际效果等同于**全部**, 如果只需要**手办**类型的情报, 可以使用参数*catType*, e.g. /hpoi/info/all/hobby\r\n:::\r\n\r\n|  手办   | 动漫模型 | 真实模型 | 毛绒布偶 | doll娃娃 | GK/其他 |\r\n| ------ | ------- | ------- | ------- | ------- | ------ |\r\n| hobby  |  model  |  real   | moppet  |  doll   | gkdiy  |`,\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { type = 'all', catType = 'all' } = ctx.req.param();\r\n    const baseUrl = 'https://www.hpoi.net';\r\n    const reqUrl = `${baseUrl}/user/home/ajax`;\r\n\r\n    const classMap = {\r\n        all: '全部',\r\n        hobby: '手办',\r\n        model: '动漫模型',\r\n        real: '真实模型',\r\n        moppet: '毛绒布偶',\r\n        doll: 'doll娃娃',\r\n        gkdiy: 'GK/其他',\r\n    };\r\n\r\n    const filterArr = catType.split('|').sort();\r\n\r\n    const filterSet = new Set(filterArr.map((e: string) => classMap[e]));\r\n    if (catType.includes('all')) {\r\n        filterSet.clear();\r\n    }\r\n\r\n    let finalType = type;\r\n    if (['hobby', 'model'].includes(type)) {\r\n        finalType = 'all';\r\n    }\r\n\r\n    const url = `${reqUrl}?page=1&type=info&subType=${finalType}`;\r\n    const response = await got.post(url);\r\n\r\n    const $ = load(response.data);\r\n\r\n    const items = $('.home-info')\r\n        .toArray()\r\n        .map((ele) => {\r\n            const $item = load(ele);\r\n            const leftNode = $item('.overlay-container');\r\n            const relativeLink = leftNode.find('a').first().attr('href');\r\n            const typeName = leftNode.find('.type-name').first().text().trim();\r\n            const imgUrl = leftNode.find('img').first().attr('src');\r\n            const rightNode = $item('.home-info-content');\r\n            const infoType = rightNode.find('.user-name').contents()[0].data.trim();\r\n            const infoTitle = rightNode.find('.user-content').text();\r\n            const infoTime = rightNode.find('.type-time').text();\r\n            return {\r\n                title: infoTitle,\r\n                pubDate: parseRelativeDate(infoTime),\r\n                link: `${baseUrl}/${relativeLink}`,\r\n                category: infoType,\r\n                typeName,\r\n                description: [`类型:${typeName}`, infoTitle, `更新内容: ${infoType}`, `<img src=\"${imgUrl}\"/>`].join('<br/>'),\r\n            };\r\n        });\r\n\r\n    const items2 = filterSet.size > 0 ? items.filter((e) => filterSet.has(e.typeName)) : items;\r\n\r\n    const typeToLabel = {\r\n        all: '全部',\r\n        confirm: '制作',\r\n        official_pic: '官图更新',\r\n        preorder: '开订',\r\n        delay: '延期',\r\n        release: '出荷',\r\n        reorder: '再版',\r\n    };\r\n    const title = `手办维基 - 情报 - ${typeToLabel[finalType]}`;\r\n    const catTypeName = filterSet.size > 0 ? filterArr.join('|') : 'all';\r\n    return {\r\n        title,\r\n        link: `${baseUrl}/user/home?type=info&subType=${type}&catType=${catTypeName}`,\r\n        description: title,\r\n        item: items2,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"4TAKA,MAAaA,EAAe,CACxB,KAAM,yBACN,WAAY,CAAC,SACb,QAAS,6BACT,WAAY,CACR,KAAM,CACF,YAAa,OACb,QAAS,CACL,CAAE,MAAO,MAAO,MAAO,MACvB,CAAE,MAAO,UAAW,MAAO,MAC3B,CAAE,MAAO,eAAgB,MAAO,QAChC,CAAE,MAAO,WAAY,MAAO,MAC5B,CAAE,MAAO,QAAS,MAAO,MACzB,CAAE,MAAO,UAAW,MAAO,MAC3B,CAAE,MAAO,UAAW,MAAO,MAC3B,CAAE,MAAO,QAAS,MAAO,gBACzB,CAAE,MAAO,QAAS,MAAO,mBAE7B,QAAS,OAEb,QAAS,CACL,YAAa,0BACb,QAAS,QAGjB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,iBACd,YAAa;;;;;;6DAOb,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAO,MAAO,UAAU,OAAU,EAAI,IAAI,QAC5C,EAAU,uBACV,EAAS,GAAG,EAAQ,iBAEpB,EAAW,CACb,IAAK,KACL,MAAO,KACP,MAAO,OACP,KAAM,OACN,OAAQ,OACR,KAAM,SACN,MAAO,SAGL,EAAY,EAAQ,MAAM,KAAK,OAE/B,EAAY,IAAI,IAAI,EAAU,IAAK,GAAc,EAAS,KAC5D,EAAQ,SAAS,QACjB,EAAU,QAGd,IAAI,EAAY,EACZ,CAAC,QAAS,SAAS,SAAS,KAC5B,EAAY,OAGhB,IAAM,EAAM,GAAG,EAAO,4BAA4B,IAC5C,EAAW,MAAMC,EAAI,KAAK,GAE1B,EAAI,EAAK,EAAS,MAElB,EAAQ,EAAE,cACX,UACA,IAAK,GAAQ,CACV,IAAM,EAAQ,EAAK,GACb,EAAW,EAAM,sBACjB,EAAe,EAAS,KAAK,KAAK,QAAQ,KAAK,QAC/C,EAAW,EAAS,KAAK,cAAc,QAAQ,OAAO,OACtD,EAAS,EAAS,KAAK,OAAO,QAAQ,KAAK,OAC3C,EAAY,EAAM,sBAClB,EAAW,EAAU,KAAK,cAAc,WAAW,GAAG,KAAK,OAC3D,EAAY,EAAU,KAAK,iBAAiB,OAC5C,EAAW,EAAU,KAAK,cAAc,OAC9C,MAAO,CACH,MAAO,EACP,QAAS,EAAkB,GAC3B,KAAM,GAAG,EAAQ,GAAG,IACpB,SAAU,EACV,WACA,YAAa,CAAC,MAAM,IAAY,EAAW,SAAS,IAAY,aAAa,EAAO,MAAM,KAAK,YAIrG,EAAS,EAAU,KAAO,EAAI,EAAM,OAAQ,GAAM,EAAU,IAAI,EAAE,WAAa,EAE/E,EAAc,CAChB,IAAK,KACL,QAAS,KACT,aAAc,OACd,SAAU,KACV,MAAO,KACP,QAAS,KACT,QAAS,MAEP,EAAQ,eAAe,EAAY,KACnC,EAAc,EAAU,KAAO,EAAI,EAAU,KAAK,KAAO,MAC/D,MAAO,CACH,QACA,KAAM,GAAG,EAAQ,+BAA+B,EAAK,WAAW,IAChE,YAAa,EACb,KAAM,EACN,WAAY"}