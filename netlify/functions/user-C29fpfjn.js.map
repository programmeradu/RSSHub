{"version":3,"file":"user-C29fpfjn.js","names":[],"sources":["../../lib/routes/tiktok/user.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { queryToBoolean } from '@/utils/readable-social';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nconst baseUrl = 'https://www.tiktok.com';\r\n\r\nexport const route: Route = {\r\n    path: '/user/:user/:iframe?',\r\n    categories: ['social-media'],\r\n    example: '/tiktok/user/@linustech/true',\r\n    parameters: { user: 'User ID, including @', iframe: 'Use the official iframe to embed the video, which allows you to view the video if the default option does not work. Default to `false`' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['tiktok.com/:user'],\r\n            target: '/user/:user',\r\n        },\r\n    ],\r\n    name: 'User',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { user, iframe } = ctx.req.param();\r\n    const useIframe = queryToBoolean(iframe);\r\n\r\n    const data = await cache.tryGet(\r\n        `tiktok:user:${user}`,\r\n        async () => {\r\n            const browser = await puppeteer();\r\n            const page = await browser.newPage();\r\n            await page.setRequestInterception(true);\r\n            page.on('request', (request) => {\r\n                request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n            });\r\n            await page.goto(`${baseUrl}/${user}`, {\r\n                waitUntil: 'networkidle0',\r\n            });\r\n            const SIGI_STATE = await page.evaluate(() => window.SIGI_STATE);\r\n            await browser.close();\r\n\r\n            const lang = SIGI_STATE.AppContext.lang;\r\n            const SharingMetaState = SIGI_STATE.SharingMetaState;\r\n            const ItemModule = SIGI_STATE.ItemModule;\r\n\r\n            return { lang, SharingMetaState, ItemModule };\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const items = Object.values(data.ItemModule).map((item) => ({\r\n        title: item.desc,\r\n        description: art(path.join(__dirname, 'templates/user.art'), {\r\n            poster: item.video.cover,\r\n            source: item.video.playAddr,\r\n            useIframe,\r\n            id: item.id,\r\n        }),\r\n        author: item.nickname,\r\n        pubDate: parseDate(item.createTime, 'X'),\r\n        link: `${baseUrl}/@${item.author}/video/${item.id}`,\r\n        category: item.textExtra.map((t) => `#${t.hashtagName}`),\r\n    }));\r\n\r\n    return {\r\n        title: data.SharingMetaState.value['og:title'],\r\n        description: data.SharingMetaState.value['og:description'],\r\n        image: data.SharingMetaState.value['og:image'],\r\n        link: `${baseUrl}/${user}`,\r\n        item: items,\r\n        language: data.lang,\r\n    };\r\n}\r\n"],"mappings":"2dAUA,MAAM,EAAU,yBAEH,EAAe,CACxB,KAAM,uBACN,WAAY,CAAC,gBACb,QAAS,+BACT,WAAY,CAAE,KAAM,uBAAwB,OAAQ,0IACpD,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,oBACT,OAAQ,gBAGhB,KAAM,OACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAM,UAAW,EAAI,IAAI,QAC3B,EAAY,EAAe,GAE3B,EAAO,MAAM,EAAM,OACrB,eAAe,IACf,SAAY,CACR,IAAM,EAAU,MAAM,IAChB,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,MAAM,EAAK,KAAK,GAAG,EAAQ,GAAG,IAAQ,CAClC,UAAW,iBAEf,IAAM,EAAa,MAAM,EAAK,aAAe,OAAO,YACpD,MAAM,EAAQ,QAEd,IAAM,EAAO,EAAW,WAAW,KAC7B,EAAmB,EAAW,iBAC9B,EAAa,EAAW,WAE9B,MAAO,CAAE,OAAM,mBAAkB,eAErC,EAAO,MAAM,YACb,IAGE,EAAQ,OAAO,OAAO,EAAK,YAAY,IAAK,IAAU,CACxD,MAAO,EAAK,KACZ,YAAa,EAAI,EAAA,KAAA,EAAA,+BAA4C,CACzD,OAAQ,EAAK,MAAM,MACnB,OAAQ,EAAK,MAAM,SACnB,YACA,GAAI,EAAK,KAEb,OAAQ,EAAK,SACb,QAAS,EAAU,EAAK,WAAY,KACpC,KAAM,GAAG,EAAQ,IAAI,EAAK,OAAO,SAAS,EAAK,KAC/C,SAAU,EAAK,UAAU,IAAK,GAAM,IAAI,EAAE,kBAG9C,MAAO,CACH,MAAO,EAAK,iBAAiB,MAAM,YACnC,YAAa,EAAK,iBAAiB,MAAM,kBACzC,MAAO,EAAK,iBAAiB,MAAM,YACnC,KAAM,GAAG,EAAQ,GAAG,IACpB,KAAM,EACN,SAAU,EAAK"}