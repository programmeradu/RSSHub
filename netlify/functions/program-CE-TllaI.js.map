{"version":3,"file":"program-CE-TllaI.js","names":[],"sources":["../../lib/routes/iqilu/program.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/v/:category{.+}?',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'sdws/sdxwlb' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 30;\r\n\r\n    const rootUrl = 'http://v.iqilu.com';\r\n    const currentUrl = new URL(category, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    let items = $('#jmzhanshi1 dl')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const a = item.find('a').first();\r\n            const image = item.find('img').first();\r\n\r\n            item.find('dd').last().remove();\r\n\r\n            return {\r\n                title: a.prop('title'),\r\n                link: a.prop('href'),\r\n                description: art(path.join(__dirname, 'templates/description.art'), {\r\n                    image: {\r\n                        src: image.prop('src'),\r\n                        alt: image.prop('alt'),\r\n                    },\r\n                }),\r\n                pubDate: parseDate(\r\n                    item\r\n                        .find('dd')\r\n                        .last()\r\n                        .text()\r\n                        .match(/(\\d{4}-\\d{2}-\\d{2})/)[1]\r\n                ),\r\n                itunes_item_image: image.prop('src'),\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                item.title = content('div.vtitle').text();\r\n                item.enclosure_url = content('#copy_mp4text').prop('value');\r\n                item.enclosure_type = item.enclosure_url ? `video/${item.enclosure_url.split(/\\./).pop()}` : undefined;\r\n\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    image: {\r\n                        src: item.itunes_item_image,\r\n                        alt: item.title,\r\n                    },\r\n                    video: {\r\n                        src: item.enclosure_url,\r\n                        type: item.enclosure_type,\r\n                    },\r\n                    description: content('div.vinfo').text().trim(),\r\n                });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const icon = new URL($('link[rel=\"icon\"]').prop('href'), rootUrl).href;\r\n    const author = $('div.host_pic dl dd a')\r\n        .toArray()\r\n        .map((a) => $(a).text())\r\n        .join('/');\r\n\r\n    return {\r\n        item: items,\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image: $('div.s_logo img').prop('src'),\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"keywords\"]').prop('content'),\r\n        author,\r\n        itunes_author: author,\r\n        itunes_category: 'News',\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,oBACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,eAAkB,EAAI,IAAI,QACvC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,qBACV,EAAa,IAAI,IAAI,EAAU,GAAS,KAExC,CAAE,KAAM,GAAa,MAAM,EAAI,GAE/B,EAAI,EAAK,GAEX,EAAQ,EAAE,kBACT,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAI,EAAK,KAAK,KAAK,QACnB,EAAQ,EAAK,KAAK,OAAO,QAI/B,OAFA,EAAK,KAAK,MAAM,OAAO,SAEhB,CACH,MAAO,EAAE,KAAK,SACd,KAAM,EAAE,KAAK,QACb,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,CACH,IAAK,EAAM,KAAK,OAChB,IAAK,EAAM,KAAK,UAGxB,QAAS,EACL,EACK,KAAK,MACL,OACA,OACA,MAAM,uBAAuB,IAEtC,kBAAmB,EAAM,KAAK,UAI1C,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GAkBrB,MAhBA,GAAK,MAAQ,EAAQ,cAAc,OACnC,EAAK,cAAgB,EAAQ,iBAAiB,KAAK,SACnD,EAAK,eAAiB,EAAK,cAAgB,SAAS,EAAK,cAAc,MAAM,MAAM,QAAU,IAAA,GAE7F,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACtE,MAAO,CACH,IAAK,EAAK,kBACV,IAAK,EAAK,OAEd,MAAO,CACH,IAAK,EAAK,cACV,KAAM,EAAK,gBAEf,YAAa,EAAQ,aAAa,OAAO,SAGtC,MAKnB,IAAM,EAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,QAAS,GAAS,KAC5D,EAAS,EAAE,wBACZ,UACA,IAAK,GAAM,EAAE,GAAG,QAChB,KAAK,KAEV,MAAO,CACH,KAAM,EACN,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,EAAE,QAAQ,KAAK,QACzB,MAAO,EAAE,kBAAkB,KAAK,OAChC,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,SACA,cAAe,EACf,gBAAiB,OACjB,WAAY"}