{"version":3,"file":"utils-BrGisCrd.js","names":["ConfigNotFoundError","got","cache"],"sources":["../../lib/routes/javdb/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport { Cookie, CookieJar } from 'tough-cookie';\r\n\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nconst allowDomain = new Set(['javdb.com', 'javdb36.com', 'javdb007.com', 'javdb521.com']);\r\n\r\nconst ProcessItems = async (ctx, currentUrl, title) => {\r\n    const domain = ctx.req.query('domain') ?? 'javdb.com';\r\n    const url = new URL(currentUrl, `https://${domain}`);\r\n    if (!config.feature.allow_user_supply_unsafe_domain && !allowDomain.has(url.hostname)) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n\r\n    const rootUrl = `https://${domain}`;\r\n\r\n    const cookieJar = new CookieJar();\r\n\r\n    if (config.javdb.session) {\r\n        const cookie = Cookie.fromJSON({\r\n            key: '_jdb_session',\r\n            value: config.javdb.session,\r\n            domain,\r\n            path: '/',\r\n        });\r\n        cookie && cookieJar.setCookie(cookie, rootUrl);\r\n    }\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: url.href,\r\n        cookieJar,\r\n        headers: {\r\n            'User-Agent': config.trueUA,\r\n        },\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    $('.tags, .tag-can-play, .over18-modal').remove();\r\n\r\n    let items = $('div.item')\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 20)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.find('.video-title').text(),\r\n                link: `${rootUrl}${item.find('.box').attr('href')}`,\r\n                pubDate: parseDate(item.find('.meta').text()),\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                    cookieJar,\r\n                    headers: {\r\n                        'User-Agent': config.trueUA,\r\n                    },\r\n                });\r\n\r\n                const content = load(detailResponse.data);\r\n\r\n                item.enclosure_type = 'application/x-bittorrent';\r\n                item.enclosure_url = content('#magnets-content button[data-clipboard-text]').first().attr('data-clipboard-text');\r\n\r\n                content('icon').remove();\r\n                content('#modal-review-watched, #modal-comment-warning, #modal-save-list').remove();\r\n                content('.review-buttons, .copy-to-clipboard, .preview-video-container, .play-button').remove();\r\n\r\n                content('.preview-images img').each(function () {\r\n                    content(this).removeAttr('data-src');\r\n                    content(this).attr('src', content(this).parent().attr('href'));\r\n                });\r\n\r\n                item.category = content('.panel-block .value a')\r\n                    .toArray()\r\n                    .map((v) => content(v).text());\r\n                item.author = content('.panel-block .value').last().parent().find('.value a').first().text();\r\n                item.description = content('.cover-container, .column-video-cover').html() + content('.movie-panel-info').html() + content('#magnets-content').html() + content('.preview-images').html();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const htmlTitle = $('title').text();\r\n    const subject = htmlTitle.includes('|') ? htmlTitle.split('|')[0] : '';\r\n\r\n    return {\r\n        title: subject === '' ? title : `${subject} - ${title}`,\r\n        link: url.href,\r\n        item: items,\r\n    };\r\n};\r\n\r\nexport default { ProcessItems };\r\n"],"mappings":"qWAQA,MAAM,EAAc,IAAI,IAAI,CAAC,YAAa,cAAe,eAAgB,iBAEnE,EAAe,MAAO,EAAK,EAAY,IAAU,CACnD,IAAM,EAAS,EAAI,IAAI,MAAM,WAAa,YACpC,EAAM,IAAI,IAAI,EAAY,WAAW,KAC3C,GAAI,CAAC,EAAO,QAAQ,iCAAmC,CAAC,EAAY,IAAI,EAAI,UACxE,MAAM,IAAIA,EAAoB,mFAGlC,IAAM,EAAU,WAAW,IAErB,EAAY,IAAI,EAEtB,GAAI,EAAO,MAAM,QAAS,CACtB,IAAM,EAAS,EAAO,SAAS,CAC3B,IAAK,eACL,MAAO,EAAO,MAAM,QACpB,SACA,KAAM,MAEV,GAAU,EAAU,UAAU,EAAQ,GAG1C,IAAM,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,EAAI,KACT,YACA,QAAS,CACL,aAAc,EAAO,UAIvB,EAAI,EAAK,EAAS,MAExB,EAAE,uCAAuC,SAEzC,IAAI,EAAQ,EAAE,YACT,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAC5E,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,KAAK,gBAAgB,OACjC,KAAM,GAAG,IAAU,EAAK,KAAK,QAAQ,KAAK,UAC1C,QAAS,EAAU,EAAK,KAAK,SAAS,WAIlD,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAMD,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,KACV,YACA,QAAS,CACL,aAAc,EAAO,UAIvB,EAAU,EAAK,EAAe,MAoBpC,MAlBA,GAAK,eAAiB,2BACtB,EAAK,cAAgB,EAAQ,gDAAgD,QAAQ,KAAK,uBAE1F,EAAQ,QAAQ,SAChB,EAAQ,mEAAmE,SAC3E,EAAQ,+EAA+E,SAEvF,EAAQ,uBAAuB,KAAK,UAAY,CAC5C,EAAQ,MAAM,WAAW,YACzB,EAAQ,MAAM,KAAK,MAAO,EAAQ,MAAM,SAAS,KAAK,WAG1D,EAAK,SAAW,EAAQ,yBACnB,UACA,IAAK,GAAM,EAAQ,GAAG,QAC3B,EAAK,OAAS,EAAQ,uBAAuB,OAAO,SAAS,KAAK,YAAY,QAAQ,OACtF,EAAK,YAAc,EAAQ,yCAAyC,OAAS,EAAQ,qBAAqB,OAAS,EAAQ,oBAAoB,OAAS,EAAQ,mBAAmB,OAE5K,MAKnB,IAAM,EAAY,EAAE,SAAS,OACvB,EAAU,EAAU,SAAS,KAAO,EAAU,MAAM,KAAK,GAAK,GAEpE,MAAO,CACH,MAAO,IAAY,GAAK,EAAQ,GAAG,EAAQ,KAAK,IAChD,KAAM,EAAI,KACV,KAAM,IAId,IAAA,EAAe,CAAE"}