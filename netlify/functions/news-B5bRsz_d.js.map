{"version":3,"file":"news-B5bRsz_d.js","names":["route: Route","initialData: Promise<InitialData>","cache","ofetch","list"],"sources":["../../lib/routes/hypergryph/arknights/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport * as cheerio from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\n\r\ntype NewsItem = {\r\n    cid: string;\r\n    tab: string;\r\n    sticky: boolean;\r\n    title: string;\r\n    author: string;\r\n    displayTime: number;\r\n    cover: string;\r\n    extraCover: string;\r\n    brief: string;\r\n};\r\n\r\ntype InitialData = {\r\n    LATEST: {\r\n        list: NewsItem[];\r\n        total: number;\r\n        end: boolean;\r\n        map: Record<string, NewsItem[]>;\r\n    };\r\n    ANNOUNCEMENT: {\r\n        list: NewsItem[];\r\n        total: number;\r\n        end: boolean;\r\n        map: Record<string, NewsItem[]>;\r\n    };\r\n    ACTIVITY: {\r\n        list: NewsItem[];\r\n        total: number;\r\n        end: boolean;\r\n        map: Record<string, NewsItem[]>;\r\n    };\r\n    NEWS: {\r\n        list: NewsItem[];\r\n        total: number;\r\n        end: boolean;\r\n        map: Record<string, NewsItem[]>;\r\n    };\r\n};\r\n\r\nconst parseList = (list: NewsItem[]) =>\r\n    list.map((item) => ({\r\n        title: item.title,\r\n        author: item.author,\r\n        description: item.brief.trim().replaceAll('\\n', '<br>'),\r\n        link: `https://ak.hypergryph.com/news/${item.cid}`,\r\n        pubDate: parseDate(item.displayTime, 'X'),\r\n    }));\r\n\r\nexport const route: Route = {\r\n    path: '/arknights/news/:group?',\r\n    categories: ['game'],\r\n    example: '/hypergryph/arknights/news',\r\n    parameters: { group: '分组，默认为 `ALL`' },\r\n    radar: [\r\n        {\r\n            source: ['ak-conf.hypergryph.com/news'],\r\n        },\r\n    ],\r\n    name: '明日方舟 - 游戏公告与新闻',\r\n    maintainers: ['Astrian'],\r\n    handler,\r\n    url: 'ak-conf.hypergryph.com/news',\r\n    description: `\r\n| 全部 | 最新   | 公告         | 活动     | 新闻 |\r\n| ---- | ------ | ------------ | -------- | ---- |\r\n| ALL  | LATEST | ANNOUNCEMENT | ACTIVITY | NEWS |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { group = 'ALL' } = ctx.req.param();\r\n\r\n    const initialData: Promise<InitialData> = await cache.tryGet(\r\n        'hypergryph:arknights:news',\r\n        async () => {\r\n            const response = await ofetch('https://ak.hypergryph.com/news');\r\n            const $ = cheerio.load(response);\r\n            const renderData = JSON.parse(\r\n                $('script:contains(\"initialData\")')\r\n                    .first()\r\n                    .text()\r\n                    .match(/self\\.__next_f\\.push\\((.+)\\)/)?.[1] ?? ''\r\n            );\r\n            return JSON.parse(renderData[1].slice(2))[3].initialData as InitialData;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const list = group === 'ALL' ? Object.values(initialData).flatMap(({ list }) => parseList(list)) : parseList(initialData[group].list);\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch(item.link);\r\n                const $ = cheerio.load(response);\r\n\r\n                const description = $('div > div > div > div > div > div > div:nth-child(4)');\r\n                item.description = description.length ? description.html() : item.description;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: '《明日方舟》游戏公告与新闻',\r\n        link: 'https://ak.hypergryph.com/news',\r\n        item: items,\r\n        language: 'zh-cn',\r\n    };\r\n}\r\n"],"mappings":"+TA8CA,MAAM,EAAa,GACf,EAAK,IAAK,IAAU,CAChB,MAAO,EAAK,MACZ,OAAQ,EAAK,OACb,YAAa,EAAK,MAAM,OAAO,WAAW;EAAM,QAChD,KAAM,kCAAkC,EAAK,MAC7C,QAAS,EAAU,EAAK,YAAa,QAGhCA,EAAe,CACxB,KAAM,0BACN,WAAY,CAAC,QACb,QAAS,6BACT,WAAY,CAAE,MAAO,gBACrB,MAAO,CACH,CACI,OAAQ,CAAC,iCAGjB,KAAM,iBACN,YAAa,CAAC,WACd,UACA,IAAK,8BACL,YAAa;;;qDAMjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,QAAQ,OAAU,EAAI,IAAI,QAE5BC,EAAoC,MAAMC,EAAM,OAClD,4BACA,SAAY,CACR,IAAM,EAAW,MAAMC,EAAO,kCACxB,EAAI,EAAQ,KAAK,GACjB,EAAa,KAAK,MACpB,EAAE,kCACG,QACA,OACA,MAAM,kCAAkC,IAAM,IAEvD,OAAO,KAAK,MAAM,EAAW,GAAG,MAAM,IAAI,GAAG,aAEjD,EAAO,MAAM,YACb,IAGE,EAAO,IAAU,MAAQ,OAAO,OAAO,GAAa,SAAS,CAAE,KAAA,KAAW,EAAUC,IAAS,EAAU,EAAY,GAAO,MAE1H,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNF,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAMC,EAAO,EAAK,MAC7B,EAAI,EAAQ,KAAK,GAEjB,EAAc,EAAE,wDAGtB,MAFA,GAAK,YAAc,EAAY,OAAS,EAAY,OAAS,EAAK,YAE3D,MAKnB,MAAO,CACH,MAAO,gBACP,KAAM,iCACN,KAAM,EACN,SAAU"}