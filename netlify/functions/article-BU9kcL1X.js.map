{"version":3,"file":"article-BU9kcL1X.js","names":["route: Route","cache","ofetch"],"sources":["../../lib/routes/69shu/article.ts"],"sourcesContent":["import { load } from 'cheerio';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport type { Route, DataItem } from '@/types';\r\n\r\nexport const route: Route = {\r\n    path: '/article/:id',\r\n    name: '章节',\r\n    url: 'www.69shuba.cx',\r\n    maintainers: ['eternasuno'],\r\n    example: '/69shu/article/47117',\r\n    parameters: { id: '小说 id, 可在对应小说页 URL 中找到' },\r\n    categories: ['reading'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.69shuba.cx/book/:id.htm'],\r\n            target: '/article/:id',\r\n        },\r\n    ],\r\n    handler: async (ctx) => {\r\n        const { id } = ctx.req.param();\r\n        const link = `https://www.69shuba.cx/book/${id}.htm`;\r\n        const $ = load(await get(link));\r\n\r\n        const item = await Promise.all(\r\n            $('.qustime li>a')\r\n                .toArray()\r\n                .map((chapter) => createItem(chapter.attribs.href))\r\n        );\r\n\r\n        return {\r\n            title: $('h1>a').text(),\r\n            description: $('.navtxt>p:first-of-type').text(),\r\n            link,\r\n            item,\r\n            image: $('.bookimg2>img').attr('src'),\r\n            author: $('.booknav2>p:first-of-type>a').text(),\r\n            language: 'zh-cn',\r\n        };\r\n    },\r\n};\r\n\r\nconst createItem = (url: string) =>\r\n    cache.tryGet(url, async () => {\r\n        const $ = load(await get(url));\r\n        const { articleid, chapterid, chaptername } = parseObject(/bookinfo\\s?=\\s?{[\\S\\s]+?}/, $('head>script:not([src])').text());\r\n        const decryptionMap = parseObject(/_\\d+\\s?=\\s?{[\\S\\s]+?}/, $('.txtnav+script').text());\r\n\r\n        return {\r\n            title: chaptername,\r\n            description: decrypt($('.txtnav').html() || '', articleid, chapterid, decryptionMap),\r\n            link: url,\r\n        };\r\n    }) as Promise<DataItem>;\r\n\r\nconst get = async (url: string, encoding = 'gbk') => new TextDecoder(encoding).decode(await ofetch(url, { responseType: 'arrayBuffer' }));\r\n\r\nconst parseObject = (reg: RegExp, str: string): Record<string, string> => {\r\n    const obj = {};\r\n    const match = reg.exec(str);\r\n    if (match) {\r\n        for (const line of match[0].matchAll(/(\\w+):\\s?[\"']?([\\S\\s]+?)[\"']?[\\n,}]/g)) {\r\n            obj[line[1]] = line[2];\r\n        }\r\n    }\r\n\r\n    return obj;\r\n};\r\n\r\nconst decrypt = (txt: string, articleid: string, chapterid: string, decryptionMap: Record<string, string>) => {\r\n    if (!txt || txt.length < 10) {\r\n        return txt;\r\n    }\r\n\r\n    const lineMap = {};\r\n    const articleKey = Number(articleid) + 3_061_711;\r\n    const chapterKey = Number(chapterid) + 3_421_001;\r\n    for (const key of Object.keys(decryptionMap)) {\r\n        lineMap[(Number(key) ^ chapterKey) - articleKey] = (Number(decryptionMap[key]) ^ chapterKey) - articleKey;\r\n    }\r\n\r\n    return txt\r\n        .replaceAll(/\\u2003|\\n/g, '')\r\n        .split('<br><br>')\r\n        .flatMap((line, index, array) => (lineMap[index] ? array[lineMap[index]] : line).split('<br>'))\r\n        .slice(1, -2)\r\n        .join('<br><br>');\r\n};\r\n"],"mappings":"8PAKA,MAAaA,EAAe,CACxB,KAAM,eACN,KAAM,KACN,IAAK,iBACL,YAAa,CAAC,cACd,QAAS,uBACT,WAAY,CAAE,GAAI,0BAClB,WAAY,CAAC,WACb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,+BACT,OAAQ,iBAGhB,QAAS,KAAO,IAAQ,CACpB,GAAM,CAAE,MAAO,EAAI,IAAI,QACjB,EAAO,+BAA+B,EAAG,MACzC,EAAI,EAAK,MAAM,EAAI,IAEnB,EAAO,MAAM,QAAQ,IACvB,EAAE,iBACG,UACA,IAAK,GAAY,EAAW,EAAQ,QAAQ,QAGrD,MAAO,CACH,MAAO,EAAE,QAAQ,OACjB,YAAa,EAAE,2BAA2B,OAC1C,OACA,OACA,MAAO,EAAE,iBAAiB,KAAK,OAC/B,OAAQ,EAAE,+BAA+B,OACzC,SAAU,WAKhB,EAAc,GAChBC,EAAM,OAAO,EAAK,SAAY,CAC1B,IAAM,EAAI,EAAK,MAAM,EAAI,IACnB,CAAE,YAAW,YAAW,eAAgB,EAAY,4BAA6B,EAAE,0BAA0B,QAC7G,EAAgB,EAAY,wBAAyB,EAAE,kBAAkB,QAE/E,MAAO,CACH,MAAO,EACP,YAAa,EAAQ,EAAE,WAAW,QAAU,GAAI,EAAW,EAAW,GACtE,KAAM,KAIZ,EAAM,MAAO,EAAa,EAAW,QAAU,IAAI,YAAY,GAAU,OAAO,MAAMC,EAAO,EAAK,CAAE,aAAc,iBAElH,GAAe,EAAa,IAAwC,CACtE,IAAM,EAAM,GACN,EAAQ,EAAI,KAAK,GACvB,GAAI,EACA,IAAK,IAAM,KAAQ,EAAM,GAAG,SAAS,wCACjC,EAAI,EAAK,IAAM,EAAK,GAI5B,OAAO,GAGL,GAAW,EAAa,EAAmB,EAAmB,IAA0C,CAC1G,GAAI,CAAC,GAAO,EAAI,OAAS,GACrB,OAAO,EAGX,IAAM,EAAU,GACV,EAAa,OAAO,GAAa,QACjC,EAAa,OAAO,GAAa,QACvC,IAAK,IAAM,KAAO,OAAO,KAAK,GAC1B,GAAS,OAAO,GAAO,GAAc,IAAe,OAAO,EAAc,IAAQ,GAAc,EAGnG,OAAO,EACF,WAAW,aAAc,IACzB,MAAM,YACN,SAAS,EAAM,EAAO,KAAW,EAAQ,GAAS,EAAM,EAAQ,IAAU,GAAM,MAAM,SACtF,MAAM,EAAG,IACT,KAAK"}