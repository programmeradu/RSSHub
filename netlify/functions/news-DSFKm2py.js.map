{"version":3,"file":"news-DSFKm2py.js","names":["cache","got"],"sources":["../../lib/routes/kcna/utils.ts","../../lib/routes/kcna/news.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\n\r\nconst rootUrl = 'http://www.kcna.kp';\r\n\r\nconst parseJucheDate = (dateString) => {\r\n    if (!dateString) {\r\n        return null;\r\n    }\r\n\r\n    // https://en.wikipedia.org/wiki/Juche_calendar\r\n    const dateMatch = dateString.match(/(\\d+)\\D(\\d+)\\D(\\d+)/);\r\n    const [jucheYear, month, day] = dateMatch ? dateMatch.slice(1) : [null, null, null];\r\n    if (jucheYear && month && day) {\r\n        const year = Number.parseInt(jucheYear, 10) + 1911;\r\n        return parseDate(`${year}-${month}-${day}`, 'YYYY-M-D');\r\n    }\r\n    return null;\r\n};\r\n\r\nconst fixDesc = ($, elem) => {\r\n    // <nobr><span className='fSpecCs'>???</span></nobr> => <b>???</b>\r\n    const $elem = $(elem);\r\n    $elem.find('.fSpecCs').each((_, item) => {\r\n        if (item.parent.name === 'nobr') {\r\n            $(item).unwrap();\r\n        }\r\n        item.name = 'b';\r\n        item.attribs = {};\r\n    });\r\n    return elem.html();\r\n};\r\n\r\nconst fetchPhoto = (ctx, url) =>\r\n    cache.tryGet(url, async () => {\r\n        const res = await got(url);\r\n        const $ = load(res.data);\r\n        let html = '';\r\n        $('.content img').each((_, item) => {\r\n            const src = item.attribs.src;\r\n            if (src) {\r\n                html += html ? `<br><img src=\"${src}\">` : `<img src=\"${src}\">`;\r\n            }\r\n        });\r\n        return html;\r\n    });\r\n\r\nconst fetchVideo = (ctx, url) =>\r\n    cache.tryGet(url, async () => {\r\n        const res = await got(url);\r\n        const $ = load(res.data);\r\n        const js = $('script[type=\"text/javascript\"]:not([src])').html();\r\n        let sources = js.match(/<[^>]*source[^>]+src[^>]+>/g);\r\n        sources = sources && sources.map((item) => item.replaceAll(\"'\", '\"').replaceAll(/src=\"([^\"]+)\"/g, `src=\"${rootUrl}$1\"`));\r\n        return `<video controls preload=\"metadata\">${sources.join('\\n')}</video>`;\r\n    });\r\n\r\nexport { parseJucheDate, fixDesc, fetchPhoto, fetchVideo };\r\n","import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport pMap from 'p-map';\r\nimport { art } from '@/utils/render';\r\nimport { fixDesc, fetchPhoto, fetchVideo } from './utils';\r\nimport path from 'node:path';\r\nimport sanitizeHtml from 'sanitize-html';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nexport const route: Route = {\r\n    path: '/:lang/:category?',\r\n    categories: ['traditional-media'],\r\n    example: '/kcna/en',\r\n    parameters: { lang: 'Language, refer to the table below', category: 'Category, refer to the table below' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.kcna.kp/:lang', 'www.kcna.kp/:lang/category/articles/q/1ee9bdb7186944f765208f34ecfb5407.kcmsf', 'www.kcna.kp/:lang/category/articles.kcmsf'],\r\n            target: '/:lang',\r\n        },\r\n    ],\r\n    name: 'News',\r\n    maintainers: ['Rongronggg9'],\r\n    handler,\r\n    description: `| Language | 조선어 | English | 中国语 | Русский | Español | 日本語 |\r\n| -------- | ------ | ------- | ------ | ------- | ------- | ------ |\r\n| \\`:lang\\`  | \\`kp\\`   | \\`en\\`    | \\`cn\\`   | \\`ru\\`    | \\`es\\`    | \\`jp\\`   |\r\n\r\n| Category                                                         | \\`:category\\`                        |\r\n| ---------------------------------------------------------------- | ---------------------------------- |\r\n| WPK General Secretary **Kim Jong Un**'s Revolutionary Activities | \\`54c0ca4ca013a92cc9cf95bd4004c61a\\` |\r\n| Latest News (default)                                            | \\`1ee9bdb7186944f765208f34ecfb5407\\` |\r\n| Top News                                                         | \\`5394b80bdae203fadef02522cfb578c0\\` |\r\n| Home News                                                        | \\`b2b3bcc1b0a4406ab0c36e45d5db58db\\` |\r\n| Documents                                                        | \\`a8754921399857ebdbb97a98a1e741f5\\` |\r\n| World                                                            | \\`593143484cf15d48ce85c26139582395\\` |\r\n| Society-Life                                                     | \\`93102e5a735d03979bc58a3a7aefb75a\\` |\r\n| External                                                         | \\`0f98b4623a3ef82aeea78df45c423fd0\\` |\r\n| News Commentary                                                  | \\`12c03a49f7dbe829bceea8ac77088c21\\` |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { lang, category = '1ee9bdb7186944f765208f34ecfb5407' } = ctx.req.param();\r\n\r\n    const rootUrl = 'http://www.kcna.kp';\r\n    const pageUrl = `${rootUrl}/${lang}/category/articles/q/${category}.kcmsf`;\r\n\r\n    const response = await got(pageUrl);\r\n    const $ = load(response.data);\r\n\r\n    // fix <nobr><span class=\"fSpecCs\">???</span></nobr>\r\n    const title = sanitizeHtml($('head > title').text(), { allowedTags: [], allowedAttributes: {} });\r\n\r\n    const list = $('.article-link li a')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            const dateElem = item.find('.publish-time');\r\n            const dateString = dateElem.text().match(/\\d+\\.\\d+\\.\\d+/);\r\n            dateElem.remove();\r\n            return {\r\n                title: item.text(),\r\n                link: rootUrl + item.attr('href'),\r\n                pubDate: timezone(parseDate(dateString[0]), +9),\r\n            };\r\n        });\r\n\r\n    // avoid being IP-banned\r\n    // if being banned, 103.35.255.254 (the last hop before www.kcna.kp - 175.45.176.71) will drop the packet\r\n    // verify that with `mtr www.kcna.kp -Tz`\r\n    const items = await pMap(\r\n        list,\r\n        (item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await got(item.link);\r\n                const $ = load(response.data);\r\n                item.title = $('article-main-title').text() || item.title;\r\n\r\n                const dateElem = $('.publish-time');\r\n                const dateString = dateElem.text().match(/\\d+\\.\\d+\\.\\d+/);\r\n                dateElem.remove();\r\n                item.pubDate = dateString ? timezone(parseDate(dateString[0]), +9) : item.pubDate;\r\n\r\n                const description = fixDesc($, $('.article-content-body .content-wrapper'));\r\n\r\n                // add picture and video\r\n                const media = $('.media-icon a')\r\n                    .toArray()\r\n                    .map((elem) => rootUrl + elem.attribs.href);\r\n                let photo, video;\r\n                await Promise.all(\r\n                    media.map(async (medium) => {\r\n                        if (medium.includes('/photo/')) {\r\n                            photo = await fetchPhoto(ctx, medium);\r\n                        } else if (medium.includes('/video/')) {\r\n                            video = await fetchVideo(ctx, medium);\r\n                        }\r\n                    })\r\n                );\r\n\r\n                item.description = art(path.join(__dirname, 'templates/news.art'), { description, photo, video });\r\n\r\n                return item;\r\n            }),\r\n        { concurrency: 3 }\r\n    );\r\n\r\n    return {\r\n        title,\r\n        link: pageUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"4jBAKA,MAiBA,GAAA,EAAA,IAAA,YAUI,OAPA,EAAA,KAAA,YAAA,MAAA,EAAA,IAAA,CACI,EAAA,OAAA,OAAA,QAAA,EAAA,GAAA,SAGA,EAAA,KAAA,IACA,EAAA,QAAA,KAEJ,EAAA,QAGJ,GAAA,EAAA,IAAA,EAAA,OAAA,EAAA,SAAA,mCAWQ,OANA,EAAA,gBAAA,MAAA,EAAA,IAAA,qBAEI,IAAA,GAAA,EAAA,iBAAA,EAAA,IAAA,aAAA,EAAA,OAIJ,IAGR,GAAA,EAAA,IAAA,EAAA,OAAA,EAAA,SAAA,+HAOQ,MADA,GAAA,GAAA,EAAA,IAAA,GAAA,EAAA,WAAA,IAAA,KAAA,WAAA,iBAAA,+BACA,sCAAA,EAAA,KAAA;GAAA,YC3CK,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,qBACb,QAAS,WACT,WAAY,CAAE,KAAM,qCAAsC,SAAU,sCACpE,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,oBAAqB,+EAAgF,6CAC9G,OAAQ,WAGhB,KAAM,OACN,YAAa,CAAC,eACd,UACA,YAAa,y2CAiBjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAM,WAAW,oCAAuC,EAAI,IAAI,QAElE,EAAU,qBACV,EAAU,GAAG,EAAQ,GAAG,EAAK,uBAAuB,EAAS,QAE7D,EAAW,MAAM,EAAI,GACrB,EAAI,EAAK,EAAS,MAGlB,EAAQ,EAAa,EAAE,gBAAgB,OAAQ,CAAE,YAAa,GAAI,kBAAmB,KAErF,EAAO,EAAE,sBACV,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GACT,IAAM,EAAW,EAAK,KAAK,iBACrB,EAAa,EAAS,OAAO,MAAM,iBAEzC,OADA,EAAS,SACF,CACH,MAAO,EAAK,OACZ,KAAM,EAAU,EAAK,KAAK,QAC1B,QAAS,EAAS,EAAU,EAAW,IAAK,MAOlD,EAAQ,MAAM,EAChB,EACC,GACG,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAM,EAAI,EAAK,MAC1B,EAAI,EAAK,EAAS,MACxB,EAAK,MAAQ,EAAE,sBAAsB,QAAU,EAAK,MAEpD,IAAM,EAAW,EAAE,iBACb,EAAa,EAAS,OAAO,MAAM,iBACzC,EAAS,SACT,EAAK,QAAU,EAAa,EAAS,EAAU,EAAW,IAAK,GAAM,EAAK,QAE1E,IAAM,EAAc,EAAQ,EAAG,EAAE,2CAG3B,EAAQ,EAAE,iBACX,UACA,IAAK,GAAS,EAAU,EAAK,QAAQ,MACtC,EAAO,EAaX,OAZA,MAAM,QAAQ,IACV,EAAM,IAAI,KAAO,IAAW,CACpB,EAAO,SAAS,WAChB,EAAQ,MAAM,EAAW,EAAK,GACvB,EAAO,SAAS,aACvB,EAAQ,MAAM,EAAW,EAAK,OAK1C,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,+BAA4C,CAAE,cAAa,QAAO,UAElF,IAEf,CAAE,YAAa,IAGnB,MAAO,CACH,QACA,KAAM,EACN,KAAM"}