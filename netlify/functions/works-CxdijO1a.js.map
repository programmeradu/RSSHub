{"version":3,"file":"works-CxdijO1a.js","names":["route: Route","ConfigNotFoundError","cache","data","ofetch"],"sources":["../../lib/routes/skeb/works.ts"],"sourcesContent":["import { Data, DataItem, Route } from '@/types';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nimport { baseUrl, processWork } from './utils';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\n\r\nexport const route: Route = {\r\n    path: '/works/:username',\r\n    categories: ['picture'],\r\n    example: '/skeb/works/@brm2_1925',\r\n    parameters: { username: 'Skeb Username with @' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'SKEB_BEARER_TOKEN',\r\n                optional: false,\r\n                description: '在瀏覽器開發者工具（F12）的主控台中輸入 `localStorage.getItem(\"token\")` 獲取',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Creator Works',\r\n    maintainers: ['SnowAgar25'],\r\n    handler,\r\n    radar: [\r\n        {\r\n            title: 'Creator Works',\r\n            source: ['skeb.jp/:username'],\r\n            target: '/works/:username',\r\n        },\r\n    ],\r\n    description: 'Get the latest works of a specific creator on Skeb',\r\n};\r\n\r\nasync function handler(ctx): Promise<Data> {\r\n    const username = ctx.req.param('username');\r\n\r\n    if (!config.skeb || !config.skeb.bearerToken) {\r\n        throw new ConfigNotFoundError('Skeb works RSS is disabled due to the lack of <a href=\"https://docs.rsshub.app/deploy/config#route-specific-configurations\">relevant config</a>');\r\n    }\r\n\r\n    const url = `${baseUrl}/api/users/${username.replace('@', '')}/works`;\r\n\r\n    const items = await cache.tryGet(url, async () => {\r\n        const fetchData = async (retryCount = 0, maxRetries = 3) => {\r\n            const data = await ofetch(url, {\r\n                retry: 0,\r\n                method: 'GET',\r\n                query: { role: 'creator', sort: 'date', offset: '0' },\r\n                headers: {\r\n                    'User-Agent': config.ua,\r\n                    Cookie: `request_key=${cache.get('skeb:request_key')}`,\r\n                    Authorization: `Bearer ${config.skeb.bearerToken}`,\r\n                },\r\n            }).catch((error) => {\r\n                if (retryCount >= maxRetries) {\r\n                    throw new Error('Max retries reached');\r\n                }\r\n                const newRequestKey = error.response?._data?.match(/request_key=(.*?);/)?.[1];\r\n                if (newRequestKey) {\r\n                    cache.set('skeb:request_key', newRequestKey);\r\n                    return fetchData(retryCount + 1, maxRetries);\r\n                }\r\n                throw error;\r\n            });\r\n            return data;\r\n        };\r\n\r\n        const data = await fetchData();\r\n\r\n        if (!data || !Array.isArray(data)) {\r\n            throw new Error('Invalid data received from API');\r\n        }\r\n\r\n        return data.map((item) => processWork(item)).filter(Boolean);\r\n    });\r\n\r\n    return {\r\n        title: `Skeb - ${username}'s Works`,\r\n        link: `${baseUrl}/${username}`,\r\n        item: items as DataItem[],\r\n    };\r\n}\r\n"],"mappings":"sZAOA,MAAaA,EAAe,CACxB,KAAM,mBACN,WAAY,CAAC,WACb,QAAS,yBACT,WAAY,CAAE,SAAU,wBACxB,SAAU,CACN,cAAe,CACX,CACI,KAAM,oBACN,SAAU,GACV,YAAa,6DAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,gBACN,YAAa,CAAC,cACd,UACA,MAAO,CACH,CACI,MAAO,gBACP,OAAQ,CAAC,qBACT,OAAQ,qBAGhB,YAAa,sDAGjB,eAAe,EAAQ,EAAoB,CACvC,IAAM,EAAW,EAAI,IAAI,MAAM,YAE/B,GAAI,CAAC,EAAO,MAAQ,CAAC,EAAO,KAAK,YAC7B,MAAM,IAAIC,EAAoB,mJAGlC,IAAM,EAAM,GAAG,EAAQ,aAAa,EAAS,QAAQ,IAAK,IAAI,QAExD,EAAQ,MAAMC,EAAM,OAAO,EAAK,SAAY,CAC9C,IAAM,EAAY,MAAO,EAAa,EAAG,EAAa,IAAM,CACxD,IAAMC,EAAO,MAAMC,EAAO,EAAK,CAC3B,MAAO,EACP,OAAQ,MACR,MAAO,CAAE,KAAM,UAAW,KAAM,OAAQ,OAAQ,KAChD,QAAS,CACL,aAAc,EAAO,GACrB,OAAQ,eAAeF,EAAM,IAAI,sBACjC,cAAe,UAAU,EAAO,KAAK,iBAE1C,MAAO,GAAU,CAChB,GAAI,GAAc,EACd,MAAU,MAAM,uBAEpB,IAAM,EAAgB,EAAM,UAAU,OAAO,MAAM,wBAAwB,GAC3E,GAAI,EAEA,OADA,EAAM,IAAI,mBAAoB,GACvB,EAAU,EAAa,EAAG,GAErC,MAAM,IAEV,OAAOC,GAGL,EAAO,MAAM,IAEnB,GAAI,CAAC,GAAQ,CAAC,MAAM,QAAQ,GACxB,MAAU,MAAM,kCAGpB,OAAO,EAAK,IAAK,GAAS,EAAY,IAAO,OAAO,WAGxD,MAAO,CACH,MAAO,UAAU,EAAS,UAC1B,KAAM,GAAG,EAAQ,GAAG,IACpB,KAAM"}