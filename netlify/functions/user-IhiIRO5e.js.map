{"version":3,"file":"user-IhiIRO5e.js","names":["route: Route","starMap: Record<number, string>","headers: Record<string, string>","ofetch"],"sources":["../../lib/routes/dianping/user.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/user/:id',\r\n    categories: ['shopping'],\r\n    example: '/dianping/user/808259118',\r\n    parameters: { id: 'User id，打开网页端从 URL 中获取，在 `/member/:id` 中' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'DIANPING_COOKIE',\r\n                optional: false,\r\n                description: '大众点评的 Cookie',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['dianping.com/member/:id', 'm.dianping.com/userprofile/:id'],\r\n            target: '/dianping/user/:id',\r\n        },\r\n    ],\r\n    name: '用户动态',\r\n    maintainers: ['pseudoyu'],\r\n    handler,\r\n    description: '获取用户点评、签到、攻略等动态。',\r\n};\r\n\r\nfunction addPictureAndVideo(item: any) {\r\n    let content = '';\r\n    content += item.pictureList ? item.pictureList.map((ele: any) => `<img src=\"${ele.picUrl}\" />`).join('<br>') : '';\r\n    content += item.videoUrl ? `<img src=\"${item.videoUrl}\" />` : '';\r\n    return content;\r\n}\r\n\r\nconst starMap: Record<number, string> = {\r\n    0: '无',\r\n    10: '一星',\r\n    20: '二星',\r\n    30: '三星',\r\n    35: '三星半',\r\n    40: '四星',\r\n    45: '四星半',\r\n    50: '五星',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n\r\n    const userAgent = 'Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1';\r\n    const userPage = `https://m.dianping.com/userprofile/${id}`;\r\n    const cookie = config.dianping.cookie;\r\n\r\n    const headers: Record<string, string> = {\r\n        'User-Agent': userAgent,\r\n        Referer: userPage,\r\n    };\r\n\r\n    if (cookie) {\r\n        headers.Cookie = cookie;\r\n    }\r\n\r\n    const pageResponse = await ofetch(userPage, {\r\n        headers,\r\n    });\r\n\r\n    const nickNameReg = /window\\.nickName = \"(.*?)\"/g;\r\n    const nickName = nickNameReg.exec(pageResponse as string)?.[1];\r\n\r\n    const response = await ofetch(`https://m.dianping.com/member/ajax/NobleUserFeeds?userId=${id}`, {\r\n        headers,\r\n    });\r\n\r\n    const data = response.data;\r\n\r\n    const items = data.map((item: any) => {\r\n        let link = '';\r\n        let title = '';\r\n        let content = '';\r\n\r\n        const poi = item.poi ? `地点：<a href=\"http://www.dianping.com/shop/${item.poi.shopId}\">${item.poi.name} - ${item.poi.regionCategory}</a>` : '';\r\n        const poiName = item.poi ? item.poi.name : '';\r\n\r\n        switch (item.feedType) {\r\n            case 1101:\r\n                // 签到成功\r\n                link = `https://m.dianping.com/ugcdetail/${item.mainId}?sceneType=0&bizType=3`;\r\n                content = poi;\r\n                title = `签到成功: ${poiName} `;\r\n\r\n                break;\r\n\r\n            case 101:\r\n                // 对商户、地点发布点评\r\n                link = `https://m.dianping.com/ugcdetail/${item.mainId}?sceneType=0&bizType=1`;\r\n                content = item.content.replaceAll(/\\n+/g, '<br>') + '<br>';\r\n                content += `评分：${starMap[item.star]}<br>`;\r\n                content += poi + '<br>';\r\n                content += addPictureAndVideo(item);\r\n                title = `发布点评: ${poiName}`;\r\n\r\n                break;\r\n\r\n            case 131:\r\n                // 发布点评\r\n                link = `https://m.dianping.com/ugcdetail/${item.mainId}?sceneType=0&bizType=29`;\r\n                content = item.content.replaceAll(/\\n+/g, '<br>') + '<br>';\r\n                content += addPictureAndVideo(item);\r\n                title = `发布点评: ${content}`;\r\n\r\n                break;\r\n\r\n            case 4208:\r\n                // 发布攻略\r\n                link = `https://m.dianping.com/cityinsight/${item.mainId}`;\r\n                content = item.content.replaceAll(/\\n+/g, '<br>') + '<br>';\r\n                content += poi + '<br>';\r\n                content += item.moreDesc ? `<a href='${link}'>${item.moreDesc}</a><br>` : '';\r\n                content += addPictureAndVideo(item);\r\n                title = `发布攻略: ${poiName}`;\r\n\r\n                break;\r\n\r\n            default:\r\n            // Do nothing\r\n        }\r\n\r\n        return {\r\n            description: content,\r\n            title,\r\n            link,\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `大众点评 - ${nickName}`,\r\n        link: userPage,\r\n        description: `大众点评 - ${nickName}`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"4LAIA,MAAaA,EAAe,CACxB,KAAM,YACN,WAAY,CAAC,YACb,QAAS,2BACT,WAAY,CAAE,GAAI,4CAClB,SAAU,CACN,cAAe,CACX,CACI,KAAM,kBACN,SAAU,GACV,YAAa,iBAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,0BAA2B,kCACpC,OAAQ,uBAGhB,KAAM,OACN,YAAa,CAAC,YACd,UACA,YAAa,oBAGjB,SAAS,EAAmB,EAAW,CACnC,IAAI,EAAU,GAGd,MAFA,IAAW,EAAK,YAAc,EAAK,YAAY,IAAK,GAAa,aAAa,EAAI,OAAO,OAAO,KAAK,QAAU,GAC/G,GAAW,EAAK,SAAW,aAAa,EAAK,SAAS,MAAQ,GACvD,EAGX,MAAMC,EAAkC,CACpC,EAAG,IACH,GAAI,KACJ,GAAI,KACJ,GAAI,KACJ,GAAI,MACJ,GAAI,KACJ,GAAI,MACJ,GAAI,MAGR,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MAGnB,EAAW,sCAAsC,IACjD,EAAS,EAAO,SAAS,OAEzBC,EAAkC,CACpC,aAAc,0IACd,QAAS,GAGT,IACA,EAAQ,OAAS,GAGrB,IAAM,EAAe,MAAMC,EAAO,EAAU,CACxC,YAGE,EAAc,8BACd,EAAW,EAAY,KAAK,KAA0B,GAEtD,EAAW,MAAMA,EAAO,4DAA4D,IAAM,CAC5F,YAGE,EAAO,EAAS,KAEhB,EAAQ,EAAK,IAAK,GAAc,CAClC,IAAI,EAAO,GACP,EAAQ,GACR,EAAU,GAER,EAAM,EAAK,IAAM,4CAA4C,EAAK,IAAI,OAAO,IAAI,EAAK,IAAI,KAAK,KAAK,EAAK,IAAI,eAAe,MAAQ,GACpI,EAAU,EAAK,IAAM,EAAK,IAAI,KAAO,GAE3C,OAAQ,EAAK,SAAb,CACI,IAAK,MAED,EAAO,oCAAoC,EAAK,OAAO,wBACvD,EAAU,EACV,EAAQ,SAAS,EAAQ,GAEzB,MAEJ,IAAK,KAED,EAAO,oCAAoC,EAAK,OAAO,wBACvD,EAAU,EAAK,QAAQ,WAAW,OAAQ,QAAU,OACpD,GAAW,MAAM,EAAQ,EAAK,MAAM,MACpC,GAAW,EAAM,OACjB,GAAW,EAAmB,GAC9B,EAAQ,SAAS,IAEjB,MAEJ,IAAK,KAED,EAAO,oCAAoC,EAAK,OAAO,yBACvD,EAAU,EAAK,QAAQ,WAAW,OAAQ,QAAU,OACpD,GAAW,EAAmB,GAC9B,EAAQ,SAAS,IAEjB,MAEJ,IAAK,MAED,EAAO,sCAAsC,EAAK,SAClD,EAAU,EAAK,QAAQ,WAAW,OAAQ,QAAU,OACpD,GAAW,EAAM,OACjB,GAAW,EAAK,SAAW,YAAY,EAAK,IAAI,EAAK,SAAS,UAAY,GAC1E,GAAW,EAAmB,GAC9B,EAAQ,SAAS,IAEjB,MAEJ,SAIJ,MAAO,CACH,YAAa,EACb,QACA,UAIR,MAAO,CACH,MAAO,UAAU,IACjB,KAAM,EACN,YAAa,UAAU,IACvB,KAAM"}