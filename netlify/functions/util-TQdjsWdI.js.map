{"version":3,"file":"util-TQdjsWdI.js","names":[],"sources":["../../lib/routes/app-sales/util.ts"],"sourcesContent":["import { type DataItem } from '@/types';\r\n\r\nimport { art } from '@/utils/render';\r\nimport ofetch from '@/utils/ofetch';\r\n\r\nimport { type CheerioAPI, type Cheerio, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport path from 'node:path';\r\n\r\nconst baseUrl: string = 'https://www.app-sales.net';\r\n\r\n/**\r\n * Formats price change information into a standardized tag\r\n * @param priceOld - Old price\r\n * @param priceNew - New price\r\n * @param priceDisco - Discount\r\n * @returns Formatted price change tag string. Returns empty string when no new price exists.\r\n */\r\nconst formatPriceChangeTag = (priceOld: string, priceNew: string, priceDisco: string): string => (priceNew?.trim() ? `[${[priceOld && `${priceOld}â†’`, priceNew, priceDisco && ` ${priceDisco}`].filter(Boolean).join('')}]` : '');\r\n\r\n/**\r\n * Processes DOM elements into structured data items\r\n * @param $ - CheerioAPI instance\r\n * @param selector - CSS selector for target elements\r\n * @returns Parsed data items array.\r\n */\r\nconst processItems = ($: CheerioAPI, selector: string): DataItem[] =>\r\n    $(selector)\r\n        .toArray()\r\n        .map((el) => {\r\n            const $el: Cheerio<Element> = $(el);\r\n\r\n            const appName: string = $el.find('p.app-name').text()?.trim();\r\n            const appDev: string = $el.find('p.app-dev').text()?.trim();\r\n            const appNote: string = $el.find('p.app-dev').next('p')?.text()?.trim() ?? '';\r\n            const rating: string = $el.find('p.rating').contents().last().text()?.trim();\r\n            const downloads: string = $el.find('p.downloads').contents().last().text()?.trim();\r\n            const bookmarks: string = $el.find('p.bookmarks').contents().last().text()?.trim();\r\n            const priceNew: string = $el.find('div.price-new').text()?.trim();\r\n            const priceOld: string = $el.find('div.price-old').text()?.trim();\r\n            const priceDisco: string = $el.find('div.price-disco').text()?.trim();\r\n\r\n            const isHot: boolean = $el.hasClass('sale-hot');\r\n            const isFree: boolean = priceNew?.toLocaleUpperCase() === 'FREE';\r\n\r\n            const title: string = `${appName} ${formatPriceChangeTag(priceOld, priceNew, priceDisco)}`;\r\n            const image: string | undefined = $el.find('div.app-icon img').attr('src');\r\n            const linkUrl: string | undefined = $el.find('div.sale-list-action a').attr('href');\r\n            const description: string | undefined = art(path.join(__dirname, 'templates/description.art'), {\r\n                images: image\r\n                    ? [\r\n                          {\r\n                              alt: `${appName}-${appDev}`,\r\n                              src: image,\r\n                          },\r\n                      ]\r\n                    : undefined,\r\n                appName,\r\n                appDev,\r\n                appNote,\r\n                rating,\r\n                downloads,\r\n                bookmarks,\r\n                priceNew,\r\n                priceOld,\r\n                priceDisco,\r\n                linkUrl,\r\n            });\r\n            const categories: string[] = [isHot ? 'Hot' : undefined, isFree ? 'Free' : undefined].filter(Boolean) as string[];\r\n            const authors: DataItem['author'] = appDev;\r\n            const guid: string = [appName, appDev, rating, downloads, bookmarks, priceNew].filter(Boolean).join('-');\r\n\r\n            const processedItem: DataItem = {\r\n                title: title.trim(),\r\n                description,\r\n                link: linkUrl,\r\n                category: categories,\r\n                author: authors,\r\n                guid,\r\n                id: guid,\r\n                content: {\r\n                    html: description,\r\n                    text: description,\r\n                },\r\n                image,\r\n                banner: image,\r\n            };\r\n\r\n            return processedItem;\r\n        });\r\n\r\n/**\r\n * Retrieves pagination URLs from page navigation\r\n * @param $ - CheerioAPI instance\r\n * @param targetUrl - Base URL for relative path resolution\r\n * @returns Array of absolute pagination URLs.\r\n */\r\nconst getAvailablePageUrls = ($: CheerioAPI, targetUrl: string): string[] =>\r\n    $('ul.pagination li.waves-effect a')\r\n        .slice(0, -1)\r\n        .toArray()\r\n        .filter((el) => {\r\n            const $el: Cheerio<Element> = $(el);\r\n\r\n            return $el.attr('href');\r\n        })\r\n        .map((el) => {\r\n            const $el: Cheerio<Element> = $(el);\r\n\r\n            return new URL($el.attr('href') as string, targetUrl).href;\r\n        });\r\n\r\n/**\r\n * Aggregates items across paginated pages\r\n * @param $ - Initial page CheerioAPI instance\r\n * @param selector - Target element CSS selector\r\n * @param targetUrl - Base URL for pagination requests\r\n * @param country - Country ID for request headers\r\n * @param limit - Maximum number of items to return\r\n * @returns Aggregated items array within specified limit.\r\n */\r\nconst fetchItems = async ($: CheerioAPI, selector: string, targetUrl: string, country: string, limit: number): Promise<DataItem[]> => {\r\n    const initialItems = processItems($, selector);\r\n    if (initialItems.length >= limit) {\r\n        return initialItems.slice(0, limit);\r\n    }\r\n\r\n    /**\r\n     * Recursive helper function to process paginated URLs\r\n     *\r\n     * @param remainingUrls - Array of URLs yet to be processed\r\n     * @param aggregated - Accumulator for collected items\r\n     *\r\n     * @returns Promise resolving to aggregated items\r\n     */\r\n    const processPage = async (remainingUrls: string[], aggregated: DataItem[]): Promise<DataItem[]> => {\r\n        if (aggregated.length >= limit || remainingUrls.length === 0) {\r\n            return aggregated.slice(0, limit);\r\n        }\r\n\r\n        const [currentUrl, ...restUrls] = remainingUrls;\r\n\r\n        try {\r\n            const response = await ofetch(currentUrl, {\r\n                headers: {\r\n                    Cookie: `countryId=${country};`,\r\n                },\r\n            });\r\n            const pageItems = processItems(load(response), selector);\r\n            const newItems = [...aggregated, ...pageItems];\r\n\r\n            return newItems.length >= limit ? newItems.slice(0, limit) : processPage(restUrls, newItems);\r\n        } catch {\r\n            return processPage(restUrls, aggregated);\r\n        }\r\n    };\r\n\r\n    return await processPage(getAvailablePageUrls($, targetUrl), initialItems);\r\n};\r\n\r\nexport { baseUrl, fetchItems };\r\n"],"mappings":"qOASA,MAAM,EAAkB,4BASlB,GAAwB,EAAkB,EAAkB,IAAgC,GAAU,OAAS,IAAI,CAAC,GAAY,GAAG,EAAS,GAAI,EAAU,GAAc,IAAI,KAAc,OAAO,SAAS,KAAK,IAAI,GAAK,GAQxN,GAAgB,EAAe,IACjC,EAAE,GACG,UACA,IAAK,GAAO,CACT,IAAM,EAAwB,EAAE,GAE1B,EAAkB,EAAI,KAAK,cAAc,QAAQ,OACjD,EAAiB,EAAI,KAAK,aAAa,QAAQ,OAC/C,EAAkB,EAAI,KAAK,aAAa,KAAK,MAAM,QAAQ,QAAU,GACrE,EAAiB,EAAI,KAAK,YAAY,WAAW,OAAO,QAAQ,OAChE,EAAoB,EAAI,KAAK,eAAe,WAAW,OAAO,QAAQ,OACtE,EAAoB,EAAI,KAAK,eAAe,WAAW,OAAO,QAAQ,OACtE,EAAmB,EAAI,KAAK,iBAAiB,QAAQ,OACrD,EAAmB,EAAI,KAAK,iBAAiB,QAAQ,OACrD,EAAqB,EAAI,KAAK,mBAAmB,QAAQ,OAEzD,EAAiB,EAAI,SAAS,YAC9B,EAAkB,GAAU,sBAAwB,OAEpD,EAAgB,GAAG,EAAQ,GAAG,EAAqB,EAAU,EAAU,KACvE,EAA4B,EAAI,KAAK,oBAAoB,KAAK,OAC9D,EAA8B,EAAI,KAAK,0BAA0B,KAAK,QACtE,EAAkC,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAC3F,OAAQ,EACF,CACI,CACI,IAAK,GAAG,EAAQ,GAAG,IACnB,IAAK,IAGb,IAAA,GACN,UACA,SACA,UACA,SACA,YACA,YACA,WACA,WACA,aACA,YAEE,EAAuB,CAAC,EAAQ,MAAQ,IAAA,GAAW,EAAS,OAAS,IAAA,IAAW,OAAO,SACvF,EAA8B,EAC9B,EAAe,CAAC,EAAS,EAAQ,EAAQ,EAAW,EAAW,GAAU,OAAO,SAAS,KAAK,KAE9F,EAA0B,CAC5B,MAAO,EAAM,OACb,cACA,KAAM,EACN,SAAU,EACV,OAAQ,EACR,OACA,GAAI,EACJ,QAAS,CACL,KAAM,EACN,KAAM,GAEV,QACA,OAAQ,GAGZ,OAAO,IASb,GAAwB,EAAe,IACzC,EAAE,mCACG,MAAM,EAAG,IACT,UACA,OAAQ,GAAO,CACZ,IAAM,EAAwB,EAAE,GAEhC,OAAO,EAAI,KAAK,UAEnB,IAAK,GAAO,CACT,IAAM,EAAwB,EAAE,GAEhC,OAAO,IAAI,IAAI,EAAI,KAAK,QAAmB,GAAW,OAY5D,EAAa,MAAO,EAAe,EAAkB,EAAmB,EAAiB,IAAuC,CAClI,IAAM,EAAe,EAAa,EAAG,GACrC,GAAI,EAAa,QAAU,EACvB,OAAO,EAAa,MAAM,EAAG,GAWjC,IAAM,EAAc,MAAO,EAAyB,IAAgD,CAChG,GAAI,EAAW,QAAU,GAAS,EAAc,SAAW,EACvD,OAAO,EAAW,MAAM,EAAG,GAG/B,GAAM,CAAC,EAAY,GAAG,GAAY,EAElC,GAAI,CACA,IAAM,EAAW,MAAM,EAAO,EAAY,CACtC,QAAS,CACL,OAAQ,aAAa,EAAQ,MAG/B,EAAY,EAAa,EAAK,GAAW,GACzC,EAAW,CAAC,GAAG,EAAY,GAAG,GAEpC,OAAO,EAAS,QAAU,EAAQ,EAAS,MAAM,EAAG,GAAS,EAAY,EAAU,QAC/E,CACJ,OAAO,EAAY,EAAU,KAIrC,OAAO,MAAM,EAAY,EAAqB,EAAG,GAAY"}