{"version":3,"file":"common-D7PrzxN0.js","names":["cache","got","matches: string[]","match: RegExpExecArray | null"],"sources":["../../lib/routes/sis001/common.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { DataItem } from '@/types';\r\nimport CryptoJS from 'crypto-js';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\n\r\nfunction getCookie(url: string): Promise<string> {\r\n    return cache.tryGet(\r\n        'sis001:cookie',\r\n        async () => {\r\n            const response = await got(url);\r\n            const rsp = response.data;\r\n\r\n            const regex = /toNumbers\\(\"([a-fA-F0-9]+)\"\\)/g;\r\n            const matches: string[] = [];\r\n            let match: RegExpExecArray | null;\r\n\r\n            while ((match = regex.exec(rsp)) !== null) {\r\n                matches.push(match[1]);\r\n            }\r\n\r\n            if (matches.length !== 3) {\r\n                return '';\r\n            }\r\n\r\n            const key = CryptoJS.enc.Hex.parse(matches[0]);\r\n            const iv = CryptoJS.enc.Hex.parse(matches[1]);\r\n            const encrypted = CryptoJS.enc.Hex.parse(matches[2]);\r\n\r\n            const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, { iv, padding: CryptoJS.pad.NoPadding });\r\n\r\n            return 'CeRaHigh1=' + decrypted.toString(CryptoJS.enc.Hex);\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n}\r\n\r\nasync function getThread(cookie: string, item: DataItem) {\r\n    const response = await got(item.link, { headers: { cookie } });\r\n    const $ = load(response.data);\r\n\r\n    item.guid = item.link?.replace(/^https?:\\/\\/.+?\\//, 'https://www.sis001.com/');\r\n    item.category = $('.posttags a')\r\n        .toArray()\r\n        .map((a) => $(a).text());\r\n    item.pubDate = timezone(\r\n        parseDate(\r\n            $('.postinfo')\r\n                .eq(0)\r\n                .text()\r\n                .match(/发表于 (.*)\\s*只看该作者/)[1],\r\n            'YYYY-M-D HH:mm'\r\n        ),\r\n        8\r\n    );\r\n    $('div[id^=postmessage_] table, fieldset, .posttags, strong font, span:empty').remove();\r\n    item.description =\r\n        $('div[id^=postmessage_]')\r\n            .eq(0)\r\n            .html()\r\n            ?.replaceAll('\\n', '')\r\n            .replaceAll(/\\u3000{2}.+?(((?:<br>){2})|(&nbsp;))/g, (str) => `<p>${str.replaceAll('<br>', '')}</p>`)\r\n            .replaceAll(/<p>\\u3000{6,}(.+?)<\\/p>/g, '<center><p style=\"text-align:center;\">$1</p></center>')\r\n            .replaceAll('&nbsp;', '')\r\n            .replace(/<br><br> +<br><br>/, '') + ($('.defaultpost .postattachlist').html() ?? '');\r\n    return item;\r\n}\r\n\r\nexport { getCookie, getThread };\r\n"],"mappings":"iTASA,SAAS,EAAU,EAA8B,CAC7C,OAAOA,EAAM,OACT,gBACA,SAAY,CACR,IAAM,EAAW,MAAMC,EAAI,GACrB,EAAM,EAAS,KAEf,EAAQ,iCACRC,EAAoB,GACtBC,EAEJ,MAAQ,EAAQ,EAAM,KAAK,MAAU,MACjC,EAAQ,KAAK,EAAM,IAGvB,GAAI,EAAQ,SAAW,EACnB,MAAO,GAGX,IAAM,EAAM,EAAS,IAAI,IAAI,MAAM,EAAQ,IACrC,EAAK,EAAS,IAAI,IAAI,MAAM,EAAQ,IACpC,EAAY,EAAS,IAAI,IAAI,MAAM,EAAQ,IAE3C,EAAY,EAAS,IAAI,QAAQ,CAAE,WAAY,GAAa,EAAK,CAAE,KAAI,QAAS,EAAS,IAAI,YAEnG,MAAO,aAAe,EAAU,SAAS,EAAS,IAAI,MAE1D,EAAO,MAAM,YACb,IAIR,eAAe,EAAU,EAAgB,EAAgB,CACrD,IAAM,EAAW,MAAMF,EAAI,EAAK,KAAM,CAAE,QAAS,CAAE,YAC7C,EAAI,EAAK,EAAS,MA0BxB,MAxBA,GAAK,KAAO,EAAK,MAAM,QAAQ,oBAAqB,2BACpD,EAAK,SAAW,EAAE,eACb,UACA,IAAK,GAAM,EAAE,GAAG,QACrB,EAAK,QAAU,EACX,EACI,EAAE,aACG,GAAG,GACH,OACA,MAAM,oBAAoB,GAC/B,kBAEJ,GAEJ,EAAE,6EAA6E,SAC/E,EAAK,YACD,EAAE,yBACG,GAAG,GACH,QACC,WAAW;EAAM,IAClB,WAAW,wCAA0C,GAAQ,MAAM,EAAI,WAAW,OAAQ,IAAI,OAC9F,WAAW,2BAA4B,yDACvC,WAAW,SAAU,IACrB,QAAQ,qBAAsB,KAAO,EAAE,gCAAgC,QAAU,IACnF"}