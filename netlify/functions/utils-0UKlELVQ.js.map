{"version":3,"file":"utils-0UKlELVQ.js","names":["ofetch"],"sources":["../../lib/routes/scmp/utils.ts"],"sourcesContent":["import { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport ofetch from '@/utils/ofetch';\r\n\r\nexport const renderHTML = (node) => {\r\n    if (!node) {\r\n        return '';\r\n    }\r\n    if (Array.isArray(node)) {\r\n        return node.map((n) => renderHTML(n)).join('');\r\n    }\r\n\r\n    switch (node.type) {\r\n        case 'a':\r\n            return `<a ${Object.keys(node.attribs)\r\n                .map((key) => `${key}=\"${node.attribs[key]}\"`)\r\n                .join(' ')}>${renderHTML(node.children)}</a>`;\r\n        case 'div':\r\n            return `<div ${\r\n                node.attribs\r\n                    ? Object.keys(node.attribs)\r\n                          .map((key) => `${key}=\"${node.attribs[key]}\"`)\r\n                          .join(' ')\r\n                    : ''\r\n            }>${renderHTML(node.children)}</div>`;\r\n        case 'blockquote-quote':\r\n            return `<blockquote>${renderHTML(node.children)}</blockquote>`;\r\n        case 'iframe':\r\n            return `<iframe ${Object.keys(node.attribs)\r\n                .map((key) => `${key}=\"${node.attribs[key]}\"`)\r\n                .join(' ')}></iframe>`;\r\n        case 'leading':\r\n        case 'img':\r\n            return `<figure><img ${\r\n                node.attribs\r\n                    ? Object.keys(node.attribs)\r\n                          .map((key) => `${key}=\"${node.attribs[key]}\"`)\r\n                          .join(' ')\r\n                    : `url=\"${node.url}\"` // for leading\r\n            }><figcaption>${node.attribs?.title ?? node.title}</figcaption></figure>`;\r\n        case 'em':\r\n        case 'h3':\r\n        case 'li':\r\n        case 'ol':\r\n        case 'ul':\r\n        case 'p':\r\n        case 'strong':\r\n        case 'u':\r\n            return `<${node.type}>${renderHTML(node.children)}</${node.type}>`;\r\n        case 'text':\r\n            return node.data;\r\n        case 'script':\r\n        case 'inline-ad-slot':\r\n        case 'inline-widget':\r\n        case 'track-viewed-percentage':\r\n            return '';\r\n        default:\r\n            return `Unhandled type: ${node.type} ${JSON.stringify(node)}`;\r\n    }\r\n};\r\n\r\nexport const parseItem = async (item) => {\r\n    const { _data: response, url } = await ofetch.raw(item.link);\r\n\r\n    if (new URL(url).hostname !== 'www.scmp.com') {\r\n        // e.g., https://multimedia.scmp.com/\r\n        return item;\r\n    }\r\n\r\n    const $ = load(response);\r\n\r\n    const nextData = JSON.parse($('script#__NEXT_DATA__').text());\r\n    const { article } = nextData.props.pageProps.payload.data;\r\n\r\n    // item.nextData = article;\r\n\r\n    item.summary = renderHTML(article.summary.json);\r\n    item.description = renderHTML(article.subHeadline.json) + renderHTML(article.images.find((i) => i.type === 'leading')) + renderHTML(article.body.json);\r\n    item.updated = parseDate(article.updatedDate, 'x');\r\n    item.category = [...new Set([...article.topics.map((t) => t.name), ...article.sections.flatMap((t) => t.value.map((v) => v.name)), ...article.keywords.map((k) => k?.split(', '))])];\r\n\r\n    // N.B. gallery in article is not rendered\r\n    // e.g., { type: 'div', attribs: { class: 'scmp-photo-gallery', 'data-gallery-nid': '3239409' }}\r\n    // from https://www.scmp.com/news/china/politics/article/3239355/li-keqiang-former-premier-china-dead\r\n\r\n    return item;\r\n};\r\n"],"mappings":"0IAIA,MAAa,EAAc,GAAS,CAChC,GAAI,CAAC,EACD,MAAO,GAEX,GAAI,MAAM,QAAQ,GACd,OAAO,EAAK,IAAK,GAAM,EAAW,IAAI,KAAK,IAG/C,OAAQ,EAAK,KAAb,CACI,IAAK,IACD,MAAO,MAAM,OAAO,KAAK,EAAK,SACzB,IAAK,GAAQ,GAAG,EAAI,IAAI,EAAK,QAAQ,GAAK,IAC1C,KAAK,KAAK,GAAG,EAAW,EAAK,UAAU,MAChD,IAAK,MACD,MAAO,QACH,EAAK,QACC,OAAO,KAAK,EAAK,SACZ,IAAK,GAAQ,GAAG,EAAI,IAAI,EAAK,QAAQ,GAAK,IAC1C,KAAK,KACV,GACT,GAAG,EAAW,EAAK,UAAU,QAClC,IAAK,mBACD,MAAO,eAAe,EAAW,EAAK,UAAU,eACpD,IAAK,SACD,MAAO,WAAW,OAAO,KAAK,EAAK,SAC9B,IAAK,GAAQ,GAAG,EAAI,IAAI,EAAK,QAAQ,GAAK,IAC1C,KAAK,KAAK,YACnB,IAAK,UACL,IAAK,MACD,MAAO,gBACH,EAAK,QACC,OAAO,KAAK,EAAK,SACZ,IAAK,GAAQ,GAAG,EAAI,IAAI,EAAK,QAAQ,GAAK,IAC1C,KAAK,KACV,QAAQ,EAAK,IAAI,GAC1B,eAAe,EAAK,SAAS,OAAS,EAAK,MAAM,wBACtD,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,IACL,IAAK,SACL,IAAK,IACD,MAAO,IAAI,EAAK,KAAK,GAAG,EAAW,EAAK,UAAU,IAAI,EAAK,KAAK,GACpE,IAAK,OACD,OAAO,EAAK,KAChB,IAAK,SACL,IAAK,iBACL,IAAK,gBACL,IAAK,0BACD,MAAO,GACX,QACI,MAAO,mBAAmB,EAAK,KAAK,GAAG,KAAK,UAAU,OAIrD,EAAY,KAAO,IAAS,CACrC,GAAM,CAAE,MAAO,EAAU,OAAQ,MAAMA,EAAO,IAAI,EAAK,MAEvD,GAAI,IAAI,IAAI,GAAK,WAAa,eAE1B,OAAO,EAGX,IAAM,EAAI,EAAK,GAET,EAAW,KAAK,MAAM,EAAE,wBAAwB,QAChD,CAAE,WAAY,EAAS,MAAM,UAAU,QAAQ,KAarD,MATA,GAAK,QAAU,EAAW,EAAQ,QAAQ,MAC1C,EAAK,YAAc,EAAW,EAAQ,YAAY,MAAQ,EAAW,EAAQ,OAAO,KAAM,GAAM,EAAE,OAAS,YAAc,EAAW,EAAQ,KAAK,MACjJ,EAAK,QAAU,EAAU,EAAQ,YAAa,KAC9C,EAAK,SAAW,CAAC,GAAG,IAAI,IAAI,CAAC,GAAG,EAAQ,OAAO,IAAK,GAAM,EAAE,MAAO,GAAG,EAAQ,SAAS,QAAS,GAAM,EAAE,MAAM,IAAK,GAAM,EAAE,OAAQ,GAAG,EAAQ,SAAS,IAAK,GAAM,GAAG,MAAM,UAMpK"}