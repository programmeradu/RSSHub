{"version":3,"file":"utils-Br76Bc7d.js","names":["ofetch","cache","response","$"],"sources":["../../lib/routes/jou/utils/index.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch'; // 使用ofetch库\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nasync function getItems(ctx, url, host, tableClass, timeStyleClass1, titleStyleClass, timeStyleClass2) {\r\n    const response = await ofetch(url).catch(() => null);\r\n    if (!response) {\r\n        return [];\r\n    }\r\n    const $ = load(response);\r\n\r\n    const list = $(`table.${tableClass} > tbody > tr[height=20]`)\r\n        .toArray()\r\n        .map((item) => {\r\n            const currentItem = $(item);\r\n            const item1 = currentItem.find('td:eq(1)');\r\n            const item2 = currentItem.find('td:eq(2)');\r\n            const link = new URL(item1.find('a').attr('href'), host).href;\r\n\r\n            return {\r\n                title: item1.find('a').attr('title'),\r\n                link,\r\n                pubDate: timezone(parseDate(item2.find(`.${timeStyleClass1}`).text(), 'YYYY-MM-DD'), +8),\r\n            };\r\n        });\r\n\r\n    const out = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch(item.link).catch(() => null);\r\n                if (!response || (response.status >= 300 && response.status < 400)) {\r\n                    // 响应为空或状态码表明发生了重定向\r\n                    return {\r\n                        ...item,\r\n                        description: '该通知无法直接预览，请点击原文链接↑查看',\r\n                    };\r\n                }\r\n                const $ = load(response);\r\n\r\n                item.title = $(`.${titleStyleClass}`).text();\r\n                const hasEmbeddedPDFScript = $('script:contains(\"showVsbpdfIframe\")').length > 0;\r\n\r\n                if (hasEmbeddedPDFScript) {\r\n                    item.description = '该通知无法直接预览，请点击原文链接↑查看';\r\n                } else {\r\n                    const contentHtml = $('.v_news_content').html();\r\n                    const $content = load(contentHtml);\r\n                    $content('a').each(function () {\r\n                        const a = $(this);\r\n                        const href = a.attr('href');\r\n                        if (href && !href.startsWith('http')) {\r\n                            a.attr('href', new URL(href, host).href);\r\n                        }\r\n                    });\r\n                    item.description = $content.html();\r\n                }\r\n                item.pubDate = timezone(parseDate($(`.${timeStyleClass2}`).text().replace('发布时间：', '')), +8);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return out;\r\n}\r\n\r\nexport { getItems };\r\n"],"mappings":"gPAMA,eAAe,EAAS,EAAK,EAAK,EAAM,EAAY,EAAiB,EAAiB,EAAiB,CACnG,IAAM,EAAW,MAAMA,EAAO,GAAK,UAAY,MAC/C,GAAI,CAAC,EACD,MAAO,GAEX,IAAM,EAAI,EAAK,GAET,EAAO,EAAE,SAAS,EAAW,2BAC9B,UACA,IAAK,GAAS,CACX,IAAM,EAAc,EAAE,GAChB,EAAQ,EAAY,KAAK,YACzB,EAAQ,EAAY,KAAK,YACzB,EAAO,IAAI,IAAI,EAAM,KAAK,KAAK,KAAK,QAAS,GAAM,KAEzD,MAAO,CACH,MAAO,EAAM,KAAK,KAAK,KAAK,SAC5B,OACA,QAAS,EAAS,EAAU,EAAM,KAAK,IAAI,KAAmB,OAAQ,cAAe,MAI3F,EAAM,MAAM,QAAQ,IACtB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAMC,EAAW,MAAMF,EAAO,EAAK,MAAM,UAAY,MACrD,GAAI,CAACE,GAAaA,EAAS,QAAU,KAAOA,EAAS,OAAS,IAE1D,MAAO,CACH,GAAG,EACH,YAAa,wBAGrB,IAAMC,EAAI,EAAKD,GAEf,EAAK,MAAQC,EAAE,IAAI,KAAmB,OACtC,IAAM,EAAuBA,EAAE,uCAAuC,OAAS,EAE/E,GAAI,EACA,EAAK,YAAc,2BAChB,CACH,IAAM,EAAcA,EAAE,mBAAmB,OACnC,EAAW,EAAK,GACtB,EAAS,KAAK,KAAK,UAAY,CAC3B,IAAM,EAAIA,EAAE,MACN,EAAO,EAAE,KAAK,QAChB,GAAQ,CAAC,EAAK,WAAW,SACzB,EAAE,KAAK,OAAQ,IAAI,IAAI,EAAM,GAAM,QAG3C,EAAK,YAAc,EAAS,OAIhC,MAFA,GAAK,QAAU,EAAS,EAAUA,EAAE,IAAI,KAAmB,OAAO,QAAQ,QAAS,KAAM,GAElF,MAKnB,OAAO"}