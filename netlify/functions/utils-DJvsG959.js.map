{"version":3,"file":"utils-DJvsG959.js","names":[],"sources":["../../lib/routes/yahoo/news/utils.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\n\r\nconst getArchive = async (region, limit, tag, providerId?) => {\r\n    const { data: response } = await got(\r\n        `https://${region}.news.yahoo.com/_td-news/api/resource/NCPListService;api=archive;ncpParams=${encodeURIComponent(\r\n            JSON.stringify({\r\n                query: {\r\n                    count: limit,\r\n                    // imageSizes: '220x128',\r\n                    start: 0,\r\n                    providerid: providerId,\r\n                    tag,\r\n                },\r\n            })\r\n        )}`\r\n    );\r\n    return response;\r\n};\r\n\r\nconst getList = async (region, listId) => {\r\n    const { data: response } = await got(`https://${region}.news.yahoo.com/_td-news/api/resource/StreamService;category=LISTID%3A${listId};useNCP=true`);\r\n    return response;\r\n};\r\n\r\nconst getCategories = (region, tryGet) =>\r\n    tryGet(`yahoo:${region}:categoryMap`, async () => {\r\n        const { PageStore } = await getStores(region, tryGet);\r\n\r\n        const { Col1: col1 } = PageStore.pagesConfigRaw.base.section.regions;\r\n        const { categoryMap } = col1.find((c) => c.name === 'ArchiveFilterBar').props;\r\n        for (const [key, value] of Object.entries(categoryMap)) {\r\n            categoryMap[key] = {\r\n                name: value,\r\n                yctMap: col1.find((c) => c.name === 'StreamContainerArchive').props.yctMap[key],\r\n            };\r\n        }\r\n\r\n        return categoryMap;\r\n    });\r\n\r\nconst getProviderList = (region, tryGet) =>\r\n    tryGet(`yahoo:${region}:providerList`, async () => {\r\n        const { ProviderListStore } = await getStores(region, tryGet);\r\n\r\n        return ProviderListStore.providerList.flatMap((list) =>\r\n            list.providers.map((provider) => ({\r\n                title: `${list.title} - ${provider.title}`,\r\n                key: provider.key,\r\n                link: new URL(provider.url, `https://${region}.news.yahoo.com`).href,\r\n            }))\r\n        );\r\n    });\r\n\r\nconst getStores = (region, tryGet) =>\r\n    tryGet(`yahoo:${region}:stores`, async () => {\r\n        const { data: response } = await got(`https://${region}.news.yahoo.com/archive`);\r\n        const $ = load(response);\r\n\r\n        const appData = JSON.parse(\r\n            $('script:contains(\"root.App.main\")')\r\n                .text()\r\n                .match(/root.App.main\\s+=\\s+({.+});/)?.[1] as string\r\n        );\r\n\r\n        return appData.context.dispatcher.stores;\r\n    });\r\n\r\nconst parseList = (region, response) =>\r\n    response.map((item) => ({\r\n        title: item.title,\r\n        link: item.url.startsWith('http') ? item.url : new URL(item.url, `https://${region}.news.yahoo.com`).href,\r\n        description: item.summary,\r\n        pubDate: parseDate(item.published_at, 'X'),\r\n    }));\r\n\r\nconst parseItem = (item, tryGet) =>\r\n    tryGet(item.link, async () => {\r\n        const { data: response } = await got(item.link);\r\n        const $ = load(response);\r\n\r\n        const ldJson = JSON.parse($('script[type=\"application/ld+json\"]').first().text());\r\n        const author = `${$('span.caas-author-byline-collapse').text()} @${$('span.caas-attr-provider').text()}`;\r\n        const body = $('.atoms');\r\n\r\n        body.find('noscript').remove();\r\n        // remove padding\r\n        body.find('.caas-figure-with-pb, .caas-img-container').each((_, ele) => {\r\n            const $ele = $(ele);\r\n            $ele.removeAttr('style');\r\n        });\r\n\r\n        body.find('img').each((_, ele) => {\r\n            const $ele = $(ele);\r\n            let dataSrc = $ele.data('src') as string;\r\n\r\n            if (dataSrc) {\r\n                const match = dataSrc.match(/.*--\\/.*--\\/(.*)/);\r\n                if (match?.[1]) {\r\n                    dataSrc = match?.[1];\r\n                }\r\n                $ele.attr('src', dataSrc);\r\n                $ele.removeAttr('data-src');\r\n            }\r\n        });\r\n        // fix blockquote iframe\r\n        body.find('.caas-iframe').each((_, ele) => {\r\n            const $ele = $(ele);\r\n            if ($ele.data('type') === 'youtube') {\r\n                const blockquoteSrc = $ele.find('blockquote').data('src') as string;\r\n                $ele.replaceWith(\r\n                    art(path.join(__dirname, '../templates/youtube.art'), {\r\n                        id: blockquoteSrc.split('/').pop()?.split('?')?.[0],\r\n                    })\r\n                );\r\n            }\r\n        });\r\n\r\n        item.description = body.html();\r\n        item.author = author;\r\n        item.category = ldJson.keywords;\r\n        item.pubDate = parseDate(ldJson.datePublished);\r\n        item.updated = parseDate(ldJson.dateModified);\r\n\r\n        return item;\r\n    });\r\n\r\nexport { getArchive, getList, getCategories, getProviderList, getStores, parseList, parseItem };\r\n"],"mappings":"oRAMA,MAAM,EAAa,MAAO,EAAQ,EAAO,EAAK,IAAgB,CAC1D,GAAM,CAAE,KAAM,GAAa,MAAM,EAC7B,WAAW,EAAO,6EAA6E,mBAC3F,KAAK,UAAU,CACX,MAAO,CACH,MAAO,EAEP,MAAO,EACP,WAAY,EACZ,aAKhB,OAAO,GAGL,EAAU,MAAO,EAAQ,IAAW,CACtC,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,WAAW,EAAO,wEAAwE,EAAO,eACtI,OAAO,GAGL,GAAiB,EAAQ,IAC3B,EAAO,SAAS,EAAO,cAAe,SAAY,CAC9C,GAAM,CAAE,aAAc,MAAM,EAAU,EAAQ,GAExC,CAAE,KAAM,GAAS,EAAU,eAAe,KAAK,QAAQ,QACvD,CAAE,eAAgB,EAAK,KAAM,GAAM,EAAE,OAAS,oBAAoB,MACxE,IAAK,GAAM,CAAC,EAAK,KAAU,OAAO,QAAQ,GACtC,EAAY,GAAO,CACf,KAAM,EACN,OAAQ,EAAK,KAAM,GAAM,EAAE,OAAS,0BAA0B,MAAM,OAAO,IAInF,OAAO,IAGT,GAAmB,EAAQ,IAC7B,EAAO,SAAS,EAAO,eAAgB,SAAY,CAC/C,GAAM,CAAE,qBAAsB,MAAM,EAAU,EAAQ,GAEtD,OAAO,EAAkB,aAAa,QAAS,GAC3C,EAAK,UAAU,IAAK,IAAc,CAC9B,MAAO,GAAG,EAAK,MAAM,KAAK,EAAS,QACnC,IAAK,EAAS,IACd,KAAM,IAAI,IAAI,EAAS,IAAK,WAAW,EAAO,kBAAkB,WAK1E,GAAa,EAAQ,IACvB,EAAO,SAAS,EAAO,SAAU,SAAY,CACzC,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,WAAW,EAAO,0BACjD,EAAI,EAAK,GAET,EAAU,KAAK,MACjB,EAAE,oCACG,OACA,MAAM,iCAAiC,IAGhD,OAAO,EAAQ,QAAQ,WAAW,SAGpC,GAAa,EAAQ,IACvB,EAAS,IAAK,IAAU,CACpB,MAAO,EAAK,MACZ,KAAM,EAAK,IAAI,WAAW,QAAU,EAAK,IAAM,IAAI,IAAI,EAAK,IAAK,WAAW,EAAO,kBAAkB,KACrG,YAAa,EAAK,QAClB,QAAS,EAAU,EAAK,aAAc,QAGxC,GAAa,EAAM,IACrB,EAAO,EAAK,KAAM,SAAY,CAC1B,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,EAAK,MACpC,EAAI,EAAK,GAET,EAAS,KAAK,MAAM,EAAE,sCAAsC,QAAQ,QACpE,EAAS,GAAG,EAAE,oCAAoC,OAAO,IAAI,EAAE,2BAA2B,SAC1F,EAAO,EAAE,UAyCf,OAvCA,EAAK,KAAK,YAAY,SAEtB,EAAK,KAAK,6CAA6C,MAAM,EAAG,IAAQ,CACpE,IAAM,EAAO,EAAE,GACf,EAAK,WAAW,WAGpB,EAAK,KAAK,OAAO,MAAM,EAAG,IAAQ,CAC9B,IAAM,EAAO,EAAE,GACX,EAAU,EAAK,KAAK,OAExB,GAAI,EAAS,CACT,IAAM,EAAQ,EAAQ,MAAM,oBACxB,IAAQ,KACR,EAAU,IAAQ,IAEtB,EAAK,KAAK,MAAO,GACjB,EAAK,WAAW,eAIxB,EAAK,KAAK,gBAAgB,MAAM,EAAG,IAAQ,CACvC,IAAM,EAAO,EAAE,GACf,GAAI,EAAK,KAAK,UAAY,UAAW,CACjC,IAAM,EAAgB,EAAK,KAAK,cAAc,KAAK,OACnD,EAAK,YACD,EAAI,EAAA,KAAA,EAAA,kCAAkD,CAClD,GAAI,EAAc,MAAM,KAAK,OAAO,MAAM,OAAO,SAMjE,EAAK,YAAc,EAAK,OACxB,EAAK,OAAS,EACd,EAAK,SAAW,EAAO,SACvB,EAAK,QAAU,EAAU,EAAO,eAChC,EAAK,QAAU,EAAU,EAAO,cAEzB"}