{"version":3,"file":"dt-Dmy56j8H.js","names":[],"sources":["../../lib/routes/yicai/dt.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst columns = {\r\n    article: 2,\r\n    report: 3,\r\n    visualization: 4,\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/dt/:column?/:category?',\r\n    categories: ['traditional-media'],\r\n    example: '/yicai/dt/article',\r\n    parameters: { column: '栏目，见下表，默认为文章', category: '分类，见下表，默认为全部' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'DT 财经',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `#### [文章](https://dt.yicai.com/article)\r\n\r\n| 分类     | ID         |\r\n| -------- | ---------- |\r\n| 全部     | article/0  |\r\n| 新流行   | article/31 |\r\n| 新趋势   | article/32 |\r\n| 商业黑马 | article/33 |\r\n| 新品     | article/34 |\r\n| 营销     | article/35 |\r\n| 大公司   | article/36 |\r\n| 城市生活 | article/38 |\r\n\r\n#### [报告](https://dt.yicai.com/report)\r\n\r\n| 分类       | ID        |\r\n| ---------- | --------- |\r\n| 全部       | report/0  |\r\n| 人群观念   | report/9  |\r\n| 人群行为   | report/22 |\r\n| 美妆个护   | report/23 |\r\n| 3C 数码    | report/24 |\r\n| 营销趋势   | report/25 |\r\n| 服饰鞋包   | report/27 |\r\n| 互联网     | report/28 |\r\n| 城市与居住 | report/29 |\r\n| 消费趋势   | report/30 |\r\n| 生活趋势   | report/37 |\r\n\r\n#### [可视化](https://dt.yicai.com/visualization)\r\n\r\n| 分类     | ID               |\r\n| -------- | ---------------- |\r\n| 全部     | visualization/0  |\r\n| 新流行   | visualization/39 |\r\n| 新趋势   | visualization/40 |\r\n| 商业黑马 | visualization/41 |\r\n| 新品     | visualization/42 |\r\n| 营销     | visualization/43 |\r\n| 大公司   | visualization/44 |\r\n| 城市生活 | visualization/45 |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { column = 'article', category = '0' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 30;\r\n\r\n    const rootUrl = 'https://dt.yicai.com';\r\n    const apiUrl = new URL('api/getNewsList', rootUrl).href;\r\n    const currentUrl = new URL(column, rootUrl).href;\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: {\r\n            page: 1,\r\n            rid: columns[column],\r\n            cid: category,\r\n            pageSize: limit,\r\n        },\r\n    });\r\n\r\n    let items = response.data.data.slice(0, limit).map((item) => {\r\n        const enclosureUrl = item.originVideo;\r\n        const enclosureExt = enclosureUrl.split(/\\./).pop();\r\n\r\n        return {\r\n            title: item.newstitle,\r\n            link: new URL(item.url, rootUrl).href,\r\n            description: art(path.join(__dirname, 'templates/description.art'), {\r\n                image: {\r\n                    src: item.originPic,\r\n                    alt: item.newstitle,\r\n                },\r\n                intro: item.newsnotes,\r\n            }),\r\n            author: item.creatername,\r\n            category: [item.channelrootname, item.channelname, item.NewsTypeName].filter(Boolean),\r\n            guid: `yicai-dt-${item.newsid}`,\r\n            pubDate: parseDate(item.utc_createdate),\r\n            updated: parseDate(item.utc_lastdate),\r\n            enclosure_url: enclosureUrl,\r\n            enclosure_type: enclosureUrl ? `${enclosureExt === 'mp4' ? 'video' : 'application'}/${enclosureExt}` : undefined,\r\n            upvotes: item.newsscore ?? 0,\r\n        };\r\n    });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                content('div.logintips').remove();\r\n\r\n                content('img').each((_, e) => {\r\n                    e = content(e);\r\n\r\n                    content(e).replaceWith(\r\n                        art(path.join(__dirname, 'templates/description.art'), {\r\n                            image: {\r\n                                src: e.prop('data-original') ?? e.prop('src'),\r\n                                alt: e.prop('alt'),\r\n                                width: e.prop('width'),\r\n                                height: e.prop('height'),\r\n                            },\r\n                        })\r\n                    );\r\n                });\r\n\r\n                item.description += art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: content('div.txt').html(),\r\n                });\r\n                item.author = content('div.authortime h3').text();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const title = $('title').text();\r\n    const image = $('div.logo a img').prop('src');\r\n    const icon = new URL($('link[rel=\"shortcut icon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: `${$(`a[data-cid=\"${category}\"]`).text()}${title}`,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"keywords\"]').prop('content'),\r\n        language: 'zh',\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"description\"]').prop('content'),\r\n        author: title.split(/_/).pop(),\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAM,EAAU,CACZ,QAAS,EACT,OAAQ,EACR,cAAe,GAGN,EAAe,CACxB,KAAM,0BACN,WAAY,CAAC,qBACb,QAAS,oBACT,WAAY,CAAE,OAAQ,eAAgB,SAAU,gBAChD,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,QACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;8BA2CjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,SAAS,UAAW,WAAW,KAAQ,EAAI,IAAI,QACjD,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,uBACV,EAAS,IAAI,IAAI,kBAAmB,GAAS,KAC7C,EAAa,IAAI,IAAI,EAAQ,GAAS,KAEtC,CAAE,KAAM,GAAa,MAAM,EAAI,EAAQ,CACzC,aAAc,CACV,KAAM,EACN,IAAK,EAAQ,GACb,IAAK,EACL,SAAU,KAId,EAAQ,EAAS,KAAK,KAAK,MAAM,EAAG,GAAO,IAAK,GAAS,CACzD,IAAM,EAAe,EAAK,YACpB,EAAe,EAAa,MAAM,MAAM,MAE9C,MAAO,CACH,MAAO,EAAK,UACZ,KAAM,IAAI,IAAI,EAAK,IAAK,GAAS,KACjC,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,CACH,IAAK,EAAK,UACV,IAAK,EAAK,WAEd,MAAO,EAAK,YAEhB,OAAQ,EAAK,YACb,SAAU,CAAC,EAAK,gBAAiB,EAAK,YAAa,EAAK,cAAc,OAAO,SAC7E,KAAM,YAAY,EAAK,SACvB,QAAS,EAAU,EAAK,gBACxB,QAAS,EAAU,EAAK,cACxB,cAAe,EACf,eAAgB,EAAe,GAAG,IAAiB,MAAQ,QAAU,cAAc,GAAG,IAAiB,IAAA,GACvG,QAAS,EAAK,WAAa,KAInC,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GAwBrB,OAtBA,EAAQ,iBAAiB,SAEzB,EAAQ,OAAO,MAAM,EAAG,IAAM,CAC1B,EAAI,EAAQ,GAEZ,EAAQ,GAAG,YACP,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACnD,MAAO,CACH,IAAK,EAAE,KAAK,kBAAoB,EAAE,KAAK,OACvC,IAAK,EAAE,KAAK,OACZ,MAAO,EAAE,KAAK,SACd,OAAQ,EAAE,KAAK,gBAM/B,EAAK,aAAe,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACvE,YAAa,EAAQ,WAAW,SAEpC,EAAK,OAAS,EAAQ,qBAAqB,OAEpC,MAKnB,GAAM,CAAE,KAAM,GAAoB,MAAM,EAAI,GAEtC,EAAI,EAAK,GAET,EAAQ,EAAE,SAAS,OACnB,EAAQ,EAAE,kBAAkB,KAAK,OACjC,EAAO,IAAI,IAAI,EAAE,6BAA6B,KAAK,QAAS,GAAS,KAE3E,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAE,eAAe,EAAS,KAAK,SAAS,IAClD,KAAM,EACN,YAAa,EAAE,yBAAyB,KAAK,WAC7C,SAAU,KACV,QACA,OACA,KAAM,EACN,SAAU,EAAE,4BAA4B,KAAK,WAC7C,OAAQ,EAAM,MAAM,KAAK,MACzB,WAAY"}