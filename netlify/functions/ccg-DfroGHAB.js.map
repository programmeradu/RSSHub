{"version":3,"file":"ccg-DfroGHAB.js","names":[],"sources":["../../lib/routes/ccg/index.ts"],"sourcesContent":["import { type Data, type DataItem, type Route, ViewType } from '@/types';\r\n\r\nimport { art } from '@/utils/render';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nimport { type CheerioAPI, type Cheerio, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport { type Context } from 'hono';\r\nimport path from 'node:path';\r\n\r\nexport const handler = async (ctx: Context): Promise<Data> => {\r\n    const { category = 'news' } = ctx.req.param();\r\n    const limit: number = Number.parseInt(ctx.req.query('limit') ?? '7', 10);\r\n\r\n    const baseUrl: string = 'http://www.ccg.org.cn';\r\n    const targetUrl: string = new URL(category, baseUrl).href;\r\n\r\n    const response = await ofetch(targetUrl);\r\n    const $: CheerioAPI = load(response);\r\n    const language = $('html').attr('lang') ?? 'zh';\r\n\r\n    let items: DataItem[] = [];\r\n\r\n    items = $('ul.huodong-list li')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((el): Element => {\r\n            const $el: Cheerio<Element> = $(el);\r\n\r\n            const title: string = $el.find('h5').text();\r\n            const image: string | undefined = $el.find('div.huodong-img img').attr('src');\r\n            const description: string | undefined = art(path.join(__dirname, 'templates/description.art'), {\r\n                images: image\r\n                    ? [\r\n                          {\r\n                              src: image,\r\n                              alt: title,\r\n                          },\r\n                      ]\r\n                    : undefined,\r\n                intro: $el.find('p').html(),\r\n            });\r\n            const pubDateStr: string | undefined = $el.find('span').text();\r\n            const linkUrl: string | undefined = $el.find('a').attr('href');\r\n            const upDatedStr: string | undefined = pubDateStr;\r\n\r\n            const processedItem: DataItem = {\r\n                title,\r\n                description,\r\n                pubDate: pubDateStr ? parseDate(pubDateStr, 'YYYY年M月D日') : undefined,\r\n                link: linkUrl,\r\n                content: {\r\n                    html: description,\r\n                    text: description,\r\n                },\r\n                image,\r\n                banner: image,\r\n                updated: upDatedStr ? parseDate(upDatedStr, 'YYYY年M月D日') : undefined,\r\n                language,\r\n            };\r\n\r\n            return processedItem;\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) => {\r\n            if (!item.link) {\r\n                return item;\r\n            }\r\n\r\n            return cache.tryGet(item.link, async (): Promise<DataItem> => {\r\n                const detailResponse = await ofetch(item.link);\r\n                const $$: CheerioAPI = load(detailResponse);\r\n\r\n                const title: string = $$('div.pinpai-page h3').text();\r\n                const pubDateStr: string | undefined = $$('span.time').text();\r\n\r\n                $$('div.pinpai-page h3').remove();\r\n                $$('div.pinpai-page span.time').remove();\r\n\r\n                const description: string | undefined = art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: $$('div.pinpai-page').html(),\r\n                });\r\n\r\n                const upDatedStr: string | undefined = pubDateStr;\r\n\r\n                const processedItem: DataItem = {\r\n                    title,\r\n                    description,\r\n                    pubDate: pubDateStr ? parseDate(pubDateStr, 'YYYY年M月D日') : item.pubDate,\r\n                    content: {\r\n                        html: description,\r\n                        text: description,\r\n                    },\r\n                    updated: upDatedStr ? parseDate(upDatedStr, 'YYYY年M月D日') : item.updated,\r\n                    language,\r\n                };\r\n\r\n                return {\r\n                    ...item,\r\n                    ...processedItem,\r\n                };\r\n            });\r\n        })\r\n    );\r\n\r\n    const author: string = $('h1.nav-logo').first().text();\r\n\r\n    return {\r\n        title: `${author} - ${$('title').text()}`,\r\n        link: targetUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: new URL('wp-content/themes/ccg/imgs/nav-logo.png', baseUrl).href,\r\n        author,\r\n        language,\r\n        id: targetUrl,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:category?',\r\n    name: '动态',\r\n    url: 'www.ccg.org.cn',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/ccg/news',\r\n    parameters: {\r\n        category: {\r\n            description: '分类，默认为 `news`，即新闻动态，可在对应分类页 URL 中找到',\r\n            options: [\r\n                {\r\n                    label: '新闻动态',\r\n                    value: 'news',\r\n                },\r\n                {\r\n                    label: '媒体报道',\r\n                    value: 'mtbd',\r\n                },\r\n            ],\r\n        },\r\n    },\r\n    description: `:::tip\r\n订阅 [新闻动态](http://www.ccg.org.cn/news)，其源网址为 \\`http://www.ccg.org.cn/news\\`，请参考该 URL 指定部分构成参数，此时路由为 [\\`/ccg/news\\`](https://rsshub.app/ccg/news)。\r\n:::\r\n\r\n| 分类                                   | ID                                  |\r\n| -------------------------------------- | ----------------------------------- |\r\n| [新闻动态](http://www.ccg.org.cn/news) | [news](https://rsshub.app/ccg/news) |\r\n| [媒体报道](http://www.ccg.org.cn/mtbd) | [mtbd](https://rsshub.app/ccg/mtbd) |\r\n`,\r\n    categories: ['new-media'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.ccg.org.cn/category'],\r\n            target: '/:category',\r\n        },\r\n        {\r\n            title: '新闻动态',\r\n            source: ['www.ccg.org.cn/news'],\r\n            target: '/news',\r\n        },\r\n        {\r\n            title: '媒体报道',\r\n            source: ['www.ccg.org.cn/mtbd'],\r\n            target: '/mtbd',\r\n        },\r\n    ],\r\n    view: ViewType.Articles,\r\n};\r\n"],"mappings":"kdAYA,MAAa,EAAU,KAAO,IAAgC,CAC1D,GAAM,CAAE,WAAW,QAAW,EAAI,IAAI,QAChC,EAAgB,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAAK,IAE/D,EAAkB,wBAClB,EAAoB,IAAI,IAAI,EAAU,GAAS,KAE/C,EAAW,MAAM,EAAO,GACxB,EAAgB,EAAK,GACrB,EAAW,EAAE,QAAQ,KAAK,SAAW,KAEvC,EAAoB,GAExB,EAAQ,EAAE,sBACL,MAAM,EAAG,GACT,UACA,IAAK,GAAgB,CAClB,IAAM,EAAwB,EAAE,GAE1B,EAAgB,EAAI,KAAK,MAAM,OAC/B,EAA4B,EAAI,KAAK,uBAAuB,KAAK,OACjE,EAAkC,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAC3F,OAAQ,EACF,CACI,CACI,IAAK,EACL,IAAK,IAGb,IAAA,GACN,MAAO,EAAI,KAAK,KAAK,SAEnB,EAAiC,EAAI,KAAK,QAAQ,OAClD,EAA8B,EAAI,KAAK,KAAK,KAAK,QACjD,EAAiC,EAEjC,EAA0B,CAC5B,QACA,cACA,QAAS,EAAa,EAAU,EAAY,aAAe,IAAA,GAC3D,KAAM,EACN,QAAS,CACL,KAAM,EACN,KAAM,GAEV,QACA,OAAQ,EACR,QAAS,EAAa,EAAU,EAAY,aAAe,IAAA,GAC3D,YAGJ,OAAO,IAGf,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACF,EAAK,KAIH,EAAM,OAAO,EAAK,KAAM,SAA+B,CAC1D,IAAM,EAAiB,MAAM,EAAO,EAAK,MACnC,EAAiB,EAAK,GAEtB,EAAgB,EAAG,sBAAsB,OACzC,EAAiC,EAAG,aAAa,OAEvD,EAAG,sBAAsB,SACzB,EAAG,6BAA6B,SAEhC,IAAM,EAAkC,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAC3F,YAAa,EAAG,mBAAmB,SAGjC,EAAiC,EAEjC,EAA0B,CAC5B,QACA,cACA,QAAS,EAAa,EAAU,EAAY,aAAe,EAAK,QAChE,QAAS,CACL,KAAM,EACN,KAAM,GAEV,QAAS,EAAa,EAAU,EAAY,aAAe,EAAK,QAChE,YAGJ,MAAO,CACH,GAAG,EACH,GAAG,KAjCA,IAuCnB,IAAM,EAAiB,EAAE,eAAe,QAAQ,OAEhD,MAAO,CACH,MAAO,GAAG,EAAO,KAAK,EAAE,SAAS,SACjC,KAAM,EACN,KAAM,EACN,WAAY,GACZ,MAAO,IAAI,IAAI,0CAA2C,GAAS,KACnE,SACA,WACA,GAAI,IAIC,EAAe,CACxB,KAAM,cACN,KAAM,KACN,IAAK,iBACL,YAAa,CAAC,WACd,UACA,QAAS,YACT,WAAY,CACR,SAAU,CACN,YAAa,sCACb,QAAS,CACL,CACI,MAAO,OACP,MAAO,QAEX,CACI,MAAO,OACP,MAAO,WAKvB,YAAa;;;;;;;;EASb,WAAY,CAAC,aACb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,aAAc,GACd,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,2BACT,OAAQ,cAEZ,CACI,MAAO,OACP,OAAQ,CAAC,uBACT,OAAQ,SAEZ,CACI,MAAO,OACP,OAAQ,CAAC,uBACT,OAAQ,UAGhB,KAAM,EAAS"}