{"version":3,"file":"tag-btAbdekb.js","names":["route: Route","ConfigNotFoundError","got"],"sources":["../../lib/routes/lofter/tag.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { JSDOM } from 'jsdom';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/tag/:name?/:type?',\r\n    categories: ['social-media'],\r\n    example: '/lofter/tag/cosplay/date',\r\n    parameters: { name: 'tag name, such as `名侦探柯南`, `摄影` by default', type: 'ranking type, see below, new by default' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'LOFTER_COOKIE',\r\n                description: `LOFTER_COOKIE: 用于搜索标签相关内容，获取方式：\r\n    1.  登录 Lofter 并搜索任一标签，进入页面 https://www.lofter.com/tag/*\r\n    2.  打开控制台，切换到 Network 面板，刷新\r\n    3.  点击 TagBean.seach.dwr 请求，找到 Cookie\r\n    4.  获取最新标签内容只要求 \\`LOFTER_SESS\\` 开始的字段`,\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Tag',\r\n    maintainers: ['hoilc', 'nczitzk', 'LucunJi'],\r\n    handler,\r\n    description: `::: warning\r\n  搜索标签下的最新内容需要 Lofter 登录后的 Cookie 值，所以只能自建，详情见部署页面的配置模块。\r\n:::\r\n\r\n| new  | date | week | month | total |\r\n| ---- | ---- | ---- | ----- | ----- |\r\n| 最新 | 日榜 | 周榜 | 月榜  | 总榜  |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const name = ctx.req.param('name') ?? '摄影';\r\n    const type = ctx.req.param('type') ?? 'new';\r\n    const pageSize = 20;\r\n    const startingIndex = 0;\r\n\r\n    const rootUrl = 'https://www.lofter.com';\r\n    const linkUrl = `${rootUrl}/tag/${name}/${type}`;\r\n    const apiUrl = `${rootUrl}/dwr/call/plaincall/TagBean.search.dwr`;\r\n\r\n    const cookie = config.lofter.cookies;\r\n    if (cookie === undefined) {\r\n        throw new ConfigNotFoundError('Lofter 用户登录后的 Cookie 值');\r\n    }\r\n\r\n    const response = await got({\r\n        method: 'post',\r\n        url: apiUrl,\r\n        body: new URLSearchParams({\r\n            callCount: 1,\r\n            scriptSessionId: '${scriptSessionId}187',\r\n            httpSessionId: '',\r\n            'c0-scriptName': 'TagBean',\r\n            'c0-methodName': 'search',\r\n            'c0-id': '0',\r\n            'c0-param0': `string:${encodeURI(name)}`,\r\n            'c0-param1': 'number:0',\r\n            'c0-param2': 'string:',\r\n            'c0-param3': `string:${type}`,\r\n            'c0-param4': 'boolean:false',\r\n            'c0-param5': 'number:0',\r\n            'c0-param6': `number:${pageSize}`,\r\n            'c0-param7': `number:${startingIndex}`,\r\n            'c0-param8': 'number:0',\r\n            batchId: 493053,\r\n        }),\r\n        headers: {\r\n            Referer: `https://www.lofter.com/tag/${encodeURI(name)}`,\r\n            Cookie: cookie,\r\n        },\r\n    });\r\n\r\n    const dom = new JSDOM(\r\n        `<script>if (dwr == null) var dwr = {};\r\n        if (dwr.engine == null) dwr.engine = {};\r\n        dwr.engine._remoteHandleCallback = function () {\r\n            this.data = arguments;\r\n        };\r\n        ${response.data}</script>`,\r\n        {\r\n            runScripts: 'dangerously',\r\n        }\r\n    );\r\n    const data = dom.window.dwr.engine.data[2];\r\n\r\n    const title =\r\n        {\r\n            new: '最新',\r\n            date: '日榜',\r\n            week: '周榜',\r\n            month: '月榜',\r\n            total: '最热',\r\n        }[type] ?? '';\r\n\r\n    const items = data.map((entry) => {\r\n        const post = entry.post;\r\n\r\n        let videos = '';\r\n        if (post.embed) {\r\n            const embed = JSON.parse(post.embed);\r\n            if (embed.h256Url || embed.video_down_url) {\r\n                videos = `<video src=\"${embed.h256Url ?? embed.video_down_url}\" poster=\"${embed.video_img_url ?? ''}\" controls=\"controls\"></video>`;\r\n            }\r\n        }\r\n\r\n        const images = post.photoLinks\r\n            ? JSON.parse(post.photoLinks).reduce((accumulator, currentValue) => accumulator + `<img src=\"${currentValue.orign}\"/>`, '') // small | middle | orign\r\n            : '';\r\n\r\n        const digest = load(post.digest);\r\n        const description = digest.text();\r\n\r\n        return {\r\n            author: post.blogInfo.blogNickName,\r\n            link: post.blogPageUrl,\r\n            title: post.title || `${post.blogInfo.blogNickName}${description ? `：${description}` : ''}`,\r\n            pubDate: parseDate(post.publishTime),\r\n            description: videos + images + digest.html(),\r\n            category: post.tagList,\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `${name} - ${title} | LOFTER`,\r\n        link: linkUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"6aAQA,MAAaA,EAAe,CACxB,KAAM,qBACN,WAAY,CAAC,gBACb,QAAS,2BACT,WAAY,CAAE,KAAM,6CAA8C,KAAM,2CACxE,SAAU,CACN,cAAe,CACX,CACI,KAAM,gBACN,YAAa;;;;6CAOrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,MACN,YAAa,CAAC,QAAS,UAAW,WAClC,UACA,YAAa;;;;;;+BASjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,KAChC,EAAO,EAAI,IAAI,MAAM,SAAW,MAIhC,EAAU,yBACV,EAAU,GAAG,EAAQ,OAAO,EAAK,GAAG,IACpC,EAAS,GAAG,EAAQ,wCAEpB,EAAS,EAAO,OAAO,QAC7B,GAAI,IAAW,IAAA,GACX,MAAM,IAAIC,EAAoB,0BAGlC,IAAM,EAAW,MAAMC,EAAI,CACvB,OAAQ,OACR,IAAK,EACL,KAAM,IAAI,gBAAgB,CACtB,UAAW,EACX,gBAAiB,wBACjB,cAAe,GACf,gBAAiB,UACjB,gBAAiB,SACjB,QAAS,IACT,YAAa,UAAU,UAAU,KACjC,YAAa,WACb,YAAa,UACb,YAAa,UAAU,IACvB,YAAa,gBACb,YAAa,WACb,YAAa,YACb,YAAa,WACb,YAAa,WACb,QAAS,SAEb,QAAS,CACL,QAAS,8BAA8B,UAAU,KACjD,OAAQ,KAIV,EAAM,IAAI,EACZ;;;;;UAKE,EAAS,KAAK,YAChB,CACI,WAAY,gBAGd,EAAO,EAAI,OAAO,IAAI,OAAO,KAAK,GAElC,EACF,CACI,IAAK,KACL,KAAM,KACN,KAAM,KACN,MAAO,KACP,MAAO,MACT,IAAS,GAET,EAAQ,EAAK,IAAK,GAAU,CAC9B,IAAM,EAAO,EAAM,KAEf,EAAS,GACb,GAAI,EAAK,MAAO,CACZ,IAAM,EAAQ,KAAK,MAAM,EAAK,QAC1B,EAAM,SAAW,EAAM,kBACvB,EAAS,eAAe,EAAM,SAAW,EAAM,eAAe,YAAY,EAAM,eAAiB,GAAG,iCAI5G,IAAM,EAAS,EAAK,WACd,KAAK,MAAM,EAAK,YAAY,QAAQ,EAAa,IAAiB,EAAc,aAAa,EAAa,MAAM,KAAM,IACtH,GAEA,EAAS,EAAK,EAAK,QACnB,EAAc,EAAO,OAE3B,MAAO,CACH,OAAQ,EAAK,SAAS,aACtB,KAAM,EAAK,YACX,MAAO,EAAK,OAAS,GAAG,EAAK,SAAS,eAAe,EAAc,IAAI,IAAgB,KACvF,QAAS,EAAU,EAAK,aACxB,YAAa,EAAS,EAAS,EAAO,OACtC,SAAU,EAAK,WAIvB,MAAO,CACH,MAAO,GAAG,EAAK,KAAK,EAAM,WAC1B,KAAM,EACN,KAAM"}