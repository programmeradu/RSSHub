{"version":3,"file":"journal-CnknMV_7.js","names":[],"sources":["../../lib/routes/rsc/journal.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/journal/:id/:category?',\r\n    categories: ['journal'],\r\n    example: '/rsc/journal/ta',\r\n    parameters: { id: 'Journal id, can be found in URL', category: 'Category, see below, All Recent Articles by default' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Journal',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `::: tip\r\n  All journals at [Current journals](https://pubs.rsc.org/en/journals)\r\n:::\r\n\r\n| All Recent Articles | Advance Articles |\r\n| ------------------- | ---------------- |\r\n| allrecentarticles   | advancearticles  |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { id, category = 'allrecentarticles' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 50;\r\n\r\n    const rootUrl = 'https://pubs.rsc.org';\r\n    const currentUrl = new URL(`en/journals/journalissues/${id}#!recentarticles`, rootUrl).href;\r\n    const apiUrl = new URL('en/journals/getrecentarticles', rootUrl).href;\r\n\r\n    const { data: response } = await got.post(apiUrl, {\r\n        form: {\r\n            name: id,\r\n            pageno: 1,\r\n            iscontentavailable: true,\r\n            category,\r\n        },\r\n    });\r\n\r\n    let $ = load(response);\r\n\r\n    $('div.capsule__article-image').each(function () {\r\n        $(this).replaceWith(\r\n            art(path.join(__dirname, 'templates/image.art'), {\r\n                image: $(this).find('img').prop('data-original'),\r\n            })\r\n        );\r\n    });\r\n\r\n    let items = $('div.capsule--article')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const authors = item.find('div.article__authors').text().trim();\r\n            const doi = item.find('div.text--small span a').text().split(/org\\//).pop();\r\n\r\n            const isOpenAccess = !!item.find('span.capsule__context img.ver-t').prop('alt');\r\n            const isManuscript = !!item.find('span.capsule__context span').text();\r\n\r\n            const enclosureUrl = new URL(item.find('div.capsule__action--buttons a').prop('href').split('?').pop(), rootUrl).href;\r\n\r\n            return {\r\n                title: item.find('h3.capsule__title').text(),\r\n                link: new URL(item.find('a.capsule__action').prop('href'), rootUrl).href,\r\n                description: item.find('div.capsule__column-wrapper').html(),\r\n                author: authors,\r\n                category: [item.find('span.capsule__context').text().trim(), ...authors.split(/,\\s|and\\s/), isOpenAccess || isManuscript],\r\n                guid: `rsc-${doi}`,\r\n                pubDate: timezone(parseDate(item.find('div.text--small span.block').text().split(/on\\s/).pop(), 'DD MMM YYYY'), +1),\r\n                enclosure_url: enclosureUrl,\r\n                enclosure_type: enclosureUrl ? 'application/pdf' : undefined,\r\n                doi,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.guid, async () => {\r\n                if (item.category.pop()) {\r\n                    const { data: detailResponse } = await got(item.link.replace(/\\/articlelanding\\//, '/articlehtml/'));\r\n\r\n                    const content = load(detailResponse);\r\n\r\n                    content('#pnlArticleAccess, #pnlArticleContent').remove();\r\n                    content('div.abstract, div.article-abstract__heading').prevAll().remove();\r\n\r\n                    item.title = content('meta[name=\"DC.title\"]').prop('content');\r\n                    item.description = content('#wrapper, article.article-control').html();\r\n                    item.pubDate = timezone(parseDate(content('meta[name=\"citation_online_date\"]').prop('content'), 'YYYY/MM/DD'), +1);\r\n                    item.enclosure_url = content('meta[name=\"citation_pdf_url\"]').prop('content');\r\n                    item.enclosure_type = item.enclosure_url ? 'application/pdf' : undefined;\r\n                    item.doi = content('meta[name=\"DC.Identifier\"]').prop('content');\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: detailResponse } = await got(currentUrl);\r\n\r\n    $ = load(detailResponse);\r\n\r\n    const icon = new URL($('link[rel=\"apple-touch-icon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: $('meta[name=\"citation_title\"]').prop('content'),\r\n        link: currentUrl,\r\n        description: $('meta[property=\"og:description\"]').prop('content'),\r\n        language: 'en',\r\n        image: new URL($('div.page-head__cell--image span img').prop('src'), rootUrl).href,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('title').text(),\r\n        author: $('meta[name=\"citation_journal_abbrev\"]').prop('content'),\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"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"}