import"./esm-shims-Dqvxr0BZ.js";import"./config-Dl8a1sIg.js";import{logger_default as e}from"./logger-CWOoofbD.js";import"./dist-IvUHtNe1.js";import"./cache-kimkMTWJ.js";import{parseDate as t}from"./parse-date-Bgabdhlb.js";import{ofetch_default as n}from"./ofetch-Bzt0BXUH.js";import{finishArticleItem as r}from"./wechat-mp-BwNEdjlr.js";import{load as i}from"cheerio";const a=`https://weixin.sogou.com`,o=`SNUID=78725B470A0EF2C3F97AA5EB0BBF95C1; ABTEST=0|1680917938|v1; SUID=8F7B1C682B83A20A000000006430C5B2; PHPSESSID=le2lak0vghad5c98ijd3t51ls4; IPLOC=USUS5`;async function s(r){let s=`${a}/weixin`,c;try{let e=await n(s,{query:{ie:`utf8`,s_from:`input`,_sug_:`n`,_sug_type_:`1`,type:`2`,query:r,page:`1`},headers:{Referer:a,Cookie:o}});c={data:e}}catch(t){return e.error(`Failed to fetch Sogou search for ${r}: ${t instanceof Error?t.message:String(t)}`),[]}let l=i(c.data),u=l(`ul.news-list > li`).toArray(),d=u.map(async i=>{let c=l(i),u=c.find(`h3 > a`).text().trim(),d=c.find(`h3 > a`).attr(`href`);if(!d)return e.warn(`Skipping item with missing link for wechatId: ${r}`),null;let f=a+d,p=c.find(`p.txt-info`).text().trim(),m=c.find(`span.s2 script`).html(),h=m?.match(/timeConvert\('(\d+)'\)/),g=h?t(Number.parseInt(h[1])*1e3):void 0,_=f;try{let t=await n.raw(f,{headers:{Referer:s,Cookie:o},redirect:`manual`,ignoreResponseError:!0}),i=t.headers?.get(`location`);if(i){if(!i.startsWith(`http`))try{i=new URL(i,f).toString()}catch(t){e.warn(`Invalid redirect location "${i}" for title "${u}" (wechatId: ${r}): ${t instanceof Error?t.message:String(t)}`),i=null}if(typeof i==`string`&&i)if(i.startsWith(`http://mp.weixin.qq.com`)||i.startsWith(`https://mp.weixin.qq.com`))_=i;else try{let e=await n.raw(i,{headers:{Referer:f,Cookie:o},redirect:`manual`,ignoreResponseError:!0}),t=e.headers?.get(`location`);t&&(t.startsWith(`http://mp.weixin.qq.com`)||t.startsWith(`https://mp.weixin.qq.com`))&&(_=t)}catch(t){e.warn(`Failed to resolve intermediate redirect for title "${u}" (wechatId: ${r}): ${t instanceof Error?t.message:String(t)}`)}}else e.debug(`No redirect location found for title "${u}" (wechatId: ${r})`)}catch(t){let n=t instanceof Error?t.message:String(t);typeof t==`object`&&t&&`response`in t&&typeof t.response==`object`&&t.response!==null&&`status`in t.response?e.debug(`Redirect request failed for "${u}" (wechatId: ${r}) with status ${t.response.status}: ${n}`):e.debug(`Redirect request failed for "${u}" (wechatId: ${r}): ${n}`)}let v=_.startsWith(`http://mp.weixin.qq.com`)||_.startsWith(`https://mp.weixin.qq.com`),y=c.find(`span.all-time-y2`).text().trim();return{title:u,link:_,description:p,author:y,pubDate:g,guid:_,_internal:{isWeChatLink:v}}});return(await Promise.all(d)).filter(e=>e!==null)}const c={path:`/sogou/:id`,categories:[`new-media`],example:`/wechat/sogou/qimao0908`,parameters:{id:`公众号 id, 打开 weixin.sogou.com 并搜索相应公众号， 在 URL 中找到 id`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!0,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`公众号（搜狗来源）`,maintainers:[`EthanWng97`,`pseudoyu`],handler:l};async function l(t){let n=t.req.param(`id`),i=await s(n),o=i[0],c=o?.author||n,l=i.map(async t=>{let n=t;if(t._internal.isWeChatLink)try{n=await r(t)}catch(n){e.debug(`finishArticleItem failed for ${t.link}: ${n instanceof Error?n.message:String(n)}`)}if(n&&typeof n==`object`){let e={title:n.title,link:n.link,description:n.description,author:n.author,pubDate:n.pubDate,guid:n.guid,...n.content&&{content:n.content}};return e}return e.debug(`Unexpected null or non-object item during final processing for link: ${t?.link}`),null}),u=(await Promise.all(l)).filter(e=>e!==null);return{title:`${c} 的微信公众号`,link:`${a}/weixin?query=${n}`,description:`${c} 的微信公众号`,item:u}}export{c as route};
//# sourceMappingURL=sogou-D39hnjTo.js.map