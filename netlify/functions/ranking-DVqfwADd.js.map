{"version":3,"file":"ranking-DVqfwADd.js","names":["route: Route","got","utils"],"sources":["../../lib/routes/bilibili/ranking.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport got from '@/utils/got';\r\nimport utils, { getVideoUrl } from './utils';\r\nimport { parseDuration } from '@/utils/helpers';\r\n\r\n// https://www.bilibili.com/v/popular/rank/all\r\n\r\n// 0 all https://api.bilibili.com/x/web-interface/ranking/v2?rid=0&type=all&web_location=333.934&w_rid=d4e0c1b83157e3d36836eb3c4258ef61&wts=1731320484\r\n// 1 bangumi https://api.bilibili.com/pgc/web/rank/list?day=3&season_type=1&web_location=333.934&w_rid=2d46eff2d363c4960bc875e63e24df6c&wts=1731320507\r\n// 2 guochan https://api.bilibili.com/pgc/season/rank/web/list?day=3&season_type=4&web_location=333.934&w_rid=b26195dc9ee2f925bc196da68df341a5&wts=1731320523\r\n// 3 guochuang https://api.bilibili.com/x/web-interface/ranking/v2?rid=168&type=all&web_location=333.934&w_rid=f99e5982b011eb24643a2daffb7baf00&wts=1731320537\r\n// 4 documentary https://api.bilibili.com/pgc/season/rank/web/list?day=3&season_type=3&web_location=333.934&w_rid=2067f7277cf49cbea4c5e5630eeb929a&wts=1731320556\r\n// 5 douga https://api.bilibili.com/x/web-interface/ranking/v2?rid=1&type=all&web_location=333.934&w_rid=14bf53ce651e8d575d5982b24e1cebdf&wts=1731320579\r\n// 6 music https://api.bilibili.com/x/web-interface/ranking/v2?rid=3&type=all&web_location=333.934&w_rid=70f4c870f860b9334ebe6e9fe835d3fe&wts=1731320595\r\n// 7 dance https://api.bilibili.com/x/web-interface/ranking/v2?rid=129&type=all&web_location=333.934&w_rid=691f713f7fc6d3cc08174affcc59f97c&wts=1731321260\r\n// 8 game https://api.bilibili.com/x/web-interface/ranking/v2?rid=4&type=all&web_location=333.934&w_rid=cac9f26f49da223cb8ab6f189250ec23&wts=1731320726\r\n// 9 knowledge https://api.bilibili.com/x/web-interface/ranking/v2?rid=36&type=all&web_location=333.934&w_rid=79c274d74e90d93ac7adfd2df968288e&wts=1731320750\r\n// 10 tech https://api.bilibili.com/x/web-interface/ranking/v2?rid=188&type=all&web_location=333.934&w_rid=115d9e69c48bf958622c4cc0ee861b57&wts=1731320766\r\n// 11 sports https://api.bilibili.com/x/web-interface/ranking/v2?rid=234&type=all&web_location=333.934&w_rid=c618d12f36e2379bda0c9a2754cd71e0&wts=1731320783\r\n// 12 car https://api.bilibili.com/x/web-interface/ranking/v2?rid=223&type=all&web_location=333.934&w_rid=753bc1395718051aa53aedaa3cd04d76&wts=1731320797\r\n// 13 life https://api.bilibili.com/x/web-interface/ranking/v2?rid=160&type=all&web_location=333.934&w_rid=3e8895d4749e905173886dd387f657e9&wts=1731320823\r\n// 14 food https://api.bilibili.com/x/web-interface/ranking/v2?rid=211&type=all&web_location=333.934&w_rid=9ec93cab672a98ea972dfb9cb7ed6368&wts=1731320838\r\n// 15 animal https://api.bilibili.com/x/web-interface/ranking/v2?rid=217&type=all&web_location=333.934&w_rid=794e69434ec4a818f4d589e5306e9a21&wts=1731320852\r\n// 16 kichiku https://api.bilibili.com/x/web-interface/ranking/v2?rid=119&type=all&web_location=333.934&w_rid=c5e35f3f247bc9294557ab90e0be166a&wts=1731320865\r\n// 17 fashion https://api.bilibili.com/x/web-interface/ranking/v2?rid=155&type=all&web_location=333.934&w_rid=f3711c888057a8fef1f47da9cf4bcd86&wts=1731320878\r\n// 18 ent https://api.bilibili.com/x/web-interface/ranking/v2?rid=5&type=all&web_location=333.934&w_rid=5ca1b2da22de1c9e818ac619d309fed2&wts=1731320889\r\n// 19 cinephile https://api.bilibili.com/x/web-interface/ranking/v2?rid=181&type=all&web_location=333.934&w_rid=8f5cae08b232025f93b74feaefdc95d9&wts=1731320903\r\n// 20 movie https://api.bilibili.com/pgc/season/rank/web/list?day=3&season_type=2&web_location=333.934&w_rid=ccd42543ab1c4330e9f81fb52b098a9c&wts=1731320916\r\n// 21 tv https://api.bilibili.com/pgc/season/rank/web/list?day=3&season_type=5&web_location=333.934&w_rid=10fae974e8d30dd6bba11527fe17e551&wts=1731320934\r\n// 22 variety https://api.bilibili.com/pgc/season/rank/web/list?day=3&season_type=7&web_location=333.934&w_rid=c3105fd0dac70dcdf4f08ca6b5cbdb8f&wts=1731320948\r\n// 23 origin https://api.bilibili.com/x/web-interface/ranking/v2?rid=0&type=origin&web_location=333.934&w_rid=53100b7aeeca012399f4f8f3746bcbdb&wts=1731320960\r\n// 24 rookie https://api.bilibili.com/x/web-interface/ranking/v2?rid=0&type=rookie&web_location=333.934&w_rid=b8adda7447e2f115b2ed36495e436934&wts=1731320971\r\n\r\nconst ridNumberList = ['0', '1', '4', '168', '3', '1', '3', '129', '4', '36', '188', '234', '223', '160', '211', '217', '119', '155', '5', '181', '2', '5', '7', '0', '0'];\r\nconst ridChineseList = [\r\n    '全站',\r\n    '番剧',\r\n    '国产动画',\r\n    '国创相关',\r\n    '纪录片',\r\n    '动画',\r\n    '音乐',\r\n    '舞蹈',\r\n    '游戏',\r\n    '知识',\r\n    '科技',\r\n    '运动',\r\n    '汽车',\r\n    '生活',\r\n    '美食',\r\n    '动物圈',\r\n    '鬼畜',\r\n    '时尚',\r\n    '娱乐',\r\n    '影视',\r\n    '电影',\r\n    '电视剧',\r\n    '综艺',\r\n    '原创',\r\n    '新人',\r\n];\r\nconst ridEnglishList = [\r\n    'all',\r\n    'bangumi',\r\n    'guochan',\r\n    'guochuang',\r\n    'documentary',\r\n    'douga',\r\n    'music',\r\n    'dance',\r\n    'game',\r\n    'knowledge',\r\n    'tech',\r\n    'sports',\r\n    'car',\r\n    'life',\r\n    'food',\r\n    'animal',\r\n    'kichiku',\r\n    'fashion',\r\n    'ent',\r\n    'cinephile',\r\n    'movie',\r\n    'tv',\r\n    'variety',\r\n    'origin',\r\n    'rookie',\r\n];\r\nconst ridTypeList = [\r\n    'x/rid',\r\n    'pgc/web',\r\n    'pgc/season',\r\n    'x/rid',\r\n    'pgc/season',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'x/rid',\r\n    'pgc/season',\r\n    'pgc/season',\r\n    'pgc/season',\r\n    'x/type',\r\n    'x/type',\r\n];\r\n\r\nexport const route: Route = {\r\n    path: '/ranking/:rid_index?/:embed?/:redirect1?/:redirect2?',\r\n    name: '排行榜',\r\n    maintainers: ['DIYgod', 'hyoban'],\r\n    categories: ['social-media'],\r\n    view: ViewType.Videos,\r\n    example: '/bilibili/ranking/0',\r\n    parameters: {\r\n        rid_index: {\r\n            description: '排行榜分区 id 序号',\r\n            default: '0',\r\n            options: Array.from({ length: ridNumberList.length }, (_, i) => ({\r\n                value: String(i),\r\n                label: ridChineseList[i],\r\n            })).filter((_, i) => !ridTypeList[i].startsWith('pgc/')),\r\n        },\r\n        embed: '默认为开启内嵌视频, 任意值为关闭',\r\n        redirect1: '留空，用于兼容之前的路由',\r\n        redirect2: '留空，用于兼容之前的路由',\r\n    },\r\n    handler,\r\n};\r\n\r\nfunction getRidIndexByRid(rid: string): number {\r\n    const index = ridNumberList.indexOf(rid);\r\n    if (index === -1) {\r\n        throw new Error('Invalid rid');\r\n    }\r\n    return index;\r\n}\r\n\r\nfunction getAPI(ridIndex: number) {\r\n    if (ridIndex < 0 || ridIndex >= ridNumberList.length) {\r\n        throw new Error('Invalid rid index');\r\n    }\r\n    const rid = ridNumberList[ridIndex];\r\n    const ridType = ridTypeList[ridIndex];\r\n    const ridChinese = ridChineseList[ridIndex];\r\n    const ridEnglish = ridEnglishList[ridIndex];\r\n\r\n    let apiURL = '';\r\n\r\n    switch (ridType) {\r\n        case 'x/rid':\r\n            apiURL = `https://api.bilibili.com/x/web-interface/ranking?rid=${rid}&type=all`;\r\n            break;\r\n        case 'pgc/web':\r\n            apiURL = `https://api.bilibili.com/pgc/web/rank/list?day=3&season_type=${rid}`;\r\n            break;\r\n        case 'pgc/season':\r\n            apiURL = `https://api.bilibili.com/pgc/season/rank/web/list?day=3&season_type=${rid}`;\r\n            break;\r\n        case 'x/type':\r\n            apiURL = `https://api.bilibili.com/x/web-interface/ranking?rid=0&type=${ridEnglish}`;\r\n            break;\r\n        default:\r\n            throw new Error('Invalid rid type');\r\n    }\r\n\r\n    return {\r\n        apiURL,\r\n        referer: `https://www.bilibili.com/v/popular/rank/${ridEnglish}`,\r\n        ridChinese,\r\n        ridType,\r\n        link: `https://www.bilibili.com/v/popular/rank/${ridEnglish}`,\r\n    };\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const args = ctx.req.param();\r\n    if (args.redirect1 || args.redirect2) {\r\n        // redirect old routes like /bilibili/ranking/0/3/1 or /bilibili/ranking/0/3/1/xxx\r\n        const embedArg = args.redirect2 ? '/' + args.redirect2 : '';\r\n        ctx.set('redirect', `/bilibili/ranking/${getRidIndexByRid(args.rid_index)}${embedArg}`);\r\n        return null;\r\n    }\r\n\r\n    const ridIndex = ctx.req.param('rid_index') || '0';\r\n    const embed = !ctx.req.param('embed');\r\n\r\n    const { apiURL, referer, ridChinese, link, ridType } = getAPI(Number(ridIndex));\r\n    if (ridType.startsWith('pgc/')) {\r\n        throw new Error('This type of ranking is not supported yet');\r\n    }\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: apiURL,\r\n        headers: {\r\n            Referer: referer,\r\n        },\r\n    });\r\n\r\n    const data = response.data.data || response.data.result;\r\n    const list = data.list || [];\r\n    return {\r\n        title: `bilibili 排行榜-${ridChinese}`,\r\n        link,\r\n        item: list.map((item) => ({\r\n            title: item.title,\r\n            description: utils.renderUGCDescription(embed, item.pic, item.description || item.title, item.aid, undefined, item.bvid),\r\n            pubDate: item.create && new Date(item.create).toUTCString(),\r\n            author: item.author,\r\n            link: !item.create || (new Date(item.create).getTime() / 1000 > utils.bvidTime && item.bvid) ? `https://www.bilibili.com/video/${item.bvid}` : `https://www.bilibili.com/video/av${item.aid}`,\r\n            image: item.pic,\r\n            attachments: item.bvid\r\n                ? [\r\n                      {\r\n                          url: getVideoUrl(item.bvid),\r\n                          mime_type: 'text/html',\r\n                          duration_in_seconds: parseDuration(item.duration),\r\n                      },\r\n                  ]\r\n                : undefined,\r\n        })),\r\n    };\r\n}\r\n"],"mappings":"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"}