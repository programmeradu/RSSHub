{"version":3,"file":"news-BYU0NYTx.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/6park/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/news/:site?/:id?/:keyword?',\r\n    radar: [\r\n        {\r\n            source: ['club.6parkbbs.com/:id/index.php', 'club.6parkbbs.com/'],\r\n            target: '/:id?',\r\n        },\r\n    ],\r\n    name: '新闻栏目',\r\n    maintainers: ['nczitzk', 'cscnk52'],\r\n    parameters: {\r\n        site: '分站，可选newspark、local，默认为 newspark',\r\n        id: '栏目 id，可选，默认为空',\r\n        keyword: '关键词，可选，默认为空',\r\n    },\r\n    description: `::: tip 提示\r\n若订阅 [时政](https://www.6parknews.com/newspark/index.php?type=1)，其网址为 <https://www.6parknews.com/newspark/index.php?type=1>，其中 \\`newspark\\` 为分站，\\`1\\` 为栏目 id。\r\n若订阅 [美国](https://local.6parknews.com/index.php?type_id=1)，其网址为 <https://local.6parknews.com/index.php?type_id=1>，其中 \\`local\\` 为分站，\\`1\\` 为栏目 id。\r\n:::`,\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const site = ctx.req.param('site') ?? 'newspark';\r\n    const id = ctx.req.param('id') ?? '';\r\n    const keyword = ctx.req.param('keyword') ?? '';\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 50;\r\n\r\n    const isLocal = site === 'local';\r\n\r\n    const rootUrl = `https://${isLocal ? site : 'www'}.6parknews.com`;\r\n    const indexUrl = `${rootUrl}${isLocal ? '' : '/newspark'}/index.php`;\r\n    const currentUrl = `${indexUrl}${keyword ? `?act=newssearch&app=news&keywords=${keyword}&submit=查询` : id ? (Number.isNaN(id) ? `?act=${id}` : isLocal ? `?type_id=${id}` : `?type=${id}`) : ''}`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    let items = $('#d_list ul li, #thread_list li, .t_l .t_subject')\r\n        .toArray()\r\n        .slice(0, limit)\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const a = item.find('a').first();\r\n            const link = a.attr('href');\r\n\r\n            return {\r\n                title: a.text(),\r\n                link: link.startsWith('http') ? link : `${rootUrl}/${link.startsWith('view') ? `newspark/${link}` : link}`,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items\r\n            .filter((item) => /6parknews\\.com/.test(item.link))\r\n            .map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    try {\r\n                        const detailResponse = await got({\r\n                            method: 'get',\r\n                            url: item.link,\r\n                        });\r\n\r\n                        const content = load(detailResponse.data);\r\n\r\n                        const matches = detailResponse.data.match(/新闻来源:(.*?)于.*(\\d{4}(?:-\\d{2}){2} (?:\\d{1,2}:){2}\\d{1,2})/);\r\n\r\n                        item.title = content('h2').text();\r\n                        item.author = matches[1].trim();\r\n                        item.pubDate = timezone(parseDate(matches[2], 'YYYY-MM-DD h:m'), +8);\r\n                        item.description = content('#shownewsc').html().replaceAll('<p></p>', '');\r\n                    } catch {\r\n                        // no-empty\r\n                    }\r\n\r\n                    return item;\r\n                })\r\n            )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"0ZAOA,MAAaA,EAAe,CACxB,KAAM,8BACN,MAAO,CACH,CACI,OAAQ,CAAC,kCAAmC,sBAC5C,OAAQ,UAGhB,KAAM,OACN,YAAa,CAAC,UAAW,WACzB,WAAY,CACR,KAAM,mCACN,GAAI,gBACJ,QAAS,eAEb,YAAa,uTAIb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,WAChC,EAAK,EAAI,IAAI,MAAM,OAAS,GAC5B,EAAU,EAAI,IAAI,MAAM,YAAc,GAEtC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,GAE3E,EAAU,IAAS,QAEnB,EAAU,WAAW,EAAU,EAAO,MAAM,gBAC5C,EAAW,GAAG,IAAU,EAAU,GAAK,YAAY,YACnD,EAAa,GAAG,IAAW,EAAU,qCAAqC,EAAQ,YAAc,EAAM,OAAO,MAAM,GAAM,QAAQ,IAAO,EAAU,YAAY,IAAO,SAAS,IAAQ,KAEtL,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MAEpB,EAAQ,EAAE,mDACT,UACA,MAAM,EAAG,GACT,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAI,EAAK,KAAK,KAAK,QACnB,EAAO,EAAE,KAAK,QAEpB,MAAO,CACH,MAAO,EAAE,OACT,KAAM,EAAK,WAAW,QAAU,EAAO,GAAG,EAAQ,GAAG,EAAK,WAAW,QAAU,YAAY,IAAS,OAgChH,MA5BA,GAAQ,MAAM,QAAQ,IAClB,EACK,OAAQ,GAAS,iBAAiB,KAAK,EAAK,OAC5C,IAAK,GACFC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,CACA,IAAM,EAAiB,MAAMD,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAe,MAE9B,EAAU,EAAe,KAAK,MAAM,4DAE1C,EAAK,MAAQ,EAAQ,MAAM,OAC3B,EAAK,OAAS,EAAQ,GAAG,OACzB,EAAK,QAAU,EAAS,EAAU,EAAQ,GAAI,kBAAmB,GACjE,EAAK,YAAc,EAAQ,cAAc,OAAO,WAAW,UAAW,SAClE,EAIR,OAAO,MAKhB,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM"}