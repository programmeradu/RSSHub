{"version":3,"file":"profile-lqq8i5h9.js","names":["route: Route","puppeteer","resData","data: Data"],"sources":["../../lib/routes/kuaishou/profile.ts"],"sourcesContent":["import { Route, Data } from '@/types';\r\nimport puppeteer from '@/utils/puppeteer';\r\nimport { config } from '@/config';\r\nexport const route: Route = {\r\n    name: 'Profile',\r\n    path: '/profile/:principalId',\r\n    radar: [\r\n        {\r\n            source: ['kuaishou.com/profile/:principalId'],\r\n            target: '/profile/:principalId',\r\n        },\r\n    ],\r\n    parameters: {\r\n        principalId: '用户 id, 可在主页中找到',\r\n    },\r\n    example: '/kuaishou/profile/3xk46q9cdnvgife',\r\n    maintainers: ['GuoChen-thlg'],\r\n    url: 'kuaishou.com/profile/:principalId',\r\n    description: `::: tip\r\nThe profile page of the user, which contains the user's information, videos, and other information.\r\n:::`,\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { principalId } = ctx.req.param();\r\n    const browser = await puppeteer();\r\n    const page = await browser.newPage();\r\n\r\n    let retryCount = 0;\r\n    let resolve;\r\n    let userInfo;\r\n    const promise = new Promise((res) => {\r\n        resolve = res;\r\n    });\r\n    await page.setRequestInterception(true);\r\n    page.on('request', (req) => {\r\n        const resourceType = req.resourceType();\r\n        if (resourceType === 'image' || resourceType === 'media' || resourceType === 'font' || resourceType === 'stylesheet' || resourceType === 'ping') {\r\n            req.abort();\r\n        } else {\r\n            req.continue();\r\n        }\r\n    });\r\n    page.on('response', async (res) => {\r\n        if (res.ok() && res.url().includes('/live_api/profile/public')) {\r\n            const resData = await res.json();\r\n            if (resData.data.list.length > 0) {\r\n                resolve(resData.data);\r\n            } else {\r\n                if (retryCount > config.requestRetry) {\r\n                    resolve({});\r\n                }\r\n                setTimeout(() => {\r\n                    page.reload().then();\r\n                    retryCount++;\r\n                }, 3000);\r\n            }\r\n        } else if (res.ok() && res.url().includes('/live_api/baseuser/userinfo/byid')) {\r\n            // principalId\r\n            const resData = await res.json();\r\n            userInfo = resData.data.userInfo;\r\n        }\r\n    });\r\n    await page.goto('https://www.kuaishou.com', {\r\n        waitUntil: 'domcontentloaded',\r\n    });\r\n    await page.goto(`https://live.kuaishou.com/profile/${principalId}`);\r\n    const resData = (await promise.catch((error) => error)) as Array<any>;\r\n\r\n    await browser.close();\r\n    const data: Data = {\r\n        title: userInfo?.name ?? `${principalId}的作品 - 快手`,\r\n        // description: JSON.stringify(resData),\r\n        item:\r\n            resData?.list?.map((item) => ({\r\n                // title: '',\r\n                author: item.author.name,\r\n                description: `<video controls preload=\"metadata\" poster=\"${item.poster}\">\r\n                    <source src=\"${item.playUrl}\" type=\"video/mp4\">\r\n                </video>`,\r\n                // link: '',\r\n                id: item.id,\r\n                guid: item.id,\r\n                banner: item.poster,\r\n                media: {\r\n                    content: { url: item.playUrl },\r\n                },\r\n            })) || [],\r\n    };\r\n    return data;\r\n}\r\n"],"mappings":"mKAGA,MAAaA,EAAe,CACxB,KAAM,UACN,KAAM,wBACN,MAAO,CACH,CACI,OAAQ,CAAC,qCACT,OAAQ,0BAGhB,WAAY,CACR,YAAa,kBAEjB,QAAS,oCACT,YAAa,CAAC,gBACd,IAAK,oCACL,YAAa;;KAGb,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,eAAgB,EAAI,IAAI,QAC1B,EAAU,MAAMC,IAChB,EAAO,MAAM,EAAQ,UAEvB,EAAa,EACb,EACA,EACE,EAAU,IAAI,QAAS,GAAQ,CACjC,EAAU,IAEd,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAQ,CACxB,IAAM,EAAe,EAAI,eACrB,IAAiB,SAAW,IAAiB,SAAW,IAAiB,QAAU,IAAiB,cAAgB,IAAiB,OACrI,EAAI,QAEJ,EAAI,aAGZ,EAAK,GAAG,WAAY,KAAO,IAAQ,CAC/B,GAAI,EAAI,MAAQ,EAAI,MAAM,SAAS,4BAA6B,CAC5D,IAAMC,EAAU,MAAM,EAAI,OACtBA,EAAQ,KAAK,KAAK,OAAS,EAC3B,EAAQA,EAAQ,OAEZ,EAAa,EAAO,cACpB,EAAQ,IAEZ,eAAiB,CACb,EAAK,SAAS,OACd,KACD,cAEA,EAAI,MAAQ,EAAI,MAAM,SAAS,oCAAqC,CAE3E,IAAMA,EAAU,MAAM,EAAI,OAC1B,EAAWA,EAAQ,KAAK,YAGhC,MAAM,EAAK,KAAK,2BAA4B,CACxC,UAAW,qBAEf,MAAM,EAAK,KAAK,qCAAqC,KACrD,IAAM,EAAW,MAAM,EAAQ,MAAO,GAAU,GAEhD,MAAM,EAAQ,QACd,IAAMC,EAAa,CACf,MAAO,GAAU,MAAQ,GAAG,EAAY,UAExC,KACI,GAAS,MAAM,IAAK,IAAU,CAE1B,OAAQ,EAAK,OAAO,KACpB,YAAa,8CAA8C,EAAK,OAAO;mCACpD,EAAK,QAAQ;0BAGhC,GAAI,EAAK,GACT,KAAM,EAAK,GACX,OAAQ,EAAK,OACb,MAAO,CACH,QAAS,CAAE,IAAK,EAAK,cAEtB,IAEf,OAAO"}