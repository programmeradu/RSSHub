{"version":3,"file":"profile-BUgWqME-.js","names":["route: Route","ofetch","src: string"],"sources":["../../lib/routes/follow/profile.ts"],"sourcesContent":["import { ViewType, type Data, type Route } from '@/types';\r\nimport type { Context } from 'hono';\r\nimport ofetch from '@/utils/ofetch';\r\nimport type { FeedSubscription, FollowResponse, InboxSubscription, ListSubscription, Profile, Subscription } from './types';\r\nimport { parse } from 'tldts';\r\n\r\nexport const route: Route = {\r\n    name: 'User subscriptions',\r\n    categories: ['social-media'],\r\n    path: '/profile/:uid',\r\n    example: '/follow/profile/41279032429549568',\r\n    parameters: {\r\n        uid: 'User ID or user handle',\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['app.follow.is/profile/:uid'],\r\n            target: '/profile/:uid',\r\n        },\r\n    ],\r\n    handler,\r\n    maintainers: ['KarasuShin', 'DIYgod', 'DFobain'],\r\n    features: {\r\n        supportRadar: true,\r\n    },\r\n    view: ViewType.Notifications,\r\n};\r\n\r\nconst isList = (subscription: Subscription): subscription is ListSubscription => 'lists' in subscription;\r\n\r\nconst isInbox = (subscription: Subscription): subscription is InboxSubscription => 'inboxId' in subscription;\r\n\r\nconst isFeed = (subscription: Subscription): subscription is FeedSubscription => 'feeds' in subscription;\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const handleOrId = ctx.req.param('uid');\r\n    const host = 'https://api.follow.is';\r\n\r\n    const handle = isBizId(handleOrId || '') ? handleOrId : handleOrId.startsWith('@') ? handleOrId.slice(1) : handleOrId;\r\n\r\n    const searchParams = new URLSearchParams({ handle });\r\n\r\n    if (isBizId(handle || '')) {\r\n        searchParams.append('id', handle);\r\n    }\r\n\r\n    const profile = await ofetch<FollowResponse<Profile>>(`${host}/profiles?${searchParams.toString()}`);\r\n    const subscriptions = await ofetch<FollowResponse<Subscription[]>>(`${host}/subscriptions?userId=${profile.data.id}`);\r\n\r\n    return {\r\n        title: `${profile.data.name}'s subscriptions`,\r\n        item: (<Exclude<Subscription, InboxSubscription>[]>subscriptions.data.filter((i) => !isInbox(i) && !(isFeed(i) && !!i.feeds.errorAt))).map((subscription) => {\r\n            if (isList(subscription)) {\r\n                return {\r\n                    title: subscription.lists.title,\r\n                    description: subscription.lists.description,\r\n                    link: `https://app.follow.is/list/${subscription.listId}`,\r\n                    image: subscription.lists.image,\r\n                };\r\n            }\r\n            return {\r\n                title: subscription.feeds.title,\r\n                description: subscription.feeds.description,\r\n                link: `https://app.follow.is/feed/${subscription.feedId}`,\r\n                image: getUrlIcon(subscription.feeds.siteUrl).src,\r\n                category: subscription.category ? [subscription.category] : undefined,\r\n            };\r\n        }),\r\n        link: `https://app.follow.is/share/users/${handleOrId}`,\r\n        image: profile.data.image,\r\n    };\r\n}\r\n\r\nconst getUrlIcon = (url: string, fallback?: boolean | undefined) => {\r\n    let src: string;\r\n    let fallbackUrl = '';\r\n\r\n    try {\r\n        const { host } = new URL(url);\r\n        const pureDomain = parse(host).domainWithoutSuffix;\r\n        fallbackUrl = `https://avatar.vercel.sh/${pureDomain}.svg?text=${pureDomain?.slice(0, 2).toUpperCase()}`;\r\n        src = `https://unavatar.follow.is/${host}?fallback=${fallback || false}`;\r\n    } catch {\r\n        const pureDomain = parse(url).domainWithoutSuffix;\r\n        src = `https://avatar.vercel.sh/${pureDomain}.svg?text=${pureDomain?.slice(0, 2).toUpperCase()}`;\r\n    }\r\n    const ret = {\r\n        src,\r\n        fallbackUrl,\r\n    };\r\n\r\n    return ret;\r\n};\r\n\r\n// referenced from https://github.com/RSSNext/Follow/blob/dev/packages/utils/src/utils.ts\r\nconst EPOCH = 1_712_546_615_000n; // follow repo created\r\nconst MAX_TIMESTAMP_BITS = 41n; // Maximum number of bits typically used for timestamp\r\nexport const isBizId = (id: string): boolean => {\r\n    if (!id || !/^\\d{13,19}$/.test(id)) {\r\n        return false;\r\n    }\r\n\r\n    const snowflake = BigInt(id);\r\n\r\n    // Extract the timestamp assuming it's in the most significant bits after the sign bit\r\n    const timestamp = (snowflake >> (63n - MAX_TIMESTAMP_BITS)) + EPOCH;\r\n    const date = new Date(Number(timestamp));\r\n\r\n    // Check if the date is reasonable (between 2024 and 2050)\r\n    if (date.getFullYear() >= 2024 && date.getFullYear() <= 2050) {\r\n        // Additional validation: check if the ID is not larger than the maximum possible value\r\n        const maxPossibleId = (1n << 63n) - 1n; // Maximum possible 63-bit value\r\n        if (snowflake <= maxPossibleId) {\r\n            return true;\r\n        }\r\n    }\r\n\r\n    return false;\r\n};\r\n"],"mappings":"wPAMA,MAAaA,EAAe,CACxB,KAAM,qBACN,WAAY,CAAC,gBACb,KAAM,gBACN,QAAS,oCACT,WAAY,CACR,IAAK,0BAET,MAAO,CACH,CACI,OAAQ,CAAC,8BACT,OAAQ,kBAGhB,UACA,YAAa,CAAC,aAAc,SAAU,WACtC,SAAU,CACN,aAAc,IAElB,KAAM,EAAS,eAGb,EAAU,GAAiE,UAAW,EAEtF,EAAW,GAAkE,YAAa,EAE1F,EAAU,GAAiE,UAAW,EAE5F,eAAe,EAAQ,EAA6B,CAChD,IAAM,EAAa,EAAI,IAAI,MAAM,OAC3B,EAAO,wBAEP,EAAS,EAAQ,GAAc,IAAM,EAAa,EAAW,WAAW,KAAO,EAAW,MAAM,GAAK,EAErG,EAAe,IAAI,gBAAgB,CAAE,WAEvC,EAAQ,GAAU,KAClB,EAAa,OAAO,KAAM,GAG9B,IAAM,EAAU,MAAMC,EAAgC,GAAG,EAAK,YAAY,EAAa,cACjF,EAAgB,MAAMA,EAAuC,GAAG,EAAK,wBAAwB,EAAQ,KAAK,MAEhH,MAAO,CACH,MAAO,GAAG,EAAQ,KAAK,KAAK,kBAC5B,KAAmD,EAAc,KAAK,OAAQ,GAAM,CAAC,EAAQ,IAAM,EAAE,EAAO,IAAQ,EAAE,MAAM,UAAW,IAAK,GACpI,EAAO,GACA,CACH,MAAO,EAAa,MAAM,MAC1B,YAAa,EAAa,MAAM,YAChC,KAAM,8BAA8B,EAAa,SACjD,MAAO,EAAa,MAAM,OAG3B,CACH,MAAO,EAAa,MAAM,MAC1B,YAAa,EAAa,MAAM,YAChC,KAAM,8BAA8B,EAAa,SACjD,MAAO,EAAW,EAAa,MAAM,SAAS,IAC9C,SAAU,EAAa,SAAW,CAAC,EAAa,UAAY,IAAA,KAGpE,KAAM,qCAAqC,IAC3C,MAAO,EAAQ,KAAK,OAI5B,MAAM,GAAc,EAAa,IAAmC,CAChE,IAAIC,EACA,EAAc,GAElB,GAAI,CACA,GAAM,CAAE,QAAS,IAAI,IAAI,GACnB,EAAa,EAAM,GAAM,oBAC/B,EAAc,4BAA4B,EAAW,YAAY,GAAY,MAAM,EAAG,GAAG,gBACzF,EAAM,8BAA8B,EAAK,YAAY,GAAY,UAC7D,CACJ,IAAM,EAAa,EAAM,GAAK,oBAC9B,EAAM,4BAA4B,EAAW,YAAY,GAAY,MAAM,EAAG,GAAG,gBAErF,IAAM,EAAM,CACR,MACA,eAGJ,OAAO,GAME,EAAW,GAAwB,CAC5C,GAAI,CAAC,GAAM,CAAC,cAAc,KAAK,GAC3B,MAAO,GAGX,IAAM,EAAY,OAAO,GAGnB,GAAa,GAAc,IAAM,KAAuB,eACxD,EAAO,IAAI,KAAK,OAAO,IAG7B,GAAI,EAAK,eAAiB,MAAQ,EAAK,eAAiB,KAAM,CAE1D,IAAM,GAAiB,IAAM,KAAO,GACpC,GAAI,GAAa,EACb,MAAO,GAIf,MAAO"}