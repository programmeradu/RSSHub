{"version":3,"file":"series-iqD6HOcL.js","names":["route: Route","ofetch","items: DataItem[]"],"sources":["../../lib/routes/tver/series.ts"],"sourcesContent":["import { Route, Data, DataItem } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { Context } from 'hono';\r\n\r\nexport const route: Route = {\r\n    path: '/series/:id',\r\n    categories: ['traditional-media'],\r\n    example: '/tver/series/srx2o7o3c8',\r\n    parameters: {\r\n        id: 'Series ID (as it appears in URLs). For example, in https://tver.jp/series/srx2o7o3c8, the ID is \"srx2o7o3c8\".',\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['tver.jp/series/:id'],\r\n            target: '/series/:id',\r\n        },\r\n    ],\r\n    name: 'Series',\r\n    maintainers: ['yuikisaito'],\r\n    handler,\r\n};\r\n\r\nconst commonHeaders = {\r\n    Accept: '*/*',\r\n    'Accept-Language': 'ja,en-US;q=0.7,en;q=0.3',\r\n    'Cache-Control': 'no-cache',\r\n    Pragma: 'no-cache',\r\n    'Sec-GPC': '1',\r\n    'Sec-Fetch-Dest': 'empty',\r\n    'Sec-Fetch-Mode': 'cors',\r\n    'Sec-Fetch-Site': 'same-site',\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const { id } = ctx.req.param();\r\n\r\n    const { result: browser } = await ofetch('https://platform-api.tver.jp/v2/api/platform_users/browser/create', {\r\n        method: 'POST',\r\n        body: 'device_type=pc',\r\n        headers: {\r\n            ...commonHeaders,\r\n            'Content-Type': 'application/x-www-form-urlencoded',\r\n        },\r\n        referrer: 'https://s.tver.jp/',\r\n        credentials: 'omit',\r\n        mode: 'cors',\r\n    });\r\n\r\n    const { platform_uid, platform_token } = browser;\r\n\r\n    const { title, description, broadcastProvider } = await ofetch(`https://statics.tver.jp/content/series/${id}.json`, {\r\n        method: 'GET',\r\n        headers: {\r\n            ...commonHeaders,\r\n        },\r\n        referrer: 'https://tver.jp/',\r\n        credentials: 'omit',\r\n        mode: 'cors',\r\n    });\r\n\r\n    const { result } = await ofetch(`https://platform-api.tver.jp/service/api/v1/callSeriesEpisodes/${id}?platform_uid=${platform_uid}&platform_token=${platform_token}`, {\r\n        method: 'GET',\r\n        headers: {\r\n            ...commonHeaders,\r\n            'x-tver-platform-type': 'web',\r\n        },\r\n        referrer: 'https://tver.jp/',\r\n        credentials: 'omit',\r\n        mode: 'cors',\r\n    });\r\n\r\n    const items: DataItem[] = (result.contents?.[0]?.contents ?? [])\r\n        .filter((i) => i.type === 'episode')\r\n        .map((i) => {\r\n            const rawPubDate = i.content.broadcastDateLabel;\r\n            const cleanedPubDate = rawPubDate.replaceAll(/\\(.*?\\)|放送分/g, '').trim();\r\n            const parsedPubDate = timezone(parseDate(cleanedPubDate, 'M月D日'), +9).toDateString();\r\n\r\n            return {\r\n                title: i.content.title,\r\n                link: `https://tver.jp/episodes/${i.content.id}`,\r\n                image: `https://statics.tver.jp/images/content/thumbnail/episode/xlarge/${i.content.id}.jpg`,\r\n                pubDate: parsedPubDate,\r\n            };\r\n        });\r\n\r\n    return {\r\n        title: 'TVer - ' + title,\r\n        description,\r\n        author: broadcastProvider.name,\r\n        link: `https://tver.jp/series/${id}`,\r\n        image: `https://statics.tver.jp/images/content/thumbnail/series/xlarge/${id}.jpg`,\r\n        language: 'ja',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"kRAMA,MAAaA,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,qBACb,QAAS,0BACT,WAAY,CACR,GAAI,iHAER,MAAO,CACH,CACI,OAAQ,CAAC,sBACT,OAAQ,gBAGhB,KAAM,SACN,YAAa,CAAC,cACd,WAGE,EAAgB,CAClB,OAAQ,MACR,kBAAmB,0BACnB,gBAAiB,WACjB,OAAQ,WACR,UAAW,IACX,iBAAkB,QAClB,iBAAkB,OAClB,iBAAkB,aAGtB,eAAe,EAAQ,EAA6B,CAChD,GAAM,CAAE,MAAO,EAAI,IAAI,QAEjB,CAAE,OAAQ,GAAY,MAAMC,EAAO,oEAAqE,CAC1G,OAAQ,OACR,KAAM,iBACN,QAAS,CACL,GAAG,EACH,eAAgB,qCAEpB,SAAU,qBACV,YAAa,OACb,KAAM,SAGJ,CAAE,eAAc,kBAAmB,EAEnC,CAAE,QAAO,cAAa,qBAAsB,MAAMA,EAAO,0CAA0C,EAAG,OAAQ,CAChH,OAAQ,MACR,QAAS,CACL,GAAG,GAEP,SAAU,mBACV,YAAa,OACb,KAAM,SAGJ,CAAE,UAAW,MAAMA,EAAO,kEAAkE,EAAG,gBAAgB,EAAa,kBAAkB,IAAkB,CAClK,OAAQ,MACR,QAAS,CACL,GAAG,EACH,uBAAwB,OAE5B,SAAU,mBACV,YAAa,OACb,KAAM,SAGJC,GAAqB,EAAO,WAAW,IAAI,UAAY,IACxD,OAAQ,GAAM,EAAE,OAAS,WACzB,IAAK,GAAM,CACR,IAAM,EAAa,EAAE,QAAQ,mBACvB,EAAiB,EAAW,WAAW,eAAgB,IAAI,OAC3D,EAAgB,EAAS,EAAU,EAAgB,QAAS,GAAI,eAEtE,MAAO,CACH,MAAO,EAAE,QAAQ,MACjB,KAAM,4BAA4B,EAAE,QAAQ,KAC5C,MAAO,mEAAmE,EAAE,QAAQ,GAAG,MACvF,QAAS,KAIrB,MAAO,CACH,MAAO,UAAY,EACnB,cACA,OAAQ,EAAkB,KAC1B,KAAM,0BAA0B,IAChC,MAAO,kEAAkE,EAAG,MAC5E,SAAU,KACV,KAAM"}