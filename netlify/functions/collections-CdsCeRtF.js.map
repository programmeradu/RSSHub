{"version":3,"file":"collections-CdsCeRtF.js","names":[],"sources":["../../lib/routes/bangumi.tv/user/collections.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\n// 合并不同 subjectType 的 type 映射\r\nconst getTypeNames = (subjectType) => {\r\n    const commonTypeNames = {\r\n        1: '想看',\r\n        2: '看过',\r\n        3: '在看',\r\n        4: '搁置',\r\n        5: '抛弃',\r\n    };\r\n\r\n    switch (subjectType) {\r\n        case '1': // 书籍\r\n            return {\r\n                1: '想读',\r\n                2: '读过',\r\n                3: '在读',\r\n                4: '搁置',\r\n                5: '抛弃',\r\n            };\r\n        case '2': // 动画\r\n        case '6': // 三次元\r\n            return commonTypeNames;\r\n        case '3': // 音乐\r\n            return {\r\n                1: '想听',\r\n                2: '听过',\r\n                3: '在听',\r\n                4: '搁置',\r\n                5: '抛弃',\r\n            };\r\n        case '4': // 游戏\r\n            return {\r\n                1: '想玩',\r\n                2: '玩过',\r\n                3: '在玩',\r\n                4: '搁置',\r\n                5: '抛弃',\r\n            };\r\n        default:\r\n            return commonTypeNames; // 默认使用通用的类型\r\n    }\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/user/collections/:id/:subjectType/:type',\r\n    categories: ['anime'],\r\n    example: '/bangumi.tv/user/collections/sai/1/1',\r\n    parameters: {\r\n        id: '用户 id, 在用户页面地址栏查看',\r\n        subjectType: {\r\n            description: '全部类别: `空`、book: `1`、anime: `2`、music: `3`、game: `4`、real: `6`',\r\n            options: [\r\n                { value: 'ALL', label: 'all' },\r\n                { value: 'book', label: '1' },\r\n                { value: 'anime', label: '2' },\r\n                { value: 'music', label: '3' },\r\n                { value: 'game', label: '4' },\r\n                { value: 'real', label: '6' },\r\n            ],\r\n        },\r\n        type: {\r\n            description: '全部类别: `空`、想看: `1`、看过: `2`、在看: `3`、搁置: `4`、抛弃: `5`',\r\n            options: [\r\n                { value: 'ALL', label: 'all' },\r\n                { value: '想看', label: '1' },\r\n                { value: '看过', label: '2' },\r\n                { value: '在看', label: '3' },\r\n                { value: '搁置', label: '4' },\r\n                { value: '抛弃', label: '5' },\r\n            ],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['bgm.tv/anime/list/:id'],\r\n            target: '/bangumi.tv/user/collections/:id/all/all',\r\n        },\r\n        {\r\n            source: ['bangumi.tv/anime/list/:id'],\r\n            target: '/bangumi.tv/user/collections/:id/all/all',\r\n        },\r\n        {\r\n            source: ['bgm.tv/anime/list/:id/wish'],\r\n            target: '/bangumi.tv/user/collections/:id/2/1',\r\n        },\r\n        {\r\n            source: ['bangumi.tv/anime/list/:id/wish'],\r\n            target: '/bangumi.tv/user/collections/:id/2/1',\r\n        },\r\n    ],\r\n    name: 'Bangumi 用户收藏列表',\r\n    maintainers: ['youyou-sudo', 'honue'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const userId = ctx.req.param('id');\r\n    const subjectType = ctx.req.param('subjectType') || '';\r\n    const type = ctx.req.param('type') || '';\r\n\r\n    const subjectTypeNames = {\r\n        1: '书籍',\r\n        2: '动画',\r\n        3: '音乐',\r\n        4: '游戏',\r\n        6: '三次元',\r\n    };\r\n\r\n    const typeNames = getTypeNames(subjectType);\r\n    const typeName = typeNames[type] || '';\r\n    const subjectTypeName = subjectTypeNames[subjectType] || '';\r\n\r\n    let descriptionFields = '';\r\n\r\n    if (typeName && subjectTypeName) {\r\n        descriptionFields = `${typeName}的${subjectTypeName}列表`;\r\n    } else if (typeName) {\r\n        descriptionFields = `${typeName}的列表`;\r\n    } else if (subjectTypeName) {\r\n        descriptionFields = `收藏的${subjectTypeName}列表`;\r\n    } else {\r\n        descriptionFields = '的Bangumi收藏列表';\r\n    }\r\n\r\n    const userDataUrl = `https://api.bgm.tv/v0/users/${userId}`;\r\n    const userData = await ofetch(userDataUrl, {\r\n        headers: {\r\n            'User-Agent': config.trueUA,\r\n        },\r\n    });\r\n\r\n    const collectionDataUrl = `https://api.bgm.tv/v0/users/${userId}/collections?${subjectType && subjectType !== 'all' ? `subject_type=${subjectType}` : ''}${type && type !== 'all' ? `&type=${type}` : ''}`;\r\n    const collectionData = await ofetch(collectionDataUrl, {\r\n        headers: {\r\n            'User-Agent': config.trueUA,\r\n        },\r\n    });\r\n\r\n    const userNickname = userData.nickname;\r\n    const items = collectionData.data.map((item) => {\r\n        const titles = item.subject.name_cn || item.subject.name;\r\n        const updateTime = item.updated_at;\r\n        const subjectId = item.subject_id;\r\n\r\n        return {\r\n            title: `${type === 'all' ? `${getTypeNames(item.subject_type)[item.type]}：` : ''}${titles}`,\r\n            description: art(path.join(__dirname, '../templates/subject.art'), {\r\n                routeSubjectType: subjectType,\r\n                subjectTypeName: subjectTypeNames[item.subject_type],\r\n                subjectType: item.subject_type,\r\n                subjectEps: item.subject.eps,\r\n                epStatus: item.ep_status,\r\n                score: item.subject.score,\r\n                date: item.subject.date,\r\n                picUrl: item.subject.images.large,\r\n            }),\r\n            link: `https://bgm.tv/subject/${subjectId}`,\r\n            pubDate: timezone(parseDate(updateTime), 0),\r\n        };\r\n    });\r\n    return {\r\n        title: `${userNickname}${descriptionFields}`,\r\n        link: `https://bgm.tv/user/${userId}/collections`,\r\n        item: items,\r\n        description: `${userNickname}${descriptionFields}`,\r\n    };\r\n}\r\n"],"mappings":"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"}