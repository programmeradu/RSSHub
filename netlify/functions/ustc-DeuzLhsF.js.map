{"version":3,"file":"ustc-DeuzLhsF.js","names":["route: Route","got","cache","response","$"],"sources":["../../lib/routes/ustc/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nconst notice_type = {\r\n    jx: { title: '中国科学技术大学 - 教学类通知', url: 'https://ustc.edu.cn/tzgg/jxltz.htm' },\r\n    ky: { title: '中国科学技术大学 - 科研类通知', url: 'https://ustc.edu.cn/tzgg/kyltz.htm' },\r\n    gl: { title: '中国科学技术大学 - 管理类通知', url: 'https://ustc.edu.cn/tzgg/glltz.htm' },\r\n    fw: { title: '中国科学技术大学 - 服务类通知', url: 'https://ustc.edu.cn/tzgg/fwltz.htm' },\r\n};\r\n\r\n// 对防抓的措施\r\n// function getCookie(ctx) {\r\n//     const cache_key = `ustc-cookie-${new Date().toLocaleDateString()}`;\r\n//     return cache.tryGet(cache_key, async () => {\r\n//         const { headers } = await got('https://ustc.edu.cn/system/resource/code/datainput.jsp', {\r\n//             headers: { 'user-agent': UA },\r\n//         });\r\n//         const cookie = headers['set-cookie']\r\n//             .filter((c) => c.match(/(user_trace_token|X_HTTP_TOKEN)/))\r\n//             .map((c) => c.split(';')[0])\r\n//             .join('; ');\r\n//         return cookie;\r\n//     });\r\n// }\r\n\r\nexport const route: Route = {\r\n    path: '/news/:type?',\r\n    categories: ['university'],\r\n    example: '/ustc/news/gl',\r\n    parameters: { type: '分类，默认为管理类' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['ustc.edu.cn/'],\r\n            target: '/news',\r\n        },\r\n    ],\r\n    name: '官网通知公告',\r\n    maintainers: ['hang333', 'jasongzy'],\r\n    handler,\r\n    url: 'ustc.edu.cn/',\r\n    description: `| 教学类 | 科研类 | 管理类 | 服务类 |\r\n| ------ | ------ | ------ | ------ |\r\n| jx     | ky     | gl     | fw     |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const type = ctx.req.param('type') ?? 'gl';\r\n    // 发起 HTTP GET 请求\r\n    const response = await got({\r\n        method: 'get',\r\n\r\n        /* headers: {\r\n            'user-agent': UA,\r\n            cookie: await getCookie(ctx),\r\n        }, */\r\n        url: notice_type[type].url,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n    let items = $('table[portletmode=simpleList] > tbody > tr.light')\r\n        .toArray()\r\n        .map((element) => {\r\n            const child = $(element).children();\r\n            const info = {\r\n                title: $(child[1]).find('a').attr('title'),\r\n                link: $(child[1]).find('a').attr('href').startsWith('../') ? new URL($(child[1]).find('a').attr('href'), notice_type[type].url).href : $(child[1]).find('a').attr('href'),\r\n                pubDate: timezone(parseDate($(child[2]).text(), 'YYYY-MM-DD'), +8),\r\n            };\r\n            return info;\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items\r\n            .filter((item) => item.link)\r\n            .map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    try {\r\n                        const response = await got(item.link);\r\n                        const $ = load(response.data);\r\n\r\n                        item.description = $('div.v_news_content').html();\r\n                    } catch {\r\n                        // intranet contents\r\n                    }\r\n                    return item;\r\n                })\r\n            )\r\n    );\r\n\r\n    return {\r\n        title: notice_type[type].title,\r\n        description: notice_type[type].title,\r\n        link: notice_type[type].url,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"0ZAOA,MAAM,EAAc,CAChB,GAAI,CAAE,MAAO,mBAAoB,IAAK,sCACtC,GAAI,CAAE,MAAO,mBAAoB,IAAK,sCACtC,GAAI,CAAE,MAAO,mBAAoB,IAAK,sCACtC,GAAI,CAAE,MAAO,mBAAoB,IAAK,uCAkB7BA,EAAe,CACxB,KAAM,eACN,WAAY,CAAC,cACb,QAAS,gBACT,WAAY,CAAE,KAAM,aACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,gBACT,OAAQ,UAGhB,KAAM,SACN,YAAa,CAAC,UAAW,YACzB,UACA,IAAK,eACL,YAAa;;wCAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,KAEhC,EAAW,MAAMC,EAAI,CACvB,OAAQ,MAMR,IAAK,EAAY,GAAM,MAGrB,EAAI,EAAK,EAAS,MACpB,EAAQ,EAAE,oDACT,UACA,IAAK,GAAY,CACd,IAAM,EAAQ,EAAE,GAAS,WACnB,EAAO,CACT,MAAO,EAAE,EAAM,IAAI,KAAK,KAAK,KAAK,SAClC,KAAM,EAAE,EAAM,IAAI,KAAK,KAAK,KAAK,QAAQ,WAAW,OAAS,IAAI,IAAI,EAAE,EAAM,IAAI,KAAK,KAAK,KAAK,QAAS,EAAY,GAAM,KAAK,KAAO,EAAE,EAAM,IAAI,KAAK,KAAK,KAAK,QAClK,QAAS,EAAS,EAAU,EAAE,EAAM,IAAI,OAAQ,cAAe,IAEnE,OAAO,IAqBf,MAlBA,GAAQ,MAAM,QAAQ,IAClB,EACK,OAAQ,GAAS,EAAK,MACtB,IAAK,GACFC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,CACA,IAAMC,EAAW,MAAMF,EAAI,EAAK,MAC1BG,EAAI,EAAKD,EAAS,MAExB,EAAK,YAAcC,EAAE,sBAAsB,YACvC,EAGR,OAAO,MAKhB,CACH,MAAO,EAAY,GAAM,MACzB,YAAa,EAAY,GAAM,MAC/B,KAAM,EAAY,GAAM,IACxB,KAAM"}