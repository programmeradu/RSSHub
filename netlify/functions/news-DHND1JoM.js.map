{"version":3,"file":"news-DHND1JoM.js","names":[],"sources":["../../lib/routes/kamen-rider-official/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/news/:category?',\r\n    categories: ['new-media'],\r\n    example: '/kamen-rider-official/news',\r\n    parameters: { category: 'Category, see below, すべて by default' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '最新情報',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| Category                               |\r\n| -------------------------------------- |\r\n| すべて                                 |\r\n| テレビ                                 |\r\n| 映画・V シネマ等                       |\r\n| Blu-ray・DVD、配信等                   |\r\n| 20 作記念グッズ・東映 EC 商品          |\r\n| 石ノ森章太郎生誕 80 周年記念商品       |\r\n| 玩具・カード                           |\r\n| 食品・飲料・菓子                       |\r\n| 子供生活雑貨                           |\r\n| アパレル・大人向け雑貨                 |\r\n| フィギュア・ホビー・一番くじ・プライズ |\r\n| ゲーム・デジタル                       |\r\n| 雑誌・書籍・漫画                       |\r\n| 音楽                                   |\r\n| 映像                                   |\r\n| イベント                               |\r\n| ホテル・レストラン等                   |\r\n| キャンペーン・タイアップ等             |\r\n| その他                                 |\r\n| KAMEN RIDER STORE                      |\r\n| THE 鎧武祭り                           |\r\n| 鎧武外伝                               |\r\n| 仮面ライダーリバイス                   |\r\n| ファイナルステージ                     |\r\n| THE50 周年展                           |\r\n| 風都探偵                               |\r\n| 仮面ライダーギーツ                     |\r\n| 仮面ライダーアウトサイダーズ           |\r\n| 仮面ライダーガッチャード               |\r\n| 仮面ライダー BLACK SUN                 |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category');\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 50;\r\n\r\n    const rootUrl = 'https://www.kamen-rider-official.com';\r\n    const apiUrl = new URL('api/v1/news_articles', rootUrl).href;\r\n    const currentUrl = new URL(`news_articles/${category ? `?category=${category}` : ''}`, rootUrl).href;\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const buildId = currentResponse.match(/\"buildId\":\"(.*?)\"/)[1];\r\n\r\n    const apiCategoryUrl = new URL(`_next/data/${buildId}/news_articles.json`, rootUrl).href;\r\n\r\n    const { data: categoryResponse } = await got(apiCategoryUrl);\r\n\r\n    const id = categoryResponse.pageProps.categoryIds[category];\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: {\r\n            category_id: id,\r\n            limit,\r\n            offset: 0,\r\n        },\r\n    });\r\n\r\n    let items = response.news_articles.slice(0, limit).map((item) => ({\r\n        title: item.list_title,\r\n        link: new URL(item.path, rootUrl).href,\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            image: item.list_image_path\r\n                ? {\r\n                      src: new URL(item.list_image_path, rootUrl).href,\r\n                      alt: item.list_title,\r\n                  }\r\n                : undefined,\r\n        }),\r\n        author: item.author,\r\n        category: [item.category_name, item.category_2_name].filter(Boolean),\r\n        guid: `kamen-rider-official-${item.id}`,\r\n        pubDate: parseDate(item.release_date),\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                content('a.c-button').each(function () {\r\n                    content(this).parent().remove();\r\n                });\r\n\r\n                content('img').each(function () {\r\n                    content(this).replaceWith(\r\n                        art(path.join(__dirname, 'templates/description.art'), {\r\n                            image: {\r\n                                src: content(this).prop('src'),\r\n                            },\r\n                        })\r\n                    );\r\n                });\r\n\r\n                item.title = content('h1.p-post__title').text() || item.title;\r\n                item.description = content('main.p-post__main').html();\r\n                item.author = content('div.p-post__responsibility p')\r\n                    .toArray()\r\n                    .map((a) => content(a).text())\r\n                    .join(' / ');\r\n                item.category = [\r\n                    ...new Set(\r\n                        [\r\n                            ...item.category,\r\n                            ...content('ul.p-post__categories li a.p-post__category')\r\n                                .toArray()\r\n                                .map((c) => content(c).text().trim()),\r\n                        ].filter(Boolean)\r\n                    ),\r\n                ];\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const icon = new URL($('link[rel=\"icon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: `${$('title').text().split(/ー/)[0]}${category ? ` - ${category}` : ''}`,\r\n        link: currentUrl,\r\n        description: $('meta[property=\"og:description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image: $('meta[property=\"og:image\"]').prop('content'),\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[property=\"keywords\"]').prop('content'),\r\n        author: $('meta[property=\"og:site_name\"]').prop('content'),\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,mBACN,WAAY,CAAC,aACb,QAAS,6BACT,WAAY,CAAE,SAAU,uCACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;uCAkCjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,YACzB,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,uCACV,EAAS,IAAI,IAAI,uBAAwB,GAAS,KAClD,EAAa,IAAI,IAAI,iBAAiB,EAAW,aAAa,IAAa,KAAM,GAAS,KAE1F,CAAE,KAAM,GAAoB,MAAM,EAAI,GAEtC,EAAU,EAAgB,MAAM,qBAAqB,GAErD,EAAiB,IAAI,IAAI,cAAc,EAAQ,qBAAsB,GAAS,KAE9E,CAAE,KAAM,GAAqB,MAAM,EAAI,GAEvC,EAAK,EAAiB,UAAU,YAAY,GAE5C,CAAE,KAAM,GAAa,MAAM,EAAI,EAAQ,CACzC,aAAc,CACV,YAAa,EACb,QACA,OAAQ,KAIZ,EAAQ,EAAS,cAAc,MAAM,EAAG,GAAO,IAAK,IAAU,CAC9D,MAAO,EAAK,WACZ,KAAM,IAAI,IAAI,EAAK,KAAM,GAAS,KAClC,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,EAAK,gBACN,CACI,IAAK,IAAI,IAAI,EAAK,gBAAiB,GAAS,KAC5C,IAAK,EAAK,YAEd,IAAA,KAEV,OAAQ,EAAK,OACb,SAAU,CAAC,EAAK,cAAe,EAAK,iBAAiB,OAAO,SAC5D,KAAM,wBAAwB,EAAK,KACnC,QAAS,EAAU,EAAK,iBAG5B,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GAiCrB,OA/BA,EAAQ,cAAc,KAAK,UAAY,CACnC,EAAQ,MAAM,SAAS,WAG3B,EAAQ,OAAO,KAAK,UAAY,CAC5B,EAAQ,MAAM,YACV,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACnD,MAAO,CACH,IAAK,EAAQ,MAAM,KAAK,aAMxC,EAAK,MAAQ,EAAQ,oBAAoB,QAAU,EAAK,MACxD,EAAK,YAAc,EAAQ,qBAAqB,OAChD,EAAK,OAAS,EAAQ,gCACjB,UACA,IAAK,GAAM,EAAQ,GAAG,QACtB,KAAK,OACV,EAAK,SAAW,CACZ,GAAG,IAAI,IACH,CACI,GAAG,EAAK,SACR,GAAG,EAAQ,+CACN,UACA,IAAK,GAAM,EAAQ,GAAG,OAAO,SACpC,OAAO,WAIV,MAKnB,IAAM,EAAI,EAAK,GAET,EAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,QAAS,GAAS,KAElE,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAE,SAAS,OAAO,MAAM,KAAK,KAAK,EAAW,MAAM,IAAa,KAC1E,KAAM,EACN,YAAa,EAAE,mCAAmC,KAAK,WACvD,SAAU,EAAE,QAAQ,KAAK,QACzB,MAAO,EAAE,6BAA6B,KAAK,WAC3C,OACA,KAAM,EACN,SAAU,EAAE,6BAA6B,KAAK,WAC9C,OAAQ,EAAE,iCAAiC,KAAK,WAChD,WAAY"}