{"version":3,"file":"report-C11mQkgm.js","names":[],"sources":["../../lib/routes/logclub/report.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: ['/lc_report/:id?', '/report/:id?'],\r\n    categories: ['new-media'],\r\n    example: '/logclub/lc_report',\r\n    parameters: { id: '报告 id，见下表，默认为罗戈研究出品' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '报告',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 罗戈研究出品 | 物流报告       | 绿色双碳报告          |\r\n| ------------ | -------------- | --------------------- |\r\n| Report       | IndustryReport | GreenDualCarbonReport |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { id = 'Report' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 11;\r\n\r\n    const rootUrl = 'https://www.logclub.com';\r\n    const currentUrl = new URL('lc_report', rootUrl).href;\r\n    const apiUrl = new URL(`front/lc_report/load${id}List`, rootUrl).href;\r\n\r\n    const { data: response } = await got.post(apiUrl, {\r\n        json: {\r\n            page: 1,\r\n        },\r\n    });\r\n\r\n    let items = response.list.slice(0, limit).map((item) => ({\r\n        title: item.title,\r\n        link: new URL(`front/lc_report/get_report_info/${item.id}`, rootUrl).href,\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            image: {\r\n                src: item.img_url?.split(/\\?/)[0] ?? undefined,\r\n                alt: item.title,\r\n            },\r\n        }),\r\n        author: item.author,\r\n        category: [item.channel_name],\r\n        guid: `logclub-report-${item.id}`,\r\n        pubDate: timezone(parseDate(item.release_time), +8),\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                content('img').each((_, el) => {\r\n                    el = content(el);\r\n                    el.replaceWith(\r\n                        art(path.join(__dirname, 'templates/description.art'), {\r\n                            image: {\r\n                                src: el.prop('src')?.split(/\\?/)[0] ?? undefined,\r\n                                alt: el.prop('title'),\r\n                            },\r\n                        })\r\n                    );\r\n                });\r\n\r\n                item.title = content('h1').first().text();\r\n                item.description += art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: content('div.article-cont').html(),\r\n                });\r\n                item.author = content('div.lc-infos a')\r\n                    .toArray()\r\n                    .map((a) => content(a).text())\r\n                    .join('/');\r\n                item.category = [\r\n                    ...new Set([\r\n                        ...(item.category ?? []),\r\n                        ...content('div.article-label-r a.label')\r\n                            .toArray()\r\n                            .map((c) => content(c).text()),\r\n                    ]),\r\n                ].filter(Boolean);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const title = $('div.this_nav').text().trim();\r\n    const icon = new URL($('link[rel=\"shortcut icon\"]').prop('href'), rootUrl).href;\r\n    const subtitle = $('meta[name=\"keywords\"]').prop('content');\r\n\r\n    return {\r\n        item: items,\r\n        title: `${$('title').text()}${title}`,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: 'zh',\r\n        image: new URL($('div.logo_img img').prop('src'), rootUrl).href,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: subtitle.replaceAll(',', ''),\r\n        author: subtitle.split(/,/)[0],\r\n    };\r\n}\r\n"],"mappings":"0gBAUA,MAAa,EAAe,CACxB,KAAM,CAAC,kBAAmB,gBAC1B,WAAY,CAAC,aACb,QAAS,qBACT,WAAY,CAAE,GAAI,uBAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,WACd,UACA,YAAa;;4DAKjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,KAAK,UAAa,EAAI,IAAI,QAC5B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,0BACV,EAAa,IAAI,IAAI,YAAa,GAAS,KAC3C,EAAS,IAAI,IAAI,uBAAuB,EAAG,MAAO,GAAS,KAE3D,CAAE,KAAM,GAAa,MAAM,EAAI,KAAK,EAAQ,CAC9C,KAAM,CACF,KAAM,KAIV,EAAQ,EAAS,KAAK,MAAM,EAAG,GAAO,IAAK,IAAU,CACrD,MAAO,EAAK,MACZ,KAAM,IAAI,IAAI,mCAAmC,EAAK,KAAM,GAAS,KACrE,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,CACH,IAAK,EAAK,SAAS,MAAM,MAAM,IAAM,IAAA,GACrC,IAAK,EAAK,SAGlB,OAAQ,EAAK,OACb,SAAU,CAAC,EAAK,cAChB,KAAM,kBAAkB,EAAK,KAC7B,QAAS,EAAS,EAAU,EAAK,cAAe,MAGpD,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GA+BrB,OA7BA,EAAQ,OAAO,MAAM,EAAG,IAAO,CAC3B,EAAK,EAAQ,GACb,EAAG,YACC,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACnD,MAAO,CACH,IAAK,EAAG,KAAK,QAAQ,MAAM,MAAM,IAAM,IAAA,GACvC,IAAK,EAAG,KAAK,eAM7B,EAAK,MAAQ,EAAQ,MAAM,QAAQ,OACnC,EAAK,aAAe,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACvE,YAAa,EAAQ,oBAAoB,SAE7C,EAAK,OAAS,EAAQ,kBACjB,UACA,IAAK,GAAM,EAAQ,GAAG,QACtB,KAAK,KACV,EAAK,SAAW,CACZ,GAAG,IAAI,IAAI,CACP,GAAI,EAAK,UAAY,GACrB,GAAG,EAAQ,+BACN,UACA,IAAK,GAAM,EAAQ,GAAG,WAEjC,OAAO,SAEF,MAKnB,GAAM,CAAE,KAAM,GAAoB,MAAM,EAAI,GAEtC,EAAI,EAAK,GAET,EAAQ,EAAE,gBAAgB,OAAO,OACjC,EAAO,IAAI,IAAI,EAAE,6BAA6B,KAAK,QAAS,GAAS,KACrE,EAAW,EAAE,yBAAyB,KAAK,WAEjD,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAE,SAAS,SAAS,IAC9B,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,KACV,MAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,OAAQ,GAAS,KAC3D,OACA,KAAM,EACN,SAAU,EAAS,WAAW,IAAK,IACnC,OAAQ,EAAS,MAAM,KAAK"}