{"version":3,"file":"chinawriter-DQ7qMTH-.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/chinawriter/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/:id{.+}?',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 40;\r\n\r\n    const rootUrl = 'http://www.chinawriter.com.cn';\r\n    const currentUrl = `${new URL(id ?? '', rootUrl).href}/`;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    let items = ($('main div.inner').find('a').length === 0 ? $('body') : $('main div.inner'))\r\n        .find('a')\r\n        .toArray()\r\n        .filter((item) => /(?:\\/\\d{4}){2}\\/\\w+-\\w+\\.html/.test($(item).prop('href')))\r\n        .slice(0, limit)\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const link = item.prop('href');\r\n\r\n            return {\r\n                title: item.text(),\r\n                link: link.startsWith('http') ? link : new URL(item.prop('href'), rootUrl).href,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                try {\r\n                    const { data: detailResponse } = await got(item.link);\r\n\r\n                    const content = load(detailResponse);\r\n\r\n                    content('div.end_shared').remove();\r\n\r\n                    const info = content('div.end_info').text().trim();\r\n\r\n                    item.title = content('#newstit').text() || content('h6.end_tit').text();\r\n                    item.description = content('div.end_article').html();\r\n                    item.author = info ? info.match(/\\|(.*)\\d{4}/)[1].trim() : '';\r\n                    item.category = [\r\n                        ...new Set(\r\n                            [\r\n                                ...content('div.location a.clink')\r\n                                    .slice(1)\r\n                                    .toArray()\r\n                                    .map((c) => content(c).text()),\r\n                                info\r\n                                    ? info\r\n                                          .match(/^(.*)\\|/)[1]\r\n                                          .replaceAll('来源：', '')\r\n                                          .trim()\r\n                                    : undefined,\r\n                            ].filter(Boolean)\r\n                        ),\r\n                    ];\r\n                    item.pubDate = content('div.end_info em').text() ? timezone(parseDate(content('div.end_info em').text(), 'YYYY年MM月DD日HH:mm'), +8) : parseDate(content('meta[name=\"publishdate\"]').prop('content'));\r\n                } catch {\r\n                    //\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const icon = new URL($('link[rel=\"icon\"]').prop('href'), rootUrl);\r\n\r\n    return {\r\n        item: items,\r\n        title: $('title').text().replaceAll('--', ' - '),\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: 'zh-cn',\r\n        image: new URL($('h1.logo a img').prop('src'), rootUrl).href,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"keywords\"]').prop('content'),\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"0ZAOA,MAAaA,EAAe,CACxB,KAAM,YACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,gCACV,EAAa,GAAG,IAAI,IAAI,GAAM,GAAI,GAAS,KAAK,GAEhD,CAAE,KAAM,GAAa,MAAMC,EAAI,GAE/B,EAAI,EAAK,GAEX,GAAS,EAAE,kBAAkB,KAAK,KAAK,SAAW,EAAI,EAAE,QAAU,EAAE,mBACnE,KAAK,KACL,UACA,OAAQ,GAAS,gCAAgC,KAAK,EAAE,GAAM,KAAK,UACnE,MAAM,EAAG,GACT,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAO,EAAK,KAAK,QAEvB,MAAO,CACH,MAAO,EAAK,OACZ,KAAM,EAAK,WAAW,QAAU,EAAO,IAAI,IAAI,EAAK,KAAK,QAAS,GAAS,QAIvF,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,CACA,GAAM,CAAE,KAAM,GAAmB,MAAMD,EAAI,EAAK,MAE1C,EAAU,EAAK,GAErB,EAAQ,kBAAkB,SAE1B,IAAM,EAAO,EAAQ,gBAAgB,OAAO,OAE5C,EAAK,MAAQ,EAAQ,YAAY,QAAU,EAAQ,cAAc,OACjE,EAAK,YAAc,EAAQ,mBAAmB,OAC9C,EAAK,OAAS,EAAO,EAAK,MAAM,eAAe,GAAG,OAAS,GAC3D,EAAK,SAAW,CACZ,GAAG,IAAI,IACH,CACI,GAAG,EAAQ,wBACN,MAAM,GACN,UACA,IAAK,GAAM,EAAQ,GAAG,QAC3B,EACM,EACK,MAAM,WAAW,GACjB,WAAW,MAAO,IAClB,OACL,IAAA,IACR,OAAO,WAGjB,EAAK,QAAU,EAAQ,mBAAmB,OAAS,EAAS,EAAU,EAAQ,mBAAmB,OAAQ,oBAAqB,GAAM,EAAU,EAAQ,4BAA4B,KAAK,iBACnL,EAIR,OAAO,MAKnB,IAAM,EAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,QAAS,GAEzD,MAAO,CACH,KAAM,EACN,MAAO,EAAE,SAAS,OAAO,WAAW,KAAM,OAC1C,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,QACV,MAAO,IAAI,IAAI,EAAE,iBAAiB,KAAK,OAAQ,GAAS,KACxD,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,WAAY"}