{"version":3,"file":"forum-Y0LSRphp.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/nga/forum.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst X_UA = 'NGA_skull/6.0.5(iPhone10,3;iOS 12.0.1)';\r\n\r\nexport const route: Route = {\r\n    path: '/forum/:fid/:recommend?',\r\n    categories: ['bbs'],\r\n    view: ViewType.Articles,\r\n    example: '/nga/forum/489',\r\n    parameters: { fid: '分区 id, 可在分区主页 URL 找到, 没有 fid 时 stid 同样适用', recommend: '是否只显示精华主题, 留空为否, 任意值为是' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '分区帖子',\r\n    maintainers: ['xyqfer'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { fid, recommend } = ctx.req.param();\r\n    const timestamp = Math.floor(Date.now() / 1000);\r\n    let cookieString = `guestJs=${timestamp};`;\r\n    if (config.nga.uid && config.nga.cid) {\r\n        cookieString = `ngaPassportUid=${config.nga.uid}; ngaPassportCid=${config.nga.cid};`;\r\n    }\r\n    const formatContent = (content) =>\r\n        content\r\n            .replaceAll(/\\[img](.+?)\\[\\/img]/g, (match, p1) => {\r\n                const src = p1.replaceAll(/\\?.*/g, '');\r\n                return `<img src=\"${src}\" />`;\r\n            })\r\n            .replaceAll(/\\[url](.+?)\\[\\/url]/g, `<a href=\"$1\">$1</a>`);\r\n    const homePage = await got.post('https://ngabbs.com/app_api.php?__lib=subject&__act=list', {\r\n        headers: {\r\n            'X-User-Agent': X_UA,\r\n            Cookie: cookieString,\r\n        },\r\n        form: {\r\n            fid,\r\n            recommend: recommend ? 1 : 0,\r\n        },\r\n    });\r\n\r\n    const forumname = homePage.data.forumname;\r\n\r\n    const list = homePage.data.result.data.filter(({ tid }) => tid);\r\n\r\n    const resultItem = await Promise.all(\r\n        list.map(async ({ subject, postdate, tid }) => {\r\n            const link = `https://nga.178.com/read.php?tid=${tid}`;\r\n            const item = {\r\n                title: subject,\r\n                description: '',\r\n                link,\r\n                pubDate: parseDate(postdate, 'X'),\r\n            };\r\n\r\n            const description = await cache.tryGet(`nga-forum: ${link}`, async () => {\r\n                const response = await got.post('https://ngabbs.com/app_api.php?__lib=post&__act=list', {\r\n                    headers: {\r\n                        'X-User-Agent': X_UA,\r\n                        Cookie: cookieString,\r\n                    },\r\n                    form: {\r\n                        tid,\r\n                    },\r\n                });\r\n\r\n                return response.data.code === 0 ? formatContent(response.data.result[0].content) : response.data.msg;\r\n            });\r\n\r\n            item.description = description;\r\n            return item;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `NGA-${forumname}${recommend ? '-精华' : ''}`,\r\n        link: `https://nga.178.com/thread.php?fid=${fid}`,\r\n        description: 'NGA是国内专业的游戏玩家社区,魔兽世界,英雄联盟,炉石传说,风暴英雄,暗黑破坏神3(D3)游戏攻略讨论,以及其他热门游戏玩家社区',\r\n        item: resultItem,\r\n    };\r\n}\r\n"],"mappings":"yYAMA,MAAM,EAAO,yCAEAA,EAAe,CACxB,KAAM,0BACN,WAAY,CAAC,OACb,KAAM,EAAS,SACf,QAAS,iBACT,WAAY,CAAE,IAAK,2CAA4C,UAAW,0BAC1E,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,MAAK,aAAc,EAAI,IAAI,QAC7B,EAAY,KAAK,MAAM,KAAK,MAAQ,KACtC,EAAe,WAAW,EAAU,GACpC,EAAO,IAAI,KAAO,EAAO,IAAI,MAC7B,EAAe,kBAAkB,EAAO,IAAI,IAAI,mBAAmB,EAAO,IAAI,IAAI,IAEtF,IAAM,EAAiB,GACnB,EACK,WAAW,wBAAyB,EAAO,IAAO,CAC/C,IAAM,EAAM,EAAG,WAAW,QAAS,IACnC,MAAO,aAAa,EAAI,QAE3B,WAAW,uBAAwB,uBACtC,EAAW,MAAMC,EAAI,KAAK,0DAA2D,CACvF,QAAS,CACL,eAAgB,EAChB,OAAQ,GAEZ,KAAM,CACF,MACA,UAAW,EAAY,EAAI,KAI7B,EAAY,EAAS,KAAK,UAE1B,EAAO,EAAS,KAAK,OAAO,KAAK,QAAQ,CAAE,SAAU,GAErD,EAAa,MAAM,QAAQ,IAC7B,EAAK,IAAI,MAAO,CAAE,UAAS,WAAU,SAAU,CAC3C,IAAM,EAAO,oCAAoC,IAC3C,EAAO,CACT,MAAO,EACP,YAAa,GACb,OACA,QAAS,EAAU,EAAU,MAG3B,EAAc,MAAMC,EAAM,OAAO,cAAc,IAAQ,SAAY,CACrE,IAAM,EAAW,MAAMD,EAAI,KAAK,uDAAwD,CACpF,QAAS,CACL,eAAgB,EAChB,OAAQ,GAEZ,KAAM,CACF,SAIR,OAAO,EAAS,KAAK,OAAS,EAAI,EAAc,EAAS,KAAK,OAAO,GAAG,SAAW,EAAS,KAAK,MAIrG,MADA,GAAK,YAAc,EACZ,KAIf,MAAO,CACH,MAAO,OAAO,IAAY,EAAY,MAAQ,KAC9C,KAAM,sCAAsC,IAC5C,YAAa,oEACb,KAAM"}