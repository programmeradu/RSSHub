{"version":3,"file":"channel-CIc4Mq2s.js","names":[],"sources":["../../lib/routes/cma/channel.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/channel/:id?',\r\n    categories: ['forecast'],\r\n    example: '/cma/channel/380',\r\n    parameters: { id: '分类，见下表，可在对应频道页 URL 中找到，默认为 380，即每日天气提示' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '天气预报频道',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `#### 天气实况\r\n\r\n| 频道名称 | 频道 id                          |\r\n| -------- | -------------------------------- |\r\n| 卫星云图 | d3236549863e453aab0ccc4027105bad |\r\n| 单站雷达 | 103                              |\r\n| 降水量   | 18                               |\r\n| 气温     | 32                               |\r\n| 土壤水分 | 45                               |\r\n\r\n#### 气象公报\r\n\r\n| 频道名称       | 频道 id                          |\r\n| -------------- | -------------------------------- |\r\n| 每日天气提示   | 380                              |\r\n| 重要天气提示   | da5d55817ad5430fb9796a0780178533 |\r\n| 天气公报       | 3780                             |\r\n| 强对流天气预报 | 383                              |\r\n| 交通气象预报   | 423                              |\r\n| 森林火险预报   | 424                              |\r\n| 海洋天气公报   | 452                              |\r\n| 环境气象公报   | 467                              |\r\n\r\n::: tip\r\n  订阅更多细分频道，请前往对应上级频道页，使用下拉菜单选择项目后跳转到目标频道页，查看其 URL 找到对应频道 id\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { id = '380' } = ctx.req.param();\r\n\r\n    const author = '中国气象局·天气预报';\r\n    const rootUrl = 'https://weather.cma.cn';\r\n    const apiUrl = new URL('api/channel', rootUrl).href;\r\n    const currentUrl = new URL(`web/channel-${id}.html`, rootUrl).href;\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: {\r\n            id,\r\n        },\r\n    });\r\n\r\n    const data = response?.data?.pop() ?? {};\r\n\r\n    data.image = data.image?.replace(/\\?.*$/, '') ?? undefined;\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const title = [\r\n        ...new Set(\r\n            $('ol#breadcrumb li')\r\n                .slice(1)\r\n                .toArray()\r\n                .map((li) => $(li).text())\r\n        ),\r\n    ].join(' > ');\r\n    const description = $('div.xml').html();\r\n    const image = new URL($('li.active a img').prop('src'), rootUrl).href;\r\n    const icon = new URL($('link[rel=\"shortcut icon\"]').prop('href'), rootUrl).href;\r\n\r\n    const items = data\r\n        ? [\r\n              {\r\n                  title: `${data.title} ${data.releaseTime}`,\r\n                  link: new URL(data.link, rootUrl).href,\r\n                  description: art(path.join(__dirname, 'templates/description.art'), {\r\n                      description,\r\n                      image: data.image\r\n                          ? {\r\n                                src: new URL(data.image, rootUrl).href,\r\n                                alt: data.title,\r\n                            }\r\n                          : undefined,\r\n                  }),\r\n                  author:\r\n                      $(\r\n                          $('div.col-xs-8 span')\r\n                              .toArray()\r\n                              .filter((a) => $(a).text().startsWith('来源'))\r\n                              ?.pop()\r\n                      )\r\n                          ?.text()\r\n                          ?.split(/：/)\r\n                          ?.pop() || author,\r\n                  guid: `cma${data.link}#${data.releaseTime.replaceAll(/\\s/g, '-')}`,\r\n                  pubDate: timezone(parseDate(data.releaseTime), +8),\r\n                  enclosure_url: new URL(data.image, rootUrl).href,\r\n                  enclosure_type: data.image ? `image/${data.image.split(/\\./).pop()}` : undefined,\r\n              },\r\n          ]\r\n        : [];\r\n\r\n    return {\r\n        item: items,\r\n        title: `${author} - ${title}`,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: 'zh',\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"keywords\"]').prop('content'),\r\n        author,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"sdASA,MAAa,EAAe,CACxB,KAAM,gBACN,WAAY,CAAC,YACb,QAAS,mBACT,WAAY,CAAE,GAAI,0CAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,SACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;MA4BjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,KAAK,OAAU,EAAI,IAAI,QAEzB,EAAS,aACT,EAAU,yBACV,EAAS,IAAI,IAAI,cAAe,GAAS,KACzC,EAAa,IAAI,IAAI,eAAe,EAAG,OAAQ,GAAS,KAExD,CAAE,KAAM,GAAa,MAAM,EAAI,EAAQ,CACzC,aAAc,CACV,QAIF,EAAO,GAAU,MAAM,OAAS,GAEtC,EAAK,MAAQ,EAAK,OAAO,QAAQ,QAAS,KAAO,IAAA,GAEjD,GAAM,CAAE,KAAM,GAAoB,MAAM,EAAI,GAEtC,EAAI,EAAK,GAET,EAAQ,CACV,GAAG,IAAI,IACH,EAAE,oBACG,MAAM,GACN,UACA,IAAK,GAAO,EAAE,GAAI,UAE7B,KAAK,OACD,EAAc,EAAE,WAAW,OAC3B,EAAQ,IAAI,IAAI,EAAE,mBAAmB,KAAK,OAAQ,GAAS,KAC3D,EAAO,IAAI,IAAI,EAAE,6BAA6B,KAAK,QAAS,GAAS,KAErE,EAAQ,EACR,CACI,CACI,MAAO,GAAG,EAAK,MAAM,GAAG,EAAK,cAC7B,KAAM,IAAI,IAAI,EAAK,KAAM,GAAS,KAClC,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,cACA,MAAO,EAAK,MACN,CACI,IAAK,IAAI,IAAI,EAAK,MAAO,GAAS,KAClC,IAAK,EAAK,OAEd,IAAA,KAEV,OACI,EACI,EAAE,qBACG,UACA,OAAQ,GAAM,EAAE,GAAG,OAAO,WAAW,QACpC,QAEJ,QACA,MAAM,MACN,OAAS,EACnB,KAAM,MAAM,EAAK,KAAK,GAAG,EAAK,YAAY,WAAW,MAAO,OAC5D,QAAS,EAAS,EAAU,EAAK,aAAc,GAC/C,cAAe,IAAI,IAAI,EAAK,MAAO,GAAS,KAC5C,eAAgB,EAAK,MAAQ,SAAS,EAAK,MAAM,MAAM,MAAM,QAAU,IAAA,KAG/E,GAEN,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAO,KAAK,IACtB,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,KACV,QACA,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,SACA,WAAY"}