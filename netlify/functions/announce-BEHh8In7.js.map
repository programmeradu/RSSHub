{"version":3,"file":"announce-BEHh8In7.js","names":["route: Route","cache","ofetch","announceList"],"sources":["../../lib/routes/hypergryph/arknights/announce.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\n\r\ntype AnnounceItem = {\r\n    announceId: string;\r\n    title: string;\r\n    isWebUrl: boolean;\r\n    webUrl: string;\r\n    day: number;\r\n    month: number;\r\n    group: string;\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/arknights/announce/:platform?/:group?',\r\n    categories: ['game'],\r\n    example: '/hypergryph/arknights/announce',\r\n    parameters: { platform: '平台，默认为 Android', group: '分组，默认为 ALL' },\r\n    name: '明日方舟 - 游戏内公告',\r\n    maintainers: ['swwind'],\r\n    handler,\r\n    description: `平台\r\n\r\n|  安卓服 | iOS 服 |   B 服   |\r\n| :-----: | :----: | :------: |\r\n| Android |   IOS  | Bilibili |\r\n\r\n  分组\r\n\r\n| 全部 | 系统公告 | 活动公告 |\r\n| :--: | :------: | :------: |\r\n|  ALL |  SYSTEM  | ACTIVITY |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { platform = 'Android', group = 'ALL' } = ctx.req.param();\r\n\r\n    let announceList = (await cache.tryGet(\r\n        `hypergryph:arknights:announce_meta:${platform}`,\r\n        async () => {\r\n            const { announceList } = await ofetch(`https://ak-conf.hypergryph.com/config/prod/announce_meta/${platform}/announcement.meta.json`);\r\n            return announceList;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    )) as AnnounceItem[];\r\n\r\n    if (group !== 'ALL') {\r\n        announceList = announceList.filter((item) => item.group === group);\r\n    }\r\n\r\n    const items = await Promise.all(\r\n        announceList.map((item) =>\r\n            cache.tryGet(item.webUrl, async () => {\r\n                const data = await ofetch(item.webUrl);\r\n\r\n                const $ = load(data);\r\n                let description =\r\n                    // 一般来讲是有字的\r\n                    $('.content').html() ??\r\n                    // 有些情况只有一张图\r\n                    $('.banner-image-container.cover').html() ??\r\n                    // 有些情况啥都没有（暂时没有遇到）\r\n                    'No Description';\r\n\r\n                // 游戏内部跳转链接\r\n                description = description.replace(/href=\"uniwebview:\\/\\/.+?\"/, 'href=\"#\"');\r\n\r\n                return {\r\n                    title: item.title,\r\n                    description,\r\n                    // 不知道是哪一年的，所以不管了\r\n                    pubDate: parseDate(`${item.month}-${item.day}`, 'M-D'),\r\n                    link: item.webUrl,\r\n                };\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `《明日方舟》${group === 'SYSTEM' ? '系统' : group === 'ACTIVITY' ? '活动' : '全部'}公告`,\r\n        link: 'https://ak.hypergryph.com/',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"oUAiBA,MAAaA,EAAe,CACxB,KAAM,yCACN,WAAY,CAAC,QACb,QAAS,iCACT,WAAY,CAAE,SAAU,iBAAkB,MAAO,cACjD,KAAM,eACN,YAAa,CAAC,UACd,UACA,YAAa;;;;;;;;;;iCAajB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,UAAW,QAAQ,OAAU,EAAI,IAAI,QAEpD,EAAgB,MAAMC,EAAM,OAC5B,sCAAsC,IACtC,SAAY,CACR,GAAM,CAAE,aAAA,GAAiB,MAAMC,EAAO,4DAA4D,EAAS,0BAC3G,OAAOC,GAEX,EAAO,MAAM,YACb,IAGA,IAAU,QACV,EAAe,EAAa,OAAQ,GAAS,EAAK,QAAU,IAGhE,IAAM,EAAQ,MAAM,QAAQ,IACxB,EAAa,IAAK,GACdF,EAAM,OAAO,EAAK,OAAQ,SAAY,CAClC,IAAM,EAAO,MAAMC,EAAO,EAAK,QAEzB,EAAI,EAAK,GACX,EAEA,EAAE,YAAY,QAEd,EAAE,iCAAiC,QAEnC,iBAKJ,MAFA,GAAc,EAAY,QAAQ,4BAA6B,YAExD,CACH,MAAO,EAAK,MACZ,cAEA,QAAS,EAAU,GAAG,EAAK,MAAM,GAAG,EAAK,MAAO,OAChD,KAAM,EAAK,YAM3B,MAAO,CACH,MAAO,SAAS,IAAU,SAAW,KAAO,IAAU,WAAa,KAAO,KAAK,IAC/E,KAAM,6BACN,KAAM"}