{"version":3,"file":"topic-CIF9QBZn.js","names":["route: Route","cache","got","data"],"sources":["../../lib/routes/jike/topic.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { topicDataHanding, constructTopicEntry } from './utils';\r\nimport { load } from 'cheerio';\r\nimport dayjs from 'dayjs';\r\n\r\nconst urlRegex = /(https?:\\/\\/[^\\s\"'<>]+)/g;\r\n\r\nexport const route: Route = {\r\n    path: '/topic/:id/:showUid?',\r\n    categories: ['social-media'],\r\n    view: ViewType.SocialMedia,\r\n    example: '/jike/topic/556688fae4b00c57d9dd46ee',\r\n    parameters: {\r\n        id: '圈子 id, 可在即刻 web 端圈子页或 APP 分享出来的圈子页 URL 中找到',\r\n        showUid: {\r\n            description: '是否在内容中显示用户信息，设置为 1 则开启',\r\n            options: [{ value: '1', label: '显示' }],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['web.okjike.com/topic/:id'],\r\n            target: '/topic/:id',\r\n        },\r\n    ],\r\n    name: '圈子',\r\n    maintainers: ['DIYgod', 'prnake'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const topicUrl = `https://m.okjike.com/topics/${id}`;\r\n\r\n    const data = await constructTopicEntry(ctx, topicUrl);\r\n\r\n    if (data) {\r\n        const result = data.result;\r\n        result.item = topicDataHanding(data, ctx);\r\n        if (id === '553870e8e4b0cafb0a1bef68' || id === '55963702e4b0d84d2c30ce6f') {\r\n            result.item = await Promise.all(\r\n                result.item.map(async (one) => {\r\n                    const item = { ...one };\r\n                    const regResult = /https:\\/\\/www\\.okjike\\.com\\/medium\\/[\\dA-Za-z]*/.exec(item.description);\r\n                    if (regResult) {\r\n                        const newsUrl = regResult[0];\r\n                        item.description = await cache.tryGet(newsUrl, async () => {\r\n                            const { data } = await got(newsUrl);\r\n                            const $ = load(data);\r\n                            const upper = $('ul.main > li.item');\r\n                            const links = upper.find('a').map((_, ele) => $(ele).attr('href'));\r\n                            const texts = upper.find('span.text').map((_, ele) => $(ele).text());\r\n                            let description = '';\r\n                            for (const [i, link] of links.entries()) {\r\n                                description += `${i + 1}、<a href=\"${link}\">${texts[i]}</a><br>`;\r\n                            }\r\n                            description = description.replace(/<br>$/, '');\r\n                            return description;\r\n                        });\r\n                    }\r\n                    item.description = item.description.replaceAll(urlRegex, (url) => `<a href=\"${url}\">${url}</a>`);\r\n                    item.title = `${data.topic.content} ${dayjs(one.pubDate).format('MM月DD日')}`;\r\n                    return item;\r\n                })\r\n            );\r\n        }\r\n        return result;\r\n    }\r\n}\r\n"],"mappings":"weAOA,MAAM,EAAW,2BAEJA,EAAe,CACxB,KAAM,uBACN,WAAY,CAAC,gBACb,KAAM,EAAS,YACf,QAAS,uCACT,WAAY,CACR,GAAI,6CACJ,QAAS,CACL,YAAa,yBACb,QAAS,CAAC,CAAE,MAAO,IAAK,MAAO,SAGvC,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,4BACT,OAAQ,eAGhB,KAAM,KACN,YAAa,CAAC,SAAU,UACxB,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAW,+BAA+B,IAE1C,EAAO,MAAM,EAAoB,EAAK,GAE5C,GAAI,EAAM,CACN,IAAM,EAAS,EAAK,OA6BpB,MA5BA,GAAO,KAAO,EAAiB,EAAM,IACjC,IAAO,4BAA8B,IAAO,8BAC5C,EAAO,KAAO,MAAM,QAAQ,IACxB,EAAO,KAAK,IAAI,KAAO,IAAQ,CAC3B,IAAM,EAAO,CAAE,GAAG,GACZ,EAAY,kDAAkD,KAAK,EAAK,aAC9E,GAAI,EAAW,CACX,IAAM,EAAU,EAAU,GAC1B,EAAK,YAAc,MAAMC,EAAM,OAAO,EAAS,SAAY,CACvD,GAAM,CAAE,KAAA,GAAS,MAAMC,EAAI,GACrB,EAAI,EAAKC,GACT,EAAQ,EAAE,qBACV,EAAQ,EAAM,KAAK,KAAK,KAAK,EAAG,IAAQ,EAAE,GAAK,KAAK,SACpD,EAAQ,EAAM,KAAK,aAAa,KAAK,EAAG,IAAQ,EAAE,GAAK,QACzD,EAAc,GAClB,IAAK,GAAM,CAAC,EAAG,KAAS,EAAM,UAC1B,GAAe,GAAG,EAAI,EAAE,YAAY,EAAK,IAAI,EAAM,GAAG,UAG1D,MADA,GAAc,EAAY,QAAQ,QAAS,IACpC,IAKf,MAFA,GAAK,YAAc,EAAK,YAAY,WAAW,EAAW,GAAQ,YAAY,EAAI,IAAI,EAAI,OAC1F,EAAK,MAAQ,GAAG,EAAK,MAAM,QAAQ,GAAG,EAAM,EAAI,SAAS,OAAO,YACzD,MAIZ"}