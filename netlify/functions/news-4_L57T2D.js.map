{"version":3,"file":"news-4_L57T2D.js","names":["route: Route","puppeteer","utils","cache","got"],"sources":["../../lib/routes/ccac/utils.ts","../../lib/routes/ccac/news.ts"],"sourcesContent":["const BASE_URL = 'https://www.ccac.org.mo';\r\n\r\nconst LANG_TYPE = {\r\n    en: 'en-us',\r\n    sc: 'zh-cn',\r\n    tc: 'zh-hk',\r\n    pt: 'pt',\r\n};\r\n\r\nconst TYPE = {\r\n    all: '全部',\r\n    case: '案件發佈',\r\n    Persuasion: '調查報告或勸喻',\r\n    AnnualReport: '年度報告',\r\n    PCANews: '公署消息',\r\n};\r\n\r\nfunction langBase(lang) {\r\n    return `${BASE_URL}/${lang}/news.html`;\r\n}\r\n\r\nfunction typeFilter(list, type) {\r\n    return type === '全部' ? list : list.filter((item) => item.tags.some((tag) => tag.name === type));\r\n}\r\n\r\nexport default { TYPE, BASE_URL, LANG_TYPE, langBase, typeFilter };\r\n","import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport utils from './utils';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nexport const route: Route = {\r\n    path: '/news/:type/:lang?',\r\n    categories: ['government'],\r\n    example: '/ccac/news/all',\r\n    parameters: { type: 'Category', lang: 'Language, default to `sc`. Supprot `en`(English), `sc`(Simplified Chinese), `tc`(Traditional Chinese) and `pt`(Portuguese)' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Latest News',\r\n    maintainers: ['linbuxiao'],\r\n    handler,\r\n    description: `Category\r\n\r\n| All | Detected Cases | Investigation Reports or Recommendations | Annual Reports | CCAC's Updates |\r\n| --- | -------------- | ---------------------------------------- | -------------- | -------------- |\r\n| all | case           | Persuasion                               | AnnualReport   | PCANews        |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const browser = await puppeteer();\r\n    const lang = ctx.req.param('lang') ?? 'sc';\r\n    const type = utils.TYPE[ctx.req.param('type')];\r\n\r\n    const BASE = utils.langBase(lang);\r\n    const page = await browser.newPage();\r\n    await page.setRequestInterception(true);\r\n    page.on('request', (request) => {\r\n        request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n    });\r\n    await page.goto(BASE, {\r\n        waitUntil: 'domcontentloaded',\r\n    });\r\n    const articles = await page.evaluate(() => window.articles);\r\n    await browser.close();\r\n\r\n    const list = utils\r\n        .typeFilter(articles, type)\r\n        .slice(0, ctx.req.query('limit') ? Number(ctx.req.query('limit')) : 30)\r\n        .map((item) => ({\r\n            title: item.name,\r\n            category: item.tags.map((tag) => tag.name),\r\n            link: utils.BASE_URL + item.url,\r\n            pubDate: parseDate(item.time, 'YYYY-MM-DD'),\r\n        }));\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                });\r\n\r\n                const $ = load(detailResponse.data);\r\n                $('.article_details_body > *').removeAttr('style');\r\n                item.description = $('.article_details_body').html();\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `CCAC ${type}`,\r\n        link: BASE,\r\n        description: `CCAC ${type}`,\r\n        language: ctx.req.param('lang') ? utils.LANG_TYPE[ctx.req.param('lang')] : utils.LANG_TYPE.sc,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"gcAAA,MAAM,EAAW,0BAEX,EAAY,CACd,GAAI,QACJ,GAAI,QACJ,GAAI,QACJ,GAAI,MAGF,EAAO,CACT,IAAK,KACL,KAAM,OACN,WAAY,UACZ,aAAc,OACd,QAAS,QAGb,SAAS,EAAS,EAAM,CACpB,MAAO,GAAG,EAAS,GAAG,EAAK,YAG/B,SAAS,EAAW,EAAM,EAAM,CAC5B,OAAO,IAAS,KAAO,EAAO,EAAK,OAAQ,GAAS,EAAK,KAAK,KAAM,GAAQ,EAAI,OAAS,IAG7F,IAAA,EAAe,CAAE,OAAM,WAAU,YAAW,WAAU,cCjBtD,MAAaA,EAAe,CACxB,KAAM,qBACN,WAAY,CAAC,cACb,QAAS,iBACT,WAAY,CAAE,KAAM,WAAY,KAAM,8HACtC,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,cACN,YAAa,CAAC,aACd,UACA,YAAa;;;;wGAOjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,MAAMC,IAChB,EAAO,EAAI,IAAI,MAAM,SAAW,KAChC,EAAOC,EAAM,KAAK,EAAI,IAAI,MAAM,SAEhC,EAAOA,EAAM,SAAS,GACtB,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,MAAM,EAAK,KAAK,EAAM,CAClB,UAAW,qBAEf,IAAM,EAAW,MAAM,EAAK,aAAe,OAAO,UAClD,MAAM,EAAQ,QAEd,IAAM,EAAOA,EACR,WAAW,EAAU,GACrB,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,EAAI,IAAI,MAAM,UAAY,IACnE,IAAK,IAAU,CACZ,MAAO,EAAK,KACZ,SAAU,EAAK,KAAK,IAAK,GAAQ,EAAI,MACrC,KAAMA,EAAM,SAAW,EAAK,IAC5B,QAAS,EAAU,EAAK,KAAM,iBAGhC,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAMC,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAI,EAAK,EAAe,MAG9B,OAFA,EAAE,6BAA6B,WAAW,SAC1C,EAAK,YAAc,EAAE,yBAAyB,OACvC,MAKnB,MAAO,CACH,MAAO,QAAQ,IACf,KAAM,EACN,YAAa,QAAQ,IACrB,SAAU,EAAI,IAAI,MAAM,QAAUF,EAAM,UAAU,EAAI,IAAI,MAAM,SAAWA,EAAM,UAAU,GAC3F,KAAM"}