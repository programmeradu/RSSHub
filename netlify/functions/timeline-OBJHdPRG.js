import"./esm-shims-Dqvxr0BZ.js";import{config as e}from"./config-Dl8a1sIg.js";import"./logger-CWOoofbD.js";import"./dist-IvUHtNe1.js";import{parseDate as t}from"./parse-date-Bgabdhlb.js";import{ofetch_default as n}from"./ofetch-Bzt0BXUH.js";import{ViewType as r}from"./types-A5bA50Mg.js";import{invalid_parameter_default as i}from"./invalid-parameter-CUJdROXf.js";import{config_not_found_default as a}from"./config-not-found-BVqhRP9D.js";import{rss_parser_default as o}from"./rss-parser-1vyhErsD.js";const s={path:`/timeline/:account`,categories:[`social-media`],view:r.SocialMedia,example:`/fediverse/timeline/Mastodon@mastodon.social`,parameters:{account:`username@domain`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`Timeline`,maintainers:[`DIYgod`,`pseudoyu`],handler:u},c=new Set([`mastodon.social`,`pawoo.net`,e.mastodon.apiHost].filter(Boolean)),l=new Set([`application/activity+json`,`application/ld+json; profile="https://www.w3.org/ns/activitystreams"`]);async function u(r){let s=r.req.param(`account`),u=s.split(`@`)[1],d=s.split(`@`)[0];if(!u||!d)throw new i(`Invalid account`);if(!e.feature.allow_user_supply_unsafe_domain&&!c.has(u.toLowerCase()))throw new a(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);let f={headers:{Accept:`application/ld+json; profile="https://www.w3.org/ns/activitystreams"`}},p=await n(`https://${u}/.well-known/webfinger?resource=acct:${s}`,{headers:{Accept:`application/jrd+json`}}),m=p.links.find(e=>e.rel===`self`&&l.has(e.type))?.href,h=p.links.find(e=>e.rel===`http://webfinger.net/rel/profile-page`)?.href,g=await o.parseURL(`${h}.rss`);if(g)return{title:`${g.title} (Fediverse@${s})`,description:g.description,image:g.image?.url,link:g.link,item:g.items.map(e=>({title:e.title,description:e.content,link:e.link,pubDate:e.pubDate?t(e.pubDate):null,guid:e.guid}))};let _=await n(m,f),v=await n(_.outbox,f),y=await n(v.first,f),b=y.orderedItems,x=[];for(let e of b){if(![`Announce`,`Create`,`Update`].includes(e.type))continue;typeof e.object==`string`?x.push((async e=>(e.object=await n(e.object,f),e))(e)):x.push(Promise.resolve(e))}let S=await Promise.all(x);return{title:`${_.name||_.preferredUsername} (Fediverse@${s})`,description:_.summary,image:_.icon?.url||_.image?.url,link:h,item:S.map(e=>({title:e.object.content.replaceAll(/<[^<]*>/g,``),description:`${e.object.content}\n${e.object.attachment?.map(e=>`<img src="${e.url}" width="${e.width}" height="${e.height}" />`).join(`
`)||``}`,link:e.object.url,pubDate:t(e.published),guid:e.id}))}}export{s as route};
//# sourceMappingURL=timeline-OBJHdPRG.js.map