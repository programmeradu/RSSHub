{"version":3,"file":"2048-B0H_1r4K.js","names":[],"sources":["../../lib/routes/2048/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/:id?',\r\n    categories: ['multimedia'],\r\n    example: '/2048/2',\r\n    parameters: { id: '板块 ID, 见下表，默认为最新合集，即 `3`，亦可在 URL 中找到, 例如, `thread.php?fid-3.html`中, 板块 ID 为`3`' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: true,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n        nsfw: true,\r\n    },\r\n    name: '论坛',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 最新合集 | 亞洲無碼 | 日本騎兵 | 歐美新片 | 國內原創 | 中字原創 | 三級寫真 |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| 3        | 4        | 5        | 13       | 15       | 16       | 18       |\r\n\r\n| 有碼.HD | 亞洲 SM.HD | 日韓 VR/3D | 歐美 VR/3D | S-cute / Mywife / G-area |\r\n| ------- | ---------- | ---------- | ---------- | ------------------------ |\r\n| 116     | 114        | 96         | 97         | 119                      |\r\n\r\n| 網友自拍 | 亞洲激情 | 歐美激情 | 露出偷窺 | 高跟絲襪 | 卡通漫畫 | 原創达人 |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| 23       | 24       | 25       | 26       | 27       | 28       | 135      |\r\n\r\n| 唯美清純 | 网络正妹 | 亞洲正妹 | 素人正妹 | COSPLAY | 女优情报 | Gif 动图 |\r\n| -------- | -------- | -------- | -------- | ------- | -------- | -------- |\r\n| 21       | 274      | 276      | 277      | 278     | 29       |          |\r\n\r\n| 獨家拍攝 | 稀有首發 | 网络见闻 | 主播實錄 | 珍稀套圖 | 名站同步 | 实用漫画 |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| 213      | 94       | 283      | 111      | 88       | 131      | 180      |\r\n\r\n| 网盘二区 | 网盘三区 | 分享福利 | 国产精选 | 高清福利 | 高清首发 | 多挂原创 |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| 72       | 272      | 195      | 280      | 79       | 216      | 76       |\r\n\r\n| 磁链迅雷 | 正片大片 | H-GAME | 有声小说 | 在线视频 | 在线快播影院 |\r\n| -------- | -------- | ------ | -------- | -------- | ------------ |\r\n| 43       | 67       | 66     | 55       | 78       | 279          |\r\n\r\n| 综合小说 | 人妻意淫 | 乱伦迷情 | 长篇连载 | 文学作者 | TXT 小说打包 |\r\n| -------- | -------- | -------- | -------- | -------- | ------------ |\r\n| 48       | 103      | 50       | 54       | 100      | 109          |\r\n\r\n| 聚友客栈 | 坛友自售 |\r\n| -------- | -------- |\r\n| 57       | 136      |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id') ?? '3';\r\n\r\n    const rootUrl = 'https://hjd2048.com';\r\n    // 获取地址发布页指向的 URL\r\n    const domainInfo = (await cache.tryGet('2048:domainInfo', async () => {\r\n        const response = await ofetch('https://2048.info');\r\n        const $ = load(response);\r\n        const onclickValue = $('.button').first().attr('onclick');\r\n        const targetUrl = onclickValue.match(/window\\.open\\('([^']+)'/)[1];\r\n\r\n        return { url: targetUrl };\r\n    })) as { url: string };\r\n    // 获取重定向后的url和safeid\r\n    const redirectResponse = await ofetch.raw(domainInfo.url);\r\n    const currentUrl = `${redirectResponse.url}thread.php?fid-${id}.html`;\r\n    const redirectPageContent = load(redirectResponse._data);\r\n    const safeId =\r\n        redirectPageContent('script')\r\n            .text()\r\n            .match(/var safeid='(.*?)',/)?.[1] ?? '';\r\n\r\n    const response = await ofetch.raw(currentUrl, {\r\n        headers: {\r\n            cookie: `_safe=${safeId}`,\r\n        },\r\n    });\r\n\r\n    const $ = load(response._data);\r\n    const currentHost = `https://${new URL(response.url).host}`; // redirected host\r\n\r\n    $('#shortcut').remove();\r\n    $('tr[onmouseover=\"this.className=\\'tr3 t_two\\'\"]').remove();\r\n\r\n    const list = $('#ajaxtable tbody .tr2')\r\n        .last()\r\n        .nextAll('.tr3')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item).find('a.subject');\r\n\r\n            return {\r\n                title: item.text(),\r\n                link: `${currentHost}/${item.attr('href')}`,\r\n                guid: `${rootUrl}/2048/${item.attr('href')}`,\r\n            };\r\n        })\r\n        .filter((item) => !item.link.includes('undefined'));\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.guid, async () => {\r\n                const detailResponse = await ofetch(item.link, {\r\n                    headers: {\r\n                        cookie: `_safe=${safeId}`,\r\n                    },\r\n                });\r\n\r\n                const content = load(detailResponse);\r\n\r\n                content('.ads, .tips').remove();\r\n\r\n                content('ignore_js_op').each(function () {\r\n                    const img = content(this).find('img');\r\n                    const originalSrc = img.attr('data-original');\r\n                    const fallbackSrc = img.attr('src');\r\n                    // 判断是否有 data-original 属性，若有则使用其值，否则使用 src 属性值\r\n                    const imgSrc = originalSrc || fallbackSrc;\r\n                    content(this).replaceWith(`<img src=\"${imgSrc}\">`);\r\n                });\r\n\r\n                item.author = content('.fl.black').first().text();\r\n                item.pubDate = timezone(parseDate(content('span.fl.gray').first().attr('title')), +8);\r\n\r\n                const downloadLink = content('#read_tpc').first().find('a').last();\r\n                const copyLink = content('#copytext')?.first()?.text();\r\n                if (downloadLink?.text()?.startsWith('http') && /bt\\.azvmw\\.com$/.test(new URL(downloadLink.text()).hostname)) {\r\n                    const torrentResponse = await ofetch(downloadLink.text());\r\n\r\n                    const torrent = load(torrentResponse);\r\n\r\n                    item.enclosure_type = 'application/x-bittorrent';\r\n                    const ahref = torrent('.uk-button').last().attr('href');\r\n                    item.enclosure_url = ahref?.startsWith('http') ? ahref : `https://bt.azvmw.com/${ahref}`;\r\n\r\n                    const magnet = torrent('.uk-button').first().attr('href');\r\n\r\n                    downloadLink.replaceWith(\r\n                        art(path.join(__dirname, 'templates/download.art'), {\r\n                            magnet,\r\n                            torrent: item.enclosure_url,\r\n                        })\r\n                    );\r\n                } else if (copyLink?.startsWith('magnet')) {\r\n                    // copy link\r\n                    item.enclosure_url = copyLink;\r\n                    item.enclosure_type = 'x-scheme-handler/magnet';\r\n                }\r\n\r\n                const desp = content('#read_tpc').first();\r\n\r\n                content('.showhide img').each(function () {\r\n                    desp.append(`<br><img style=\"max-width: 100%;\" src=\"${content(this).attr('src')}\">`);\r\n                });\r\n\r\n                item.description = desp.html();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${$('#main #breadCrumb a').last().text()} - 2048核基地`,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"qdAUA,MAAa,EAAe,CACxB,KAAM,QACN,WAAY,CAAC,cACb,QAAS,UACT,WAAY,CAAE,GAAI,kFAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,GACf,KAAM,IAEV,KAAM,KACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;0BAqCjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,OAAS,IAI5B,EAAc,MAAM,EAAM,OAAO,kBAAmB,SAAY,CAClE,IAAM,EAAW,MAAM,EAAO,qBACxB,EAAI,EAAK,GACT,EAAe,EAAE,WAAW,QAAQ,KAAK,WACzC,EAAY,EAAa,MAAM,2BAA2B,GAEhE,MAAO,CAAE,IAAK,KAGZ,EAAmB,MAAM,EAAO,IAAI,EAAW,KAC/C,EAAa,GAAG,EAAiB,IAAI,iBAAiB,EAAG,OACzD,EAAsB,EAAK,EAAiB,OAC5C,EACF,EAAoB,UACf,OACA,MAAM,yBAAyB,IAAM,GAExC,EAAW,MAAM,EAAO,IAAI,EAAY,CAC1C,QAAS,CACL,OAAQ,SAAS,OAInB,EAAI,EAAK,EAAS,OAClB,EAAc,WAAW,IAAI,IAAI,EAAS,KAAK,OAErD,EAAE,aAAa,SACf,EAAE,gDAAkD,SAEpD,IAAM,EAAO,EAAE,yBACV,OACA,QAAQ,QACR,UACA,IAAK,IACF,EAAO,EAAE,GAAM,KAAK,aAEb,CACH,MAAO,EAAK,OACZ,KAAM,GAAG,EAAY,GAAG,EAAK,KAAK,UAClC,KAAM,4BAAmB,EAAK,KAAK,aAG1C,OAAQ,GAAS,CAAC,EAAK,KAAK,SAAS,cAEpC,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAO,EAAK,KAAM,CAC3C,QAAS,CACL,OAAQ,SAAS,OAInB,EAAU,EAAK,GAErB,EAAQ,eAAe,SAEvB,EAAQ,gBAAgB,KAAK,UAAY,CACrC,IAAM,EAAM,EAAQ,MAAM,KAAK,OACzB,EAAc,EAAI,KAAK,iBACvB,EAAc,EAAI,KAAK,OAEvB,EAAS,GAAe,EAC9B,EAAQ,MAAM,YAAY,aAAa,EAAO,OAGlD,EAAK,OAAS,EAAQ,aAAa,QAAQ,OAC3C,EAAK,QAAU,EAAS,EAAU,EAAQ,gBAAgB,QAAQ,KAAK,UAAW,GAElF,IAAM,EAAe,EAAQ,aAAa,QAAQ,KAAK,KAAK,OACtD,EAAW,EAAQ,cAAc,SAAS,OAChD,GAAI,GAAc,QAAQ,WAAW,SAAW,kBAAkB,KAAK,IAAI,IAAI,EAAa,QAAQ,UAAW,CAC3G,IAAM,EAAkB,MAAM,EAAO,EAAa,QAE5C,EAAU,EAAK,GAErB,EAAK,eAAiB,2BACtB,IAAM,EAAQ,EAAQ,cAAc,OAAO,KAAK,QAChD,EAAK,cAAgB,GAAO,WAAW,QAAU,EAAQ,wBAAwB,IAEjF,IAAM,EAAS,EAAQ,cAAc,QAAQ,KAAK,QAElD,EAAa,YACT,EAAI,EAAA,KAAA,EAAA,mCAAgD,CAChD,SACA,QAAS,EAAK,sBAGf,GAAU,WAAW,YAE5B,EAAK,cAAgB,EACrB,EAAK,eAAiB,2BAG1B,IAAM,EAAO,EAAQ,aAAa,QAQlC,OANA,EAAQ,iBAAiB,KAAK,UAAY,CACtC,EAAK,OAAO,0CAA0C,EAAQ,MAAM,KAAK,OAAO,OAGpF,EAAK,YAAc,EAAK,OAEjB,MAKnB,MAAO,CACH,MAAO,GAAG,EAAE,uBAAuB,OAAO,OAAO,YACjD,KAAM,EACN,KAAM"}