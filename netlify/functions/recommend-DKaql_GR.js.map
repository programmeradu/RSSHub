{"version":3,"file":"recommend-DKaql_GR.js","names":["cache","ofetch","route: Route","fullContent: null | string","ofetch","cookie","got","cache"],"sources":["../../lib/routes/51cto/utils.ts","../../lib/routes/51cto/recommend.ts"],"sourcesContent":["import ofetch from '@/utils/ofetch';\r\nimport cache from '@/utils/cache';\r\nimport md5 from '@/utils/md5';\r\n\r\nexport const getToken = () =>\r\n    cache.tryGet(\r\n        '51cto:token',\r\n        async () => {\r\n            const response = await ofetch('https://api-media.51cto.com/api/token-get');\r\n            return response.data.data.token;\r\n        },\r\n        3600,\r\n        false\r\n    );\r\n\r\nexport const sign = (requestPath: string, payload: Record<string, any> = {}, timestamp: number, token: string) => {\r\n    payload.timestamp = timestamp;\r\n    payload.token = token;\r\n    const sortedParams = Object.keys(payload).sort();\r\n    return md5(md5(requestPath) + md5(sortedParams + md5(token) + timestamp));\r\n};\r\n","import { Route } from '@/types';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport got from '@/utils/got';\r\nimport { getToken, sign } from './utils';\r\nimport { load } from 'cheerio';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport logger from '@/utils/logger';\r\n\r\nexport const route: Route = {\r\n    path: '/index/recommend',\r\n    categories: ['programming'],\r\n    example: '/51cto/index/recommend',\r\n    radar: [\r\n        {\r\n            source: ['51cto.com/'],\r\n        },\r\n    ],\r\n    name: '推荐',\r\n    maintainers: ['cnkmmk', 'ovo-tim'],\r\n    handler,\r\n    url: '51cto.com/',\r\n};\r\n\r\nconst pattern = /'(WTKkN|bOYDu|wyeCN)':\\s*(\\d+)/g;\r\n\r\nasync function getFullcontent(item, cookie = '') {\r\n    let fullContent: null | string = null;\r\n    const articleResponse = await ofetch(item.url, {\r\n        headers: {\r\n            cookie,\r\n        },\r\n    });\r\n    const $ = load(articleResponse);\r\n\r\n    fullContent = new URL(item.url).host === 'ost.51cto.com' ? $('.posts-content').html() : $('article').html();\r\n\r\n    if (!fullContent && cookie === '') {\r\n        // If fullContent is null and haven't tried to request with cookie, try to get fullContent with cookie\r\n        try {\r\n            // More details: https://github.com/DIYgod/RSSHub/pull/16583#discussion_r1738643033\r\n            const _matches = articleResponse!.match(pattern)!.slice(0, 3);\r\n            const matches = _matches.map((str) => Number(str.split(':')[1]));\r\n            const [v1, v2, v3] = matches;\r\n            const cookie = '__tst_status=' + (v1 + v2 + v3) + '#;';\r\n            return await getFullcontent(item, cookie);\r\n        } catch (error) {\r\n            logger.error(error);\r\n        }\r\n    }\r\n\r\n    return {\r\n        title: item.title,\r\n        link: item.url,\r\n        pubDate: parseDate(item.pubdate, +8),\r\n        description: fullContent || item.abstract, // Return item.abstract if fullContent is null\r\n    };\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const url = 'https://api-media.51cto.com';\r\n    const requestPath = 'index/index/recommend';\r\n    const token = (await getToken()) as string;\r\n    const timestamp = Date.now();\r\n    const params = {\r\n        page: 1,\r\n        page_size: ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 50,\r\n        limit_time: 0,\r\n        name_en: '',\r\n    };\r\n\r\n    const response = await got(`${url}/${requestPath}`, {\r\n        searchParams: {\r\n            ...params,\r\n            timestamp,\r\n            token,\r\n            sign: sign(requestPath, params, timestamp, token),\r\n        },\r\n    });\r\n    const list = response.data.data.data.list;\r\n\r\n    const items = await Promise.all(list.map((item) => cache.tryGet(item.url, async () => await getFullcontent(item))));\r\n\r\n    return {\r\n        title: '51CTO',\r\n        link: 'https://www.51cto.com/',\r\n        description: '51cto - 推荐',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"kcAIA,MAAa,MACTO,EAAM,OACF,cACA,SAAY,CACR,IAAM,EAAW,MAAMH,EAAO,6CAC9B,OAAO,EAAS,KAAK,KAAK,OAE9B,KACA,IAGK,GAAQ,EAAqB,EAA+B,GAAI,EAAmB,IAAkB,CAC9G,EAAQ,UAAY,EACpB,EAAQ,MAAQ,EAChB,IAAM,EAAe,OAAO,KAAK,GAAS,OAC1C,OAAO,EAAI,EAAI,GAAe,EAAI,EAAe,EAAI,GAAS,KCVrDF,EAAe,CACxB,KAAM,mBACN,WAAY,CAAC,eACb,QAAS,yBACT,MAAO,CACH,CACI,OAAQ,CAAC,gBAGjB,KAAM,KACN,YAAa,CAAC,SAAU,WACxB,UACA,IAAK,cAGH,EAAU,kCAEhB,eAAe,EAAe,EAAM,EAAS,GAAI,CAC7C,IAAIC,EAA6B,KAC3B,EAAkB,MAAMC,EAAO,EAAK,IAAK,CAC3C,QAAS,CACL,YAGF,EAAI,EAAK,GAIf,GAFA,EAAc,IAAI,IAAI,EAAK,KAAK,OAAS,gBAAkB,EAAE,kBAAkB,OAAS,EAAE,WAAW,OAEjG,CAAC,GAAe,IAAW,GAE3B,GAAI,CAEA,IAAM,EAAW,EAAiB,MAAM,GAAU,MAAM,EAAG,GACrD,EAAU,EAAS,IAAK,GAAQ,OAAO,EAAI,MAAM,KAAK,KACtD,CAAC,EAAI,EAAI,GAAM,EACfC,EAAS,iBAAmB,EAAK,EAAK,GAAM,KAClD,OAAO,MAAM,EAAe,EAAMA,SAC7B,EAAO,CACZ,EAAO,MAAM,GAIrB,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,IACX,QAAS,EAAU,EAAK,QAAS,GACjC,YAAa,GAAe,EAAK,UAIzC,eAAe,EAAQ,EAAK,CACxB,IACM,EAAc,wBACd,EAAS,MAAM,IACf,EAAY,KAAK,MACjB,EAAS,CACX,KAAM,EACN,UAAW,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAClF,WAAY,EACZ,QAAS,IAGP,EAAW,MAAMC,EAAI,+BAAU,IAAe,CAChD,aAAc,CACV,GAAG,EACH,YACA,QACA,KAAM,EAAK,EAAa,EAAQ,EAAW,MAG7C,EAAO,EAAS,KAAK,KAAK,KAAK,KAE/B,EAAQ,MAAM,QAAQ,IAAI,EAAK,IAAK,GAASC,EAAM,OAAO,EAAK,IAAK,SAAY,MAAM,EAAe,MAE3G,MAAO,CACH,MAAO,QACP,KAAM,yBACN,YAAa,aACb,KAAM"}