{"version":3,"file":"utils-BTJM9wSK.js","names":["ConfigNotFoundError","got"],"sources":["../../lib/routes/pianyuan/utils.ts"],"sourcesContent":["import { load } from 'cheerio';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nconst security_key = 'pianyuan-security_session_verify';\r\nconst PHPSESSID_key = 'pianyuan-PHPSESSID';\r\nconst loginauth_key = 'pianyuan-py_loginauth';\r\n\r\nconst ProcessFeed = async (list, cache) => {\r\n    const link_base = 'https://pianyuan.org';\r\n\r\n    const items = await Promise.all(\r\n        list.map(async (e) => {\r\n            const link = new URL(e, link_base).href;\r\n            const single = await cache.tryGet(link, async () => {\r\n                const response = await request(link, cache);\r\n                const content = load(response.data);\r\n                const magnet = content('.btn-primary').attr('href');\r\n                const torrent_name = content('body > div.jumbotron.masthead > div > div > div.col-sm-10.col-md-10.col-lg-10.text-left > h1').text();\r\n                const name = content('body > div.jumbotron.masthead > div > div > div.col-sm-10.col-md-10.col-lg-10.text-left > h2 > a').text();\r\n                const size = content('#main-container > div > div.col-sm-10.col-md-8.col-lg-8 > div > ul > li:nth-child(2)').text();\r\n                let length;\r\n                if (size.includes('MB')) {\r\n                    length = size.replace('MB', '') * 1024;\r\n                } else if (size.includes('GB')) {\r\n                    length = size.replace('GB', '') * 1024 * 1024;\r\n                }\r\n                // const description ='';\r\n\r\n                return {\r\n                    title: `${torrent_name} [${name}] [${size}]`,\r\n                    size: length,\r\n                    enclosure_url: magnet,\r\n                    enclosure_type: 'application/x-bittorrent',\r\n                    enclosure_length: length,\r\n                };\r\n            });\r\n            return single;\r\n        })\r\n    );\r\n\r\n    return items;\r\n};\r\n\r\nasync function getCookie(cache) {\r\n    const security_session_verify = await cache.get(security_key);\r\n    const PHPSESSID = await cache.get(PHPSESSID_key);\r\n    let py_loginauth = await cache.get(loginauth_key);\r\n    if (!py_loginauth) {\r\n        if (!config.pianyuan || !config.pianyuan.cookie) {\r\n            throw new ConfigNotFoundError('pianyuan is disabled due to the lack of <a href=\"https://docs.rsshub.app/deploy/config#route-specific-configurations\">relevant config</a>');\r\n        }\r\n        py_loginauth = config.pianyuan.cookie;\r\n    }\r\n    return `${py_loginauth};${security_session_verify};${PHPSESSID};`;\r\n}\r\n\r\nasync function request(link, cache) {\r\n    const cookie = await getCookie(cache);\r\n    const response = await got({\r\n        method: 'get',\r\n        url: link,\r\n        headers: {\r\n            Cookie: cookie,\r\n        },\r\n    });\r\n    // set cookie\r\n    const set_cookie = response.headers['set-cookie'];\r\n    if (set_cookie) {\r\n        for (const e of set_cookie) {\r\n            if (e.includes('security_session_verify')) {\r\n                cache.set(security_key, e.split(';')[0]);\r\n            } else if (e.includes('PHPSESSID')) {\r\n                cache.set(PHPSESSID_key, e.split(';')[0]);\r\n            } else if (e.includes('py_loginauth')) {\r\n                cache.set(loginauth_key, e.split(';')[0]);\r\n            }\r\n        }\r\n    }\r\n    if (response.data.includes('会员登录后才能访问')) {\r\n        throw new ConfigNotFoundError('pianyuan Cookie已失效');\r\n    }\r\n    return response;\r\n}\r\n\r\nexport default { ProcessFeed, request };\r\n"],"mappings":"uMAIA,MAAM,EAAe,mCACf,EAAgB,qBAChB,EAAgB,wBAEhB,EAAc,MAAO,EAAM,IAAU,CACvC,IAEM,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAI,KAAO,IAAM,CAClB,IAAM,EAAO,IAAI,IAAI,EAAG,wBAAW,KAC7B,EAAS,MAAM,EAAM,OAAO,EAAM,SAAY,CAChD,IAAM,EAAW,MAAM,EAAQ,EAAM,GAC/B,EAAU,EAAK,EAAS,MACxB,EAAS,EAAQ,gBAAgB,KAAK,QACtC,EAAe,EAAQ,gGAAgG,OACvH,EAAO,EAAQ,oGAAoG,OACnH,EAAO,EAAQ,wFAAwF,OACzG,EAQJ,OAPI,EAAK,SAAS,MACd,EAAS,EAAK,QAAQ,KAAM,IAAM,KAC3B,EAAK,SAAS,QACrB,EAAS,EAAK,QAAQ,KAAM,IAAM,KAAO,MAItC,CACH,MAAO,GAAG,EAAa,IAAI,EAAK,KAAK,EAAK,GAC1C,KAAM,EACN,cAAe,EACf,eAAgB,2BAChB,iBAAkB,KAG1B,OAAO,KAIf,OAAO,GAGX,eAAe,EAAU,EAAO,CAC5B,IAAM,EAA0B,MAAM,EAAM,IAAI,GAC1C,EAAY,MAAM,EAAM,IAAI,GAC9B,EAAe,MAAM,EAAM,IAAI,GACnC,GAAI,CAAC,EAAc,CACf,GAAI,CAAC,EAAO,UAAY,CAAC,EAAO,SAAS,OACrC,MAAM,IAAIA,EAAoB,6IAElC,EAAe,EAAO,SAAS,OAEnC,MAAO,GAAG,EAAa,GAAG,EAAwB,GAAG,EAAU,GAGnE,eAAe,EAAQ,EAAM,EAAO,CAChC,IAAM,EAAS,MAAM,EAAU,GACzB,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,EACL,QAAS,CACL,OAAQ,KAIV,EAAa,EAAS,QAAQ,cACpC,GAAI,MACK,IAAM,KAAK,EACR,EAAE,SAAS,2BACX,EAAM,IAAI,EAAc,EAAE,MAAM,KAAK,IAC9B,EAAE,SAAS,aAClB,EAAM,IAAI,EAAe,EAAE,MAAM,KAAK,IAC/B,EAAE,SAAS,iBAClB,EAAM,IAAI,EAAe,EAAE,MAAM,KAAK,IAIlD,GAAI,EAAS,KAAK,SAAS,aACvB,MAAM,IAAID,EAAoB,sBAElC,OAAO,EAGX,IAAA,EAAe,CAAE,cAAa"}