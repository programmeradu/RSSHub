{"version":3,"file":"newbook-il8snyLU.js","names":[],"sources":["../../lib/routes/buaa/lib/space/newbook.ts"],"sourcesContent":["import { Data, DataItem, Route } from '@/types';\r\nimport { Context } from 'hono';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport cache from '@/utils/cache';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\ninterface Book {\r\n    bibId: string;\r\n    inBooklist: number;\r\n    thumb: string;\r\n    holdingTypes: string[];\r\n    author: string;\r\n    callno: string[];\r\n    docType: string;\r\n    onSelfDate: string;\r\n    groupId: string;\r\n    isbn: string;\r\n    inDate: number;\r\n    language: string;\r\n    bibNo: string;\r\n    abstract: string;\r\n    docTypeDesc: string;\r\n    title: string;\r\n    itemCount: number;\r\n    tags: string[];\r\n    circCount: number;\r\n    pub_year: string;\r\n    classno: string;\r\n    publisher: string;\r\n    holdings: string;\r\n}\r\n\r\ninterface Holding {\r\n    classMethod: string;\r\n    callNo: string;\r\n    inDate: number;\r\n    shelfMark: string;\r\n    itemsCount: number;\r\n    barCode: string;\r\n    tempLocation: string;\r\n    circStatus: number;\r\n    itemId: number;\r\n    vol: string;\r\n    library: string;\r\n    itemStatus: string;\r\n    itemsAvailable: number;\r\n    location: string;\r\n    extenStatus: number;\r\n    donatorId: null;\r\n    status: string;\r\n    locationName: string;\r\n}\r\n\r\ninterface Info {\r\n    _id: string;\r\n    imageUrl: string | null;\r\n    authorInfo: string;\r\n    catalog: string | null;\r\n    content: string;\r\n    title: string;\r\n}\r\n\r\nexport const route: Route = {\r\n    path: String.raw`/lib/space/:path{newbook.*}`,\r\n    name: '图书馆 - 新书速递',\r\n    url: 'space.lib.buaa.edu.cn/mspace/newBook',\r\n    maintainers: ['OverflowCat'],\r\n    example: '/buaa/lib/space/newbook/',\r\n    handler,\r\n    description: `可通过参数进行筛选：\\`/buaa/lib/space/newbook/key1=value1&key2=value2...\\`\r\n- \\`dcpCode\\`：学科分类代码\r\n  - 例：\r\n    - 工学：\\`08\\`\r\n    - 工学 > 计算机 > 计算机科学与技术：\\`080901\\`\r\n  - 默认值：\\`nolimit\\`\r\n  - 注意事项：不可与 \\`clsNo\\` 同时使用。\r\n- \\`clsNo\\`：中图分类号\r\n  - 例：\r\n    - 计算机科学：\\`TP3\\`\r\n  - 默认值：无\r\n  - 注意事项\r\n    - 不可与 \\`dcpCode\\` 同时使用。\r\n    - 此模式下获取不到上架日期。\r\n- \\`libCode\\`：图书馆代码\r\n  - 例：\r\n    - 本馆：\\`00000\\`\r\n  - 默认值：无\r\n  - 注意事项：只有本馆一个可选值。\r\n- \\`locaCode\\`：馆藏地代码\r\n  - 例：\r\n    - 五层西-中文新书借阅室(A-Z类)：\\`02503\\`\r\n  - 默认值：无\r\n  - 注意事项：必须与 \\`libCode\\` 同时使用。\r\n\r\n示例：\r\n- \\`buaa/lib/space/newbook\\` 为所有新书\r\n- \\`buaa/lib/space/newbook/clsNo=U&libCode=00000&locaCode=60001\\` 为沙河教2图书馆所有中图分类号为 U（交通运输）的书籍\r\n`,\r\n    categories: ['university'],\r\n\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const path = ctx.req.param('path');\r\n    const i = path.indexOf('/');\r\n    const params = i === -1 ? '' : path.slice(i + 1);\r\n    const searchParams = new URLSearchParams(params);\r\n    const dcpCode = searchParams.get('dcpCode'); // Filter by subject (discipline code)\r\n    const clsNo = searchParams.get('clsNo'); // Filter by class (Chinese Library Classification)\r\n    if (dcpCode && clsNo) {\r\n        throw new Error('dcpCode and clsNo cannot be used at the same time');\r\n    }\r\n    searchParams.set('pageSize', '100'); // Max page size. Any larger value will be ignored\r\n    searchParams.set('page', '1');\r\n    !dcpCode && !clsNo && searchParams.set('dcpCode', 'nolimit'); // No classification filter\r\n    const url = `https://space.lib.buaa.edu.cn/meta-local/opac/new/100/${clsNo ? 'byclass' : 'bysubject'}?${searchParams.toString()}`;\r\n    const { data } = await got(url);\r\n    const list = (data?.data?.dataList || []) as Book[];\r\n    const item = await Promise.all(list.map(async (item: Book) => await getItem(item)));\r\n    const res: Data = {\r\n        title: '北航图书馆 - 新书速递',\r\n        item,\r\n        description: '北京航空航天大学图书馆新书速递',\r\n        language: 'zh-CN',\r\n        link: 'https://space.lib.buaa.edu.cn/space/newBook',\r\n        author: '北京航空航天大学图书馆',\r\n        allowEmpty: true,\r\n        image: 'https://lib.buaa.edu.cn/apple-touch-icon.png',\r\n    };\r\n    return res;\r\n}\r\n\r\nasync function getItem(item: Book): Promise<DataItem> {\r\n    return (await cache.tryGet(item.isbn, async () => {\r\n        const info = await getItemInfo(item.isbn);\r\n        const holdings = JSON.parse(item.holdings) as Holding[];\r\n        const link = `https://space.lib.buaa.edu.cn/space/searchDetailLocal/${item.bibId}`;\r\n        const content = art(path.join(__dirname, 'templates/newbook.art'), {\r\n            item,\r\n            info,\r\n            holdings,\r\n        });\r\n        return {\r\n            language: item.language === 'eng' ? 'en' : 'zh-CN',\r\n            title: item.title,\r\n            pubDate: item.onSelfDate ? timezone(parseDate(item.onSelfDate), +8) : undefined,\r\n            description: content,\r\n            link,\r\n        };\r\n    })) as DataItem;\r\n}\r\n\r\nasync function getItemInfo(isbn: string): Promise<Info | null> {\r\n    const url = `https://space.lib.buaa.edu.cn/meta-local/opac/third_api/douban/${isbn}/info`;\r\n    const response = await got(url);\r\n    return JSON.parse(response.body).data;\r\n}\r\n"],"mappings":"2eAiEA,MAAa,EAAe,CACxB,KAAM,OAAO,GAAG,8BAChB,KAAM,aACN,IAAK,uCACL,YAAa,CAAC,eACd,QAAS,2BACT,UACA,YAAa,2mBA6Bb,WAAY,CAAC,cAEb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,aAAc,GACd,UAAW,GACX,eAAgB,GAChB,cAAe,KAIvB,eAAe,EAAQ,EAA6B,CAChD,IAAM,EAAO,EAAI,IAAI,MAAM,QACrB,EAAI,EAAK,QAAQ,KACjB,EAAS,IAAM,GAAK,GAAK,EAAK,MAAM,EAAI,GACxC,EAAe,IAAI,gBAAgB,GACnC,EAAU,EAAa,IAAI,WAC3B,EAAQ,EAAa,IAAI,SAC/B,GAAI,GAAW,EACX,MAAU,MAAM,qDAEpB,EAAa,IAAI,WAAY,OAC7B,EAAa,IAAI,OAAQ,KACzB,CAAC,GAAW,CAAC,GAAS,EAAa,IAAI,UAAW,WAClD,IAAM,EAAM,yDAAyD,EAAQ,UAAY,YAAY,GAAG,EAAa,aAC/G,CAAE,QAAS,MAAM,EAAI,GACrB,EAAQ,GAAM,MAAM,UAAY,GAChC,EAAO,MAAM,QAAQ,IAAI,EAAK,IAAI,KAAO,IAAe,MAAM,EAAQ,KACtE,EAAY,CACd,MAAO,eACP,OACA,YAAa,kBACb,SAAU,QACV,KAAM,8CACN,OAAQ,cACR,WAAY,GACZ,MAAO,gDAEX,OAAO,EAGX,eAAe,EAAQ,EAA+B,CAClD,OAAQ,MAAM,EAAM,OAAO,EAAK,KAAM,SAAY,CAC9C,IAAM,EAAO,MAAM,EAAY,EAAK,MAC9B,EAAW,KAAK,MAAM,EAAK,UAC3B,EAAO,yDAAyD,EAAK,QACrE,EAAU,EAAI,EAAA,KAAA,EAAA,kCAA+C,CAC/D,OACA,OACA,aAEJ,MAAO,CACH,SAAU,EAAK,WAAa,MAAQ,KAAO,QAC3C,MAAO,EAAK,MACZ,QAAS,EAAK,WAAa,EAAS,EAAU,EAAK,YAAa,GAAM,IAAA,GACtE,YAAa,EACb,UAKZ,eAAe,EAAY,EAAoC,CAC3D,IAAM,EAAM,kEAAkE,EAAK,OAC7E,EAAW,MAAM,EAAI,GAC3B,OAAO,KAAK,MAAM,EAAS,MAAM"}