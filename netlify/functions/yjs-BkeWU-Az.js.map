{"version":3,"file":"yjs-BkeWU-Az.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/gmu/yjs.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport type { Route } from '@/types';\r\nimport type { Context } from 'hono';\r\nimport cache from '@/utils/cache';\r\n\r\nconst sections = {\r\n    zsgz: {\r\n        tzgg: { title: '招生工作 - 通知公告', path: '/zsgz/tzgg.htm' },\r\n        xwsd: { title: '招生工作 - 新闻速递', path: '/zsgz/xwsd.htm' },\r\n    },\r\n    pygz: {\r\n        tzgg: { title: '培养工作 - 通知公告', path: '/pygz/tzgg.htm' },\r\n        gzzd: { title: '培养工作 - 规章制度', path: '/pygz/gzzd.htm' },\r\n    },\r\n    xwgz: {\r\n        tzgg: { title: '学位工作 - 通知公告', path: '/xwgz/tzgg.htm' },\r\n        dsgl: { title: '学位工作 - 导师管理', path: '/xwgz/dsgl.htm' },\r\n        xwgl: { title: '学位工作 - 学位管理', path: '/xwgz/xwgl.htm' },\r\n        pggz: { title: '学位工作 - 评估工作', path: '/xwgz/pggz.htm' },\r\n    },\r\n    xsgz: {\r\n        tzgg: { title: '学生工作 - 通知公告', path: '/xsgz/tzgg.htm' },\r\n        xwsd: { title: '学生工作 - 新闻速递', path: '/xsgz/xwsd.htm' },\r\n        xshd: { title: '学生工作 - 学生活动', path: '/xsgz/xshd.htm' },\r\n        jzgz: { title: '学生工作 - 奖助工作', path: '/xsgz/jzgz.htm' },\r\n    },\r\n    xzzx: {\r\n        zsxz: { title: '下载中心 - 招生下载', path: '/xzzx/zsxz.htm' },\r\n        pyxz: { title: '下载中心 - 培养下载', path: '/xzzx/pyxz.htm' },\r\n        // xsxz: { title: '下载中心 - 学生下载', path: '/xzzx/xsxz.htm' },\r\n        xwxz: { title: '下载中心 - 学位下载', path: '/xzzx/xwxz.htm' },\r\n    },\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/yjs/:type/:subtype',\r\n    categories: ['university'],\r\n    example: '/gmu/yjs/zsgz/tzgg',\r\n    parameters: {\r\n        type: {\r\n            description: '分类，见下表',\r\n            options: [\r\n                { value: 'zsgz', label: '招生工作' },\r\n                { value: 'pygz', label: '培养工作' },\r\n                { value: 'xwgz', label: '学位工作' },\r\n                { value: 'xsgz', label: '学生工作' },\r\n                { value: 'xzzx', label: '下载中心' },\r\n            ],\r\n        },\r\n        subtype: {\r\n            description: '子分类，见下表',\r\n            options: [\r\n                { value: 'tzgg', label: '通知公告' },\r\n                { value: 'xwsd', label: '新闻速递' },\r\n                { value: 'gzzd', label: '规章制度' },\r\n                { value: 'dsgl', label: '导师管理' },\r\n                { value: 'xwgl', label: '学位管理' },\r\n                { value: 'pggz', label: '评估工作' },\r\n                { value: 'xshd', label: '学生活动' },\r\n                { value: 'jzgz', label: '奖助工作' },\r\n                { value: 'zsxz', label: '招生下载' },\r\n                { value: 'pyxz', label: '培养下载' },\r\n                { value: 'xwxz', label: '学位下载' },\r\n            ],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '研究生院',\r\n    maintainers: ['FrankFahey'],\r\n    radar: [\r\n        {\r\n            source: ['yjs.gmu.cn/:type/:subtype.htm', 'yjs.gmu.cn/'],\r\n            target: '/yjs/:type/:subtype',\r\n        },\r\n    ],\r\n    handler,\r\n};\r\n\r\nexport async function handler(ctx: Context) {\r\n    const { type, subtype } = ctx.req.param();\r\n\r\n    if (!sections[type] || !sections[type][subtype]) {\r\n        throw new Error('Invalid type or subtype');\r\n    }\r\n\r\n    const { title, path } = sections[type][subtype];\r\n    const baseUrl = 'https://yjs.gmu.cn';\r\n    const link = baseUrl + path;\r\n\r\n    const response = await got(link, {\r\n        https: {\r\n            rejectUnauthorized: false,\r\n        },\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    // 更新选择器以匹配研究生院网站的实际结构\r\n    const list = $('.n_listxx1 li');\r\n\r\n    if (list.length === 0) {\r\n        throw new Error('No content found. The page structure might have changed.');\r\n    }\r\n\r\n    const items = await Promise.all(\r\n        list.toArray().map(async (item) => {\r\n            const element = $(item);\r\n            const a = element.find('a');\r\n            const dateText = element.find('span').text();\r\n            const href = a.attr('href');\r\n            const itemTitle = a.text().trim();\r\n\r\n            if (!href || !itemTitle) {\r\n                return null;\r\n            }\r\n\r\n            const pubDate = parseDate(dateText);\r\n            if (!pubDate) {\r\n                return null;\r\n            }\r\n\r\n            const fullLink = new URL(href, link).href;\r\n\r\n            // Use cache.tryGet to cache the article content\r\n            return await cache.tryGet(`gmu:yjs:${fullLink}`, async () => {\r\n                try {\r\n                    const contentResponse = await got(fullLink, {\r\n                        https: {\r\n                            rejectUnauthorized: false,\r\n                        },\r\n                    });\r\n                    const content = load(contentResponse.data);\r\n\r\n                    // 获取新闻内容\r\n                    const articleContent = content('.v_news_content').html() || '暂无详细内容';\r\n\r\n                    return {\r\n                        title: itemTitle,\r\n                        link: fullLink,\r\n                        pubDate,\r\n                        description: articleContent,\r\n                    };\r\n                } catch {\r\n                    // 如果获取文章内容失败，返回基本信息\r\n                    return {\r\n                        title: itemTitle,\r\n                        link: fullLink,\r\n                        pubDate,\r\n                        description: '暂无详细内容',\r\n                    };\r\n                }\r\n            });\r\n        })\r\n    );\r\n\r\n    const result = items.filter((item): item is { title: string; link: string; pubDate: Date; description: string } => item !== null);\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        description: `广州医科大学研究生院 - ${title}`,\r\n        item: result,\r\n    };\r\n}\r\n"],"mappings":"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"}