{"version":3,"file":"hket-BJnahD3m.js","names":[],"sources":["../../lib/routes/hket/index.ts"],"sourcesContent":["import { DataItem, Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport * as cheerio from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\n\r\nconst urlMap = {\r\n    srac: {\r\n        baseUrl: 'https://china.hket.com',\r\n    },\r\n    sran: {\r\n        baseUrl: 'https://inews.hket.com',\r\n    },\r\n    srat: {\r\n        baseUrl: 'https://topick.hket.com',\r\n    },\r\n    sraw: {\r\n        baseUrl: 'https://wealth.hket.com',\r\n    },\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:category?',\r\n    categories: ['traditional-media'],\r\n    example: '/hket/sran001',\r\n    parameters: { category: '分类，默认为全部新闻，可在 URL 中找到，部分见下表' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['china.hket.com/:category/*'],\r\n            target: '/:category',\r\n        },\r\n        {\r\n            source: ['inews.hket.com/:category/*'],\r\n            target: '/:category',\r\n        },\r\n        {\r\n            source: ['topick.hket.com/:category/*'],\r\n            target: '/:category',\r\n        },\r\n        {\r\n            source: ['wealth.hket.com/:category/*'],\r\n            target: '/:category',\r\n        },\r\n        {\r\n            source: ['www.hket.com/'],\r\n            target: '/',\r\n        },\r\n    ],\r\n    name: '新闻',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n    url: 'www.hket.com/',\r\n    description: `香港经济日报已有提供简单 RSS，详细可前往官方网站： [https://www.hket.com/rss](https://www.hket.com/rss)\r\n\r\n此路由主要补全官方 RSS 全文输出及完善分类输出。\r\n\r\n<details>\r\n<summary>分类</summary>\r\n\r\n| sran001  | sran008  | sran010  | sran011  | sran012  | srat006  |\r\n| -------- | -------- | -------- | -------- | -------- | -------- |\r\n| 全部新闻 | 财经地产 | 科技信息 | 国际新闻 | 商业新闻 | 香港新闻 |\r\n\r\n| sran009  | sran009-1 | sran009-2 | sran009-3  | sran009-4 | sran009-5 | sran009-6 |\r\n| -------- | --------- | --------- | ---------- | --------- | --------- | --------- |\r\n| 即时财经 | 股市      | 新股 IPO  | 新经济追踪 | 当炒股    | 宏观解读  | Hot Talk  |\r\n\r\n| sran011-1 | sran011-2    | sran011-3    |\r\n| --------- | ------------ | ------------ |\r\n| 环球政治  | 环球经济金融 | 环球社会热点 |\r\n\r\n| sran016    | sran016-1  | sran016-2  | sran016-3  | sran016-4  | sran016-5      |\r\n| ---------- | ---------- | ---------- | ---------- | ---------- | -------------- |\r\n| 大湾区主页 | 大湾区发展 | 大湾区工作 | 大湾区买楼 | 大湾区消费 | 大湾区投资理财 |\r\n\r\n| srac002  | srac003  | srac004  | srac005  |\r\n| -------- | -------- | -------- | -------- |\r\n| 即时中国 | 经济脉搏 | 国情动向 | 社会热点 |\r\n\r\n| srat001 | srat008 | srat055  | srat069  | srat070   |\r\n| ------- | ------- | -------- | -------- | --------- |\r\n| 话题    | 观点    | 休闲消费 | 娱乐新闻 | TOPick TV |\r\n\r\n| srat052  | srat052-1 | srat052-2  | srat052-3 |\r\n| -------- | --------- | ---------- | --------- |\r\n| 健康主页 | 食用安全  | 医生诊症室 | 保健美颜  |\r\n\r\n| srat053  | srat053-1 | srat053-2 | srat053-3 | srat053-4  |\r\n| -------- | --------- | --------- | --------- | ---------- |\r\n| 亲子主页 | 儿童健康  | 育儿经    | 教育      | 亲子好去处 |\r\n\r\n| srat053-6   | srat053-61 | srat053-62 | srat053-63 | srat053-64 |\r\n| ----------- | ---------- | ---------- | ---------- | ---------- |\r\n| Band 1 学堂 | 幼稚园     | 中小学     | 尖子教室   | 海外升学   |\r\n\r\n| srat072-1  | srat072-2  | srat072-3        | srat072-4         |\r\n| ---------- | ---------- | ---------------- | ----------------- |\r\n| 健康身心活 | 抗癌新方向 | 「糖」「心」解密 | 风湿不再 你我自在 |\r\n\r\n| sraw007  | sraw009  | sraw010  | sraw011  | sraw012  | sraw014  | sraw018  | sraw019  |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| 全部博客 | Bloggers | 收息攻略 | 精明消费 | 退休规划 | 个人增值 | 财富管理 | 绿色金融 |\r\n\r\n| sraw015  | sraw015-07 | sraw015-08 | sraw015-09 | sraw015-10 |\r\n| -------- | ---------- | ---------- | ---------- | ---------- |\r\n| 移民百科 | 海外置业   | 移民攻略   | 移民点滴   | 海外理财   |\r\n\r\n| sraw020  | sraw020-1    | sraw020-2 | sraw020-3 | sraw020-4 |\r\n| -------- | ------------ | --------- | --------- | --------- |\r\n| ESG 主页 | ESG 趋势政策 | ESG 投资  | ESG 企业  | ESG 社会  |\r\n</details>`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'sran001' } = ctx.req.param();\r\n    const baseUrl = urlMap[category.slice(0, 4)].baseUrl;\r\n\r\n    const response = await ofetch(`${baseUrl}/${category}`);\r\n\r\n    const $ = cheerio.load(response);\r\n\r\n    const list = $('.main-listing-container div.listing-title > a')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            const url = item.parent().parent().find('.share-button').data('url');\r\n            return {\r\n                title: item.text().trim(),\r\n                link: url.startsWith('http') ? url : baseUrl + url,\r\n            };\r\n        }) as DataItem[];\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link!, async () => {\r\n                if (item.link!.startsWith('https://invest.hket.com/') || item.link!.startsWith('https://ps.hket.com/')) {\r\n                    const data = await (item.link!.startsWith('https://invest.hket.com/')\r\n                        ? ofetch('https://invest.hket.com/content-api-middleware/content', {\r\n                              headers: {\r\n                                  referer: item.link!,\r\n                              },\r\n                              method: 'POST',\r\n                              body: {\r\n                                  id: item.link!.split('/').pop(),\r\n                                  channel: 'invest',\r\n                              },\r\n                          })\r\n                        : ofetch('https://data02.hket.com/content', {\r\n                              headers: {\r\n                                  referer: item.link!,\r\n                              },\r\n                              query: {\r\n                                  id: item.link!.split('/').pop(),\r\n                                  channel: 'epc',\r\n                              },\r\n                          }));\r\n\r\n                    item.pubDate = timezone(parseDate(data.displayDate), +8);\r\n                    item.updated = timezone(parseDate(data.lastModifiedDate), +8);\r\n                    item.author = data.authors?.map((e) => e.name).join(', ');\r\n                    item.description = data.content.full || data.content.partial;\r\n                    item.category = data.contentTags?.map((e) => e.name);\r\n\r\n                    return item;\r\n                }\r\n\r\n                const response = await ofetch(item.link!);\r\n                const $ = cheerio.load(response);\r\n\r\n                item.category = $('.contentTags-container > .hotkey-container-wrapper > .hotkey-container > a')\r\n                    .toArray()\r\n                    .map((e) => $(e).text().trim());\r\n\r\n                // remove unwanted elements\r\n                $('source').remove();\r\n                $('p.article-detail_caption, .article-extend-button, span.click-to-enlarge').remove();\r\n                $('.loyalty-promotion-container, .relatedContents-container, .article-details-center-sharing-btn, .article-detail_login').remove();\r\n                $('.gallery-related-container, .contentTags-container').remove();\r\n                $('.listing-widget-126, div.template-default.hket-row.no-padding.detail-widget').remove();\r\n\r\n                // remove ads\r\n                $('.ad_MobileMain, .adunit, .native-ad').remove();\r\n\r\n                $('span').each((_, e) => {\r\n                    if ($(e).text().startsWith('+')) {\r\n                        $(e).remove();\r\n                    }\r\n                });\r\n\r\n                // fix lazyload image and caption\r\n                $('img').each((_, e) => {\r\n                    e = $(e);\r\n                    e.replaceWith(\r\n                        art(path.join(__dirname, 'templates/image.art'), {\r\n                            alt: e.data('alt'),\r\n                            src: e.data('src') ?? e.attr('src'),\r\n                        })\r\n                    );\r\n                });\r\n\r\n                const ldJson = JSON.parse(\r\n                    $('script[type=\"application/ld+json\"]')\r\n                        .toArray()\r\n                        .find((e) => $(e).text().includes('NewsArticle'))?.children[0].data\r\n                );\r\n\r\n                item.description = $('div.article-detail-body-container').html()!;\r\n                item.pubDate = parseDate(ldJson.datePublished);\r\n                item.updated = parseDate(ldJson.dateModified);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('head meta[name=title]').attr('content')?.trim(),\r\n        link: baseUrl + '/' + category,\r\n        description: $('head meta[name=description]').attr('content')?.trim(),\r\n        item: items,\r\n        language: 'zh-hk',\r\n    };\r\n}\r\n"],"mappings":"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"}