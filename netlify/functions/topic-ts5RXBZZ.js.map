{"version":3,"file":"topic-ts5RXBZZ.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/scmp/topic.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { parseItem } from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/topics/:topic',\r\n    categories: ['traditional-media'],\r\n    example: '/scmp/topics/coronavirus-pandemic-all-stories',\r\n    parameters: { topic: 'Topic, can be found in URL' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['scmp.com/topics/:topic'],\r\n        },\r\n    ],\r\n    name: 'Topics',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const topic = ctx.req.param('topic');\r\n    const limit = Number.parseInt(ctx.req.query('limit'), 10) || 30;\r\n    const pageUrl = `https://www.scmp.com/topics/${topic}`;\r\n    const { data: pageResponse } = await got(pageUrl);\r\n    const $ = load(pageResponse);\r\n\r\n    const nextData = JSON.parse($('script#__NEXT_DATA__').text());\r\n    const topicData = nextData.props.pageProps.payload.data.topic;\r\n    const variables = nextData.props.pageProps.operationDescriptor.root.variables;\r\n\r\n    const { data: apiResponse } = await got('https://apigw.scmp.com/content-delivery/v2', {\r\n        headers: {\r\n            apikey: 'MyYvyg8M9RTaevVlcIRhN5yRIqqVssNY',\r\n            'content-type': 'application/json',\r\n        },\r\n        searchParams: {\r\n            // got v11 does not support nested object in searchParams\r\n            extensions: JSON.stringify({\r\n                persistedQuery: {\r\n                    sha256Hash: '8c951c1c2d4e94bc37d06dd94571552da4c0440c744acd00f2af84d3d8b6e2cf',\r\n                    version: 1,\r\n                },\r\n            }),\r\n            operationName: 'topicContentListPaginationQuery',\r\n            variables: JSON.stringify({\r\n                applicationIds: variables.applicationIds,\r\n                count: limit,\r\n                scmpPlusPaywallTypeIds: variables.scmpPlusPaywallTypeIds,\r\n                id: topicData.id,\r\n            }),\r\n        },\r\n    });\r\n\r\n    const list = apiResponse.data.node.contents.edges.map(({ node }) => ({\r\n        title: node.headline,\r\n        summary: node.summary.text,\r\n        link: `https://www.scmp.com${node.urlAlias}`,\r\n        author: node.authors.map((a) => a.name).join(', '),\r\n        pubDate: parseDate(node.publishedDate, 'x'),\r\n        updated: parseDate(node.updatedDate, 'x'),\r\n    }));\r\n\r\n    const items = await Promise.all(list.map((item) => cache.tryGet(item.link, () => parseItem(item))));\r\n\r\n    ctx.set('json', {\r\n        nextData,\r\n        apiResponse,\r\n    });\r\n\r\n    return {\r\n        title: topicData.name,\r\n        link: pageUrl,\r\n        description: topicData.description.text,\r\n        item: items,\r\n        language: 'en-hk',\r\n        icon: 'https://assets.i-scmp.com/static/img/icons/scmp-icon-256x256.png',\r\n        logo: 'https://customerservice.scmp.com/img/logo_scmp@2x.png',\r\n        image: 'https://assets-v2.i-scmp.com/production/_next/static/media/default-image.d1be8967.png',\r\n    };\r\n}\r\n"],"mappings":"wZAOA,MAAaA,EAAe,CACxB,KAAM,iBACN,WAAY,CAAC,qBACb,QAAS,gDACT,WAAY,CAAE,MAAO,8BACrB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,4BAGjB,KAAM,SACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAQ,EAAI,IAAI,MAAM,SACtB,EAAQ,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,KAAO,GACvD,EAAU,+BAA+B,IACzC,CAAE,KAAM,GAAiB,MAAMC,EAAI,GACnC,EAAI,EAAK,GAET,EAAW,KAAK,MAAM,EAAE,wBAAwB,QAChD,EAAY,EAAS,MAAM,UAAU,QAAQ,KAAK,MAClD,EAAY,EAAS,MAAM,UAAU,oBAAoB,KAAK,UAE9D,CAAE,KAAM,GAAgB,MAAMA,EAAI,6CAA8C,CAClF,QAAS,CACL,OAAQ,mCACR,eAAgB,oBAEpB,aAAc,CAEV,WAAY,KAAK,UAAU,CACvB,eAAgB,CACZ,WAAY,mEACZ,QAAS,KAGjB,cAAe,kCACf,UAAW,KAAK,UAAU,CACtB,eAAgB,EAAU,eAC1B,MAAO,EACP,uBAAwB,EAAU,uBAClC,GAAI,EAAU,QAKpB,EAAO,EAAY,KAAK,KAAK,SAAS,MAAM,KAAK,CAAE,WAAY,CACjE,MAAO,EAAK,SACZ,QAAS,EAAK,QAAQ,KACtB,KAAM,uBAAuB,EAAK,WAClC,OAAQ,EAAK,QAAQ,IAAK,GAAM,EAAE,MAAM,KAAK,MAC7C,QAAS,EAAU,EAAK,cAAe,KACvC,QAAS,EAAU,EAAK,YAAa,QAGnC,EAAQ,MAAM,QAAQ,IAAI,EAAK,IAAK,GAASC,EAAM,OAAO,EAAK,SAAY,EAAU,MAO3F,OALA,EAAI,IAAI,OAAQ,CACZ,WACA,gBAGG,CACH,MAAO,EAAU,KACjB,KAAM,EACN,YAAa,EAAU,YAAY,KACnC,KAAM,EACN,SAAU,QACV,KAAM,mEACN,KAAM,wDACN,MAAO"}