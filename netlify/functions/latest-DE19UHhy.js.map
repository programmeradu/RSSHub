{"version":3,"file":"latest-DE19UHhy.js","names":["route: Route","got","cache","contents: Data[]"],"sources":["../../lib/routes/yilinzazhi/latest.ts"],"sourcesContent":["import { Data, DataItem, Route, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport dayjs from 'dayjs';\r\n\r\nexport const route: Route = {\r\n    path: '/latest',\r\n    categories: ['reading'],\r\n    view: ViewType.Articles,\r\n    example: '/yilinzazhi/latest',\r\n    radar: [\r\n        {\r\n            source: ['www.yilinzazhi.com'],\r\n            target: '/',\r\n        },\r\n    ],\r\n    name: '近期文章汇总',\r\n    maintainers: ['g0ngjie'],\r\n    handler,\r\n    url: 'www.yilinzazhi.com',\r\n    description: '最近一期的文章汇总',\r\n};\r\n\r\ntype Stage = {\r\n    link: string;\r\n    title: string;\r\n};\r\n\r\ntype Catalog = {\r\n    title: string;\r\n    tables: Data[];\r\n};\r\n\r\nasync function handler(): Promise<Data> {\r\n    const baseUrl = 'https://www.yilinzazhi.com/';\r\n    const response = await got(baseUrl);\r\n    const $ = load(response.data);\r\n\r\n    const currentYear = dayjs().year();\r\n    const yearSection = $('.year-section')\r\n        .toArray()\r\n        .find((el) =>\r\n            $(el)\r\n                .find('.year-title')\r\n                .text()\r\n                .includes(currentYear + '')\r\n        );\r\n\r\n    const stage = $(yearSection!)\r\n        .find('a')\r\n        .toArray()\r\n        .map<Stage>((elem) => {\r\n            const aTag = $(elem);\r\n            const link = baseUrl + aTag.attr('href');\r\n            const title = aTag.text();\r\n            return { link, title };\r\n        })[0];\r\n\r\n    const catalogs = (await cache.tryGet(stage.link, async () => {\r\n        const stageRes = await got(stage.link);\r\n        const $$ = load(stageRes.data);\r\n        const catalogsEl = $$('.maglistbox dl').toArray();\r\n        const children = catalogsEl.map<Catalog>((catalog) => {\r\n            const title = $$(catalog).find('dt span').text();\r\n            const tables = $$(catalog)\r\n                .find('a')\r\n                .toArray()\r\n                .map<Data>((aTag) => {\r\n                    const href = $$(aTag).attr('href')!;\r\n                    const yearType = currentYear + href.slice(4, 5);\r\n                    return {\r\n                        title: $$(aTag).text(),\r\n                        link: `${baseUrl}${currentYear}/yl${yearType}/${href}`,\r\n                    };\r\n                });\r\n            return { title, tables };\r\n        });\r\n        return children;\r\n    })) as Catalog[];\r\n\r\n    const contents: Data[] = catalogs.flatMap((catalog) => catalog.tables);\r\n\r\n    const items = (await Promise.all(\r\n        contents.map(\r\n            async (target) =>\r\n                await cache.tryGet(target.link!, async () => {\r\n                    const detailRes = await got(target.link);\r\n                    const $$ = load(detailRes.data);\r\n                    const detailContainer = $$('.blkContainerSblk.collectionContainer');\r\n\r\n                    target.description = detailContainer.html()!;\r\n\r\n                    return target;\r\n                })\r\n        )\r\n    )) as DataItem[];\r\n\r\n    return {\r\n        title: '意林 - 近期文章汇总',\r\n        link: stage.link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"uXAMA,MAAaA,EAAe,CACxB,KAAM,UACN,WAAY,CAAC,WACb,KAAM,EAAS,SACf,QAAS,qBACT,MAAO,CACH,CACI,OAAQ,CAAC,sBACT,OAAQ,MAGhB,KAAM,SACN,YAAa,CAAC,WACd,UACA,IAAK,qBACL,YAAa,aAajB,eAAe,GAAyB,CACpC,IAAM,EAAU,8BACV,EAAW,MAAMC,EAAI,GACrB,EAAI,EAAK,EAAS,MAElB,EAAc,IAAQ,OACtB,EAAc,EAAE,iBACjB,UACA,KAAM,GACH,EAAE,GACG,KAAK,eACL,OACA,SAAS,EAAc,KAG9B,EAAQ,EAAE,GACX,KAAK,KACL,UACA,IAAY,GAAS,CAClB,IAAM,EAAO,EAAE,GACT,EAAO,EAAU,EAAK,KAAK,QAC3B,EAAQ,EAAK,OACnB,MAAO,CAAE,OAAM,WAChB,GAED,EAAY,MAAMC,EAAM,OAAO,EAAM,KAAM,SAAY,CACzD,IAAM,EAAW,MAAMD,EAAI,EAAM,MAC3B,EAAK,EAAK,EAAS,MACnB,EAAa,EAAG,kBAAkB,UAClC,EAAW,EAAW,IAAc,GAAY,CAClD,IAAM,EAAQ,EAAG,GAAS,KAAK,WAAW,OACpC,EAAS,EAAG,GACb,KAAK,KACL,UACA,IAAW,GAAS,CACjB,IAAM,EAAO,EAAG,GAAM,KAAK,QACrB,EAAW,EAAc,EAAK,MAAM,EAAG,GAC7C,MAAO,CACH,MAAO,EAAG,GAAM,OAChB,KAAM,GAAG,IAAU,EAAY,KAAK,EAAS,GAAG,OAG5D,MAAO,CAAE,QAAO,YAEpB,OAAO,IAGLE,EAAmB,EAAS,QAAS,GAAY,EAAQ,QAEzD,EAAS,MAAM,QAAQ,IACzB,EAAS,IACL,KAAO,IACH,MAAMD,EAAM,OAAO,EAAO,KAAO,SAAY,CACzC,IAAM,EAAY,MAAMD,EAAI,EAAO,MAC7B,EAAK,EAAK,EAAU,MACpB,EAAkB,EAAG,yCAI3B,MAFA,GAAO,YAAc,EAAgB,OAE9B,MAKvB,MAAO,CACH,MAAO,cACP,KAAM,EAAM,KACZ,KAAM"}