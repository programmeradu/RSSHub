{"version":3,"file":"rank-CWqkflos.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/xinpianchang/rank.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\n\r\nimport { rootUrl, getData, processItems } from './util';\r\n\r\nexport const route: Route = {\r\n    path: '/rank/:category?',\r\n    categories: ['new-media'],\r\n    example: '/xinpianchang/rank',\r\n    parameters: { category: '分类 id，可在对应排行榜页 URL 中找到，见下表，默认为 `all` ，即总榜' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '排行榜',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 分类     | id         |\r\n| -------- | ---------- |\r\n| 总榜     | all        |\r\n| 精选榜   | staffPicks |\r\n| 广告     | ad         |\r\n| 宣传片   | publicity  |\r\n| 创意     | creative   |\r\n| 干货教程 | backstage  |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'all' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 60;\r\n\r\n    const apiRankUrl = new URL(`api/xpc/v2/rank/${category}`, rootUrl).href;\r\n\r\n    const { data: apiResponse } = await got(apiRankUrl);\r\n\r\n    const current = apiResponse.data.list[0];\r\n    const currentUrl = current.web_link;\r\n    const currentName = `${current.code}-${current.year}-${current.index}`;\r\n\r\n    const { data, response: currentResponse } = await getData(currentUrl, cache.tryGet);\r\n\r\n    const buildId = currentResponse.match(/\\/static\\/(\\w+)\\/_buildManifest\\.js/)[1];\r\n\r\n    const apiUrl = new URL(`_next/data/${buildId}/rank/article/${currentName}.json`, rootUrl).href;\r\n\r\n    const { data: response } = await got(apiUrl);\r\n\r\n    let items = response.pageProps.rankList;\r\n\r\n    items = await processItems(items.slice(0, limit), cache.tryGet);\r\n\r\n    return {\r\n        ...data,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"8ZAMA,MAAaA,EAAe,CACxB,KAAM,mBACN,WAAY,CAAC,aACb,QAAS,qBACT,WAAY,CAAE,SAAU,6CACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,MACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;;wBAUjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,OAAU,EAAI,IAAI,QAC/B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAa,IAAI,IAAI,mBAAmB,IAAY,GAAS,KAE7D,CAAE,KAAM,GAAgB,MAAMC,EAAI,GAElC,EAAU,EAAY,KAAK,KAAK,GAChC,EAAa,EAAQ,SACrB,EAAc,GAAG,EAAQ,KAAK,GAAG,EAAQ,KAAK,GAAG,EAAQ,QAEzD,CAAE,OAAM,SAAU,GAAoB,MAAM,EAAQ,EAAYC,EAAM,QAEtE,EAAU,EAAgB,MAAM,uCAAuC,GAEvE,EAAS,IAAI,IAAI,cAAc,EAAQ,gBAAgB,EAAY,OAAQ,GAAS,KAEpF,CAAE,KAAM,GAAa,MAAMD,EAAI,GAEjC,EAAQ,EAAS,UAAU,SAI/B,MAFA,GAAQ,MAAM,EAAa,EAAM,MAAM,EAAG,GAAQC,EAAM,QAEjD,CACH,GAAG,EACH,KAAM"}