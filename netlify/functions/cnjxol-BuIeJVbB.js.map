{"version":3,"file":"cnjxol-BuIeJVbB.js","names":[],"sources":["../../lib/routes/cnjxol/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nconst categories = {\r\n    jxrb: '嘉兴日报',\r\n    nhwb: '南湖晚报',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:category?/:id?',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category') ?? 'jxrb';\r\n    const id = ctx.req.param('id');\r\n    if (!Object.keys(categories).includes(category)) {\r\n        throw new InvalidParameterError('Invalid category');\r\n    }\r\n\r\n    const rootUrl = `https://${category}.cnjxol.com`;\r\n    const currentUrl = `${rootUrl}/${category}Paper/pc/layout`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    let $ = load(response.data);\r\n    const dateMatch = $('a')\r\n        .first()\r\n        .attr('href')\r\n        .match(/\\d{6}\\/\\d{2}/)[0];\r\n\r\n    let items = [];\r\n\r\n    if (id) {\r\n        const pageUrl = `${currentUrl}/${dateMatch}/node_${id}.html`;\r\n\r\n        const pageResponse = await got({\r\n            method: 'get',\r\n            url: pageUrl,\r\n        });\r\n\r\n        $ = load(pageResponse.data);\r\n\r\n        items = $('#articlelist .clearfix a')\r\n            .toArray()\r\n            .map((a) => `${currentUrl}/${$(a).attr('href')}`.replaceAll('layout/../../../', ''));\r\n    } else {\r\n        await Promise.all(\r\n            $('#list li a')\r\n                .toArray()\r\n                .map(async (p) => {\r\n                    const pageResponse = await got({\r\n                        method: 'get',\r\n                        url: `${currentUrl}/${$(p).attr('href')}`,\r\n                    });\r\n\r\n                    const page = load(pageResponse.data);\r\n\r\n                    items.push(\r\n                        ...page('#articlelist .clearfix a')\r\n                            .toArray()\r\n                            .map((a) => `${currentUrl}/${page(a).attr('href')}`.replaceAll('layout/../../../', ''))\r\n                    );\r\n                })\r\n        );\r\n    }\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item,\r\n                });\r\n\r\n                const content = load(detailResponse.data);\r\n\r\n                return {\r\n                    link: item,\r\n                    title: content('#Title').text(),\r\n                    pubDate: parseDate(content('date').text()),\r\n                    description: art(path.join(__dirname, 'templates/description.art'), {\r\n                        attachment: content('.attachment').html(),\r\n                        content: content('founder-content').html(),\r\n                    }),\r\n                };\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${categories[category]}${id ? ` - ${$('#layout').text()}` : ''}`,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"oiBAUA,MAAM,EAAa,CACf,KAAM,OACN,KAAM,QAGG,EAAe,CACxB,KAAM,mBACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,aAAe,OACxC,EAAK,EAAI,IAAI,MAAM,MACzB,GAAI,CAAC,OAAO,KAAK,GAAY,SAAS,GAClC,MAAM,IAAI,EAAsB,oBAGpC,IAAM,EAAU,WAAW,EAAS,aAC9B,EAAa,GAAG,EAAQ,GAAG,EAAS,iBAEpC,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGL,EAAI,EAAK,EAAS,MAChB,EAAY,EAAE,KACf,QACA,KAAK,QACL,MAAM,gBAAgB,GAEvB,EAAQ,GAEZ,GAAI,EAAI,CACJ,IAAM,EAAU,GAAG,EAAW,GAAG,EAAU,QAAQ,EAAG,OAEhD,EAAe,MAAM,EAAI,CAC3B,OAAQ,MACR,IAAK,IAGT,EAAI,EAAK,EAAa,MAEtB,EAAQ,EAAE,4BACL,UACA,IAAK,GAAM,GAAG,EAAW,GAAG,EAAE,GAAG,KAAK,UAAU,WAAW,mBAAoB,UAEpF,MAAM,QAAQ,IACV,EAAE,cACG,UACA,IAAI,KAAO,IAAM,CACd,IAAM,EAAe,MAAM,EAAI,CAC3B,OAAQ,MACR,IAAK,GAAG,EAAW,GAAG,EAAE,GAAG,KAAK,YAG9B,EAAO,EAAK,EAAa,MAE/B,EAAM,KACF,GAAG,EAAK,4BACH,UACA,IAAK,GAAM,GAAG,EAAW,GAAG,EAAK,GAAG,KAAK,UAAU,WAAW,mBAAoB,SA6B3G,MAvBA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAM,SAAY,CAC3B,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,IAGH,EAAU,EAAK,EAAe,MAEpC,MAAO,CACH,KAAM,EACN,MAAO,EAAQ,UAAU,OACzB,QAAS,EAAU,EAAQ,QAAQ,QACnC,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,WAAY,EAAQ,eAAe,OACnC,QAAS,EAAQ,mBAAmB,cAOjD,CACH,MAAO,GAAG,EAAW,KAAY,EAAK,MAAM,EAAE,WAAW,SAAW,KACpE,KAAM,EACN,KAAM"}