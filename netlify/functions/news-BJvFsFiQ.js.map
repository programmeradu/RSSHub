{"version":3,"file":"news-BJvFsFiQ.js","names":[],"sources":["../../lib/routes/lovelive-anime/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\nimport ofetch from '@/utils/ofetch';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nconst renderDescription = (desc) => art(path.join(__dirname, 'templates/description.art'), desc);\r\n\r\nexport const route: Route = {\r\n    path: '/news/:abbr?/:category?/:option?',\r\n    categories: ['anime'],\r\n    example: '/lovelive-anime/news',\r\n    parameters: {\r\n        abbr: 'The path to the Love Live series of sub-projects on the official website is detailed in the table below, `abbr` is `detail` when crawling the full text',\r\n        category: 'The official website lists the Topics category, `category` is `detail` when crawling the full text, other categories see the following table for details',\r\n        option: 'Crawl full text when `option` is `detail`.',\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.lovelive-anime.jp/', 'www.lovelive-anime.jp/news/'],\r\n            target: '/news',\r\n        },\r\n    ],\r\n    name: 'News',\r\n    maintainers: ['axojhf', 'zhaoweizhong'],\r\n    handler,\r\n    url: 'www.lovelive-anime.jp/',\r\n    description: `| Sub-project Name | All Projects | Lovelive!   | Lovelive! Sunshine!! | Lovelive! Nijigasaki High School Idol Club | Lovelive! Superstar!! | 蓮ノ空女学院 | 幻日のヨハネ | ラブライブ！スクールアイドルミュージカル |\r\n| -------------------------------- | -------------- | ----------- | -------------------- | ------------------------------------------ | --------------------- | ------------ | ------------ | ---------------------------------------- |\r\n| \\`abbr\\`parameter                  | <u>*No parameter*</u> | lovelive |     sunshine        | nijigasaki                                 | superstar              | hasunosora | yohane       | musical                                  |\r\n\r\n| Category Name       | 全てのニュース        | 音楽商品 | アニメ映像商品 | キャスト映像商品 | 劇場    | アニメ放送 / 配信 | キャスト配信 / ラジオ | ライブ / イベント | ブック | グッズ | ゲーム | メディア | ご当地情報 | キャンペーン | その他 |\r\n| ------------------- | --------------------- | -------- | -------------- | ---------------- | ------- | ----------------- | --------------------- | ----------------- | ------ | ------ | ------ | -------- | ---------- | ------ | ------------ |\r\n| \\`category\\`parameter | <u>*No parameter*</u> | music    | anime_movie   | cast_movie      | theater | onair             | radio                 | event             | books  | goods  | game   | media    | local      | campaign  | other   |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const abbr = ctx.req.param('abbr');\r\n    const category = ctx.req.param('category');\r\n    const option = ctx.req.param('option');\r\n\r\n    const isDetail = abbr === 'detail' || category === 'detail' || option === 'detail';\r\n    let series = '';\r\n    let subcategory = '';\r\n\r\n    if (abbr && abbr !== 'detail') {\r\n        series = abbr;\r\n        if (category && category !== 'detail') {\r\n            subcategory = category;\r\n        }\r\n    }\r\n\r\n    const limit = 20;\r\n\r\n    let url = `https://www.lovelive-anime.jp/common/api/article_list.php?site=jp&ip=lovelive&limit=${limit}&data=`;\r\n    const params: { category: string[]; series?: string[]; subcategory?: string[] } = { category: ['NEWS'] };\r\n    if (series) {\r\n        params.series = [series];\r\n    }\r\n    if (subcategory) {\r\n        params.subcategory = [subcategory];\r\n    }\r\n    url += encodeURIComponent(JSON.stringify(params));\r\n\r\n    const data = await ofetch(url);\r\n\r\n    const articles = data.data.article_list.map((item) => ({\r\n        title: item.title,\r\n        link: item.url,\r\n        description: renderDescription({\r\n            imglink: 'https://www.lovelive-anime.jp' + item.thumbnail,\r\n        }),\r\n        pubDate: timezone(parseDate(item.dspdate), +9),\r\n        category: item.categories.subcategory.map((category) => category.name),\r\n    }));\r\n\r\n    let items = articles;\r\n\r\n    if (isDetail) {\r\n        items = await Promise.all(\r\n            articles.map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const detailResp = await got(item.link);\r\n                    const $ = load(detailResp.data);\r\n\r\n                    const content = $('div.p-page__detail.p-article');\r\n                    for (const v of content.find('img')) {\r\n                        v.attribs.src = 'https://www.lovelive-anime.jp' + v.attribs.src;\r\n                    }\r\n                    item.description = content.html();\r\n                    return item;\r\n                })\r\n            )\r\n        );\r\n    }\r\n\r\n    return {\r\n        title: 'lovelive official website news',\r\n        link: 'https://www.lovelive-anime.jp/news/',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"miBAUA,MAAM,EAAqB,GAAS,EAAI,EAAA,KAAA,EAAA,sCAAmD,GAE9E,EAAe,CACxB,KAAM,mCACN,WAAY,CAAC,SACb,QAAS,uBACT,WAAY,CACR,KAAM,0JACN,SAAU,2JACV,OAAQ,8CAEZ,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,yBAA0B,+BACnC,OAAQ,UAGhB,KAAM,OACN,YAAa,CAAC,SAAU,gBACxB,UACA,IAAK,yBACL,YAAa;;;;;;oPASjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,QACrB,EAAW,EAAI,IAAI,MAAM,YACzB,EAAS,EAAI,IAAI,MAAM,UAEvB,EAAW,IAAS,UAAY,IAAa,UAAY,IAAW,SACtE,EAAS,GACT,EAAc,GAEd,GAAQ,IAAS,WACjB,EAAS,EACL,GAAY,IAAa,WACzB,EAAc,IAItB,IAEI,EAAM,+FACJ,EAA4E,CAAE,SAAU,CAAC,SAC3F,IACA,EAAO,OAAS,CAAC,IAEjB,IACA,EAAO,YAAc,CAAC,IAE1B,GAAO,mBAAmB,KAAK,UAAU,IAEzC,IAAM,EAAO,MAAM,EAAO,GAEpB,EAAW,EAAK,KAAK,aAAa,IAAK,IAAU,CACnD,MAAO,EAAK,MACZ,KAAM,EAAK,IACX,YAAa,EAAkB,CAC3B,QAAS,gCAAkC,EAAK,YAEpD,QAAS,EAAS,EAAU,EAAK,SAAU,GAC3C,SAAU,EAAK,WAAW,YAAY,IAAK,GAAa,EAAS,SAGjE,EAAQ,EAoBZ,OAlBI,IACA,EAAQ,MAAM,QAAQ,IAClB,EAAS,IAAK,GACV,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAa,MAAM,EAAI,EAAK,MAC5B,EAAI,EAAK,EAAW,MAEpB,EAAU,EAAE,gCAClB,IAAK,IAAM,KAAK,EAAQ,KAAK,OACzB,EAAE,QAAQ,IAAM,gCAAkC,EAAE,QAAQ,IAGhE,MADA,GAAK,YAAc,EAAQ,OACpB,OAMhB,CACH,MAAO,iCACP,KAAM,sCACN,KAAM"}