{"version":3,"file":"transcriptforest-Dw_t__DY.js","names":[],"sources":["../../lib/routes/transcriptforest/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst bakeTimestamp = (seconds) => {\r\n    const hours = Math.floor(seconds / 3600);\r\n    const minutes = Math.floor((seconds % 3600) / 60);\r\n    const remainingSeconds = Math.floor(seconds % 60);\r\n\r\n    const formattedHours = String(hours).padStart(2, '0');\r\n    const formattedMinutes = String(minutes).padStart(2, '0');\r\n    const formattedSeconds = String(remainingSeconds).padStart(2, '0');\r\n\r\n    return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:channel?',\r\n    radar: [\r\n        {\r\n            source: ['www.transcriptforest.com/en/channel'],\r\n            target: '',\r\n        },\r\n    ],\r\n    name: 'Unknown',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    url: 'www.transcriptforest.com/en/channel',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const channel = ctx.req.param('channel');\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 10;\r\n\r\n    const rootUrl = 'https://www.transcriptforest.com';\r\n\r\n    const { data: firstResponse } = await got(rootUrl);\r\n\r\n    const data = JSON.parse(firstResponse.match(/({\"props\".*\"scriptLoader\":\\[]})<\\/script>/)?.[1]);\r\n\r\n    const buildId = data.buildId;\r\n    const defaultLocale = data.defaultLocale;\r\n    const channels = data.props.pageProps.listChannel;\r\n    const selected = channel ? channels.find((c) => c.channel_id === channel || c.channel_name === channel) : undefined;\r\n\r\n    const apiUrl = new URL(`_next/data/${buildId}/en${selected ? `/channel/${selected.channel_id}` : ''}.json`, rootUrl).href;\r\n    const currentUrl = new URL(selected ? `${defaultLocale}/channel/${selected.channel_id}` : '', rootUrl).href;\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: {\r\n            channelName: selected ? selected.channel_id : '',\r\n            offset: 0,\r\n        },\r\n    });\r\n\r\n    let items = response.pageProps.listEpisode.data.slice(0, limit).map((item) => ({\r\n        title: item.episode_name,\r\n        link: new URL(`${defaultLocale}/${item.channel_id}/${item.episode_id}`, rootUrl).href,\r\n        detailUrl: new URL(`_next/data/${buildId}/${defaultLocale}/${item.channel_id}/${item.episode_id}.json`, rootUrl).href,\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            texts: item.episode_description.split(/\\n\\n/).map((text) => ({\r\n                text,\r\n            })),\r\n        }),\r\n        author: item.channel_name,\r\n        guid: item.id,\r\n        pubDate: parseDate(item.published_at),\r\n        updated: parseDate(item.updated_at),\r\n        itunes_item_image: item.episode_cover.split(/\\?/)[0],\r\n        itunes_duration: item.episode_duration,\r\n        enclosure_url: item.source_media,\r\n        enclosure_type: 'audio/mpeg',\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.detailUrl);\r\n                const { data: textResponse } = await got(detailResponse.pageProps.currentEpisode.ps4_url);\r\n\r\n                item.description =\r\n                    art(path.join(__dirname, 'templates/description.art'), {\r\n                        audios: [\r\n                            {\r\n                                src: detailResponse.pageProps.currentEpisode.media,\r\n                                type: 'audio/mpeg',\r\n                            },\r\n                        ],\r\n                    }) +\r\n                    item.description +\r\n                    art(path.join(__dirname, 'templates/description.art'), {\r\n                        texts: textResponse.map((t) => ({\r\n                            startTime: bakeTimestamp(t.startTime),\r\n                            endTime: bakeTimestamp(t.endTime),\r\n                            text: t.readOnlyText,\r\n                        })),\r\n                    });\r\n\r\n                delete item.detailUrl;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const title = $('title').text();\r\n    const image = $('meta[property=\"og:image\"]').prop('content');\r\n    const icon = new URL($('link[rel=\"apple-touch-icon\"]').prop('href'), rootUrl).href;\r\n    const author = title.split(/\\|/)[0].trim();\r\n\r\n    return {\r\n        item: items,\r\n        title,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        author,\r\n        itunes_author: author,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"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"}