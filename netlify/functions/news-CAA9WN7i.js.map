{"version":3,"file":"news-CAA9WN7i.js","names":["route: Route","parseList"],"sources":["../../lib/routes/hafu/utils.ts","../../lib/routes/hafu/news.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst typeMap = {\r\n    ggtz: { url: 'https://www.hafu.edu.cn/index/ggtz.htm', root: 'https://www.hafu.edu.cn/', title: '河南财院 - 公告通知', parseFn: ggtzParse },\r\n    jwc: { url: 'https://jwc.hafu.edu.cn/tzgg.htm', root: 'https://jwc.hafu.edu.cn/', title: '河南财院 教务处 - 公告通知', parseFn: jwcParse },\r\n    zsjyc: { url: 'https://zsjyc.hafu.edu.cn/tztg.htm', root: 'https://zsjyc.hafu.edu.cn/', title: '河南财院 招生就业处 - 公告通知', parseFn: zsjycParse },\r\n};\r\n// Number of get articles\r\nlet limit = 10;\r\n\r\nconst parseList = async (ctx, type) => {\r\n    const link = typeMap[type].url;\r\n    const title = typeMap[type].title;\r\n\r\n    const response = await got(link);\r\n    const $ = load(response.data);\r\n\r\n    limit = ctx.req.query('limit') || limit;\r\n    const resultList = await typeMap[type].parseFn(ctx, $);\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        resultList,\r\n    };\r\n};\r\nexport default parseList;\r\n\r\nasync function tryGetFullText(href, link, type) {\r\n    let articleData = '';\r\n    let description = '';\r\n    // for some unexpected href link\r\n    try {\r\n        const articleRes = await got(link);\r\n        articleData = load(articleRes.data);\r\n        // fullText\r\n        let articleBody = articleData('div[class=v_news_content]').html();\r\n        // attachments\r\n        if (articleData('[id^=nattach]').length !== 0) {\r\n            articleBody = tryGetAttachments(articleData, articleBody, type);\r\n        }\r\n\r\n        description = art(path.join(__dirname, 'templates/hafu.art'), articleBody)();\r\n    } catch {\r\n        description = href;\r\n    }\r\n\r\n    return { articleData, description };\r\n}\r\n\r\nfunction tryGetAttachments(articleData, articleBody, type) {\r\n    if (type === 'ggtz') {\r\n        articleData(`[id^=nattach]`)\r\n            .prev()\r\n            .map((_, item) => {\r\n                const href = articleData(item).attr('href').slice(1);\r\n                const link = typeMap.ggtz.root + href;\r\n                const title = articleData(item).text();\r\n                articleBody += '<br/>';\r\n                articleBody += `<a href=${link}>${title}</a>`;\r\n                return null;\r\n            });\r\n    } else {\r\n        articleData('[id^=nattach]')\r\n            .parent()\r\n            .prev()\r\n            .map((_, item) => {\r\n                const href = articleData(item).find('a').attr('href').slice(1);\r\n                const link = typeMap[type].root + href;\r\n                const title = articleData(item).find('a').find('span').text();\r\n                articleBody += '<br/>';\r\n                articleBody += `<a href=${link}> ${title} </a>`;\r\n                return null;\r\n            });\r\n    }\r\n\r\n    return articleBody;\r\n}\r\n// A. got from hostPage     1.article(link), 2.article(title), 3.(pubDate)\r\n// B. got from articlePage  1.description(fullText), 2.article(author), 3.detailed(pubDate)\r\nasync function ggtzParse(ctx, $) {\r\n    const data = $('a[class=c269582]').parent().slice(0, limit);\r\n    const resultItems = await Promise.all(\r\n        data.toArray().map(async (item) => {\r\n            // .slice(3) for cut out str '../' in original link\r\n            const href = $(item).find('a[class=c269582]').attr('href').slice(3);\r\n            const link = typeMap.ggtz.root + href;\r\n            const title = $(item).find('a[class=c269582]').attr('title');\r\n\r\n            const result = await cache.tryGet(link, async () => {\r\n                const { articleData, description } = await tryGetFullText(href, link, 'ggtz');\r\n                let author = '';\r\n                let pubDate = '';\r\n                if (typeof articleData === 'function') {\r\n                    const header = articleData('h1').next().text();\r\n                    const index = header.indexOf('日期');\r\n\r\n                    author = header.slice(0, index - 2) || '';\r\n\r\n                    const date = header.substring(index + 3, index + 19);\r\n                    pubDate = parseDate(date, 'YYYY-MM-DD HH:mm');\r\n                } else {\r\n                    const date = $(item).find('a[class=c269582_date]').text();\r\n                    pubDate = parseDate(date, 'YYYY-MM-DD');\r\n                }\r\n\r\n                return {\r\n                    title,\r\n                    description,\r\n                    pubDate: timezone(pubDate, +8),\r\n                    link,\r\n                    author,\r\n                };\r\n            });\r\n\r\n            return result;\r\n        })\r\n    );\r\n\r\n    return resultItems;\r\n}\r\n// A. got from hostPage     1.article(link), 2.article(title), 3.(pubDate)\r\n// B. got from articlePage  1.description(fullText), 2.article(author)\r\nasync function jwcParse(ctx, $) {\r\n    const data = $('a[class=c259713]').parent().parent().slice(0, limit);\r\n    const resultItems = await Promise.all(\r\n        data.toArray().map(async (item) => {\r\n            const href = $(item).find('a[class=c259713]').attr('href');\r\n            const link = typeMap.jwc.root + href;\r\n            const title = $(item).find('a[class=c259713]').attr('title');\r\n\r\n            const date = $(item).find('span[class=timestyle259713]').text();\r\n            const pubDate = parseDate(date, 'YYYY/MM/DD');\r\n\r\n            const result = await cache.tryGet(link, async () => {\r\n                const { articleData, description } = await tryGetFullText(href, link, 'jwc');\r\n\r\n                let author = '';\r\n                if (typeof articleData === 'function') {\r\n                    author = articleData('span[class=authorstyle259690]').text();\r\n                }\r\n\r\n                return {\r\n                    title,\r\n                    description,\r\n                    pubDate: timezone(pubDate, +8),\r\n                    link,\r\n                    author: '供稿单位：' + author,\r\n                };\r\n            });\r\n\r\n            return result;\r\n        })\r\n    );\r\n\r\n    return resultItems;\r\n}\r\n// A. got from hostPage     1.article(link), 2.article(title), 3.(pubDate)\r\n// B. got from articlePage  1.description(fullText), 2.detailed(pubDate)\r\nasync function zsjycParse(ctx, $) {\r\n    const data = $('a[class=c127701]').parent().parent().slice(0, limit);\r\n    const resultItems = await Promise.all(\r\n        data.toArray().map(async (item) => {\r\n            const href = $(item).find('a[class=c127701]').attr('href');\r\n            const link = typeMap.zsjyc.root + href;\r\n\r\n            const title = $(item).find('a[class=c127701]').attr('title');\r\n\r\n            const result = await cache.tryGet(link, async () => {\r\n                const { articleData, description } = await tryGetFullText(href, link, 'zsjyc');\r\n\r\n                let pubDate = '';\r\n                if (typeof articleData === 'function') {\r\n                    const date = articleData('span[class=timestyle127702]').text();\r\n                    pubDate = parseDate(date, 'YYYY-MM-DD HH:mm');\r\n                } else {\r\n                    const date = $(item).find('a[class=c269582_date]').text();\r\n                    pubDate = parseDate(date, 'YYYY-MM-DD');\r\n                }\r\n\r\n                return {\r\n                    title,\r\n                    description,\r\n                    pubDate: timezone(pubDate, +8),\r\n                    link,\r\n                    author: '供稿单位：招生就业处',\r\n                };\r\n            });\r\n\r\n            return result;\r\n        })\r\n    );\r\n\r\n    return resultItems;\r\n}\r\n","import { Route } from '@/types';\r\nimport parseList from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/news/:type?',\r\n    categories: ['university'],\r\n    example: '/hafu/news/ggtz',\r\n    parameters: { type: '分类，见下表（默认为 `ggtz`)' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '河南财政金融学院',\r\n    maintainers: [],\r\n    handler,\r\n    description: `| 校内公告通知 | 教务处公告通知 | 招生就业处公告通知 |\r\n| ------------ | -------------- | ------------------ |\r\n| ggtz         | jwc            | zsjyc              |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    // set default router type\r\n    const type = ctx.req.param('type') ?? 'ggtz';\r\n\r\n    const { link, title, resultList } = await parseList(ctx, type);\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        description: '河南财政金融学院 - 公告通知',\r\n        item: resultList,\r\n    };\r\n}\r\n"],"mappings":"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"}