{"version":3,"file":"feed-CKTyLdej.js","names":["route: Route","getToken","cache","got","constants","listName","listAuthor","feed"],"sources":["../../lib/routes/mangadex/mdlist/feed.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport getToken from '../_access';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\nimport constants from '../_constants';\r\nimport { getFilteredLanguages } from '../_profile';\r\nimport { getMangaMetaByIds } from '../_feed';\r\nimport { toQueryString } from '../_utils';\r\n\r\nconst DEFAULT_LIMIT = 25;\r\n\r\nexport const route: Route = {\r\n    name: 'MDList Feed',\r\n    path: '/mdlist/:id/:lang?',\r\n    radar: [\r\n        {\r\n            source: ['mangadex.org/list/:id/:suffix'],\r\n            target: '/mdlist/:id',\r\n        },\r\n    ],\r\n    description: 'Sepcific MangaDex MDList Feed',\r\n    example: '/mangadex/mdlist/10cca803-8dc9-4f0e-86a8-6659a3ce5188?limit=10&private=true',\r\n    maintainers: ['chrisis58'],\r\n    categories: ['anime'],\r\n    parameters: {\r\n        id: {\r\n            description: 'The list id of the manga list',\r\n        },\r\n        private: {\r\n            description: '(Query Param) Needed to access private lists, any value will be treated as true',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'MANGADEX_USERNAME',\r\n                description: 'MangaDex Username, required when refresh-token is not set and the list is private',\r\n                optional: true,\r\n            },\r\n            {\r\n                name: 'MANGADEX_PASSWORD',\r\n                description: 'MangaDex Password, required when refresh-token is not set and the list is private',\r\n                optional: true,\r\n            },\r\n            {\r\n                name: 'MANGADEX_CLIENT_ID',\r\n                description: 'MangaDex Client ID, required when the list is private',\r\n                optional: true,\r\n            },\r\n            {\r\n                name: 'MANGADEX_CLIENT_SECRET',\r\n                description: 'MangaDex Client Secret, required when the list is private',\r\n                optional: true,\r\n            },\r\n            {\r\n                name: 'MANGADEX_REFRESH_TOKEN',\r\n                description: 'MangaDex Refresh Token, required when username and password are not set and the list is private',\r\n                optional: true,\r\n            },\r\n        ],\r\n    },\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { id, lang } = ctx.req.param();\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : DEFAULT_LIMIT;\r\n    const isPrivate = !!ctx.req.query('private');\r\n\r\n    const accessToken = isPrivate ? await getToken() : undefined;\r\n\r\n    const languagesQuery = new Set([...(typeof lang === 'string' ? [lang] : lang || []), ...(await getFilteredLanguages())].filter(Boolean));\r\n\r\n    const { listName, listAuthor } = (await cache.tryGet(\r\n        `mangadex:mdlist-info-${id}`,\r\n        async () => {\r\n            const response = await got.get(\r\n                `${constants.API.BASE}/list/${id}${toQueryString({\r\n                    includes: ['user'],\r\n                })}`,\r\n                {\r\n                    headers: {\r\n                        Authorization: String(isPrivate ? `Bearer ${accessToken}` : ''),\r\n                        'User-Agent': config.trueUA,\r\n                    },\r\n                }\r\n            );\r\n\r\n            const mdlistInfo = response?.data?.data;\r\n            if (!mdlistInfo) {\r\n                throw new Error('Failed to retrieve user follows from MangaDex API.');\r\n            }\r\n\r\n            const listName = mdlistInfo.attributes.name;\r\n            const listAuthor = mdlistInfo.relationships.find((relationship) => relationship.type === 'user')?.attributes.username;\r\n\r\n            return { listName, listAuthor };\r\n        },\r\n        config.cache.contentExpire\r\n    )) as Record<string, any>;\r\n\r\n    const feed = (await cache.tryGet(\r\n        `mangadex:mdlist-feed-${id}`,\r\n        async () => {\r\n            const response = await got.get(\r\n                `${constants.API.BASE}/list/${id}/feed${toQueryString({\r\n                    limit,\r\n                    translatedLanguage: languagesQuery,\r\n                    order: {\r\n                        publishAt: 'desc',\r\n                    },\r\n                })}`,\r\n                {\r\n                    headers: {\r\n                        Authorization: String(isPrivate ? `Bearer ${accessToken}` : ''),\r\n                        'User-Agent': config.trueUA,\r\n                    },\r\n                }\r\n            );\r\n\r\n            const feed = response?.data?.data;\r\n            if (!feed) {\r\n                throw new Error('Failed to retrieve user follows from MangaDex API.');\r\n            }\r\n\r\n            return feed;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    )) as Record<string, any>[];\r\n\r\n    const mangaIds = feed.map((chapter) => chapter?.relationships.find((relationship) => relationship.type === 'manga')?.id);\r\n\r\n    const mangaMetas = await getMangaMetaByIds(mangaIds);\r\n\r\n    return {\r\n        title: `MDList - ${listName} by ${listAuthor}`,\r\n        link: `https://mangadex.org/list/${id}?tab=feed`,\r\n        description: 'The latest updates of all the manga in a sepcific list',\r\n        item: feed.map((chapter) => {\r\n            const mangaId = chapter.relationships.find((relationship) => relationship.type === 'manga')?.id;\r\n            const mangaMeta = mangaMetas.get(mangaId);\r\n            const chapterTitile = [chapter.attributes.volume ? `Vol. ${chapter.attributes.volume}` : null, chapter.attributes.chapter ? `Ch. ${chapter.attributes.chapter}` : null, chapter.attributes.title].filter(Boolean).join(' ');\r\n\r\n            return {\r\n                title: mangaMeta?.title || 'Unknown',\r\n                link: `${constants.API.MANGA_CHAPTERS}${chapter.id}`,\r\n                pubDate: new Date(chapter.attributes.publishAt),\r\n                description: chapterTitile,\r\n                image: mangaMeta?.cover,\r\n            };\r\n        }),\r\n    };\r\n}\r\n"],"mappings":"wfAUA,MAEaA,EAAe,CACxB,KAAM,cACN,KAAM,qBACN,MAAO,CACH,CACI,OAAQ,CAAC,iCACT,OAAQ,gBAGhB,YAAa,gCACb,QAAS,8EACT,YAAa,CAAC,aACd,WAAY,CAAC,SACb,WAAY,CACR,GAAI,CACA,YAAa,iCAEjB,QAAS,CACL,YAAa,oFAGrB,SAAU,CACN,cAAe,CACX,CACI,KAAM,oBACN,YAAa,oFACb,SAAU,IAEd,CACI,KAAM,oBACN,YAAa,oFACb,SAAU,IAEd,CACI,KAAM,qBACN,YAAa,wDACb,SAAU,IAEd,CACI,KAAM,yBACN,YAAa,4DACb,SAAU,IAEd,CACI,KAAM,yBACN,YAAa,kGACb,SAAU,MAItB,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,KAAI,QAAS,EAAI,IAAI,QAEvB,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,GAC3E,EAAY,CAAC,CAAC,EAAI,IAAI,MAAM,WAE5B,EAAc,EAAY,MAAMC,IAAa,IAAA,GAE7C,EAAiB,IAAI,IAAI,CAAC,GAAI,OAAO,GAAS,SAAW,CAAC,GAAQ,GAAQ,GAAK,GAAI,MAAM,KAAyB,OAAO,UAEzH,CAAE,WAAU,cAAgB,MAAMC,EAAM,OAC1C,wBAAwB,IACxB,SAAY,CACR,IAAM,EAAW,MAAMC,EAAI,IACvB,GAAGC,EAAU,IAAI,KAAK,QAAQ,IAAK,EAAc,CAC7C,SAAU,CAAC,YAEf,CACI,QAAS,CACL,cAAe,OAAO,EAAY,UAAU,IAAgB,IAC5D,aAAc,EAAO,UAK3B,EAAa,GAAU,MAAM,KACnC,GAAI,CAAC,EACD,MAAU,MAAM,sDAGpB,IAAMC,EAAW,EAAW,WAAW,KACjCC,EAAa,EAAW,cAAc,KAAM,GAAiB,EAAa,OAAS,SAAS,WAAW,SAE7G,MAAO,CAAE,SAAA,EAAU,WAAA,IAEvB,EAAO,MAAM,eAGX,EAAQ,MAAMJ,EAAM,OACtB,wBAAwB,IACxB,SAAY,CACR,IAAM,EAAW,MAAMC,EAAI,IACvB,GAAGC,EAAU,IAAI,KAAK,QAAQ,EAAG,OAAO,EAAc,CAClD,QACA,mBAAoB,EACpB,MAAO,CACH,UAAW,YAGnB,CACI,QAAS,CACL,cAAe,OAAO,EAAY,UAAU,IAAgB,IAC5D,aAAc,EAAO,UAK3BG,EAAO,GAAU,MAAM,KAC7B,GAAI,CAACA,EACD,MAAU,MAAM,sDAGpB,OAAOA,GAEX,EAAO,MAAM,YACb,IAGE,EAAW,EAAK,IAAK,GAAY,GAAS,cAAc,KAAM,GAAiB,EAAa,OAAS,UAAU,IAE/G,EAAa,MAAM,EAAkB,GAE3C,MAAO,CACH,MAAO,YAAY,EAAS,MAAM,IAClC,KAAM,6BAA6B,EAAG,WACtC,YAAa,yDACb,KAAM,EAAK,IAAK,GAAY,CACxB,IAAM,EAAU,EAAQ,cAAc,KAAM,GAAiB,EAAa,OAAS,UAAU,GACvF,EAAY,EAAW,IAAI,GAC3B,EAAgB,CAAC,EAAQ,WAAW,OAAS,QAAQ,EAAQ,WAAW,SAAW,KAAM,EAAQ,WAAW,QAAU,OAAO,EAAQ,WAAW,UAAY,KAAM,EAAQ,WAAW,OAAO,OAAO,SAAS,KAAK,KAEvN,MAAO,CACH,MAAO,GAAW,OAAS,UAC3B,KAAM,GAAGH,EAAU,IAAI,iBAAiB,EAAQ,KAChD,QAAS,IAAI,KAAK,EAAQ,WAAW,WACrC,YAAa,EACb,MAAO,GAAW"}