{"version":3,"file":"post-BSlB5Kxf.js","names":["route: Route","tid","authorId","pageId","got","$","str"],"sources":["../../lib/routes/nga/post.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport iconv from 'iconv-lite';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/post/:tid/:authorId?',\r\n    categories: ['bbs'],\r\n    example: '/nga/post/18449558',\r\n    parameters: { tid: '帖子 id, 可在帖子 URL 找到', authorId: '作者 id' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '帖子',\r\n    maintainers: ['xyqfer', 'syrinka'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const getPageUrl = (tid, authorId, page = 1, hash = '') => `https://nga.178.com/read.php?tid=${tid}&page=${page}${authorId ? `&authorid=${authorId}` : ''}&rand=${Math.random() * 1000}#${hash}`;\r\n    const getPage = async (tid, authorId, pageId = 1) => {\r\n        const link = getPageUrl(tid, authorId, pageId);\r\n        const timestamp = Math.floor(Date.now() / 1000);\r\n        let cookieString = `guestJs=${timestamp};`;\r\n        if (config.nga.uid && config.nga.cid) {\r\n            cookieString = `ngaPassportUid=${config.nga.uid}; ngaPassportCid=${config.nga.cid};`;\r\n        }\r\n        const response = await got(link, {\r\n            responseType: 'buffer',\r\n            headers: {\r\n                Cookie: cookieString,\r\n            },\r\n        });\r\n\r\n        const htmlString = iconv.decode(response.data, 'gbk');\r\n        return load(htmlString);\r\n    };\r\n\r\n    const getLastPageId = async (tid, authorId) => {\r\n        const $ = await getPage(tid, authorId);\r\n        const nav = $('#pagebtop');\r\n        const match = nav.html().match(/{0:'\\/read\\.php\\?tid=(\\d+).*?',1:(\\d+),.*?}/);\r\n        return match ? match[2] : 1;\r\n    };\r\n\r\n    const deepReplace = (str, pattern, replace) => {\r\n        // 对于可能存在嵌套的样式一路 replace 到最深处\r\n        while (pattern.test(str)) {\r\n            str = str.replace(pattern, replace);\r\n        }\r\n        return str;\r\n    };\r\n\r\n    const formatContent = (str) => {\r\n        // 简单样式\r\n        str = deepReplace(str, /\\[(b|u|i|del|code|sub|sup)](.+?)\\[\\/\\1]/g, '<$1>$2</$1>');\r\n        str = str\r\n            .replaceAll(/\\[dice](.+?)\\[\\/dice]/g, '<b>ROLL : $1</b>')\r\n            .replaceAll(/\\[color=(.+?)](.+?)\\[\\/color]/g, '<span style=\"color:$1;\">$2</span>')\r\n            .replaceAll(/\\[font=(.+?)](.+?)\\[\\/font]/g, '<span style=\"font-family:$1;\">$2</span>')\r\n            .replaceAll(/\\[size=(.+?)](.+?)\\[\\/size]/g, '<span style=\"font-size:$1;\">$2</span>')\r\n            .replaceAll(/\\[align=(.+?)](.+?)\\[\\/align]/g, '<span style=\"text-align:$1;\">$2</span>');\r\n        // 列表\r\n        str = deepReplace(str, /\\[\\*](.+?)(?=\\[\\*]|\\[\\/list])/g, '<li>$1</li>');\r\n        str = deepReplace(str, /\\[list](.+?)\\[\\/list]/g, '<ul>$1</ul>');\r\n        // 图片\r\n        str = str.replaceAll(/\\[img](.+?)\\[\\/img]/g, (m, src) => `<img src='${src[0] === '.' ? 'https://img.nga.178.com/attachments' + src.slice(1) : src}'></img>`);\r\n        // 折叠\r\n        str = deepReplace(str, /\\[collapse(?:=(.+?))?](.+?)\\[\\/collapse]/g, '<details><summary>$1</summary>$2</details>');\r\n        // 引用\r\n        str = deepReplace(str, /\\[quote](.+?)\\[\\/quote]/g, '<blockquote>$1</blockquote>')\r\n            .replaceAll(/\\[@(.+?)]/g, '<a href=\"https://nga.178.com/nuke.php?func=ucp&username=$1\">@$1</a>')\r\n            .replaceAll(/\\[uid=(\\d+)](.+?)\\[\\/uid]/g, '<a href=\"https://nga.178.com/nuke.php?func=ucp&uid=$1\">@$2</a>')\r\n            .replaceAll(/\\[tid=(\\d+)](.+?)\\[\\/tid]/g, '<a href=\"https://nga.178.com/read.php?tid=$1\">$2</a>')\r\n            .replaceAll(/\\[pid=(\\d+),(\\d+),(\\d+)](.+?)\\[\\/pid]/g, (m, pid, tid, page, str) => {\r\n                const url = `https://nga.178.com/read.php?tid=${tid}&page=${page}#pid${pid}Anchor`;\r\n                return `<a href=\"${url}\">${str}</a>`;\r\n            });\r\n        // 链接\r\n        str = str.replaceAll(/\\[url=(.+?)](.+?)\\[\\/url]/g, '<a href=\"$1\">$2</a>');\r\n        // 分割线\r\n        str = str.replaceAll(/\\[h](.+?)\\[\\/h]/g, '<h4 style=\"font-size:1.17em;font-weight:bold;border-bottom:1px solid #aaa;clear:both;margin:1.33em 0 0.2em 0;\">$1</h4>');\r\n        return str;\r\n    };\r\n\r\n    const tid = ctx.req.param('tid');\r\n    const authorId = ctx.req.param('authorId') || undefined;\r\n    const pageId = await getLastPageId(tid, authorId);\r\n\r\n    const $ = await getPage(tid, authorId, pageId);\r\n    const title = $('title').text() || '';\r\n    const posterMap = JSON.parse(\r\n        $('script')\r\n            .text()\r\n            .match(/commonui\\.userInfo\\.setAll\\((.*)\\)$/m)[1]\r\n    );\r\n    const authorName = authorId ? posterMap[authorId].username : undefined;\r\n\r\n    const items = $('#m_posts_c')\r\n        .children()\r\n        .filter('table')\r\n        .toArray()\r\n        .map((post_) => {\r\n            const post = $(post_);\r\n            const posterId = post\r\n                .find('.posterinfo a')\r\n                .first()\r\n                .attr('href')\r\n                .match(/&uid=(-?\\d+)$/)[1];\r\n            const poster = authorName || posterMap[posterId].username;\r\n            const content = post.find('.postcontent').first();\r\n            const description = formatContent(content.html());\r\n            const postId = content.attr('id');\r\n            const link = getPageUrl(tid, authorId, pageId, postId);\r\n            const pubDate = timezone(parseDate(post.find('.postInfo > span').first().text(), 'YYYY-MM-DD HH:mm'), +8);\r\n\r\n            return {\r\n                title: load(description).text(),\r\n                author: poster,\r\n                link,\r\n                description,\r\n                pubDate,\r\n                guid: postId,\r\n            };\r\n        });\r\n\r\n    const rssTitle = authorName ? `NGA ${authorName} ${title}` : `NGA ${title}`;\r\n\r\n    return {\r\n        title: rssTitle,\r\n        link: getPageUrl(tid, authorId, pageId),\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}