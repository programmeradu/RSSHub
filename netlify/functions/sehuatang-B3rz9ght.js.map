{"version":3,"file":"sehuatang-B3rz9ght.js","names":["route: Route","cache","ofetch","response","$"],"sources":["../../lib/routes/sehuatang/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { config } from '@/config';\r\n\r\nconst host = 'https://www.sehuatang.net/';\r\n\r\nconst forumIdMaps = {\r\n    // 原创 BT 电影\r\n    gcyc: '2', //     国产原创\r\n    yzwmyc: '36', //  亚洲无码原创\r\n    yzymyc: '37', //  亚洲有码原创\r\n    gqzwzm: '103', // 高清中文字幕\r\n    sjxz: '107', //   三级写真\r\n    vr: '160', //     VR 视频\r\n    srym: '104', //   素人有码\r\n    omwm: '38', //    欧美无码\r\n    '4k': '151', //   4K 原版\r\n    hgzb: '152', //   韩国主播\r\n    dmyc: '39', //    动漫原创\r\n    // 色花图片\r\n    yczp: '155', //   原创自拍\r\n    ztzp: '125', //   转贴自拍\r\n    hrjp: '50', //    华人街拍\r\n    yzxa: '48', //    亚洲性爱\r\n    omxa: '49', //    欧美性爱\r\n    ktdm: '117', //   卡通动漫\r\n    ttxz: '165', //   套图下载\r\n\r\n    zhtl: '95', //    综合讨论\r\n    // no longer updated/available\r\n    mrhj: '106', //   每日合集\r\n    ai: '113', //     AI 换脸电影\r\n    ydsc: '111', //   原档收藏 WMV\r\n    hrxazp: '98', //  华人性爱自拍\r\n};\r\n\r\nexport const route: Route = {\r\n    path: ['/bt/:subforumid?', '/picture/:subforumid', '/:subforumid?/:type?', '/:subforumid?', ''],\r\n    name: 'Forum',\r\n    maintainers: ['qiwihui', 'junfengP', 'nczitzk'],\r\n    handler,\r\n    features: {\r\n        nsfw: true,\r\n    },\r\n    description: `**原创 BT 电影**\r\n\r\n| 国产原创 | 亚洲无码原创 | 亚洲有码原创 | 高清中文字幕 | 三级写真 | VR 视频 | 素人有码 | 欧美无码 | 韩国主播 | 动漫原创 | 综合讨论 |\r\n| -------- | ------------ | ------------ | ------------ | -------- | ------- | -------- | -------- | -------- | -------- | -------- |\r\n| gcyc     | yzwmyc       | yzymyc       | gqzwzm       | sjxz     | vr      | srym     | omwm     | hgzb     | dmyc     | zhtl     |\r\n\r\n  **色花图片**\r\n\r\n| 原创自拍 | 转贴自拍 | 华人街拍 | 亚洲性爱 | 欧美性爱 | 卡通动漫 | 套图下载 |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| yczp     | ztzp     | hrjp     | yzxa     | omxa     | ktdm     | ttxz     |`,\r\n};\r\n\r\nconst getSafeId = () =>\r\n    cache.tryGet(\r\n        'sehuatang:safeid',\r\n        async () => {\r\n            const response = await ofetch(host);\r\n            const $ = load(response);\r\n            const safeId = $('script:contains(\"safeid\")')\r\n                .text()\r\n                .match(/safeid\\s*=\\s*'(.+)';/)?.[1];\r\n            return safeId;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\nasync function handler(ctx) {\r\n    const subformName = ctx.req.param('subforumid') ?? 'gqzwzm';\r\n    const subformId = subformName in forumIdMaps ? forumIdMaps[subformName] : subformName;\r\n    const type = ctx.req.param('type');\r\n    const typefilter = type ? `&filter=typeid&typeid=${type}` : '';\r\n    const link = `${host}forum.php?mod=forumdisplay&orderby=dateline&fid=${subformId}${typefilter}`;\r\n    const headers = {\r\n        Cookie: `_safe=${await getSafeId()};`,\r\n    };\r\n\r\n    const response = await ofetch(link, {\r\n        headers,\r\n    });\r\n    const $ = load(response);\r\n\r\n    const list = $('#threadlisttableid tbody[id^=normalthread]')\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 25)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            const hasCategory = item.find('th em a').length;\r\n            return {\r\n                title: `${hasCategory ? `[${item.find('th em a').text()}]` : ''} ${item.find('a.xst').text()}`,\r\n                link: host + item.find('a.xst').attr('href'),\r\n                pubDate: parseDate(item.find('td.by').find('em span span').attr('title')),\r\n                author: item.find('td.by cite a').first().text(),\r\n            };\r\n        });\r\n\r\n    const out = await Promise.all(\r\n        list.map((info) =>\r\n            cache.tryGet(info.link, async () => {\r\n                const response = await ofetch(info.link, {\r\n                    headers,\r\n                });\r\n\r\n                const $ = load(response);\r\n                const postMessage = $('div[id^=\"postmessage\"], td[id^=\"postmessage\"]').slice(0, 1);\r\n                const images = $(postMessage).find('img');\r\n                for (const image of images) {\r\n                    const file = $(image).attr('file');\r\n                    if (!file || file === 'undefined') {\r\n                        $(image).replaceWith('');\r\n                    } else {\r\n                        $(image).replaceWith($(`<img src=\"${file}\">`));\r\n                    }\r\n                }\r\n                // also parse image url from `.pattl`\r\n                const pattl = $('.pattl');\r\n                const pattlImages = $(pattl).find('img');\r\n                for (const pattlImage of pattlImages) {\r\n                    const file = $(pattlImage).attr('file');\r\n                    if (!file || file === 'undefined') {\r\n                        $(pattlImage).replaceWith('');\r\n                    } else {\r\n                        $(pattlImage).replaceWith($(`<img src=\"${file}\" />`));\r\n                    }\r\n                }\r\n                postMessage.append($(pattl));\r\n                $('em[onclick]').remove();\r\n\r\n                info.description = (postMessage.html() || '抓取原帖失败').replaceAll('ignore_js_op', 'div');\r\n                info.pubDate = timezone(parseDate($('.authi em span').attr('title')), 8);\r\n\r\n                const magnet = postMessage.find('div.blockcode li').first().text();\r\n                const isMag = magnet.startsWith('magnet');\r\n                const torrent = postMessage.find('p.attnm a').attr('href');\r\n\r\n                const hasEnclosureUrl = isMag || torrent !== undefined;\r\n                if (hasEnclosureUrl) {\r\n                    const enclosureUrl = isMag ? magnet : new URL(torrent, host).href;\r\n                    info.enclosure_url = enclosureUrl;\r\n                    info.enclosure_type = isMag ? 'application/x-bittorrent' : 'application/octet-stream';\r\n                }\r\n\r\n                return info;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `色花堂 - ${$('#pt > div:nth-child(1) > a:last-child').text()}`,\r\n        link,\r\n        item: out,\r\n    };\r\n}\r\n"],"mappings":"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"}