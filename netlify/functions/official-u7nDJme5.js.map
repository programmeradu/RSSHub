{"version":3,"file":"official-u7nDJme5.js","names":[],"sources":["../../lib/routes/mihoyo/bbs/official.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport logger from '@/utils/logger';\r\n\r\n// 游戏id\r\nconst GITS_MAP = {\r\n    1: '崩坏三',\r\n    2: '原神',\r\n    3: '崩坏二',\r\n    4: '未定事件簿',\r\n    6: '崩坏：星穹铁道',\r\n    8: '绝区零',\r\n};\r\n\r\n// 公告类型\r\nconst TYPE_MAP = {\r\n    1: '公告',\r\n    2: '活动',\r\n    3: '资讯',\r\n};\r\n\r\n// 游戏缩写\r\nconst GAME_SHORT_MAP = {\r\n    1: 'bh3',\r\n    2: 'ys',\r\n    3: 'bh2',\r\n    4: 'wd',\r\n    6: 'sr',\r\n    8: 'zzz',\r\n};\r\n// 游戏官方页所属分区\r\nconst OFFICIAL_PAGE_MAP = {\r\n    1: '6',\r\n    2: '28',\r\n    3: '31',\r\n    4: '33',\r\n    6: '53',\r\n    8: '58',\r\n};\r\n\r\nclass MiHoYoOfficialError extends Error {\r\n    constructor(message) {\r\n        super(message);\r\n        this.name = 'MiHoYoOfficialError';\r\n    }\r\n}\r\n\r\nconst getNewsList = async ({ gids, type, page_size, last_id }) => {\r\n    const query = new URLSearchParams({\r\n        client_type: '4',\r\n        gids,\r\n        type,\r\n        page_size,\r\n        last_id,\r\n    }).toString();\r\n    const url = `https://bbs-api-static.miyoushe.com/painter/wapi/getNewsList?${query}`;\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n    });\r\n    const list = response?.data?.data?.list;\r\n    return list;\r\n};\r\n\r\nconst getPostContent = async (row, default_gid = '2') => {\r\n    const post = row.post;\r\n    const post_id = post.post_id;\r\n    const query = new URLSearchParams({\r\n        post_id,\r\n    }).toString();\r\n    const url = `https://bbs-api.miyoushe.com/post/wapi/getPostFull?${query}`;\r\n    return await cache.tryGet(url, async () => {\r\n        const res = await got(url);\r\n        const fullRow = res?.data?.data?.post;\r\n        if (!fullRow) {\r\n            // throw an error to prevent an empty item from being cached and returned\r\n            throw new MiHoYoOfficialError(`mihoyo/bbs/official: getPostContent failed: ${url} - ${JSON.stringify(res)}`);\r\n        }\r\n        // default_gid should be useless since the above error-throwing line, but just in case\r\n        const gid = fullRow?.post?.game_id || default_gid;\r\n        const author = fullRow?.user?.nickname || '';\r\n        const content = fullRow?.post?.content || '';\r\n        const tags = fullRow?.topics?.map((item) => item.name) || [];\r\n        const description = art(path.join(__dirname, '../templates/official.art'), {\r\n            hasCover: post.has_cover,\r\n            coverList: row.cover_list,\r\n            content,\r\n        });\r\n        return {\r\n            // 文章标题\r\n            title: post.subject,\r\n            // 文章链接\r\n            link: `https://www.miyoushe.com/${GAME_SHORT_MAP[gid]}/article/${post_id}`,\r\n            // 文章正文\r\n            description,\r\n            // 文章发布日期\r\n            pubDate: parseDate(post.created_at * 1000),\r\n            // 文章标签\r\n            category: tags,\r\n            author,\r\n        };\r\n    });\r\n};\r\n\r\nconst getPostContents = (list, default_gid = '2') =>\r\n    Promise.all(\r\n        list.map((item) =>\r\n            getPostContent(item, default_gid).catch((error) => {\r\n                if (error instanceof MiHoYoOfficialError) {\r\n                    logger.error(error.message);\r\n                    return null; // skip it now and pray that it will be available next time\r\n                }\r\n                throw error;\r\n            })\r\n        )\r\n    ).then((items) => items.filter(Boolean));\r\n\r\nexport const route: Route = {\r\n    path: '/bbs/official/:gids/:type?/:page_size?/:last_id?',\r\n    categories: ['game'],\r\n    example: '/mihoyo/bbs/official/2/3/20/',\r\n    parameters: { gids: '游戏id', type: '公告类型，默认为 2(即 活动)', page_size: '分页大小，默认为 20 ', last_id: '跳过的公告数，例如指定为 40 就是从第 40 条公告开始，可用于分页' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '米游社 - 官方公告',\r\n    maintainers: ['CaoMeiYouRen'],\r\n    handler,\r\n    description: `游戏 id\r\n\r\n| 崩坏三 | 原神 | 崩坏二 | 未定事件簿 | 星穹铁道 | 绝区零 |\r\n| ------ | ---- | ------ | ---------- | -------- | ------ |\r\n| 1      | 2    | 3      | 4          | 6        | 8      |\r\n\r\n  公告类型\r\n\r\n| 公告 | 活动 | 资讯 |\r\n| ---- | ---- | ---- |\r\n| 1    | 2    | 3    |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { gids, type = '2', page_size = '20', last_id = '' } = ctx.req.param();\r\n\r\n    const list = await getNewsList({ gids, type, page_size, last_id });\r\n    const items = await getPostContents(list, gids);\r\n    const title = `米游社 - ${GITS_MAP[gids] || ''} - ${TYPE_MAP[type] || ''}`;\r\n    const url = `https://www.miyoushe.com/${GAME_SHORT_MAP[gids]}/home/${OFFICIAL_PAGE_MAP[gids]}?type=${type}`;\r\n    const data = {\r\n        title,\r\n        link: url,\r\n        item: items,\r\n    };\r\n\r\n    return data;\r\n}\r\n"],"mappings":"kdASA,MAAM,EAAW,CACb,EAAG,MACH,EAAG,KACH,EAAG,MACH,EAAG,QACH,EAAG,UACH,EAAG,OAID,EAAW,CACb,EAAG,KACH,EAAG,KACH,EAAG,MAID,EAAiB,CACnB,EAAG,MACH,EAAG,KACH,EAAG,MACH,EAAG,KACH,EAAG,KACH,EAAG,OAGD,EAAoB,CACtB,EAAG,IACH,EAAG,KACH,EAAG,KACH,EAAG,KACH,EAAG,KACH,EAAG,MAGP,IAAM,EAAN,cAAkC,KAAM,CACpC,YAAY,EAAS,CACjB,MAAM,GACN,KAAK,KAAO,wBAIpB,MAAM,EAAc,MAAO,CAAE,OAAM,OAAM,YAAW,aAAc,CAC9D,IAAM,EAAQ,IAAI,gBAAgB,CAC9B,YAAa,IACb,OACA,OACA,YACA,YACD,WACG,EAAM,gEAAgE,IACtE,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,QAEE,EAAO,GAAU,MAAM,MAAM,KACnC,OAAO,GAGL,EAAiB,MAAO,EAAK,EAAc,MAAQ,CACrD,IAAM,EAAO,EAAI,KACX,EAAU,EAAK,QACf,EAAQ,IAAI,gBAAgB,CAC9B,YACD,WACG,EAAM,sDAAsD,IAClE,OAAO,MAAM,EAAM,OAAO,EAAK,SAAY,CACvC,IAAM,EAAM,MAAM,EAAI,GAChB,EAAU,GAAK,MAAM,MAAM,KACjC,GAAI,CAAC,EAED,MAAM,IAAI,EAAoB,+CAA+C,EAAI,KAAK,KAAK,UAAU,MAGzG,IAAM,EAAM,GAAS,MAAM,SAAW,EAChC,EAAS,GAAS,MAAM,UAAY,GACpC,EAAU,GAAS,MAAM,SAAW,GACpC,EAAO,GAAS,QAAQ,IAAK,GAAS,EAAK,OAAS,GACpD,EAAc,EAAI,EAAA,KAAA,EAAA,mCAAmD,CACvE,SAAU,EAAK,UACf,UAAW,EAAI,WACf,YAEJ,MAAO,CAEH,MAAO,EAAK,QAEZ,KAAM,4BAA4B,EAAe,GAAK,WAAW,IAEjE,cAEA,QAAS,EAAU,EAAK,WAAa,KAErC,SAAU,EACV,aAKN,GAAmB,EAAM,EAAc,MACzC,QAAQ,IACJ,EAAK,IAAK,GACN,EAAe,EAAM,GAAa,MAAO,GAAU,CAC/C,GAAI,aAAiB,EAEjB,OADA,EAAO,MAAM,EAAM,SACZ,KAEX,MAAM,MAGhB,KAAM,GAAU,EAAM,OAAO,UAEtB,EAAe,CACxB,KAAM,mDACN,WAAY,CAAC,QACb,QAAS,+BACT,WAAY,CAAE,KAAM,OAAQ,KAAM,mBAAoB,UAAW,eAAgB,QAAS,uCAC1F,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,aACN,YAAa,CAAC,gBACd,UACA,YAAa;;;;;;;;;;yBAajB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAM,OAAO,IAAK,YAAY,KAAM,UAAU,IAAO,EAAI,IAAI,QAE/D,EAAO,MAAM,EAAY,CAAE,OAAM,OAAM,YAAW,YAClD,EAAQ,MAAM,EAAgB,EAAM,GACpC,EAAQ,SAAS,EAAS,IAAS,GAAG,KAAK,EAAS,IAAS,KAC7D,EAAM,4BAA4B,EAAe,GAAM,QAAQ,EAAkB,GAAM,QAAQ,IAC/F,EAAO,CACT,QACA,KAAM,EACN,KAAM,GAGV,OAAO"}