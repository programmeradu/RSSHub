{"version":3,"file":"uraaka-joshi-user-DlOsEQO0.js","names":["route: Route","cache","puppeteer","link"],"sources":["../../lib/routes/uraaka-joshi/uraaka-joshi-user.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nexport const route: Route = {\r\n    path: '/:id',\r\n    categories: ['other'],\r\n    example: '/uraaka-joshi/_rrwq',\r\n    parameters: { id: 'User ID' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['uraaka-joshi.com/:id'],\r\n        },\r\n    ],\r\n    name: 'User',\r\n    maintainers: ['SettingDust', 'Halcao'],\r\n    handler,\r\n    url: 'uraaka-joshi.com/',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const link = `https://www.uraaka-joshi.com/user/${id}`;\r\n\r\n    const response = await cache.tryGet(\r\n        link,\r\n        async () => {\r\n            const browser = await puppeteer();\r\n            const page = await browser.newPage();\r\n            await page.setRequestInterception(true);\r\n            page.on('request', (request) => {\r\n                request.resourceType() === 'document' || request.resourceType() === 'script' || request.resourceType() === 'fetch' ? request.continue() : request.abort();\r\n            });\r\n            page.on('requestfinished', async (request) => {\r\n                if (request.url() === link && request.response().status() === 403) {\r\n                    await page.close();\r\n                }\r\n            });\r\n\r\n            let html = '';\r\n            try {\r\n                await page.goto(link, {\r\n                    waitUntil: 'domcontentloaded',\r\n                });\r\n                await page.waitForSelector('#pickup03 .grid-cell');\r\n                await page.waitForSelector('#pickup04 .grid-cell');\r\n                await page.waitForSelector('#main-block .grid-cell');\r\n\r\n                html = await page.evaluate(() => document.documentElement.innerHTML);\r\n            } catch {\r\n                throw new Error('Access denied (403)');\r\n            }\r\n            await browser.close();\r\n            return html;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const $ = load(response);\r\n    const items = $('#main-block .grid .grid-cell')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            // remove event and styles\r\n            item.find('*').removeAttr('onclick');\r\n            item.find('*').removeAttr('onerror');\r\n            item.find('*').removeAttr('style');\r\n\r\n            // format account style\r\n            const account = item.find('.account-group-link-row');\r\n            account.html(account.text());\r\n\r\n            // extract video tag from its player\r\n            item.find('.plyr--video').each((_, player) => {\r\n                player = $(player);\r\n\r\n                const v = player.find('video');\r\n                player.replaceWith(v);\r\n                v.attr('poster', 'https:' + v.attr('data-poster'));\r\n                v.find('source').attr('src', 'https:' + v.find('source').attr('src'));\r\n            });\r\n\r\n            // correct src of img tags\r\n            item.find('img').each((_, i) => {\r\n                i = $(i);\r\n                i.attr('src', 'https:' + i.attr('data-src').split('?resize')[0]);\r\n                i.removeAttr('data-src');\r\n            });\r\n\r\n            const author = item.find('.account-group').text();\r\n            const categories = item\r\n                .find('.hashtag-item .hashtag')\r\n                .toArray()\r\n                .map((c) => $(c).text().trim());\r\n            const link = item.find('.account-group-link-row').attr('href');\r\n            const date = parseDate(item.find('.profile-char').attr('datetime'));\r\n            const guid = item.find('a.tap-image').attr('data-tweet-id') || item.find('video[class^=\"js-player-\"]').attr('data-tweet-id');\r\n\r\n            item.find('.grow-room').remove();\r\n            item.find('div.profile-group.mt10.prl2').eq(1).remove();\r\n\r\n            return {\r\n                title: item.find('.profile-text').text(),\r\n                description: item.html(),\r\n                link,\r\n                pubDate: date,\r\n                guid,\r\n                category: categories,\r\n                author,\r\n            };\r\n        });\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        description: $('meta[name=\"description\"]').attr('content'),\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"2SAOA,MAAaA,EAAe,CACxB,KAAM,OACN,WAAY,CAAC,SACb,QAAS,sBACT,WAAY,CAAE,GAAI,WAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,0BAGjB,KAAM,OACN,YAAa,CAAC,cAAe,UAC7B,UACA,IAAK,qBAGT,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAO,qCAAqC,IAE5C,EAAW,MAAMC,EAAM,OACzB,EACA,SAAY,CACR,IAAM,EAAU,MAAMC,IAChB,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,UAAY,EAAQ,iBAAmB,QAAU,EAAQ,WAAa,EAAQ,UAEtJ,EAAK,GAAG,kBAAmB,KAAO,IAAY,CACtC,EAAQ,QAAU,GAAQ,EAAQ,WAAW,WAAa,KAC1D,MAAM,EAAK,UAInB,IAAI,EAAO,GACX,GAAI,CACA,MAAM,EAAK,KAAK,EAAM,CAClB,UAAW,qBAEf,MAAM,EAAK,gBAAgB,wBAC3B,MAAM,EAAK,gBAAgB,wBAC3B,MAAM,EAAK,gBAAgB,0BAE3B,EAAO,MAAM,EAAK,aAAe,SAAS,gBAAgB,gBACtD,CACJ,MAAU,MAAM,uBAGpB,OADA,MAAM,EAAQ,QACP,GAEX,EAAO,MAAM,YACb,IAGE,EAAI,EAAK,GACT,EAAQ,EAAE,gCACX,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAGT,EAAK,KAAK,KAAK,WAAW,WAC1B,EAAK,KAAK,KAAK,WAAW,WAC1B,EAAK,KAAK,KAAK,WAAW,SAG1B,IAAM,EAAU,EAAK,KAAK,2BAC1B,EAAQ,KAAK,EAAQ,QAGrB,EAAK,KAAK,gBAAgB,MAAM,EAAG,IAAW,CAC1C,EAAS,EAAE,GAEX,IAAM,EAAI,EAAO,KAAK,SACtB,EAAO,YAAY,GACnB,EAAE,KAAK,SAAU,SAAW,EAAE,KAAK,gBACnC,EAAE,KAAK,UAAU,KAAK,MAAO,SAAW,EAAE,KAAK,UAAU,KAAK,UAIlE,EAAK,KAAK,OAAO,MAAM,EAAG,IAAM,CAC5B,EAAI,EAAE,GACN,EAAE,KAAK,MAAO,SAAW,EAAE,KAAK,YAAY,MAAM,WAAW,IAC7D,EAAE,WAAW,cAGjB,IAAM,EAAS,EAAK,KAAK,kBAAkB,OACrC,EAAa,EACd,KAAK,0BACL,UACA,IAAK,GAAM,EAAE,GAAG,OAAO,QACtBC,EAAO,EAAK,KAAK,2BAA2B,KAAK,QACjD,EAAO,EAAU,EAAK,KAAK,iBAAiB,KAAK,aACjD,EAAO,EAAK,KAAK,eAAe,KAAK,kBAAoB,EAAK,KAAK,8BAA8B,KAAK,iBAK5G,OAHA,EAAK,KAAK,cAAc,SACxB,EAAK,KAAK,+BAA+B,GAAG,GAAG,SAExC,CACH,MAAO,EAAK,KAAK,iBAAiB,OAClC,YAAa,EAAK,OAClB,KAAA,EACA,QAAS,EACT,OACA,SAAU,EACV,YAIZ,MAAO,CACH,MAAO,EAAE,SAAS,OAClB,YAAa,EAAE,4BAA4B,KAAK,WAChD,OACA,KAAM"}