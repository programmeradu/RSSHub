{"version":3,"file":"javbus-fpuhqVNi.js","names":[],"sources":["../../lib/routes/javbus/index.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport { getSubPath } from '@/utils/common-utils';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nconst toSize = (raw) => {\r\n    const matches = raw.match(/(\\d+(\\.\\d+)?)(\\w+)/);\r\n    return matches[3] === 'GB' ? matches[1] * 1024 : matches[1];\r\n};\r\n\r\nconst allowDomain = new Set(['javbus.com', 'javbus.org', 'javsee.icu', 'javsee.one']);\r\n\r\nexport const route: Route = {\r\n    path: '/:path{.+}?',\r\n    radar: [\r\n        {\r\n            source: ['www.javbus.com/:path*'],\r\n            target: '/:path',\r\n        },\r\n    ],\r\n    name: 'Works',\r\n    maintainers: ['MegrezZhu', 'CoderTonyChan', 'nczitzk', 'Felix2yu'],\r\n    categories: ['multimedia'],\r\n    view: ViewType.Videos,\r\n    handler,\r\n    url: 'www.javbus.com',\r\n    example: '/javbus/star/rwt',\r\n    parameters: {\r\n        path: {\r\n            description: 'Any path of list page on javbus',\r\n        },\r\n    },\r\n    features: {\r\n        nsfw: true,\r\n    },\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const isWestern = /^\\/western/.test(getSubPath(ctx));\r\n    const domain = ctx.req.query('domain') ?? 'javbus.com';\r\n    const westernDomain = ctx.req.query('western_domain') ?? 'javbus.org';\r\n\r\n    const rootUrl = `https://www.${domain}`;\r\n    const westernUrl = `https://www.${westernDomain}`;\r\n\r\n    if (!config.feature.allow_user_supply_unsafe_domain && (!allowDomain.has(new URL(`https://${domain}/`).hostname) || !allowDomain.has(new URL(`https://${westernDomain}/`).hostname))) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n\r\n    const currentUrl = `${isWestern ? westernUrl : rootUrl}${getSubPath(ctx)\r\n        .replace(/^\\/western/, '')\r\n        .replace(/\\/home/, '')}`;\r\n\r\n    const headers = {\r\n        'accept-language': 'zh-CN',\r\n    };\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n        headers,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    let items = $('.movie-box')\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 50)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                link: item.attr('href'),\r\n                guid: item.find('date').first().text(),\r\n                pubDate: parseDate(item.find('date').last().text()),\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                    headers,\r\n                });\r\n\r\n                const content = load(detailResponse.data);\r\n\r\n                content('.genre').last().parent().remove();\r\n                content('input[type=\"checkbox\"], button').remove();\r\n\r\n                const stars = content('.avatar-box span')\r\n                    .toArray()\r\n                    .map((s) => content(s).text());\r\n\r\n                const cacheIn = {\r\n                    author: stars.join(', '),\r\n                    title: content('h3').text(),\r\n                    category: [\r\n                        ...content('.genre label')\r\n                            .toArray()\r\n                            .map((c) => content(c).text()),\r\n                        ...stars,\r\n                    ],\r\n                    info: content('.row.movie').html(),\r\n                    thumbs: content('.sample-box')\r\n                        .toArray()\r\n                        .map((i) => {\r\n                            const thumbSrc = content(i).attr('href');\r\n                            return thumbSrc.startsWith('http') ? thumbSrc : `${rootUrl}${thumbSrc}`;\r\n                        }),\r\n                };\r\n\r\n                let magnets, videoSrc, videoPreview;\r\n\r\n                // To fetch magnets.\r\n\r\n                try {\r\n                    const matches = detailResponse.data.match(/var gid = (\\d+);[\\S\\s]*var uc = (\\d+);[\\S\\s]*var img = '(.*)';/);\r\n\r\n                    const magnetResponse = await got({\r\n                        method: 'get',\r\n                        url: `${rootUrl}/ajax/uncledatoolsbyajax.php`,\r\n                        searchParams: {\r\n                            gid: matches[1],\r\n                            lang: 'zh',\r\n                            img: matches[3],\r\n                            uc: matches[2],\r\n                            floor: 800,\r\n                        },\r\n                        headers: {\r\n                            Referer: item.link,\r\n                        },\r\n                    });\r\n\r\n                    const content = load(`<table>${magnetResponse.data}</table>`);\r\n\r\n                    magnets = content('tr')\r\n                        .toArray()\r\n                        .map((tr) => {\r\n                            const td = content(tr).find('a[href]');\r\n\r\n                            return {\r\n                                title: td.first().text().trim(),\r\n                                link: td.first().attr('href'),\r\n                                size: td.eq(1).text().trim(),\r\n                                date: td.last().text().trim(),\r\n                                score: content(tr).find('a').length ** 8 * toSize(td.eq(1).text().trim()),\r\n                            };\r\n                        });\r\n\r\n                    if (magnets) {\r\n                        item.enclosure_url = magnets.sort((a, b) => b.score - a.score)[0].link;\r\n                        item.enclosure_type = 'application/x-bittorrent';\r\n                    }\r\n                } catch {\r\n                    // no-empty\r\n                }\r\n\r\n                // If the video is not western, go fetch preview.\r\n\r\n                if (!isWestern) {\r\n                    try {\r\n                        const avgleResponse = await got({\r\n                            method: 'get',\r\n                            url: `https://api.avgle.com/v1/jav/${item.guid}/0`,\r\n                        });\r\n\r\n                        // full video\r\n                        videoSrc = avgleResponse.data.response.videos[0]?.embedded_url ?? '';\r\n                        // video preview\r\n                        videoPreview = avgleResponse.data.response.videos[0]?.preview_video_url ?? '';\r\n                    } catch {\r\n                        // no-empty\r\n                    }\r\n                }\r\n\r\n                item.author = cacheIn.author;\r\n                item.title = cacheIn.title;\r\n                item.category = cacheIn.category;\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    info: cacheIn.info,\r\n                    thumbs: cacheIn.thumbs,\r\n                    magnets,\r\n                    videoSrc,\r\n                    videoPreview,\r\n                });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const title = $('head title').text();\r\n\r\n    return {\r\n        title: `${title.startsWith('JavBus') ? '' : 'JavBus - '}${title.replace(/ - AV磁力連結分享/, '')}`,\r\n        link: currentUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"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"}