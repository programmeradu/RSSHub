import{config as e}from"./config-Dl8a1sIg.js";import{cache_default as t}from"./cache-kimkMTWJ.js";import{parseDate as n}from"./parse-date-Bgabdhlb.js";import{got_default as r}from"./got-CdvI2yKX.js";import{config_not_found_default as i}from"./config-not-found-BVqhRP9D.js";import{load as a}from"cheerio";import{Cookie as o,CookieJar as s}from"tough-cookie";const c=new Set([`javdb.com`,`javdb36.com`,`javdb007.com`,`javdb521.com`]),l=async(l,u,d)=>{let f=l.req.query(`domain`)??`javdb.com`,p=new URL(u,`https://${f}`);if(!e.feature.allow_user_supply_unsafe_domain&&!c.has(p.hostname))throw new i(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);let m=`https://${f}`,h=new s;if(e.javdb.session){let t=o.fromJSON({key:`_jdb_session`,value:e.javdb.session,domain:f,path:`/`});t&&h.setCookie(t,m)}let g=await r({method:`get`,url:p.href,cookieJar:h,headers:{"User-Agent":e.trueUA}}),_=a(g.data);_(`.tags, .tag-can-play, .over18-modal`).remove();let v=_(`div.item`).slice(0,l.req.query(`limit`)?Number.parseInt(l.req.query(`limit`)):20).toArray().map(e=>(e=_(e),{title:e.find(`.video-title`).text(),link:`${m}${e.find(`.box`).attr(`href`)}`,pubDate:n(e.find(`.meta`).text())}));v=await Promise.all(v.map(n=>t.tryGet(n.link,async()=>{let t=await r({method:`get`,url:n.link,cookieJar:h,headers:{"User-Agent":e.trueUA}}),i=a(t.data);return n.enclosure_type=`application/x-bittorrent`,n.enclosure_url=i(`#magnets-content button[data-clipboard-text]`).first().attr(`data-clipboard-text`),i(`icon`).remove(),i(`#modal-review-watched, #modal-comment-warning, #modal-save-list`).remove(),i(`.review-buttons, .copy-to-clipboard, .preview-video-container, .play-button`).remove(),i(`.preview-images img`).each(function(){i(this).removeAttr(`data-src`),i(this).attr(`src`,i(this).parent().attr(`href`))}),n.category=i(`.panel-block .value a`).toArray().map(e=>i(e).text()),n.author=i(`.panel-block .value`).last().parent().find(`.value a`).first().text(),n.description=i(`.cover-container, .column-video-cover`).html()+i(`.movie-panel-info`).html()+i(`#magnets-content`).html()+i(`.preview-images`).html(),n})));let y=_(`title`).text(),b=y.includes(`|`)?y.split(`|`)[0]:``;return{title:b===``?d:`${b} - ${d}`,link:p.href,item:v}};var u={ProcessItems:l};export{u as utils_default};
//# sourceMappingURL=utils-BrGisCrd.js.map