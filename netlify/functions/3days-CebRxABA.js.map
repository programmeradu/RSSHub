{"version":3,"file":"3days-CebRxABA.js","names":[],"sources":["../../lib/routes/qweather/3days.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nconst WEATHER_API = 'https://devapi.qweather.com/v7/weather/3d';\r\nconst AIR_QUALITY_API = 'https://devapi.qweather.com/v7/air/5d';\r\nconst CIRY_LOOKUP_API = 'https://geoapi.qweather.com/v2/city/lookup';\r\nconst author = 'QWeather';\r\n\r\nexport const route: Route = {\r\n    path: '/3days/:location',\r\n    categories: ['forecast'],\r\n    example: '/qweather/3days/广州',\r\n    parameters: { location: 'N' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'HEFENG_KEY',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '近三天天气',\r\n    maintainers: ['Rein-Ou', 'la3rence'],\r\n    handler,\r\n    description: '获取订阅近三天天气预报',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.hefeng.key) {\r\n        throw new ConfigNotFoundError('QWeather RSS is disabled due to the lack of <a href=\"https://docs.rsshub.app/zh/install/config#%E5%92%8C%E9%A3%8E%E5%A4%A9%E6%B0%94\">relevant config</a>');\r\n    }\r\n\r\n    const id = await cache.tryGet('qweather:' + ctx.req.param('location') + ':id', async () => {\r\n        const response = await got(`${CIRY_LOOKUP_API}?location=${ctx.req.param('location')}&key=${config.hefeng.key}`);\r\n        return response.data.location[0].id;\r\n    });\r\n    const weatherData = await cache.tryGet(\r\n        'qweather:' + ctx.req.param('location'),\r\n        async () => {\r\n            const response = await got(`${WEATHER_API}?key=${config.hefeng.key}&location=${id}`);\r\n            return response.data;\r\n        },\r\n        config.cache.contentExpire,\r\n        false\r\n    );\r\n    const airQualityData = await cache.tryGet(\r\n        `qweather:air:${ctx.req.param('location')}`,\r\n        async () => {\r\n            const airQualityResponse = await got(`${AIR_QUALITY_API}?location=${id}&key=${config.hefeng.key}`);\r\n            return airQualityResponse.data;\r\n        },\r\n        config.cache.contentExpire,\r\n        false\r\n    );\r\n    // merge weather data with air quality data\r\n    const combined = {\r\n        updateTime: weatherData.updateTime,\r\n        fxLink: weatherData.fxLink,\r\n        daily: weatherData.daily.map((weatherItem) => {\r\n            const dailyAirQuality = airQualityData.daily.find((airQualityItem) => airQualityItem.fxDate === weatherItem.fxDate);\r\n            if (dailyAirQuality) {\r\n                return {\r\n                    ...weatherItem,\r\n                    aqi: dailyAirQuality.aqi,\r\n                    aqiLevel: dailyAirQuality.level,\r\n                    aqiCategory: dailyAirQuality.category,\r\n                    aqiPrimary: dailyAirQuality.primary,\r\n                };\r\n            }\r\n            return weatherItem;\r\n        }),\r\n    };\r\n    const items = combined.daily.map((item) => ({\r\n        title: `${item.fxDate}: ${item.textDay === item.textNight ? item.textDay : item.textDay + '转' + item.textNight} ${item.tempMin}~${item.tempMax}℃`,\r\n        description: art(path.join(__dirname, 'templates/3days.art'), {\r\n            item,\r\n        }),\r\n        pubDate: combined.updateTime,\r\n        guid: '位置：' + ctx.req.param('location') + '--日期：' + item.fxDate,\r\n        link: combined.fxLink,\r\n        author,\r\n    }));\r\n\r\n    return {\r\n        title: ctx.req.param('location') + '未来三天天气',\r\n        description: ctx.req.param('location') + '未来三天天气情况，使用和风彩云 API (包括空气质量)',\r\n        item: items,\r\n        link: combined.fxLink,\r\n        author,\r\n    };\r\n}\r\n"],"mappings":"+dASA,MAGM,EAAS,WAEF,EAAe,CACxB,KAAM,mBACN,WAAY,CAAC,YACb,QAAS,qBACT,WAAY,CAAE,SAAU,KACxB,SAAU,CACN,cAAe,CACX,CACI,KAAM,aACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,QACN,YAAa,CAAC,UAAW,YACzB,UACA,YAAa,eAGjB,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,OAAO,IACf,MAAM,IAAI,EAAoB,4JAGlC,IAAM,EAAK,MAAM,EAAM,OAAO,YAAc,EAAI,IAAI,MAAM,YAAc,MAAO,SAAY,CACvF,IAAM,EAAW,MAAM,EAAI,uDAA+B,EAAI,IAAI,MAAM,YAAY,OAAO,EAAO,OAAO,OACzG,OAAO,EAAS,KAAK,SAAS,GAAG,KAE/B,EAAc,MAAM,EAAM,OAC5B,YAAc,EAAI,IAAI,MAAM,YAC5B,SAAY,CACR,IAAM,EAAW,MAAM,EAAI,iDAAsB,EAAO,OAAO,IAAI,YAAY,KAC/E,OAAO,EAAS,MAEpB,EAAO,MAAM,cACb,IAEE,EAAiB,MAAM,EAAM,OAC/B,gBAAgB,EAAI,IAAI,MAAM,cAC9B,SAAY,CACR,IAAM,EAAqB,MAAM,EAAI,kDAA+B,EAAG,OAAO,EAAO,OAAO,OAC5F,OAAO,EAAmB,MAE9B,EAAO,MAAM,cACb,IAGE,EAAW,CACb,WAAY,EAAY,WACxB,OAAQ,EAAY,OACpB,MAAO,EAAY,MAAM,IAAK,GAAgB,CAC1C,IAAM,EAAkB,EAAe,MAAM,KAAM,GAAmB,EAAe,SAAW,EAAY,QAU5G,OATI,EACO,CACH,GAAG,EACH,IAAK,EAAgB,IACrB,SAAU,EAAgB,MAC1B,YAAa,EAAgB,SAC7B,WAAY,EAAgB,SAG7B,KAGT,EAAQ,EAAS,MAAM,IAAK,IAAU,CACxC,MAAO,GAAG,EAAK,OAAO,IAAI,EAAK,UAAY,EAAK,UAAY,EAAK,QAAU,EAAK,QAAU,IAAM,EAAK,UAAU,GAAG,EAAK,QAAQ,GAAG,EAAK,QAAQ,GAC/I,YAAa,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAC1D,SAEJ,QAAS,EAAS,WAClB,KAAM,MAAQ,EAAI,IAAI,MAAM,YAAc,QAAU,EAAK,OACzD,KAAM,EAAS,OACf,YAGJ,MAAO,CACH,MAAO,EAAI,IAAI,MAAM,YAAc,SACnC,YAAa,EAAI,IAAI,MAAM,YAAc,+BACzC,KAAM,EACN,KAAM,EAAS,OACf"}