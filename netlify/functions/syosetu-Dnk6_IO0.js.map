{"version":3,"file":"syosetu-Dnk6_IO0.js","names":["InvalidParameterError","cache","ofetch","route: Route"],"sources":["../../lib/routes/syosetu/utils.ts","../../lib/routes/syosetu/index.ts"],"sourcesContent":["import { DataItem } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport { config } from '@/config';\r\nimport { NarouNovelFetch, NarouSearchResult, SearchBuilder, SearchBuilderR18 } from 'narou';\r\n\r\nexport async function fetchNovelInfo(ncode: string): Promise<{ baseUrl: string; novel: NarouSearchResult }> {\r\n    const api = new NarouNovelFetch();\r\n    const [generalRes, r18Res] = await Promise.all([new SearchBuilder({ gzip: 5, of: 't-s-k-ga-nt-nu' }, api).ncode(ncode).execute(), new SearchBuilderR18({ gzip: 5, of: 't-s-k-ga-nt-nu' }, api).ncode(ncode).execute()]);\r\n\r\n    const isGeneral = generalRes.allcount !== 0;\r\n    const novelData = isGeneral ? generalRes : r18Res;\r\n    const baseUrl = isGeneral ? 'https://ncode.syosetu.com' : 'https://novel18.syosetu.com';\r\n\r\n    if (novelData.allcount === 0) {\r\n        throw new InvalidParameterError('Novel not found in both APIs');\r\n    }\r\n\r\n    return {\r\n        baseUrl,\r\n        novel: novelData.values[0] as NarouSearchResult,\r\n    };\r\n}\r\n\r\nexport async function fetchChapterContent(chapterUrl: string, chapter?: number): Promise<DataItem> {\r\n    return (await cache.tryGet(chapterUrl, async () => {\r\n        const response = await ofetch(chapterUrl, {\r\n            headers: {\r\n                Cookie: 'over18=yes',\r\n                'User-Agent': config.ua,\r\n            },\r\n        });\r\n\r\n        const $ = load(response);\r\n\r\n        const title = `${chapter ? `#${chapter} ` : ''}${$('.p-novel__title').html() || ''}`;\r\n        const description = $('.p-novel__body').html() || '';\r\n        const pubDate = $('meta[name=WWWC]').attr('content');\r\n\r\n        return {\r\n            title,\r\n            description,\r\n            link: chapterUrl,\r\n            pubDate,\r\n            language: 'ja',\r\n        };\r\n    })) as DataItem;\r\n}\r\n","import { Route, Data, DataItem } from '@/types';\r\nimport { fetchNovelInfo, fetchChapterContent } from './utils';\r\nimport { Context } from 'hono';\r\nimport { NovelType } from 'narou';\r\n\r\nexport const route: Route = {\r\n    path: '/:ncode',\r\n    categories: ['reading'],\r\n    example: '/syosetu/n9292ii',\r\n    parameters: {\r\n        ncode: 'Novel code, can be found in URL',\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Novel Updates',\r\n    maintainers: ['eternasuno', 'SnowAgar25'],\r\n    handler,\r\n    radar: [\r\n        {\r\n            title: 'Novel Updates',\r\n            source: ['ncode.syosetu.com/:ncode', 'ncode.syosetu.com/:ncode/:chapter'],\r\n            target: '/:ncode',\r\n        },\r\n        {\r\n            title: 'Novel Updates',\r\n            source: ['novel18.syosetu.com/:ncode', 'novel18.syosetu.com/:ncode/:chapter'],\r\n            target: '/:ncode',\r\n        },\r\n    ],\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const { ncode } = ctx.req.param();\r\n    const limit = Math.min(Number(ctx.req.query('limit') ?? 5), 20);\r\n\r\n    const { baseUrl, novel } = await fetchNovelInfo(ncode);\r\n    novel.story = novel.story.replaceAll('\\n', '<br>') || '';\r\n\r\n    // Tanpen = Short\r\n    if (novel.noveltype === NovelType.Tanpen) {\r\n        const chapterUrl = `${baseUrl}/${ncode}`;\r\n        const item = await fetchChapterContent(chapterUrl);\r\n\r\n        // Shorts are updated rather than having new chapters\r\n        // Use novelupdated_at as pubDate since RSS 2.0 doesn't have updated field\r\n        item.pubDate = novel.novelupdated_at;\r\n\r\n        return {\r\n            title: novel.title,\r\n            description: novel.story,\r\n            link: chapterUrl,\r\n            item: [item] as DataItem[],\r\n            language: 'ja',\r\n        };\r\n    }\r\n\r\n    // Rensai = Series\r\n    // if (novel.noveltype === NovelType.Rensai)\r\n    const totalChapters = novel.general_all_no ?? 1;\r\n    const startChapter = Math.max(totalChapters - limit + 1, 1);\r\n\r\n    const items = await Promise.all(\r\n        Array.from({ length: Math.min(limit, totalChapters) }, async (_, index) => {\r\n            const chapterNumber = startChapter + index;\r\n            const chapterUrl = `${baseUrl}/${ncode}/${chapterNumber}`;\r\n\r\n            const item = await fetchChapterContent(chapterUrl, chapterNumber);\r\n            return item;\r\n        }).toReversed()\r\n    );\r\n\r\n    return {\r\n        title: novel.title,\r\n        description: novel.story,\r\n        link: `${baseUrl}/${ncode}`,\r\n        item: items as DataItem[],\r\n        language: 'ja',\r\n    };\r\n}\r\n"],"mappings":"2bAQA,eAAsB,EAAe,EAAuE,CACxG,IAAM,EAAM,IAAI,EACV,CAAC,EAAY,GAAU,MAAM,QAAQ,IAAI,CAAC,IAAI,EAAc,CAAE,KAAM,EAAG,GAAI,kBAAoB,GAAK,MAAM,GAAO,UAAW,IAAI,EAAiB,CAAE,KAAM,EAAG,GAAI,kBAAoB,GAAK,MAAM,GAAO,YAEtM,EAAY,EAAW,WAAa,EACpC,EAAY,EAAY,EAAa,EACrC,EAAU,EAAY,4BAA8B,8BAE1D,GAAI,EAAU,WAAa,EACvB,MAAM,IAAIA,EAAsB,gCAGpC,MAAO,CACH,UACA,MAAO,EAAU,OAAO,IAIhC,eAAsB,EAAoB,EAAoB,EAAqC,CAC/F,OAAQ,MAAMC,EAAM,OAAO,EAAY,SAAY,CAC/C,IAAM,EAAW,MAAMC,EAAO,EAAY,CACtC,QAAS,CACL,OAAQ,aACR,aAAc,EAAO,MAIvB,EAAI,EAAK,GAET,EAAQ,GAAG,EAAU,IAAI,EAAQ,GAAK,KAAK,EAAE,mBAAmB,QAAU,KAC1E,EAAc,EAAE,kBAAkB,QAAU,GAC5C,EAAU,EAAE,mBAAmB,KAAK,WAE1C,MAAO,CACH,QACA,cACA,KAAM,EACN,UACA,SAAU,QCzCtB,MAAaC,EAAe,CACxB,KAAM,UACN,WAAY,CAAC,WACb,QAAS,mBACT,WAAY,CACR,MAAO,mCAEX,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,gBACN,YAAa,CAAC,aAAc,cAC5B,UACA,MAAO,CACH,CACI,MAAO,gBACP,OAAQ,CAAC,2BAA4B,qCACrC,OAAQ,WAEZ,CACI,MAAO,gBACP,OAAQ,CAAC,6BAA8B,uCACvC,OAAQ,aAKpB,eAAe,EAAQ,EAA6B,CAChD,GAAM,CAAE,SAAU,EAAI,IAAI,QACpB,EAAQ,KAAK,IAAI,OAAO,EAAI,IAAI,MAAM,UAAY,GAAI,IAEtD,CAAE,UAAS,SAAU,MAAM,EAAe,GAIhD,GAHA,EAAM,MAAQ,EAAM,MAAM,WAAW;EAAM,SAAW,GAGlD,EAAM,YAAc,EAAU,OAAQ,CACtC,IAAM,EAAa,GAAG,EAAQ,GAAG,IAC3B,EAAO,MAAM,EAAoB,GAMvC,MAFA,GAAK,QAAU,EAAM,gBAEd,CACH,MAAO,EAAM,MACb,YAAa,EAAM,MACnB,KAAM,EACN,KAAM,CAAC,GACP,SAAU,MAMlB,IAAM,EAAgB,EAAM,gBAAkB,EACxC,EAAe,KAAK,IAAI,EAAgB,EAAQ,EAAG,GAEnD,EAAQ,MAAM,QAAQ,IACxB,MAAM,KAAK,CAAE,OAAQ,KAAK,IAAI,EAAO,IAAkB,MAAO,EAAG,IAAU,CACvE,IAAM,EAAgB,EAAe,EAC/B,EAAa,GAAG,EAAQ,GAAG,EAAM,GAAG,IAEpC,EAAO,MAAM,EAAoB,EAAY,GACnD,OAAO,IACR,cAGP,MAAO,CACH,MAAO,EAAM,MACb,YAAa,EAAM,MACnB,KAAM,GAAG,EAAQ,GAAG,IACpB,KAAM,EACN,SAAU"}