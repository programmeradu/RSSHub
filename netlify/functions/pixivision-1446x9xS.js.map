{"version":3,"file":"pixivision-1446x9xS.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/pixivision/utils.ts","../../lib/routes/pixivision/index.ts"],"sourcesContent":["import { CheerioAPI } from 'cheerio';\r\nimport { config } from '@/config';\r\n\r\nconst multiImagePrompt = {\r\n    en: (count) => `${count} images in total`,\r\n    zh: (count) => `共${count}张图`,\r\n    'zh-tw': (count) => `共${count}張圖`,\r\n    ko: (count) => `총 ${count}개의 이미지`,\r\n    ja: (count) => `計${count}枚の画像`,\r\n};\r\n\r\nexport function processContent($: CheerioAPI, lang: string): string {\r\n    // 移除作者頭像\r\n    $('.am__work__user-icon-container').remove();\r\n\r\n    // 插畫標題&作者\r\n    $('.am__work__title').attr('style', 'display: inline;');\r\n    $('.am__work__user-name').attr('style', 'display: inline; margin-left: 10px;');\r\n\r\n    // 處理多張圖片的提示\r\n    $('.mic__label').each((_, elem) => {\r\n        const $label = $(elem);\r\n        const count = $label.text();\r\n        const $workContainer = $label.parentsUntil('.am__work').last().parent();\r\n        const $titleContainer = $workContainer.find('.am__work__title-container');\r\n\r\n        $titleContainer.append(`<p style=\"float: right; margin: 0;\">${multiImagePrompt[lang](count)}</p>`);\r\n        $label.remove();\r\n    });\r\n\r\n    // 插畫間隔\r\n    $('.article-item, ._feature-article-body__pixiv_illust').after('<br>');\r\n\r\n    // Remove Label & Tags\r\n    $('.arc__thumbnail-label').remove();\r\n    $('.arc__footer-container').remove();\r\n\r\n    // pixivision card\r\n    $('article._article-card').each((_, article) => {\r\n        const $article = $(article);\r\n\r\n        const $thumbnail = $article.find('._thumbnail');\r\n        const thumbnailStyle = $thumbnail.attr('style');\r\n        const bgImageMatch = thumbnailStyle?.match(/url\\((.*?)\\)/);\r\n        const imageUrl = bgImageMatch ? bgImageMatch[1] : '';\r\n\r\n        $thumbnail.remove();\r\n\r\n        if (imageUrl) {\r\n            $article.prepend(`<img src=\"${imageUrl}\" alt=\"Article thumbnail\">`);\r\n        }\r\n    });\r\n\r\n    // 處理 tweet\r\n    $('.fab__script').each((_, elem) => {\r\n        const $elem = $(elem);\r\n        const $link = $elem.find('blockquote > a');\r\n        const href = $link.attr('href');\r\n\r\n        if (href) {\r\n            const match = href.match(/\\/status\\/(\\d+)/);\r\n            if (match) {\r\n                const tweetId = match[1];\r\n                $elem.html(`\r\n                <iframe\r\n                    scrolling=\"no\"\r\n                    frameborder=\"0\"\r\n                    allowtransparency=\"true\"\r\n                    allowfullscreen=\"true\"\r\n                    class=\"\"\r\n                    style=\"position: static; visibility: visible; display: block; width: 550px; height: 1000px; flex-grow: 1;\"\r\n                    title=\"X Post\"\r\n                    src=\"https://platform.twitter.com/embed/Tweet.html?id=${tweetId}\"\r\n                ></iframe>\r\n            `);\r\n                $elem.find('blockquote').remove();\r\n            }\r\n        }\r\n    });\r\n\r\n    return (\r\n        $('.am__body')\r\n            .html()\r\n            ?.replace(/https:\\/\\/i\\.pximg\\.net/g, config.pixiv.imgProxy || '') || ''\r\n    );\r\n}\r\n","import { Route, DataItem, Data, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { processContent } from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/:lang/:category?',\r\n    categories: ['anime'],\r\n    view: ViewType.Articles,\r\n    example: '/pixivision/zh-tw',\r\n    parameters: { lang: 'Language', category: 'Category' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Category',\r\n    maintainers: ['SnowAgar25'],\r\n    description: `::: tip\r\n  \\`https://www.pixivision.net/zh-tw/c/interview\\` → \\`/pixivision/zh-tw/interview\\`\r\n:::`,\r\n    radar: [\r\n        {\r\n            source: ['www.pixivision.net/:lang'],\r\n            target: '/:lang',\r\n        },\r\n        {\r\n            source: ['www.pixivision.net/:lang/c/:category'],\r\n            target: '/:lang/:category',\r\n        },\r\n    ],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx): Promise<Data> {\r\n    const { lang, category } = ctx.req.param();\r\n    const baseUrl = 'https://www.pixivision.net';\r\n    const url = category ? `${baseUrl}/${lang}/c/${category}` : `${baseUrl}/${lang}`;\r\n\r\n    const headers = {\r\n        headers: {\r\n            Cookie: `user_lang=${lang.replace('-', '_')}`, // zh-tw → zh_tw\r\n        },\r\n    };\r\n\r\n    const { data: response } = await got(url, headers);\r\n    const $ = load(response);\r\n\r\n    const list = $('li.article-card-container a[data-gtm-action=\"ClickTitle\"]')\r\n        .toArray()\r\n        .map((elem) => ({\r\n            title: $(elem).text(),\r\n            link: new URL($(elem).attr('href') ?? '', baseUrl).href,\r\n        }));\r\n\r\n    const items = await Promise.all(\r\n        list.map(async (item) => {\r\n            const result = await cache.tryGet(item.link, async () => {\r\n                const { data: articleData } = await got(item.link, headers);\r\n                const $article = load(articleData);\r\n\r\n                const processedDescription = processContent($article, lang);\r\n\r\n                return {\r\n                    title: item.title,\r\n                    description: processedDescription,\r\n                    link: item.link,\r\n                    pubDate: parseDate($article('time').attr('datetime') ?? ''),\r\n                } as DataItem;\r\n            });\r\n            return result;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `${$('.ssc__header').length ? $('.ssc__header').text() : 'New'} - pixivision`,\r\n        link: url,\r\n        item: items.filter((item): item is DataItem => !!item),\r\n    };\r\n}\r\n"],"mappings":"waAGA,MAAM,EAAmB,CACrB,GAAK,GAAU,GAAG,EAAM,kBACxB,GAAK,GAAU,IAAI,EAAM,IACzB,QAAU,GAAU,IAAI,EAAM,IAC9B,GAAK,GAAU,KAAK,EAAM,QAC1B,GAAK,GAAU,IAAI,EAAM,OAG7B,SAAgB,EAAe,EAAe,EAAsB,CAqEhE,OAnEA,EAAE,kCAAkC,SAGpC,EAAE,oBAAoB,KAAK,QAAS,oBACpC,EAAE,wBAAwB,KAAK,QAAS,uCAGxC,EAAE,eAAe,MAAM,EAAG,IAAS,CAC/B,IAAM,EAAS,EAAE,GACX,EAAQ,EAAO,OACf,EAAiB,EAAO,aAAa,aAAa,OAAO,SACzD,EAAkB,EAAe,KAAK,8BAE5C,EAAgB,OAAO,uCAAuC,EAAiB,GAAM,GAAO,OAC5F,EAAO,WAIX,EAAE,uDAAuD,MAAM,QAG/D,EAAE,yBAAyB,SAC3B,EAAE,0BAA0B,SAG5B,EAAE,yBAAyB,MAAM,EAAG,IAAY,CAC5C,IAAM,EAAW,EAAE,GAEb,EAAa,EAAS,KAAK,eAC3B,EAAiB,EAAW,KAAK,SACjC,EAAe,GAAgB,MAAM,gBACrC,EAAW,EAAe,EAAa,GAAK,GAElD,EAAW,SAEP,GACA,EAAS,QAAQ,aAAa,EAAS,+BAK/C,EAAE,gBAAgB,MAAM,EAAG,IAAS,CAChC,IAAM,EAAQ,EAAE,GACV,EAAQ,EAAM,KAAK,kBACnB,EAAO,EAAM,KAAK,QAExB,GAAI,EAAM,CACN,IAAM,EAAQ,EAAK,MAAM,mBACzB,GAAI,EAAO,CACP,IAAM,EAAU,EAAM,GACtB,EAAM,KAAK;;;;;;;;;4EASiD,EAAQ;;eAGpE,EAAM,KAAK,cAAc,aAMjC,EAAE,aACG,QACC,QAAQ,2BAA4B,EAAO,MAAM,UAAY,KAAO,GC5ElF,MAAaA,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,SACb,KAAM,EAAS,SACf,QAAS,oBACT,WAAY,CAAE,KAAM,WAAY,SAAU,YAC1C,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,WACN,YAAa,CAAC,cACd,YAAa,iGAGb,MAAO,CACH,CACI,OAAQ,CAAC,4BACT,OAAQ,UAEZ,CACI,OAAQ,CAAC,wCACT,OAAQ,qBAGhB,WAGJ,eAAe,EAAQ,EAAoB,CACvC,GAAM,CAAE,OAAM,YAAa,EAAI,IAAI,QAC7B,EAAU,6BACV,EAAM,EAAW,GAAG,EAAQ,GAAG,EAAK,KAAK,IAAa,GAAG,EAAQ,GAAG,IAEpE,EAAU,CACZ,QAAS,CACL,OAAQ,aAAa,EAAK,QAAQ,IAAK,SAIzC,CAAE,KAAM,GAAa,MAAMC,EAAI,EAAK,GACpC,EAAI,EAAK,GAET,EAAO,EAAE,6DACV,UACA,IAAK,IAAU,CACZ,MAAO,EAAE,GAAM,OACf,KAAM,IAAI,IAAI,EAAE,GAAM,KAAK,SAAW,GAAI,GAAS,QAGrD,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAI,KAAO,IAAS,CACrB,IAAM,EAAS,MAAMC,EAAM,OAAO,EAAK,KAAM,SAAY,CACrD,GAAM,CAAE,KAAM,GAAgB,MAAMD,EAAI,EAAK,KAAM,GAC7C,EAAW,EAAK,GAEhB,EAAuB,EAAe,EAAU,GAEtD,MAAO,CACH,MAAO,EAAK,MACZ,YAAa,EACb,KAAM,EAAK,KACX,QAAS,EAAU,EAAS,QAAQ,KAAK,aAAe,OAGhE,OAAO,KAIf,MAAO,CACH,MAAO,GAAG,EAAE,gBAAgB,OAAS,EAAE,gBAAgB,OAAS,MAAM,eACtE,KAAM,EACN,KAAM,EAAM,OAAQ,GAA2B,CAAC,CAAC"}