{"version":3,"file":"oa-news-D8nMDpSf.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/gdut/oa-news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { CookieJar } from 'tough-cookie';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport pMap from 'p-map';\r\n\r\nconst site = 'https://oas.gdut.edu.cn/seeyon';\r\nconst typeMap = {\r\n    news: {\r\n        id: '-4899485396563308862',\r\n        name: '校内简讯',\r\n        publish: false,\r\n    },\r\n    notice: {\r\n        id: '5854888065150372255',\r\n        name: '校内通知',\r\n        publish: false,\r\n    },\r\n    announcement: {\r\n        id: '5821359576359193913',\r\n        name: '公示公告',\r\n        publish: false,\r\n    },\r\n    tender_result: {\r\n        id: '-1226046021292568614',\r\n        name: '招标结果',\r\n        publish: true,\r\n    },\r\n    tender_invite: {\r\n        id: '-3656117696093796045',\r\n        name: '招标公告',\r\n        publish: true,\r\n    },\r\n};\r\n\r\nfunction getArg(type) {\r\n    return type.publish\r\n        ? JSON.stringify([\r\n              {\r\n                  pageSize: '20',\r\n                  pageNo: 1,\r\n                  listType: '1',\r\n                  spaceType: '',\r\n                  spaceId: '',\r\n                  typeId: type.id,\r\n                  condition: 'publishDepartment',\r\n                  textfield1: '',\r\n                  textfield2: '',\r\n                  myNews: '',\r\n              },\r\n          ])\r\n        : JSON.stringify([\r\n              {\r\n                  pageSize: '20',\r\n                  pageNo: 1,\r\n                  listType: '1',\r\n                  spaceType: '2',\r\n                  spaceId: '',\r\n                  typeId: '',\r\n                  condition: 'publishDepartment',\r\n                  textfield1: '',\r\n                  textfield2: '',\r\n                  myNews: '',\r\n                  fragmentId: type.id,\r\n                  ordinal: '0',\r\n                  panelValue: 'designated_value',\r\n              },\r\n          ]);\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/oa_news/:type?',\r\n    radar: [\r\n        {\r\n            source: ['oas.gdut.edu.cn/seeyon'],\r\n            target: '/oa_news/',\r\n        },\r\n    ],\r\n    name: 'Unknown',\r\n    maintainers: ['jim-kirisame'],\r\n    handler,\r\n    url: 'oas.gdut.edu.cn/seeyon',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const typeParam = ctx.req.param('type') ?? 'notice';\r\n    if (typeMap[typeParam] === undefined) {\r\n        throw new Error('通知类型' + typeParam + '未定义');\r\n    }\r\n\r\n    const type = typeMap[typeParam];\r\n\r\n    // 获取cookie\r\n    const cookieJar = new CookieJar();\r\n    await got(site + '/main.do', {\r\n        cookieJar,\r\n    });\r\n\r\n    // 获取文章列表\r\n    const listUrl = '/ajax.do?method=ajaxAction&managerName=newsDataManager';\r\n    const resp = await got.post(site + listUrl, {\r\n        cookieJar,\r\n        form: {\r\n            managerMethod: 'findListDatas',\r\n            arguments: getArg(type),\r\n        },\r\n    });\r\n\r\n    if (!resp.data.list) {\r\n        throw new Error('文章列表获取失败，可能是被临时限制了访问，请稍后重试');\r\n    }\r\n\r\n    // 构造文章数组\r\n    const articles = resp.data.list.map((item) => ({\r\n        title: item.title,\r\n        guid: item.id,\r\n        link: site + '/newsData.do?method=newsView&newsId=' + item.id,\r\n        pubDate: timezone(parseDate(item.publishDate1), +8),\r\n        author: item.publishUserDepart,\r\n        category: item.typeName,\r\n    }));\r\n\r\n    const results = await pMap(\r\n        articles,\r\n        async (data) => {\r\n            const link = data.link;\r\n            data.description = await cache.tryGet(link, async () => {\r\n                // 获取数据\r\n                const response = await got(link, {\r\n                    cookieJar,\r\n                });\r\n\r\n                const $ = load(response.data);\r\n                const node = $('#content');\r\n                // 清理样式\r\n                node.find('*')\r\n                    .filter(function () {\r\n                        return this.type === 'comment' || this.tagName === 'meta' || this.tagName === 'style';\r\n                    })\r\n                    .remove();\r\n                node.find('*')\r\n                    .contents()\r\n                    .filter(function () {\r\n                        return this.type === 'comment' || this.tagName === 'meta' || this.tagName === 'style';\r\n                    })\r\n                    .remove();\r\n                node.find('*').each(function () {\r\n                    if (this.attribs.style !== undefined) {\r\n                        const newSty = this.attribs.style\r\n                            .split(';')\r\n                            .filter((s) => {\r\n                                const styBlocklist = ['color:rgb(0,0,0)', 'color:black', 'background:rgb(255,255,255)', 'background:white', 'text-align:left', 'text-align:justify', 'font-style:normal', 'font-weight:normal'];\r\n                                const styPrefixBlocklist = [\r\n                                    'font-family',\r\n                                    'font-size',\r\n                                    'background',\r\n                                    'text-autospace',\r\n                                    'text-transform',\r\n                                    'letter-spacing',\r\n                                    'line-height',\r\n                                    'padding',\r\n                                    'margin',\r\n                                    'text-justify',\r\n                                    'word-break',\r\n                                    'vertical-align',\r\n                                    'mso-',\r\n                                    '-ms-',\r\n                                ];\r\n                                const sty = s.trim();\r\n                                if (styBlocklist.includes(sty.replaceAll(/\\s+/g, ''))) {\r\n                                    return false;\r\n                                }\r\n                                for (const prefix of styPrefixBlocklist) {\r\n                                    if (sty.startsWith(prefix)) {\r\n                                        return false;\r\n                                    }\r\n                                }\r\n                                return true;\r\n                            })\r\n                            .join(';');\r\n                        if (newSty) {\r\n                            this.attribs.style = newSty;\r\n                        } else {\r\n                            delete this.attribs.style;\r\n                        }\r\n                    }\r\n                    if (this.attribs.class && this.attribs.class.trim().startsWith('Mso')) {\r\n                        delete this.attribs.class;\r\n                    }\r\n                    if (this.attribs.lang) {\r\n                        delete this.attribs.lang;\r\n                    }\r\n                    if (this.tagName === 'font' || this.tagName === 'o:p') {\r\n                        $(this).replaceWith(this.childNodes);\r\n                    }\r\n                    if (this.tagName === 'span' && !this.attribs.style) {\r\n                        $(this).replaceWith(this.childNodes);\r\n                    }\r\n                });\r\n                node.find('span').each(function () {\r\n                    if (this.childNodes.length === 0) {\r\n                        $(this).remove();\r\n                    }\r\n                });\r\n\r\n                return node.html();\r\n            });\r\n            return data;\r\n        },\r\n        { concurrency: 2 }\r\n    );\r\n\r\n    return {\r\n        title: `广东工业大学新闻通知网 - ` + type.name,\r\n        link: site,\r\n        description: `广东工业大学新闻通知网`,\r\n        item: results,\r\n    };\r\n}\r\n"],"mappings":"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"}