{"version":3,"file":"user-DAY8fs2A.js","names":["route: Route","cache","response","ofetch"],"sources":["../../lib/routes/thepaper/user.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport * as cheerio from 'cheerio';\r\nimport ofetch from '@/utils/ofetch';\r\nimport cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/user/:pphId',\r\n    categories: ['new-media'],\r\n    example: '/thepaper/user/4221423',\r\n    parameters: { pphId: '澎湃号 id，可在澎湃号页 URL 中找到' },\r\n    name: '澎湃号',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\ninterface AuthorInfo {\r\n    userId: number;\r\n    sname: string;\r\n    pic: string;\r\n    isAuth: string;\r\n    userType: string;\r\n    perDesc: string;\r\n    mobile: null;\r\n    isOrder: string;\r\n    sex: string;\r\n    area: string;\r\n    attentionNum: string;\r\n    fansNum: string;\r\n    praiseNum: null;\r\n    pph: boolean;\r\n    normalUser: boolean;\r\n    mobForwardType: number;\r\n    authInfo: string;\r\n    mail: string;\r\n    pphImpactNum: string;\r\n    wonderfulCommentCount: string;\r\n    location: string;\r\n    lastLoginDate: null;\r\n}\r\n\r\ninterface PPHContentResponse {\r\n    code: number;\r\n    data: Data;\r\n    desc: string;\r\n    time: number;\r\n}\r\n\r\ninterface Data {\r\n    hasNext: boolean;\r\n    startTime: number;\r\n    list: ListItem[];\r\n    nodeInfo: null;\r\n    tagInfo: null;\r\n    moreNodeInfo: null;\r\n    pageNum: null;\r\n    pageSize: null;\r\n    pages: null;\r\n    total: null;\r\n    prevPageNum: null;\r\n    nextPageNum: null;\r\n    excludeContIds: null;\r\n    contCont: null;\r\n    filterIds: null;\r\n    updateCount: null;\r\n}\r\n\r\ninterface ListItem {\r\n    contId: string;\r\n    isOutForword: string;\r\n    isOutForward: string;\r\n    forwardType: string;\r\n    mobForwardType: number;\r\n    interactionNum: string;\r\n    praiseTimes: string;\r\n    pic: string;\r\n    imgCardMode: number;\r\n    smallPic: string;\r\n    sharePic: string;\r\n    pubTime: string;\r\n    pubTimeNew: string;\r\n    name: string;\r\n    closePraise: string;\r\n    authorInfo: AuthorInfo;\r\n    nodeId: number;\r\n    contType: number;\r\n    pubTimeLong: number;\r\n    specialNodeId: number;\r\n    cardMode: string;\r\n    dataObjId: number;\r\n    closeFrontComment: boolean;\r\n    isSupInteraction: boolean;\r\n    hideVideoFlag: boolean;\r\n    praiseStyle: number;\r\n    isSustainedFly: number;\r\n    softLocType: number;\r\n    closeComment: boolean;\r\n    voiceInfo: VoiceInfo;\r\n    softAdTypeStr: string;\r\n}\r\n\r\ninterface VoiceInfo {\r\n    imgSrc: string;\r\n    isHaveVoice: string;\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const { pphId } = ctx.req.param();\r\n\r\n    const mobileBuildId = (await cache.tryGet('thepaper:m:buildId', async () => {\r\n        const response = await ofetch('https://m.thepaper.cn');\r\n        const $ = cheerio.load(response);\r\n        const nextData = JSON.parse($('script#__NEXT_DATA__').text());\r\n        return nextData.buildId;\r\n    })) as string;\r\n\r\n    const userInfo = (await cache.tryGet(`thepaper:user:${pphId}`, async () => {\r\n        const response = await ofetch(`https://api.thepaper.cn/userservice/user/homePage/${pphId}`, {\r\n            headers: {\r\n                'Client-Type': '2',\r\n                Origin: 'https://m.thepaper.cn',\r\n                Referer: 'https://m.thepaper.cn/',\r\n            },\r\n        });\r\n        return response.userInfo;\r\n    })) as AuthorInfo;\r\n\r\n    const response = await ofetch<PPHContentResponse>('https://api.thepaper.cn/contentapi/cont/pph/user', {\r\n        method: 'POST',\r\n        body: {\r\n            pageSize: 10,\r\n            pageNum: 1,\r\n            contType: 0,\r\n            excludeContIds: [],\r\n            pphId,\r\n            startTime: 0,\r\n        },\r\n    });\r\n\r\n    const list = response.data.list.map((item) => ({\r\n        title: item.name,\r\n        link: `https://www.thepaper.cn/newsDetail_forward_${item.contId}`,\r\n        pubDate: parseDate(item.pubTimeLong),\r\n        author: item.authorInfo.sname,\r\n        contId: item.contId,\r\n        image: item.pic,\r\n    }));\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch(`https://m.thepaper.cn/_next/data/${mobileBuildId}/detail/${item.contId}.json`, {\r\n                    query: {\r\n                        id: item.contId,\r\n                    },\r\n                });\r\n\r\n                item.description = response.pageProps.detailData.contentDetail.content;\r\n                item.updated = parseDate(response.pageProps.detailData.contentDetail.updateTime);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: userInfo.sname,\r\n        description: userInfo.perDesc,\r\n        link: `https://www.thepaper.cn/user_${pphId}`,\r\n        item: items,\r\n        itunes_author: userInfo.sname,\r\n        image: userInfo.pic,\r\n    };\r\n}\r\n"],"mappings":"8SAMA,MAAaA,EAAe,CACxB,KAAM,eACN,WAAY,CAAC,aACb,QAAS,yBACT,WAAY,CAAE,MAAO,yBACrB,KAAM,MACN,YAAa,CAAC,UACd,WA6FJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,SAAU,EAAI,IAAI,QAEpB,EAAiB,MAAMC,EAAM,OAAO,qBAAsB,SAAY,CACxE,IAAMC,EAAW,MAAMC,EAAO,yBACxB,EAAI,EAAQ,KAAKD,GACjB,EAAW,KAAK,MAAM,EAAE,wBAAwB,QACtD,OAAO,EAAS,UAGd,EAAY,MAAMD,EAAM,OAAO,iBAAiB,IAAS,SAAY,CACvE,IAAMC,EAAW,MAAMC,EAAO,qDAAqD,IAAS,CACxF,QAAS,CACL,cAAe,IACf,OAAQ,wBACR,QAAS,4BAGjB,OAAOD,EAAS,WAGd,EAAW,MAAMC,EAA2B,mDAAoD,CAClG,OAAQ,OACR,KAAM,CACF,SAAU,GACV,QAAS,EACT,SAAU,EACV,eAAgB,GAChB,QACA,UAAW,KAIb,EAAO,EAAS,KAAK,KAAK,IAAK,IAAU,CAC3C,MAAO,EAAK,KACZ,KAAM,8CAA8C,EAAK,SACzD,QAAS,EAAU,EAAK,aACxB,OAAQ,EAAK,WAAW,MACxB,OAAQ,EAAK,OACb,MAAO,EAAK,OAGV,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNF,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAMC,EAAW,MAAMC,EAAO,oCAAoC,EAAc,UAAU,EAAK,OAAO,OAAQ,CAC1G,MAAO,CACH,GAAI,EAAK,UAOjB,MAHA,GAAK,YAAcD,EAAS,UAAU,WAAW,cAAc,QAC/D,EAAK,QAAU,EAAUA,EAAS,UAAU,WAAW,cAAc,YAE9D,MAKnB,MAAO,CACH,MAAO,EAAS,MAChB,YAAa,EAAS,QACtB,KAAM,gCAAgC,IACtC,KAAM,EACN,cAAe,EAAS,MACxB,MAAO,EAAS"}