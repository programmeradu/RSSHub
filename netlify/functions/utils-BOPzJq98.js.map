{"version":3,"file":"utils-BOPzJq98.js","names":["cache","ofetch"],"sources":["../../lib/routes/zaker/utils.ts"],"sourcesContent":["import { DataItem } from '@/types';\r\n\r\nimport CryptoJS from 'crypto-js';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { config } from '@/config';\r\nimport logger from '@/utils/logger';\r\nimport * as cheerio from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nconst hints = ['globalThis', 'headless', 'languages', 'permHook', 'vendor', 'webDriverValue', 'webdriver'];\r\nexport const baseUrl = 'https://www.myzaker.com';\r\n\r\nconst generateSalt = (input: string, targetZeros = 20) => {\r\n    for (let nonce = 0; nonce < 100_000_000; nonce++) {\r\n        const hash = CryptoJS.SHA256(input + nonce).toString();\r\n        let leadingZeros = 0;\r\n\r\n        for (const char of hash) {\r\n            if (char !== '0') {\r\n                leadingZeros += 4 - Number.parseInt(char, 16).toString(2).length;\r\n                break;\r\n            }\r\n            leadingZeros += 4;\r\n        }\r\n\r\n        if (leadingZeros >= targetZeros) {\r\n            return nonce;\r\n        }\r\n    }\r\n    return 0;\r\n};\r\n\r\nconst padSeed = (seed: string) => {\r\n    const padding = '0'.repeat(16);\r\n    return CryptoJS.enc.Utf8.parse((seed + padding).slice(0, 16));\r\n};\r\n\r\nconst encrypt = (data, seed: string) => {\r\n    const iv = CryptoJS.enc.Utf8.parse('1234567890123456');\r\n    return CryptoJS.AES.encrypt(JSON.stringify(data), padSeed(seed), {\r\n        iv,\r\n        padding: CryptoJS.pad.Pkcs7,\r\n    });\r\n};\r\n\r\nconst encryptPayload = (data, seed: string) => encrypt(data, seed).ciphertext.toString();\r\n\r\nexport const getSafeLineCookieWithData = async (link): Promise<{ cookie: string; data: string }> => {\r\n    const cacheKey = 'zaker:cookie';\r\n    const cacheAge = 3600;\r\n    const cacheIn = await cache.get(cacheKey, false);\r\n    if (cacheIn) {\r\n        return JSON.parse(cacheIn);\r\n    }\r\n    const apiBaseUrl = 'https://challenge.rivers.chaitin.cn/captcha/api';\r\n\r\n    const headerResponse = await ofetch.raw(link);\r\n    const session = headerResponse.headers\r\n        .getSetCookie()\r\n        .find((e) => e.startsWith('sl-session'))\r\n        ?.split(';')[0]\r\n        .split('sl-session=')[1];\r\n    const onceId = headerResponse._data.match(/once_id:\\s*\"(.*?)\",/)?.[1];\r\n    logger.debug(`getSafeLineCookie: sl-session=${session}, onceId=${onceId}`);\r\n    if (!/window\\.captcha/.test(headerResponse._data)) {\r\n        logger.debug('getSafeLineCookie: Failed to get once_id');\r\n        return {\r\n            cookie: headerResponse.headers\r\n                .getSetCookie()\r\n                .map((c) => c.split(';')[0])\r\n                .join('; '),\r\n            data: headerResponse._data,\r\n        };\r\n    }\r\n\r\n    // await ofetch(`${apiBaseUrl}/index.html?${Math.random()}`);\r\n    // await ofetch('${apiBaseUrl}/sdk.js');\r\n    const seedResponse = await ofetch<{ req_id: string; seed: string }>(`${apiBaseUrl}/seed`, {\r\n        headers: {\r\n            Referer: `${baseUrl}/`,\r\n        },\r\n        query: {\r\n            once_id: onceId,\r\n            v: '1.0.0',\r\n            hints: hints.sort(() => Math.random() - 0.5).join(','),\r\n        },\r\n    });\r\n\r\n    const ua = config.ua;\r\n    const seed = seedResponse.seed;\r\n    const takeTime = Math.trunc(Math.random() * 2000 + 1000);\r\n    logger.debug(`getSafeLineCookie: ua=${ua}, seed=${seed}, takeTime=${takeTime}`);\r\n    const payload = encryptPayload(\r\n        {\r\n            resolution: '1920x1080',\r\n            languages: ['en-US'],\r\n            useragents: [ua, ua, ua],\r\n            hint: 0,\r\n            salt: String(generateSalt(seed, 16)),\r\n            taketime: takeTime,\r\n        },\r\n        seed\r\n    );\r\n\r\n    const inspectResponse = await ofetch<{ req_id: string; jwt: string; reason: string }>(`${apiBaseUrl}/inspect`, {\r\n        method: 'POST',\r\n        headers: {\r\n            Referer: `${baseUrl}/`,\r\n            'Content-Type': 'text/plain',\r\n        },\r\n        query: {\r\n            seed,\r\n        },\r\n        body: payload,\r\n    });\r\n    logger.debug(`getSafeLineCookie: inspectResponse=${JSON.stringify(inspectResponse)}`);\r\n    if (inspectResponse.reason) {\r\n        logger.error(`getSafeLineCookie: reason=${inspectResponse.reason}`);\r\n        return {\r\n            cookie: headerResponse.headers\r\n                .getSetCookie()\r\n                .map((c) => c.split(';')[0])\r\n                .join('; '),\r\n            data: headerResponse._data,\r\n        };\r\n    }\r\n\r\n    const response = await ofetch.raw(link, {\r\n        headers: {\r\n            Cookie: `sl-session=${session}; sl_waf_recap=${inspectResponse.jwt}`,\r\n        },\r\n    });\r\n\r\n    const cookie = response.headers\r\n        .getSetCookie()\r\n        .map((c) => c.split(';')[0])\r\n        .join('; ');\r\n    logger.debug(`getSafeLineCookie: ${cookie}`);\r\n\r\n    cache.set(cacheKey, JSON.stringify(cookie), cacheAge);\r\n    return {\r\n        cookie,\r\n        data: response._data,\r\n    };\r\n};\r\n\r\nexport const parseList = ($: cheerio.CheerioAPI) => {\r\n    const winPageData = JSON.parse(\r\n        $('script:contains(\"window.WinPageData\")')\r\n            .text()\r\n            .match(/window\\.WinPageData\\s*=\\s*({.*})/)?.[1] ?? '{}'\r\n    );\r\n\r\n    return winPageData.data.article.map((item) => ({\r\n        title: item.title,\r\n        description: item.desc,\r\n        link: 'https:' + item.url,\r\n        author: item.author_name,\r\n        pubDate: timezone(parseDate(item.date, 'MM月DD日'), +8),\r\n        category: item.tag.map((t) => t.tag),\r\n        image: item.thumbnail_mpic,\r\n    })) as DataItem[];\r\n};\r\n\r\nexport const fetchItem = async (item: DataItem, cookie: string) => {\r\n    const response = await ofetch(item.link!, {\r\n        headers: {\r\n            Cookie: cookie as string,\r\n        },\r\n    });\r\n\r\n    const $ = cheerio.load(response);\r\n\r\n    const content = $('div.article_content div');\r\n    content.find('img').each((_, img) => {\r\n        const $img = $(img);\r\n        $img.attr('src', $img.attr('data-original'));\r\n        $img.removeAttr('data-original');\r\n    });\r\n\r\n    item.description = content.html();\r\n\r\n    return item;\r\n};\r\n"],"mappings":"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"}