{"version":3,"file":"crowdfunding-Dn8MLFZb.js","names":["route: Route","result: Promise<CrowdfundingDetailInfo>[]","utils","items: DataItem[]"],"sources":["../../lib/routes/mi/utils.ts","../../lib/routes/mi/crowdfunding.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { art } from '@/utils/render';\r\nimport dayjs from 'dayjs';\r\nimport 'dayjs/locale/zh-cn.js';\r\nimport localizedFormat from 'dayjs/plugin/localizedFormat.js';\r\nimport timezone from 'dayjs/plugin/timezone.js';\r\nimport utc from 'dayjs/plugin/utc.js';\r\nimport path from 'node:path';\r\nimport { CrowdfundingData, CrowdfundingDetailData, CrowdfundingDetailInfo, CrowdfundingItem, CrowdfundingList, DataResponse } from './types';\r\n\r\ndayjs.extend(localizedFormat);\r\ndayjs.extend(timezone);\r\ndayjs.extend(utc);\r\n\r\n/**\r\n * 获取众筹项目列表\r\n *\r\n * @returns {Promise<CrowdfundingList[]>} 众筹项目列表。\r\n */\r\nexport const getCrowdfundingList = async (): Promise<CrowdfundingList[]> => {\r\n    const response = await ofetch<DataResponse<CrowdfundingData>>('https://m.mi.com/v1/crowd/crowd_home', {\r\n        headers: {\r\n            referrer: 'https://m.mi.com/',\r\n        },\r\n        method: 'POST',\r\n    });\r\n    return response.data.list;\r\n};\r\n\r\n/**\r\n * 获取众筹项目详情并缓存\r\n *\r\n * @param {CrowdfundingItem} item - 众筹项目。\r\n * @returns {Promise<CrowdfundingDetailInfo>} 众筹项目详情。\r\n */\r\nexport const getCrowdfundingItem = (item: CrowdfundingItem): Promise<CrowdfundingDetailInfo> =>\r\n    cache.tryGet(`mi:crowdfunding:${item.project_id}`, async () => {\r\n        const response = await ofetch<DataResponse<CrowdfundingDetailData>>('https://m.mi.com/v1/crowd/crowd_detail', {\r\n            headers: {\r\n                referrer: 'https://m.mi.com/crowdfunding/home',\r\n            },\r\n            method: 'POST',\r\n            query: {\r\n                project_id: item.project_id,\r\n            },\r\n        });\r\n        // 建议零售价\r\n        if (response.data.crowd_funding_info.product_market_price === undefined) {\r\n            response.data.crowd_funding_info.product_market_price = item.product_market_price;\r\n        }\r\n        // 众筹开始\r\n        if (response.data.crowd_funding_info.start_time_desc === undefined) {\r\n            response.data.crowd_funding_info.start_time_desc = formatDate(response.data.crowd_funding_info.start_time);\r\n        }\r\n        // 众筹结束\r\n        if (response.data.crowd_funding_info.end_time_desc === undefined) {\r\n            response.data.crowd_funding_info.end_time_desc = formatDate(response.data.crowd_funding_info.end_time);\r\n        }\r\n        return response.data.crowd_funding_info;\r\n    }) as Promise<CrowdfundingDetailInfo>;\r\n\r\n/**\r\n * 渲染众筹项目模板\r\n *\r\n * @param {CrowdfundingDetailInfo} item - 众筹项目详情。\r\n * @returns {string} 渲染后的众筹项目模板字符串。\r\n */\r\nexport const renderCrowdfunding = (item: CrowdfundingDetailInfo): string => art(path.join(__dirname, 'templates/crowdfunding.art'), item);\r\n\r\nconst formatDate = (timestamp: number): string => dayjs.unix(timestamp).tz('Asia/Shanghai').locale('zh-cn').format('lll');\r\n\r\nexport default {\r\n    getCrowdfundingList,\r\n    getCrowdfundingItem,\r\n    renderCrowdfunding,\r\n};\r\n","import { Data, DataItem, Route, ViewType } from '@/types';\r\nimport { CrowdfundingDetailInfo, CrowdfundingList } from './types';\r\nimport utils from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/crowdfunding',\r\n    categories: ['shopping'],\r\n    example: '/mi/crowdfunding',\r\n    name: '小米众筹',\r\n    maintainers: ['DIYgod', 'nuomi1'],\r\n    handler,\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['m.mi.com/crowdfunding/home'],\r\n            target: '/crowdfunding',\r\n        },\r\n    ],\r\n    view: ViewType.Notifications,\r\n};\r\n\r\nconst getDetails = async (list: CrowdfundingList[]) => {\r\n    const result: Promise<CrowdfundingDetailInfo>[] = list.flatMap((section) => section.items.map((item) => utils.getCrowdfundingItem(item)));\r\n    return await Promise.all(result);\r\n};\r\n\r\nconst getDataItem = (item: CrowdfundingDetailInfo) =>\r\n    ({\r\n        title: item.project_name,\r\n        description: utils.renderCrowdfunding(item),\r\n        link: `https://m.mi.com/crowdfunding/proddetail/${item.project_id}`,\r\n        image: item.big_image,\r\n        language: 'zh-cn',\r\n    }) as DataItem;\r\n\r\nasync function handler() {\r\n    const list = await utils.getCrowdfundingList();\r\n    const details = await getDetails(list);\r\n\r\n    const items: DataItem[] = details.map((item) => getDataItem(item));\r\n\r\n    return {\r\n        title: '小米众筹',\r\n        link: 'https://m.mi.com/crowdfunding/home',\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: 'https://m.mi.com/static/img/icons/apple-touch-icon-152x152.png',\r\n        language: 'zh-cn',\r\n    } as Data;\r\n}\r\n"],"mappings":"2iBAWA,EAAM,OAAO,GACb,EAAM,OAAO,GACb,EAAM,OAAO,GAOb,MAAa,EAAsB,SAAyC,CACxE,IAAM,EAAW,MAAM,EAAuC,uCAAwC,CAClG,QAAS,CACL,SAAU,qBAEd,OAAQ,SAEZ,OAAO,EAAS,KAAK,MASZ,EAAuB,GAChC,EAAM,OAAO,mBAAmB,EAAK,aAAc,SAAY,CAC3D,IAAM,EAAW,MAAM,EAA6C,yCAA0C,CAC1G,QAAS,CACL,SAAU,sCAEd,OAAQ,OACR,MAAO,CACH,WAAY,EAAK,cAezB,OAXI,EAAS,KAAK,mBAAmB,uBAAyB,IAAA,KAC1D,EAAS,KAAK,mBAAmB,qBAAuB,EAAK,sBAG7D,EAAS,KAAK,mBAAmB,kBAAoB,IAAA,KACrD,EAAS,KAAK,mBAAmB,gBAAkB,EAAW,EAAS,KAAK,mBAAmB,aAG/F,EAAS,KAAK,mBAAmB,gBAAkB,IAAA,KACnD,EAAS,KAAK,mBAAmB,cAAgB,EAAW,EAAS,KAAK,mBAAmB,WAE1F,EAAS,KAAK,qBAShB,EAAsB,GAAyC,EAAI,EAAA,KAAA,EAAA,uCAAoD,GAE9H,EAAc,GAA8B,EAAM,KAAK,GAAW,GAAG,iBAAiB,OAAO,SAAS,OAAO,OAEnH,IAAA,EAAe,CACX,sBACA,sBACA,sBCvEJ,MAAaA,EAAe,CACxB,KAAM,gBACN,WAAY,CAAC,YACb,QAAS,mBACT,KAAM,OACN,YAAa,CAAC,SAAU,UACxB,UACA,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,aAAc,GACd,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,8BACT,OAAQ,kBAGhB,KAAM,EAAS,eAGb,EAAa,KAAO,IAA6B,CACnD,IAAMC,EAA4C,EAAK,QAAS,GAAY,EAAQ,MAAM,IAAK,GAASC,EAAM,oBAAoB,KAClI,OAAO,MAAM,QAAQ,IAAI,IAGvB,EAAe,IAChB,CACG,MAAO,EAAK,aACZ,YAAaA,EAAM,mBAAmB,GACtC,KAAM,4CAA4C,EAAK,aACvD,MAAO,EAAK,UACZ,SAAU,UAGlB,eAAe,GAAU,CACrB,IAAM,EAAO,MAAMA,EAAM,sBACnB,EAAU,MAAM,EAAW,GAE3BC,EAAoB,EAAQ,IAAK,GAAS,EAAY,IAE5D,MAAO,CACH,MAAO,OACP,KAAM,qCACN,KAAM,EACN,WAAY,GACZ,MAAO,iEACP,SAAU"}