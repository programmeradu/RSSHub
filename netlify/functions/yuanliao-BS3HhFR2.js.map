{"version":3,"file":"yuanliao-BS3HhFR2.js","names":["limit: number","baseUrl: string","apiUrl: string","targetUrl: string","ofetch","$: CheerioAPI","items: DataItem[]","title: string","description: string | undefined","pubDate: number | string","linkUrl: string | undefined","categories: string[]","tag","authors: DataItem['author']","guid: string","updated: number | string","processedItem: DataItem","route: Route","tag: string"],"sources":["../../lib/routes/yuanliao/index.ts"],"sourcesContent":["import { type Data, type DataItem, type Route, ViewType } from '@/types';\r\n\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nimport { type CheerioAPI, load } from 'cheerio';\r\nimport { type Context } from 'hono';\r\n\r\nexport const handler = async (ctx: Context): Promise<Data> => {\r\n    const { tag } = ctx.req.param();\r\n    const limit: number = Number.parseInt(ctx.req.query('limit') ?? '30', 10);\r\n\r\n    const baseUrl: string = 'https://yuanliao.info';\r\n    const apiUrl: string = new URL('api/discussions', baseUrl).href;\r\n    const targetUrl: string = new URL(tag ? `t/${tag}` : '', baseUrl).href;\r\n\r\n    const targetResponse = await ofetch(targetUrl);\r\n    const $: CheerioAPI = load(targetResponse);\r\n    const language = $('html').attr('lang') ?? 'zh';\r\n\r\n    const response = await ofetch(apiUrl, {\r\n        query: {\r\n            include: 'user,firstPost,tags',\r\n            'filter[q]': tag ? `tag:${tag}` : '',\r\n            sort: '',\r\n            'page[offset]': '',\r\n        },\r\n    });\r\n\r\n    const includedMap = new Map<string, any>();\r\n    for (const item of response.included) {\r\n        includedMap.set(`${item.type}-${item.id}`, item);\r\n    }\r\n\r\n    const items: DataItem[] = response.data.slice(0, limit).map((item): DataItem => {\r\n        const attributes = item.attributes;\r\n        const relationships = item.relationships;\r\n\r\n        const title: string = attributes.title;\r\n\r\n        const firstPostData = relationships?.firstPost?.data;\r\n\r\n        const description: string | undefined = firstPostData?.type && firstPostData?.id ? includedMap.get(`${firstPostData.type}-${firstPostData.id}`)?.attributes?.contentHtml : undefined;\r\n        const pubDate: number | string = attributes.createdAt;\r\n        const linkUrl: string | undefined = item.id ? `d/${item.id}` : undefined;\r\n        const categories: string[] = [...new Set(relationships?.tags?.data?.map((tag) => `${tag.type}-${tag.id}`)?.map((key) => includedMap.get(key)?.attributes?.name))].filter(Boolean);\r\n\r\n        const userData = relationships?.user?.data;\r\n        const userAttributes = userData && userData.type && userData.id ? includedMap.get(`${userData.type}-${userData.id}`)?.attributes : undefined;\r\n\r\n        const authors: DataItem['author'] = userAttributes\r\n            ? [\r\n                  {\r\n                      name: userAttributes.displayName,\r\n                      url: userAttributes.username ? new URL(`u/${userAttributes.username}`, baseUrl).href : undefined,\r\n                      avatar: userAttributes.avatarUrl,\r\n                  },\r\n              ]\r\n            : undefined;\r\n        const guid: string = `yuanliao-${item.id}`;\r\n        const updated: number | string = attributes.lastPostedAt ?? pubDate;\r\n\r\n        const processedItem: DataItem = {\r\n            title,\r\n            description,\r\n            pubDate: pubDate ? parseDate(pubDate) : undefined,\r\n            link: linkUrl ? new URL(linkUrl, baseUrl).href : undefined,\r\n            category: categories,\r\n            author: authors,\r\n            guid,\r\n            id: guid,\r\n            content: {\r\n                html: description,\r\n                text: description,\r\n            },\r\n            updated: updated ? parseDate(updated) : undefined,\r\n            language,\r\n        };\r\n\r\n        return processedItem;\r\n    });\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        description: $('meta[name=\"description\"]').attr('content'),\r\n        link: targetUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: $('img.Header-logo').attr('src'),\r\n        author: $('img.Header-logo').attr('alt'),\r\n        language,\r\n        id: targetUrl,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:tag?',\r\n    name: '主题',\r\n    url: 'yuanliao.info',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/yuanliao',\r\n    parameters: {\r\n        tag: {\r\n            description: '标签，默认为全部，可在对应标签页 URL 中找到',\r\n            options: [\r\n                {\r\n                    label: '问题反馈',\r\n                    value: 'bug-report',\r\n                },\r\n                {\r\n                    label: 'Windows',\r\n                    value: 'windows',\r\n                },\r\n                {\r\n                    label: 'macOS',\r\n                    value: 'macos',\r\n                },\r\n                {\r\n                    label: 'Linux',\r\n                    value: 'linux',\r\n                },\r\n                {\r\n                    label: '意见建议',\r\n                    value: 'suggestions',\r\n                },\r\n                {\r\n                    label: '插件发布',\r\n                    value: 'plugins',\r\n                },\r\n                {\r\n                    label: '插件需求',\r\n                    value: 'plugin-needs',\r\n                },\r\n                {\r\n                    label: '开发者',\r\n                    value: 'developers',\r\n                },\r\n            ],\r\n        },\r\n    },\r\n    description: `:::tip\r\n订阅 [问题反馈](https://yuanliao.info/t/bug-report)，其源网址为 \\`https://yuanliao.info/t/bug-report\\`，请参考该 URL 指定部分构成参数，此时路由为 [\\`/yuanliao/bug-report\\`](https://rsshub.app/yuanliao/bug-report)。\r\n:::\r\n\r\n| 标签                                             | id                                                       |\r\n| ------------------------------------------------ | -------------------------------------------------------- |\r\n| [问题反馈](https://yuanliao.info/t/bug-report)   | [bug-report](https://rsshub.app/yuanliao/bug-report)     |\r\n| [Windows](https://yuanliao.info/t/windows)       | [windows](https://rsshub.app/yuanliao/windows)           |\r\n| [macOS](https://yuanliao.info/t/macos)           | [macos](https://rsshub.app/yuanliao/macos)               |\r\n| [Linux](https://yuanliao.info/t/linux)           | [linux](https://rsshub.app/yuanliao/linux)               |\r\n| [意见建议](https://yuanliao.info/t/suggestions)  | [suggestions](https://rsshub.app/yuanliao/suggestions)   |\r\n| [插件发布](https://yuanliao.info/t/plugins)      | [plugins](https://rsshub.app/yuanliao/plugins)           |\r\n| [插件需求](https://yuanliao.info/t/plugin-needs) | [plugin-needs](https://rsshub.app/yuanliao/plugin-needs) |\r\n| [开发者](https://yuanliao.info/t/developers)     | [developers](https://rsshub.app/yuanliao/developers)     |\r\n`,\r\n    categories: ['bbs'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['yuanliao.info', 'yuanliao.info/t/:tag'],\r\n            target: (params) => {\r\n                const tag: string = params.tag;\r\n\r\n                return `/yuanliao${tag ? `/${tag}` : ''}`;\r\n            },\r\n        },\r\n        {\r\n            title: '问题反馈',\r\n            source: ['yuanliao.info/t/bug-report'],\r\n            target: '/bug-report',\r\n        },\r\n        {\r\n            title: 'Windows',\r\n            source: ['yuanliao.info/t/windows'],\r\n            target: '/windows',\r\n        },\r\n        {\r\n            title: 'macOS',\r\n            source: ['yuanliao.info/t/macos'],\r\n            target: '/macos',\r\n        },\r\n        {\r\n            title: 'Linux',\r\n            source: ['yuanliao.info/t/linux'],\r\n            target: '/linux',\r\n        },\r\n        {\r\n            title: '意见建议',\r\n            source: ['yuanliao.info/t/suggestions'],\r\n            target: '/suggestions',\r\n        },\r\n        {\r\n            title: '插件发布',\r\n            source: ['yuanliao.info/t/plugins'],\r\n            target: '/plugins',\r\n        },\r\n        {\r\n            title: '插件需求',\r\n            source: ['yuanliao.info/t/plugin-needs'],\r\n            target: '/plugin-needs',\r\n        },\r\n        {\r\n            title: '开发者',\r\n            source: ['yuanliao.info/t/developers'],\r\n            target: '/developers',\r\n        },\r\n    ],\r\n    view: ViewType.Articles,\r\n};\r\n"],"mappings":"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"}