{"version":3,"file":"search-B27Nv8_t.js","names":["route: Route","got","result: DataItem"],"sources":["../../lib/routes/shopify/apps/search.ts"],"sourcesContent":["import { Data, DataItem, Route } from '@/types';\r\nimport type { Context } from 'hono';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { baseURL } from './const';\r\n\r\nexport const route: Route = {\r\n    path: '/apps/search/:q',\r\n    example: '/shopify/apps/search/flow',\r\n    parameters: { q: '需要搜索的 App' },\r\n    name: 'App store search',\r\n    maintainers: ['PrintNow'],\r\n    handler,\r\n    radar: [\r\n        {\r\n            source: ['apps.shopify.com/search'],\r\n            target: (_params, url) => {\r\n                const searchParams = new URL(url).searchParams;\r\n                if (!searchParams.has('q')) {\r\n                    return '';\r\n                }\r\n                return `/shopify/apps/search/${searchParams.get('q')}`;\r\n            },\r\n        },\r\n    ],\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const { q = '' } = ctx.req.param();\r\n    const response = await got.get(`${baseURL}/search`, {\r\n        searchParams: {\r\n            q,\r\n        },\r\n        headers: {\r\n            accept: 'text/html, application/xhtml+xml',\r\n            'accept-language': 'en-US;q=0.9',\r\n            'turbo-frame': 'search_page',\r\n            referer: baseURL,\r\n            dnt: '1',\r\n        },\r\n    });\r\n\r\n    const htmlContent = await response.data;\r\n    const $ = load(htmlContent);\r\n\r\n    const items = $('.search-results-component div[data-controller=\"app-card\"]')\r\n        .toArray()\r\n        .map((item) => {\r\n            const handle = $(item).attr('data-app-card-handle-value');\r\n\r\n            // const appInfo = $(item).find('div.tw-transition-colors.tw-text-fg-primary + div.tw-self-stretch');\r\n            const appInfo = $(item).find('div.tw-self-stretch').clone();\r\n\r\n            const rattingMatch = appInfo\r\n                .find('span')\r\n                .text()\r\n                .match(/\\d\\.\\d/);\r\n            const rattingCountMatch = appInfo.find('span + span.tw-sr-only').text().match(/\\d+/);\r\n\r\n            const result: DataItem = {\r\n                title: $(item).attr('data-app-card-name-value') ?? '',\r\n                link: `${baseURL}/${handle}`,\r\n                description: $(item).find(`div.tw-text-fg-tertiary`).first().text().trim(),\r\n                image: $(item).attr('data-app-card-icon-url-value'),\r\n                _extra: {\r\n                    handle,\r\n                    description: $(item).find(`div.tw-text-fg-tertiary`).first().text().trim(),\r\n                    built_for_shopify: $(item).find(`span.built-for-shopify-badge`).length > 0,\r\n                    ratting: rattingMatch ? Number.parseFloat(rattingMatch[0]) : 0,\r\n                    ratting_count: rattingCountMatch ? Number(rattingCountMatch[0]) : 0,\r\n                },\r\n            };\r\n\r\n            return result;\r\n        });\r\n\r\n    return {\r\n        title: `Search results for \"${q}\" – Shopify App Store`,\r\n        link: `https://apps.shopify.com/search?q=${q}`,\r\n        // description: `Search results for \"${q}\" – Shopify App Store`,\r\n        allowEmpty: true,\r\n        language: 'en-us',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"6SAMA,MAAaA,EAAe,CACxB,KAAM,kBACN,QAAS,4BACT,WAAY,CAAE,EAAG,aACjB,KAAM,mBACN,YAAa,CAAC,YACd,UACA,MAAO,CACH,CACI,OAAQ,CAAC,2BACT,QAAS,EAAS,IAAQ,CACtB,IAAM,EAAe,IAAI,IAAI,GAAK,aAIlC,OAHK,EAAa,IAAI,KAGf,wBAAwB,EAAa,IAAI,OAFrC,OAQ3B,eAAe,EAAQ,EAA6B,CAChD,GAAM,CAAE,IAAI,IAAO,EAAI,IAAI,QACrB,EAAW,MAAMC,EAAI,IAAI,GAAG,EAAQ,SAAU,CAChD,aAAc,CACV,KAEJ,QAAS,CACL,OAAQ,mCACR,kBAAmB,cACnB,cAAe,cACf,QAAS,EACT,IAAK,OAIP,EAAc,MAAM,EAAS,KAC7B,EAAI,EAAK,GAET,EAAQ,EAAE,6DACX,UACA,IAAK,GAAS,CACX,IAAM,EAAS,EAAE,GAAM,KAAK,8BAGtB,EAAU,EAAE,GAAM,KAAK,uBAAuB,QAE9C,EAAe,EAChB,KAAK,QACL,OACA,MAAM,UACL,EAAoB,EAAQ,KAAK,0BAA0B,OAAO,MAAM,OAExEC,EAAmB,CACrB,MAAO,EAAE,GAAM,KAAK,6BAA+B,GACnD,KAAM,GAAG,EAAQ,GAAG,IACpB,YAAa,EAAE,GAAM,KAAK,2BAA2B,QAAQ,OAAO,OACpE,MAAO,EAAE,GAAM,KAAK,gCACpB,OAAQ,CACJ,SACA,YAAa,EAAE,GAAM,KAAK,2BAA2B,QAAQ,OAAO,OACpE,kBAAmB,EAAE,GAAM,KAAK,gCAAgC,OAAS,EACzE,QAAS,EAAe,OAAO,WAAW,EAAa,IAAM,EAC7D,cAAe,EAAoB,OAAO,EAAkB,IAAM,IAI1E,OAAO,IAGf,MAAO,CACH,MAAO,uBAAuB,EAAE,uBAChC,KAAM,qCAAqC,IAE3C,WAAY,GACZ,SAAU,QACV,KAAM"}