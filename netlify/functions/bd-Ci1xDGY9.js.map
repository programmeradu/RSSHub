{"version":3,"file":"bd-Ci1xDGY9.js","names":["TYPE: Mapping","heading: string[]","separator: string[]","body: string[]","handler: Route['handler']","ConfigNotFoundError","ofetch","$","item","route: Route"],"sources":["../../lib/routes/tsdm39/bd.ts"],"sourcesContent":["import type { DataItem, Route } from '@/types';\r\nimport { config } from '@/config';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\n// type id => display name\r\ntype Mapping = Record<string, string>;\r\n\r\nconst TYPE: Mapping = {\r\n    '403': '720P',\r\n    '404': '1080P',\r\n    '405': 'BDMV',\r\n    '4130': '4K',\r\n    '5815': 'AV1',\r\n};\r\n\r\n// render into MD table\r\nconst mkTable = (mapping: Mapping): string => {\r\n    const heading: string[] = [],\r\n        separator: string[] = [],\r\n        body: string[] = [];\r\n\r\n    for (const key in mapping) {\r\n        heading.push(mapping[key]);\r\n        separator.push(':--:');\r\n        body.push(key);\r\n    }\r\n\r\n    return [heading.join(' | '), separator.join(' | '), body.join(' | ')].map((s) => `| ${s} |`).join('\\n');\r\n};\r\n\r\nconst handler: Route['handler'] = async (ctx) => {\r\n    const { type } = ctx.req.param();\r\n\r\n    const cookie = config.tsdm39.cookie;\r\n    if (!cookie) {\r\n        throw new ConfigNotFoundError('缺少 TSDM39 用户登录后的 Cookie 值 <a href=\"https://docs.rsshub.app/zh/deploy/config#route-specific-configurations\">TSDM 相关路由</a>');\r\n    }\r\n\r\n    const html = await ofetch(`https://www.tsdm39.com/forum.php?mod=forumdisplay&fid=85${type ? `&filter=typeid&typeid=${type}` : ''}`, {\r\n        headers: {\r\n            Cookie: cookie,\r\n        },\r\n    });\r\n\r\n    const $ = load(html);\r\n\r\n    const item = $('tbody.tsdm_normalthread')\r\n        .toArray()\r\n        .map<DataItem>((item) => {\r\n            const $ = load(item);\r\n\r\n            const title = $('a.xst').text();\r\n            const price = $('span.xw1').last().text();\r\n            const link = $('a.xst').attr('href');\r\n            const date = $('td.by em').first().text().trim();\r\n\r\n            return {\r\n                title,\r\n                description: `价格：${price}`,\r\n                link,\r\n                pubDate: parseDate(date),\r\n            };\r\n        });\r\n\r\n    return {\r\n        title: '天使动漫论坛 - BD',\r\n        link: 'https://www.tsdm39.com/forum.php?mod=forumdisplay&fid=85',\r\n        language: 'zh-Hans',\r\n        item,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/bd/:type?',\r\n    name: 'BD',\r\n    categories: ['anime'],\r\n    maintainers: ['equt'],\r\n    example: '/tsdm39/bd',\r\n    parameters: {\r\n        type: 'BD type, checkout the table below for details',\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'TSDM39_COOKIES',\r\n                optional: false,\r\n                description: '天使动漫论坛登陆后的 cookie 值，可在浏览器控制台通过 `document.cookie` 获取。',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    handler,\r\n    description: [TYPE].map((el) => mkTable(el)).join('\\n\\n'),\r\n};\r\n"],"mappings":"0VAUA,MAAMA,EAAgB,CAClB,IAAO,OACP,IAAO,QACP,IAAO,OACP,KAAQ,KACR,KAAQ,OAIN,EAAW,GAA6B,CAC1C,IAAMC,EAAoB,GACtBC,EAAsB,GACtBC,EAAiB,GAErB,IAAK,IAAM,KAAO,EACd,EAAQ,KAAK,EAAQ,IACrB,EAAU,KAAK,QACf,EAAK,KAAK,GAGd,MAAO,CAAC,EAAQ,KAAK,OAAQ,EAAU,KAAK,OAAQ,EAAK,KAAK,QAAQ,IAAK,GAAM,KAAK,EAAE,KAAK,KAAK;IAGhGC,EAA4B,KAAO,IAAQ,CAC7C,GAAM,CAAE,QAAS,EAAI,IAAI,QAEnB,EAAS,EAAO,OAAO,OAC7B,GAAI,CAAC,EACD,MAAM,IAAIC,EAAoB,4HAGlC,IAAM,EAAO,MAAMC,EAAO,2DAA2D,EAAO,yBAAyB,IAAS,KAAM,CAChI,QAAS,CACL,OAAQ,KAIV,EAAI,EAAK,GAET,EAAO,EAAE,2BACV,UACA,IAAe,GAAS,CACrB,IAAMC,EAAI,EAAKC,GAET,EAAQD,EAAE,SAAS,OACnB,EAAQA,EAAE,YAAY,OAAO,OAC7B,EAAOA,EAAE,SAAS,KAAK,QACvB,EAAOA,EAAE,YAAY,QAAQ,OAAO,OAE1C,MAAO,CACH,QACA,YAAa,MAAM,IACnB,OACA,QAAS,EAAU,MAI/B,MAAO,CACH,MAAO,cACP,KAAM,2DACN,SAAU,UACV,SAIKE,EAAe,CACxB,KAAM,aACN,KAAM,KACN,WAAY,CAAC,SACb,YAAa,CAAC,QACd,QAAS,aACT,WAAY,CACR,KAAM,iDAEV,SAAU,CACN,cAAe,CACX,CACI,KAAM,iBACN,SAAU,GACV,YAAa,yDAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,UACA,YAAa,CAAC,GAAM,IAAK,GAAO,EAAQ,IAAK,KAAK"}