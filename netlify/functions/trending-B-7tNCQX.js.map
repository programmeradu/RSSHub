{"version":3,"file":"trending-B-7tNCQX.js","names":[],"sources":["../../lib/routes/github/trending.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport { config } from '@/config';\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport { load } from 'cheerio';\r\nimport path from 'node:path';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/trending/:since/:language/:spoken_language?',\r\n    categories: ['programming'],\r\n    example: '/github/trending/daily/javascript/en',\r\n    view: ViewType.Notifications,\r\n    parameters: {\r\n        since: {\r\n            description: 'time range',\r\n            options: [\r\n                {\r\n                    value: 'daily',\r\n                    label: 'Today',\r\n                },\r\n                {\r\n                    value: 'weekly',\r\n                    label: 'This week',\r\n                },\r\n                {\r\n                    value: 'monthly',\r\n                    label: 'This month',\r\n                },\r\n            ],\r\n        },\r\n        language: {\r\n            description: \"the feed language, available in [Trending page](https://github.com/trending/javascript?since=monthly) 's URL, don't filter option is `any`\",\r\n            default: 'any',\r\n        },\r\n        spoken_language: {\r\n            description: \"natural language, available in [Trending page](https://github.com/trending/javascript?since=monthly) 's URL\",\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'GITHUB_ACCESS_TOKEN',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['github.com/trending'],\r\n            target: '/trending/:since',\r\n        },\r\n    ],\r\n    name: 'Trending',\r\n    maintainers: ['DIYgod', 'jameschensmith'],\r\n    handler,\r\n    url: 'github.com/trending',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.github || !config.github.access_token) {\r\n        throw new ConfigNotFoundError('GitHub trending RSS is disabled due to the lack of <a href=\"https://docs.rsshub.app/deploy/config#route-specific-configurations\">relevant config</a>');\r\n    }\r\n    const since = ctx.req.param('since');\r\n    const language = ctx.req.param('language') === 'any' ? '' : ctx.req.param('language');\r\n    const spoken_language = ctx.req.param('spoken_language') ?? '';\r\n\r\n    const trendingUrl = `https://github.com/trending/${encodeURIComponent(language)}?since=${since}&spoken_language_code=${spoken_language}`;\r\n    const { data: trendingPage } = await got({\r\n        method: 'get',\r\n        url: trendingUrl,\r\n        headers: {\r\n            Referer: trendingUrl,\r\n        },\r\n    });\r\n    const $ = load(trendingPage);\r\n\r\n    const articles = $('article');\r\n    const trendingRepos = articles.toArray().map((item) => {\r\n        const [owner, name] = $(item).find('h2').text().split('/');\r\n        return {\r\n            name: name.trim(),\r\n            owner: owner.trim(),\r\n        };\r\n    });\r\n\r\n    const { data: repoData } = await got({\r\n        method: 'post',\r\n        url: 'https://api.github.com/graphql',\r\n        headers: {\r\n            Authorization: `bearer ${config.github.access_token}`,\r\n        },\r\n        json: {\r\n            query: `\r\n            query {\r\n            ${trendingRepos\r\n                .map(\r\n                    (repo, index) => `\r\n                _${index}: repository(owner: \"${repo.owner}\", name: \"${repo.name}\") {\r\n                    ...RepositoryFragment\r\n                }\r\n            `\r\n                )\r\n                .join('\\n')}\r\n            }\r\n\r\n            fragment RepositoryFragment on Repository {\r\n                description\r\n                forkCount\r\n                nameWithOwner\r\n                openGraphImageUrl\r\n                primaryLanguage {\r\n                    name\r\n                }\r\n                stargazerCount\r\n            }\r\n            `,\r\n        },\r\n    });\r\n\r\n    const repos = Object.values(repoData.data).map((repo) => {\r\n        const found = trendingRepos.find((r) => `${r.owner}/${r.name}` === repo.nameWithOwner);\r\n        return { ...found, ...repo };\r\n    });\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: trendingUrl,\r\n        item: repos.map((r) => ({\r\n            title: r.nameWithOwner,\r\n            author: r.owner,\r\n            description: art(path.join(__dirname, 'templates/trending-description.art'), {\r\n                cover: r.openGraphImageUrl,\r\n                desc: r.description,\r\n                forks: r.forkCount,\r\n                lang: r.primaryLanguage?.name || 'Unknown',\r\n                stars: r.stargazerCount,\r\n            }),\r\n            link: `https://github.com/${r.nameWithOwner}`,\r\n        })),\r\n    };\r\n}\r\n"],"mappings":"yfASA,MAAa,EAAe,CACxB,KAAM,+CACN,WAAY,CAAC,eACb,QAAS,uCACT,KAAM,EAAS,cACf,WAAY,CACR,MAAO,CACH,YAAa,aACb,QAAS,CACL,CACI,MAAO,QACP,MAAO,SAEX,CACI,MAAO,SACP,MAAO,aAEX,CACI,MAAO,UACP,MAAO,gBAInB,SAAU,CACN,YAAa,6IACb,QAAS,OAEb,gBAAiB,CACb,YAAa,gHAGrB,SAAU,CACN,cAAe,CACX,CACI,KAAM,sBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,uBACT,OAAQ,qBAGhB,KAAM,WACN,YAAa,CAAC,SAAU,kBACxB,UACA,IAAK,uBAGT,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,QAAU,CAAC,EAAO,OAAO,aACjC,MAAM,IAAI,EAAoB,wJAElC,IAAM,EAAQ,EAAI,IAAI,MAAM,SACtB,EAAW,EAAI,IAAI,MAAM,cAAgB,MAAQ,GAAK,EAAI,IAAI,MAAM,YACpE,EAAkB,EAAI,IAAI,MAAM,oBAAsB,GAEtD,EAAc,+BAA+B,mBAAmB,GAAU,SAAS,EAAM,wBAAwB,IACjH,CAAE,KAAM,GAAiB,MAAM,EAAI,CACrC,OAAQ,MACR,IAAK,EACL,QAAS,CACL,QAAS,KAGX,EAAI,EAAK,GAET,EAAW,EAAE,WACb,EAAgB,EAAS,UAAU,IAAK,GAAS,CACnD,GAAM,CAAC,EAAO,GAAQ,EAAE,GAAM,KAAK,MAAM,OAAO,MAAM,KACtD,MAAO,CACH,KAAM,EAAK,OACX,MAAO,EAAM,UAIf,CAAE,KAAM,GAAa,MAAM,EAAI,CACjC,OAAQ,OACR,IAAK,iCACL,QAAS,CACL,cAAe,UAAU,EAAO,OAAO,gBAE3C,KAAM,CACF,MAAO;;cAEL,EACG,KACI,EAAM,IAAU;mBAClB,EAAM,uBAAuB,EAAK,MAAM,YAAY,EAAK,KAAK;;;eAKhE,KAAK;GAAM;;;;;;;;;;;;;iBAiBlB,EAAQ,OAAO,OAAO,EAAS,MAAM,IAAK,GAAS,CACrD,IAAM,EAAQ,EAAc,KAAM,GAAM,GAAG,EAAE,MAAM,GAAG,EAAE,SAAW,EAAK,eACxE,MAAO,CAAE,GAAG,EAAO,GAAG,KAG1B,MAAO,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM,EAAM,IAAK,IAAO,CACpB,MAAO,EAAE,cACT,OAAQ,EAAE,MACV,YAAa,EAAI,EAAA,KAAA,EAAA,+CAA4D,CACzE,MAAO,EAAE,kBACT,KAAM,EAAE,YACR,MAAO,EAAE,UACT,KAAM,EAAE,iBAAiB,MAAQ,UACjC,MAAO,EAAE,iBAEb,KAAM,sBAAsB,EAAE"}