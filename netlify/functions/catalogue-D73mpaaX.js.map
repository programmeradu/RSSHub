{"version":3,"file":"catalogue-D73mpaaX.js","names":[],"sources":["../../lib/routes/jinse/catalogue.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst categories = {\r\n    zhengce: '政策',\r\n    fenxishishuo: '行情',\r\n    defi: 'DeFi',\r\n    kuang: '矿业',\r\n    '以太坊2.0': '以太坊 2.0',\r\n    industry: '产业',\r\n    IPFS: 'IPFS',\r\n    tech: '技术',\r\n    baike: '百科',\r\n    capitalmarket: '研报',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:category?',\r\n    categories: ['finance'],\r\n    example: '/jinse/zhengce',\r\n    parameters: { category: '分类，见下表，默认为政策' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '分类',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 政策    | 行情         | DeFi | 矿业  | 以太坊 2.0 |\r\n| ------- | ------------ | ---- | ----- | ---------- |\r\n| zhengce | fenxishishuo | defi | kuang | 以太坊 2.0 |\r\n\r\n| 产业     | IPFS | 技术 | 百科  | 研报          |\r\n| -------- | ---- | ---- | ----- | ------------- |\r\n| industry | IPFS | tech | baike | capitalmarket |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'zhengce' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 50;\r\n\r\n    const rootUrl = 'https://www.jinse.cn';\r\n    const rootApiUrl = 'https://api.jinse.cn';\r\n    const apiUrl = new URL('v6/www/information/list', rootApiUrl).href;\r\n    const currentUrl = rootUrl;\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: {\r\n            catelogue_key: category,\r\n            limit,\r\n            flag: 'up',\r\n        },\r\n    });\r\n\r\n    let items = response.list.slice(0, limit).map((item) => ({\r\n        title: item.title,\r\n        link: item.extra.topic_url,\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            images:\r\n                item.extra.thumbnails_pics.length > 0\r\n                    ? item.extra.thumbnails_pics.map((p) => ({\r\n                          src: p.replace(/_[^\\W_]+(\\.\\w+)$/, '_true$1'),\r\n                      }))\r\n                    : undefined,\r\n            intro: item.extra.summary,\r\n        }),\r\n        author: item.extra.nickname,\r\n        guid: `jinse${/\\/lives\\//.test(item.extra.topic_url) ? '-lives' : ''}-${item.extra.topic_id}`,\r\n        pubDate: parseDate(item.extra.published_at, 'X'),\r\n        upvotes: item.extra.up_counts ?? 0,\r\n        downvotes: item.extra.down_counts ?? 0,\r\n        comments: item.extra.comment_count ?? 0,\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                if (/\\/lives\\//.test(item.link)) {\r\n                    return item;\r\n                }\r\n\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                item.description += art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: content('section.js-article-content').html() || content('div.js-article').html(),\r\n                });\r\n                item.category = content('section.js-article-tag_state_1 a span')\r\n                    .toArray()\r\n                    .map((c) => content(c).text());\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const author = $('meta[name=\"author\"]').prop('content');\r\n    const image = $('a.js-logoBox img').prop('src');\r\n    const icon = new URL($('link[rel=\"favicon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: `${author} - ${Object.hasOwn(categories, category) ? categories[category] : category}`,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"keywords\"]').prop('content'),\r\n        author,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAM,EAAa,CACf,QAAS,KACT,aAAc,KACd,KAAM,OACN,MAAO,KACP,SAAU,UACV,SAAU,KACV,KAAM,OACN,KAAM,KACN,MAAO,KACP,cAAe,MAGN,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,WACb,QAAS,iBACT,WAAY,CAAE,SAAU,gBACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,WACd,UACA,YAAa;;;;;;qDASjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,WAAc,EAAI,IAAI,QACnC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,uBAEV,EAAS,IAAI,IAAI,0BAA2B,wBAAY,KACxD,EAAa,EAEb,CAAE,KAAM,GAAa,MAAM,EAAI,EAAQ,CACzC,aAAc,CACV,cAAe,EACf,QACA,KAAM,QAIV,EAAQ,EAAS,KAAK,MAAM,EAAG,GAAO,IAAK,IAAU,CACrD,MAAO,EAAK,MACZ,KAAM,EAAK,MAAM,UACjB,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,OACI,EAAK,MAAM,gBAAgB,OAAS,EAC9B,EAAK,MAAM,gBAAgB,IAAK,IAAO,CACnC,IAAK,EAAE,QAAQ,mBAAoB,cAEvC,IAAA,GACV,MAAO,EAAK,MAAM,UAEtB,OAAQ,EAAK,MAAM,SACnB,KAAM,QAAQ,YAAY,KAAK,EAAK,MAAM,WAAa,SAAW,GAAG,GAAG,EAAK,MAAM,WACnF,QAAS,EAAU,EAAK,MAAM,aAAc,KAC5C,QAAS,EAAK,MAAM,WAAa,EACjC,UAAW,EAAK,MAAM,aAAe,EACrC,SAAU,EAAK,MAAM,eAAiB,KAG1C,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,YAAY,KAAK,EAAK,MACtB,OAAO,EAGX,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GASrB,MAPA,GAAK,aAAe,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACvE,YAAa,EAAQ,8BAA8B,QAAU,EAAQ,kBAAkB,SAE3F,EAAK,SAAW,EAAQ,yCACnB,UACA,IAAK,GAAM,EAAQ,GAAG,QAEpB,MAKnB,GAAM,CAAE,KAAM,GAAoB,MAAM,EAAI,GAEtC,EAAI,EAAK,GAET,EAAS,EAAE,uBAAuB,KAAK,WACvC,EAAQ,EAAE,oBAAoB,KAAK,OACnC,EAAO,IAAI,IAAI,EAAE,uBAAuB,KAAK,QAAS,GAAS,KAErE,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAO,KAAK,OAAO,OAAO,EAAY,GAAY,EAAW,GAAY,IACnF,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,EAAE,QAAQ,KAAK,QACzB,QACA,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,SACA,WAAY"}