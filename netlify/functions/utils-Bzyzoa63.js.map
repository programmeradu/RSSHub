{"version":3,"file":"utils-Bzyzoa63.js","names":[],"sources":["../../lib/routes/skeb/utils.ts"],"sourcesContent":["import { config } from '@/config';\r\nimport { DataItem } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const baseUrl = 'https://skeb.jp';\r\n\r\ninterface Work {\r\n    path: string;\r\n    private_thumbnail_image_urls: null | string;\r\n    private: boolean;\r\n    genre: string;\r\n    tipped: boolean;\r\n    creator_id: number;\r\n    client_id: number;\r\n    vtt_url: null | string;\r\n    thumbnail_image_urls: {\r\n        src: string;\r\n        srcset: string;\r\n    };\r\n    preview_url: null | string;\r\n    duration: null | number;\r\n    nsfw: boolean;\r\n    hardcore: boolean;\r\n    consored_thumbnail_image_urls: {\r\n        src: string;\r\n        srcset: string;\r\n    };\r\n    body: string;\r\n    nc: number;\r\n    word_count: number;\r\n    transcoder: string;\r\n    creator_acceptable_same_genre: boolean;\r\n}\r\n\r\ninterface Creator {\r\n    id: number;\r\n    creator: boolean;\r\n    nsfw_acceptable: boolean;\r\n    acceptable: boolean;\r\n    name: string;\r\n    screen_name: string;\r\n    avatar_url: string;\r\n    header_url: string | null;\r\n    appeal_receivable: boolean;\r\n    popular_creator_rank: number | null;\r\n    request_master_rank: number | null;\r\n    first_requester_rank: number | null;\r\n    deleted_at: string | null;\r\n    tip_acceptable_by: string;\r\n    accept_expiration_days: number;\r\n    skills: { genre: string }[];\r\n    nc: number;\r\n}\r\n\r\nexport function processWork(work: Work): DataItem | null {\r\n    if (!work || typeof work !== 'object' || work.private === true) {\r\n        return null;\r\n    }\r\n\r\n    const imageUrl = work.thumbnail_image_urls?.srcset?.split(',').pop()?.trim().split(' ')[0] || '';\r\n    const body = work.body || '';\r\n\r\n    const audioUrl = work.genre === 'music' || work.genre === 'voice' ? work.preview_url : null;\r\n\r\n    const renderedHtml = art(path.join(__dirname, 'templates/work.art'), {\r\n        imageUrl,\r\n        body,\r\n        audioUrl,\r\n    });\r\n\r\n    return {\r\n        title: work.path || '',\r\n        link: `${baseUrl}${work.path || ''}`,\r\n        description: renderedHtml,\r\n    };\r\n}\r\n\r\nconst skillMap = {\r\n    art: 'Illust',\r\n    voice: 'Voice',\r\n    novel: 'Novel',\r\n    video: 'Video',\r\n    music: 'Music',\r\n    correction: 'Advice',\r\n    comic: 'Comic',\r\n};\r\n\r\nexport function processCreator(creator: Creator): DataItem | null {\r\n    if (!creator || typeof creator !== 'object') {\r\n        return null;\r\n    }\r\n\r\n    const avatarUrl = creator.avatar_url || '';\r\n\r\n    let renderedHtml;\r\n\r\n    if (creator.creator) {\r\n        const acceptingCommissions = creator.acceptable ? 'Yes' : 'No';\r\n        const nsfwAcceptable = creator.nsfw_acceptable ? 'Yes' : 'No';\r\n\r\n        let skills = '';\r\n        if (Array.isArray(creator.skills) && creator.skills.length > 0) {\r\n            skills = creator.skills\r\n                .map((skill) => skillMap[skill.genre] || skill.genre)\r\n                .filter(Boolean)\r\n                .join(', ');\r\n        }\r\n\r\n        renderedHtml = art(path.join(__dirname, 'templates/creator.art'), {\r\n            avatarUrl,\r\n            acceptingCommissions,\r\n            nsfwAcceptable,\r\n            skills,\r\n        });\r\n    }\r\n\r\n    return {\r\n        title: creator.name || '',\r\n        link: `${baseUrl}/@${creator.screen_name || ''}`,\r\n        description: renderedHtml,\r\n    };\r\n}\r\n\r\nexport async function getFollowingsItems(username: string, path: 'friend_works' | 'following_works' | 'following_creators'): Promise<DataItem[]> {\r\n    const url = `${baseUrl}/api/users/${username.replace('@', '')}/followings`;\r\n\r\n    const followings_data = await cache.tryGet(\r\n        `skeb:followings_data:${username}`,\r\n        async () => {\r\n            const data = await ofetch(url, {\r\n                headers: {\r\n                    Authorization: `Bearer ${config.skeb.bearerToken}`,\r\n                },\r\n            });\r\n            return data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    if (!followings_data || typeof followings_data !== 'object') {\r\n        throw new Error('Failed to fetch followings data');\r\n    }\r\n\r\n    if (path === 'following_creators') {\r\n        return followings_data[path].map((item) => processCreator(item)).filter(Boolean) as DataItem[];\r\n    }\r\n    return followings_data[path].map((item) => processWork(item)).filter(Boolean) as DataItem[];\r\n}\r\n"],"mappings":"wSAOA,MAAa,EAAU,kBAkDvB,SAAgB,EAAY,EAA6B,CACrD,GAAI,CAAC,GAAQ,OAAO,GAAS,UAAY,EAAK,UAAY,GACtD,OAAO,KAGX,IAAM,EAAW,EAAK,sBAAsB,QAAQ,MAAM,KAAK,OAAO,OAAO,MAAM,KAAK,IAAM,GACxF,EAAO,EAAK,MAAQ,GAEpB,EAAW,EAAK,QAAU,SAAW,EAAK,QAAU,QAAU,EAAK,YAAc,KAEjF,EAAe,EAAI,EAAA,KAAA,EAAA,+BAA4C,CACjE,WACA,OACA,aAGJ,MAAO,CACH,MAAO,EAAK,MAAQ,GACpB,KAAM,GAAG,IAAU,EAAK,MAAQ,KAChC,YAAa,GAIrB,MAAM,EAAW,CACb,IAAK,SACL,MAAO,QACP,MAAO,QACP,MAAO,QACP,MAAO,QACP,WAAY,SACZ,MAAO,SAGX,SAAgB,EAAe,EAAmC,CAC9D,GAAI,CAAC,GAAW,OAAO,GAAY,SAC/B,OAAO,KAGX,IAAM,EAAY,EAAQ,YAAc,GAEpC,EAEJ,GAAI,EAAQ,QAAS,CACjB,IAAM,EAAuB,EAAQ,WAAa,MAAQ,KACpD,EAAiB,EAAQ,gBAAkB,MAAQ,KAErD,EAAS,GACT,MAAM,QAAQ,EAAQ,SAAW,EAAQ,OAAO,OAAS,IACzD,EAAS,EAAQ,OACZ,IAAK,GAAU,EAAS,EAAM,QAAU,EAAM,OAC9C,OAAO,SACP,KAAK,OAGd,EAAe,EAAI,EAAA,KAAA,EAAA,kCAA+C,CAC9D,YACA,uBACA,iBACA,WAIR,MAAO,CACH,MAAO,EAAQ,MAAQ,GACvB,KAAM,GAAG,EAAQ,IAAI,EAAQ,aAAe,KAC5C,YAAa,GAIrB,eAAsB,EAAmB,EAAkB,EAAsF,CAC7I,IAAM,EAAM,GAAG,EAAQ,aAAa,EAAS,QAAQ,IAAK,IAAI,aAExD,EAAkB,MAAM,EAAM,OAChC,wBAAwB,IACxB,SAAY,CACR,IAAM,EAAO,MAAM,EAAO,EAAK,CAC3B,QAAS,CACL,cAAe,UAAU,EAAO,KAAK,iBAG7C,OAAO,GAEX,EAAO,MAAM,YACb,IAGJ,GAAI,CAAC,GAAmB,OAAO,GAAoB,SAC/C,MAAU,MAAM,mCAMpB,OAHI,IAAS,qBACF,EAAgB,GAAM,IAAK,GAAS,EAAe,IAAO,OAAO,SAErE,EAAgB,GAAM,IAAK,GAAS,EAAY,IAAO,OAAO"}