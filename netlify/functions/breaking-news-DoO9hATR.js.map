{"version":3,"file":"breaking-news-DoO9hATR.js","names":[],"sources":["../../lib/routes/udn/breaking-news.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { load } from 'cheerio';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/news/breakingnews/:id',\r\n    categories: ['traditional-media'],\r\n    example: '/udn/news/breakingnews/99',\r\n    parameters: { id: '类别' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['udn.com/news/breaknews/1/:id', 'udn.com/'],\r\n        },\r\n    ],\r\n    name: '即時新聞',\r\n    maintainers: ['miles170'],\r\n    handler,\r\n    description: `| 0    | 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    | 9    | 11   | 12   | 13   | 99     |\r\n| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ------ |\r\n| 精選 | 要聞 | 社會 | 地方 | 兩岸 | 國際 | 財經 | 運動 | 娛樂 | 生活 | 股市 | 文教 | 數位 | 不分類 |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const link = `/news/breaknews/1/${id}#breaknews`;\r\n    const name = await getLinkName(link);\r\n    const rootUrl = 'https://udn.com';\r\n    const response = await got(`${rootUrl}/api/more?page=1&channelId=1&cate_id=${id}&type=breaknews`);\r\n\r\n    const items = await Promise.all(\r\n        response.data.lists.map((item) => {\r\n            let link = item.titleLink.startsWith('http') ? item.titleLink : `${rootUrl}${item.titleLink}`;\r\n            const linkUrl = new URL(link);\r\n            // cleanup query paramter\r\n            linkUrl.query = linkUrl.search = '';\r\n            link = linkUrl.toString();\r\n\r\n            return cache.tryGet(link, async () => {\r\n                let result = await got(link);\r\n                // VIP article requires redirection\r\n                // e.g. https://udn.com/news/story/7331/6576320\r\n                const vip = result.data.match(/<script language=javascript>window\\.location\\.href=\"(https?:\\/\\/[^\"]+)\"/);\r\n                if (vip) {\r\n                    result = await got(vip[1]);\r\n                }\r\n\r\n                const $ = load(result.data);\r\n                const metadata = $('script[type=\"application/ld+json\"]')\r\n                    .eq(0)\r\n                    .text()\r\n                    .trim()\r\n                    .replaceAll(/[\\b\\t\\n]/g, '');\r\n                const data = metadata.startsWith('[') ? JSON.parse(metadata)[0] : JSON.parse(metadata);\r\n                // e.g. https://udn.com/news/story/7331/6576320\r\n                const content = $('.article-content__editor');\r\n                // e.g. https://udn.com/news/story/7240/6576424\r\n                const body = $('.article-body__editor');\r\n\r\n                let description = '';\r\n                if (data.image) {\r\n                    description += art(path.join(__dirname, 'templates/figure.art'), {\r\n                        src: data.image.contentUrl,\r\n                        alt: data.image.name,\r\n                    });\r\n                }\r\n                if (content.length) {\r\n                    description += content.html();\r\n                } else if (body.length) {\r\n                    description += body.html();\r\n                }\r\n\r\n                if (data.publisher.name.includes('轉角國際 udn Global')) {\r\n                    // 轉角24小時\r\n                    description = $('.story_body_content')\r\n                        .html()\r\n                        .split(/<!--\\d+?-->/g)\r\n                        .slice(1, -1)\r\n                        .join('');\r\n                }\r\n\r\n                return {\r\n                    title: item.title,\r\n                    author: [{ name: $('.article-content__author').text().match('中央社')?.at(0) }, { name: data.publisher.name.match('轉角國際 udn Global')?.at(0) }, data.author].filter((e) => Boolean(e.name)),\r\n                    description,\r\n                    pubDate: timezone(parseDate(item.time.date, 'YYYY-MM-DD HH:mm'), +8),\r\n                    category: [data.articleSection, vip ? $('.article-head li.breadcrumb__item:last > b').text() : $(\"meta[name='subsection']\").attr('content'), ...data.keywords.split(',')],\r\n                    link,\r\n                };\r\n            });\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `即時${name} - 聯合新聞網`,\r\n        link: `${rootUrl}${link}`,\r\n        description: 'udn.com 提供即時新聞以及豐富的政治、社會、地方、兩岸、國際、財經、數位、運動、NBA、娛樂、生活、健康、旅遊新聞，以最即時、多元的內容，滿足行動世代的需求',\r\n        item: items,\r\n    };\r\n}\r\n\r\nconst getLinkName = async (link) => {\r\n    const url = 'https://udn.com/news/breaknews';\r\n    const links = await cache.tryGet(url, async () => {\r\n        const result = await got(url);\r\n        const $ = load(result.data);\r\n        const data = $('.cate-list__subheader a')\r\n            .toArray()\r\n            .map((item) => {\r\n                item = $(item);\r\n                return [item.attr('href'), item.text().trim()];\r\n            });\r\n        return Object.fromEntries(data);\r\n    });\r\n    if (link in links) {\r\n        return links[link];\r\n    }\r\n    return '列表';\r\n};\r\n"],"mappings":"0gBAUA,MAAa,EAAe,CACxB,KAAM,yBACN,WAAY,CAAC,qBACb,QAAS,4BACT,WAAY,CAAE,GAAI,MAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,+BAAgC,cAGjD,KAAM,OACN,YAAa,CAAC,YACd,UACA,YAAa;;2EAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAO,qBAAqB,EAAG,YAC/B,EAAO,MAAM,EAAY,GACzB,EAAU,kBACV,EAAW,MAAM,EAAI,GAAG,EAAQ,uCAAuC,EAAG,kBAE1E,EAAQ,MAAM,QAAQ,IACxB,EAAS,KAAK,MAAM,IAAK,GAAS,CAC9B,IAAI,EAAO,EAAK,UAAU,WAAW,QAAU,EAAK,UAAY,GAAG,IAAU,EAAK,YAC5E,EAAU,IAAI,IAAI,GAKxB,MAHA,GAAQ,MAAQ,EAAQ,OAAS,GACjC,EAAO,EAAQ,WAER,EAAM,OAAO,EAAM,SAAY,CAClC,IAAI,EAAS,MAAM,EAAI,GAGjB,EAAM,EAAO,KAAK,MAAM,2EAC1B,IACA,EAAS,MAAM,EAAI,EAAI,KAG3B,IAAM,EAAI,EAAK,EAAO,MAChB,EAAW,EAAE,sCACd,GAAG,GACH,OACA,OACA,WAAW,YAAa,IACvB,EAAO,EAAS,WAAW,KAAO,KAAK,MAAM,GAAU,GAAK,KAAK,MAAM,GAEvE,EAAU,EAAE,4BAEZ,EAAO,EAAE,yBAEX,EAAc,GAsBlB,OArBI,EAAK,QACL,GAAe,EAAI,EAAA,KAAA,EAAA,iCAA8C,CAC7D,IAAK,EAAK,MAAM,WAChB,IAAK,EAAK,MAAM,QAGpB,EAAQ,OACR,GAAe,EAAQ,OAChB,EAAK,SACZ,GAAe,EAAK,QAGpB,EAAK,UAAU,KAAK,SAAS,qBAE7B,EAAc,EAAE,uBACX,OACA,MAAM,gBACN,MAAM,EAAG,IACT,KAAK,KAGP,CACH,MAAO,EAAK,MACZ,OAAQ,CAAC,CAAE,KAAM,EAAE,4BAA4B,OAAO,MAAM,QAAQ,GAAG,IAAM,CAAE,KAAM,EAAK,UAAU,KAAK,MAAM,oBAAoB,GAAG,IAAM,EAAK,QAAQ,OAAQ,GAAM,EAAQ,EAAE,MACjL,cACA,QAAS,EAAS,EAAU,EAAK,KAAK,KAAM,oBAAqB,GACjE,SAAU,CAAC,EAAK,eAAgB,EAAM,EAAE,8CAA8C,OAAS,EAAE,2BAA2B,KAAK,WAAY,GAAG,EAAK,SAAS,MAAM,MACpK,KAAA,QAMhB,MAAO,CACH,MAAO,KAAK,EAAK,UACjB,KAAM,GAAG,IAAU,IACnB,YAAa,oFACb,KAAM,GAId,MAAM,EAAc,KAAO,IAAS,CAChC,IAAM,EAAM,iCACN,EAAQ,MAAM,EAAM,OAAO,EAAK,SAAY,CAC9C,IAAM,EAAS,MAAM,EAAI,GACnB,EAAI,EAAK,EAAO,MAChB,EAAO,EAAE,2BACV,UACA,IAAK,IACF,EAAO,EAAE,GACF,CAAC,EAAK,KAAK,QAAS,EAAK,OAAO,UAE/C,OAAO,OAAO,YAAY,KAK9B,OAHI,KAAQ,EACD,EAAM,GAEV"}