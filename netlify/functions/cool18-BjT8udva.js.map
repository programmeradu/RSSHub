{"version":3,"file":"cool18-BjT8udva.js","names":["route: Route","ofetch","cache"],"sources":["../../lib/routes/cool18/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport type { Context } from 'hono';\r\nimport ofetch from '@/utils/ofetch';\r\n\r\ntype PageDataItem = {\r\n    tid: string;\r\n    username: string;\r\n    subject: string;\r\n    dateline: string;\r\n    type: string;\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:id?/:type?/:keyword?',\r\n    url: 'cool18.com',\r\n    example: 'cool18.com/bbs4',\r\n    parameters: {\r\n        id: 'the name of the bbs',\r\n        type: 'the type of the post. Can be `home`, `gold` or `threadsearch`. Default: `home`',\r\n        keyword: 'the keyword to search.',\r\n        pageSize: 'the number of posts to fetch. If the type is not in search, you can type any words. Default: 10',\r\n    },\r\n    categories: ['bbs'],\r\n    radar: [\r\n        {\r\n            source: ['cool18.com/:id/'],\r\n            target: '/:id/:type?/:keyword?',\r\n        },\r\n    ],\r\n    name: '禁忌书屋',\r\n    maintainers: ['nczitzk', 'Gabrlie'],\r\n    handler,\r\n    features: {\r\n        nsfw: true,\r\n    },\r\n};\r\n\r\nasync function handler(ctx: Context) {\r\n    const { id = 'bbs4', type = 'home', keyword } = ctx.req.param();\r\n\r\n    const rootUrl = 'https://www.cool18.com/' + id + '/index.php';\r\n    const params = type === 'home' ? '' : type === 'gold' ? '?app=forum&act=gold' : `?action=search&act=threadsearch&app=forum&keywords=${keyword}&submit=查询`;\r\n\r\n    const currentUrl = rootUrl + params;\r\n\r\n    const response = await ofetch(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(<string>ctx.req.query('limit')) : 20;\r\n\r\n    const list =\r\n        type === 'home'\r\n            ? JSON.parse(\r\n                  $('script:contains(\"_PageData\")')\r\n                      .text()\r\n                      .match(/const\\s+_PageData\\s*=\\s*(\\[[\\s\\S]*?]);/)?.[1] || '[]'\r\n              )\r\n                  .slice(0, limit)\r\n                  .map((item: PageDataItem) => ({\r\n                      title: item.subject,\r\n                      link: `${rootUrl}?app=forum&act=threadview&tid=${item.tid}`,\r\n                      pubDate: parseDate(item.dateline, 'MM/DD/YY'),\r\n                      author: item.username,\r\n                      category: item.type,\r\n                      description: '',\r\n                  }))\r\n            : $('#d_list ul li, #thread_list li, .t_l .t_subject')\r\n                  .slice(0, limit)\r\n                  .toArray()\r\n                  .map((item) => {\r\n                      const a = $(item).find('a').first();\r\n                      return {\r\n                          title: a.text(),\r\n                          link: `${rootUrl}/${a.attr('href')}`,\r\n                          pubDate: parseDate($(item).find('i').text(), 'MM/DD/YY'),\r\n                          author: $(item).find('a').last().text(),\r\n                          category: a.find('span').first().text(),\r\n                          description: '',\r\n                      };\r\n                  });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await ofetch(item.link);\r\n\r\n                const content = load(detailResponse);\r\n                const preElement = content('pre');\r\n                if (preElement.length > 0) {\r\n                    const htmlContent = preElement.html();\r\n                    item.description = htmlContent ? htmlContent.replaceAll(/<font color=\"#E6E6DD\">cool18.com<\\/font>/g, '') : '';\r\n                }\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"mTAeA,MAAaA,EAAe,CACxB,KAAM,yBACN,IAAK,aACL,QAAS,kBACT,WAAY,CACR,GAAI,sBACJ,KAAM,iFACN,QAAS,yBACT,SAAU,mGAEd,WAAY,CAAC,OACb,MAAO,CACH,CACI,OAAQ,CAAC,mBACT,OAAQ,0BAGhB,KAAM,OACN,YAAa,CAAC,UAAW,WACzB,UACA,SAAU,CACN,KAAM,KAId,eAAe,EAAQ,EAAc,CACjC,GAAM,CAAE,KAAK,OAAQ,OAAO,OAAQ,WAAY,EAAI,IAAI,QAElD,EAAU,0BAA4B,EAAK,aAC3C,EAAS,IAAS,OAAS,GAAK,IAAS,OAAS,sBAAwB,sDAAsD,EAAQ,YAExI,EAAa,EAAU,EAEvB,EAAW,MAAMC,EAAO,GAExB,EAAI,EAAK,GAET,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAiB,EAAI,IAAI,MAAM,UAAY,GAEnF,EACF,IAAS,OACH,KAAK,MACD,EAAE,gCACG,OACA,MAAM,4CAA4C,IAAM,MAE5D,MAAM,EAAG,GACT,IAAK,IAAwB,CAC1B,MAAO,EAAK,QACZ,KAAM,GAAG,EAAQ,gCAAgC,EAAK,MACtD,QAAS,EAAU,EAAK,SAAU,YAClC,OAAQ,EAAK,SACb,SAAU,EAAK,KACf,YAAa,MAErB,EAAE,mDACG,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,IAAM,EAAI,EAAE,GAAM,KAAK,KAAK,QAC5B,MAAO,CACH,MAAO,EAAE,OACT,KAAM,GAAG,EAAQ,GAAG,EAAE,KAAK,UAC3B,QAAS,EAAU,EAAE,GAAM,KAAK,KAAK,OAAQ,YAC7C,OAAQ,EAAE,GAAM,KAAK,KAAK,OAAO,OACjC,SAAU,EAAE,KAAK,QAAQ,QAAQ,OACjC,YAAa,MAI7B,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAMD,EAAO,EAAK,MAEnC,EAAU,EAAK,GACf,EAAa,EAAQ,OAC3B,GAAI,EAAW,OAAS,EAAG,CACvB,IAAM,EAAc,EAAW,OAC/B,EAAK,YAAc,EAAc,EAAY,WAAW,4CAA6C,IAAM,GAE/G,OAAO,MAKnB,MAAO,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM"}