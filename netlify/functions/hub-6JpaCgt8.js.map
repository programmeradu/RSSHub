{"version":3,"file":"hub-6JpaCgt8.js","names":["route: Route","tag","InvalidParameterError","ofetch","cache","response"],"sources":["../../lib/routes/baai/hub.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\n\r\nimport { baseUrl, apiHost, getTagsData, parseEventDetail, parseItem } from './utils';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: ['/hub/:tagId?/:sort?/:range?'],\r\n    categories: ['programming'],\r\n    example: '/baai/hub',\r\n    parameters: {\r\n        tagId: '社群 ID，可在 [社群页](https://hub.baai.ac.cn/taglist) 或 URL 中找到',\r\n        sort: '排序，见下表，默认为 `new`',\r\n        range: '时间跨度，仅在排序 `readCnt` 时有效',\r\n    },\r\n    description: `排序\r\n\r\n| 最新 | 最热    |\r\n| ---- | ------- |\r\n| new  | readCnt |\r\n\r\n时间跨度\r\n\r\n| 3 天 | 本周 | 本月 |\r\n| ---- | ---- | ---- |\r\n| 3    | 7    | 30   |`,\r\n    radar: [\r\n        {\r\n            source: ['baai.ac.cn/'],\r\n            target: (_params, url) => {\r\n                const searchParams = new URL(url).searchParams;\r\n                const tagId = searchParams.get('tag_id');\r\n                const sort = searchParams.get('sort');\r\n                const range = searchParams.get('time_range');\r\n                return `/baai/hub${tagId ? `/${tagId}` : ''}${sort ? `/${sort}` : ''}${range ? `/${range}` : ''}`;\r\n            },\r\n        },\r\n    ],\r\n    name: '智源社区',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { tagId = '', sort = 'new', range } = ctx.req.param();\r\n\r\n    let title, description, brief, iconUrl;\r\n    if (tagId) {\r\n        const tagsData = await getTagsData();\r\n\r\n        const tag = (tagsData as Record<string, string>[]).find((tag) => tag.id === tagId);\r\n        if (tag) {\r\n            title = tag.title;\r\n            description = tag.description;\r\n            brief = tag.brief;\r\n            iconUrl = tag.iconUrl;\r\n        } else {\r\n            throw new InvalidParameterError('Tag not found');\r\n        }\r\n    }\r\n\r\n    const response = await ofetch(`${apiHost}/api/v1/story/list`, {\r\n        method: 'POST',\r\n        query: {\r\n            page: 1,\r\n            sort,\r\n            tag_id: tagId,\r\n            time_range: range,\r\n        },\r\n    });\r\n\r\n    const list = response.data.map((item) => parseItem(item));\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                if (item.eventId) {\r\n                    item.description = await parseEventDetail(item);\r\n                } else {\r\n                    const response = await ofetch(item.link);\r\n                    const $ = load(response);\r\n                    item.description = item.is_event ? $('div.box2').html() : $('.post-content').html();\r\n                }\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${title ? `${title} - ` : ''}${description ? `${description} - ` : ''}智源社区`,\r\n        description: brief,\r\n        link: `${baseUrl}/?${tagId ? `tag_id=${tagId}&` : ''}sort=${sort}${range ? `&time_range=${range}` : ''}`,\r\n        image: iconUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"2fAQA,MAAaA,EAAe,CACxB,KAAM,CAAC,+BACP,WAAY,CAAC,eACb,QAAS,YACT,WAAY,CACR,MAAO,2DACP,KAAM,mBACN,MAAO,2BAEX,YAAa;;;;;;;;;;wBAWb,MAAO,CACH,CACI,OAAQ,CAAC,eACT,QAAS,EAAS,IAAQ,CACtB,IAAM,EAAe,IAAI,IAAI,GAAK,aAC5B,EAAQ,EAAa,IAAI,UACzB,EAAO,EAAa,IAAI,QACxB,EAAQ,EAAa,IAAI,cAC/B,MAAO,YAAY,EAAQ,IAAI,IAAU,KAAK,EAAO,IAAI,IAAS,KAAK,EAAQ,IAAI,IAAU,QAIzG,KAAM,OACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,QAAQ,GAAI,OAAO,MAAO,SAAU,EAAI,IAAI,QAEhD,EAAO,EAAa,EAAO,EAC/B,GAAI,EAAO,CACP,IAAM,EAAW,MAAM,IAEjB,EAAO,EAAsC,KAAM,GAAQC,EAAI,KAAO,GAC5E,GAAI,EACA,EAAQ,EAAI,MACZ,EAAc,EAAI,YAClB,EAAQ,EAAI,MACZ,EAAU,EAAI,aAEd,MAAM,IAAIC,EAAsB,iBAIxC,IAAM,EAAW,MAAMC,EAAO,GAAG,EAAQ,oBAAqB,CAC1D,OAAQ,OACR,MAAO,CACH,KAAM,EACN,OACA,OAAQ,EACR,WAAY,KAId,EAAO,EAAS,KAAK,IAAK,GAAS,EAAU,IAE7C,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,EAAK,QACL,EAAK,YAAc,MAAM,EAAiB,OACvC,CACH,IAAMC,EAAW,MAAMF,EAAO,EAAK,MAC7B,EAAI,EAAKE,GACf,EAAK,YAAc,EAAK,SAAW,EAAE,YAAY,OAAS,EAAE,iBAAiB,OAEjF,OAAO,MAKnB,MAAO,CACH,MAAO,GAAG,EAAQ,GAAG,EAAM,KAAO,KAAK,EAAc,GAAG,EAAY,KAAO,GAAG,MAC9E,YAAa,EACb,KAAM,GAAG,EAAQ,IAAI,EAAQ,UAAU,EAAM,GAAK,GAAG,OAAO,IAAO,EAAQ,eAAe,IAAU,KACpG,MAAO,EACP,KAAM"}