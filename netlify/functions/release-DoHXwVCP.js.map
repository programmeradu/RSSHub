{"version":3,"file":"release-DoHXwVCP.js","names":[],"sources":["../../lib/routes/app-center/release.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport MarkdownIt from 'markdown-it';\r\n\r\nexport const route: Route = {\r\n    path: '/release/:user/:app/:distribution_group',\r\n    categories: ['program-update'],\r\n    example: '/app-center/release/cloudflare/1.1.1.1-windows/beta',\r\n    parameters: { user: 'User', app: 'App name', distribution_group: 'Distribution group' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['install.appcenter.ms/users/:user/apps/:app/distribution_groups/:distribution_group', 'install.appcenter.ms/orgs/:user/apps/:app/distribution_groups/:distribution_group'],\r\n        },\r\n    ],\r\n    name: 'Release',\r\n    maintainers: ['Rongronggg9'],\r\n    handler,\r\n    description: `::: tip\r\n  The parameters can be extracted from the Release page URL: \\`https://install.appcenter.ms/users/:user/apps/:app/distribution_groups/:distribution_group\\`\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const user = ctx.req.param('user');\r\n    const app = ctx.req.param('app');\r\n    const distribution_group = ctx.req.param('distribution_group');\r\n\r\n    const baseUrl = 'https://install.appcenter.ms/api/v0.1/apps';\r\n    const apiUrl = `${baseUrl}/${user}/${app}/distribution_groups/${distribution_group}`;\r\n    const releasesListUrl = `${apiUrl}/public_releases?scope=tester`;\r\n    // const releaseUrl = `${apiUrl}/releases/${release_id}?is_install_page=true`;\r\n    const link = `https://install.appcenter.ms/users/${user}/apps/${app}/distribution_groups/${distribution_group}`;\r\n\r\n    const response = await got(releasesListUrl);\r\n    let items = response.data.map((item) => ({\r\n        // item:\r\n        // {\r\n        //     \"id\": 504,\r\n        //     \"short_version\": \"8.5.0.0\",\r\n        //     \"version\": \"18558\",\r\n        //     \"origin\": \"appcenter\",\r\n        //     \"uploaded_at\": \"2022-02-02T11:36:06.044Z\",\r\n        //     \"mandatory_update\": false,\r\n        //     \"enabled\": true,\r\n        //     \"is_external_build\": false\r\n        // }\r\n\r\n        pubDate: parseDate(item.uploaded_at),\r\n        link: `${apiUrl}/releases/${item.id}?is_install_page=true`,\r\n    }));\r\n\r\n    // Release info examples:\r\n    // Android: https://install.appcenter.ms/api/v0.1/apps/rafalense-70ux/plus-release/distribution_groups/public/releases/42?is_install_page=true\r\n    // iOS: https://install.appcenter.ms/api/v0.1/apps/gameonline/baitomobile/distribution_groups/baito/releases/26?is_install_page=true\r\n    // Windows: https://install.appcenter.ms/api/v0.1/apps/remitano/remitano-windows/distribution_groups/beta/releases/5?is_install_page=true\r\n    // macOS: https://install.appcenter.ms/api/v0.1/apps/rdmacios-k2vy/microsoft-remote-desktop-for-mac/distribution_groups/all-users-of-microsoft-remote-desktop-for-mac/releases/635?is_install_page=true\r\n\r\n    const md = new MarkdownIt();\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const releaseResponse = await got(item.link);\r\n                const releaseInfo = releaseResponse.data;\r\n\r\n                const userName = releaseInfo.owner.display_name;\r\n                const appOS = releaseInfo.app_os;\r\n                const shortVersion = releaseInfo.short_version; // will be an empty string for Windows\r\n                const versionCode = releaseInfo.version;\r\n                const isExternalBuild = releaseInfo.is_external_build;\r\n                const isMandatoryUpdate = releaseInfo.mandatory_update;\r\n                // const isLatest = releaseInfo.is_latest;  // this is not representing the latest release, but the latest version of a certain release\r\n                const sizeInMBytes = (releaseInfo.size / (1024 * 1024)).toFixed(2);\r\n                const releaseDate = releaseInfo.uploaded_at; // use original text here because it is already an ISO 8601 time\r\n                const fingerprint = releaseInfo.fingerprint;\r\n                const minOS = releaseInfo.min_os; // `null` for Windows\r\n                const androidMinApiLevel = releaseInfo.android_min_api_level; // only for Android\r\n                const deviceFamily = releaseInfo.device_family; // only for iOS, `null` for others\r\n                const bundleId = releaseInfo.bundle_identifier; // can be a hash or a package name\r\n                const releaseNotes = releaseInfo.release_notes; // markdown, can be an empty string\r\n                const downloadUrl = releaseInfo.download_url;\r\n                const installUrl = releaseInfo.install_url;\r\n                const fileExtension = releaseInfo.fileExtension;\r\n\r\n                // workaround: cache feed title and icon\r\n                const appName = releaseInfo.app_display_name;\r\n                const distributionGroupId = releaseInfo.distribution_group_id;\r\n                const distributionGroupName = releaseInfo.distribution_groups.find((group) => group.id === distributionGroupId).display_name;\r\n                item._feed_title = `${appName} (${distributionGroupName}) for ${appOS} by ${userName} - App Center Releases`;\r\n                item._feed_icon = releaseInfo.app_icon_url;\r\n\r\n                const version = shortVersion && versionCode ? `${shortVersion} (${versionCode})` : shortVersion || versionCode;\r\n\r\n                item.title =\r\n                    `${appName}: ` +\r\n                    (isMandatoryUpdate ? '[Mandatory]' : '') +\r\n                    // + (isLatest ? \"[Latest]\" : \"\")\r\n                    (isExternalBuild ? '[External Build]' : '') +\r\n                    `Version ${version}`;\r\n                item.link = link; // replace the link with the release page\r\n                item.author = userName;\r\n                item.description = art(\r\n                    path.join(__dirname, 'templates/description.art'),\r\n                    {\r\n                        releaseDate,\r\n                        sizeInMBytes,\r\n                        minOS,\r\n                        deviceFamily,\r\n                        androidMinApiLevel,\r\n                        bundleId,\r\n                        downloadUrl,\r\n                        installUrl,\r\n                        fingerprint,\r\n                        appOS,\r\n                        fileExtension,\r\n                        releaseNotes: releaseNotes && md.render(releaseNotes),\r\n                    },\r\n                    { minimize: true }\r\n                );\r\n                item.guid = fingerprint;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const icon = items && items[0]._feed_icon; // if it is an empty feed, would not raise an error here\r\n    const title = items && items[0]._feed_title;\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        description: title,\r\n        image: icon,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"odASA,MAAa,EAAe,CACxB,KAAM,0CACN,WAAY,CAAC,kBACb,QAAS,sDACT,WAAY,CAAE,KAAM,OAAQ,IAAK,WAAY,mBAAoB,sBACjE,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,qFAAsF,uFAGvG,KAAM,UACN,YAAa,CAAC,eACd,UACA,YAAa;;MAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,QACrB,EAAM,EAAI,IAAI,MAAM,OACpB,EAAqB,EAAI,IAAI,MAAM,sBAGnC,EAAS,8CAAc,EAAK,GAAG,EAAI,uBAAuB,IAC1D,EAAkB,GAAG,EAAO,+BAE5B,EAAO,sCAAsC,EAAK,QAAQ,EAAI,uBAAuB,IAErF,EAAW,MAAM,EAAI,GACvB,EAAQ,EAAS,KAAK,IAAK,IAAU,CAarC,QAAS,EAAU,EAAK,aACxB,KAAM,GAAG,EAAO,YAAY,EAAK,GAAG,0BASlC,EAAK,IAAI,EACf,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAkB,MAAM,EAAI,EAAK,MACjC,EAAc,EAAgB,KAE9B,EAAW,EAAY,MAAM,aAC7B,EAAQ,EAAY,OACpB,EAAe,EAAY,cAC3B,EAAc,EAAY,QAC1B,EAAkB,EAAY,kBAC9B,EAAoB,EAAY,iBAEhC,GAAgB,EAAY,MAAQ,KAAO,OAAO,QAAQ,GAC1D,EAAc,EAAY,YAC1B,EAAc,EAAY,YAC1B,EAAQ,EAAY,OACpB,EAAqB,EAAY,sBACjC,EAAe,EAAY,cAC3B,EAAW,EAAY,kBACvB,EAAe,EAAY,cAC3B,EAAc,EAAY,aAC1B,EAAa,EAAY,YACzB,EAAgB,EAAY,cAG5B,EAAU,EAAY,iBACtB,EAAsB,EAAY,sBAClC,EAAwB,EAAY,oBAAoB,KAAM,GAAU,EAAM,KAAO,GAAqB,aAChH,EAAK,YAAc,GAAG,EAAQ,IAAI,EAAsB,QAAQ,EAAM,MAAM,EAAS,wBACrF,EAAK,WAAa,EAAY,aAE9B,IAAM,EAAU,GAAgB,EAAc,GAAG,EAAa,IAAI,EAAY,GAAK,GAAgB,EA8BnG,MA5BA,GAAK,MACD,GAAG,EAAQ,KACV,EAAoB,cAAgB,KAEpC,EAAkB,mBAAqB,IACxC,WAAW,IACf,EAAK,KAAO,EACZ,EAAK,OAAS,EACd,EAAK,YAAc,EACf,EAAA,KAAA,EAAA,sCACA,CACI,cACA,eACA,QACA,eACA,qBACA,WACA,cACA,aACA,cACA,QACA,gBACA,aAAc,GAAgB,EAAG,OAAO,IAE5C,CAAE,SAAU,KAEhB,EAAK,KAAO,EAEL,MAKnB,IAAM,EAAO,GAAS,EAAM,GAAG,WACzB,EAAQ,GAAS,EAAM,GAAG,YAEhC,MAAO,CACH,QACA,OACA,YAAa,EACb,MAAO,EACP,KAAM"}