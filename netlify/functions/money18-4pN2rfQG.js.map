{"version":3,"file":"money18-4pN2rfQG.js","names":[],"sources":["../../lib/routes/oncc/money18.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport dayjs from 'dayjs';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst sections = {\r\n    exp: '新聞總覽',\r\n    fov: '全日焦點',\r\n    industry: '板塊新聞',\r\n    int: '國際金融',\r\n    recagent: '大行報告',\r\n    ntlgroup: 'A股新聞',\r\n    pro: '地產新聞',\r\n    weainvest: '投資理財',\r\n    ipo: '新股IPO',\r\n    tech: '科技財情',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/money18/:id?',\r\n    categories: ['traditional-media'],\r\n    example: '/oncc/money18/exp',\r\n    parameters: { id: '栏目 id，可在对应栏目页 URL 中找到，默认为 exp，即新聞總覽' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Money18',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 新聞總覽 | 全日焦點 | 板塊新聞 | 國際金融 | 大行報告 | A 股新聞 | 地產新聞 | 投資理財  | 新股 IPO | 科技財情 |\r\n| -------- | -------- | -------- | -------- | -------- | -------- | -------- | --------- | -------- | -------- |\r\n| exp      | fov      | industry | int      | recagent | ntlgroup | pro      | weainvest | ipo      | tech     |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id') ?? 'exp';\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 30;\r\n\r\n    const rootUrl = 'https://money18.on.cc';\r\n    const currentUrl = `${rootUrl}/finnews/news_${id === 'industry' ? 'industry.html' : `breaking.html?section=${id}`}`;\r\n    const ipoApiUrl = `https://dyn.on.cc/api/asrh/v1/events/names/新股/articles?page=1&limit=${limit}`;\r\n    const industryApiUrl = `${rootUrl}/cnt/utf8/content/articleList/sector_list_exp_1.js`;\r\n\r\n    const toApiUrl = (date) => `${rootUrl}/cnt/utf8/content/${date}/articleList/list_${id}_all.js`;\r\n\r\n    let apiUrl = id === 'ipo' ? ipoApiUrl : id === 'industry' ? industryApiUrl : toApiUrl(dayjs().format('YYYYMMDD')),\r\n        hasArticle = false,\r\n        items = [],\r\n        i = 0,\r\n        response;\r\n\r\n    /* eslint-disable no-await-in-loop */\r\n\r\n    while (!hasArticle) {\r\n        try {\r\n            response = await got({\r\n                method: 'get',\r\n                url: apiUrl,\r\n            });\r\n            hasArticle = true;\r\n        } catch (error) {\r\n            if (error.code === 'ERR_NON_2XX_3XX_RESPONSE') {\r\n                hasArticle = false;\r\n                apiUrl = toApiUrl(dayjs().subtract(++i, 'day').format('YYYYMMDD'));\r\n            }\r\n        }\r\n    }\r\n\r\n    /* eslint-enable no-await-in-loop */\r\n\r\n    if (id === 'ipo') {\r\n        items = response.data.articles.map((item) => ({\r\n            title: item.title,\r\n            author: item.authorname,\r\n            link: `${rootUrl}/finnews/content/${id}/${item.articleId}.html`,\r\n            description: art(path.join(__dirname, 'templates/money18.art'), {\r\n                images: item.hasHdPhoto ? [`https://hk.on.cc/hk/bkn${item.hdEnlargeThumbnail}`] : undefined,\r\n                description: item.content,\r\n            }),\r\n            pubDate: timezone(parseDate(item.pubDate), +8),\r\n        }));\r\n    } else if (id === 'industry') {\r\n        items = response.data.articles.slice(0, limit).map((item) => ({\r\n            title: item.title,\r\n            author: item.authorname,\r\n            link: `${rootUrl}/finnews/content/${id}/${item.articleId}.html`,\r\n            category: item.sector.map((s) => s.name),\r\n            pubDate: timezone(parseDate(item.pubDate), +8),\r\n        }));\r\n    } else {\r\n        items = response.data.slice(0, limit).map((item) => ({\r\n            title: item.title,\r\n            author: item.authorname,\r\n            link: `${rootUrl}/finnews/content/${id}/${item.articleId}.html`,\r\n            pubDate: timezone(parseDate(item.pubDate), +8),\r\n        }));\r\n    }\r\n\r\n    if (id !== 'ipo') {\r\n        items = await Promise.all(\r\n            items.map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const detailResponse = await got({\r\n                        method: 'get',\r\n                        url: item.link,\r\n                    });\r\n\r\n                    const content = load(detailResponse.data);\r\n\r\n                    item.description = art(path.join(__dirname, 'templates/money18.art'), {\r\n                        images: content('.photo img')\r\n                            .toArray()\r\n                            .map((i) => content(i).attr('src')),\r\n                        description: content('.content').html(),\r\n                    });\r\n\r\n                    return item;\r\n                })\r\n            )\r\n        );\r\n    }\r\n\r\n    return {\r\n        title: `東網產經 - ${sections[id]}`,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"+hBAWA,MAAM,EAAW,CACb,IAAK,OACL,IAAK,OACL,SAAU,OACV,IAAK,OACL,SAAU,OACV,SAAU,OACV,IAAK,OACL,UAAW,OACX,IAAK,QACL,KAAM,QAGG,EAAe,CACxB,KAAM,gBACN,WAAY,CAAC,qBACb,QAAS,oBACT,WAAY,CAAE,GAAI,uCAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,UACN,YAAa,CAAC,WACd,UACA,YAAa;;mHAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,OAAS,MAC5B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,GAE3E,EAAU,wBACV,EAAa,GAAG,EAAQ,gBAAgB,IAAO,WAAa,gBAAkB,yBAAyB,MACvG,EAAY,uEAAuE,IACnF,EAAiB,GAAG,EAAQ,oDAE5B,EAAY,GAAS,GAAG,EAAQ,oBAAoB,EAAK,oBAAoB,EAAG,SAElF,EAAS,IAAO,MAAQ,EAAY,IAAO,WAAa,EAAiB,EAAS,IAAQ,OAAO,aACjG,EAAa,GACb,EAAQ,GACR,EAAI,EACJ,EAIJ,KAAO,CAAC,GACJ,GAAI,CACA,EAAW,MAAM,EAAI,CACjB,OAAQ,MACR,IAAK,IAET,EAAa,SACR,EAAO,CACR,EAAM,OAAS,6BACf,EAAa,GACb,EAAS,EAAS,IAAQ,SAAS,EAAE,EAAG,OAAO,OAAO,cA2DlE,MApDA,CAoBI,EApBA,IAAO,MACC,EAAS,KAAK,SAAS,IAAK,IAAU,CAC1C,MAAO,EAAK,MACZ,OAAQ,EAAK,WACb,KAAM,GAAG,EAAQ,mBAAmB,EAAG,GAAG,EAAK,UAAU,OACzD,YAAa,EAAI,EAAA,KAAA,EAAA,kCAA+C,CAC5D,OAAQ,EAAK,WAAa,CAAC,0BAA0B,EAAK,sBAAwB,IAAA,GAClF,YAAa,EAAK,UAEtB,QAAS,EAAS,EAAU,EAAK,SAAU,MAExC,IAAO,WACN,EAAS,KAAK,SAAS,MAAM,EAAG,GAAO,IAAK,IAAU,CAC1D,MAAO,EAAK,MACZ,OAAQ,EAAK,WACb,KAAM,GAAG,EAAQ,mBAAmB,EAAG,GAAG,EAAK,UAAU,OACzD,SAAU,EAAK,OAAO,IAAK,GAAM,EAAE,MACnC,QAAS,EAAS,EAAU,EAAK,SAAU,MAGvC,EAAS,KAAK,MAAM,EAAG,GAAO,IAAK,IAAU,CACjD,MAAO,EAAK,MACZ,OAAQ,EAAK,WACb,KAAM,GAAG,EAAQ,mBAAmB,EAAG,GAAG,EAAK,UAAU,OACzD,QAAS,EAAS,EAAU,EAAK,SAAU,MAI/C,IAAO,QACP,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAe,MASpC,MAPA,GAAK,YAAc,EAAI,EAAA,KAAA,EAAA,kCAA+C,CAClE,OAAQ,EAAQ,cACX,UACA,IAAK,GAAM,EAAQ,GAAG,KAAK,QAChC,YAAa,EAAQ,YAAY,SAG9B,OAMhB,CACH,MAAO,UAAU,EAAS,KAC1B,KAAM,EACN,KAAM"}