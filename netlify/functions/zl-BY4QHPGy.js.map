{"version":3,"file":"zl-BY4QHPGy.js","names":[],"sources":["../../lib/routes/ali213/zl.ts"],"sourcesContent":["import path from 'node:path';\r\n\r\nimport { type CheerioAPI, type Cheerio, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport { type Context } from 'hono';\r\n\r\nimport { type DataItem, type Route, type Data, ViewType } from '@/types';\r\n\r\nimport { art } from '@/utils/render';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const handler = async (ctx: Context): Promise<Data> => {\r\n    const { category } = ctx.req.param();\r\n    const limit: number = Number.parseInt(ctx.req.query('limit') ?? '1', 10);\r\n\r\n    const rootUrl: string = 'https://www.ali213.net';\r\n    const apiRootUrl: string = 'https://mp.ali213.net';\r\n    const targetUrl: string = new URL(`/news/zl/${category ? (category.endsWith('/') ? category : `${category}/`) : ''}`, rootUrl).href;\r\n    const apiUrl: string = new URL('ajax/newslist', apiRootUrl).href;\r\n\r\n    const response = await ofetch(apiUrl, {\r\n        query: {\r\n            type: 'new',\r\n        },\r\n    });\r\n\r\n    const targetResponse = await ofetch(targetUrl);\r\n    const $: CheerioAPI = load(targetResponse);\r\n    const language: string = $('html').prop('lang') ?? 'zh';\r\n\r\n    let items: DataItem[] = JSON.parse(response.replace(/^\\((.*)\\)$/, '$1'))\r\n        .data.slice(0, limit)\r\n        .map((item): DataItem => {\r\n            const title: string = item.Title;\r\n            const description: string = art(path.join(__dirname, 'templates/description.art'), {\r\n                intro: item.GuideRead ?? '',\r\n            });\r\n            const guid: string = `ali213-zl-${item.ID}`;\r\n            const image: string | undefined = item.PicPath ? `https:${item.PicPath}` : undefined;\r\n\r\n            const author: DataItem['author'] = item.xiaobian;\r\n\r\n            return {\r\n                title,\r\n                description,\r\n                pubDate: parseDate(item.addtime * 1000),\r\n                link: item.url ? `https:${item.url}` : undefined,\r\n                author,\r\n                guid,\r\n                id: guid,\r\n                content: {\r\n                    html: description,\r\n                    text: item.GuideRead ?? '',\r\n                },\r\n                image,\r\n                banner: image,\r\n                language,\r\n            };\r\n        });\r\n\r\n    items = (\r\n        await Promise.all(\r\n            items.map((item) => {\r\n                if (!item.link && typeof item.link !== 'string') {\r\n                    return item;\r\n                }\r\n\r\n                return cache.tryGet(item.link, async (): Promise<DataItem> => {\r\n                    const detailResponse = await ofetch(item.link);\r\n                    const $$: CheerioAPI = load(detailResponse);\r\n\r\n                    const title: string = $$('h1.newstit').text();\r\n\r\n                    let description: string = $$('div#Content').html() ?? '';\r\n\r\n                    const pageLinks: string[] = [];\r\n                    $$('a.currpage')\r\n                        .parent()\r\n                        .find('a:not(.currpage)')\r\n                        .each((_, el) => {\r\n                            const href = $$(el).attr('href');\r\n                            if (href) {\r\n                                pageLinks.push(href);\r\n                            }\r\n                        });\r\n\r\n                    const pageContents = await Promise.all(\r\n                        pageLinks.map(async (link) => {\r\n                            const response = await ofetch(new URL(link, item.link).href);\r\n                            const $$$: CheerioAPI = load(response);\r\n\r\n                            return $$$('div#Content').html() ?? '';\r\n                        })\r\n                    );\r\n\r\n                    description += pageContents.join('');\r\n\r\n                    description = art(path.join(__dirname, 'templates/description.art'), {\r\n                        description,\r\n                    });\r\n\r\n                    const extraLinks = $$('div.extend_read a')\r\n                        .toArray()\r\n                        .map((el) => {\r\n                            const $$el: Cheerio<Element> = $$(el);\r\n\r\n                            return {\r\n                                url: $$el.prop('href'),\r\n                                type: 'related',\r\n                                content_html: $$el.text(),\r\n                            };\r\n                        })\r\n                        .filter((_): _ is { url: string; type: string; content_html: string } => true);\r\n\r\n                    return {\r\n                        title,\r\n                        description,\r\n                        pubDate: item.pubDate,\r\n                        category: $$('.category')\r\n                            .toArray()\r\n                            .map((c) => $$(c).text()),\r\n                        author: item.author,\r\n                        doi: $$('meta[name=\"citation_doi\"]').prop('content') || undefined,\r\n                        guid: item.guid,\r\n                        id: item.guid,\r\n                        content: {\r\n                            html: description,\r\n                            text: description,\r\n                        },\r\n                        image: item.image,\r\n                        banner: item.image,\r\n                        language,\r\n                        _extra: {\r\n                            links: extraLinks.length > 0 ? extraLinks : undefined,\r\n                        },\r\n                    };\r\n                });\r\n            })\r\n        )\r\n    ).filter((_): _ is DataItem => true);\r\n\r\n    const title: string = $('title').text();\r\n    const feedImage: string = new URL('news/images/dxhlogo.png', rootUrl).href;\r\n\r\n    return {\r\n        title,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        link: targetUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: feedImage,\r\n        author: title.split(/_/).pop(),\r\n        language,\r\n        id: targetUrl,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/zl/:category?',\r\n    name: '大侠号',\r\n    url: 'www.ali213.net',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/ali213/zl',\r\n    parameters: {\r\n        category: '分类，默认为首页，可在对应分类页 URL 中找到',\r\n    },\r\n    description: `::: tip\r\n若订阅 [游戏](https://www.ali213.net/news/zl/game/)，网址为 \\`https://www.ali213.net/news/zl/game/\\`，请截取 \\`https://www.ali213.net/news/zl/\\` 到末尾 \\`/\\` 的部分 \\`game\\` 作为 \\`category\\` 参数填入，此时目标路由为 [\\`/ali213/zl/game\\`](https://rsshub.app/ali213/zl/game)。\r\n:::\r\n\r\n| 首页                                     | 游戏                                         | 动漫                                           | 影视                                           | 娱乐                                           |\r\n| ---------------------------------------- | -------------------------------------------- | ---------------------------------------------- | ---------------------------------------------- | ---------------------------------------------- |\r\n| [index](https://www.ali213.net/news/zl/) | [game](https://www.ali213.net/news/zl/game/) | [comic](https://www.ali213.net/news/zl/comic/) | [movie](https://www.ali213.net/news/zl/movie/) | [amuse](https://www.ali213.net/news/zl/amuse/) |\r\n`,\r\n    categories: ['game'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.ali213.net/news/zl/:category'],\r\n            target: (params) => {\r\n                const category = params.category;\r\n\r\n                return `/ali213/zl${category ? `/${category}` : ''}`;\r\n            },\r\n        },\r\n        {\r\n            title: '首页',\r\n            source: ['www.ali213.net/news/zl/'],\r\n            target: '/zl',\r\n        },\r\n        {\r\n            title: '游戏',\r\n            source: ['www.ali213.net/news/zl/game/'],\r\n            target: '/zl/game',\r\n        },\r\n        {\r\n            title: '动漫',\r\n            source: ['www.ali213.net/news/zl/comic/'],\r\n            target: '/zl/comic',\r\n        },\r\n        {\r\n            title: '影视',\r\n            source: ['www.ali213.net/news/zl/movie/'],\r\n            target: '/zl/movie',\r\n        },\r\n        {\r\n            title: '娱乐',\r\n            source: ['www.ali213.net/news/zl/amuse/'],\r\n            target: '/zl/amuse',\r\n        },\r\n    ],\r\n    view: ViewType.Articles,\r\n};\r\n"],"mappings":"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"}