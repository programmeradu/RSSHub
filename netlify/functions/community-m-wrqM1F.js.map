{"version":3,"file":"community-m-wrqM1F.js","names":[],"sources":["../../lib/routes/youtube/community.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseRelativeDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { isYouTubeChannelId } from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/community/:handle',\r\n    categories: ['social-media'],\r\n    example: '/youtube/community/@JFlaMusic',\r\n    parameters: { handle: 'YouTube handles or channel id' },\r\n    name: 'Community',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const handle = ctx.req.param('handle');\r\n\r\n    let urlPath = handle;\r\n    if (isYouTubeChannelId(handle)) {\r\n        urlPath = `channel/${handle}`;\r\n    }\r\n\r\n    const { data: response } = await got(`https://www.youtube.com/${urlPath}/community`);\r\n    const $ = load(response);\r\n    const ytInitialData = JSON.parse(\r\n        $('script')\r\n            .text()\r\n            .match(/ytInitialData = ({.*?});/)?.[1] ?? '{}'\r\n    );\r\n\r\n    const channelMetadata = ytInitialData.metadata.channelMetadataRenderer;\r\n    const username = channelMetadata.title;\r\n    const communityTab = ytInitialData.contents.twoColumnBrowseResultsRenderer.tabs.find(\r\n        (tab) => tab.tabRenderer.endpoint.commandMetadata.webCommandMetadata.url.endsWith('/posts') || tab.tabRenderer.endpoint.commandMetadata.webCommandMetadata.url.endsWith('/community')\r\n    );\r\n    const list = communityTab.tabRenderer.content.sectionListRenderer.contents[0].itemSectionRenderer.contents;\r\n\r\n    if (list[0].messageRenderer) {\r\n        throw new Error(list[0].messageRenderer.text.runs[0].text);\r\n    }\r\n\r\n    const items = list\r\n        .filter((i) => i.backstagePostThreadRenderer)\r\n        .map((item) => {\r\n            const post = item.backstagePostThreadRenderer.post.backstagePostRenderer || item.backstagePostThreadRenderer.post.sharedPostRenderer.originalPost.backstagePostRenderer;\r\n            const media = post.backstageAttachment?.postMultiImageRenderer?.images.map((i) => i.backstageImageRenderer.image.thumbnails.pop()) ?? [post.backstageAttachment?.backstageImageRenderer?.image.thumbnails.pop()];\r\n            return {\r\n                title: post.contentText.runs?.[0].text ?? '',\r\n                description: art(path.join(__dirname, 'templates/community.art'), {\r\n                    runs: post.contentText.runs,\r\n                    media,\r\n                }),\r\n                link: `https://www.youtube.com/post/${post.postId}`,\r\n                author: post.authorText.runs[0].text,\r\n                pubDate: parseRelativeDate(post.publishedTimeText.runs[0].text.split('(')[0]),\r\n            };\r\n        });\r\n\r\n    return {\r\n        title: `${username} - Community - YouTube`,\r\n        link: channelMetadata.channelUrl,\r\n        description: channelMetadata.description,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"iiBASA,MAAa,EAAe,CACxB,KAAM,qBACN,WAAY,CAAC,gBACb,QAAS,gCACT,WAAY,CAAE,OAAQ,iCACtB,KAAM,YACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAI,IAAI,MAAM,UAEzB,EAAU,EACV,EAAmB,KACnB,EAAU,WAAW,KAGzB,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,2BAA2B,EAAQ,aAClE,EAAI,EAAK,GACT,EAAgB,KAAK,MACvB,EAAE,UACG,OACA,MAAM,8BAA8B,IAAM,MAG7C,EAAkB,EAAc,SAAS,wBACzC,EAAW,EAAgB,MAC3B,EAAe,EAAc,SAAS,+BAA+B,KAAK,KAC3E,GAAQ,EAAI,YAAY,SAAS,gBAAgB,mBAAmB,IAAI,SAAS,WAAa,EAAI,YAAY,SAAS,gBAAgB,mBAAmB,IAAI,SAAS,eAEtK,EAAO,EAAa,YAAY,QAAQ,oBAAoB,SAAS,GAAG,oBAAoB,SAElG,GAAI,EAAK,GAAG,gBACR,MAAU,MAAM,EAAK,GAAG,gBAAgB,KAAK,KAAK,GAAG,MAGzD,IAAM,EAAQ,EACT,OAAQ,GAAM,EAAE,6BAChB,IAAK,GAAS,CACX,IAAM,EAAO,EAAK,4BAA4B,KAAK,uBAAyB,EAAK,4BAA4B,KAAK,mBAAmB,aAAa,sBAC5I,EAAQ,EAAK,qBAAqB,wBAAwB,OAAO,IAAK,GAAM,EAAE,uBAAuB,MAAM,WAAW,QAAU,CAAC,EAAK,qBAAqB,wBAAwB,MAAM,WAAW,OAC1M,MAAO,CACH,MAAO,EAAK,YAAY,OAAO,GAAG,MAAQ,GAC1C,YAAa,EAAI,EAAA,KAAA,EAAA,oCAAiD,CAC9D,KAAM,EAAK,YAAY,KACvB,UAEJ,KAAM,gCAAgC,EAAK,SAC3C,OAAQ,EAAK,WAAW,KAAK,GAAG,KAChC,QAAS,EAAkB,EAAK,kBAAkB,KAAK,GAAG,KAAK,MAAM,KAAK,OAItF,MAAO,CACH,MAAO,GAAG,EAAS,wBACnB,KAAM,EAAgB,WACtB,YAAa,EAAgB,YAC7B,KAAM"}