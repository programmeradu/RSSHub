{"version":3,"file":"utils-Z4lGI3xS.js","names":[],"sources":["../../lib/routes/lfsyd/utils.ts"],"sourcesContent":["import { load } from 'cheerio';\r\nimport got from '@/utils/got';\r\nimport md5 from '@/utils/md5';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\n\r\nconst rootUrl = 'https://www.iyingdi.com';\r\nconst infoUrL = 'https://api.iyingdi.com/web/post/info';\r\n\r\nconst ProcessFeed = async (cache, articleList) => {\r\n    const items = await Promise.all(\r\n        articleList.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const infoForm = {\r\n                    post_id: item.postId,\r\n                    timestamp: '',\r\n                };\r\n                const { body } = await got({\r\n                    method: 'post',\r\n                    url: infoUrL,\r\n                    headers: {\r\n                        Host: 'api.iyingdi.com',\r\n                        'Login-Token': 'nologin',\r\n                        Origin: rootUrl,\r\n                        Platform: 'pc',\r\n                        Referer: `${rootUrl}/`,\r\n                    },\r\n                    form: ProcessForm(infoForm),\r\n                });\r\n                item.description = cleanHtml(JSON.parse(body).post.content);\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return items;\r\n};\r\n\r\nconst ProcessForm = (form, type) => {\r\n    const key = type ? '8a11ed3712b699e749185674f1dc20b4' : 'b8d5b38577b8bb382b0c783b474b95f9';\r\n    form.key = key;\r\n    form.timestamp = Math.floor(Date.now() / 1000);\r\n    form.sign = md5(new URLSearchParams(form).toString());\r\n    delete form.key;\r\n    return form;\r\n};\r\n\r\nconst cleanHtml = (htmlString) => {\r\n    const regex = /(<p>|<div>)(.*?)?<strong>(标准|狂野)日报投稿.*?<\\/strong>(.*?)?(<\\/p>|<\\/div>)(.|\\n)*$/;\r\n    const $ = load(htmlString.replace(regex, ''));\r\n\r\n    $('.yingdi-car,.bbspost,.deck-set').each((i, e) => {\r\n        const className = $(e).attr('class');\r\n        const dataId = $(e).attr('data-id');\r\n        const decksUrl = `${rootUrl}/web/tools/hearthstone/decks/setdetail?setid=${dataId}`;\r\n        const url = className === 'yingdi-card bbspost' ? `${rootUrl}/tz/post/${dataId}` : decksUrl;\r\n        const time = $(e).find('.card-status .time').text();\r\n        $(e)\r\n            .find('.card-info .title')\r\n            .text((i, c) => `${c} ${time}`);\r\n        $(e).find('.card-status').remove();\r\n        $(e)\r\n            .find('.card-info')\r\n            .wrap(art(path.join(__dirname, 'templates/card.art'), { url }));\r\n    });\r\n\r\n    $('.yingdi-image.gif').each((i, e) => {\r\n        const imgsrc = $(e).attr('data-original');\r\n        $(e).attr('src', imgsrc);\r\n    });\r\n\r\n    $('.yingdi-audio').each((i, e) => {\r\n        $(e).find('.audio-cover').remove();\r\n        $(e).find('.audio-area.hidden').attr('class', 'audio-area');\r\n    });\r\n\r\n    $('.yingdi-video iframe').each((i, e) => {\r\n        const bvid = $(e)\r\n            .attr('src')\r\n            .match(/bvid=(.*?)&/)[1];\r\n        if (bvid) {\r\n            const url = `https://www.bilibili.com/video/${bvid}`;\r\n            $(e).after(art(path.join(__dirname, 'templates/video.art'), { url }));\r\n        }\r\n    });\r\n\r\n    // 用户头像\r\n    $('.yingdi-card.user').each((i, e) => {\r\n        $(e).prev('p').remove();\r\n        $(e).remove();\r\n    });\r\n    // 套牌代码复制\r\n    $('.action-button').remove();\r\n    // 投票\r\n    $('.yingdi-ballot').remove();\r\n    $('hr').remove();\r\n    return $.html();\r\n};\r\n\r\nexport { ProcessForm, ProcessFeed };\r\n"],"mappings":"uQAMA,MAAM,EAAU,0BAGV,EAAc,MAAO,EAAO,IAAgB,CAC9C,IAAM,EAAQ,MAAM,QAAQ,IACxB,EAAY,IAAK,GACb,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,CACb,QAAS,EAAK,OACd,UAAW,IAET,CAAE,QAAS,MAAM,EAAI,CACvB,OAAQ,OACR,IAAK,wCACL,QAAS,CACL,KAAM,kBACN,cAAe,UACf,OAAQ,EACR,SAAU,KACV,QAAS,GAAG,EAAQ,IAExB,KAAM,EAAY,KAGtB,MADA,GAAK,YAAc,EAAU,KAAK,MAAM,GAAM,KAAK,SAC5C,MAKnB,OAAO,GAGL,GAAe,EAAM,IAAS,CAChC,IAAM,EAAM,EAAO,mCAAqC,mCAKxD,MAJA,GAAK,IAAM,EACX,EAAK,UAAY,KAAK,MAAM,KAAK,MAAQ,KACzC,EAAK,KAAO,EAAI,IAAI,gBAAgB,GAAM,YAC1C,OAAO,EAAK,IACL,GAGL,EAAa,GAAe,CAC9B,IAAM,EAAQ,iFACR,EAAI,EAAK,EAAW,QAAQ,EAAO,KA+CzC,OA7CA,EAAE,kCAAkC,MAAM,EAAG,IAAM,CAC/C,IAAM,EAAY,EAAE,GAAG,KAAK,SACtB,EAAS,EAAE,GAAG,KAAK,WACnB,EAAW,GAAG,EAAQ,+CAA+C,IACrE,EAAM,IAAc,sBAAwB,GAAG,EAAQ,WAAW,IAAW,EAC7E,EAAO,EAAE,GAAG,KAAK,sBAAsB,OAC7C,EAAE,GACG,KAAK,qBACL,MAAM,EAAG,IAAM,GAAG,EAAE,GAAG,KAC5B,EAAE,GAAG,KAAK,gBAAgB,SAC1B,EAAE,GACG,KAAK,cACL,KAAK,EAAI,EAAA,KAAA,EAAA,+BAA4C,CAAE,WAGhE,EAAE,qBAAqB,MAAM,EAAG,IAAM,CAClC,IAAM,EAAS,EAAE,GAAG,KAAK,iBACzB,EAAE,GAAG,KAAK,MAAO,KAGrB,EAAE,iBAAiB,MAAM,EAAG,IAAM,CAC9B,EAAE,GAAG,KAAK,gBAAgB,SAC1B,EAAE,GAAG,KAAK,sBAAsB,KAAK,QAAS,gBAGlD,EAAE,wBAAwB,MAAM,EAAG,IAAM,CACrC,IAAM,EAAO,EAAE,GACV,KAAK,OACL,MAAM,eAAe,GAC1B,GAAI,EAAM,CACN,IAAM,EAAM,kCAAkC,IAC9C,EAAE,GAAG,MAAM,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAAE,YAKtE,EAAE,qBAAqB,MAAM,EAAG,IAAM,CAClC,EAAE,GAAG,KAAK,KAAK,SACf,EAAE,GAAG,WAGT,EAAE,kBAAkB,SAEpB,EAAE,kBAAkB,SACpB,EAAE,MAAM,SACD,EAAE"}