{"version":3,"file":"user-DoMru3Tx.js","names":["route: Route","ConfigNotFoundError","got","cache","response","$"],"sources":["../../lib/routes/sehuatang/user.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\n// 导入必要的模组\r\nimport got from '@/utils/got'; // 自订的 got\r\nimport { load } from 'cheerio'; // 可以使用类似 jQuery 的 API HTML 解析器\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nconst baseUrl = 'https://sehuatang.org/';\r\n\r\nexport const route: Route = {\r\n    path: '/user/:uid',\r\n    categories: ['multimedia'],\r\n    example: '/sehuatang/user/411096',\r\n    parameters: { uid: '用户 uid, 可在用户主页 URL 中找到' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'SEHUATANG_COOKIE',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '作者文章',\r\n    maintainers: ['JamYiz'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.sehuatang.cookie) {\r\n        throw new ConfigNotFoundError('Sehuatang RSS is disabled due to the lack of <a href=\"https://docs.rsshub.app/deploy/config#route-specific-configurations\">relevant config</a>');\r\n    }\r\n    // 从Url参数中获取uid\r\n    const uid = ctx.req.param('uid');\r\n    const link = `${baseUrl}home.php?mod=space&uid=${uid}&do=thread&view=me&from=space`;\r\n\r\n    const response = await got(link, {\r\n        headers: {\r\n            Cookie: config.sehuatang.cookie,\r\n            'Accept-Encoding': 'gzip, deflate, br',\r\n            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',\r\n        },\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    const list = $('#delform tr:not(.th)')\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 25)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            const a = item.find('th>a').first();\r\n            const category = item.find('.xg1').first().text();\r\n            return {\r\n                title: `[${category}] ${a.text()}`,\r\n                // `link` 需要一个绝对 URL，但 `a.attr('href')` 返回一个相对 URL。\r\n                link: baseUrl + a.attr('href'),\r\n                // pubDate: '',\r\n                author: $('.mt').first().text(),\r\n            };\r\n        });\r\n\r\n    const out = await Promise.all(\r\n        list.map((info) =>\r\n            cache.tryGet(info.link, async () => {\r\n                const response = await got(info.link, {\r\n                    headers: {\r\n                        Cookie: config.sehuatang.cookie,\r\n                        'Accept-Encoding': 'gzip, deflate, br',\r\n                        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',\r\n                    },\r\n                });\r\n\r\n                const $ = load(response.data);\r\n                const postMessage = $(\"[id^='postmessage']\").slice(0, 1);\r\n                const images = $(postMessage).find('img');\r\n                for (const image of images) {\r\n                    const file = $(image).attr('file');\r\n                    if (!file || file === 'undefined') {\r\n                        $(image).replaceWith('');\r\n                    } else {\r\n                        $(image).replaceWith($(`<img src=\"${file}\">`));\r\n                    }\r\n                }\r\n                // also parse image url from `.pattl`\r\n                const pattl = $('.pattl');\r\n                const pattlImages = $(pattl).find('img');\r\n                for (const pattlImage of pattlImages) {\r\n                    const file = $(pattlImage).attr('file');\r\n                    if (!file || file === 'undefined') {\r\n                        $(pattlImage).replaceWith('');\r\n                    } else {\r\n                        $(pattlImage).replaceWith($(`<img src=\"${file}\" />`));\r\n                    }\r\n                }\r\n                postMessage.append($(pattl));\r\n\r\n                $('em[onclick]').remove();\r\n\r\n                info.description = (postMessage.html() || '抓取原帖失败').replaceAll('ignore_js_op', 'div');\r\n\r\n                const dateString = $('.authi em').first().text();\r\n                const datestampString = dateString.split(' ')[1];\r\n                const timestampString = dateString.split(' ')[2];\r\n                const datetimeString = `${datestampString} ${timestampString}`;\r\n                const timestamp = new Date(datetimeString).getTime();\r\n\r\n                info.pubDate = $('.authi em span').length > 0 ? parseDate($('.authi em span').attr('title')) : parseDate(timestamp);\r\n\r\n                const magnet = postMessage.find('div.blockcode li').first().text();\r\n                const isMag = magnet.startsWith('magnet');\r\n                const torrent = postMessage.find('p.attnm a').attr('href');\r\n\r\n                const hasEnclosureUrl = isMag || torrent !== undefined;\r\n                if (hasEnclosureUrl) {\r\n                    const enclosureUrl = isMag ? magnet : new URL(torrent, baseUrl).href;\r\n                    info.enclosure_url = enclosureUrl;\r\n                    info.enclosure_type = isMag ? 'application/x-bittorrent' : 'application/octet-stream';\r\n                }\r\n\r\n                return info;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        // 在此处输出您的 RSS\r\n        title: `${$('.mt').text()}的帖子-色花堂`,\r\n        link,\r\n        item: out,\r\n    };\r\n}\r\n"],"mappings":"mcASA,MAAM,EAAU,yBAEHA,EAAe,CACxB,KAAM,aACN,WAAY,CAAC,cACb,QAAS,yBACT,WAAY,CAAE,IAAK,0BACnB,SAAU,CACN,cAAe,CACX,CACI,KAAM,mBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,UAAU,OAClB,MAAM,IAAIC,EAAoB,kJAGlC,IAAM,EAAM,EAAI,IAAI,MAAM,OACpB,EAAO,GAAG,EAAQ,yBAAyB,EAAI,+BAE/C,EAAW,MAAMC,EAAI,EAAM,CAC7B,QAAS,CACL,OAAQ,EAAO,UAAU,OACzB,kBAAmB,oBACnB,kBAAmB,6BAIrB,EAAI,EAAK,EAAS,MAElB,EAAO,EAAE,wBACV,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAC5E,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GACT,IAAM,EAAI,EAAK,KAAK,QAAQ,QACtB,EAAW,EAAK,KAAK,QAAQ,QAAQ,OAC3C,MAAO,CACH,MAAO,IAAI,EAAS,IAAI,EAAE,SAE1B,KAAM,EAAU,EAAE,KAAK,QAEvB,OAAQ,EAAE,OAAO,QAAQ,UAI/B,EAAM,MAAM,QAAQ,IACtB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAMC,EAAW,MAAMF,EAAI,EAAK,KAAM,CAClC,QAAS,CACL,OAAQ,EAAO,UAAU,OACzB,kBAAmB,oBACnB,kBAAmB,6BAIrBG,EAAI,EAAKD,EAAS,MAClB,EAAcC,EAAE,uBAAuB,MAAM,EAAG,GAChD,EAASA,EAAE,GAAa,KAAK,OACnC,IAAK,IAAM,KAAS,EAAQ,CACxB,IAAM,EAAOA,EAAE,GAAO,KAAK,QACvB,CAAC,GAAQ,IAAS,YAClB,EAAE,GAAO,YAAY,IAErB,EAAE,GAAO,YAAYA,EAAE,aAAa,EAAK,MAIjD,IAAM,EAAQA,EAAE,UACV,EAAcA,EAAE,GAAO,KAAK,OAClC,IAAK,IAAM,KAAc,EAAa,CAClC,IAAM,EAAOA,EAAE,GAAY,KAAK,QAC5B,CAAC,GAAQ,IAAS,YAClB,EAAE,GAAY,YAAY,IAE1B,EAAE,GAAY,YAAYA,EAAE,aAAa,EAAK,QAGtD,EAAY,OAAOA,EAAE,IAErB,EAAE,eAAe,SAEjB,EAAK,aAAe,EAAY,QAAU,UAAU,WAAW,eAAgB,OAE/E,IAAM,EAAaA,EAAE,aAAa,QAAQ,OACpC,EAAkB,EAAW,MAAM,KAAK,GACxC,EAAkB,EAAW,MAAM,KAAK,GACxC,EAAiB,GAAG,EAAgB,GAAG,IACvC,EAAY,IAAI,KAAK,GAAgB,UAE3C,EAAK,QAAUA,EAAE,kBAAkB,OAAS,EAAI,EAAUA,EAAE,kBAAkB,KAAK,UAAY,EAAU,GAEzG,IAAM,EAAS,EAAY,KAAK,oBAAoB,QAAQ,OACtD,EAAQ,EAAO,WAAW,UAC1B,EAAU,EAAY,KAAK,aAAa,KAAK,QAE7C,EAAkB,GAAS,IAAY,IAAA,GAC7C,GAAI,EAAiB,CACjB,IAAM,EAAe,EAAQ,EAAS,IAAI,IAAI,EAAS,GAAS,KAChE,EAAK,cAAgB,EACrB,EAAK,eAAiB,EAAQ,2BAA6B,2BAG/D,OAAO,MAKnB,MAAO,CAEH,MAAO,GAAG,EAAE,OAAO,OAAO,SAC1B,OACA,KAAM"}