{"version":3,"file":"timeline-CtjE5Mhr.js","names":["route: Route","ConfigNotFoundError","got","e"],"sources":["../../lib/routes/zhihu/timeline.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { processImage } from './utils';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/timeline',\r\n    categories: ['social-media'],\r\n    example: '/zhihu/timeline',\r\n    parameters: {},\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'ZHIHU_COOKIES',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '用户关注时间线',\r\n    maintainers: ['SeanChao'],\r\n    handler,\r\n    description: `::: warning\r\n  用户关注动态需要登录后的 Cookie 值，所以只能自建，详情见部署页面的配置模块。\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const cookie = config.zhihu.cookies;\r\n    if (cookie === undefined) {\r\n        throw new ConfigNotFoundError('缺少知乎用户登录后的 Cookie 值');\r\n    }\r\n    const response = await got({\r\n        method: 'get',\r\n        url: `https://www.zhihu.com/api/v3/moments`,\r\n        headers: {\r\n            Cookie: cookie,\r\n        },\r\n        searchParams: {\r\n            desktop: true,\r\n            limit: ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 15,\r\n        },\r\n    });\r\n    const feeds = response.data.data;\r\n\r\n    const urlBase = 'https://zhihu.com';\r\n    const buildLink = (e) => {\r\n        if (!e || !e.target || !e.target.type) {\r\n            return '';\r\n        }\r\n        const id = e.target.id;\r\n        switch (e.target.type) {\r\n            case 'answer': {\r\n                const questionId = e.target.question.id;\r\n                return `${urlBase}/question/${questionId}/answer/${id}`;\r\n            }\r\n            case 'pin':\r\n            case 'article':\r\n                return e.target.url;\r\n            case 'question':\r\n                return `${urlBase}/question/${id}`;\r\n            default:\r\n                return;\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Returns one non-undefined/null element from a list of items\r\n     * make sure there exists at least one element that is non-undefined\r\n     *\r\n     * @param {Array} list a list of items to be filtered\r\n     */\r\n    const getOne = (list) => list.find((e) => e !== undefined && e !== null);\r\n\r\n    const buildActors = (e) => {\r\n        const actors = e.actors;\r\n        if (!actors) {\r\n            return '';\r\n        }\r\n        return actors.map((e) => e.name).join(', ');\r\n    };\r\n\r\n    const getContent = (content) => {\r\n        if (!content || !Array.isArray(content)) {\r\n            return content;\r\n        }\r\n        // content can be a string or an array of objects\r\n        return (\r\n            content\r\n                .map((e) => e.content)\r\n                .filter((e) => !!e && typeof e === 'string')\r\n                // some content may not be wrapped in tag, it will cause error when parsing\r\n                .map((e) => `<div>${e}</div>`)\r\n                .join('')\r\n        );\r\n    };\r\n\r\n    const buildItem = (e) => {\r\n        if (!e || !e.target) {\r\n            return {};\r\n        }\r\n        const link = buildLink(e);\r\n        return {\r\n            title: `${e.action_text_tpl.replace('{}', buildActors(e))}: ${getOne([e.target.title, e.target.question ? e.target.question.title : ''])}`,\r\n            description: processImage(`<div>${getOne([e.target.content_html, getContent(e.target.content), e.target.detail, e.target.excerpt, ''])}</div>`),\r\n            pubDate: parseDate(e.updated_time * 1000),\r\n            link,\r\n            author: e.target.author ? e.target.author.name : '',\r\n            guid: link,\r\n            category: [e.verb],\r\n        };\r\n    };\r\n\r\n    const out = feeds\r\n        .filter((e) => e.verb)\r\n        .map((e) => {\r\n            if (e && e.type && e.type === 'feed_group') {\r\n                // A feed group contains a list of feeds whose structure is the same as a single feed\r\n                const title = e.group_text.replace('{LIST_COUNT}', e.list.length);\r\n                const description =\r\n                    e.list && Array.isArray(e.list)\r\n                        ? e.list\r\n                              .map((e) => buildItem(e))\r\n                              .map((e) => `<a href=\"${e.link}\"><b>${e.title}</b></a><br><p>${e.description}</p><br>`)\r\n                              .join('')\r\n                        : '';\r\n                const pubDate = e.list && Array.isArray(e.list) && e.list.length > 0 ? parseDate(e.list[0].updated_time * 1000) : new Date();\r\n                const guid = e.link;\r\n                return {\r\n                    title,\r\n                    description,\r\n                    pubDate,\r\n                    guid,\r\n                    category: [e.verb],\r\n                };\r\n            }\r\n            return buildItem(e);\r\n        });\r\n\r\n    return {\r\n        title: `知乎关注动态`,\r\n        link: `https://www.zhihu.com/follow`,\r\n        item: out,\r\n    };\r\n}\r\n"],"mappings":"ydAOA,MAAaA,EAAe,CACxB,KAAM,YACN,WAAY,CAAC,gBACb,QAAS,kBACT,WAAY,GACZ,SAAU,CACN,cAAe,CACX,CACI,KAAM,gBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,UACN,YAAa,CAAC,YACd,UACA,YAAa;;MAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAO,MAAM,QAC5B,GAAI,IAAW,IAAA,GACX,MAAM,IAAIC,EAAoB,uBAElC,IAAM,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,uCACL,QAAS,CACL,OAAQ,GAEZ,aAAc,CACV,QAAS,GACT,MAAO,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,MAG5E,EAAQ,EAAS,KAAK,KAEtB,EAAU,oBACV,EAAa,GAAM,CACrB,GAAI,CAAC,GAAK,CAAC,EAAE,QAAU,CAAC,EAAE,OAAO,KAC7B,MAAO,GAEX,IAAM,EAAK,EAAE,OAAO,GACpB,OAAQ,EAAE,OAAO,KAAjB,CACI,IAAK,SAAU,CACX,IAAM,EAAa,EAAE,OAAO,SAAS,GACrC,MAAO,GAAG,EAAQ,YAAY,EAAW,UAAU,IAEvD,IAAK,MACL,IAAK,UACD,OAAO,EAAE,OAAO,IACpB,IAAK,WACD,MAAO,GAAG,EAAQ,YAAY,IAClC,QACI,SAUN,EAAU,GAAS,EAAK,KAAM,GAAM,GAAyB,MAE7D,EAAe,GAAM,CACvB,IAAM,EAAS,EAAE,OAIjB,OAHK,EAGE,EAAO,IAAK,GAAMC,EAAE,MAAM,KAAK,MAF3B,IAKT,EAAc,GACZ,CAAC,GAAW,CAAC,MAAM,QAAQ,GACpB,EAIP,EACK,IAAK,GAAM,EAAE,SACb,OAAQ,GAAM,CAAC,CAAC,GAAK,OAAO,GAAM,UAElC,IAAK,GAAM,QAAQ,EAAE,SACrB,KAAK,IAIZ,EAAa,GAAM,CACrB,GAAI,CAAC,GAAK,CAAC,EAAE,OACT,MAAO,GAEX,IAAM,EAAO,EAAU,GACvB,MAAO,CACH,MAAO,GAAG,EAAE,gBAAgB,QAAQ,KAAM,EAAY,IAAI,IAAI,EAAO,CAAC,EAAE,OAAO,MAAO,EAAE,OAAO,SAAW,EAAE,OAAO,SAAS,MAAQ,OACpI,YAAa,EAAa,QAAQ,EAAO,CAAC,EAAE,OAAO,aAAc,EAAW,EAAE,OAAO,SAAU,EAAE,OAAO,OAAQ,EAAE,OAAO,QAAS,KAAK,SACvI,QAAS,EAAU,EAAE,aAAe,KACpC,OACA,OAAQ,EAAE,OAAO,OAAS,EAAE,OAAO,OAAO,KAAO,GACjD,KAAM,EACN,SAAU,CAAC,EAAE,QAIf,EAAM,EACP,OAAQ,GAAM,EAAE,MAChB,IAAK,GAAM,CACR,GAAI,GAAK,EAAE,MAAQ,EAAE,OAAS,aAAc,CAExC,IAAM,EAAQ,EAAE,WAAW,QAAQ,eAAgB,EAAE,KAAK,QACpD,EACF,EAAE,MAAQ,MAAM,QAAQ,EAAE,MACpB,EAAE,KACG,IAAK,GAAM,EAAUA,IACrB,IAAK,GAAM,YAAYA,EAAE,KAAK,OAAOA,EAAE,MAAM,iBAAiBA,EAAE,YAAY,WAC5E,KAAK,IACV,GACJ,EAAU,EAAE,MAAQ,MAAM,QAAQ,EAAE,OAAS,EAAE,KAAK,OAAS,EAAI,EAAU,EAAE,KAAK,GAAG,aAAe,KAAQ,IAAI,KAChH,EAAO,EAAE,KACf,MAAO,CACH,QACA,cACA,UACA,OACA,SAAU,CAAC,EAAE,OAGrB,OAAO,EAAU,KAGzB,MAAO,CACH,MAAO,SACP,KAAM,+BACN,KAAM"}