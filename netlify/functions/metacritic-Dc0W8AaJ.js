import{__dirname as e,init_esm_shims as t}from"./esm-shims-Dqvxr0BZ.js";import"./config-Dl8a1sIg.js";import"./logger-CWOoofbD.js";import"./dist-IvUHtNe1.js";import"./helpers-DzX-lcQO.js";import{art as n}from"./render-CxhTJIsl.js";import{parseDate as r}from"./parse-date-Bgabdhlb.js";import"./ofetch-Bzt0BXUH.js";import{got_default as i}from"./got-CdvI2yKX.js";import a from"node:path";import{load as o}from"cheerio";t();const s={metascore:{id:`metaScore`,name:`Metascore`},userscore:{id:`userScore`,name:`User Score`},popular:{id:`popularityCount`,name:`Most Popular`},new:{id:`releaseDate`,name:`Releases`}},c={game:{id:`games`,name:`Games`},movie:{id:`movies`,name:`Movies`},tv:{id:`tv`,name:`TV Shows`},albums:{id:`albums`,name:`Music`}},l={path:`/:type?/:sort?/:filter?`,name:`Unknown`,maintainers:[],handler:u};async function u(t){let{type:l=`game`,sort:u=`new`,filter:d}=t.req.param(),f=t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`),10):50,p=`https://www.metacritic.com`,m=new URL(`finder/metacritic/web`,`https://backend.metacritic.com`).href,h=new URL(`/browse/${l}/all/all/all-time/${u}/${d?`?${d}`:``}`,p),g=h.searchParams,_=h.href,{data:v}=await i(_),y=v.match(/apiKey=(.*?)&/)[1],b={sortBy:`-${s[u].id}`,productType:c[l].id,limit:f,apiKey:y},x=g.getAll(`genre`).join(`,`).toLowerCase(),S=g.getAll(`releaseType`).join(`,`),C=g.get(`releaseYearMin`),w=g.get(`releaseYearMax`);x&&(b.genres=x),S&&(b.releaseType=S),C&&(b.releaseYearMin=C),w&&(b.releaseYearMax=w);let T=g.getAll(`platform`),E=g.getAll(`network`);if(T.length||E.length){let e={},t=String.raw`{label:"([^"]+)",value:(\d+),href:a,meta:{mcDisplayWeight`;for(let n of v.match(new RegExp(t,`g`))){let r=n.match(new RegExp(t));e[r[1].toLowerCase().split(/(\s\(|\\u002f(?!\s))/)[0].replaceAll(`-`,`---`).replaceAll(/\s\/\s/g,`-or-`).replaceAll(`+`,`-plus`).replaceAll(/\s/g,`-`)]=r[2]}T.length&&(b.gamePlatformIds=T.map(t=>Object.hasOwn(e,t)?e[t]:void 0).filter(Boolean).join(`,`)),E.length&&(b.streamingNetworkIds=E.map(t=>Object.hasOwn(e,t)?e[t]:void 0).filter(Boolean).join(`,`))}let{data:D}=await i(m,{searchParams:b}),O=D.data.items.slice(0,f).map(t=>({title:t.title,link:new URL(`${l}/${t.slug}`,p).href,description:n(a.join(e,`templates/description-af955539.art`),{image:t.image?{src:new URL(`a/img/catalog${t.image.bucketPath}`,p).href,alt:t.image.alt}:void 0,description:t.description,score:t.criticScoreSummary?.score??void 0}),category:t.genres?.map(e=>e.name),guid:`metacritic-${t.id}`,pubDate:r(t.releaseDate),upvotes:t.criticScoreSummary?.positiveCount?Number.parseInt(t.criticScoreSummary?.positiveCount,10):0,downvotes:t.criticScoreSummary?.negativeCount?Number.parseInt(t.criticScoreSummary?.negativeCount,10):0,comments:t.criticScoreSummary?.reviewCount?Number.parseInt(t.criticScoreSummary?.reviewCount,10):0})),k=o(v),A=new URL(k(`meta[data-hid="msapplication-task-metacritic"]`).prop(`content`).split(`icon-uri=`).pop(),p).href;return{item:O,title:k(`title`).text(),link:_,description:k(`meta[name="description"]`).prop(`content`),language:k(`html`).prop(`lang`),image:k(`link[rel="icon"]`).prop(`content`),icon:A,logo:A,subtitle:k(`meta[name="msapplication-tooltip"]`).prop(`content`),author:k(`meta[name="twitter:site"]`).prop(`content`),allowEmpty:!0}}export{l as route};
//# sourceMappingURL=metacritic-Dc0W8AaJ.js.map