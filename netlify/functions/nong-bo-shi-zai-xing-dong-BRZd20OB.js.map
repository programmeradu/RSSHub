{"version":3,"file":"nong-bo-shi-zai-xing-dong-BRZd20OB.js","names":[],"sources":["../../lib/routes/hebtv/nong-bo-shi-zai-xing-dong.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst baseUrl = 'https://web.cmc.hebtv.com/cms/rmt0336/19/19js/st/ds/nmpd/nbszxd/index.shtml';\r\n\r\nexport const route: Route = {\r\n    path: '/nbszxd',\r\n    categories: ['traditional-media'],\r\n    example: '/hebtv/nbszxd',\r\n    parameters: {},\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: true,\r\n        supportPodcast: true,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['web.cmc.hebtv.com/cms/rmt0336/19/19js/st/ds/nmpd/nbszxd/index.shtml'],\r\n        },\r\n    ],\r\n    name: '农博士在行动',\r\n    maintainers: ['iamqiz', 'nczitzk'],\r\n    handler,\r\n    url: 'web.cmc.hebtv.com/cms/rmt0336/19/19js/st/ds/nmpd/nbszxd/index.shtml',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 40;\r\n\r\n    const apiRootUrl = 'http://api.cmc.hebtv.com';\r\n    const apiUrl = new URL('cmsback/api/article/getMyArticleDetail', apiRootUrl).href;\r\n\r\n    const response = await got(baseUrl);\r\n    const $ = load(response.data);\r\n\r\n    // 获取当前页面的 list\r\n    const list = $('.video_box .tv_items')\r\n        .first()\r\n        .children()\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            const a = item.find('a').first();\r\n            const timeMatch = a.text().match(/\\d+/);\r\n            const timestr = timeMatch ? timeMatch[0] : '';\r\n\r\n            return {\r\n                title: a.text(),\r\n                // `link` 需要一个绝对 URL，但 `a.attr('href')` 返回一个相对 URL。\r\n                link: `${baseUrl}/../${a.attr('href')}`,\r\n                pubDate: timestr ? timezone(parseDate(timestr, 'YYYYMMDD'), +8) : null,\r\n                author: '时间|' + timestr,\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.slice(0, limit).map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const tenantId = detailResponse.match(/tenantid = '(\\w+)';/)[1];\r\n                const articleId = item.link.match(/\\/nbszxd\\/(\\d+)/)[1];\r\n\r\n                const { data: apiResponse } = await got(apiUrl, {\r\n                    searchParams: {\r\n                        tenantId,\r\n                        articleId,\r\n                    },\r\n                });\r\n\r\n                const data = apiResponse.data;\r\n\r\n                let videoData;\r\n                if (data.articleContentDto?.videoDtoList?.length > 0) {\r\n                    videoData = data.articleContentDto?.videoDtoList[0];\r\n                }\r\n\r\n                item.title = data.title;\r\n                item.author = data.source;\r\n                item.guid = `hebtv-nbszxd-${articleId}`;\r\n                item.pubDate = timezone(parseDate(data.publishDate), +8);\r\n                item.updated = timezone(parseDate(data.modifyTime), +8);\r\n\r\n                if (videoData) {\r\n                    item.itunes_item_image = videoData.poster;\r\n                    item.itunes_duration = data.articleContentDto?.videoEditDtoList[0]?.sourceMediaInfo?.duration;\r\n                    item.enclosure_url = videoData.formats[0]?.url;\r\n                    item.enclosure_length = data.articleContentDto?.videoEditDtoList[0].sourceMediaInfo?.fileSize;\r\n                    item.enclosure_type = item.enclosure_url ? `video/${item.enclosure_url?.split(/\\./)?.pop()}` : undefined;\r\n                }\r\n\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    video: videoData\r\n                        ? {\r\n                              src: item.enclosure_url,\r\n                              type: item.enclosure_type,\r\n                              poster: item.itunes_item_image,\r\n                          }\r\n                        : undefined,\r\n                });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const description = $('meta[name=\"description\"]').prop('content');\r\n    const author = description.split(/,/)[0];\r\n    const icon = $('link[rel=\"shortcut icon\"]').prop('href');\r\n\r\n    return {\r\n        item: items,\r\n        title: $('title').text(),\r\n        link: baseUrl,\r\n        description,\r\n        language: $('html').prop('lang'),\r\n        image: $('div.logo a img').prop('src'),\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"keywords\"]').prop('content'),\r\n        author,\r\n        itunes_author: author,\r\n        itunes_category: 'News',\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"0gBAUA,MAAM,EAAU,8EAEH,EAAe,CACxB,KAAM,UACN,WAAY,CAAC,qBACb,QAAS,gBACT,WAAY,GACZ,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,yEAGjB,KAAM,SACN,YAAa,CAAC,SAAU,WACxB,UACA,IAAK,uEAGT,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAG/E,EAAS,IAAI,IAAI,yCAA0C,4BAAY,KAEvE,EAAW,MAAM,EAAI,GACrB,EAAI,EAAK,EAAS,MAGlB,EAAO,EAAE,wBACV,QACA,WACA,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GACT,IAAM,EAAI,EAAK,KAAK,KAAK,QACnB,EAAY,EAAE,OAAO,MAAM,OAC3B,EAAU,EAAY,EAAU,GAAK,GAE3C,MAAO,CACH,MAAO,EAAE,OAET,KAAM,GAAG,EAAQ,MAAM,EAAE,KAAK,UAC9B,QAAS,EAAU,EAAS,EAAU,EAAS,YAAa,GAAM,KAClE,OAAQ,MAAQ,KAItB,EAAQ,MAAM,QAAQ,IACxB,EAAK,MAAM,EAAG,GAAO,IAAK,GACtB,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAW,EAAe,MAAM,uBAAuB,GACvD,EAAY,EAAK,KAAK,MAAM,mBAAmB,GAE/C,CAAE,KAAM,GAAgB,MAAM,EAAI,EAAQ,CAC5C,aAAc,CACV,WACA,eAIF,EAAO,EAAY,KAErB,EA6BJ,OA5BI,EAAK,mBAAmB,cAAc,OAAS,IAC/C,EAAY,EAAK,mBAAmB,aAAa,IAGrD,EAAK,MAAQ,EAAK,MAClB,EAAK,OAAS,EAAK,OACnB,EAAK,KAAO,gBAAgB,IAC5B,EAAK,QAAU,EAAS,EAAU,EAAK,aAAc,GACrD,EAAK,QAAU,EAAS,EAAU,EAAK,YAAa,GAEhD,IACA,EAAK,kBAAoB,EAAU,OACnC,EAAK,gBAAkB,EAAK,mBAAmB,iBAAiB,IAAI,iBAAiB,SACrF,EAAK,cAAgB,EAAU,QAAQ,IAAI,IAC3C,EAAK,iBAAmB,EAAK,mBAAmB,iBAAiB,GAAG,iBAAiB,SACrF,EAAK,eAAiB,EAAK,cAAgB,SAAS,EAAK,eAAe,MAAM,OAAO,QAAU,IAAA,IAGnG,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACtE,MAAO,EACD,CACI,IAAK,EAAK,cACV,KAAM,EAAK,eACX,OAAQ,EAAK,mBAEjB,IAAA,KAGH,MAKb,EAAc,EAAE,4BAA4B,KAAK,WACjD,EAAS,EAAY,MAAM,KAAK,GAChC,EAAO,EAAE,6BAA6B,KAAK,QAEjD,MAAO,CACH,KAAM,EACN,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,cACA,SAAU,EAAE,QAAQ,KAAK,QACzB,MAAO,EAAE,kBAAkB,KAAK,OAChC,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,SACA,cAAe,EACf,gBAAiB,OACjB,WAAY"}