{"version":3,"file":"hashtag-llc2OvT-.js","names":["route: Route","InvalidParameterError","cache","puppeteer"],"sources":["../../lib/routes/douyin/hashtag.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport { config } from '@/config';\r\nimport { fallback, queryToBoolean } from '@/utils/readable-social';\r\nimport { templates, resolveUrl, proxyVideo, getOriginAvatar } from './utils';\r\nimport puppeteer from '@/utils/puppeteer';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/hashtag/:cid/:routeParams?',\r\n    categories: ['social-media'],\r\n    example: '/douyin/hashtag/1592824105719812',\r\n    parameters: { cid: '标签 ID，可在标签页面 URL 中找到', routeParams: '额外参数，query string 格式，请参阅上面的表格' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['douyin.com/hashtag/:cid'],\r\n            target: '/hashtag/:cid',\r\n        },\r\n    ],\r\n    name: '标签',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const cid = ctx.req.param('cid');\r\n    if (Number.isNaN(cid)) {\r\n        throw new InvalidParameterError('Invalid tag ID. Tag ID should be a number.');\r\n    }\r\n    const routeParams = Object.fromEntries(new URLSearchParams(ctx.req.param('routeParams')));\r\n    const embed = fallback(undefined, queryToBoolean(routeParams.embed), false); // embed video\r\n    const iframe = fallback(undefined, queryToBoolean(routeParams.iframe), false); // embed video in iframe\r\n    const relay = resolveUrl(routeParams.relay, true, true); // embed video behind a reverse proxy\r\n\r\n    const tagUrl = `https://www.douyin.com/hashtag/${cid}`;\r\n\r\n    const tagData = await cache.tryGet(\r\n        `douyin:hashtag:${cid}`,\r\n        async () => {\r\n            const browser = await puppeteer();\r\n            const page = await browser.newPage();\r\n            await page.setRequestInterception(true);\r\n            let awemeList = '';\r\n            page.on('request', (request) => {\r\n                request.resourceType() === 'document' || request.resourceType() === 'script' || request.resourceType() === 'xhr' ? request.continue() : request.abort();\r\n            });\r\n            page.on('response', async (response) => {\r\n                const request = response.request();\r\n                if (request.url().includes('/v1/web/challenge/aweme')) {\r\n                    awemeList = await response.json();\r\n                }\r\n            });\r\n            await page.goto(tagUrl, {\r\n                waitUntil: 'networkidle2',\r\n            });\r\n            await page.waitForSelector('#RENDER_DATA');\r\n            const html = await page.evaluate(() => document.querySelector('#RENDER_DATA').textContent);\r\n            await browser.close();\r\n\r\n            const renderData = JSON.parse(decodeURIComponent(html));\r\n            const dataKey = Object.keys(renderData).find((key) => renderData[key].topicDetail);\r\n            renderData[dataKey].defaultData = awemeList.aweme_list;\r\n            return renderData[dataKey];\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const tagInfo = tagData.topicDetail;\r\n    const tagName = tagInfo.chaName;\r\n    const userAvatar = getOriginAvatar(tagInfo.hashtagProfile);\r\n\r\n    const posts = tagData.defaultData;\r\n    const items = posts.map((post) => {\r\n        // parse video\r\n        let videoList = post.video && post.video.bit_rate && post.video.bit_rate.map((bit_rate) => resolveUrl(bit_rate.play_addr.url_list[0]));\r\n        if (relay) {\r\n            videoList = videoList.map((item) => proxyVideo(item, relay));\r\n        }\r\n        let duration = post.video && post.video.duration;\r\n        duration = duration && duration / 1000;\r\n        let img;\r\n        // if (!embed) {\r\n        //     img = post.video && post.video.dynamic_cover && post.video.dynamic_cover.url_list[post.video.dynamic_cover.url_list.length - 1]; // dynamic cover (webp)\r\n        // }\r\n        img = img || (post.video && post.video.origin_cover && post.video.origin_cover.url_list.at(-1));\r\n        img = img && resolveUrl(img);\r\n\r\n        // render description\r\n        const desc = post.desc && post.desc.replaceAll('\\n', '<br>');\r\n        let media = art(embed && videoList ? templates.embed : templates.cover, { img, videoList, duration });\r\n        media = embed && videoList && iframe ? art(templates.iframe, { content: media }) : media; // warp in iframe\r\n        const description = art(templates.desc, { desc, media });\r\n\r\n        return {\r\n            title: post.desc,\r\n            description,\r\n            link: `https://www.douyin.com/video/${post.aweme_id}`,\r\n            pubDate: parseDate(post.create_time, 'X'),\r\n            category: post.text_extra.map((extra) => extra.hashtag_name),\r\n            author: post.author.nickname,\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: tagName,\r\n        description: `${tagInfo.viewCount} 次播放`,\r\n        image: userAvatar,\r\n        link: tagUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"qlBAUA,MAAaA,EAAe,CACxB,KAAM,8BACN,WAAY,CAAC,gBACb,QAAS,mCACT,WAAY,CAAE,IAAK,uBAAwB,YAAa,iCACxD,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,2BACT,OAAQ,kBAGhB,KAAM,KACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAM,EAAI,IAAI,MAAM,OAC1B,GAAI,OAAO,MAAM,GACb,MAAM,IAAIC,EAAsB,8CAEpC,IAAM,EAAc,OAAO,YAAY,IAAI,gBAAgB,EAAI,IAAI,MAAM,iBACnE,EAAQ,EAAS,IAAA,GAAW,EAAe,EAAY,OAAQ,IAC/D,EAAS,EAAS,IAAA,GAAW,EAAe,EAAY,QAAS,IACjE,EAAQ,EAAW,EAAY,MAAO,GAAM,IAE5C,EAAS,kCAAkC,IAE3C,EAAU,MAAMC,EAAM,OACxB,kBAAkB,IAClB,SAAY,CACR,IAAM,EAAU,MAAMC,IAChB,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,IAAI,EAAY,GAChB,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,UAAY,EAAQ,iBAAmB,MAAQ,EAAQ,WAAa,EAAQ,UAEpJ,EAAK,GAAG,WAAY,KAAO,IAAa,CACpC,IAAM,EAAU,EAAS,UACrB,EAAQ,MAAM,SAAS,6BACvB,EAAY,MAAM,EAAS,UAGnC,MAAM,EAAK,KAAK,EAAQ,CACpB,UAAW,iBAEf,MAAM,EAAK,gBAAgB,gBAC3B,IAAM,EAAO,MAAM,EAAK,aAAe,SAAS,cAAc,gBAAgB,aAC9E,MAAM,EAAQ,QAEd,IAAM,EAAa,KAAK,MAAM,mBAAmB,IAC3C,EAAU,OAAO,KAAK,GAAY,KAAM,GAAQ,EAAW,GAAK,aAEtE,MADA,GAAW,GAAS,YAAc,EAAU,WACrC,EAAW,IAEtB,EAAO,MAAM,YACb,IAGE,EAAU,EAAQ,YAClB,EAAU,EAAQ,QAClB,EAAa,EAAgB,EAAQ,gBAErC,EAAQ,EAAQ,YAChB,EAAQ,EAAM,IAAK,GAAS,CAE9B,IAAI,EAAY,EAAK,OAAS,EAAK,MAAM,UAAY,EAAK,MAAM,SAAS,IAAK,GAAa,EAAW,EAAS,UAAU,SAAS,KAC9H,IACA,EAAY,EAAU,IAAK,GAAS,EAAW,EAAM,KAEzD,IAAI,EAAW,EAAK,OAAS,EAAK,MAAM,SACxC,EAAW,GAAY,EAAW,IAClC,IAAI,EAIJ,EAAM,GAAQ,EAAK,OAAS,EAAK,MAAM,cAAgB,EAAK,MAAM,aAAa,SAAS,GAAG,IAC3F,EAAM,GAAO,EAAW,GAGxB,IAAM,EAAO,EAAK,MAAQ,EAAK,KAAK,WAAW;EAAM,QACjD,EAAQ,EAAI,GAAS,EAAY,EAAU,MAAQ,EAAU,MAAO,CAAE,MAAK,YAAW,aAC1F,EAAQ,GAAS,GAAa,EAAS,EAAI,EAAU,OAAQ,CAAE,QAAS,IAAW,EACnF,IAAM,EAAc,EAAI,EAAU,KAAM,CAAE,OAAM,UAEhD,MAAO,CACH,MAAO,EAAK,KACZ,cACA,KAAM,gCAAgC,EAAK,WAC3C,QAAS,EAAU,EAAK,YAAa,KACrC,SAAU,EAAK,WAAW,IAAK,GAAU,EAAM,cAC/C,OAAQ,EAAK,OAAO,YAI5B,MAAO,CACH,MAAO,EACP,YAAa,GAAG,EAAQ,UAAU,MAClC,MAAO,EACP,KAAM,EACN,KAAM"}