{"version":3,"file":"common-DEd0m-Z-.js","names":[],"sources":["../../lib/routes/reuters/common.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/:category/:topic?',\r\n    categories: ['traditional-media'],\r\n    view: ViewType.Articles,\r\n    example: '/reuters/world/us',\r\n    parameters: {\r\n        category: {\r\n            description: 'find it in the URL, or tables below',\r\n            options: [\r\n                { value: 'world', label: 'World' },\r\n                { value: 'business', label: 'Business' },\r\n                { value: 'legal', label: 'Legal' },\r\n                { value: 'markets', label: 'Markets' },\r\n                { value: 'breakingviews', label: 'Breakingviews' },\r\n                { value: 'technology', label: 'Technology' },\r\n                { value: 'graphics', label: 'Graphics' },\r\n                { value: 'authors', label: 'Authors' },\r\n            ],\r\n            default: 'world',\r\n        },\r\n        topic: 'find it in the URL, or tables below, leave empty for `All`',\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['reuters.com/:category/:topic?', 'reuters.com/'],\r\n        },\r\n    ],\r\n    name: 'Category/Topic/Author',\r\n    maintainers: ['LyleLee', 'HenryQW', 'proletarius101', 'black-desk', 'nczitzk', 'pseudoyu'],\r\n    handler,\r\n    description: `-   \\`:category\\`:\r\n\r\n      | World | Business | Legal | Markets | Breakingviews | Technology | Graphics |\r\n      | ----- | -------- | ----- | ------- | ------------- | ---------- | -------- |\r\n      | world | business | legal | markets | breakingviews | technology | graphics |\r\n\r\n  -   \\`world/:topic\\`:\r\n\r\n      | All | Africa | Americas | Asia Pacific | China | Europe | India | Middle East | United Kingdom | United States | The Great Reboot | Reuters Next |\r\n      | --- | ------ | -------- | ------------ | ----- | ------ | ----- | ----------- | -------------- | ------------- | ---------------- | ------------ |\r\n      |     | africa | americas | asia-pacific | china | europe | india | middle-east | uk             | us            | the-great-reboot | reuters-next |\r\n\r\n  -   \\`business/:topic\\`:\r\n\r\n      | All | Aerospace & Defense | Autos & Transportation | Energy | Environment | Finance | Healthcare & Pharmaceuticals | Media & Telecom | Retail & Consumer | Sustainable Business | Charged | Future of Health | Future of Money | Take Five | Reuters Impact |\r\n      | --- | ------------------- | ---------------------- | ------ | ----------- | ------- | ---------------------------- | --------------- | ----------------- | -------------------- | ------- | ---------------- | --------------- | --------- | -------------- |\r\n      |     | aerospace-defense   | autos-transportation   | energy | environment | finance | healthcare-pharmaceuticals   | media-telecom   | retail-consumer   | sustainable-business | charged | future-of-health | future-of-money | take-five | reuters-impact |\r\n\r\n  -   \\`legal/:topic\\`:\r\n\r\n      | All | Government | Legal Industry | Litigation | Transactional |\r\n      | --- | ---------- | -------------- | ---------- | ------------- |\r\n      |     | government | legalindustry  | litigation | transactional |\r\n\r\n  -   \\`authors/:topic\\`:\r\n\r\n      | Default | Jonathan Landay | any other authors |\r\n      | ------- | --------------- | ----------------- |\r\n      | reuters | jonathan-landay | their name in URL |\r\n\r\n  More could be found in the URL of the category/topic page.`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const MUST_FETCH_BY_TOPICS = new Set(['authors', 'tags']);\r\n    const CAN_USE_SOPHI = ['world'];\r\n\r\n    const category = ctx.req.param('category');\r\n    const topic = ctx.req.param('topic') ?? (category === 'authors' ? 'reuters' : '');\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 20;\r\n    const useSophi = ctx.req.query('sophi') === 'true' && topic !== '' && CAN_USE_SOPHI.includes(category);\r\n\r\n    const section_id = `/${category}/${topic ? `${topic}/` : ''}`;\r\n\r\n    const browserHeaders = {\r\n        Accept: 'application/json, text/plain, */*',\r\n        'Accept-Language': 'en-US,en;q=0.9',\r\n        Referer: 'https://www.reuters.com/',\r\n    };\r\n\r\n    try {\r\n        const { title, description, rootUrl, response } = await (async () => {\r\n            if (MUST_FETCH_BY_TOPICS.has(category)) {\r\n                const rootUrl = 'https://www.reuters.com/pf/api/v3/content/fetch/articles-by-topic-v1';\r\n                const response = await ofetch(rootUrl, {\r\n                    query: {\r\n                        query: JSON.stringify({\r\n                            offset: 0,\r\n                            size: limit,\r\n                            topic_url: section_id,\r\n                            website: 'reuters',\r\n                        }),\r\n                    },\r\n                    headers: browserHeaders,\r\n                });\r\n\r\n                return {\r\n                    title: `${response.result.topics[0].name} | Reuters`,\r\n                    description: response.result.topics[0].entity_id,\r\n                    rootUrl,\r\n                    response,\r\n                };\r\n            } else {\r\n                const rootUrl = 'https://www.reuters.com/pf/api/v3/content/fetch/articles-by-section-alias-or-id-v1';\r\n                const response = await ofetch(rootUrl, {\r\n                    query: {\r\n                        query: JSON.stringify({\r\n                            offset: 0,\r\n                            size: limit,\r\n                            section_id,\r\n                            website: 'reuters',\r\n                            ...(useSophi\r\n                                ? {\r\n                                      fetch_type: 'sophi',\r\n                                      sophi_page: '*',\r\n                                      sophi_widget: 'topic',\r\n                                  }\r\n                                : {}),\r\n                        }),\r\n                    },\r\n                    headers: browserHeaders,\r\n                });\r\n                return {\r\n                    title: response.result.section.title,\r\n                    description: response.result.section.section_about,\r\n                    rootUrl,\r\n                    response,\r\n                };\r\n            }\r\n        })();\r\n\r\n        let items = response.result.articles.map((e) => ({\r\n            title: e.title,\r\n            link: new URL(e.canonical_url, rootUrl).href,\r\n            guid: e.id,\r\n            pubDate: parseDate(e.published_time),\r\n            updated: parseDate(e.updated_time),\r\n            author: e.authors.map((e) => e.name).join(', '),\r\n            category: e.kicker.names,\r\n            description: e.description,\r\n        }));\r\n\r\n        items = items.filter((e, i) => items.findIndex((f) => e.guid === f.guid) === i);\r\n\r\n        const results = await Promise.allSettled(\r\n            items.map((item) =>\r\n                ctx.req.query('fulltext') === 'true'\r\n                    ? cache.tryGet(item.link, async () => {\r\n                          const detailResponse = await ofetch(item.link, {\r\n                              headers: browserHeaders,\r\n                          });\r\n                          const content = load(detailResponse.data);\r\n\r\n                          if (detailResponse.url.startsWith('https://www.reuters.com/investigates/')) {\r\n                              const ldJson = JSON.parse(content('script[type=\"application/ld+json\"]').text());\r\n                              content('.special-report-article-container .container, #slide-dek, #slide-end, .share-in-article-container').remove();\r\n\r\n                              item.title = ldJson.headline;\r\n                              item.pubDate = parseDate(ldJson.dateCreated);\r\n                              item.author = ldJson.creator;\r\n                              item.category = ldJson.keywords;\r\n                              item.description = content('.special-report-article-container').html();\r\n\r\n                              return item;\r\n                          }\r\n\r\n                          const matches = content('script#fusion-metadata')\r\n                              .text()\r\n                              .match(/Fusion.globalContent=({[\\S\\s]*?});/);\r\n\r\n                          if (matches) {\r\n                              const data = JSON.parse(matches[1]);\r\n\r\n                              item.title = data.result.title || item.title;\r\n                              item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                                  result: data.result,\r\n                              });\r\n                              item.pubDate = parseDate(data.result.display_time);\r\n                              item.author = data.result.authors.map((author) => author.name).join(', ');\r\n                              item.category = data.result.taxonomy.keywords;\r\n\r\n                              return item;\r\n                          }\r\n\r\n                          content('.title').remove();\r\n                          content('.article-metadata').remove();\r\n\r\n                          item.title = content('meta[property=\"og:title\"]').attr('content');\r\n                          item.pubDate = parseDate(detailResponse.data.match(/\"datePublished\":\"(.*?)\",\"dateModified/)[1]);\r\n                          item.author = detailResponse.data\r\n                              .match(/{\"@type\":\"Person\",\"name\":\"(.*?)\"}/g)\r\n                              .map((p) => p.match(/\"name\":\"(.*?)\"/)[1])\r\n                              .join(', ');\r\n                          item.description = content('article').html();\r\n\r\n                          return item;\r\n                      })\r\n                    : item\r\n            )\r\n        );\r\n        items = results.filter((r) => r.status === 'fulfilled').map((r) => r.value);\r\n\r\n        return {\r\n            title,\r\n            description,\r\n            image: 'https://www.reuters.com/pf/resources/images/reuters/logo-vertical-default-512x512.png?d=116',\r\n            link: `https://www.reuters.com${section_id}`,\r\n            item: items,\r\n        };\r\n    } catch {\r\n        // Fallback to arc outboundfeeds if API fails\r\n        const arcUrl = topic ? `https://www.reuters.com/arc/outboundfeeds/v4/mobile/section${section_id}?outputType=json` : `https://www.reuters.com/arc/outboundfeeds/v4/mobile/section/${category}/?outputType=json`;\r\n\r\n        const arcResponse = await ofetch(arcUrl, {\r\n            headers: browserHeaders,\r\n        });\r\n        if (arcResponse.wireitems?.length) {\r\n            const items = arcResponse.wireitems\r\n                .map((item) => {\r\n                    const story = item.templates.find((t) => t.template === 'story_with_image')?.story;\r\n                    if (!story) {\r\n                        return null;\r\n                    }\r\n\r\n                    return {\r\n                        title: story.hed,\r\n                        link: item.templates.find((t) => t.template === 'story_with_image')?.template_action?.url,\r\n                        guid: story.usn,\r\n                        pubDate: parseDate(story.updated_at),\r\n                        updated: parseDate(story.updated_at),\r\n                        description: story.lede,\r\n                        author: story.authors?.map((author) => author.name).join(', '),\r\n                        category: [arcResponse.analytics?.topic_channel, arcResponse.analytics?.topic_sub_channel].filter(Boolean),\r\n                    };\r\n                })\r\n                .filter(Boolean);\r\n\r\n            return {\r\n                title: arcResponse.analytics?.title || `${arcResponse.wire_name} | Reuters`,\r\n                description: arcResponse.analytics?.content_title,\r\n                image: 'https://www.reuters.com/pf/resources/images/reuters/logo-vertical-default-512x512.png?d=116',\r\n                link: arcResponse.canonical_action?.url || `https://www.reuters.com${section_id}`,\r\n                category: [arcResponse.analytics?.topic_channel, arcResponse.analytics?.topic_sub_channel].filter(Boolean),\r\n                item: items.slice(0, limit),\r\n            };\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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"}