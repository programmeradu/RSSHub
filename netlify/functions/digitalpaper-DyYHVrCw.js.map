{"version":3,"file":"digitalpaper-DyYHVrCw.js","names":[],"sources":["../../lib/routes/stdaily/digitalpaper.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\n\r\nconst renderDescription = ({ subtitle, quotation, pics, article }) =>\r\n    art(path.join(__dirname, 'templates/description.art'), {\r\n        subtitle,\r\n        quotation,\r\n        pics,\r\n        article,\r\n    });\r\n\r\nconst getPageLength = async (url) => {\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n    const pageLength = $('.right1 .bmname').children().length;\r\n    return { pageLength, $ };\r\n};\r\n\r\nconst getArticleList = ($, paperUrl) => {\r\n    const pageName = $('.zi .zi-top .banci strong').text();\r\n    const list = $('.zi-meat ul>li')\r\n        .toArray()\r\n        .map((item) => {\r\n            const link = $(item).find('a').attr('href');\r\n            const title = $(item).find('a div').text();\r\n            return {\r\n                link: `${paperUrl}/${link}`,\r\n                title: `[${pageName}] ${title}`,\r\n                // pubDate,\r\n            };\r\n        });\r\n\r\n    return list;\r\n};\r\nconst createGetPageArticleList = (paperUrl, page = 1) => {\r\n    const getPageArticleList = async () => {\r\n        const currentUrl = `${paperUrl}/node_${page + 1}.htm`;\r\n        const response = await got({\r\n            method: 'get',\r\n            url: currentUrl,\r\n        });\r\n\r\n        const $ = load(response.data);\r\n        return getArticleList($, paperUrl);\r\n    };\r\n\r\n    return getPageArticleList;\r\n};\r\n\r\nconst getListArticles = async (list, cache) => {\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data } = await got(item.link);\r\n                const $ = load(data);\r\n\r\n                const quotation = $('.right-meat .yinti').text();\r\n                const subtitle = $('.right-meat .futi').text();\r\n                const article = $('.right-meat .tuwen .article #ozoom').html();\r\n                const pics = $('.right-meat .tuwen .picture')\r\n                    .toArray()\r\n                    .map((item) => {\r\n                        const pic = {};\r\n                        $(item)\r\n                            .find('tr')\r\n                            .toArray()\r\n                            .map((row) => {\r\n                                const src = $(row).find('img').attr('src');\r\n                                if (src) {\r\n                                    pic.src = src;\r\n                                } else {\r\n                                    pic.des = $(row).find('td').text();\r\n                                }\r\n                                return null;\r\n                            });\r\n                        return pic;\r\n                    });\r\n\r\n                item.author = $('.right-meat .author').text();\r\n                item.description = renderDescription({ subtitle, quotation, article, pics });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n    return items;\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/digitalpaper',\r\n    categories: ['traditional-media'],\r\n    example: '/stdaily/digitalpaper',\r\n    parameters: {},\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '科技日报',\r\n    maintainers: ['lyqluis'],\r\n    handler,\r\n};\r\n\r\nasync function handler() {\r\n    const date = new Date();\r\n    const dateStr = date.toLocaleDateString('zh-CN', {\r\n        year: 'numeric',\r\n        month: '2-digit',\r\n        day: '2-digit',\r\n    });\r\n    const formatedDate = dateStr.replace('/', '-'); // 'yyyy-mm/dd'\r\n\r\n    const rootUrl = 'http://digitalpaper.stdaily.com/http_www.kjrb.com/kjrb/html';\r\n    const currentUrl = `${rootUrl}/${formatedDate}`;\r\n\r\n    // get page\r\n    const restPageLists = [];\r\n    const allPageArticleLists = [];\r\n    const { pageLength, $ } = await getPageLength(`${currentUrl}/node_2.htm`);\r\n    allPageArticleLists.push(...getArticleList($, currentUrl));\r\n    for (let i = 2; i <= pageLength; i++) {\r\n        restPageLists.push(createGetPageArticleList(currentUrl, i));\r\n    }\r\n    // get pages' article list\r\n    allPageArticleLists.push(...(await Promise.all(restPageLists.map((getPageArticleList) => getPageArticleList()))).flat());\r\n    // get all articles\r\n    const items = await getListArticles(allPageArticleLists, cache);\r\n\r\n    return {\r\n        title: `科技日报`,\r\n        link: 'http://digitalpaper.stdaily.com',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"maAQA,MAAM,GAAqB,CAAE,WAAU,YAAW,OAAM,aACpD,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACnD,WACA,YACA,OACA,YAGF,EAAgB,KAAO,IAAQ,CACjC,IAAM,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,QAGE,EAAI,EAAK,EAAS,MAClB,EAAa,EAAE,mBAAmB,WAAW,OACnD,MAAO,CAAE,aAAY,MAGnB,GAAkB,EAAG,IAAa,CACpC,IAAM,EAAW,EAAE,6BAA6B,OAC1C,EAAO,EAAE,kBACV,UACA,IAAK,GAAS,CACX,IAAM,EAAO,EAAE,GAAM,KAAK,KAAK,KAAK,QAC9B,EAAQ,EAAE,GAAM,KAAK,SAAS,OACpC,MAAO,CACH,KAAM,GAAG,EAAS,GAAG,IACrB,MAAO,IAAI,EAAS,IAAI,OAKpC,OAAO,GAEL,GAA4B,EAAU,EAAO,IAAM,CACrD,IAAM,EAAqB,SAAY,CACnC,IAAM,EAAa,GAAG,EAAS,QAAQ,EAAO,EAAE,MAC1C,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MACxB,OAAO,EAAe,EAAG,IAG7B,OAAO,GAGL,EAAkB,MAAO,EAAM,IAAU,CAC3C,IAAM,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,QAAS,MAAM,EAAI,EAAK,MAC1B,EAAI,EAAK,GAET,EAAY,EAAE,sBAAsB,OACpC,EAAW,EAAE,qBAAqB,OAClC,EAAU,EAAE,sCAAsC,OAClD,EAAO,EAAE,+BACV,UACA,IAAK,GAAS,CACX,IAAM,EAAM,GAaZ,OAZA,EAAE,GACG,KAAK,MACL,UACA,IAAK,GAAQ,CACV,IAAM,EAAM,EAAE,GAAK,KAAK,OAAO,KAAK,OAMpC,OALI,EACA,EAAI,IAAM,EAEV,EAAI,IAAM,EAAE,GAAK,KAAK,MAAM,OAEzB,OAER,IAMf,MAHA,GAAK,OAAS,EAAE,uBAAuB,OACvC,EAAK,YAAc,EAAkB,CAAE,WAAU,YAAW,UAAS,SAE9D,MAInB,OAAO,GAGE,EAAe,CACxB,KAAM,gBACN,WAAY,CAAC,qBACb,QAAS,wBACT,WAAY,GACZ,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,WACd,WAGJ,eAAe,GAAU,CACrB,IAAM,EAAO,IAAI,KACX,EAAU,EAAK,mBAAmB,QAAS,CAC7C,KAAM,UACN,MAAO,UACP,IAAK,YAEH,EAAe,EAAQ,QAAQ,IAAK,KAGpC,EAAa,+DAAc,IAG3B,EAAgB,GAChB,EAAsB,GACtB,CAAE,aAAY,KAAM,MAAM,EAAc,GAAG,EAAW,cAC5D,EAAoB,KAAK,GAAG,EAAe,EAAG,IAC9C,IAAK,IAAI,EAAI,EAAG,GAAK,EAAY,IAC7B,EAAc,KAAK,EAAyB,EAAY,IAG5D,EAAoB,KAAK,IAAI,MAAM,QAAQ,IAAI,EAAc,IAAK,GAAuB,OAAwB,QAEjH,IAAM,EAAQ,MAAM,EAAgB,EAAqB,GAEzD,MAAO,CACH,MAAO,OACP,KAAM,kCACN,KAAM"}