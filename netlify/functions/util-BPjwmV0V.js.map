{"version":3,"file":"util-BPjwmV0V.js","names":[],"sources":["../../lib/routes/zaobao/util.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseRelativeDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { base32 } from 'rfc4648';\r\n\r\nconst baseUrl = 'https://www.zaobao.com';\r\nconst got_ins = got.extend({\r\n    headers: {\r\n        Referer: baseUrl,\r\n    },\r\n});\r\n\r\n/**\r\n * 通用解析页面类似 https://www.zaobao.com/realtime/china 的网站\r\n *\r\n * @param {*} ctx RSSHub 的 ctx 参数，用来设置缓存\r\n * @param {string} sectionUrl 形如 /realtime/china 的字符串\r\n * @returns 新闻标题以及新闻列表\r\n */\r\nconst parseList = async (\r\n    ctx,\r\n    sectionUrl: string\r\n): Promise<{\r\n    title: string;\r\n    resultList: {\r\n        title: string;\r\n        description: string;\r\n        pubDate: string;\r\n        link: string;\r\n    }[];\r\n}> => {\r\n    const response = await got_ins.get(baseUrl + sectionUrl);\r\n    const $ = load(response.data);\r\n    let data = $('.card-listing .card .content-header a');\r\n    if (data.length === 0) {\r\n        // for HK version\r\n        data = $('[data-testid=\"article-list\"] article a.article-link');\r\n    }\r\n\r\n    const title = $('meta[property=\"og:title\"]').attr('content');\r\n\r\n    const resultList = await Promise.all(\r\n        data.toArray().map((item) => {\r\n            const $item = $(item);\r\n            // addBack: for HK version\r\n            let link = $item.attr('href');\r\n\r\n            if (link[0] !== '/') {\r\n                // https://www.zaobao.com/interactive-graphics\r\n                const title = $item.find('a').text();\r\n                let dateNodes = $item.find('.meta-published-date');\r\n                if (dateNodes.length === 0) {\r\n                    dateNodes = $item.find('.datestamp');\r\n                }\r\n                let dateString;\r\n                let pubDate;\r\n                if (dateNodes.length !== 0) {\r\n                    dateString = dateNodes.text().trim();\r\n                    const dateParts = dateString.split('/');\r\n                    dateParts.reverse();\r\n                    dateString = dateParts.join('-');\r\n                    pubDate = parseRelativeDate(dateString);\r\n                    // if conversion was no success, pubDate === dateString\r\n                    // zaobao seems always UTC+8\r\n                    pubDate = pubDate === dateString ? undefined : timezone(pubDate, +8);\r\n                }\r\n\r\n                return {\r\n                    title,\r\n                    description: title,\r\n                    pubDate,\r\n                    link,\r\n                };\r\n            }\r\n\r\n            link = baseUrl + link;\r\n\r\n            return cache.tryGet(link, async () => {\r\n                const article = await got_ins.get(link);\r\n                const $1 = load(article.data);\r\n\r\n                let title, time;\r\n                if ($1('#seo-article-page').text() === '') {\r\n                    // HK\r\n                    title = $1('h1.article-title').text();\r\n                    const jsonText = $1(\"head script[type='application/ld+json']\")\r\n                        .eq(0)\r\n                        .text()\r\n                        .replaceAll(/[\\u0000-\\u001F\\u007F-\\u009F]/g, '');\r\n                    time = new Date(JSON.parse(jsonText)?.datePublished);\r\n                } else {\r\n                    // SG\r\n                    const jsonText = $1('#seo-article-page')\r\n                        .text()\r\n                        .replaceAll(/[\\u0000-\\u001F\\u007F-\\u009F]/g, '');\r\n                    const json = JSON.parse(jsonText);\r\n                    title = json['@graph'][0]?.headline;\r\n                    time = new Date(json['@graph'][0]?.datePublished);\r\n                }\r\n\r\n                $1('.overlay-microtransaction').remove();\r\n                $1('#video-freemium-player').remove();\r\n                $1('script').remove();\r\n                $1('.bff-google-ad').remove();\r\n                $1('.bff-recommend-article').remove();\r\n\r\n                let articleBodyNode = $1('.articleBody');\r\n                if (articleBodyNode.length === 0) {\r\n                    // for HK version\r\n                    $1('.read-on-app-cover').remove();\r\n                    $1('astro-island').remove();\r\n                    $1('.further-reading').remove();\r\n                    articleBodyNode = $1('.article-body');\r\n                }\r\n\r\n                const articleBody = articleBodyNode.html();\r\n\r\n                const imageDataArray = processImageData($1);\r\n\r\n                return {\r\n                    // <- for HK version  -> for SG version\r\n                    title,\r\n                    description: art(path.join(__dirname, 'templates/zaobao.art'), {\r\n                        articleBody,\r\n                        imageDataArray,\r\n                    }),\r\n                    pubDate: time,\r\n                    link,\r\n                };\r\n            });\r\n        })\r\n    );\r\n    return {\r\n        title,\r\n        resultList,\r\n    };\r\n};\r\n\r\nconst orderContent = (parent) => {\r\n    for (const [i, e] of parent\r\n        .children()\r\n        .toArray()\r\n        .sort((a, b) => {\r\n            const index = Buffer.from(base32.parse('GM======')).toString(); // substring(3)\r\n            a = Buffer.from(base32.parse(parent.find(a).data('s').slice(index))).toString();\r\n            b = Buffer.from(base32.parse(parent.find(b).data('s').slice(index))).toString();\r\n            return a - b;\r\n        })\r\n        .entries()) {\r\n        parent.find(e).attr('s', i);\r\n        parent.append(e);\r\n    }\r\n};\r\n\r\ninterface ImageData {\r\n    type: string;\r\n    html: string;\r\n    src?: string;\r\n    title?: string;\r\n}\r\n\r\nconst processImageData = ($1) => {\r\n    const imageDataArray: ImageData[] = [];\r\n\r\n    const imageSelectors = [\r\n        '.inline-figure-img', // for SG version\r\n        '.body-content .loadme picture img', // Unused?\r\n        '.inline-figure-gallery', // for SG version\r\n        '#carousel-article', // for HK version, HK version of multi images use same selector as single image, so g is needed for all pages\r\n    ];\r\n\r\n    for (const selector of imageSelectors) {\r\n        if ($1(selector).length) {\r\n            let html = $1(selector === '#carousel-article' ? '#carousel-article .carousel-inner' : selector).html();\r\n\r\n            if (html) {\r\n                html = html.replaceAll(/\\/\\/.*\\.com\\/s3fs-public/g, '//static.zaobao.com/s3fs-public').replaceAll('s3/files', 's3fs-public');\r\n\r\n                imageDataArray.push({\r\n                    type: selector === '.body-content .loadme picture img' ? 'data' : 'normalHTML',\r\n                    html,\r\n                    ...(selector === '.body-content .loadme picture img' && {\r\n                        src: $1('.body-content .loadme picture source').attr('data-srcset'),\r\n                        title: $1(selector).attr('title'),\r\n                    }),\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    return imageDataArray;\r\n};\r\n\r\nexport { parseList, orderContent };\r\n"],"mappings":"kZASA,MAAM,EAAU,yBACV,EAAU,EAAI,OAAO,CACvB,QAAS,CACL,QAAS,KAWX,EAAY,MACd,EACA,IASE,CACF,IAAM,EAAW,MAAM,EAAQ,IAAI,EAAU,GACvC,EAAI,EAAK,EAAS,MACpB,EAAO,EAAE,yCACT,EAAK,SAAW,IAEhB,EAAO,EAAE,wDAGb,IAAM,EAAQ,EAAE,6BAA6B,KAAK,WAE5C,EAAa,MAAM,QAAQ,IAC7B,EAAK,UAAU,IAAK,GAAS,CACzB,IAAM,EAAQ,EAAE,GAEZ,EAAO,EAAM,KAAK,QAEtB,GAAI,EAAK,KAAO,IAAK,CAEjB,IAAM,EAAQ,EAAM,KAAK,KAAK,OAC1B,EAAY,EAAM,KAAK,wBACvB,EAAU,SAAW,IACrB,EAAY,EAAM,KAAK,eAE3B,IAAI,EACA,EACJ,GAAI,EAAU,SAAW,EAAG,CACxB,EAAa,EAAU,OAAO,OAC9B,IAAM,EAAY,EAAW,MAAM,KACnC,EAAU,UACV,EAAa,EAAU,KAAK,KAC5B,EAAU,EAAkB,GAG5B,EAAU,IAAY,EAAa,IAAA,GAAY,EAAS,EAAS,GAGrE,MAAO,CACH,MAAA,EACA,YAAa,EACb,UACA,QAMR,MAFA,GAAO,EAAU,EAEV,EAAM,OAAO,EAAM,SAAY,CAClC,IAAM,EAAU,MAAM,EAAQ,IAAI,GAC5B,EAAK,EAAK,EAAQ,MAEpB,EAAO,EACX,GAAI,EAAG,qBAAqB,SAAW,GAAI,CAEvC,EAAQ,EAAG,oBAAoB,OAC/B,IAAM,EAAW,EAAG,2CACf,GAAG,GACH,OACA,WAAW,gCAAiC,IACjD,EAAO,IAAI,KAAK,KAAK,MAAM,IAAW,mBACnC,CAEH,IAAM,EAAW,EAAG,qBACf,OACA,WAAW,gCAAiC,IAC3C,EAAO,KAAK,MAAM,GACxB,EAAQ,EAAK,UAAU,IAAI,SAC3B,EAAO,IAAI,KAAK,EAAK,UAAU,IAAI,eAGvC,EAAG,6BAA6B,SAChC,EAAG,0BAA0B,SAC7B,EAAG,UAAU,SACb,EAAG,kBAAkB,SACrB,EAAG,0BAA0B,SAE7B,IAAI,EAAkB,EAAG,gBACrB,EAAgB,SAAW,IAE3B,EAAG,sBAAsB,SACzB,EAAG,gBAAgB,SACnB,EAAG,oBAAoB,SACvB,EAAkB,EAAG,kBAGzB,IAAM,EAAc,EAAgB,OAE9B,EAAiB,EAAiB,GAExC,MAAO,CAEH,MAAA,EACA,YAAa,EAAI,EAAA,KAAA,EAAA,iCAA8C,CAC3D,cACA,mBAEJ,QAAS,EACT,aAKhB,MAAO,CACH,QACA,eA2BF,EAAoB,GAAO,CAC7B,IAAM,EAA8B,GAE9B,EAAiB,CACnB,qBACA,oCACA,yBACA,qBAGJ,IAAK,IAAM,KAAY,EACnB,GAAI,EAAG,GAAU,OAAQ,CACrB,IAAI,EAAO,EAAG,IAAa,oBAAsB,oCAAsC,GAAU,OAE7F,IACA,EAAO,EAAK,WAAW,4BAA6B,mCAAmC,WAAW,WAAY,eAE9G,EAAe,KAAK,CAChB,KAAM,IAAa,oCAAsC,OAAS,aAClE,OACA,GAAI,IAAa,qCAAuC,CACpD,IAAK,EAAG,wCAAwC,KAAK,eACrD,MAAO,EAAG,GAAU,KAAK,aAO7C,OAAO"}