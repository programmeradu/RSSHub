{"version":3,"file":"posts-b5_GwLdk.js","names":["MarkdownIt","route: Route","InvalidParameterError","ofetch"],"sources":["../../lib/routes/hedwig/posts.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { isValidHost } from '@/utils/valid-host';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nimport MarkdownIt from 'markdown-it';\r\nconst md = MarkdownIt({\r\n    html: true,\r\n});\r\n\r\nexport const route: Route = {\r\n    path: '/posts/:site',\r\n    categories: ['blog'],\r\n    example: '/posts/walnut',\r\n    parameters: { site: '站点名，原则上只要是 `{site}.hedwig.pub` 都可以匹配' },\r\n    features: {\r\n        supportRadar: false,\r\n    },\r\n    name: 'Posts',\r\n    url: 'hedwig.pub',\r\n    maintainers: ['zwithz', 'GetToSet'],\r\n    view: ViewType.Articles,\r\n    handler: async (ctx) => {\r\n        const { site } = ctx.req.param();\r\n\r\n        if (!isValidHost(site)) {\r\n            throw new InvalidParameterError('Invalid site');\r\n        }\r\n\r\n        const baseUrl = `https://${site}.hedwig.pub`;\r\n\r\n        const response = await ofetch(baseUrl);\r\n        const $ = load(response);\r\n\r\n        const text = $('script#__NEXT_DATA__').text();\r\n        const json = JSON.parse(text);\r\n\r\n        const pageProps = json.props.pageProps;\r\n\r\n        const list = pageProps.issuesByNewsletter.map((item) => {\r\n            const description = item.blocks.reduce((desc, block) => desc + md.render(block.markdown.text), '');\r\n            return {\r\n                title: item.subject,\r\n                description,\r\n                pubDate: timezone(parseDate(item.publishAt, 'YYYY-MM-DDTHH:mm:ss.SSS[Z]'), +0),\r\n                link: `${baseUrl}/i/${item.urlFriendlyName}`,\r\n            };\r\n        });\r\n\r\n        return {\r\n            title: pageProps.newsletter.name,\r\n            description: pageProps.newsletter.about,\r\n            link: baseUrl,\r\n            item: list,\r\n        };\r\n    },\r\n};\r\n"],"mappings":"8fASA,MAAM,EAAKA,EAAW,CAClB,KAAM,KAGGC,EAAe,CACxB,KAAM,eACN,WAAY,CAAC,QACb,QAAS,gBACT,WAAY,CAAE,KAAM,wCACpB,SAAU,CACN,aAAc,IAElB,KAAM,QACN,IAAK,aACL,YAAa,CAAC,SAAU,YACxB,KAAM,EAAS,SACf,QAAS,KAAO,IAAQ,CACpB,GAAM,CAAE,QAAS,EAAI,IAAI,QAEzB,GAAI,CAAC,EAAY,GACb,MAAM,IAAIC,EAAsB,gBAGpC,IAAM,EAAU,WAAW,EAAK,aAE1B,EAAW,MAAMC,EAAO,GACxB,EAAI,EAAK,GAET,EAAO,EAAE,wBAAwB,OACjC,EAAO,KAAK,MAAM,GAElB,EAAY,EAAK,MAAM,UAEvB,EAAO,EAAU,mBAAmB,IAAK,GAAS,CACpD,IAAM,EAAc,EAAK,OAAO,QAAQ,EAAM,IAAU,EAAO,EAAG,OAAO,EAAM,SAAS,MAAO,IAC/F,MAAO,CACH,MAAO,EAAK,QACZ,cACA,QAAS,EAAS,EAAU,EAAK,UAAW,8BAA+B,GAC3E,KAAM,GAAG,EAAQ,KAAK,EAAK,qBAInC,MAAO,CACH,MAAO,EAAU,WAAW,KAC5B,YAAa,EAAU,WAAW,MAClC,KAAM,EACN,KAAM"}