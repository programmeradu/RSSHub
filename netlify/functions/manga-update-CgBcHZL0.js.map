{"version":3,"file":"manga-update-CgBcHZL0.js","names":["route: Route","cache","got"],"sources":["../../lib/routes/bilibili/manga-update.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\n\r\nexport const route: Route = {\r\n    path: '/manga/update/:comicid',\r\n    categories: ['social-media'],\r\n    example: '/bilibili/manga/update/26009',\r\n    parameters: { comicid: '漫画 id, 可在 URL 中找到, 支持带有`mc`前缀' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['manga.bilibili.com/detail/:comicid'],\r\n        },\r\n    ],\r\n    name: '漫画更新',\r\n    maintainers: ['hoilc'],\r\n    handler,\r\n};\r\n\r\n// Based on https://github.com/SocialSisterYi/bilibili-API-collect/issues/1168#issuecomment-2620749895\r\nasync function genReqSign(query, body) {\r\n    // Don't import on top-level to avoid a cyclic dependency - wasm-exec.js generated via `pnpm build`, which in turn needs wasm-exec.js to import routes correctly\r\n    const { Go } = await import('./wasm-exec');\r\n\r\n    // Cache the wasm binary as it's quite large (~2MB)\r\n    // Here the binary is saved as base64 as the cache stores strings\r\n    const wasmBufferBase64 = await cache.tryGet('bilibili-manga-wasm-20250208', async () => {\r\n        const wasmResp = await got('https://s1.hdslb.com/bfs/manga-static/manga-pc/6732b1bf426cfc634293.wasm', {\r\n            responseType: 'arrayBuffer',\r\n        });\r\n        return Buffer.from(wasmResp.data).toString('base64');\r\n    });\r\n    const wasmBuffer = Buffer.from(wasmBufferBase64, 'base64');\r\n\r\n    const go = new Go();\r\n    const { instance } = await WebAssembly.instantiate(wasmBuffer, go.importObject);\r\n    go.run(instance);\r\n    if (void 0 === globalThis.genReqSign) {\r\n        throw new Error('WASM function not available');\r\n    }\r\n\r\n    const signature = globalThis.genReqSign(query, body, Date.now());\r\n\r\n    return signature.sign;\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const comic_id = ctx.req.param('comicid').startsWith('mc') ? ctx.req.param('comicid').replace('mc', '') : ctx.req.param('comicid');\r\n    const link = `https://manga.bilibili.com/detail/mc${comic_id}`;\r\n\r\n    const spi_response = await got('https://api.bilibili.com/x/frontend/finger/spi');\r\n\r\n    const query = 'device=pc&platform=web&nov=25';\r\n    const body = JSON.stringify({\r\n        comic_id: Number(comic_id),\r\n    });\r\n\r\n    const ultraSign = await genReqSign(query, body);\r\n\r\n    const response = await got({\r\n        method: 'POST',\r\n        url: `https://manga.bilibili.com/twirp/comic.v2.Comic/ComicDetail?${query}&ultra_sign=${ultraSign}`,\r\n        body,\r\n        headers: {\r\n            Referer: link,\r\n            Cookie: `buvid3=${spi_response.data.data.b_3}; buvid4=${spi_response.data.data.b_4}`,\r\n        },\r\n    });\r\n    const data = response.data.data;\r\n    const author = data.author_name.join(', ');\r\n\r\n    return {\r\n        title: `${data.title} - 哔哩哔哩漫画`,\r\n        link,\r\n        image: data.vertical_cover,\r\n        description: data.classic_lines,\r\n        item: data.ep_list.slice(0, 20).map((item) => ({\r\n            title: item.short_title === item.title ? item.short_title : `${item.short_title} ${item.title}`,\r\n            author,\r\n            description: `<img src=\"${item.cover}\">`,\r\n            pubDate: new Date(item.pub_time + ' +0800'),\r\n            link: `https://manga.bilibili.com/mc${comic_id}/${item.id}`,\r\n        })),\r\n    };\r\n}\r\n"],"mappings":"oRAIA,MAAaA,EAAe,CACxB,KAAM,yBACN,WAAY,CAAC,gBACb,QAAS,+BACT,WAAY,CAAE,QAAS,iCACvB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,wCAGjB,KAAM,OACN,YAAa,CAAC,SACd,WAIJ,eAAe,EAAW,EAAO,EAAM,CAEnC,GAAM,CAAE,MAAO,MAAM,OAAO,2BAItB,EAAmB,MAAMC,EAAM,OAAO,+BAAgC,SAAY,CACpF,IAAM,EAAW,MAAMC,EAAI,2EAA4E,CACnG,aAAc,gBAElB,OAAO,OAAO,KAAK,EAAS,MAAM,SAAS,YAEzC,EAAa,OAAO,KAAK,EAAkB,UAE3C,EAAK,IAAI,EACT,CAAE,YAAa,MAAM,YAAY,YAAY,EAAY,EAAG,cAElE,GADA,EAAG,IAAI,GACQ,WAAW,aAAtB,IAAK,GACL,MAAU,MAAM,+BAGpB,IAAM,EAAY,WAAW,WAAW,EAAO,EAAM,KAAK,OAE1D,OAAO,EAAU,KAGrB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,WAAW,WAAW,MAAQ,EAAI,IAAI,MAAM,WAAW,QAAQ,KAAM,IAAM,EAAI,IAAI,MAAM,WAClH,EAAO,uCAAuC,IAE9C,EAAe,MAAMA,EAAI,kDAEzB,EAAQ,gCACR,EAAO,KAAK,UAAU,CACxB,SAAU,OAAO,KAGf,EAAY,MAAM,EAAW,EAAO,GAEpC,EAAW,MAAMA,EAAI,CACvB,OAAQ,OACR,IAAK,+DAA+D,EAAM,cAAc,IACxF,OACA,QAAS,CACL,QAAS,EACT,OAAQ,UAAU,EAAa,KAAK,KAAK,IAAI,WAAW,EAAa,KAAK,KAAK,SAGjF,EAAO,EAAS,KAAK,KACrB,EAAS,EAAK,YAAY,KAAK,MAErC,MAAO,CACH,MAAO,GAAG,EAAK,MAAM,WACrB,OACA,MAAO,EAAK,eACZ,YAAa,EAAK,cAClB,KAAM,EAAK,QAAQ,MAAM,EAAG,IAAI,IAAK,IAAU,CAC3C,MAAO,EAAK,cAAgB,EAAK,MAAQ,EAAK,YAAc,GAAG,EAAK,YAAY,GAAG,EAAK,QACxF,SACA,YAAa,aAAa,EAAK,MAAM,IACrC,QAAS,IAAI,KAAK,EAAK,SAAW,UAClC,KAAM,gCAAgC,EAAS,GAAG,EAAK"}