{"version":3,"file":"zhengce-DKVCtCYD.js","names":["route: Route","got","cache","author"],"sources":["../../lib/routes/gov/zhengce/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: ['/zhengce/zuixin', '/zhengce/:category{.+}?'],\r\n    categories: ['government'],\r\n    example: '/gov/zhengce/zuixin',\r\n    parameters: {},\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.gov.cn/zhengce/zuixin.htm', 'www.gov.cn/'],\r\n        },\r\n    ],\r\n    name: '最新政策',\r\n    maintainers: ['SettingDust', 'nczitzk'],\r\n    handler,\r\n    url: 'www.gov.cn/zhengce/zuixin.htm',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'zuixin' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 20;\r\n\r\n    const rootUrl = 'https://www.gov.cn';\r\n    const currentUrl = new URL(`zhengce/${category.replace(/\\/$/, '')}/`, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    let items = $('h4 a, div.subtitle a[title]')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const link = item.prop('href');\r\n\r\n            return {\r\n                title: item.text(),\r\n                link: link.startsWith('http') ? link : new URL(link, currentUrl).href,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items\r\n            .filter((item) => /https?:\\/\\/www\\.gov\\.cn\\/zhengce.*content_\\d+\\.htm/.test(item.link))\r\n            .slice(0, limit)\r\n            .map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const { data: detailResponse } = await got(item.link);\r\n\r\n                    const content = load(detailResponse);\r\n\r\n                    const processElementText = (el) => content(el).text().split(/：/).pop().trim() || content(el).next().text().trim();\r\n\r\n                    const author = content('meta[name=\"author\"]').prop('content');\r\n\r\n                    const agencyEl = content('table.bd1')\r\n                        .find('td')\r\n                        .toArray()\r\n                        .findLast((a) => content(a).text().startsWith('发文机关'));\r\n\r\n                    const sourceEl = content('span.font-zyygwj')\r\n                        .toArray()\r\n                        .findLast((a) => content(a).text().startsWith('来源'));\r\n\r\n                    const subjectEl = content('table.bd1')\r\n                        .find('td')\r\n                        .toArray()\r\n                        .findLast((a) => content(a).text().startsWith('主题分类'));\r\n\r\n                    const agency = agencyEl ? processElementText(agencyEl) : undefined;\r\n                    const source = sourceEl ? processElementText(sourceEl) : undefined;\r\n                    const subject = subjectEl ? processElementText(subjectEl) : content('td.zcwj_ztfl').text();\r\n\r\n                    const column = content('meta[name=\"lanmu\"]').prop('content');\r\n                    const keywords = content('meta[name=\"keywords\"]').prop('content')?.split(/;|,/) ?? [];\r\n                    const manuscriptId = content('meta[name=\"manuscriptId\"]').prop('content');\r\n\r\n                    item.title = content('div.share-title').text() || item.title;\r\n                    item.description = content('div.TRS_UEDITOR').first().html() || content('div#UCAP-CONTENT, td#UCAP-CONTENT').first().html();\r\n                    item.author = [agency, source, author].filter(Boolean).join('/');\r\n                    item.category = [...new Set([subject, column, ...keywords].filter(Boolean))];\r\n                    item.guid = `gov-zhengce-${manuscriptId}`;\r\n                    item.pubDate = timezone(parseDate(content('meta[name=\"firstpublishedtime\"]').prop('content'), 'YYYY-MM-DD-HH:mm:ss'), +8);\r\n                    item.updated = timezone(parseDate(content('meta[name=\"lastmodifiedtime\"]').prop('content'), 'YYYY-MM-DD-HH:mm:ss'), +8);\r\n\r\n                    return item;\r\n                })\r\n            )\r\n    );\r\n\r\n    const image = new URL($('img.wordlogo').prop('src'), rootUrl).href;\r\n    const icon = new URL($('link[rel=\"icon\"]').prop('href'), rootUrl).href;\r\n    const subtitle = $('meta[name=\"lanmu\"]').prop('content');\r\n    const author = $('div.header_logo a[aria-label]').prop('aria-label');\r\n\r\n    return {\r\n        item: items,\r\n        title: author && subtitle ? `${author} - ${subtitle}` : $('title').text(),\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: 'zh-CN',\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        subtitle,\r\n        author,\r\n    };\r\n}\r\n"],"mappings":"0ZAOA,MAAaA,EAAe,CACxB,KAAM,CAAC,kBAAmB,2BAC1B,WAAY,CAAC,cACb,QAAS,sBACT,WAAY,GACZ,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,gCAAiC,iBAGlD,KAAM,OACN,YAAa,CAAC,cAAe,WAC7B,UACA,IAAK,iCAGT,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,UAAa,EAAI,IAAI,QAClC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,qBACV,EAAa,IAAI,IAAI,WAAW,EAAS,QAAQ,MAAO,IAAI,GAAI,GAAS,KAEzE,CAAE,KAAM,GAAa,MAAMC,EAAI,GAE/B,EAAI,EAAK,GAEX,EAAQ,EAAE,+BACT,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAO,EAAK,KAAK,QAEvB,MAAO,CACH,MAAO,EAAK,OACZ,KAAM,EAAK,WAAW,QAAU,EAAO,IAAI,IAAI,EAAM,GAAY,QAI7E,EAAQ,MAAM,QAAQ,IAClB,EACK,OAAQ,GAAS,qDAAqD,KAAK,EAAK,OAChF,MAAM,EAAG,GACT,IAAK,GACFC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAMD,EAAI,EAAK,MAE1C,EAAU,EAAK,GAEf,EAAsB,GAAO,EAAQ,GAAI,OAAO,MAAM,KAAK,MAAM,QAAU,EAAQ,GAAI,OAAO,OAAO,OAErGE,EAAS,EAAQ,uBAAuB,KAAK,WAE7C,EAAW,EAAQ,aACpB,KAAK,MACL,UACA,SAAU,GAAM,EAAQ,GAAG,OAAO,WAAW,SAE5C,EAAW,EAAQ,oBACpB,UACA,SAAU,GAAM,EAAQ,GAAG,OAAO,WAAW,OAE5C,EAAY,EAAQ,aACrB,KAAK,MACL,UACA,SAAU,GAAM,EAAQ,GAAG,OAAO,WAAW,SAE5C,EAAS,EAAW,EAAmB,GAAY,IAAA,GACnD,EAAS,EAAW,EAAmB,GAAY,IAAA,GACnD,EAAU,EAAY,EAAmB,GAAa,EAAQ,gBAAgB,OAE9E,EAAS,EAAQ,sBAAsB,KAAK,WAC5C,EAAW,EAAQ,yBAAyB,KAAK,YAAY,MAAM,QAAU,GAC7E,EAAe,EAAQ,6BAA6B,KAAK,WAU/D,MARA,GAAK,MAAQ,EAAQ,mBAAmB,QAAU,EAAK,MACvD,EAAK,YAAc,EAAQ,mBAAmB,QAAQ,QAAU,EAAQ,qCAAqC,QAAQ,OACrH,EAAK,OAAS,CAAC,EAAQ,EAAQA,GAAQ,OAAO,SAAS,KAAK,KAC5D,EAAK,SAAW,CAAC,GAAG,IAAI,IAAI,CAAC,EAAS,EAAQ,GAAG,GAAU,OAAO,WAClE,EAAK,KAAO,eAAe,IAC3B,EAAK,QAAU,EAAS,EAAU,EAAQ,mCAAmC,KAAK,WAAY,uBAAwB,GACtH,EAAK,QAAU,EAAS,EAAU,EAAQ,iCAAiC,KAAK,WAAY,uBAAwB,GAE7G,MAKvB,IAAM,EAAQ,IAAI,IAAI,EAAE,gBAAgB,KAAK,OAAQ,GAAS,KACxD,EAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,QAAS,GAAS,KAC5D,EAAW,EAAE,sBAAsB,KAAK,WACxC,EAAS,EAAE,iCAAiC,KAAK,cAEvD,MAAO,CACH,KAAM,EACN,MAAO,GAAU,EAAW,GAAG,EAAO,KAAK,IAAa,EAAE,SAAS,OACnE,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,QACV,QACA,OACA,KAAM,EACN,WACA"}