{"version":3,"file":"special-BEisUD7E.js","names":["route: Route","cache","ofetch","recommendList"],"sources":["../../lib/routes/dxy/special.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { phoneBaseUrl, webBaseUrl, generateNonce, sign, getPost } from './utils';\r\nimport { config } from '@/config';\r\nimport { RecommendListData, SpecialBoardDetail } from './types';\r\n\r\nexport const route: Route = {\r\n    path: '/bbs/special/:specialId',\r\n    categories: ['bbs'],\r\n    example: '/dxy/bbs/special/72',\r\n    parameters: { specialId: '专题 ID，可在对应专题页 URL 中找到' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '专题',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const specialId = ctx.req.param('specialId');\r\n    const { limit = '10' } = ctx.req.query();\r\n\r\n    const specialDetail = (await cache.tryGet(`dxy:special:detail:${specialId}`, async () => {\r\n        const detailParams = {\r\n            specialId,\r\n            requestType: 'h5',\r\n            timestamp: Date.now(),\r\n            noncestr: generateNonce(8, 'number'),\r\n        };\r\n\r\n        const detail = await ofetch(`${phoneBaseUrl}/newh5/bbs/special/detail`, {\r\n            query: {\r\n                ...detailParams,\r\n                sign: sign(detailParams),\r\n            },\r\n        });\r\n        if (detail.code !== 'success') {\r\n            throw new Error(detail.message);\r\n        }\r\n        return detail.data;\r\n    })) as SpecialBoardDetail;\r\n\r\n    const recommendList = (await cache.tryGet(\r\n        `dxy:special:recommend-list-v3:${specialId}`,\r\n        async () => {\r\n            const listParams = {\r\n                specialId,\r\n                requestType: 'h5',\r\n                pageNum: '1',\r\n                pageSize: limit,\r\n                timestamp: Date.now(),\r\n                noncestr: generateNonce(8, 'number'),\r\n            };\r\n\r\n            const recommendList = await ofetch(`${phoneBaseUrl}/newh5/bbs/special/post/recommend-list-v3`, {\r\n                query: {\r\n                    ...listParams,\r\n                    sign: sign(listParams),\r\n                },\r\n            });\r\n            if (recommendList.code !== 'success') {\r\n                throw new Error(recommendList.message);\r\n            }\r\n            return recommendList.data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    )) as RecommendListData;\r\n\r\n    const list = recommendList.result.map((item) => {\r\n        const { postInfo, dataTime, entityId } = item;\r\n        return {\r\n            title: postInfo.subject,\r\n            description: postInfo.simpleBody,\r\n            pubDate: parseDate(dataTime, 'x'),\r\n            author: postInfo.postUser.nickname,\r\n            category: [postInfo.postSpecial.specialName],\r\n            link: `${webBaseUrl}/bbs/newweb/pc/post/${entityId}`,\r\n            postId: entityId,\r\n        };\r\n    });\r\n\r\n    const items = await Promise.all(list.map((item) => getPost(item, cache.tryGet)));\r\n\r\n    return {\r\n        title: specialDetail.name,\r\n        description: `${specialDetail.content} ${specialDetail.postCount} 內容 ${specialDetail.followCount} 关注`,\r\n        link: `${phoneBaseUrl}/bbs/special?specialId=${specialId}`,\r\n        image: specialDetail.specialAvatar,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"kZAQA,MAAaA,EAAe,CACxB,KAAM,0BACN,WAAY,CAAC,OACb,QAAS,sBACT,WAAY,CAAE,UAAW,yBACzB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAY,EAAI,IAAI,MAAM,aAC1B,CAAE,QAAQ,MAAS,EAAI,IAAI,QAE3B,EAAiB,MAAMC,EAAM,OAAO,sBAAsB,IAAa,SAAY,CACrF,IAAM,EAAe,CACjB,YACA,YAAa,KACb,UAAW,KAAK,MAChB,SAAU,EAAc,EAAG,WAGzB,EAAS,MAAMC,EAAO,GAAG,EAAa,2BAA4B,CACpE,MAAO,CACH,GAAG,EACH,KAAM,EAAK,MAGnB,GAAI,EAAO,OAAS,UAChB,MAAU,MAAM,EAAO,SAE3B,OAAO,EAAO,OAGZ,EAAiB,MAAMD,EAAM,OAC/B,iCAAiC,IACjC,SAAY,CACR,IAAM,EAAa,CACf,YACA,YAAa,KACb,QAAS,IACT,SAAU,EACV,UAAW,KAAK,MAChB,SAAU,EAAc,EAAG,WAGzBE,EAAgB,MAAMD,EAAO,GAAG,EAAa,2CAA4C,CAC3F,MAAO,CACH,GAAG,EACH,KAAM,EAAK,MAGnB,GAAIC,EAAc,OAAS,UACvB,MAAU,MAAMA,EAAc,SAElC,OAAOA,EAAc,MAEzB,EAAO,MAAM,YACb,IAGE,EAAO,EAAc,OAAO,IAAK,GAAS,CAC5C,GAAM,CAAE,WAAU,WAAU,YAAa,EACzC,MAAO,CACH,MAAO,EAAS,QAChB,YAAa,EAAS,WACtB,QAAS,EAAU,EAAU,KAC7B,OAAQ,EAAS,SAAS,SAC1B,SAAU,CAAC,EAAS,YAAY,aAChC,KAAM,GAAG,EAAW,sBAAsB,IAC1C,OAAQ,KAIV,EAAQ,MAAM,QAAQ,IAAI,EAAK,IAAK,GAAS,EAAQ,EAAMF,EAAM,UAEvE,MAAO,CACH,MAAO,EAAc,KACrB,YAAa,GAAG,EAAc,QAAQ,GAAG,EAAc,UAAU,MAAM,EAAc,YAAY,KACjG,KAAM,GAAG,EAAa,yBAAyB,IAC/C,MAAO,EAAc,cACrB,KAAM"}