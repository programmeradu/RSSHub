{"version":3,"file":"list-Cyx9d39a.js","names":[],"sources":["../../lib/routes/douban/other/list.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\nimport { fallback, queryToInteger, queryToFloat } from '@/utils/readable-social';\r\n\r\nexport const route: Route = {\r\n    path: '/list/:type?/:routeParams?',\r\n    categories: ['social-media'],\r\n    example: '/douban/list/subject_real_time_hotest',\r\n    parameters: { type: '榜单类型，见下表。默认为实时热门书影音', routeParams: '额外参数；请参阅以下说明和表格' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.douban.com/subject_collection/:type'],\r\n            target: '/list/:type',\r\n        },\r\n    ],\r\n    name: '豆瓣榜单与集合',\r\n    maintainers: ['5upernova-heng', 'honue'],\r\n    handler,\r\n    description: `| 榜单 / 集合        | 路由                          |\r\n| ------------------ | ----------------------------- |\r\n| 实时热门书影音     | subject\\_real\\_time\\_hotest   |\r\n| 影院热映           | movie\\_showing                |\r\n| 实时热门电影       | movie\\_real\\_time\\_hotest     |\r\n| 实时热门电视       | tv\\_real\\_time\\_hotest        |\r\n| 一周口碑电影榜     | movie\\_weekly\\_best           |\r\n| 华语口碑剧集榜     | tv\\_chinese\\_best\\_weekly     |\r\n| 全球口碑剧集榜     | tv\\_global\\_best\\_weekly      |\r\n| 国内口碑综艺榜     | show\\_chinese\\_best\\_weekly   |\r\n| 国外口碑综艺榜     | show\\_global\\_best\\_weekly    |\r\n| 热播新剧国产剧     | tv\\_domestic                  |\r\n| 热播新剧欧美剧     | tv\\_american                  |\r\n| 热播新剧日剧       | tv\\_japanese                  |\r\n| 热播新剧韩剧       | tv\\_korean                    |\r\n| 热播新剧动画       | tv\\_animation                 |\r\n| 虚构类小说热门榜   | book\\_fiction\\_hot\\_weekly    |\r\n| 非虚构类小说热门榜 | book\\_nonfiction\\_hot\\_weekly |\r\n| 热门单曲榜         | music\\_single                 |\r\n| 华语新碟榜         | music\\_chinese                |\r\n| ...                | ...                           |\r\n\r\n| 额外参数 | 含义                   | 接受的值 | 默认值 |\r\n| -------- | ---------------------- | -------- | ------ |\r\n| playable | 仅看有可播放片源的影片 | 0/1      | 0      |\r\n| score    | 筛选评分               | 0.0-10.0 | 0      |\r\n\r\n  用例：\\`/douban/list/tv_korean/playable=1&score=8\\`\r\n\r\n  > 上面的榜单 / 集合并没有列举完整。\r\n  >\r\n  > 如何找到榜单对应的路由参数：\r\n  > 在豆瓣手机 APP 中，对应地榜单页面右上角，点击分享链接。链接路径 \\`subject_collection\\` 后的路径就是路由参数 \\`type\\`。\r\n  > 如：小说热门榜的分享链接为：\\`https://m.douban.com/subject_collection/ECDIHUN4A\\`，其对应本 RSS 路由的 \\`type\\` 为 \\`ECDIHUN4A\\`，对应的订阅链接路由：[\\`/douban/list/ECDIHUN4A\\`](https://rsshub.app/douban/list/ECDIHUN4A)`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const type = ctx.req.param('type') || 'subject_real_time_hotest';\r\n    const routeParams = Object.fromEntries(new URLSearchParams(ctx.req.param('routeParams')));\r\n    const playable = fallback(undefined, queryToInteger(routeParams.playable), 0);\r\n    const score = fallback(undefined, queryToFloat(routeParams.score), 0);\r\n    let start = 0;\r\n    const count = 50;\r\n    let items = [];\r\n    let title = '';\r\n    let description = '';\r\n    let total = null;\r\n    while (total === null || start < total) {\r\n        const url = `https://m.douban.com/rexxar/api/v2/subject_collection/${type}/items?playable=${playable}&start=${start}&count=${count}`;\r\n        // eslint-disable-next-line no-await-in-loop\r\n        const response = await got({\r\n            method: 'get',\r\n            url,\r\n            headers: {\r\n                Referer: `https://m.douban.com/subject_collection/${type}`,\r\n            },\r\n        });\r\n        title = response.data.subject_collection.name;\r\n        description = response.data.subject_collection.description;\r\n        total = response.data.total;\r\n        const newItems = response.data.subject_collection_items\r\n            .filter((item) => {\r\n                const rate = item.rating ? item.rating.value : 0;\r\n                return rate >= score; // 保留rate大于等于score的项and过滤无评分项\r\n            })\r\n            .map((item) => {\r\n                const title = item.title;\r\n                const link = item.url;\r\n                const description = art(path.join(__dirname, '../templates/list_description.art'), {\r\n                    ranking_value: item.ranking_value,\r\n                    title,\r\n                    original_title: item.original_title,\r\n                    rate: item.rating ? item.rating.value : null,\r\n                    card_subtitle: item.card_subtitle,\r\n                    description: item.cards ? item.cards[0].content : item.abstract,\r\n                    cover: item.cover_url || item.cover?.url,\r\n                });\r\n                return {\r\n                    title,\r\n                    link,\r\n                    description,\r\n                };\r\n            });\r\n        items = [...items, ...newItems];\r\n        start += count;\r\n    }\r\n\r\n    return {\r\n        title: `豆瓣 - ${title}`,\r\n        link: `https://m.douban.com/subject_collection/${type}`,\r\n        item: items,\r\n        description,\r\n    };\r\n}\r\n"],"mappings":"+aAOA,MAAa,EAAe,CACxB,KAAM,6BACN,WAAY,CAAC,gBACb,QAAS,wCACT,WAAY,CAAE,KAAM,sBAAuB,YAAa,mBACxD,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,2CACT,OAAQ,gBAGhB,KAAM,UACN,YAAa,CAAC,iBAAkB,SAChC,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;iMAoCjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,2BAChC,EAAc,OAAO,YAAY,IAAI,gBAAgB,EAAI,IAAI,MAAM,iBACnE,EAAW,EAAS,IAAA,GAAW,EAAe,EAAY,UAAW,GACrE,EAAQ,EAAS,IAAA,GAAW,EAAa,EAAY,OAAQ,GAC/D,EAAQ,EAER,EAAQ,GACR,EAAQ,GACR,EAAc,GACd,EAAQ,KACZ,KAAO,IAAU,MAAQ,EAAQ,GAAO,CACpC,IAAM,EAAM,yDAAyD,EAAK,kBAAkB,EAAS,SAAS,EAAM,WAE9G,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,MACA,QAAS,CACL,QAAS,2CAA2C,OAG5D,EAAQ,EAAS,KAAK,mBAAmB,KACzC,EAAc,EAAS,KAAK,mBAAmB,YAC/C,EAAQ,EAAS,KAAK,MACtB,IAAM,EAAW,EAAS,KAAK,yBAC1B,OAAQ,GAAS,CACd,IAAM,EAAO,EAAK,OAAS,EAAK,OAAO,MAAQ,EAC/C,OAAO,GAAQ,IAElB,IAAK,GAAS,CACX,IAAM,EAAQ,EAAK,MACb,EAAO,EAAK,IACZ,EAAc,EAAI,EAAA,KAAA,EAAA,2CAA2D,CAC/E,cAAe,EAAK,cACpB,MAAA,EACA,eAAgB,EAAK,eACrB,KAAM,EAAK,OAAS,EAAK,OAAO,MAAQ,KACxC,cAAe,EAAK,cACpB,YAAa,EAAK,MAAQ,EAAK,MAAM,GAAG,QAAU,EAAK,SACvD,MAAO,EAAK,WAAa,EAAK,OAAO,MAEzC,MAAO,CACH,MAAA,EACA,OACA,YAAA,KAGZ,EAAQ,CAAC,GAAG,EAAO,GAAG,GACtB,GAAS,GAGb,MAAO,CACH,MAAO,QAAQ,IACf,KAAM,2CAA2C,IACjD,KAAM,EACN"}