{"version":3,"file":"programs-Chmw8ycP.js","names":[],"sources":["../../lib/routes/appstorrent/programs.ts"],"sourcesContent":["import { Data, DataItem, Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got, { Options } from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport { load } from 'cheerio';\r\nimport dayjs from 'dayjs';\r\nimport { Context } from 'hono';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/programs',\r\n    categories: ['program-update'],\r\n    example: '/appstorrent/programs',\r\n    name: 'Programs',\r\n    maintainers: ['xzzpig'],\r\n    handler,\r\n    url: 'appstorrent.ru/programs/',\r\n};\r\n\r\nasync function handler(ctx?: Context): Promise<Data> {\r\n    const limit = ctx?.req.query('limit') ? Number.parseInt(ctx?.req.query('limit') ?? '20') : 20;\r\n    const baseUrl = 'https://appstorrent.ru';\r\n    const currentUrl = `${baseUrl}/programs/`;\r\n    const gotOptions: Options = {\r\n        http2: true,\r\n    };\r\n\r\n    const response = await got(currentUrl, gotOptions);\r\n    const $ = load(response.data as any);\r\n\r\n    const selector = 'article.soft-item:not(.locked)';\r\n    const list = $(selector)\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            const $item = $(item);\r\n            return {\r\n                title: $item.find('.subtitle').text().trim(),\r\n                link: $item.find('.subtitle a').attr('href')!,\r\n                category: [$item.find('.info .category').text().trim()],\r\n                version: $item.find('.version').text(),\r\n                architecture: $item.find('.architecture').text().trim(),\r\n                size: $item.find('.size').text().trim(),\r\n            };\r\n        });\r\n\r\n    const items: DataItem[] = await Promise.all(\r\n        list.map(\r\n            (item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const response = await got(item.link, gotOptions);\r\n                    const $ = load(response.data as any);\r\n\r\n                    const pubDate = parseDate($('.tech-info .date-news a').attr('href')?.replace('https://appstorrent.ru/', '') ?? '');\r\n\r\n                    return {\r\n                        title: item.title,\r\n                        link: item.link,\r\n                        category: item.category,\r\n                        pubDate,\r\n                        description: art(path.join(__dirname, 'templates/description.art'), {\r\n                            cover: baseUrl + $('.main-title img').attr('src')?.trim(),\r\n                            title: item.title,\r\n                            pubDate: dayjs(pubDate).format('YYYY-MM-DD'),\r\n                            version: item.version,\r\n                            architecture: item.architecture,\r\n                            compatibility: $('div.right > div.info > div.right-container > div:nth-child(5) > div > span:nth-child(2) > a').text(),\r\n                            size: item.size,\r\n                            activation: $('div.right > div.info > div.right-container > div:nth-child(4) > div > span:nth-child(2) > a').text(),\r\n                            description: $('.content .body-content').first().text(),\r\n                            changelog: $('.content .body-content').last().text(),\r\n                            screenshots: $('.screenshots img')\r\n                                .toArray()\r\n                                .map((img) => $(img).attr('src'))\r\n                                .map((src) => baseUrl + src),\r\n                        }),\r\n                    } as DataItem;\r\n                }) as Promise<DataItem>\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: currentUrl.toString(),\r\n        allowEmpty: true,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"6eAUA,MAAa,EAAe,CACxB,KAAM,YACN,WAAY,CAAC,kBACb,QAAS,wBACT,KAAM,WACN,YAAa,CAAC,UACd,UACA,IAAK,4BAGT,eAAe,EAAQ,EAA8B,CACjD,IAAM,EAAQ,GAAK,IAAI,MAAM,SAAW,OAAO,SAAS,GAAK,IAAI,MAAM,UAAY,MAAQ,GACrF,EAAU,yBACV,EAAa,GAAG,EAAQ,YACxB,EAAsB,CACxB,MAAO,IAGL,EAAW,MAAM,EAAI,EAAY,GACjC,EAAI,EAAK,EAAS,MAGlB,EAAO,EAAE,kCACV,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,IAAM,EAAQ,EAAE,GAChB,MAAO,CACH,MAAO,EAAM,KAAK,aAAa,OAAO,OACtC,KAAM,EAAM,KAAK,eAAe,KAAK,QACrC,SAAU,CAAC,EAAM,KAAK,mBAAmB,OAAO,QAChD,QAAS,EAAM,KAAK,YAAY,OAChC,aAAc,EAAM,KAAK,iBAAiB,OAAO,OACjD,KAAM,EAAM,KAAK,SAAS,OAAO,UAIvC,EAAoB,MAAM,QAAQ,IACpC,EAAK,IACA,GACG,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAM,EAAI,EAAK,KAAM,GAChC,EAAI,EAAK,EAAS,MAElB,EAAU,EAAU,EAAE,2BAA2B,KAAK,SAAS,QAAQ,0BAA2B,KAAO,IAE/G,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,SAAU,EAAK,SACf,UACA,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,EAAU,EAAE,mBAAmB,KAAK,QAAQ,OACnD,MAAO,EAAK,MACZ,QAAS,EAAM,GAAS,OAAO,cAC/B,QAAS,EAAK,QACd,aAAc,EAAK,aACnB,cAAe,EAAE,+FAA+F,OAChH,KAAM,EAAK,KACX,WAAY,EAAE,+FAA+F,OAC7G,YAAa,EAAE,0BAA0B,QAAQ,OACjD,UAAW,EAAE,0BAA0B,OAAO,OAC9C,YAAa,EAAE,oBACV,UACA,IAAK,GAAQ,EAAE,GAAK,KAAK,QACzB,IAAK,GAAQ,EAAU,UAOpD,MAAO,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EAAW,WACjB,WAAY,GACZ,KAAM"}