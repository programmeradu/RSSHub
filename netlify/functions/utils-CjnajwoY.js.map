{"version":3,"file":"utils-CjnajwoY.js","names":["cache","got"],"sources":["../../lib/routes/kuaidi100/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nconst wwwid_key = 'kuaidi100-wwwid';\r\nconst csrf_key = 'kuaidi100-csrf';\r\nconst globacsrftoken_key = 'kuaidi100-globacsrftoken';\r\nconst dasddocTitl_key = 'kuaidi100-dasddocTitl';\r\nconst dasddocReferrer_key = 'kuaidi100-dasddocReferrer';\r\nconst dasddocHref_key = 'kuaidi100-dasddocHref';\r\nconst query_count = 'kuaidi100-cookie-count';\r\nconst max_query_count = 30;\r\n\r\nasync function getCookie() {\r\n    // Check if this key should be replace? every 30 times should be fine.\r\n    shouldUpdateCookie();\r\n    let wwwid = await cache.get(wwwid_key);\r\n    let csrf = await cache.get(csrf_key);\r\n    let globacsrftoken = await cache.get(globacsrftoken_key);\r\n    let dasddocTitl = await cache.get(dasddocTitl_key);\r\n    let dasddocReferrer = await cache.get(dasddocReferrer_key);\r\n    let dasddocHref = await cache.get(dasddocHref_key);\r\n    if (!wwwid || !csrf || !dasddocTitl || !dasddocReferrer || !dasddocHref) {\r\n        const indexResponse = await got({\r\n            method: 'get',\r\n            url: 'https://www.kuaidi100.com/?from=appstore',\r\n            headers: {\r\n                // App store\r\n                Referer: 'https://apps.apple.com/cn/app/%E5%BF%AB%E9%80%92100-%E5%8F%8C11%E5%AF%84%E4%BB%B6%E9%80%80%E8%B4%A7-%E4%B8%8A%E5%BF%AB%E9%80%92100/id458270120',\r\n            },\r\n        });\r\n        const set_cookie = indexResponse.headers['set-cookie'];\r\n        if (set_cookie) {\r\n            for (const e of set_cookie) {\r\n                // eslint-disable-next-line unicorn/prefer-switch\r\n                if (e.indexOf('WWWID') === 0) {\r\n                    wwwid = e.split(';')[0];\r\n                } else if (e.indexOf('csrftoken') === 0) {\r\n                    csrf = e.split(';')[0];\r\n                } else if (e.indexOf('globacsrftoken') === 0) {\r\n                    globacsrftoken = e.split(';')[0];\r\n                } else if (e.includes('dasddocTitle')) {\r\n                    dasddocTitl = e.split(';')[0];\r\n                } else if (e.includes('dasddocReferrer')) {\r\n                    dasddocReferrer = e.split(';')[0];\r\n                } else if (e.includes('dasddocHref')) {\r\n                    dasddocHref = e.split(';')[0];\r\n                }\r\n            }\r\n        }\r\n\r\n        cache.set(wwwid_key, wwwid, 600);\r\n        cache.set(csrf_key, csrf, 600);\r\n        cache.set(globacsrftoken_key, globacsrftoken, 600);\r\n        cache.set(dasddocTitl_key, dasddocTitl, 600);\r\n        cache.set(dasddocReferrer_key, dasddocReferrer, 600);\r\n        cache.set(dasddocHref_key, dasddocHref, 600);\r\n        // We have acquired new cookie. It may due to cache timeout.\r\n        // Force update counter and don't wait it finished.\r\n        shouldUpdateCookie(true);\r\n    }\r\n\r\n    return {\r\n        wwwid,\r\n        csrf,\r\n        globacsrftoken,\r\n        dasddocTitl,\r\n        dasddocReferrer,\r\n        dasddocHref,\r\n    };\r\n}\r\n\r\n/*\r\n    Example Company\r\n    {\r\n        \"available\": false,  <- 这个不知道是什么的可用性，反正不是可查询的\r\n        \"canOrder\": false,\r\n        \"comTypeName\": \"国内运输商\",\r\n        \"contactTel\": \"626-818-2750\",\r\n        \"createTime\": 1486202888000,\r\n        \"hasNetwork\": false,\r\n        \"id\": 7172420,\r\n        \"name\": \"金岸物流\",\r\n        \"number\": \"jinan\",\r\n        \"shortName\": \"金岸物流\",\r\n        \"shortNumber\": \"jinan\",\r\n        \"siteUrl\": \"http://www.gpl-express.com/\",\r\n        \"type\": 0,\r\n        \"version\": 776\r\n    }\r\n*/\r\nfunction getCompanyList() {\r\n    // Using date as cache key and it will automatically expired by 1d\r\n    const key = `kuaidi100-company-name-${new Date().toISOString().split('T')[0]}`;\r\n    return cache.tryGet(key, async () => {\r\n        const cookie = await getCookie();\r\n        const wwwid = cookie.wwwid;\r\n        const companyResponse = await got({\r\n            method: 'post',\r\n            url: 'https://www.kuaidi100.com/company.do?method=js&t=201701051440',\r\n            headers: {\r\n                Referer: 'https://www.kuaidi100.com/',\r\n                Cookie: wwwid,\r\n            },\r\n        });\r\n        let list = companyResponse.body;\r\n\r\n        // Parsing the js file\r\n        try {\r\n            list = list.slice(12).replaceAll('};', '}').replaceAll(\"'\", '\"');\r\n            list = JSON.parse(list);\r\n            list = list.company;\r\n        } catch {\r\n            throw new Error('无法正确获取快递公司列表：请稍后重试');\r\n        }\r\n\r\n        return list;\r\n    });\r\n}\r\n\r\nfunction shouldUpdateCookie(forcedUpdate = false) {\r\n    if (forcedUpdate) {\r\n        cache.set(query_count, 0);\r\n    } else {\r\n        const count = cache.get(query_count);\r\n        if (count) {\r\n            if (count > max_query_count) {\r\n                cache.set(query_count, 0);\r\n                clearCookie();\r\n            } else {\r\n                cache.set(query_count, count + 1);\r\n            }\r\n        } else {\r\n            cache.set(query_count, 1);\r\n        }\r\n    }\r\n}\r\n\r\nfunction clearCookie() {\r\n    cache.set(wwwid_key, null);\r\n    cache.set(csrf_key, null);\r\n}\r\n\r\nexport default {\r\n    company: () => getCompanyList(),\r\n    checkCode: async (number, id, phone) => {\r\n        const list = await getCompanyList();\r\n        const company = list.find((c) => c.number === number);\r\n        if (company) {\r\n            if (number.includes('shunfeng') && !Number.isNaN(phone) && String(phone).length !== 4) {\r\n                return {\r\n                    status: false,\r\n                    message: '顺丰查询需要手机号后四位！',\r\n                    company,\r\n                };\r\n            } else if (company.checkReg) {\r\n                return {\r\n                    status: true,\r\n                    regex: new RegExp(company.checkReg).test(id),\r\n                    company,\r\n                };\r\n            } else {\r\n                return {\r\n                    status: true,\r\n                    regex: undefined,\r\n                    company,\r\n                };\r\n            }\r\n        } else {\r\n            return {\r\n                status: false,\r\n                message: '快递公司编号不受支持！',\r\n                company: {\r\n                    name: '未知',\r\n                },\r\n            };\r\n        }\r\n    },\r\n\r\n    /*\r\n      Example Query\r\n      {\r\n          \"message\": \"ok\",\r\n          \"nu\": \"73123917441103\",\r\n          \"ischeck\": \"1\",\r\n          \"condition\": \"F00\",\r\n          \"com\": \"zhongtong\",\r\n          \"status\": \"200\",\r\n          \"state\": \"3\",\r\n          \"data\": [{\r\n                      \"time\": \"2019-12-12 12:41:15\",\r\n                      \"ftime\": \"2019-12-12 12:41:15\",\r\n                      \"context\": \"【温州市】 快件已由【菜鸟的温州燎原华庭7栋103号店】代签收, 如有问题请电联（18581563547 / 4001787878）, 感谢您使用中通快递, 期待再次为您服务!\",\r\n                      \"location\": \"\"\r\n                  }\r\n                ...]\r\n        Example failed Query\r\n        {\r\n            \"message\": \"快递公司参数异常：验证码错误\",\r\n            \"nu\": \"\",\r\n            \"ischeck\": \"0\",\r\n            \"condition\": \"\",\r\n            \"com\": \"\",\r\n            \"status\": \"408\",\r\n            \"state\": \"0\",\r\n            \"data\": []\r\n        }\r\n    */\r\n\r\n    getQuery: async (number, id, phone) => {\r\n        const query_key = `kuaidi100-query-${number}-${id}`;\r\n        let query = await cache.get(query_key);\r\n        // 组装日期与单号 日期为提前两个月\r\n        const timestamp = Number.parseInt(Date.now() / 1000);\r\n        const lastTowMonth = Date.now() - 60 * 60 * 24 * 60 * 1000;\r\n        const dateString = new Date(lastTowMonth).toLocaleDateString('ZH').split('/').join('');\r\n        const queryMeta = encodeURIComponent(\r\n            JSON.stringify({\r\n                date: dateString,\r\n                nums: [id],\r\n            })\r\n        );\r\n\r\n        if (query) {\r\n            query = JSON.parse(query);\r\n        } else {\r\n            const cookie = await getCookie();\r\n            const queryResponse = await got({\r\n                method: 'get',\r\n                url: `https://www.kuaidi100.com/query?type=${number}&postid=${id}&temp=${Math.random()}&phone=${phone ?? ''}`,\r\n                headers: {\r\n                    Referer: 'https://www.kuaidi100.com/',\r\n                    'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8,ja;q=0.7',\r\n                    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36',\r\n                    Cookie: `${cookie.globacsrftoken}; ${cookie.csrf}; ${cookie.wwwid}; ${cookie.dasddocHref}; ${cookie.dasddocReferrer}; ${\r\n                        cookie.dasddocTitl\r\n                    }; addcom=${number}; addnu=${id}; snt_query_meta=${queryMeta}; sortStatus=0; Hm_lpvt_22ea01af58ba2be0fec7c11b25e88e6c=${timestamp}; Hm_lvt_22ea01af58ba2be0fec7c11b25e88e6c=${timestamp - 1642}`,\r\n                },\r\n            });\r\n\r\n            query = queryResponse.data;\r\n            if (query.status === '200') {\r\n                if (query.data && query.data[0].context === '查无结果') {\r\n                    // 查无结果 appears when cookie is invaild, force update cookie.\r\n                    clearCookie();\r\n                    throw new Error('暂时无法获取快递信息，请稍后重试...');\r\n                } else if (query.ischeck === '0') {\r\n                    // Not yet complete, don't cache for now.\r\n                    // To avoid frquent link test when add source, add 180s cache\r\n                    cache.set(query_key, query, 180);\r\n                } else {\r\n                    cache.set(query_key, query); // Finished, cache id\r\n                }\r\n            } else {\r\n                cache.set(query_key, query); // Error, cache as well\r\n                throw new Error(`[${query.status}]信息有误，请重新检查后订阅：${query.message}`);\r\n            }\r\n        }\r\n\r\n        return query;\r\n    },\r\n};\r\n"],"mappings":"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"}