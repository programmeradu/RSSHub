{"version":3,"file":"cmde-xIGT8Vpp.js","names":["route: Route","puppeteer","cache"],"sources":["../../lib/routes/cmde/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nconst rootURL = 'https://www.cmde.org.cn';\r\n\r\nexport const route: Route = {\r\n    path: '/:cate{.+}?',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const cate = ctx.req.param('cate') ?? 'xwdt/zxyw';\r\n    const url = `${rootURL}/${cate}/`;\r\n    const browser = await puppeteer();\r\n    const data = await cache.tryGet(url, async () => {\r\n        const page = await browser.newPage();\r\n        await page.setRequestInterception(true);\r\n        page.on('request', (request) => {\r\n            request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n        });\r\n        await page.goto(url, {\r\n            waitUntil: 'domcontentloaded',\r\n        });\r\n        await page.waitForSelector('.list');\r\n        const html = await page.evaluate(() => document.documentElement.innerHTML);\r\n        await page.close();\r\n\r\n        const $ = load(html);\r\n\r\n        return {\r\n            title: $('head title').text(),\r\n            description: $('meta[name=ColumnDescription]').attr('content'),\r\n            items: $('.list ul li')\r\n                .toArray()\r\n                .map((item) => {\r\n                    item = $(item);\r\n                    return {\r\n                        title: $(item).find('a').attr('title'),\r\n                        link: new URL($(item).find('a').attr('href'), url).href,\r\n                    };\r\n                }),\r\n        };\r\n    });\r\n\r\n    const items = await Promise.all(\r\n        data.items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const page = await browser.newPage();\r\n                await page.setRequestInterception(true);\r\n                page.on('request', (request) => {\r\n                    request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n                });\r\n                await page.goto(item.link, {\r\n                    waitUntil: 'domcontentloaded',\r\n                });\r\n                await page.waitForSelector('.text');\r\n\r\n                const html = await page.evaluate(() => document.documentElement.innerHTML);\r\n                await page.close();\r\n                const $ = load(html);\r\n                item.description = $('.text').html();\r\n                item.pubDate = timezone(parseDate($('meta[name=\"PubDate\"]').attr('content')), +8);\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    await browser.close();\r\n\r\n    return {\r\n        title: data.title,\r\n        description: data.description,\r\n        link: url,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"4UAOA,MAEaA,EAAe,CACxB,KAAM,cACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,YAChC,EAAM,2BAAc,EAAK,GACzB,EAAU,MAAMC,IAChB,EAAO,MAAMC,EAAM,OAAO,EAAK,SAAY,CAC7C,IAAM,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,MAAM,EAAK,KAAK,EAAK,CACjB,UAAW,qBAEf,MAAM,EAAK,gBAAgB,SAC3B,IAAM,EAAO,MAAM,EAAK,aAAe,SAAS,gBAAgB,WAChE,MAAM,EAAK,QAEX,IAAM,EAAI,EAAK,GAEf,MAAO,CACH,MAAO,EAAE,cAAc,OACvB,YAAa,EAAE,gCAAgC,KAAK,WACpD,MAAO,EAAE,eACJ,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAE,GAAM,KAAK,KAAK,KAAK,SAC9B,KAAM,IAAI,IAAI,EAAE,GAAM,KAAK,KAAK,KAAK,QAAS,GAAK,WAMjE,EAAQ,MAAM,QAAQ,IACxB,EAAK,MAAM,IAAK,GACZA,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,MAAM,EAAK,KAAK,EAAK,KAAM,CACvB,UAAW,qBAEf,MAAM,EAAK,gBAAgB,SAE3B,IAAM,EAAO,MAAM,EAAK,aAAe,SAAS,gBAAgB,WAChE,MAAM,EAAK,QACX,IAAM,EAAI,EAAK,GAGf,MAFA,GAAK,YAAc,EAAE,SAAS,OAC9B,EAAK,QAAU,EAAS,EAAU,EAAE,wBAAwB,KAAK,YAAa,GACvE,MAOnB,OAFA,MAAM,EAAQ,QAEP,CACH,MAAO,EAAK,MACZ,YAAa,EAAK,YAClB,KAAM,EACN,KAAM"}