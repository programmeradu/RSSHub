{"version":3,"file":"forum-FLHCx6hH.js","names":["route: Route","headers: HeadersInit","ofetch","items: DataItem[]","title","link","cache","description: string | undefined","$"],"sources":["../../lib/routes/yamibo/bbs/forum.ts"],"sourcesContent":["import type { Data, DataItem, Route } from '@/types';\r\nimport type { Context } from 'hono';\r\nimport { config } from '@/config';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { fetchThread, generateDescription, getDate, bbsOrigin } from '../utils';\r\nimport pMap from 'p-map';\r\nimport cache from '@/utils/cache';\r\n\r\nexport const route: Route = {\r\n    name: 'BBS - 板块',\r\n    categories: ['bbs'],\r\n    path: '/bbs/forum/:fid/:type?',\r\n    example: '/yamibo/bbs/forum/5/404',\r\n    parameters: {\r\n        fid: '板块 id，可从URL中提取。https://bbs.yamibo.com/forum-aa-b.html中的aa部分即为fid值',\r\n        type: '板块子分类，网页中选中板块分类后URL中的typeid值',\r\n    },\r\n    maintainers: ['KarasuShin'],\r\n    handler,\r\n    features: {\r\n        antiCrawler: true,\r\n        requireConfig: [\r\n            {\r\n                optional: true,\r\n                name: 'YAMIBO_SALT',\r\n                description:\r\n                    '百合会BBS登录后的认证信息，获取方式：1. 登录百合会BBS网页版 2. 打开浏览器开发者工具，切换到 Application 面板\\n3. 点击侧边栏中的Storage -> Cookies -> https://bbs.yamibo.com 4. 复制 Cookie 中的 EeqY_2132_saltkey 值',\r\n            },\r\n            {\r\n                optional: true,\r\n                name: 'YAMIBO_AUTH',\r\n                description:\r\n                    '百合会BBS登录后的认证信息，获取方式：1. 登录百合会BBS网页版 2. 打开浏览器开发者工具，切换到 Application 面板\\n3. 点击侧边栏中的Storage -> Cookies -> https://bbs.yamibo.com 4. 复制 Cookie 中的 EeqY_2132_auth 值',\r\n            },\r\n        ],\r\n    },\r\n    description: `::: warning\r\n百合会BBS访问部分板块需要用户登录认证，请参考配置说明\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const fid = ctx.req.param('fid');\r\n    const type = ctx.req.param('type');\r\n    const { auth, salt } = config.yamibo;\r\n\r\n    const params = new URLSearchParams();\r\n    params.set('mod', 'forumdisplay');\r\n    params.set('fid', fid);\r\n    params.set('orderby', 'dateline');\r\n    if (type) {\r\n        params.set('filter', 'typeid');\r\n        params.set('typeid', type);\r\n    }\r\n    const headers: HeadersInit = {};\r\n\r\n    if (auth && salt) {\r\n        headers.cookie = `EeqY_2132_saltkey=${salt}; EeqY_2132_auth=${auth}`;\r\n    }\r\n\r\n    const link = `${bbsOrigin}/forum.php?${params.toString()}`;\r\n\r\n    const $ = load(await ofetch<string>(link, { headers }));\r\n\r\n    const title = $('title').text().replace(' -  百合会 -  Powered by Discuz!', '');\r\n\r\n    let items: DataItem[] = $('tbody[id^=\"normalthread_\"]')\r\n        .toArray()\r\n        .map((item) => {\r\n            const $item = $(item);\r\n            const id = $item.attr('id')!.match(/\\d+/)![0];\r\n            const title = $item.find('th em').text() + $item.find('th .s.xst').text();\r\n            const link = `${bbsOrigin}/thread-${id}-1-1.html`;\r\n            const pubDate = getDate($item.find('td.by').first().find('em').text());\r\n\r\n            return {\r\n                id,\r\n                title,\r\n                link,\r\n                pubDate,\r\n            };\r\n        });\r\n\r\n    items = await pMap(\r\n        items,\r\n        async (item) =>\r\n            (await cache.tryGet(item.link!, async () => {\r\n                let description: string | undefined;\r\n                const { data } = await fetchThread(item.id!);\r\n                if (data && !data.startsWith('<script type=\"text/javascript\">')) {\r\n                    const $ = load(data);\r\n                    if ($('#postlist>div[id^=\"post_\"]').length) {\r\n                        const op = $('#postlist>div[id^=\"post_\"]').first();\r\n                        const postId = op.attr('id')?.match(/\\d+/)?.[0];\r\n                        if (postId) {\r\n                            description = generateDescription(op, postId);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                return {\r\n                    title: item.title,\r\n                    link: item.link,\r\n                    description,\r\n                    pubDate: item.pubDate,\r\n                };\r\n            })) as DataItem,\r\n        { concurrency: 5 }\r\n    );\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"2cASA,MAAaA,EAAe,CACxB,KAAM,WACN,WAAY,CAAC,OACb,KAAM,yBACN,QAAS,0BACT,WAAY,CACR,IAAK,oEACL,KAAM,gCAEV,YAAa,CAAC,cACd,UACA,SAAU,CACN,YAAa,GACb,cAAe,CACX,CACI,SAAU,GACV,KAAM,cACN,YACI;6FAER,CACI,SAAU,GACV,KAAM,cACN,YACI;4FAIhB,YAAa;;MAKjB,eAAe,EAAQ,EAA6B,CAChD,IAAM,EAAM,EAAI,IAAI,MAAM,OACpB,EAAO,EAAI,IAAI,MAAM,QACrB,CAAE,OAAM,QAAS,EAAO,OAExB,EAAS,IAAI,gBACnB,EAAO,IAAI,MAAO,gBAClB,EAAO,IAAI,MAAO,GAClB,EAAO,IAAI,UAAW,YAClB,IACA,EAAO,IAAI,SAAU,UACrB,EAAO,IAAI,SAAU,IAEzB,IAAMC,EAAuB,GAEzB,GAAQ,IACR,EAAQ,OAAS,qBAAqB,EAAK,mBAAmB,KAGlE,IAAM,EAAO,GAAG,EAAU,aAAa,EAAO,aAExC,EAAI,EAAK,MAAMC,EAAe,EAAM,CAAE,aAEtC,EAAQ,EAAE,SAAS,OAAO,QAAQ,gCAAiC,IAErEC,EAAoB,EAAE,8BACrB,UACA,IAAK,GAAS,CACX,IAAM,EAAQ,EAAE,GACV,EAAK,EAAM,KAAK,MAAO,MAAM,OAAQ,GACrCC,EAAQ,EAAM,KAAK,SAAS,OAAS,EAAM,KAAK,aAAa,OAC7DC,EAAO,GAAG,EAAU,UAAU,EAAG,WACjC,EAAU,EAAQ,EAAM,KAAK,SAAS,QAAQ,KAAK,MAAM,QAE/D,MAAO,CACH,KACA,MAAA,EACA,KAAA,EACA,aA+BZ,MA3BA,GAAQ,MAAM,EACV,EACA,KAAO,IACF,MAAMC,EAAM,OAAO,EAAK,KAAO,SAAY,CACxC,IAAIC,EACE,CAAE,QAAS,MAAM,EAAY,EAAK,IACxC,GAAI,GAAQ,CAAC,EAAK,WAAW,mCAAoC,CAC7D,IAAMC,EAAI,EAAK,GACf,GAAIA,EAAE,8BAA8B,OAAQ,CACxC,IAAM,EAAKA,EAAE,8BAA8B,QACrC,EAAS,EAAG,KAAK,OAAO,MAAM,SAAS,GACzC,IACA,EAAc,EAAoB,EAAI,KAKlD,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,cACA,QAAS,EAAK,WAG1B,CAAE,YAAa,IAGZ,CACH,QACA,OACA,KAAM"}