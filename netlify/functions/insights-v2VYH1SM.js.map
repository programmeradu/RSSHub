{"version":3,"file":"insights-v2VYH1SM.js","names":[],"sources":["../../lib/routes/kpmg/insights.ts"],"sourcesContent":["import InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport * as cheerio from 'cheerio';\r\nimport { Context } from 'hono';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst baseUrl = 'https://kpmg.com';\r\nconst payload = {\r\n    query: '',\r\n    filters: {\r\n        all: [{ kpmg_tab_type: ['Insights'] }, { kpmg_article_type: ['Article-General'] }, { kpmg_template_type: ['article-details-template', 'insights-flexible-template', 'editable-flex-template', 'editable-campaign-template'] }],\r\n    },\r\n    result_fields: {\r\n        kpmg_description: { raw: {} },\r\n        kpmg_banner_flag: { raw: {} },\r\n        kpmg_primary_tag: { raw: {} },\r\n        kpmg_article_date: { raw: {} },\r\n        kpmg_contact_job_ttl: { raw: {} },\r\n        kpmg_title: { raw: {} },\r\n        kpmg_contact_city: { raw: {} },\r\n        kpmg_event_start_time: { raw: {} },\r\n        kpmg_article_date_time: { raw: {} },\r\n        kpmg_tab_type: { raw: {} },\r\n        kpmg_short_desc: { raw: {} },\r\n        kpmg_image_alt: { raw: {} },\r\n        kpmg_url: { raw: {} },\r\n        kpmg_template_type: { raw: {} },\r\n        kpmg_image: { raw: {} },\r\n        kpmg_non_decorative_alt_text: { raw: {} },\r\n        kpmg_article_readtime: { raw: {} },\r\n        kpmg_contact_fn: { raw: {} },\r\n        kpmg_contact_ln: { raw: {} },\r\n        kpmg_event_type: { raw: {} },\r\n        kpmg_contact_country: { raw: {} },\r\n        kpmg_is_rendition_optimized: { raw: {} },\r\n        kpmg_article_primary_format: { raw: {} },\r\n        kpmg_article_type: { raw: {} },\r\n        kpmg_event_startdate: { raw: {} },\r\n    },\r\n    page: { size: 20, current: 1 },\r\n    sort: { kpmg_filter_date: 'desc' },\r\n};\r\nconst endpoints = {\r\n    en: {\r\n        title: 'Insights - KPMG ',\r\n        link: `${baseUrl}/xx/en/home/insights.html`,\r\n        api: `${baseUrl}/esearch/xx-en`,\r\n    },\r\n    zh: {\r\n        title: '洞察 - 毕马威',\r\n        link: `${baseUrl}/cn/zh/home/insights.html`,\r\n        api: `${baseUrl}/esearch/cn-zh`,\r\n    },\r\n};\r\nconst render = (data) => art(path.join(__dirname, 'templates/description.art'), data);\r\n\r\nconst handler = async (ctx: Context) => {\r\n    const { lang = 'en' } = ctx.req.param();\r\n    const endpoint = endpoints[lang];\r\n    if (!endpoint) {\r\n        throw new InvalidParameterError('Invalid language');\r\n    }\r\n    const link = endpoint.link;\r\n\r\n    const response = await ofetch(endpoint.api, {\r\n        method: 'POST',\r\n        body: payload,\r\n    });\r\n\r\n    const list = response.results.map((item) => ({\r\n        title: item.kpmg_title.raw,\r\n        description: item.kpmg_description.raw,\r\n        link: item.kpmg_url.raw,\r\n        pubDate: parseDate(item.kpmg_article_date_time.raw),\r\n        image: item.kpmg_image.raw,\r\n        imageAlt: item.kpmg_image_alt?.raw,\r\n    }));\r\n\r\n    const item = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch(item.link);\r\n                const $ = cheerio.load(response);\r\n\r\n                const content = $('.bodytext-data')\r\n                    .toArray()\r\n                    .map((item) => {\r\n                        const element = $(item);\r\n                        element.find('.hidden-xs, .sr-only').remove();\r\n                        return element.parent().html();\r\n                    })\r\n                    .join('');\r\n\r\n                const pdfDetails = $('.pdfdetails').parent().parent().parent();\r\n                pdfDetails.find('.hidden-xs, .sr-only').remove();\r\n\r\n                item.description = render({\r\n                    image: item.image,\r\n                    alt: item.imageAlt,\r\n                    content,\r\n                    pdf: pdfDetails.prop('outerHTML'),\r\n                });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: 'KPMG Insights',\r\n        link,\r\n        item,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/insights/:lang?',\r\n    example: '/kpmg/insights',\r\n    parameters: { lang: 'Language, either `en` or `zh`' },\r\n    radar: [\r\n        {\r\n            source: ['kpmg.com/xx/en/home/insights.html'],\r\n            target: '/insights/en',\r\n        },\r\n        {\r\n            source: ['kpmg.com/cn/zh/home/insights.html'],\r\n            target: '/insights/zh',\r\n        },\r\n    ],\r\n    name: 'Insights',\r\n    maintainers: ['LogicJake'],\r\n    handler,\r\n    url: 'kpmg.com/xx/en/home/insights.html',\r\n    zh: {\r\n        name: '洞察',\r\n    },\r\n};\r\n"],"mappings":"0eAUA,MAAM,EAAU,mBACV,EAAU,CACZ,MAAO,GACP,QAAS,CACL,IAAK,CAAC,CAAE,cAAe,CAAC,aAAe,CAAE,kBAAmB,CAAC,oBAAsB,CAAE,mBAAoB,CAAC,2BAA4B,6BAA8B,yBAA0B,iCAElM,cAAe,CACX,iBAAkB,CAAE,IAAK,IACzB,iBAAkB,CAAE,IAAK,IACzB,iBAAkB,CAAE,IAAK,IACzB,kBAAmB,CAAE,IAAK,IAC1B,qBAAsB,CAAE,IAAK,IAC7B,WAAY,CAAE,IAAK,IACnB,kBAAmB,CAAE,IAAK,IAC1B,sBAAuB,CAAE,IAAK,IAC9B,uBAAwB,CAAE,IAAK,IAC/B,cAAe,CAAE,IAAK,IACtB,gBAAiB,CAAE,IAAK,IACxB,eAAgB,CAAE,IAAK,IACvB,SAAU,CAAE,IAAK,IACjB,mBAAoB,CAAE,IAAK,IAC3B,WAAY,CAAE,IAAK,IACnB,6BAA8B,CAAE,IAAK,IACrC,sBAAuB,CAAE,IAAK,IAC9B,gBAAiB,CAAE,IAAK,IACxB,gBAAiB,CAAE,IAAK,IACxB,gBAAiB,CAAE,IAAK,IACxB,qBAAsB,CAAE,IAAK,IAC7B,4BAA6B,CAAE,IAAK,IACpC,4BAA6B,CAAE,IAAK,IACpC,kBAAmB,CAAE,IAAK,IAC1B,qBAAsB,CAAE,IAAK,KAEjC,KAAM,CAAE,KAAM,GAAI,QAAS,GAC3B,KAAM,CAAE,iBAAkB,SAExB,EAAY,CACd,GAAI,CACA,MAAO,mBACP,KAAM,GAAG,EAAQ,2BACjB,IAAK,GAAG,EAAQ,iBAEpB,GAAI,CACA,MAAO,WACP,KAAM,GAAG,EAAQ,2BACjB,IAAK,GAAG,EAAQ,kBAGlB,EAAU,GAAS,EAAI,EAAA,KAAA,EAAA,sCAAmD,GAE1E,EAAU,KAAO,IAAiB,CACpC,GAAM,CAAE,OAAO,MAAS,EAAI,IAAI,QAC1B,EAAW,EAAU,GAC3B,GAAI,CAAC,EACD,MAAM,IAAI,EAAsB,oBAEpC,IAAM,EAAO,EAAS,KAEhB,EAAW,MAAM,EAAO,EAAS,IAAK,CACxC,OAAQ,OACR,KAAM,IAGJ,EAAO,EAAS,QAAQ,IAAK,IAAU,CACzC,MAAO,EAAK,WAAW,IACvB,YAAa,EAAK,iBAAiB,IACnC,KAAM,EAAK,SAAS,IACpB,QAAS,EAAU,EAAK,uBAAuB,KAC/C,MAAO,EAAK,WAAW,IACvB,SAAU,EAAK,gBAAgB,OAG7B,EAAO,MAAM,QAAQ,IACvB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAM,EAAO,EAAK,MAC7B,EAAI,EAAQ,KAAK,GAEjB,EAAU,EAAE,kBACb,UACA,IAAK,GAAS,CACX,IAAM,EAAU,EAAE,GAElB,OADA,EAAQ,KAAK,wBAAwB,SAC9B,EAAQ,SAAS,SAE3B,KAAK,IAEJ,EAAa,EAAE,eAAe,SAAS,SAAS,SAUtD,OATA,EAAW,KAAK,wBAAwB,SAExC,EAAK,YAAc,EAAO,CACtB,MAAO,EAAK,MACZ,IAAK,EAAK,SACV,UACA,IAAK,EAAW,KAAK,eAGlB,MAKnB,MAAO,CACH,MAAO,gBACP,OACA,SAIK,EAAe,CACxB,KAAM,mBACN,QAAS,iBACT,WAAY,CAAE,KAAM,iCACpB,MAAO,CACH,CACI,OAAQ,CAAC,qCACT,OAAQ,gBAEZ,CACI,OAAQ,CAAC,qCACT,OAAQ,iBAGhB,KAAM,WACN,YAAa,CAAC,aACd,UACA,IAAK,oCACL,GAAI,CACA,KAAM"}