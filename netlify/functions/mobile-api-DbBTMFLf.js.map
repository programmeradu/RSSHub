{"version":3,"file":"mobile-api-DbBTMFLf.js","names":["route: Route","ofetch"],"sources":["../../lib/routes/apnews/mobile-api.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\nimport { fetchArticle } from './utils';\r\nimport pMap from 'p-map';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/mobile/:path{.+}?',\r\n    categories: ['traditional-media'],\r\n    example: '/apnews/mobile/ap-top-news',\r\n    view: ViewType.Articles,\r\n    parameters: {\r\n        path: {\r\n            description: 'Corresponding path from AP News website',\r\n            default: 'ap-top-news',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['apnews.com/'],\r\n        },\r\n    ],\r\n    name: 'News (from mobile client API)',\r\n    maintainers: ['dzx-dzx'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const path = ctx.req.param('path') ? `/${ctx.req.param('path')}` : '/hub/ap-top-news';\r\n    const apiRootUrl = 'https://apnews.com/graphql/delivery/ap/v1';\r\n    const res = await ofetch(apiRootUrl, {\r\n        query: {\r\n            operationName: 'ContentPageQuery',\r\n            variables: { path },\r\n            extensions: { persistedQuery: { version: 1, sha256Hash: '3bc305abbf62e9e632403a74cc86dc1cba51156d2313f09b3779efec51fc3acb' } },\r\n        },\r\n    });\r\n\r\n    const screen = res.data.Screen;\r\n\r\n    const list = [...screen.main.filter((e) => e.__typename === 'ColumnContainer').flatMap((_) => _.columns), ...screen.main.filter((e) => e.__typename !== 'ColumnContainer')]\r\n        .filter((e) => e.__typename !== 'GoogleDfPAdModule')\r\n        .flatMap((e) => {\r\n            switch (e.__typename) {\r\n                case 'PageListModule':\r\n                    return e.items;\r\n                case 'VideoPlaylistModule':\r\n                    return e.playlist;\r\n                default:\r\n                    return;\r\n            }\r\n        })\r\n        .filter(Boolean)\r\n        .map((e) => {\r\n            if (e.__typename === 'PagePromo') {\r\n                return {\r\n                    title: e.title,\r\n                    link: e.url,\r\n                    pubDate: parseDate(e.publishDateStamp),\r\n                    category: e.category,\r\n                    description: e.description,\r\n                    guid: e.id,\r\n                };\r\n            } else if (e.__typename === 'VideoPlaylistItem') {\r\n                return {\r\n                    title: e.title,\r\n                    link: e.url,\r\n                    description: e.description,\r\n                    guid: e.contentId,\r\n                };\r\n            } else {\r\n                return;\r\n            }\r\n        })\r\n        .filter(Boolean)\r\n        .sort((a, b) => b.pubDate - a.pubDate)\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 20);\r\n\r\n    const items = ctx.req.query('fulltext') === 'true' ? await pMap(list, (item) => fetchArticle(item), { concurrency: 10 }) : list;\r\n\r\n    return {\r\n        title: screen.category ?? screen.title,\r\n        item: items,\r\n        link: 'https://apnews.com',\r\n    };\r\n}\r\n"],"mappings":"mXAMA,MAAaA,EAAe,CACxB,KAAM,qBACN,WAAY,CAAC,qBACb,QAAS,6BACT,KAAM,EAAS,SACf,WAAY,CACR,KAAM,CACF,YAAa,0CACb,QAAS,gBAGjB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,iBAGjB,KAAM,gCACN,YAAa,CAAC,WACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,QAAU,IAAI,EAAI,IAAI,MAAM,UAAY,mBAE7D,EAAM,MAAMC,EAAO,4CAAY,CACjC,MAAO,CACH,cAAe,mBACf,UAAW,CAAE,QACb,WAAY,CAAE,eAAgB,CAAE,QAAS,EAAG,WAAY,wEAI1D,EAAS,EAAI,KAAK,OAElB,EAAO,CAAC,GAAG,EAAO,KAAK,OAAQ,GAAM,EAAE,aAAe,mBAAmB,QAAS,GAAM,EAAE,SAAU,GAAG,EAAO,KAAK,OAAQ,GAAM,EAAE,aAAe,oBACnJ,OAAQ,GAAM,EAAE,aAAe,qBAC/B,QAAS,GAAM,CACZ,OAAQ,EAAE,WAAV,CACI,IAAK,iBACD,OAAO,EAAE,MACb,IAAK,sBACD,OAAO,EAAE,SACb,QACI,UAGX,OAAO,SACP,IAAK,GAAM,CACR,GAAI,EAAE,aAAe,YACjB,MAAO,CACH,MAAO,EAAE,MACT,KAAM,EAAE,IACR,QAAS,EAAU,EAAE,kBACrB,SAAU,EAAE,SACZ,YAAa,EAAE,YACf,KAAM,EAAE,OAEL,EAAE,aAAe,oBACxB,MAAO,CACH,MAAO,EAAE,MACT,KAAM,EAAE,IACR,YAAa,EAAE,YACf,KAAM,EAAE,aAMnB,OAAO,SACP,MAAM,EAAG,IAAM,EAAE,QAAU,EAAE,SAC7B,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,IAE/E,EAAQ,EAAI,IAAI,MAAM,cAAgB,OAAS,MAAM,EAAK,EAAO,GAAS,EAAa,GAAO,CAAE,YAAa,KAAQ,EAE3H,MAAO,CACH,MAAO,EAAO,UAAY,EAAO,MACjC,KAAM,EACN,KAAM"}