{"version":3,"file":"news--iX1EIDT.js","names":["route: Route","got","cache","qs"],"sources":["../../lib/routes/scut/jwc/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport * as url from 'node:url';\r\nimport querystring from 'node:querystring';\r\n\r\nconst baseUrl = 'http://jw.scut.edu.cn';\r\nconst refererUrl = baseUrl + '/dist/';\r\n\r\nconst listPageUrl = baseUrl + '/zhinan/cms/toNews.do';\r\nconst listApiUrl = baseUrl + '/zhinan/jw/api/v2/findNewsTrends.do';\r\nconst articleApiUrl = baseUrl + '/zhinan/jw/api/v2/getArticleInfo.do';\r\n\r\nconst getArticleUrlById = (id) => `${baseUrl}/zhinan/cms/article/view.do?type=posts&id=${id}`;\r\nconst getArticleMobileUrlById = (id) => `${baseUrl}/dist/#/detail/index?id=${id}&type=news`;\r\n\r\nconst convertTimezoneToCST = (date) => {\r\n    const timeZone = 8;\r\n    const serverOffset = date.getTimezoneOffset() / 60;\r\n\r\n    return new Date(date.getTime() - 60 * 60 * 1000 * (timeZone + serverOffset));\r\n};\r\n\r\nconst generateArticlePubDate = (createDateStr) => {\r\n    const date = new Date(createDateStr);\r\n    date.setHours(8);\r\n    date.setMinutes(0);\r\n    date.setSeconds(0);\r\n    date.setMilliseconds(0);\r\n\r\n    return convertTimezoneToCST(date);\r\n};\r\n\r\nconst isRedirectPage = (data) => !!data.link;\r\n\r\nconst resolveRelativeUrl = (html) => html.replaceAll('src=\"/', `src=\"${url.resolve(baseUrl, '.')}`).replaceAll('href=\"/', `href=\"${url.resolve(baseUrl, '.')}`);\r\n\r\nconst apiSuccessAssert = (data) => {\r\n    if (!data.success) {\r\n        throw new Error('article api error');\r\n    }\r\n};\r\n\r\nconst generateBannerImgHtml = (bannerImageUrl) => (bannerImageUrl ? `<p><img src=\"${bannerImageUrl}\"></p>` : '');\r\n\r\nconst generateArticleLink = (id) => `<p>链接：<a href=\"${getArticleUrlById(id)}\">电脑版</a>&nbsp;|&nbsp;<a href=\"${getArticleMobileUrlById(id)}\">手机版</a></p>`;\r\n\r\nconst generateArticleFullText = (data) => generateBannerImgHtml(data.bannerUrl) + resolveRelativeUrl(data.content) + generateArticleLink(data.id);\r\n\r\nexport const route: Route = {\r\n    path: '/jwc/news',\r\n    categories: ['university'],\r\n    example: '/scut/jwc/news',\r\n    parameters: {},\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '教务处新闻动态',\r\n    maintainers: ['imkero'],\r\n    handler,\r\n};\r\n\r\nasync function handler() {\r\n    const qs = querystring.stringify({\r\n        pageNo: 1,\r\n        pageSize: 20,\r\n    });\r\n\r\n    const listApiResponse = await got({\r\n        method: 'post',\r\n        url: `${listApiUrl}?${qs}`,\r\n        headers: {\r\n            Referer: refererUrl,\r\n        },\r\n    });\r\n    apiSuccessAssert(listApiResponse.data);\r\n\r\n    const articleMetaArray = listApiResponse.data.data.list;\r\n    const out = await Promise.all(\r\n        articleMetaArray.map(async (articleMeta) => {\r\n            const articleUrl = getArticleUrlById(articleMeta.id);\r\n\r\n            const cacheIn = await cache.get(articleUrl);\r\n            if (cacheIn) {\r\n                return JSON.parse(cacheIn);\r\n            }\r\n\r\n            const qs = querystring.stringify({\r\n                id: articleMeta.id,\r\n                categoryType: '',\r\n            });\r\n            const articleApiResponse = await got({\r\n                method: 'post',\r\n                url: `${articleApiUrl}?${qs}`,\r\n                headers: {\r\n                    Referer: refererUrl,\r\n                },\r\n            });\r\n            apiSuccessAssert(articleApiResponse.data);\r\n\r\n            const articleData = articleApiResponse.data.data;\r\n            articleData.id = articleMeta.id;\r\n\r\n            let articleFullText = null;\r\n            if (!isRedirectPage(articleData)) {\r\n                articleFullText = generateArticleFullText(articleData);\r\n            }\r\n\r\n            const item = {\r\n                title: articleData.name,\r\n                link: articleUrl,\r\n                description: articleFullText,\r\n                pubDate: generateArticlePubDate(articleData.createDate).toUTCString(),\r\n            };\r\n\r\n            cache.set(articleUrl, JSON.stringify(item));\r\n            return item;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: '华南理工大学教务处新闻动态',\r\n        link: listPageUrl,\r\n        item: out,\r\n    };\r\n}\r\n"],"mappings":"+UAMA,MAAM,EAAU,wBACV,EAAa,EAAU,SAET,EAAU,GACX,EAAU,GACP,EAAU,GALhC,MAOM,EAAqB,GAAO,GAAG,EAAQ,4CAA4C,IACnF,EAA2B,GAAO,GAAG,EAAQ,0BAA0B,EAAG,YAE1E,EAAwB,GAAS,CACnC,IACM,EAAe,EAAK,oBAAsB,GAEhD,OAAO,IAAI,KAAK,EAAK,UAAY,KAAU,KAAQ,EAAW,KAG5D,EAA0B,GAAkB,CAC9C,IAAM,EAAO,IAAI,KAAK,GAMtB,OALA,EAAK,SAAS,GACd,EAAK,WAAW,GAChB,EAAK,WAAW,GAChB,EAAK,gBAAgB,GAEd,EAAqB,IAG1B,EAAkB,GAAS,CAAC,CAAC,EAAK,KAElC,EAAsB,GAAS,EAAK,WAAW,SAAU,QAAQ,EAAI,QAAQ,EAAS,QAAQ,WAAW,UAAW,SAAS,EAAI,QAAQ,EAAS,QAElJ,EAAoB,GAAS,CAC/B,GAAI,CAAC,EAAK,QACN,MAAU,MAAM,sBAIlB,EAAyB,GAAoB,EAAiB,gBAAgB,EAAe,QAAU,GAEvG,EAAuB,GAAO,kBAAkB,EAAkB,GAAI,iCAAiC,EAAwB,GAAI,eAEnI,EAA2B,GAAS,EAAsB,EAAK,WAAa,EAAmB,EAAK,SAAW,EAAoB,EAAK,IAEjIA,EAAe,CACxB,KAAM,YACN,WAAY,CAAC,cACb,QAAS,iBACT,WAAY,GACZ,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,UACN,YAAa,CAAC,UACd,WAGJ,eAAe,GAAU,CACrB,IAAM,EAAK,EAAY,UAAU,CAC7B,OAAQ,EACR,SAAU,KAGR,EAAkB,MAAMC,EAAI,CAC9B,OAAQ,OACR,IAAK,4DAAiB,IACtB,QAAS,CACL,QAAS,KAGjB,EAAiB,EAAgB,MAEjC,IAAM,EAAmB,EAAgB,KAAK,KAAK,KAC7C,EAAM,MAAM,QAAQ,IACtB,EAAiB,IAAI,KAAO,IAAgB,CACxC,IAAM,EAAa,EAAkB,EAAY,IAE3C,EAAU,MAAMC,EAAM,IAAI,GAChC,GAAI,EACA,OAAO,KAAK,MAAM,GAGtB,IAAMC,EAAK,EAAY,UAAU,CAC7B,GAAI,EAAY,GAChB,aAAc,KAEZ,EAAqB,MAAMF,EAAI,CACjC,OAAQ,OACR,IAAK,4DAAoBE,IACzB,QAAS,CACL,QAAS,KAGjB,EAAiB,EAAmB,MAEpC,IAAM,EAAc,EAAmB,KAAK,KAC5C,EAAY,GAAK,EAAY,GAE7B,IAAI,EAAkB,KACjB,EAAe,KAChB,EAAkB,EAAwB,IAG9C,IAAM,EAAO,CACT,MAAO,EAAY,KACnB,KAAM,EACN,YAAa,EACb,QAAS,EAAuB,EAAY,YAAY,eAI5D,OADA,EAAM,IAAI,EAAY,KAAK,UAAU,IAC9B,KAIf,MAAO,CACH,MAAO,gBACP,KAAM,6CACN,KAAM"}