{"version":3,"file":"hot-uMshH7IO.js","names":[],"sources":["../../lib/routes/weibo/search/hot.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { art } from '@/utils/render';\r\nimport { load } from 'cheerio';\r\nimport path from 'node:path';\r\n// import weiboUtils from '../utils';\r\n\r\n// Default hide all picture\r\nlet wpic = 'false';\r\nlet fullpic = 'false';\r\n\r\nexport const route: Route = {\r\n    path: '/search/hot/:fulltext?',\r\n    categories: ['social-media'],\r\n    view: ViewType.SocialMedia,\r\n    example: '/weibo/search/hot',\r\n    parameters: {\r\n        fulltext: {\r\n            description: `\r\n-   使用\\`/weibo/search/hot\\`可以获取热搜条目列表；\r\n-   使用\\`/weibo/search/hot/fulltext\\`可以进一步获取热搜条目下的摘要信息（不含图片视频）；\r\n-   使用\\`/weibo/search/hot/fulltext?pic=true\\`可以获取图片缩略（但需要配合额外的手段，例如浏览器上的 Header Editor 等来修改 referer 参数为\\`https://weibo.com\\`，以规避微博的外链限制，否则图片无法显示。）\r\n-   使用\\`/weibo/search/hot/fulltext?pic=true&fullpic=true\\`可以获取 Original 图片（但需要配合额外的手段，例如浏览器上的 Header Editor 等来修改 referer 参数为\\`https://weibo.com\\`，以规避微博的外链限制，否则图片无法显示。）`,\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['s.weibo.com/top/summary'],\r\n        },\r\n    ],\r\n    name: '热搜榜',\r\n    maintainers: ['xyqfer', 'shinemoon'],\r\n    handler,\r\n    url: 's.weibo.com/top/summary',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    wpic = ctx.req.query('pic') ?? 'false';\r\n    fullpic = ctx.req.query('fullpic') ?? 'false';\r\n    const {\r\n        data: { data },\r\n    } = await got({\r\n        method: 'get',\r\n        url: 'https://m.weibo.cn/api/container/getIndex?containerid=106003type%3D25%26t%3D3%26disable_hot%3D1%26filter_type%3Drealtimehot&title=%E5%BE%AE%E5%8D%9A%E7%83%AD%E6%90%9C&extparam=filter_type%3Drealtimehot%26mi_cid%3D100103%26pos%3D0_0%26c_type%3D30%26display_time%3D1540538388&luicode=10000011&lfid=231583',\r\n        headers: {\r\n            Referer: 'https://s.weibo.com/top/summary?cate=realtimehot',\r\n            'MWeibo-Pwa': 1,\r\n            'X-Requested-With': 'XMLHttpRequest',\r\n            'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1',\r\n        },\r\n    });\r\n\r\n    let resultItems = null;\r\n    if (ctx.req.param('fulltext') === 'fulltext') {\r\n        const cardslist = data.cards[0].card_group;\r\n        // Topic List\r\n        const tlist = cardslist.map((item) => {\r\n            const title = item.desc;\r\n            const link = `https://m.weibo.cn/search?containerid=100103type%3D1%26q%3D${encodeURIComponent(item.desc)}`;\r\n            const plink = `https://m.weibo.cn/api/container/getIndex?containerid=100103type%3D1%26q%3D${encodeURIComponent(item.desc)}`;\r\n            return {\r\n                title,\r\n                link,\r\n                plink,\r\n            };\r\n        });\r\n\r\n        resultItems = await Promise.all(\r\n            tlist.map((i) =>\r\n                cache.tryGet(i.plink, async () => {\r\n                    const pInfo = await fetchContent(i.plink);\r\n                    i.description = pInfo.content;\r\n                    return i;\r\n                })\r\n            )\r\n        );\r\n    } else {\r\n        resultItems = data.cards[0].card_group.map((item) => {\r\n            const title = item.desc;\r\n            const link = `https://m.weibo.cn/search?containerid=100103type%3D1%26q%3D${encodeURIComponent(item.desc)}`;\r\n            const description = item.desc;\r\n            return {\r\n                title,\r\n                description,\r\n                link,\r\n            };\r\n        });\r\n    }\r\n\r\n    return {\r\n        title: '微博热搜榜',\r\n        link: 'https://s.weibo.com/top/summary?cate=realtimehot',\r\n        description: '实时热点，每分钟更新一次',\r\n        item: resultItems,\r\n    };\r\n}\r\n\r\nasync function fetchContent(url) {\r\n    // Fetch the subpageinof\r\n    const cookieString = config.weibo.cookies ?? '';\r\n    const subres = await got(url, {\r\n        headers: {\r\n            Cookie: cookieString,\r\n        },\r\n    });\r\n    let demostr = '';\r\n    try {\r\n        const rdata = subres.data;\r\n        const cards = rdata.data.cards;\r\n        // Need to find one cards with 'type ==9'\r\n        demostr = seekContent(cards);\r\n    } catch {\r\n        // console.log(e);\r\n        // console.log(url);\r\n    }\r\n    const ret = demostr;\r\n    return {\r\n        content: ret,\r\n    };\r\n}\r\n\r\nfunction seekContent(clist) {\r\n    const $ = load('<div id=\"wbcontent\"></div>');\r\n    const stub = $('#wbcontent');\r\n\r\n    // To for..of per reviewers comment\r\n    // Need to find one clist with 'type ==9'\r\n    for (const curitem of clist) {\r\n        if (curitem.card_type === 9) {\r\n            const tbpic = curitem.mblog.thumbnail_pic ?? '';\r\n            const index = tbpic.lastIndexOf('/');\r\n            const thumbfolder = tbpic.slice(0, index + 1);\r\n\r\n            const curcontent = load(curitem.mblog.text);\r\n            if (wpic === 'true') {\r\n                curcontent('img').attr('width', '1em').attr('height', '1em');\r\n            } else {\r\n                curcontent('img').remove();\r\n            }\r\n            const section = art(path.join(__dirname, 'template/digest.art'), {\r\n                author: {\r\n                    link: curitem.mblog.user.profile_url,\r\n                    name: curitem.mblog.user.screen_name,\r\n                },\r\n                msg: curcontent.html(),\r\n                link: curitem.scheme,\r\n                postinfo: curitem.mblog.created_at,\r\n                picnum: wpic === 'true' ? curitem.mblog.pic_num : 0,\r\n                pics:\r\n                    wpic === 'true' && curitem.mblog.pic_num > 0\r\n                        ? curitem.mblog.pics.map((item) => {\r\n                              // Get thumbnail_pic instead of orginal ones\r\n                              const pid = item.pid;\r\n                              return fullpic === 'false' ? { url: thumbfolder + pid + '.jpg', rurl: item.url } : { url: item.url, rurl: item.url };\r\n                          })\r\n                        : [],\r\n            });\r\n            stub.append(section);\r\n        }\r\n        if (curitem.card_type === 11) {\r\n            stub.append(seekContent(curitem.card_group));\r\n        }\r\n    }\r\n    return stub.html();\r\n}\r\n"],"mappings":"meAWA,IAAI,EAAO,QACP,EAAU,QAEd,MAAa,EAAe,CACxB,KAAM,yBACN,WAAY,CAAC,gBACb,KAAM,EAAS,YACf,QAAS,oBACT,WAAY,CACR,SAAU,CACN,YAAa,8ZAOrB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,6BAGjB,KAAM,MACN,YAAa,CAAC,SAAU,aACxB,UACA,IAAK,2BAGT,eAAe,EAAQ,EAAK,CACxB,EAAO,EAAI,IAAI,MAAM,QAAU,QAC/B,EAAU,EAAI,IAAI,MAAM,YAAc,QACtC,GAAM,CACF,KAAM,CAAE,SACR,MAAM,EAAI,CACV,OAAQ,MACR,IAAK,iTACL,QAAS,CACL,QAAS,mDACT,aAAc,EACd,mBAAoB,iBACpB,aAAc,6IAIlB,EAAc,KAClB,GAAI,EAAI,IAAI,MAAM,cAAgB,WAAY,CAC1C,IAAM,EAAY,EAAK,MAAM,GAAG,WAE1B,EAAQ,EAAU,IAAK,GAAS,CAClC,IAAM,EAAQ,EAAK,KACb,EAAO,8DAA8D,mBAAmB,EAAK,QAC7F,EAAQ,8EAA8E,mBAAmB,EAAK,QACpH,MAAO,CACH,QACA,OACA,WAIR,EAAc,MAAM,QAAQ,IACxB,EAAM,IAAK,GACP,EAAM,OAAO,EAAE,MAAO,SAAY,CAC9B,IAAM,EAAQ,MAAM,EAAa,EAAE,OAEnC,MADA,GAAE,YAAc,EAAM,QACf,WAKnB,EAAc,EAAK,MAAM,GAAG,WAAW,IAAK,GAAS,CACjD,IAAM,EAAQ,EAAK,KACb,EAAO,8DAA8D,mBAAmB,EAAK,QAC7F,EAAc,EAAK,KACzB,MAAO,CACH,QACA,cACA,UAKZ,MAAO,CACH,MAAO,QACP,KAAM,mDACN,YAAa,eACb,KAAM,GAId,eAAe,EAAa,EAAK,CAE7B,IAAM,EAAe,EAAO,MAAM,SAAW,GACvC,EAAS,MAAM,EAAI,EAAK,CAC1B,QAAS,CACL,OAAQ,KAGZ,EAAU,GACd,GAAI,CACA,IAAM,EAAQ,EAAO,KACf,EAAQ,EAAM,KAAK,MAEzB,EAAU,EAAY,QAClB,EAIR,IAAM,EAAM,EACZ,MAAO,CACH,QAAS,GAIjB,SAAS,EAAY,EAAO,CACxB,IAAM,EAAI,EAAK,8BACT,EAAO,EAAE,cAIf,IAAK,IAAM,KAAW,EAAO,CACzB,GAAI,EAAQ,YAAc,EAAG,CACzB,IAAM,EAAQ,EAAQ,MAAM,eAAiB,GACvC,EAAQ,EAAM,YAAY,KAC1B,EAAc,EAAM,MAAM,EAAG,EAAQ,GAErC,EAAa,EAAK,EAAQ,MAAM,MAClC,IAAS,OACT,EAAW,OAAO,KAAK,QAAS,OAAO,KAAK,SAAU,OAEtD,EAAW,OAAO,SAEtB,IAAM,EAAU,EAAI,EAAA,KAAA,EAAA,iCAA6C,CAC7D,OAAQ,CACJ,KAAM,EAAQ,MAAM,KAAK,YACzB,KAAM,EAAQ,MAAM,KAAK,aAE7B,IAAK,EAAW,OAChB,KAAM,EAAQ,OACd,SAAU,EAAQ,MAAM,WACxB,OAAQ,IAAS,OAAS,EAAQ,MAAM,QAAU,EAClD,KACI,IAAS,QAAU,EAAQ,MAAM,QAAU,EACrC,EAAQ,MAAM,KAAK,IAAK,GAAS,CAE7B,IAAM,EAAM,EAAK,IACjB,OAAO,IAAY,QAAU,CAAE,IAAK,EAAc,EAAM,OAAQ,KAAM,EAAK,KAAQ,CAAE,IAAK,EAAK,IAAK,KAAM,EAAK,OAEnH,KAEd,EAAK,OAAO,GAEZ,EAAQ,YAAc,IACtB,EAAK,OAAO,EAAY,EAAQ,aAGxC,OAAO,EAAK"}