{"version":3,"file":"paper-CWzU1goX.js","names":["route: Route","InvalidParameterError","got","cache"],"sources":["../../lib/routes/zjol/paper.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/paper/:id?',\r\n    categories: ['traditional-media'],\r\n    example: '/zjol/paper/zjrb',\r\n    parameters: { id: '报纸 id，见下表，默认为 `zjrb`，即浙江日报' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '浙报集团系列报刊',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 浙江日报 | 钱江晚报 | 美术报 | 浙江老年报 | 浙江法制报 | 江南游报 |\r\n| -------- | -------- | ------ | ---------- | ---------- | -------- |\r\n| zjrb     | qjwb     | msb    | zjlnb      | zjfzb      | jnyb     |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id') ?? 'zjrb';\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 100;\r\n\r\n    const allowedId = ['zjrb', 'qjwb', 'msb', 'zjlnb', 'zjfzb', 'jnyb'];\r\n    if (!allowedId.includes(id)) {\r\n        throw new InvalidParameterError('id not allowed');\r\n    }\r\n\r\n    const query = id === 'jnyb' ? 'map[name=\"PagePicMap\"] area' : 'ul.main-ed-articlenav-list li a';\r\n\r\n    const rootUrl = id === 'qjwb' ? 'http://qjwb.thehour.cn' : `https://${id}.zjol.com.cn`;\r\n    let currentUrl = `${rootUrl}/paperindex.htm`;\r\n\r\n    let response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    const url = response.data.match(/URL=(.*)\"/)[1];\r\n    const pubDate = parseDate(url.match(/(\\d{4}-\\d{2}\\/\\d{2})/)[1], 'YYYY-MM/DD');\r\n\r\n    currentUrl = `${rootUrl}/${url.replace(`/${url.split('/').pop()}`, '')}`;\r\n\r\n    response = await got({\r\n        method: 'get',\r\n        url: `${rootUrl}/${url}`,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    let items = $(query)\r\n        .toArray()\r\n        .map((a) => `${currentUrl}/${$(a).attr('href')}`);\r\n\r\n    await Promise.all(\r\n        $('#pageLink')\r\n            .slice(1)\r\n            .toArray()\r\n            .map((p) => `${currentUrl}/${$(p).attr('href')}`)\r\n            .map(async (p) => {\r\n                const pageResponse = await got({\r\n                    method: 'get',\r\n                    url: p,\r\n                });\r\n\r\n                const page = load(pageResponse.data);\r\n\r\n                items.push(\r\n                    ...page(query)\r\n                        .toArray()\r\n                        .map((a) => `${currentUrl}/${page(a).attr('href')}`)\r\n                );\r\n            })\r\n    );\r\n\r\n    items = await Promise.all(\r\n        items\r\n            .filter((a) => (id === 'jnyb' ? /\\?div=1$/.test(a) : true))\r\n            .slice(0, limit)\r\n            .map((link) =>\r\n                cache.tryGet(link, async () => {\r\n                    const detailResponse = await got({\r\n                        method: 'get',\r\n                        url: link,\r\n                    });\r\n\r\n                    const content = load(detailResponse.data);\r\n\r\n                    const title = content('.main-article-title').text();\r\n\r\n                    content('.main-article-alltitle').remove();\r\n\r\n                    return {\r\n                        title,\r\n                        pubDate,\r\n                        link: link.split('?')[0],\r\n                        description: content('.main-article-content').html(),\r\n                    };\r\n                })\r\n            )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: rootUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"obAOA,MAAaA,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,qBACb,QAAS,mBACT,WAAY,CAAE,GAAI,8BAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,WACN,YAAa,CAAC,WACd,UACA,YAAa;;wEAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,OAAS,OAC5B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAE3E,EAAY,CAAC,OAAQ,OAAQ,MAAO,QAAS,QAAS,QAC5D,GAAI,CAAC,EAAU,SAAS,GACpB,MAAM,IAAIC,EAAsB,kBAGpC,IAAM,EAAQ,IAAO,OAAS,8BAAgC,kCAExD,EAAU,IAAO,OAAS,yBAA2B,WAAW,EAAG,cACrE,EAAa,GAAG,EAAQ,iBAExB,EAAW,MAAMC,EAAI,CACrB,OAAQ,MACR,IAAK,IAGH,EAAM,EAAS,KAAK,MAAM,aAAa,GACvC,EAAU,EAAU,EAAI,MAAM,wBAAwB,GAAI,cAEhE,EAAa,GAAG,EAAQ,GAAG,EAAI,QAAQ,IAAI,EAAI,MAAM,KAAK,QAAS,MAEnE,EAAW,MAAMA,EAAI,CACjB,OAAQ,MACR,IAAK,GAAG,EAAQ,GAAG,MAGvB,IAAM,EAAI,EAAK,EAAS,MAEpB,EAAQ,EAAE,GACT,UACA,IAAK,GAAM,GAAG,EAAW,GAAG,EAAE,GAAG,KAAK,WAkD3C,OAhDA,MAAM,QAAQ,IACV,EAAE,aACG,MAAM,GACN,UACA,IAAK,GAAM,GAAG,EAAW,GAAG,EAAE,GAAG,KAAK,WACtC,IAAI,KAAO,IAAM,CACd,IAAM,EAAe,MAAMA,EAAI,CAC3B,OAAQ,MACR,IAAK,IAGH,EAAO,EAAK,EAAa,MAE/B,EAAM,KACF,GAAG,EAAK,GACH,UACA,IAAK,GAAM,GAAG,EAAW,GAAG,EAAK,GAAG,KAAK,eAK9D,EAAQ,MAAM,QAAQ,IAClB,EACK,OAAQ,GAAO,IAAO,OAAS,WAAW,KAAK,GAAK,IACpD,MAAM,EAAG,GACT,IAAK,GACFC,EAAM,OAAO,EAAM,SAAY,CAC3B,IAAM,EAAiB,MAAMD,EAAI,CAC7B,OAAQ,MACR,IAAK,IAGH,EAAU,EAAK,EAAe,MAE9B,EAAQ,EAAQ,uBAAuB,OAI7C,OAFA,EAAQ,0BAA0B,SAE3B,CACH,QACA,UACA,KAAM,EAAK,MAAM,KAAK,GACtB,YAAa,EAAQ,yBAAyB,YAM3D,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM"}