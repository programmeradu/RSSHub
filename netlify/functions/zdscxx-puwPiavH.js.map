{"version":3,"file":"zdscxx-puwPiavH.js","names":["got","filters: Record<string, string[]>","cache","route: Route"],"sources":["../../lib/routes/gov/moa/zdscxx.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const handler = async (ctx) => {\r\n    const { category } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 5;\r\n\r\n    const domain = 'moa.gov.cn';\r\n    const rootFrameUrl = `http://www.${domain}`;\r\n    const rootUrl = `http://zdscxx.${domain}:8080`;\r\n    const apiUrl = new URL('nyb/getMessages', rootUrl).href;\r\n    const apiDetailUrl = new URL('nyb/getMessagesById', rootUrl).href;\r\n    const currentUrl = new URL('nyb/pc/messageList.jsp', rootUrl).href;\r\n    const frameUrl = new URL('iframe/top_sj/', rootFrameUrl).href;\r\n\r\n    const filterForm = {};\r\n\r\n    if (category) {\r\n        const apiFilterUrl = new URL('nyb/getMessageFilters', rootUrl).href;\r\n\r\n        const { data: filterResponse } = await got.post(apiFilterUrl, {\r\n            form: {\r\n                type: '',\r\n                isLatestMessage: false,\r\n            },\r\n        });\r\n\r\n        const filters: Record<string, string[]> = {};\r\n        for (const f of filterResponse.result) {\r\n            filters[f.name.trim()] = f.data.map((d) => d.name.trim());\r\n        }\r\n\r\n        const categories = category.split(/\\//);\r\n        for (const c of categories) {\r\n            for (const key of Object.keys(filters)) {\r\n                if (filters[key].includes(c)) {\r\n                    filterForm[key] = c;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    const { data: response } = await got.post(apiUrl, {\r\n        form: {\r\n            page: 1,\r\n            rows: limit,\r\n            type: '',\r\n            isLatestMessage: false,\r\n            ...filterForm,\r\n        },\r\n    });\r\n\r\n    let items = response.result.table.slice(0, limit).map((item) => ({\r\n        title: item.title,\r\n        link: item.id,\r\n        guid: `moa-zdscxx-${item.id}`,\r\n        pubDate: parseDate(item.date),\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.guid, async () => {\r\n                const { data: detailResponse } = await got.post(apiDetailUrl, {\r\n                    form: {\r\n                        id: item.link,\r\n                    },\r\n                });\r\n\r\n                const data = detailResponse.result;\r\n\r\n                item.title = data.title;\r\n                item.link = new URL(`nyb/pc/messageView.jsp?id=${item.link}`, rootUrl).href;\r\n                item.description = data.content;\r\n                item.author = data.source;\r\n                item.pubDate = parseDate(data.date);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: frameResponse } = await got(frameUrl);\r\n\r\n    const $ = load(frameResponse);\r\n\r\n    const title = $('title').text();\r\n\r\n    return {\r\n        title: `${title}${category ? ` - ${category}` : ''}`,\r\n        description: '数据',\r\n        link: currentUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: $('h1.logo a img').prop('src'),\r\n        author: title,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/moa/zdscxx/:category{.+}?',\r\n    name: '中华人民共和国农业农村部数据',\r\n    url: 'www.moa.gov.cn',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/gov/moa/zdscxx',\r\n    parameters: { category: '分类，默认为全部，见下表' },\r\n    description: `::: tip\r\n  若订阅 [中华人民共和国农业农村部数据](http://zdscxx.moa.gov.cn:8080/nyb/pc/messageList.jsp) 的 \\`价格指数\\` 报告主题。此时路由为 [\\`/gov/moa/zdscxx/价格指数\\`](https://rsshub.app/gov/moa/zdscxx/价格指数)。\r\n\r\n  若订阅 \\`央视网\\` 报告来源 的 \\`蔬菜生产\\` 报告主题。此时路由为 [\\`/gov/moa/zdscxx/央视网/蔬菜生产\\`](https://rsshub.app/gov/moa/zdscxx/央视网/蔬菜生产)。\r\n:::\r\n\r\n| 价格指数 | 供需形势 | 分析报告周报 | 分析报告日报 | 日历信息 | 蔬菜生产 |\r\n| -------- | -------- | ------------ | ------------ | -------- | -------- |\r\n    `,\r\n    categories: ['government'],\r\n\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            title: '价格指数',\r\n            source: ['zdscxx.moa.gov.cn:8080/nyb/pc/messageList.jsp'],\r\n            target: '/gov/moa/zdscxx/价格指数',\r\n        },\r\n        {\r\n            title: '供需形势',\r\n            source: ['zdscxx.moa.gov.cn:8080/nyb/pc/messageList.jsp'],\r\n            target: '/gov/moa/zdscxx/供需形势',\r\n        },\r\n        {\r\n            title: '分析报告周报',\r\n            source: ['zdscxx.moa.gov.cn:8080/nyb/pc/messageList.jsp'],\r\n            target: '/gov/moa/zdscxx/分析报告周报',\r\n        },\r\n        {\r\n            title: '分析报告日报',\r\n            source: ['zdscxx.moa.gov.cn:8080/nyb/pc/messageList.jsp'],\r\n            target: '/gov/moa/zdscxx/分析报告日报',\r\n        },\r\n        {\r\n            title: '日历信息',\r\n            source: ['zdscxx.moa.gov.cn:8080/nyb/pc/messageList.jsp'],\r\n            target: '/gov/moa/zdscxx/日历信息',\r\n        },\r\n        {\r\n            title: '蔬菜生产',\r\n            source: ['zdscxx.moa.gov.cn:8080/nyb/pc/messageList.jsp'],\r\n            target: '/gov/moa/zdscxx/蔬菜生产',\r\n        },\r\n    ],\r\n};\r\n"],"mappings":"wWAOA,MAAa,EAAU,KAAO,IAAQ,CAClC,GAAM,CAAE,YAAa,EAAI,IAAI,QACvB,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,EAE/E,EAAS,aACT,EAAe,cAAc,IAC7B,EAAU,iBAAiB,EAAO,OAClC,EAAS,IAAI,IAAI,kBAAmB,GAAS,KAC7C,EAAe,IAAI,IAAI,sBAAuB,GAAS,KACvD,EAAa,IAAI,IAAI,yBAA0B,GAAS,KACxD,EAAW,IAAI,IAAI,iBAAkB,GAAc,KAEnD,EAAa,GAEnB,GAAI,EAAU,CACV,IAAM,EAAe,IAAI,IAAI,wBAAyB,GAAS,KAEzD,CAAE,KAAM,GAAmB,MAAMA,EAAI,KAAK,EAAc,CAC1D,KAAM,CACF,KAAM,GACN,gBAAiB,MAInBC,EAAoC,GAC1C,IAAK,IAAM,KAAK,EAAe,OAC3B,EAAQ,EAAE,KAAK,QAAU,EAAE,KAAK,IAAK,GAAM,EAAE,KAAK,QAGtD,IAAM,EAAa,EAAS,MAAM,MAClC,IAAK,IAAM,KAAK,EACZ,IAAK,IAAM,KAAO,OAAO,KAAK,GACtB,EAAQ,GAAK,SAAS,KACtB,EAAW,GAAO,GAMlC,GAAM,CAAE,KAAM,GAAa,MAAMD,EAAI,KAAK,EAAQ,CAC9C,KAAM,CACF,KAAM,EACN,KAAM,EACN,KAAM,GACN,gBAAiB,GACjB,GAAG,KAIP,EAAQ,EAAS,OAAO,MAAM,MAAM,EAAG,GAAO,IAAK,IAAU,CAC7D,MAAO,EAAK,MACZ,KAAM,EAAK,GACX,KAAM,cAAc,EAAK,KACzB,QAAS,EAAU,EAAK,SAG5B,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPE,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAMF,EAAI,KAAK,EAAc,CAC1D,KAAM,CACF,GAAI,EAAK,QAIX,EAAO,EAAe,OAQ5B,MANA,GAAK,MAAQ,EAAK,MAClB,EAAK,KAAO,IAAI,IAAI,6BAA6B,EAAK,OAAQ,GAAS,KACvE,EAAK,YAAc,EAAK,QACxB,EAAK,OAAS,EAAK,OACnB,EAAK,QAAU,EAAU,EAAK,MAEvB,MAKnB,GAAM,CAAE,KAAM,GAAkB,MAAMA,EAAI,GAEpC,EAAI,EAAK,GAET,EAAQ,EAAE,SAAS,OAEzB,MAAO,CACH,MAAO,GAAG,IAAQ,EAAW,MAAM,IAAa,KAChD,YAAa,KACb,KAAM,EACN,KAAM,EACN,WAAY,GACZ,MAAO,EAAE,iBAAiB,KAAK,OAC/B,OAAQ,IAIHG,EAAe,CACxB,KAAM,6BACN,KAAM,iBACN,IAAK,iBACL,YAAa,CAAC,WACd,UACA,QAAS,kBACT,WAAY,CAAE,SAAU,gBACxB,YAAa,2aASb,WAAY,CAAC,cAEb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,aAAc,GACd,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,MAAO,OACP,OAAQ,CAAC,iDACT,OAAQ,wBAEZ,CACI,MAAO,OACP,OAAQ,CAAC,iDACT,OAAQ,wBAEZ,CACI,MAAO,SACP,OAAQ,CAAC,iDACT,OAAQ,0BAEZ,CACI,MAAO,SACP,OAAQ,CAAC,iDACT,OAAQ,0BAEZ,CACI,MAAO,OACP,OAAQ,CAAC,iDACT,OAAQ,wBAEZ,CACI,MAAO,OACP,OAAQ,CAAC,iDACT,OAAQ"}