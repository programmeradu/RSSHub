import{__dirname as e,init_esm_shims as t}from"./esm-shims-Dqvxr0BZ.js";import{config as n}from"./config-Dl8a1sIg.js";import"./logger-CWOoofbD.js";import"./dist-IvUHtNe1.js";import"./helpers-DzX-lcQO.js";import{cache_default as r}from"./cache-kimkMTWJ.js";import{art as i}from"./render-CxhTJIsl.js";import{parseDate as a}from"./parse-date-Bgabdhlb.js";import{getSubPath as o}from"./common-utils-CvkwbCD5.js";import"./ofetch-Bzt0BXUH.js";import{got_default as s}from"./got-CdvI2yKX.js";import{ViewType as c}from"./types-A5bA50Mg.js";import{config_not_found_default as l}from"./config-not-found-BVqhRP9D.js";import u from"node:path";import{load as d}from"cheerio";t();const f=e=>{let t=e.match(/(\d+(\.\d+)?)(\w+)/);return t[3]===`GB`?t[1]*1024:t[1]},p=new Set([`javbus.com`,`javbus.org`,`javsee.icu`,`javsee.one`]),m={path:`/:path{.+}?`,radar:[{source:[`www.javbus.com/:path*`],target:`/:path`}],name:`Works`,maintainers:[`MegrezZhu`,`CoderTonyChan`,`nczitzk`,`Felix2yu`],categories:[`multimedia`],view:c.Videos,handler:h,url:`www.javbus.com`,example:`/javbus/star/rwt`,parameters:{path:{description:`Any path of list page on javbus`}},features:{nsfw:!0}};async function h(t){let c=/^\/western/.test(o(t)),m=t.req.query(`domain`)??`javbus.com`,h=t.req.query(`western_domain`)??`javbus.org`,g=`https://www.${m}`,_=`https://www.${h}`;if(!n.feature.allow_user_supply_unsafe_domain&&(!p.has(new URL(`https://${m}/`).hostname)||!p.has(new URL(`https://${h}/`).hostname)))throw new l(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);let v=`${c?_:g}${o(t).replace(/^\/western/,``).replace(/\/home/,``)}`,y={"accept-language":`zh-CN`},b=await s({method:`get`,url:v,headers:y}),x=d(b.data),S=x(`.movie-box`).slice(0,t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`)):50).toArray().map(e=>(e=x(e),{link:e.attr(`href`),guid:e.find(`date`).first().text(),pubDate:a(e.find(`date`).last().text())}));S=await Promise.all(S.map(t=>r.tryGet(t.link,async()=>{let n=await s({method:`get`,url:t.link,headers:y}),r=d(n.data);r(`.genre`).last().parent().remove(),r(`input[type="checkbox"], button`).remove();let a=r(`.avatar-box span`).toArray().map(e=>r(e).text()),o={author:a.join(`, `),title:r(`h3`).text(),category:[...r(`.genre label`).toArray().map(e=>r(e).text()),...a],info:r(`.row.movie`).html(),thumbs:r(`.sample-box`).toArray().map(e=>{let t=r(e).attr(`href`);return t.startsWith(`http`)?t:`${g}${t}`})},l,p,m;try{let e=n.data.match(/var gid = (\d+);[\S\s]*var uc = (\d+);[\S\s]*var img = '(.*)';/),r=await s({method:`get`,url:`${g}/ajax/uncledatoolsbyajax.php`,searchParams:{gid:e[1],lang:`zh`,img:e[3],uc:e[2],floor:800},headers:{Referer:t.link}}),i=d(`<table>${r.data}</table>`);l=i(`tr`).toArray().map(e=>{let t=i(e).find(`a[href]`);return{title:t.first().text().trim(),link:t.first().attr(`href`),size:t.eq(1).text().trim(),date:t.last().text().trim(),score:i(e).find(`a`).length**8*f(t.eq(1).text().trim())}}),l&&(t.enclosure_url=l.sort((e,t)=>t.score-e.score)[0].link,t.enclosure_type=`application/x-bittorrent`)}catch{}if(!c)try{let e=await s({method:`get`,url:`https://api.avgle.com/v1/jav/${t.guid}/0`});p=e.data.response.videos[0]?.embedded_url??``,m=e.data.response.videos[0]?.preview_video_url??``}catch{}return t.author=o.author,t.title=o.title,t.category=o.category,t.description=i(u.join(e,`templates/description-b7d433f7.art`),{info:o.info,thumbs:o.thumbs,magnets:l,videoSrc:p,videoPreview:m}),t})));let C=x(`head title`).text();return{title:`${C.startsWith(`JavBus`)?``:`JavBus - `}${C.replace(/ - AV磁力連結分享/,``)}`,link:v,item:S,allowEmpty:!0}}export{m as route};
//# sourceMappingURL=javbus-fpuhqVNi.js.map