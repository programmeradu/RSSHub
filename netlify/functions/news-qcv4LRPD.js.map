{"version":3,"file":"news-qcv4LRPD.js","names":["got","route: Route","$","cache"],"sources":["../../lib/routes/wzu/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { URL } from 'node:url';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\n/* 新闻列表\r\n温大新闻 http://www.wzu.edu.cn/index/wdxw.htm\r\n媒体温大 http://www.wzu.edu.cn/index/mtwd.htm\r\n学术温大 http://www.wzu.edu.cn/index/xswd.htm\r\n通知公告 http://www.wzu.edu.cn/index/tzgg.htm\r\n招标信息 http://www.wzu.edu.cn/index/zbxx.htm\r\n学术公告 http://www.wzu.edu.cn/index/xsgg.htm\r\n*/\r\n\r\nconst baseUrl = 'http://www.wzu.edu.cn/index/';\r\n\r\nconst newsType = {\r\n    wdxw: '温大新闻',\r\n    mtwd: '媒体温大',\r\n    xswd: '学术温大',\r\n    tzgg: '通知公告',\r\n    zbxx: '招标信息',\r\n    xsgg: '学术公告',\r\n};\r\n\r\n/**\r\n * @description: 抓取文章内容\r\n * @param {*} link\r\n * @return {*} description\r\n */\r\nasync function loadContent(link) {\r\n    let videoUrl = '';\r\n    // 请求文章页面\r\n    const newsResp = await got.get(link);\r\n    // 加载文章内容\r\n    const $ = load(newsResp.data, { decodeEntities: false });\r\n    // 图片相对链接处理\r\n    $('img').attr('src', (n, v) => new URL(v, baseUrl).href);\r\n    // 视频相对链接处理，替换原有播放方法 showVsbVideo\r\n    $('.vsbcontent_video').each(function () {\r\n        const u1 = $(this).find('script').attr('vurl');\r\n        videoUrl = new URL(u1, baseUrl).href;\r\n        return $(this)\r\n            .html('<video width=\"100%\" src=\"' + videoUrl + '\"></video>')\r\n            .html();\r\n    });\r\n    // 返回解析的结果\r\n    return $('div[id^=vsb_content]').html();\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/news/:type?',\r\n    name: 'Unknown',\r\n    maintainers: ['Chandler-Lu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    // 获取路由 Tag\r\n    const routeTag = Number.parseInt(ctx.req.param('type')) || 0;\r\n    // 设定新闻标题及 Url\r\n    const newsArr = Object.entries(newsType);\r\n    const [k1, newsTitle] = newsArr[routeTag];\r\n    const newsLink = new URL(k1 + '.htm', baseUrl).href;\r\n\r\n    const response = await got.get(newsLink);\r\n    const $ = load(response.data);\r\n    const list = $('#News-sidebar-b-nav').find('li');\r\n\r\n    return {\r\n        title: newsTitle,\r\n        link: newsLink,\r\n        description: '温州大学' + ' - ' + newsTitle,\r\n        item: list.toArray().map(async (item) => {\r\n            const $ = load(item);\r\n            const $a1 = $('li>a');\r\n            const $originUrl = $a1.attr('href');\r\n            const $itemUrl = new URL($originUrl, baseUrl).href;\r\n            return {\r\n                title: $a1.attr('title'),\r\n                description: await cache.tryGet($itemUrl, () => loadContent($itemUrl)),\r\n                pubDate: parseDate($('li>samp').text(), 'YYYY-MM-DD'),\r\n                link: $itemUrl,\r\n            };\r\n        }),\r\n    };\r\n}\r\n"],"mappings":"uYAgBA,MAAM,EAAU,+BAEV,EAAW,CACb,KAAM,OACN,KAAM,OACN,KAAM,OACN,KAAM,OACN,KAAM,OACN,KAAM,QAQV,eAAe,EAAY,EAAM,CAC7B,IAAI,EAAW,GAET,EAAW,MAAMA,EAAI,IAAI,GAEzB,EAAI,EAAK,EAAS,KAAM,CAAE,eAAgB,KAYhD,OAVA,EAAE,OAAO,KAAK,OAAQ,EAAG,IAAM,IAAI,EAAI,EAAG,GAAS,MAEnD,EAAE,qBAAqB,KAAK,UAAY,CACpC,IAAM,EAAK,EAAE,MAAM,KAAK,UAAU,KAAK,QAEvC,MADA,GAAW,IAAI,EAAI,EAAI,GAAS,KACzB,EAAE,MACJ,KAAK,4BAA8B,EAAW,cAC9C,SAGF,EAAE,wBAAwB,OAGrC,MAAaC,EAAe,CACxB,KAAM,eACN,KAAM,UACN,YAAa,CAAC,eACd,WAGJ,eAAe,EAAQ,EAAK,CAExB,IAAM,EAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,EAErD,EAAU,OAAO,QAAQ,GACzB,CAAC,EAAI,GAAa,EAAQ,GAC1B,EAAW,IAAI,EAAI,EAAK,OAAQ,GAAS,KAEzC,EAAW,MAAMD,EAAI,IAAI,GACzB,EAAI,EAAK,EAAS,MAClB,EAAO,EAAE,uBAAuB,KAAK,MAE3C,MAAO,CACH,MAAO,EACP,KAAM,EACN,YAAa,UAAiB,EAC9B,KAAM,EAAK,UAAU,IAAI,KAAO,IAAS,CACrC,IAAME,EAAI,EAAK,GACT,EAAMA,EAAE,QACR,EAAa,EAAI,KAAK,QACtB,EAAW,IAAI,EAAI,EAAY,GAAS,KAC9C,MAAO,CACH,MAAO,EAAI,KAAK,SAChB,YAAa,MAAMC,EAAM,OAAO,MAAgB,EAAY,IAC5D,QAAS,EAAUD,EAAE,WAAW,OAAQ,cACxC,KAAM"}