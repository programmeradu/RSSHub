{"version":3,"file":"jwc-DYSnKrAJ.js","names":["route: Route","InvalidParameterError","ofetch","cache"],"sources":["../../lib/routes/uestc/jwc.ts"],"sourcesContent":["import { Data, DataItem, Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport type { Context } from 'hono';\r\n\r\nconst baseUrl = 'https://www.jwc.uestc.edu.cn/';\r\nconst detailUrl = 'https://www.jwc.uestc.edu.cn/info/';\r\n\r\nconst dateTimeRegex = /(\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2})/;\r\n\r\nconst typeUrlMap = {\r\n    important: 'hard/?page=1',\r\n    student: 'list/256/?page=1',\r\n    teacher: 'list/255/?page=1',\r\n    teaching: 'list/40/?page=1',\r\n    office: 'list/ff80808160bcf79c0160c010a8d20020/?page=1',\r\n};\r\n\r\nconst typeNameMap = {\r\n    important: '重要公告',\r\n    student: '学生事务公告',\r\n    teacher: '教师事务公告',\r\n    teaching: '教学新闻',\r\n    office: '办公室',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/jwc/:type?',\r\n    categories: ['university'],\r\n    example: '/uestc/jwc/student',\r\n    parameters: { type: '默认为 `important`' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.jwc.uestc.edu.cn/'],\r\n            target: '/jwc',\r\n        },\r\n    ],\r\n    name: '教务处',\r\n    maintainers: ['achjqz', 'mobyw'],\r\n    handler,\r\n    url: 'www.jwc.uestc.edu.cn/',\r\n    description: `\\\r\n| 重要公告  | 学生事务公告 | 教师事务公告 | 教学新闻 | 办公室 |\r\n| --------- | ------------ | ------------ | -------- | ------ |\r\n| important | student      | teacher      | teaching | office |`,\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const type = ctx.req.param('type') || 'important';\r\n    if (type in typeUrlMap === false) {\r\n        throw new InvalidParameterError('type not supported');\r\n    }\r\n    const typeName = typeNameMap[type];\r\n\r\n    const indexContent = await ofetch(baseUrl + typeUrlMap[type]);\r\n\r\n    const $ = load(indexContent);\r\n    const entries = $('div.textAreo.clearfix').toArray();\r\n\r\n    const items = entries.map(async (entry) => {\r\n        const element = $(entry);\r\n        const newsTitle = element.find('a').attr('title') ?? '';\r\n        const newsLink = detailUrl + element.find('a').attr('newsid');\r\n\r\n        const newsDetail = await cache.tryGet(newsLink, async () => {\r\n            const newsContent = await ofetch(newsLink);\r\n            const content = load(newsContent);\r\n\r\n            const basicInfo = content('div.detail_header').find('div.item').text();\r\n            const match = dateTimeRegex.exec(basicInfo);\r\n\r\n            return {\r\n                title: newsTitle,\r\n                link: newsLink,\r\n                pubDate: match ? timezone(parseDate(match[1]), +8) : null,\r\n                description: content('div.NewText').html(),\r\n            };\r\n        });\r\n\r\n        return newsDetail;\r\n    });\r\n\r\n    const out = await Promise.all(items);\r\n\r\n    return {\r\n        title: `教务处通知（${typeName}）`,\r\n        link: baseUrl,\r\n        description: `电子科技大学教务处通知（${typeName}）`,\r\n        item: out as DataItem[],\r\n    };\r\n}\r\n"],"mappings":"ibASA,MAAM,EAAU,gCAGV,EAAgB,kCAEhB,EAAa,CACf,UAAW,eACX,QAAS,mBACT,QAAS,mBACT,SAAU,kBACV,OAAQ,iDAGN,EAAc,CAChB,UAAW,OACX,QAAS,SACT,QAAS,SACT,SAAU,OACV,OAAQ,OAGCA,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,cACb,QAAS,qBACT,WAAY,CAAE,KAAM,mBACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,yBACT,OAAQ,SAGhB,KAAM,MACN,YAAa,CAAC,SAAU,SACxB,UACA,IAAK,wBACL,YAAa;;kEAMjB,eAAe,EAAQ,EAA6B,CAChD,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,YACtC,GAAI,OAAQ,GACR,MAAM,IAAIC,EAAsB,sBAEpC,IAAM,EAAW,EAAY,GAEvB,EAAe,MAAMC,EAAO,EAAU,EAAW,IAEjD,EAAI,EAAK,GACT,EAAU,EAAE,yBAAyB,UAErC,EAAQ,EAAQ,IAAI,KAAO,IAAU,CACvC,IAAM,EAAU,EAAE,GACZ,EAAY,EAAQ,KAAK,KAAK,KAAK,UAAY,GAC/C,EAAW,qCAAY,EAAQ,KAAK,KAAK,KAAK,UAE9C,EAAa,MAAMC,EAAM,OAAO,EAAU,SAAY,CACxD,IAAM,EAAc,MAAMD,EAAO,GAC3B,EAAU,EAAK,GAEf,EAAY,EAAQ,qBAAqB,KAAK,YAAY,OAC1D,EAAQ,EAAc,KAAK,GAEjC,MAAO,CACH,MAAO,EACP,KAAM,EACN,QAAS,EAAQ,EAAS,EAAU,EAAM,IAAK,GAAM,KACrD,YAAa,EAAQ,eAAe,UAI5C,OAAO,IAGL,EAAM,MAAM,QAAQ,IAAI,GAE9B,MAAO,CACH,MAAO,SAAS,EAAS,GACzB,KAAM,EACN,YAAa,eAAe,EAAS,GACrC,KAAM"}