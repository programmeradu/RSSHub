{"version":3,"file":"news-BfcH3-gZ.js","names":["ofetch","route: Route","item: DataItem","cache","ofetch","item"],"sources":["../../lib/routes/kurogames/wutheringwaves/utils.ts","../../lib/routes/kurogames/wutheringwaves/news.ts"],"sourcesContent":["import ofetch from '@/utils/ofetch';\r\nimport { Data } from '@/types';\r\nimport { Article, Language, SUPPORTED_LANGUAGES } from './constants';\r\n\r\n/**\r\n * Parse a number or a number as string.\\\r\n * **NOTE:** this may return `NaN` if the string is not a number or the value is `undefined` and no {@link fallback} is provided.\r\n */\r\nexport const parseInteger = (value?: string | number, fallback?: number): number => {\r\n    if (typeof value === 'number') {\r\n        return value;\r\n    }\r\n\r\n    if (value === undefined) {\r\n        return fallback === undefined ? NaN : fallback;\r\n    }\r\n\r\n    const parsed = Number.parseInt(value, 10);\r\n\r\n    if (fallback !== undefined && Number.isNaN(parsed)) {\r\n        return fallback;\r\n    }\r\n\r\n    return parsed;\r\n};\r\n\r\n/** Type-guard to ensure {@link language} is a valid value of {@link SUPPORTED_LANGUAGES}. */\r\nexport const isValidLanguage = (language: string): language is Language => SUPPORTED_LANGUAGES.includes(language as Language);\r\n\r\n/** Fetch the articles for a given language in a given category. */\r\nexport const fetchArticles = (language: Language): Promise<Article[]> => {\r\n    if (language === Language.Chinese) {\r\n        return ofetch<Article[]>('https://media-cdn-mingchao.kurogame.com/akiwebsite/website2.0/json/G152/zh/ArticleMenu.json', { query: { t: Date.now() } });\r\n    }\r\n\r\n    return ofetch<{ article: Article[] }>(`https://hw-media-cdn-mingchao.kurogame.com/akiwebsite/website2.0/json/G152/${language}/MainMenu.json`).then((data) => data.article);\r\n};\r\n\r\n/** Get the link to the article content. */\r\nexport const getArticleContentLink = (language: Language, articleId: number): string => {\r\n    if (language === Language.Chinese) {\r\n        return `https://media-cdn-mingchao.kurogame.com/akiwebsite/website2.0/json/G152/zh/article/${articleId}.json`;\r\n    }\r\n\r\n    return `https://hw-media-cdn-mingchao.kurogame.com/akiwebsite/website2.0/json/G152/${language}/article/${articleId}.json`;\r\n};\r\n\r\n/** Get the link to an article from its ID. */\r\nexport const getArticleLink = (language: Language, articleId: number): string => {\r\n    if (language === Language.Chinese) {\r\n        return `https://mc.kurogames.com/main/news/detail/${articleId}`;\r\n    }\r\n\r\n    return `https://wutheringwaves.kurogames.com/${language}/main/news/detail/${articleId}`;\r\n};\r\n\r\n/** Resolve the handler language from the {@link Language}. */\r\nexport const getHandlerLanguage = (language: Language): Exclude<Data['language'], undefined> => {\r\n    switch (language) {\r\n        case Language.English:\r\n            return 'en';\r\n        case Language.Chinese:\r\n            return 'zh-CN';\r\n        case Language.ChineseTaiwan:\r\n            return 'zh-TW';\r\n        case Language.French:\r\n            return 'fr';\r\n        case Language.German:\r\n            return 'de';\r\n        case Language.Japanese:\r\n            return 'ja';\r\n        case Language.Korean:\r\n            return 'ko';\r\n        case Language.Spanish:\r\n            return 'es';\r\n        default:\r\n            throw new Error(`Could not resolve handler language from \"${language}\"`);\r\n    }\r\n};\r\n","import { DataItem, Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport * as cheerio from 'cheerio';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { Article, Language, Parameter, SUPPORTED_LANGUAGES } from './constants';\r\nimport { fetchArticles, getArticleContentLink, getArticleLink, getHandlerLanguage, isValidLanguage, parseInteger } from './utils';\r\n\r\nexport const route: Route = {\r\n    path: `/wutheringwaves/news/:${Parameter.Language}?`,\r\n    categories: ['game'],\r\n    example: '/kurogames/wutheringwaves/news',\r\n    parameters: {\r\n        [Parameter.Language]: 'The language to use for the content. Default: `zh`.',\r\n    },\r\n    name: '鸣潮 — 游戏公告、新闻与活动',\r\n    radar: [\r\n        {\r\n            source: ['mc.kurogames.com/m/main/news', 'mc.kurogames.com/main'],\r\n        },\r\n        {\r\n            title: 'Wuthering Waves — Game announcements, news and events',\r\n            source: ['wutheringwaves.kurogames.com/en/main/news', 'wutheringwaves.kurogames.com/en/main'],\r\n        },\r\n    ],\r\n    maintainers: ['goestav', 'enpitsulin'],\r\n    description: `\r\nLanguage codes for the \\`${Parameter.Language}\\` parameter:\r\n\r\n| Language | Code         |\r\n|----------|--------------|\r\n| English  | en           |\r\n| 日本語    | jp           |\r\n| 한국어     | kr           |\r\n| 简体中文   | zh (default) |\r\n| 繁體中文   | zh-tw        |\r\n| Español  | es           |\r\n| Français | fr           |\r\n| Deutsch  | de           |\r\n    `,\r\n    async handler(ctx) {\r\n        const limitParam = ctx.req.query(Parameter.Limit);\r\n        const languageParam = ctx.req.param(Parameter.Language);\r\n\r\n        const limit = parseInteger(limitParam, 30);\r\n        const language = languageParam || Language.Chinese;\r\n\r\n        if (!isValidLanguage(language)) {\r\n            throw new TypeError(`Language parameter is not valid. Please use one of the following: ${SUPPORTED_LANGUAGES.join(', ')}`);\r\n        }\r\n\r\n        const articles = await fetchArticles(language);\r\n        const filteredArticles = articles.filter((a) => a.articleType !== 0).slice(0, limit);\r\n\r\n        const item = await Promise.all(\r\n            filteredArticles.map((article) => {\r\n                const contentUrl = getArticleContentLink(language, article.articleId);\r\n                const item: DataItem = {\r\n                    title: article.articleTitle,\r\n                    pubDate: timezone(parseDate(article.createTime), +8),\r\n                    link: getArticleLink(language, article.articleId),\r\n                };\r\n\r\n                return cache.tryGet(`wutheringwaves:${language}:${article.articleId}`, async () => {\r\n                    const articleDetails = await ofetch<Article>(contentUrl, { query: { t: Date.now() } });\r\n                    // Article content may not always be available, e.g: https://wutheringwaves.kurogames.com/zh-tw/main/news/detail/2596\r\n                    const articleContent = articleDetails.articleContent ?? '';\r\n\r\n                    const $ = cheerio.load(articleContent);\r\n\r\n                    item.description = $.html() ?? article.articleDesc ?? '';\r\n\r\n                    return item;\r\n                }) as Promise<DataItem>;\r\n            })\r\n        );\r\n\r\n        const title = language === Language.Chinese ? '《鸣潮》— 游戏公告、新闻和活动' : 'Wuthering Waves - Announcements, News and Events';\r\n        const link = language === Language.Chinese ? 'https://mc.kurogames.com/main#news' : `https://wutheringwaves.kurogames.com/${language}/main/#news`;\r\n\r\n        return {\r\n            title,\r\n            link,\r\n            item,\r\n            language: getHandlerLanguage(language),\r\n        };\r\n    },\r\n};\r\n"],"mappings":"2bAQA,MAAa,GAAgB,EAAyB,IAA8B,CAChF,GAAI,OAAO,GAAU,SACjB,OAAO,EAGX,GAAI,IAAU,IAAA,GACV,OAAO,IAAa,IAAA,GAAY,IAAM,EAG1C,IAAM,EAAS,OAAO,SAAS,EAAO,IAMtC,OAJI,IAAa,IAAA,IAAa,OAAO,MAAM,GAChC,EAGJ,GAIE,EAAmB,GAA2C,EAAoB,SAAS,GAG3F,EAAiB,GACtB,IAAa,EAAS,QACfI,EAAkB,8FAA+F,CAAE,MAAO,CAAE,EAAG,KAAK,SAGxIA,EAA+B,8EAA8E,EAAS,iBAAiB,KAAM,GAAS,EAAK,SAIzJ,GAAyB,EAAoB,IAClD,IAAa,EAAS,QACf,sFAAsF,EAAU,OAGpG,8EAA8E,EAAS,WAAW,EAAU,OAI1G,GAAkB,EAAoB,IAC3C,IAAa,EAAS,QACf,6CAA6C,IAGjD,wCAAwC,EAAS,oBAAoB,IAInE,EAAsB,GAA6D,CAC5F,OAAQ,EAAR,CACI,KAAK,EAAS,QACV,MAAO,KACX,KAAK,EAAS,QACV,MAAO,QACX,KAAK,EAAS,cACV,MAAO,QACX,KAAK,EAAS,OACV,MAAO,KACX,KAAK,EAAS,OACV,MAAO,KACX,KAAK,EAAS,SACV,MAAO,KACX,KAAK,EAAS,OACV,MAAO,KACX,KAAK,EAAS,QACV,MAAO,KACX,QACI,MAAU,MAAM,4CAA4C,EAAS,MCnEpEH,EAAe,CACxB,KAAM,yBAAyB,EAAU,SAAS,GAClD,WAAY,CAAC,QACb,QAAS,iCACT,WAAY,EACP,EAAU,UAAW,uDAE1B,KAAM,kBACN,MAAO,CACH,CACI,OAAQ,CAAC,+BAAgC,0BAE7C,CACI,MAAO,wDACP,OAAQ,CAAC,4CAA6C,0CAG9D,YAAa,CAAC,UAAW,cACzB,YAAa;2BACU,EAAU,SAAS;;;;;;;;;;;;MAa1C,MAAM,QAAQ,EAAK,CACf,IAAM,EAAa,EAAI,IAAI,MAAM,EAAU,OACrC,EAAgB,EAAI,IAAI,MAAM,EAAU,UAExC,EAAQ,EAAa,EAAY,IACjC,EAAW,GAAiB,EAAS,QAE3C,GAAI,CAAC,EAAgB,GACjB,MAAU,UAAU,qEAAqE,EAAoB,KAAK,SAGtH,IAAM,EAAW,MAAM,EAAc,GAC/B,EAAmB,EAAS,OAAQ,GAAM,EAAE,cAAgB,GAAG,MAAM,EAAG,GAExE,EAAO,MAAM,QAAQ,IACvB,EAAiB,IAAK,GAAY,CAC9B,IAAM,EAAa,EAAsB,EAAU,EAAQ,WACrDC,EAAiB,CACnB,MAAO,EAAQ,aACf,QAAS,EAAS,EAAU,EAAQ,YAAa,GACjD,KAAM,EAAe,EAAU,EAAQ,YAG3C,OAAOC,EAAM,OAAO,kBAAkB,EAAS,GAAG,EAAQ,YAAa,SAAY,CAC/E,IAAM,EAAiB,MAAMC,EAAgB,EAAY,CAAE,MAAO,CAAE,EAAG,KAAK,SAEtE,EAAiB,EAAe,gBAAkB,GAElD,EAAI,EAAQ,KAAK,GAIvB,MAFA,GAAK,YAAc,EAAE,QAAU,EAAQ,aAAe,GAE/CC,OAKb,EAAQ,IAAa,EAAS,QAAU,mBAAqB,mDAC7D,EAAO,IAAa,EAAS,QAAU,qCAAuC,wCAAwC,EAAS,aAErI,MAAO,CACH,QACA,OACA,OACA,SAAU,EAAmB"}