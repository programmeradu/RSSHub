{"version":3,"file":"notice-yc9hhO0o.js","names":["got","route: Route","cache"],"sources":["../../lib/routes/ecust/jwc/notice.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst baseUrl = 'https://jwc.ecust.edu.cn';\r\nconst categoryMap = {\r\n    mto: { link: '/3938', name: '教学运行管理' },\r\n    mttb: { link: '/3939', name: '培养与教学建设管理' },\r\n    gi: { link: '/zhglbgs', name: '综合信息' },\r\n    mpt: { link: '/3940', name: '实践教学管理' },\r\n    fai: { link: '/3941', name: '学院教务信息' },\r\n};\r\nconst get_from_link = async (link) => {\r\n    const { data: response } = await got(link);\r\n    const $ = load(response);\r\n    const articleList = $('div#wp_news_w2 table[width=\"100%\"]')\r\n        .toArray()\r\n        .map((item) => {\r\n            const a = $(item).find('a');\r\n            const date = $(item).find('div[style=\"white-space:nowrap\"]').first();\r\n            // deal with article_link\r\n            let articleLink = a.attr('href');\r\n            if (!articleLink.startsWith('http')) {\r\n                articleLink = `${baseUrl}${articleLink}`;\r\n            }\r\n            articleLink = articleLink.replace(/^https:\\/\\/(\\w+)-ecust-edu-cn-s\\.sslvpn\\.ecust\\.edu\\.cn:8118/, 'https://$1.ecust.edu.cn').replace(/^https:\\/\\/ecust-edu-cn-s\\.sslvpn\\.ecust\\.edu\\.cn:8118/, 'https://ecust.edu.cn');\r\n            return {\r\n                title: a.text(),\r\n                link: articleLink,\r\n                pubDate: parseDate(date.text()),\r\n            };\r\n        });\r\n    return articleList;\r\n};\r\nexport const route: Route = {\r\n    path: '/jwc/:category?',\r\n    categories: ['university'],\r\n    example: '/ecust/jwc/mto',\r\n    parameters: { category: '订阅板块，默认为全部订阅' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '本科教务处信息网',\r\n    maintainers: ['lxl66566'],\r\n    handler,\r\n    description: `| 其他任意值 | mto          | mttb               | gi       | mpt          | fai          |\r\n| ---------- | ------------ | ------------------ | -------- | ------------ | ------------ |\r\n| 全部订阅   | 教学运行管理 | 培养与教学建设管理 | 综合信息 | 实践教学管理 | 学院教务信息 |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'all' } = ctx.req.param();\r\n    const categoryItem = categoryMap[category] || null; // all -> null\r\n    const pageUrl = categoryItem ? [`${baseUrl}${categoryItem.link}/list.htm`] : Object.values(categoryMap).map((item) => `${baseUrl}${item.link}/list.htm`);\r\n    const items = (await Promise.all(pageUrl.map((link) => get_from_link(link)))).flat();\r\n    const result = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: response } = await got(item.link);\r\n                const content = load(response);\r\n                // remove all attrs and empty objects\r\n                content('div.wp_articlecontent *').each(function () {\r\n                    if (!content(this).text().trim()) {\r\n                        return content(this).remove();\r\n                    }\r\n                    for (const attr in this.attribs) {\r\n                        content(this).removeAttr(attr);\r\n                    }\r\n                });\r\n                const description = content('div.wp_articlecontent').first().html();\r\n                // merge same objects, replace two times instead of replace recursively\r\n                description && (item.description = description.replaceAll(/<\\/(p|span|strong)>\\s*<\\1>/g, '').replaceAll(/<\\/(p|span|strong)>\\s*<\\1>/g, ''));\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n    return {\r\n        title: `华理教务处 - ${categoryItem ? categoryItem.name : '全部'}`,\r\n        link: categoryItem ? pageUrl[0] : baseUrl,\r\n        item: result,\r\n    };\r\n}\r\n"],"mappings":"wWAMA,MAAM,EAAU,2BACV,EAAc,CAChB,IAAK,CAAE,KAAM,QAAS,KAAM,UAC5B,KAAM,CAAE,KAAM,QAAS,KAAM,aAC7B,GAAI,CAAE,KAAM,WAAY,KAAM,QAC9B,IAAK,CAAE,KAAM,QAAS,KAAM,UAC5B,IAAK,CAAE,KAAM,QAAS,KAAM,WAE1B,EAAgB,KAAO,IAAS,CAClC,GAAM,CAAE,KAAM,GAAa,MAAMA,EAAI,GAC/B,EAAI,EAAK,GACT,EAAc,EAAE,sCACjB,UACA,IAAK,GAAS,CACX,IAAM,EAAI,EAAE,GAAM,KAAK,KACjB,EAAO,EAAE,GAAM,KAAK,mCAAmC,QAEzD,EAAc,EAAE,KAAK,QAKzB,OAJK,EAAY,WAAW,UACxB,EAAc,GAAG,IAAU,KAE/B,EAAc,EAAY,QAAQ,+DAAgE,2BAA2B,QAAQ,yDAA0D,wBACxL,CACH,MAAO,EAAE,OACT,KAAM,EACN,QAAS,EAAU,EAAK,WAGpC,OAAO,GAEEC,EAAe,CACxB,KAAM,kBACN,WAAY,CAAC,cACb,QAAS,iBACT,WAAY,CAAE,SAAU,gBACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,WACN,YAAa,CAAC,YACd,UACA,YAAa;;2DAKjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,OAAU,EAAI,IAAI,QAC/B,EAAe,EAAY,IAAa,KACxC,EAAU,EAAe,CAAC,GAAG,IAAU,EAAa,KAAK,YAAc,OAAO,OAAO,GAAa,IAAK,GAAS,GAAG,IAAU,EAAK,KAAK,YACvI,GAAS,MAAM,QAAQ,IAAI,EAAQ,IAAK,GAAS,EAAc,MAAS,OACxE,EAAS,MAAM,QAAQ,IACzB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAa,MAAMF,EAAI,EAAK,MACpC,EAAU,EAAK,GAErB,EAAQ,2BAA2B,KAAK,UAAY,CAChD,GAAI,CAAC,EAAQ,MAAM,OAAO,OACtB,OAAO,EAAQ,MAAM,SAEzB,IAAK,IAAM,KAAQ,KAAK,QACpB,EAAQ,MAAM,WAAW,KAGjC,IAAM,EAAc,EAAQ,yBAAyB,QAAQ,OAG7D,OADA,IAAgB,EAAK,YAAc,EAAY,WAAW,8BAA+B,IAAI,WAAW,8BAA+B,KAChI,MAInB,MAAO,CACH,MAAO,WAAW,EAAe,EAAa,KAAO,OACrD,KAAM,EAAe,EAAQ,GAAK,EAClC,KAAM"}