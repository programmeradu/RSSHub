{"version":3,"file":"guancha-DzMxtcwS.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/guancha/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate, parseRelativeDate } from '@/utils/parse-date';\r\n\r\nconst config = {\r\n    review: {\r\n        title: '评论 & 研究',\r\n        query: '.module-news-main',\r\n    },\r\n    story: {\r\n        title: '要闻',\r\n        query: '.img-List',\r\n    },\r\n    fengwen: {\r\n        title: '风闻',\r\n        query: '.fengwen-list',\r\n    },\r\n    redian: {\r\n        title: '热点',\r\n    },\r\n    gundong: {\r\n        title: '滚动',\r\n    },\r\n    all: {\r\n        title: '全部',\r\n    },\r\n    home: {\r\n        title: '首页',\r\n    },\r\n    others: {\r\n        title: '热点 & 滚动',\r\n    },\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:category?',\r\n    categories: ['new-media'],\r\n    example: '/guancha',\r\n    parameters: { category: '分类，见下表，默认为全部' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['guancha.cn/'],\r\n        },\r\n    ],\r\n    name: '首页',\r\n    maintainers: ['nczitzk', 'Jeason0228'],\r\n    handler,\r\n    url: 'guancha.cn/',\r\n    description: `| 全部 | 评论 & 研究 | 要闻  | 风闻    | 热点新闻 | 滚动新闻 |\r\n| ---- | ----------- | ----- | ------- | -------- | -------- |\r\n| all  | review      | story | fengwen | redian   | gundong  |\r\n\r\n  home = 评论 & 研究 + 要闻 + 风闻\r\n\r\n  others = 热点新闻 + 滚动新闻\r\n\r\n::: tip\r\n  观察者网首页左中右的三个 column 分别对应 **评论 & 研究**、**要闻**、**风闻** 三个部分。\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const total = 10;\r\n    const category = ctx.req.param('category') ?? 'all';\r\n    const rootUrl = 'https://www.guancha.cn';\r\n\r\n    let newsList = [],\r\n        redianList = [],\r\n        gundongList = [];\r\n\r\n    // 'review', 'story' and 'fengwen' come from homepage.\r\n\r\n    if (category === 'review' || category === 'story' || category === 'fengwen' || category === 'all' || category === 'home') {\r\n        const response = await got({\r\n            method: 'get',\r\n            url: rootUrl,\r\n        });\r\n\r\n        const $ = load(response.data);\r\n\r\n        const fetchPost = (slice) =>\r\n            slice\r\n                .find('h4.module-title a')\r\n                .toArray()\r\n\r\n                // Filter some blank links which lead to no contents but 'https://user.guancha.cn'.\r\n\r\n                .filter((item) => $(item).attr('href') !== 'https://user.guancha.cn')\r\n                .map((item) => {\r\n                    item = $(item);\r\n\r\n                    const link = item.attr('href');\r\n\r\n                    return {\r\n                        title: item.text(),\r\n                        link: `${link.indexOf('http') === 0 ? '' : rootUrl}${link.replace(/\\.shtml/, '_s.shtml')}`,\r\n                    };\r\n                });\r\n\r\n        newsList =\r\n            category === 'all' || category === 'home'\r\n                ? [...fetchPost($(config.review.query)).slice(0, total / 3), ...fetchPost($(config.story.query)).slice(0, total / 3), ...fetchPost($(config.fengwen.query)).slice(0, total / 3)]\r\n                : fetchPost($(config[category].query)).slice(0, total);\r\n    }\r\n\r\n    // 'redian' and 'gundong' come from api.\r\n\r\n    if (category === 'redian' || category === 'all' || category === 'others') {\r\n        const response = await got({\r\n            method: 'get',\r\n            url: `${rootUrl}/api/redian.htm`,\r\n        });\r\n\r\n        redianList = response.data.items\r\n            .map((item) => ({\r\n                title: item.TITLE,\r\n                link: `${rootUrl}${item.HTTP_URL.replace(/\\.shtml/, '_s.shtml')}`,\r\n            }))\r\n            .slice(0, category === 'all' ? total / 3 : total);\r\n    }\r\n\r\n    if (category === 'gundong' || category === 'all' || category === 'others') {\r\n        const response = await got({\r\n            method: 'get',\r\n            url: `${rootUrl}/api/gundong.htm`,\r\n        });\r\n\r\n        gundongList = response.data.items\r\n            .map((item) => ({\r\n                title: item.TITLE,\r\n                link: `${rootUrl}${item.HTTP_URL.replace(/\\.shtml/, '_s.shtml')}`,\r\n            }))\r\n            .slice(0, category === 'all' ? total / 3 : total);\r\n    }\r\n\r\n    const items = await Promise.all(\r\n        [...newsList, ...redianList, ...gundongList].map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                let detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                });\r\n\r\n                // Some links to posts in 'fengwen' must be redirected in order to fetch content.\r\n                // eg. https://www.guancha.cn/politics/2020_10_23_569021.shtml\r\n                //  => https://user.guancha.cn/main/content?id=399176\r\n\r\n                const jumpMatch = detailResponse.data.match(/user.guancha.cn\\/main\\/content\\?id=(.*)\";/);\r\n\r\n                if (jumpMatch !== null) {\r\n                    item.link = `https://user.guancha.cn/main/content?id=${jumpMatch[1]}&page=0`;\r\n                    detailResponse = await got({\r\n                        method: 'get',\r\n                        url: item.link,\r\n                    });\r\n                }\r\n\r\n                const content = load(detailResponse.data);\r\n\r\n                const dateMatch = detailResponse.data.match(/\"pubDate\": \"(.*)\"/);\r\n                item.pubDate =\r\n                    dateMatch === null\r\n                        ? parseRelativeDate(content('.time1').text()) // PubDates of posts in 'fengwen' are in an informal format.\r\n                        : timezone(parseDate(dateMatch[1]), +8);\r\n\r\n                item.description = content('.all-txt').html() || content('.article-txt-content').html();\r\n                item.author = content('.author-intro p a').text() || content('.article-content div div h4 a').text() || content('.editor-intro p a').text() || content('.left-main > div.time.fix > span').eq(2).text();\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `观察者网 - ${config[category].title}`,\r\n        link: rootUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}