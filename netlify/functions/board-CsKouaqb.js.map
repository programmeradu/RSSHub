{"version":3,"file":"board-CsKouaqb.js","names":["route: Route","cache","ofetch"],"sources":["../../lib/routes/dxy/board.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { phoneBaseUrl, webBaseUrl, generateNonce, sign, getPost } from './utils';\r\nimport { config } from '@/config';\r\nimport { BoardInfo, PostListData } from './types';\r\n\r\nexport const route: Route = {\r\n    path: '/bbs/board/:boardId',\r\n    categories: ['bbs'],\r\n    example: '/dxy/bbs/board/46',\r\n    parameters: { specialId: '板块 ID，可在对应板块页 URL 中找到' },\r\n    name: '板块',\r\n    maintainers: ['TonyRL'],\r\n    radar: [\r\n        {\r\n            source: ['www.dxy.cn/bbs/newweb/pc/category/:boardIdId'],\r\n            target: '/bbs/board/:boardIdId',\r\n        },\r\n        {\r\n            source: ['3g.dxy.cn/bbs/board/:boardIdId'],\r\n            target: '/bbs/board/:boardIdId',\r\n        },\r\n    ],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { boardId } = ctx.req.param();\r\n    const { limit = '20' } = ctx.req.query();\r\n\r\n    const boardDetail = (await cache.tryGet(`dxy:board:detail:${boardId}`, async () => {\r\n        const detailParams = {\r\n            boardId,\r\n            timestamp: Date.now(),\r\n            noncestr: generateNonce(8, 'number'),\r\n        };\r\n\r\n        const detail = await ofetch(`${phoneBaseUrl}/bbsapi/bbs/board/detail`, {\r\n            query: {\r\n                ...detailParams,\r\n                sign: sign(detailParams),\r\n            },\r\n        });\r\n        if (detail.code !== 'success') {\r\n            throw new Error(detail.message);\r\n        }\r\n        return detail.data;\r\n    })) as BoardInfo;\r\n\r\n    const boardList = (await cache.tryGet(\r\n        `dxy:board:list:${boardId}`,\r\n        async () => {\r\n            const listParams = {\r\n                boardId,\r\n                postType: '0',\r\n                orderType: '1',\r\n                pageNum: '1',\r\n                pageSize: limit,\r\n                timestamp: Date.now(),\r\n                noncestr: generateNonce(8, 'number'),\r\n            };\r\n\r\n            const recommendList = await ofetch(`${phoneBaseUrl}/bbsapi/bbs/board/post/list`, {\r\n                query: {\r\n                    ...listParams,\r\n                    sign: sign(listParams),\r\n                },\r\n            });\r\n            if (recommendList.code !== 'success') {\r\n                throw new Error(recommendList.message);\r\n            }\r\n            return recommendList.data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    )) as PostListData;\r\n\r\n    const list = boardList.result.map((item) => ({\r\n        title: item.subject,\r\n        author: item.postUser.nickname,\r\n        category: [boardDetail.title],\r\n        link: `${webBaseUrl}/bbs/newweb/pc/post/${item.postId}`,\r\n        postId: item.postId,\r\n    }));\r\n\r\n    const items = await Promise.all(list.map((item) => getPost(item, cache.tryGet)));\r\n\r\n    return {\r\n        title: boardDetail.title,\r\n        description: `${boardDetail.postCount} 內容 ${boardDetail.followCount} 关注`,\r\n        link: `${webBaseUrl}/bbs/newweb/pc/category/${boardId}`,\r\n        image: boardDetail.boardAvatar,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"8XAOA,MAAaA,EAAe,CACxB,KAAM,sBACN,WAAY,CAAC,OACb,QAAS,oBACT,WAAY,CAAE,UAAW,yBACzB,KAAM,KACN,YAAa,CAAC,UACd,MAAO,CACH,CACI,OAAQ,CAAC,gDACT,OAAQ,yBAEZ,CACI,OAAQ,CAAC,kCACT,OAAQ,0BAGhB,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAY,EAAI,IAAI,QACtB,CAAE,QAAQ,MAAS,EAAI,IAAI,QAE3B,EAAe,MAAMC,EAAM,OAAO,oBAAoB,IAAW,SAAY,CAC/E,IAAM,EAAe,CACjB,UACA,UAAW,KAAK,MAChB,SAAU,EAAc,EAAG,WAGzB,EAAS,MAAMC,EAAO,GAAG,EAAa,0BAA2B,CACnE,MAAO,CACH,GAAG,EACH,KAAM,EAAK,MAGnB,GAAI,EAAO,OAAS,UAChB,MAAU,MAAM,EAAO,SAE3B,OAAO,EAAO,OAGZ,EAAa,MAAMD,EAAM,OAC3B,kBAAkB,IAClB,SAAY,CACR,IAAM,EAAa,CACf,UACA,SAAU,IACV,UAAW,IACX,QAAS,IACT,SAAU,EACV,UAAW,KAAK,MAChB,SAAU,EAAc,EAAG,WAGzB,EAAgB,MAAMC,EAAO,GAAG,EAAa,6BAA8B,CAC7E,MAAO,CACH,GAAG,EACH,KAAM,EAAK,MAGnB,GAAI,EAAc,OAAS,UACvB,MAAU,MAAM,EAAc,SAElC,OAAO,EAAc,MAEzB,EAAO,MAAM,YACb,IAGE,EAAO,EAAU,OAAO,IAAK,IAAU,CACzC,MAAO,EAAK,QACZ,OAAQ,EAAK,SAAS,SACtB,SAAU,CAAC,EAAY,OACvB,KAAM,GAAG,EAAW,sBAAsB,EAAK,SAC/C,OAAQ,EAAK,UAGX,EAAQ,MAAM,QAAQ,IAAI,EAAK,IAAK,GAAS,EAAQ,EAAMD,EAAM,UAEvE,MAAO,CACH,MAAO,EAAY,MACnB,YAAa,GAAG,EAAY,UAAU,MAAM,EAAY,YAAY,KACpE,KAAM,GAAG,EAAW,0BAA0B,IAC9C,MAAO,EAAY,YACnB,KAAM"}