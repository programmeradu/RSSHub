{"version":3,"file":"usersheets-DkMezaWX.js","names":[],"sources":["../../lib/routes/mymusicsheet/usersheets.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/user/sheets/:username/:iso?/:freeOnly?',\r\n    categories: ['shopping'],\r\n    example: '/mymusicsheet/user/sheets/HalcyonMusic/USD/1',\r\n    parameters: { username: '用户名，可在URL中找到', iso: '用于显示价格的ISO 4217货币代码, 支持常见代码, 默认为人民币, 即`CNY`', freeOnly: '只返回免费谱, 任意值为开启' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['mymusicsheet.com/:username/*', 'mymusicsheet.com/:username'],\r\n            target: '/user/sheets/:username',\r\n        },\r\n    ],\r\n    name: 'User Sheets',\r\n    maintainers: ['Freddd13'],\r\n    handler,\r\n    description: `关于 ISO 4217，请参考[维基百科](https://zh.wikipedia.org/zh-cn/ISO_4217#%E7%8E%B0%E8%A1%8C%E4%BB%A3%E7%A0%81)`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const baseUrl = 'https://www.mymusicsheet.com';\r\n    const graphqlUrl = 'https://mms.pd.mapia.io/mms/graphql';\r\n    const exchangeRateUrl = 'https://payport.pd.mapia.io/v2/currency';\r\n    const { username, iso = 'CNY', freeOnly } = ctx.req.param();\r\n\r\n    const exchangeRateResponse = await got(exchangeRateUrl, {\r\n        searchParams: {\r\n            serviceProvider: 'mms',\r\n            'ngsw-bypass': true,\r\n            'no-cache': Date.now(),\r\n            skipHeaders: true,\r\n        },\r\n        responseType: 'json',\r\n    });\r\n    const rates = exchangeRateResponse.data;\r\n\r\n    const response = await got.post(graphqlUrl, {\r\n        json: {\r\n            operationName: 'loadArtistSheets',\r\n            query: `\r\n          query loadArtistSheets($data: SheetSearchInput!) {\r\n            sheetSearch(data: $data) {\r\n              list {\r\n                productId\r\n                productType\r\n                metaSong\r\n                metaMaker\r\n                metaMusician\r\n                metaMemo\r\n                instruments\r\n                level\r\n                price\r\n                sheetId\r\n                status\r\n                author {\r\n                  name\r\n                  artistUrl\r\n                  profileUrl\r\n                }\r\n                youtubeId\r\n                title\r\n                supportCountry\r\n                excludeCountries\r\n                __typename\r\n              }\r\n              total\r\n              current\r\n              listNum\r\n            }\r\n          }`,\r\n            variables: {\r\n                data: {\r\n                    listNum: 10,\r\n                    paginate: 'page',\r\n                    includeChord: null,\r\n                    includeLyrics: null,\r\n                    page: 1,\r\n                    level: null,\r\n                    instruments: [],\r\n                    orderBy: {\r\n                        createdAt: 'DESC',\r\n                    },\r\n                    isFree: Boolean(freeOnly),\r\n                    category: null,\r\n                    artistUrl: username,\r\n                    aggregationKeywords: ['PACKAGE_IDS', 'TAG_IDS', 'INSTRUMENTS', 'SHEET_TYPE', 'INCLUDE_CHORD', 'INCLUDE_LYRICS', 'INSTRUMENTATION', 'LEVEL', 'CATEGORY'],\r\n                    aggregationKeySize: 20,\r\n                },\r\n            },\r\n        },\r\n        responseType: 'json',\r\n    });\r\n\r\n    const sheetSearch = response.data.data.sheetSearch.list;\r\n    const items = sheetSearch.map((item) => {\r\n        let finalPrice = 'Unknown';\r\n        const price = Number.parseFloat(item.price);\r\n\r\n        if (item.price === 0) {\r\n            finalPrice = 'Free';\r\n        } else if (!Number.isNaN(price) && Number.isFinite(price)) {\r\n            const rate = rates[iso];\r\n            if (rate) {\r\n                finalPrice = `${(price * rate).toFixed(2)} ${iso}`;\r\n            }\r\n        }\r\n\r\n        const youtubeId = item.youtubeId;\r\n        const content = {\r\n            musicName: item.metaSong,\r\n            musicMemo: item.metaMemo,\r\n            musicianName: item.metaMusician,\r\n            author: item.author.name,\r\n            instruments: item.instruments,\r\n            status: item.status,\r\n            price: finalPrice,\r\n        };\r\n\r\n        return {\r\n            title: `${item.author.name} | ${item.title} | ${finalPrice}`,\r\n            link: `${baseUrl}/${username}/${item.sheetId}`,\r\n            itunes_item_image: item.author.profileUrl,\r\n            description: art(path.join(__dirname, 'templates/description.art'), {\r\n                youtubeId,\r\n                content,\r\n            }),\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `${username}'s sheets`,\r\n        link: `https://www.mymusicsheet.com/${username}?viewType=sheet&orderBy=createdAt`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"gVAMA,MAAa,EAAe,CACxB,KAAM,0CACN,WAAY,CAAC,YACb,QAAS,+CACT,WAAY,CAAE,SAAU,eAAgB,IAAK,8CAA+C,SAAU,kBACtG,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,+BAAgC,8BACzC,OAAQ,2BAGhB,KAAM,cACN,YAAa,CAAC,YACd,UACA,YAAa,uGAGjB,eAAe,EAAQ,EAAK,CACxB,GAGM,CAAE,WAAU,MAAM,MAAO,YAAa,EAAI,IAAI,QAE9C,EAAuB,MAAM,EAAI,0CAAiB,CACpD,aAAc,CACV,gBAAiB,MACjB,cAAe,GACf,WAAY,KAAK,MACjB,YAAa,IAEjB,aAAc,SAEZ,EAAQ,EAAqB,KAE7B,EAAW,MAAM,EAAI,KAAK,sCAAY,CACxC,KAAM,CACF,cAAe,mBACf,MAAO;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;aA+BP,UAAW,CACP,KAAM,CACF,QAAS,GACT,SAAU,OACV,aAAc,KACd,cAAe,KACf,KAAM,EACN,MAAO,KACP,YAAa,GACb,QAAS,CACL,UAAW,QAEf,OAAQ,EAAQ,EAChB,SAAU,KACV,UAAW,EACX,oBAAqB,CAAC,cAAe,UAAW,cAAe,aAAc,gBAAiB,iBAAkB,kBAAmB,QAAS,YAC5I,mBAAoB,MAIhC,aAAc,SAGZ,EAAc,EAAS,KAAK,KAAK,YAAY,KAC7C,EAAQ,EAAY,IAAK,GAAS,CACpC,IAAI,EAAa,UACX,EAAQ,OAAO,WAAW,EAAK,OAErC,GAAI,EAAK,QAAU,EACf,EAAa,eACN,CAAC,OAAO,MAAM,IAAU,OAAO,SAAS,GAAQ,CACvD,IAAM,EAAO,EAAM,GACf,IACA,EAAa,IAAI,EAAQ,GAAM,QAAQ,GAAG,GAAG,KAIrD,IAAM,EAAY,EAAK,UACjB,EAAU,CACZ,UAAW,EAAK,SAChB,UAAW,EAAK,SAChB,aAAc,EAAK,aACnB,OAAQ,EAAK,OAAO,KACpB,YAAa,EAAK,YAClB,OAAQ,EAAK,OACb,MAAO,GAGX,MAAO,CACH,MAAO,GAAG,EAAK,OAAO,KAAK,KAAK,EAAK,MAAM,KAAK,IAChD,KAAM,gCAAc,EAAS,GAAG,EAAK,UACrC,kBAAmB,EAAK,OAAO,WAC/B,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,YACA,eAKZ,MAAO,CACH,MAAO,GAAG,EAAS,WACnB,KAAM,gCAAgC,EAAS,mCAC/C,KAAM"}