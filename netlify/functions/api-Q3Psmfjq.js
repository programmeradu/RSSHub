import{config as e}from"./config-Dl8a1sIg.js";import{logger_default as t}from"./logger-CWOoofbD.js";import{proxy_default as n}from"./proxy-D7ccvALx.js";import{cache_default as r}from"./cache-kimkMTWJ.js";import{ofetch_default as i}from"./ofetch-Bzt0BXUH.js";import{got_default as a}from"./got-CdvI2yKX.js";import{invalid_parameter_default as o}from"./invalid-parameter-CUJdROXf.js";import{config_not_found_default as s}from"./config-not-found-BVqhRP9D.js";import{puppeteer_default as c}from"./puppeteer-f0D6AISB.js";import{ProxyAgent as l}from"undici";import{RateLimiterMemory as u,RateLimiterQueue as d,RateLimiterRedis as f}from"rate-limiter-flexible";import p from"node:crypto";import m from"crypto-js";import{Cookie as ee,CookieJar as h}from"tough-cookie";import g from"query-string";import{v5 as _}from"uuid";import te from"oauth-1.0a";import{authenticator as v}from"otplib";import{CookieAgent as y,CookieClient as b}from"http-cookie-agent/undici";const x=`https://api.x.com`,ne=[`/graphql/u7wQyGi6oExe8_TRWGMq4Q/UserResultByScreenNameQuery`,`/graphql/oPppcargziU1uDQHAUmH-A/UserResultByIdQuery`,`/graphql/3JNH4e9dq1BifLxAa3UMWg/UserWithProfileTweetsQueryV2`,`/graphql/8IS8MaO-2EN6GZZZb8jF0g/UserWithProfileTweetsAndRepliesQueryV2`,`/graphql/PDfFf8hGeJvUCiTyWtw4wQ/MediaTimelineV2`,`/graphql/q94uRCEn65LZThakYcPT6g/TweetDetail`,`/graphql/sITyJdhRPpvpEjg4waUmTA/TweetResultByIdQuery`,`/graphql/gkjsKepM6gl_HmFWoWKfgg/SearchTimeline`,`/graphql/iTpgCtbdxrsJfyx0cFjHqg/ListByRestId`,`/graphql/-kmqNvm5Y-cVrfvBy6docg/ListBySlug`,`/graphql/P4NpVZDqUD_7MEM84L-8nw/ListMembers`,`/graphql/BbGLL1ZfMibdFNWlk7a0Pw/ListTimeline`],S=Object.fromEntries(ne.map(e=>[e.split(`/`)[3].replace(/V2$|Query$|QueryV2$/,``),e])),C=JSON.stringify({android_graphql_skip_api_media_color_palette:!1,blue_business_profile_image_shape_enabled:!1,creator_subscriptions_subscription_count_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,freedom_of_speech_not_reach_fetch_enabled:!1,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!1,hidden_profile_likes_enabled:!1,highlights_tweets_tab_ui_enabled:!1,interactive_text_enabled:!1,longform_notetweets_consumption_enabled:!0,longform_notetweets_inline_media_enabled:!1,longform_notetweets_richtext_consumption_enabled:!0,longform_notetweets_rich_text_read_enabled:!1,responsive_web_edit_tweet_api_enabled:!1,responsive_web_enhance_cards_enabled:!1,responsive_web_graphql_exclude_directive_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,responsive_web_graphql_timeline_navigation_enabled:!1,responsive_web_media_download_video_enabled:!1,responsive_web_text_conversations_enabled:!1,responsive_web_twitter_article_tweet_consumption_enabled:!1,responsive_web_twitter_blue_verified_badge_is_enabled:!0,rweb_lists_timeline_redesign_enabled:!0,spaces_2022_h2_clipping:!0,spaces_2022_h2_spaces_communities:!0,standardized_nudges_misinfo:!1,subscriptions_verification_info_enabled:!0,subscriptions_verification_info_reason_enabled:!0,subscriptions_verification_info_verified_since_enabled:!0,super_follow_badge_privacy_enabled:!1,super_follow_exclusive_tweet_notifications_enabled:!1,super_follow_tweet_api_enabled:!1,super_follow_user_api_enabled:!1,tweet_awards_web_tipping_enabled:!1,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!1,tweetypie_unmention_optimization_enabled:!1,unified_cards_ad_metadata_container_dynamic_card_content_query_enabled:!1,verified_phone_label_enabled:!1,vibe_api_enabled:!1,view_counts_everywhere_api_enabled:!1}),w=`Bearer AAAAAAAAAAAAAAAAAAAAAFXzAwAAAAAAMHCxpeSDG1gLNLghVe8d74hl6k4%3DRUMF4xAQLsbeBhTSRrCiQpJtxoGWeyHrDb5te2jpGskWDFW82F`;x+``;const T=`https://api.x.com/1.1/onboarding/task.json`,E={"User-Agent":`TwitterAndroid/10.21.0-release.0 (310210000-r-0) ONEPLUS+A3010/9 (OnePlus;ONEPLUS+A3010;OnePlus;OnePlus3;0;;1;2016)`,"X-Twitter-API-Version":`5`,"X-Twitter-Client":`TwitterAndroid`,"X-Twitter-Client-Version":`10.21.0-release.0`,"OS-Version":`28`,"System-User-Agent":`Dalvik/2.1.0 (Linux; U; Android 9; ONEPLUS A3010 Build/PKQ1.181203.001)`,"X-Twitter-Active-User":`yes`,"Content-Type":`application/json`,Authorization:w},re=r.clients.redisClient?new f({points:1,duration:20,execEvenly:!0,storeClient:r.clients.redisClient}):new u({points:1,duration:20,execEvenly:!0}),ie=new d(re),D=async(e,t,n)=>await a.post(T,{headers:E,json:{flow_token:e,subtask_inputs:[Object.assign({subtask_id:t},n)]}}),O={async LoginEnterUserIdentifier({flowToken:e,username:t}){return await D(e,`LoginEnterUserIdentifier`,{enter_text:{suggestion_id:null,text:t,link:`next_link`}})},async LoginEnterPassword({flowToken:e,password:t}){return await D(e,`LoginEnterPassword`,{enter_password:{password:t,link:`next_link`}})},async LoginEnterAlternateIdentifierSubtask({flowToken:e,phoneOrEmail:t}){return await D(e,`LoginEnterAlternateIdentifierSubtask`,{enter_text:{suggestion_id:null,text:t,link:`next_link`}})},async AccountDuplicationCheck({flowToken:e}){return await D(e,`AccountDuplicationCheck`,{check_logged_in_account:{link:`AccountDuplicationCheck_false`}})},async LoginTwoFactorAuthChallenge({flowToken:e,authenticationSecret:t}){let n=v.generate(t);return await D(e,`LoginTwoFactorAuthChallenge`,{enter_text:{suggestion_id:null,text:n,link:`next_link`}})}};async function ae({username:e,password:n,authenticationSecret:o,phoneOrEmail:s}){return await r.tryGet(`twitter:authentication:${e}`,async()=>{try{await ie.removeTokens(1),t.debug(`Twitter login start.`),E[`X-Twitter-Client-DeviceID`]=_(e,`d41d092b-b007-48f7-9129-e9538d2d8fe9`);let r=p.randomUUID().replaceAll(`-`,``),c=await a(`https://api.x.com/1.1/guest/activate.json`,{headers:{authorization:w,"x-csrf-token":r,cookie:`ct0=`+r},method:`POST`});t.debug(`Twitter login: guest token`),E[`x-guest-token`]=c.data.guest_token;let l=await i.raw(T+`?`+new URLSearchParams({flow_name:`login`,api_version:`1`,known_device_token:``,sim_country_code:`us`}).toString(),{method:`POST`,headers:E,body:{flow_token:null,input_flow_data:{country_code:null,flow_context:{referrer_context:{referral_details:`utm_source=google-play&utm_medium=organic`,referrer_url:``},start_location:{location:`deeplink`}},requested_variant:null,target_user_id:0}}}).then(({headers:e,_data:t})=>(E.att=e.get(`att`),{data:t}));t.debug(`Twitter login flow start.`);let u=async({data:r})=>{let{subtask_id:i,open_account:a}=r.subtasks.shift();if(a)return a;if(!(i in O)){t.error(`Twitter login flow task failed: unknown subtask: ${i}`);return}return l=await O[i]({flowToken:r.flow_token,username:e,password:n,authenticationSecret:o,phoneOrEmail:s}),t.debug(`Twitter login flow task finished: subtask: ${i}.`),await u(l)},d=await u(l);return t.debug(`Twitter login flow finished.`),d?t.debug(`Twitter login success.`,d):t.error(`Twitter login failed. ${JSON.stringify(l.data?.subtasks,null,2)}`),d}catch(n){t.error(`Twitter username ${e} login failed:`,n)}},3600*24*30,!1)}var oe=ae;let se=0;async function ce(){let t;if(e.twitter.username&&e.twitter.password){let n=se++%e.twitter.username.length,r=e.twitter.username[n],i=e.twitter.password[n],a=e.twitter.authenticationSecret?.[n],o=e.twitter.phoneOrEmail?.[n];if(r&&i){let e=await oe({username:r,password:i,authenticationSecret:a,phoneOrEmail:o});if(!e)throw new s(`Invalid twitter configs: ${r}`);t={key:e.oauth_token,secret:e.oauth_token_secret,cacheKey:`twitter:authentication:${r}`}}}else throw new s(`Invalid twitter configs`);return t}const k=async(e,t)=>{let n=await ce(),a=new te({consumer:{key:`3nVuSoBZnx6U4vzUxf5w`,secret:`Bcs59EFbbsdF6Sl9Ng71smgStWEGwXXKSjYvPVt7qys`},signature_method:`HMAC-SHA1`,hash_function:(e,t)=>m.HmacSHA1(e,t).toString(m.enc.Base64)}),o={url:`${e}?${g.stringify(t)}`,method:`GET`,headers:{connection:`keep-alive`,"content-type":`application/json`,"x-twitter-active-user":`yes`,authority:`api.x.com`,"accept-encoding":`gzip`,"accept-language":`en-US,en;q=0.9`,accept:`*/*`,DNT:`1`}},s=await i.raw(o.url,{headers:a.toHeader(a.authorize(o,n))});return s.status===401&&r.globalCache.set(n.cacheKey,``),s._data},A=async(e,t,n,r)=>{let{data:i}=await k(x+e,{variables:JSON.stringify({...n,rest_id:t}),features:C}),a;if(r){a=i;for(let e of r)a=a[e];a=a.instructions}else a=i.user_result.result.timeline_response.timeline.instructions;return a.find(e=>e.__typename===`TimelineAddEntries`||e.type===`TimelineAddEntries`).entries},le=(e,t={})=>A(S.UserWithProfileTweets,e,{...t,withQuickPromoteEligibilityTweetFields:!0}),ue=(e,t={})=>A(S.UserWithProfileTweetsAndReplies,e,{...t,count:20}),de=(e,t={})=>A(S.MediaTimeline,e,t),fe=(e,t={})=>A(S.SearchTimeline,null,{...t,rawQuery:e,count:20,product:`Latest`,withDownvotePerspective:!1,withReactionsMetadata:!1,withReactionsPerspective:!1},[`search_by_raw_query`,`search_timeline`,`timeline`]),pe=(e,t)=>A(S.TweetDetail,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0},[`threaded_conversation_with_injections_v2`]),me=(e,t={})=>A(S.ListTimeline,e,{...t},[`list`,`timeline_response`,`timeline`]);function j(e,t,n){let r=[],i=[];for(let n of e){let e=n.entryId;e&&(e.startsWith(`tweet-`)&&i.push(n),t&&t.some(t=>e.startsWith(t))&&i.push(...n.content.items))}for(let e of i)if(e.entryId){let t=e.content||e.item,i=t?.content?.tweetResult?.result||t?.itemContent?.tweet_results?.result;if(i&&i.tweet&&(i=i.tweet),i){let e=i.legacy?.retweeted_status_result?.result;for(let t of[i,e]){if(!t?.legacy)continue;t.legacy.user=t.core?.user_result?.result?.legacy||t.core?.user_results?.result?.legacy,t.legacy.id_str=t.rest_id;let e=t.quoted_status_result?.result;if(e&&(t.legacy.quoted_status=e.legacy,t.legacy.quoted_status.user=e.core.user_result?.result?.legacy||e.core.user_results?.result?.legacy),t.note_tweet){let e=t.note_tweet.note_tweet_results.result;t.legacy.entities.hashtags=e.entity_set.hashtags,t.legacy.entities.symbols=e.entity_set.symbols,t.legacy.entities.urls=e.entity_set.urls,t.legacy.entities.user_mentions=e.entity_set.user_mentions,t.legacy.full_text=e.text}}let t=i.legacy;t&&(e&&(t.retweeted_status=e.legacy),(n===void 0||t.user_id_str===n+``)&&r.push(t))}}return r}const he=async(e,t={})=>j(await le(e,t)),ge=async(e,t={})=>j(await ue(e,t),[`profile-conversation-`],e),_e=async(e,t={})=>j(await de(e,t)),ve=async(e,t={})=>j(await pe(e,t),[`homeConversation-`,`conversationthread-`]),ye=async(e,t={})=>j(await me(e,t)),be=function(e){let t=[];for(let n of e){if(n.retweeted_status)continue;t.push(n)}return t},xe=e=>k(`${x}${S.UserResultByScreenName}`,{variables:`{"screen_name":"${e}","withHighlightedLabel":true}`,features:C}),M=e=>k(`${x}${S.UserByRestId}`,{variables:`{"userId":"${e}","withHighlightedLabel":true}`,features:C}),Se=e=>e.startsWith(`+`)?M(e.slice(1)):xe(e),N=e=>r.tryGet(`twitter-userdata-${e}`,()=>Se(e)),P=async e=>{let t=await N(e);return(t.data?.user||t.data?.user_result)?.result?.rest_id},Ce=async e=>{let t=await N(e);return(t.data?.user||t.data?.user_result)?.result?.legacy},F=async(t,n,i)=>{let a=await P(t);if(a===void 0)throw new o(`User not found`);let s=i.name,c=JSON.stringify(n);return r.tryGet(`twitter:${a}:${s}:${c}`,()=>i(a,n),e.cache.routeExpire,!1)},we=(e,t={})=>F(e,t,he),Te=async(e,n={})=>{let i=[],a=await P(e);await Promise.all([we,I,L].map(async r=>{try{i.push(...await r(e,n))}catch(n){t.warn(`Failed to get tweets for ${e} with ${r.name}: ${n}`)}}));let o=`twitter:user:tweets-cache:${a}`,s=await r.get(o);s&&(s=JSON.parse(s),s&&s.length&&(i=[...s,...i]));let c=new Set;return i=i.filter(e=>!e.in_reply_to_user_id_str||e.in_reply_to_user_id_str===a).map(e=>{let t=e.id_str||e.conversation_id_str;return!c.has(t)&&c.add(t)&&e}).filter(Boolean).sort((e,t)=>(t.id_str||t.conversation_id_str)-(e.id_str||e.conversation_id_str)).slice(0,20),r.set(o,JSON.stringify(i)),i},I=(e,t={})=>F(e,t,ge),L=(e,t={})=>F(e,t,_e),Ee=(e,t)=>F(e,t,ve),De=async(e,t={})=>j(await fe(e,t)),Oe=(t,n={})=>r.tryGet(`twitter:${t}:getListById:${JSON.stringify(n)}`,()=>ye(t,n),e.cache.routeExpire,!1);var ke={getUser:Ce,getUserTweets:Te,getUserTweetsAndReplies:I,getUserMedia:L,excludeRetweet:be,getSearch:De,getList:Oe,getUserTweet:Ee,init:()=>void 0};const R=`https://x.com/i/api`,Ae=[`/graphql/E3opETHurmVJflFsUBVuUQ/UserTweets`,`/graphql/Yka-W8dz7RaEuQNkroPkYw/UserByScreenName`,`/graphql/HJFjzBgCs16TqxewQOeLNg/HomeTimeline`,`/graphql/DiTkXJgLqBBxCs7zaYsbtA/HomeLatestTimeline`,`/graphql/bt4TKuFz4T7Ckk-VvQVSow/UserTweetsAndReplies`,`/graphql/dexO_2tohK86JDudXXG3Yw/UserMedia`,`/graphql/Qw77dDjp9xCpUY-AXwt-yQ/UserByRestId`,`/graphql/UN1i3zUiCWa-6r-Uaho4fw/SearchTimeline`,`/graphql/Pa45JvqZuKcW1plybfgBlQ/ListLatestTweetsTimeline`,`/graphql/QuBlQ6SxNAQCt6-kBiCXCQ/TweetDetail`],z=Object.fromEntries(Ae.map(e=>[e.split(`/`)[3].replace(/V2$|Query$|QueryV2$/,``),e])),je=[`UserByScreenName`,`UserByRestId`,`UserTweets`,`UserTweetsAndReplies`,`ListLatestTweetsTimeline`,`SearchTimeline`],B={hidden_profile_subscriptions_enabled:!0,rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,subscriptions_verification_info_is_identity_verified_enabled:!0,subscriptions_verification_info_verified_since_enabled:!0,highlights_tweets_tab_ui_enabled:!0,responsive_web_twitter_article_notes_tab_enabled:!0,subscriptions_feature_can_gift_premium:!0,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,responsive_web_graphql_timeline_navigation_enabled:!0},V={rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_timeline_navigation_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,communities_web_enable_tweet_community_results_fetch:!0,c9s_tweet_anatomy_moderator_badge_enabled:!0,articles_preview_enabled:!0,responsive_web_edit_tweet_api_enabled:!0,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!0,view_counts_everywhere_api_enabled:!0,longform_notetweets_consumption_enabled:!0,responsive_web_twitter_article_tweet_consumption_enabled:!0,tweet_awards_web_tipping_enabled:!1,creator_subscriptions_quote_tweet_preview_enabled:!1,freedom_of_speech_not_reach_fetch_enabled:!0,standardized_nudges_misinfo:!0,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!0,rweb_video_timestamps_enabled:!0,longform_notetweets_rich_text_read_enabled:!0,longform_notetweets_inline_media_enabled:!0,responsive_web_enhance_cards_enabled:!1},H={rweb_tipjar_consumption_enabled:!0,responsive_web_graphql_exclude_directive_enabled:!0,verified_phone_label_enabled:!1,creator_subscriptions_tweet_preview_api_enabled:!0,responsive_web_graphql_timeline_navigation_enabled:!0,responsive_web_graphql_skip_user_profile_image_extensions_enabled:!1,communities_web_enable_tweet_community_results_fetch:!0,c9s_tweet_anatomy_moderator_badge_enabled:!0,articles_preview_enabled:!0,responsive_web_edit_tweet_api_enabled:!0,graphql_is_translatable_rweb_tweet_is_translatable_enabled:!0,view_counts_everywhere_api_enabled:!0,longform_notetweets_consumption_enabled:!0,responsive_web_twitter_article_tweet_consumption_enabled:!0,tweet_awards_web_tipping_enabled:!1,creator_subscriptions_quote_tweet_preview_enabled:!1,freedom_of_speech_not_reach_fetch_enabled:!0,standardized_nudges_misinfo:!0,tweet_with_visibility_results_prefer_gql_limited_actions_policy_enabled:!0,rweb_video_timestamps_enabled:!0,longform_notetweets_rich_text_read_enabled:!0,longform_notetweets_inline_media_enabled:!0,responsive_web_enhance_cards_enabled:!1},U={UserByScreenName:B,UserByRestId:B,UserTweets:V,UserTweetsAndReplies:V,UserMedia:V,SearchTimeline:V,ListLatestTweetsTimeline:V,HomeTimeline:V,HomeLatestTimeline:H,TweetDetail:H,Likes:V},Me=r.clients.redisClient?new f({points:1,duration:20,execEvenly:!0,storeClient:r.clients.redisClient}):new u({points:1,duration:20,execEvenly:!0}),Ne=new d(Me);async function Pe({username:e,password:n,authenticationSecret:r}){if(!(!e||!n))try{await Ne.removeTokens(1);let i=new h,a=await c(),o=await a.newPage();await o.goto(`https://x.com/i/flow/login`),await o.waitForSelector(`input[autocomplete="username"]`),await o.type(`input[autocomplete="username"]`,e);let s=await o.$$(`button`);if(await s[3]?.click(),await o.waitForSelector(`input[autocomplete="current-password"]`),await o.type(`input[autocomplete="current-password"]`,n),(await o.waitForSelector(`button[data-testid="LoginForm_Login_Button"]`))?.click(),r){await o.waitForSelector(`input[inputmode="numeric"]`);let e=v.generate(r);await o.type(`input[inputmode="numeric"]`,e),(await o.waitForSelector(`button[data-testid="ocfEnterTextNextButton"]`))?.click()}let l=new Promise(n=>{o.on(`response`,async r=>{if(r.url().includes(`/HomeTimeline`)){let a=await r.json(),s=a?.data?.home?.home_timeline_urt?.instructions?.[0]?.entries?.[0]?.entryId;s===`messageprompt-suspended-prompt`&&(t.error(`twitter debug: twitter username ${e} login failed: messageprompt-suspended-prompt`),n(``));let c=await o.cookies();for(let e of c)i.setCookieSync(`${e.name}=${e.value}`,`https://x.com`);t.debug(`twitter debug: twitter username ${e} login success`),n(JSON.stringify(i.serializeSync()))}})}),u=await l;return await a.close(),u}catch(n){t.error(`twitter debug: twitter username ${e} login failed:`,n)}}var W=Pe;let Fe=0;const Ie=async e=>{let t=await r.get(`twitter:cookie:${e}`);if(t)return t;let a=new h;await a.setCookie(`auth_token=${e}`,`https://x.com`);try{let t=n.proxyUri?new l({factory:(e,t)=>new b(e,{...t,cookies:{jar:a}}),uri:n.proxyUri}):new y({cookies:{jar:a}});if(e)await i(`https://x.com`,{dispatcher:t});else{let e=await i(`https://x.com/narendramodi?mx=2`,{dispatcher:t}),n=e.match(/document\.cookie="gt=(\d+)/)?.[1];n&&a.setCookieSync(`gt=${n}`,`https://x.com`)}let o=JSON.stringify(a.serializeSync());return r.set(`twitter:cookie:${e}`,o),o}catch{return``}},G=`twitter:lock-token1:`,K=async n=>{if(e.twitter.authToken&&n>0){let i=Fe++%e.twitter.authToken.length,a=e.twitter.authToken[i],o=await r.get(`${G}${a}`,!1);return o?(t.debug(`twitter debug: twitter cookie for token ${a} is locked, retry: ${n}`),await new Promise(e=>setTimeout(e,Math.random()*500+500)),await K(n-1)):(t.debug(`twitter debug: lock twitter cookie for token ${a}`),await r.set(`${G}${a}`,`1`,20),{token:a,username:e.twitter.username?.[i],password:e.twitter.password?.[i],authenticationSecret:e.twitter.authenticationSecret?.[i]})}},q=async(a,o,c)=>{let u=await K(30);if(!u&&!c?.allowNoAuth)throw new s(`No valid Twitter token found`);let d=`${a}?${g.stringify(o)}`,f=await Ie(u?.token);!f&&u&&(f=await W({username:u.username,password:u.password,authenticationSecret:u.authenticationSecret}));let p;if(f){t.debug(`twitter debug: got twitter cookie for token ${u?.token}`),typeof f==`string`&&(f=JSON.parse(f));let e=h.deserializeSync(f),r=n.proxyUri?new l({factory:(t,n)=>new b(t,{...n,cookies:{jar:e}}),uri:n.proxyUri}):new y({cookies:{jar:e}});n.proxyUri&&t.debug(`twitter debug: Proxying request: ${d}`),p={jar:e,agent:r}}else if(u)throw new s(`Twitter cookie for token ${u?.token?.replace(/(\w{8})(\w+)/,(e,t,n)=>t+`*`.repeat(n.length))} is not valid`);let m=p?Object.fromEntries(p.jar.getCookieStringSync(a).split(`;`).map(e=>ee.parse(e)?.toJSON()).map(e=>[e?.key,e?.value])):{},_=await i.raw(d,{retry:0,headers:{authority:`x.com`,accept:`*/*`,"accept-language":`en-US,en;q=0.9`,authorization:`Bearer AAAAAAAAAAAAAAAAAAAAANRILgAAAAAAnNwIzUejRCOuH5E6I8xnZz4puTs%3D1Zv7ttfk8LF81IUq16cHjhLTvJu4FA33AGWWjCpTnA`,"cache-control":`no-cache`,"content-type":`application/json`,dnt:`1`,pragma:`no-cache`,referer:`https://x.com/`,"x-twitter-active-user":`yes`,"x-twitter-client-language":`en`,"x-csrf-token":m.ct0,...u?.token?{"x-twitter-auth-type":`OAuth2Session`}:{"x-guest-token":m.gt}},dispatcher:p?.agent,onResponse:async({response:n})=>{let i=n.headers.get(`x-rate-limit-remaining`),a=Number.parseInt(i||`0`),o=n.headers.get(`x-rate-limit-reset`);if(t.debug(`twitter debug: twitter rate limit remaining for token ${u?.token} is ${i} and reset at ${o}, auth: ${JSON.stringify(u)}, status: ${n.status}, data: ${JSON.stringify(n._data?.data)}, cookie: ${JSON.stringify(p?.jar.serializeSync())}`),u)if(i&&a<2&&o){let e=new Date(Number.parseInt(o)*1e3),i=(e.getTime()-Date.now())/1e3;t.debug(`twitter debug: twitter rate limit exceeded for token ${u.token} with status ${n.status}, will unlock after ${i}s`),await r.set(`${G}${u.token}`,`1`,Math.ceil(i)*2)}else if(n.status===429||JSON.stringify(n._data?.data)===`{"user":{}}`)t.debug(`twitter debug: twitter rate limit exceeded for token ${u.token} with status ${n.status}`),await r.set(`${G}${u.token}`,`1`,2e3);else if(n.status===403||n.status===401){let i=await W({username:u.username,password:u.password,authenticationSecret:u.authenticationSecret});if(i)t.debug(`twitter debug: reset twitter cookie for token ${u.token}, ${i}`),await r.set(`twitter:cookie:${u.token}`,i,e.cache.contentExpire),t.debug(`twitter debug: unlock twitter cookie for token ${u.token} with error1`),await r.set(`${G}${u.token}`,``,1);else{let i=e.twitter.authToken?.indexOf(u.token);if(i!==void 0&&i!==-1&&e.twitter.authToken?.splice(i,1),u.username){let t=e.twitter.username?.indexOf(u.username);t!==void 0&&t!==-1&&e.twitter.username?.splice(t,1)}if(u.password){let t=e.twitter.password?.indexOf(u.password);t!==void 0&&t!==-1&&e.twitter.password?.splice(t,1)}t.debug(`twitter debug: delete twitter cookie for token ${u.token} with status ${n.status}, remaining tokens: ${e.twitter.authToken?.length}`),await r.set(`${G}${u.token}`,`1`,3600)}}else t.debug(`twitter debug: unlock twitter cookie with success for token ${u.token}`),await r.set(`${G}${u.token}`,``,1)}});return u?.token&&(t.debug(`twitter debug: update twitter cookie for token ${u.token}`),await r.set(`twitter:cookie:${u.token}`,JSON.stringify(p?.jar.serializeSync()),e.cache.contentExpire)),_._data},J=async(n,r,a,o)=>{let s={variables:JSON.stringify({...a,userId:r}),features:JSON.stringify(U[n])},c=async()=>{if(e.twitter.thirdPartyApi&&je.includes(n)){let{data:t}=await i(`${e.twitter.thirdPartyApi}${z[n]}`,{method:`GET`,params:s});return t}let{data:t}=await q(R+z[n],s);return t},l=e=>{if(o){let t=e;for(let e of o)t=t[e];return t.instructions}let n=e?.user?.result,r=n?.timeline?.timeline||n?.timeline?.timeline_v2||n?.timeline_v2?.timeline,i=r?.instructions;return i||t.debug(`twitter debug: instructions not found in data: ${JSON.stringify(e)}`),i},u=await c(),d=l(u);if(!d)return[];let f=d.find(e=>e.type===`TimelineAddToModule`)?.moduleItems,p=d.find(e=>e.type===`TimelineAddEntries`)?.entries;return f||p||[]};function Y(e,t,n){let r=[],i=[];for(let n of e){let e=n.entryId;e&&((e.startsWith(`tweet-`)||e.startsWith(`profile-grid-0-tweet-`))&&i.push(n),t&&t.some(t=>e.startsWith(t))&&i.push(...n.content.items))}for(let e of i)if(e.entryId){let t=e.content||e.item,i=t?.content?.tweetResult?.result||t?.itemContent?.tweet_results?.result;if(i&&i.tweet&&(i=i.tweet),i){let e=i.legacy?.retweeted_status_result?.result;for(let t of[i,e]){if(!t?.legacy)continue;if(t.legacy.user=t.core?.user_result?.result?.legacy||t.core?.user_results?.result?.legacy,t.legacy.user&&t.core?.user_results?.result?.core){let e=t.core.user_results.result.core;e.name&&(t.legacy.user.name=e.name),e.screen_name&&(t.legacy.user.screen_name=e.screen_name)}t.legacy.id_str=t.rest_id;let e=t.quoted_status_result?.result?.tweet||t.quoted_status_result?.result;if(e&&(t.legacy.quoted_status=e.legacy,t.legacy.quoted_status.user=e.core.user_result?.result?.legacy||e.core.user_results?.result?.legacy,t.legacy.quoted_status.user&&e.core?.user_results?.result?.core)){let n=e.core.user_results.result.core;n.name&&(t.legacy.quoted_status.user.name=n.name),n.screen_name&&(t.legacy.quoted_status.user.screen_name=n.screen_name)}if(t.note_tweet){let e=t.note_tweet.note_tweet_results.result;t.legacy.entities.hashtags=e.entity_set.hashtags,t.legacy.entities.symbols=e.entity_set.symbols,t.legacy.entities.urls=e.entity_set.urls,t.legacy.entities.user_mentions=e.entity_set.user_mentions,t.legacy.full_text=e.text}}let t=i.legacy;t&&(e&&(t.retweeted_status=e.legacy),(n===void 0||t.user_id_str===n+``)&&r.push(t))}}return r}const X=t=>r.tryGet(`twitter-userdata-${t}`,()=>{let n={variables:t.startsWith(`+`)?JSON.stringify({userId:t.slice(1),withSafetyModeUserFields:!0}):JSON.stringify({screen_name:t,withSafetyModeUserFields:!0}),features:JSON.stringify(t.startsWith(`+`)?U.UserByRestId:U.UserByScreenName),fieldToggles:JSON.stringify({withAuxiliaryUserLabels:!1})};if(e.twitter.thirdPartyApi){let r=t.startsWith(`+`)?z.UserByRestId:z.UserByScreenName;return i(`${e.twitter.thirdPartyApi}${r}`,{method:`GET`,params:n})}return q(`${R}${t.startsWith(`+`)?z.UserByRestId:z.UserByScreenName}`,n,{allowNoAuth:!t.startsWith(`+`)})}),Z=async(t,n,i)=>{let a=await X(t),s=(a.data?.user||a.data?.user_result)?.result?.rest_id;if(s===void 0)throw r.set(`twitter-userdata-${t}`,``,e.cache.contentExpire),new o(`User not found`);let c=i.name,l=JSON.stringify(n);return r.tryGet(`twitter:${s}:${c}:${l}`,()=>i(s,n),e.cache.routeExpire,!1)},Le=(e,t)=>Z(e,t,async(e,t={})=>Y(await J(`UserTweets`,e,{...t,count:20,includePromotedContent:!0,withQuickPromoteEligibilityTweetFields:!0,withVoice:!0,withV2Timeline:!0}))),Re=(e,t)=>Z(e,t,async(e,t={})=>Y(await J(`UserTweetsAndReplies`,e,{...t,count:20,includePromotedContent:!0,withCommunity:!0,withVoice:!0,withV2Timeline:!0}),[`profile-conversation-`],e)),ze=(e,t)=>Z(e,t,async(e,t={})=>{let n=await J(`UserMedia`,e,{...t,count:20,includePromotedContent:!1,withClientEventToken:!1,withBirdwatchNotes:!1,withVoice:!0,withV2Timeline:!0}),r=n.find(e=>e.content?.cursorType===`Top`).content.value;return Y(await J(`UserMedia`,e,{...t,cursor:r,count:20,includePromotedContent:!1,withClientEventToken:!1,withBirdwatchNotes:!1,withVoice:!0,withV2Timeline:!0}))}),Be=(e,t)=>Z(e,t,async(e,t={})=>Y(await J(`Likes`,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0}))),Ve=(e,t)=>Z(e,t,async(e,t={})=>Y(await J(`TweetDetail`,e,{...t,includeHasBirdwatchNotes:!1,includePromotedContent:!1,withBirdwatchNotes:!1,withVoice:!1,withV2Timeline:!0},[`threaded_conversation_with_injections_v2`]),[`homeConversation-`,`conversationthread-`])),Q=async(e,t)=>Y(await J(`SearchTimeline`,void 0,{...t,rawQuery:e,count:20,querySource:`typed_query`,product:`Latest`},[`search_by_raw_query`,`search_timeline`,`timeline`])),He=async(e,t)=>Y(await J(`ListLatestTweetsTimeline`,void 0,{...t,listId:e,count:20},[`list`,`tweets_timeline`,`timeline`])),Ue=async e=>{let t=await X(e);return(t.data?.user||t.data?.user_result)?.result?.legacy},We=async(e,t)=>Y(await J(`HomeTimeline`,void 0,{...t,count:20,includePromotedContent:!0,latestControlAvailable:!0,requestContext:`launch`,withCommunity:!0},[`home`,`home_timeline_urt`])),Ge=async(e,t)=>Y(await J(`HomeLatestTimeline`,void 0,{...t,count:20,includePromotedContent:!0,latestControlAvailable:!0,requestContext:`launch`,withCommunity:!0},[`home`,`home_timeline_urt`]));var Ke={getUser:Ue,getUserTweets:Le,getUserTweetsAndReplies:Re,getUserMedia:ze,getUserLikes:Be,getUserTweet:Ve,getSearch:Q,getList:He,getHomeTimeline:We,getHomeLatestTimeline:Ge,init:()=>{}};const qe=e.twitter.thirdPartyApi,Je=e.twitter.username&&e.twitter.password,Ye=e.twitter.authToken;let $={init:()=>{throw new s(`Twitter API is not configured`)},getUser:()=>null,getUserTweets:()=>null,getUserTweetsAndReplies:()=>null,getUserMedia:()=>null,getUserLikes:()=>null,getUserTweet:()=>null,getSearch:()=>null,getList:()=>null,getHomeTimeline:()=>null,getHomeLatestTimeline:()=>null};qe||Ye?$=Ke:Je&&($=ke);var Xe=$;export{Xe as api_default};
//# sourceMappingURL=api-Q3Psmfjq.js.map