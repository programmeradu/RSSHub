{"version":3,"file":"haowen-akvQXsKz.js","names":["route: Route","ConfigNotFoundError","ofetch","cache","response","$","outItem: DataItem"],"sources":["../../lib/routes/smzdm/haowen.ts"],"sourcesContent":["import { DataItem, Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { getHeaders } from './utils';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/haowen/:day?',\r\n    categories: ['shopping'],\r\n    example: '/smzdm/haowen/1',\r\n    parameters: {\r\n        day: {\r\n            description: '以天为时间跨度，默认为 `1`',\r\n            options: [\r\n                { value: '1', label: '今日热门' },\r\n                { value: '7', label: '周热门' },\r\n                { value: '30', label: '月热门' },\r\n            ],\r\n            default: '1',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'SMZDM_COOKIE',\r\n                description: '什么值得买登录后的 Cookie 值',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '好文',\r\n    maintainers: ['LogicJake', 'pseudoyu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.smzdm.cookie) {\r\n        throw new ConfigNotFoundError('什么值得买排行榜 is disabled due to the lack of SMZDM_COOKIE');\r\n    }\r\n\r\n    const day = ctx.req.param('day') ?? '1';\r\n    const link = `https://post.smzdm.com/hot_${day}/`;\r\n\r\n    const response = await ofetch(link, {\r\n        headers: getHeaders(),\r\n    });\r\n    const $ = load(response);\r\n    const title = $('li.filter-tab.active').text();\r\n\r\n    const list = $('li.feed-row-wide')\r\n        .toArray()\r\n        .map((item) => {\r\n            const $item = $(item);\r\n            return {\r\n                title: $item.find('h5.z-feed-title a').text(),\r\n                link: $item.find('h5.z-feed-title a').attr('href'),\r\n                pubDate: timezone(parseDate($item.find('span.z-publish-time').text()), 8),\r\n            };\r\n        });\r\n\r\n    const out = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link ?? '', async () => {\r\n                const response = await ofetch(item.link ?? '', {\r\n                    headers: getHeaders(),\r\n                });\r\n                const $ = load(response);\r\n                const content = $('#articleId');\r\n                content.find('.item-name').remove();\r\n                content.find('.recommend-tab').remove();\r\n\r\n                const releaseDate = $('meta[property=\"og:release_date\"]').attr('content');\r\n\r\n                const outItem: DataItem = {\r\n                    title: item.title,\r\n                    link: item.link,\r\n                    description: content.html() || '',\r\n                    pubDate: releaseDate ? timezone(parseDate(releaseDate), 8) : item.pubDate,\r\n                    author: $('meta[property=\"og:author\"]').attr('content') || '',\r\n                };\r\n\r\n                return outItem;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${title}-什么值得买好文`,\r\n        link,\r\n        item: out.filter((item): item is DataItem => item !== null),\r\n    };\r\n}\r\n"],"mappings":"ifAUA,MAAaA,EAAe,CACxB,KAAM,gBACN,WAAY,CAAC,YACb,QAAS,kBACT,WAAY,CACR,IAAK,CACD,YAAa,kBACb,QAAS,CACL,CAAE,MAAO,IAAK,MAAO,QACrB,CAAE,MAAO,IAAK,MAAO,OACrB,CAAE,MAAO,KAAM,MAAO,QAE1B,QAAS,MAGjB,SAAU,CACN,cAAe,CACX,CACI,KAAM,eACN,YAAa,uBAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,YAAa,YAC3B,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,MAAM,OACd,MAAM,IAAIC,EAAoB,wDAGlC,IAAM,EAAM,EAAI,IAAI,MAAM,QAAU,IAC9B,EAAO,8BAA8B,EAAI,GAEzC,EAAW,MAAMC,EAAO,EAAM,CAChC,QAAS,MAEP,EAAI,EAAK,GACT,EAAQ,EAAE,wBAAwB,OAElC,EAAO,EAAE,oBACV,UACA,IAAK,GAAS,CACX,IAAM,EAAQ,EAAE,GAChB,MAAO,CACH,MAAO,EAAM,KAAK,qBAAqB,OACvC,KAAM,EAAM,KAAK,qBAAqB,KAAK,QAC3C,QAAS,EAAS,EAAU,EAAM,KAAK,uBAAuB,QAAS,MAI7E,EAAM,MAAM,QAAQ,IACtB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,MAAQ,GAAI,SAAY,CACtC,IAAMC,EAAW,MAAMF,EAAO,EAAK,MAAQ,GAAI,CAC3C,QAAS,MAEPG,EAAI,EAAKD,GACT,EAAUC,EAAE,cAClB,EAAQ,KAAK,cAAc,SAC3B,EAAQ,KAAK,kBAAkB,SAE/B,IAAM,EAAcA,EAAE,oCAAoC,KAAK,WAEzDC,EAAoB,CACtB,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,YAAa,EAAQ,QAAU,GAC/B,QAAS,EAAc,EAAS,EAAU,GAAc,GAAK,EAAK,QAClE,OAAQD,EAAE,8BAA8B,KAAK,YAAc,IAG/D,OAAO,MAKnB,MAAO,CACH,MAAO,GAAG,EAAM,UAChB,OACA,KAAM,EAAI,OAAQ,GAA2B,IAAS"}