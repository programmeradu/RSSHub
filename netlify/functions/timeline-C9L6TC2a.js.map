{"version":3,"file":"timeline-C9L6TC2a.js","names":["route: Route","ConfigNotFoundError","out: DataItem[]","cache","got"],"sources":["../../lib/routes/xueqiu/timeline.ts"],"sourcesContent":["import { DataItem, Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport cache from '@/utils/cache';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nconst rootUrl = 'https://xueqiu.com';\r\nexport const route: Route = {\r\n    path: '/timeline/:usergroup_id?',\r\n    categories: ['finance'],\r\n    example: '/xueqiu/timeline/',\r\n    parameters: { usergroup_id: '用户组 ID，-1 为全部关注用户' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'XUEQIU_COOKIES',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '用户关注时间线',\r\n    maintainers: ['ErnestDong'],\r\n    handler,\r\n    description: `::: warning\r\n  用户关注动态需要登录后的 Cookie 值，所以只能自建，详情见部署页面的配置模块。\r\n:::\r\n\r\n| -1   | -2       | 1             |\r\n| ---- | -------- | ------------- |\r\n| 全部 | 关注精选 | 自定义第 1 组 |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const cookie = config.xueqiu.cookies;\r\n    const limit = ctx.req.query('limit') || 15;\r\n    const usergroup_id = ctx.req.param('usergroup_id') ?? -1;\r\n    if (cookie === undefined) {\r\n        throw new ConfigNotFoundError('缺少雪球用户登录后的 Cookie 值');\r\n    }\r\n    let out: DataItem[] = [];\r\n    let max_id = -1;\r\n\r\n    async function fetchItems() {\r\n        const data = await fetchNextID(max_id, cookie as string, usergroup_id);\r\n        const items = await Promise.all(\r\n            data.home_timeline.map((item) =>\r\n                cache.tryGet(item.target, async () => {\r\n                    const retweetedStatus = item.retweeted_status ? `<blockquote>${item.retweeted_status.user.screen_name}:&nbsp;${item.retweeted_status.description}</blockquote>` : '';\r\n                    const description = item.description + retweetedStatus;\r\n                    const result = await Promise.resolve({\r\n                        title: item.title === '' ? item.user.screen_name + (item.retweeted_status ? ' 转发' : '') : item.title,\r\n                        description: item.text ? item.text + retweetedStatus : description,\r\n                        pubDate: parseDate(item.created_at),\r\n                        link: rootUrl + item.target,\r\n                    });\r\n                    return result;\r\n                })\r\n            )\r\n        );\r\n        out = [...out, ...items];\r\n        max_id = data.next_max_id;\r\n\r\n        if (out.length < limit) {\r\n            await fetchItems();\r\n        }\r\n    }\r\n\r\n    await fetchItems();\r\n\r\n    return {\r\n        title: '雪球关注动态',\r\n        link: 'https://xueqiu.com/',\r\n        item: out,\r\n    };\r\n}\r\nasync function fetchNextID(max_id: number, cookie: string, usergroup_id = -1) {\r\n    let url = `https://xueqiu.com/v4/statuses/system/home_timeline.json?source=user&usergroup_id=${usergroup_id}`;\r\n    if (max_id > 0) {\r\n        url += `&max_id=${max_id}`;\r\n    }\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n        headers: {\r\n            Cookie: cookie,\r\n        },\r\n    });\r\n    return response.data;\r\n}\r\n"],"mappings":"oaAMA,MACaA,EAAe,CACxB,KAAM,2BACN,WAAY,CAAC,WACb,QAAS,oBACT,WAAY,CAAE,aAAc,qBAC5B,SAAU,CACN,cAAe,CACX,CACI,KAAM,iBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,UACN,YAAa,CAAC,cACd,UACA,YAAa;;;;;;2BASjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAO,OAAO,QACvB,EAAQ,EAAI,IAAI,MAAM,UAAY,GAClC,EAAe,EAAI,IAAI,MAAM,iBAAmB,GACtD,GAAI,IAAW,IAAA,GACX,MAAM,IAAIC,EAAoB,uBAElC,IAAIC,EAAkB,GAClB,EAAS,GAEb,eAAe,GAAa,CACxB,IAAM,EAAO,MAAM,EAAY,EAAQ,EAAkB,GACnD,EAAQ,MAAM,QAAQ,IACxB,EAAK,cAAc,IAAK,GACpBC,EAAM,OAAO,EAAK,OAAQ,SAAY,CAClC,IAAM,EAAkB,EAAK,iBAAmB,eAAe,EAAK,iBAAiB,KAAK,YAAY,SAAS,EAAK,iBAAiB,YAAY,eAAiB,GAC5J,EAAc,EAAK,YAAc,EACjC,EAAS,MAAM,QAAQ,QAAQ,CACjC,MAAO,EAAK,QAAU,GAAK,EAAK,KAAK,aAAe,EAAK,iBAAmB,MAAQ,IAAM,EAAK,MAC/F,YAAa,EAAK,KAAO,EAAK,KAAO,EAAkB,EACvD,QAAS,EAAU,EAAK,YACxB,KAAM,qBAAU,EAAK,SAEzB,OAAO,MAInB,EAAM,CAAC,GAAG,EAAK,GAAG,GAClB,EAAS,EAAK,YAEV,EAAI,OAAS,GACb,MAAM,IAMd,OAFA,MAAM,IAEC,CACH,MAAO,SACP,KAAM,sBACN,KAAM,GAGd,eAAe,EAAY,EAAgB,EAAgB,EAAe,GAAI,CAC1E,IAAI,EAAM,qFAAqF,IAC3F,EAAS,IACT,GAAO,WAAW,KAEtB,IAAM,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,MACA,QAAS,CACL,OAAQ,KAGhB,OAAO,EAAS"}