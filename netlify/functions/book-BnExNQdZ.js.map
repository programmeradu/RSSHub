{"version":3,"file":"book-BnExNQdZ.js","names":["route: Route","got","cache","$","data"],"sources":["../../lib/routes/yuque/utils.ts","../../lib/routes/yuque/book.ts"],"sourcesContent":["const card2Html = (elem, link) => {\r\n    const name = elem.attr('name');\r\n    const data = elem.attr('value')?.split('data:')[1]?.replace('undefined', '');\r\n    const value = JSON.parse(decodeURIComponent(data || '[]'));\r\n    let html = '';\r\n    switch (name) {\r\n        case 'board':\r\n        case 'emoji':\r\n        case 'flowchart2':\r\n        case 'image':\r\n        case 'math':\r\n        case 'mindmap':\r\n        case 'puml':\r\n            html = `<img src='${value.src}'>`;\r\n            break;\r\n        case 'bookmarkInline':\r\n        case 'bookmarklink':\r\n        case 'yuqueinline':\r\n            html = `<a href='${value.src}'>${value.detail.title}</a>`;\r\n            break;\r\n        case 'checkbox':\r\n            html = `<input type='checkbox' ${value === true ? 'checked' : ''}>`;\r\n            break;\r\n        case 'codeblock':\r\n            html = `<code>${value.code.replaceAll('\\n', '<br>')}</code>`;\r\n            break;\r\n        case 'diagram':\r\n            html = `<img src='${value.url}'>`;\r\n            break;\r\n        case 'file':\r\n        case 'localdoc':\r\n            html = `<a href='${value.src}'>${value.name}</a>`;\r\n            break;\r\n        case 'hr':\r\n            html = '<hr>';\r\n            break;\r\n        case 'label':\r\n            html = `<b>${value.label}</b>`;\r\n            break;\r\n        case 'mention':\r\n            html = `<a href='https://www.yuque.com/${value.login}'>${value.name}</a>`;\r\n            break;\r\n        case 'table':\r\n            html = value.html;\r\n            break;\r\n        case 'thirdparty':\r\n        case 'youku':\r\n            // YES, youku name with bilibli iframe\r\n            // https://www.yuque.com/api/docs/nn5lyk?book_id=297292&include_contributors=true\r\n            if (elem.attr('alias') === 'music163') {\r\n                html = `<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" height=66 src=\"${value.src}\"></iframe>`;\r\n            } else if (elem.attr('alias') === 'bilibili' || elem.attr('alias') === undefined) {\r\n                html = `<iframe src=\"${value.src}&high_quality=1&autoplay=0\" width=\"650\" height=\"477\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"></iframe>`;\r\n            } else if (value.type === 'codepen') {\r\n                html = `<iframe height=\"265\" style=\"width: 100%;\" scrolling=\"no\" title=\"codepen\" src=\"${value.url}\" frameborder=\"no\" allowtransparency=\"true\" allowfullscreen=\"true\"></iframe>`;\r\n            } else {\r\n                throw new Error(`Unhandled thirdparty on ${link}: ${elem.attr('alias')}`);\r\n            }\r\n            break;\r\n        case 'yuque':\r\n            if (value.mode === 'card') {\r\n                html = `<a href='${value.src}'>${value.detail.title}</a>`;\r\n            } else if (value.mode === 'embed') {\r\n                html = `<iframe src=\"${value.url}\" width=\"100%\" height=\"518\"></iframe>`;\r\n            } else {\r\n                throw new Error(`Unhandled mode on ${link}: ${value.mode}`);\r\n            }\r\n            break;\r\n        case 'video':\r\n            // fake video src\r\n            html = `<video src='${value.videoId}'></video>`;\r\n            break;\r\n\r\n        default:\r\n            throw new Error(`Unhandled card on ${link}: ${name}`);\r\n    }\r\n    elem.replaceWith(html);\r\n};\r\n\r\nexport { card2Html };\r\n","import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { card2Html } from './utils';\r\nimport { CookieJar } from 'tough-cookie';\r\n\r\nconst APP_DATA_REGEX = /window\\.appData = JSON\\.parse\\(decodeURIComponent\\(\"(.+?)\"\\)\\);/;\r\nconst baseUrl = 'https://www.yuque.com';\r\n\r\nexport const route: Route = {\r\n    path: '/:name/:book',\r\n    categories: ['study'],\r\n    example: '/yuque/ruanyf/weekly',\r\n    parameters: { name: '用戶名', book: '知识库 ID' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['yuque.com/:name/:book'],\r\n        },\r\n    ],\r\n    name: '知识库',\r\n    maintainers: ['aha2mao', 'ltaoo'],\r\n    handler,\r\n    description: `| Node.js 专栏                                             | 阮一峰每周分享                                                 | 语雀使用手册                                             |\r\n| -------------------------------------------------------- | -------------------------------------------------------------- | -------------------------------------------------------- |\r\n| [/yuque/egg/nodejs](https://rsshub.app/yuque/egg/nodejs) | [/yuque/ruanyf/weekly](https://rsshub.app/yuque/ruanyf/weekly) | [/yuque/yuque/help](https://rsshub.app/yuque/yuque/help) |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const cookieJar = new CookieJar();\r\n    const { name, book } = ctx.req.param();\r\n    const bookUrl = `${baseUrl}/${name}/${book}`;\r\n\r\n    const { data: bookHtml } = await got(bookUrl, {\r\n        cookieJar,\r\n    });\r\n    const $ = load(bookHtml);\r\n    const appData = JSON.parse(decodeURIComponent($('script').text().match(APP_DATA_REGEX)[1]));\r\n\r\n    const bookId = appData.book.id;\r\n\r\n    const {\r\n        data: { data: docs },\r\n    } = await got(`${baseUrl}/api/docs`, {\r\n        searchParams: {\r\n            book_id: bookId,\r\n        },\r\n        cookieJar,\r\n    });\r\n\r\n    const list = docs.map((item) => ({\r\n        title: item.title,\r\n        description: item.description,\r\n        link: `${baseUrl}/${name}/${book}/${item.slug}`,\r\n        pubDate: parseDate(item.published_at),\r\n        slug: item.slug,\r\n    }));\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const {\r\n                    data: { data },\r\n                } = await got(`${baseUrl}/api/docs/${item.slug}`, {\r\n                    searchParams: {\r\n                        book_id: bookId,\r\n                        include_contributors: true,\r\n                    },\r\n                });\r\n\r\n                const $ = load(data.content, null, false);\r\n\r\n                $('card').each((_, elem) => {\r\n                    card2Html($(elem), item.link);\r\n                });\r\n                $('[data-lake-id]').removeAttr('data-lake-id');\r\n                $('[id]').removeAttr('id');\r\n                $('p').each((_, elem) => {\r\n                    elem = $(elem);\r\n                    if (elem.children().length === 1 && elem.children().is('br')) {\r\n                        elem.remove();\r\n                    }\r\n                    if (elem.children().length === 2 && elem.children().eq(0).is('span') && elem.children().eq(0).text().length === 1 && elem.children().eq(1).is('br')) {\r\n                        elem.remove();\r\n                    }\r\n                });\r\n                // obtain real video src\r\n                for await (const v of $('video').toArray()) {\r\n                    const $v = $(v);\r\n                    const src = $v.attr('src');\r\n                    if (src.startsWith('inputs')) {\r\n                        const { data } = await got(`${baseUrl}/api/video`, {\r\n                            searchParams: {\r\n                                video_id: src,\r\n                            },\r\n                        });\r\n                        const { info } = data.data;\r\n                        $v.replaceWith(`<video controls preload='none' poster='${info.cover}'><source src='${info.url}' type='video/mp4'></video>`);\r\n                    }\r\n                }\r\n\r\n                item.description = $.html();\r\n                item.author = data.contributors.map((c) => c.name).join(', ');\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: appData.book.name,\r\n        description: appData.book.description,\r\n        image: appData.group.avatar,\r\n        link: bookUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}