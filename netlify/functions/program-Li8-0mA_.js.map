{"version":3,"file":"program-Li8-0mA_.js","names":[],"sources":["../../lib/routes/tingtingfm/utils.ts","../../lib/routes/tingtingfm/program.ts"],"sourcesContent":["import md5 from '@/utils/md5';\r\n\r\nconst SALT = '1Ftjv0bfpVmqbE38';\r\n\r\nconst getClientVal = (length) => {\r\n    let result = '';\r\n    const randomChar = () => {\r\n        const random = Math.floor(62 * Math.random());\r\n        if (random < 10) {\r\n            return random;\r\n        } else if (random < 36) {\r\n            return String.fromCharCode(random + 55);\r\n        } else {\r\n            return String.fromCharCode(random + 61);\r\n        }\r\n    };\r\n    while (result.length < length) {\r\n        result += randomChar();\r\n    }\r\n    return `h5_${result}`;\r\n};\r\n\r\nconst sign = (params) => {\r\n    const searchParams = new URLSearchParams(params);\r\n    searchParams.sort();\r\n    return md5(`${searchParams.toString()}_${SALT}`);\r\n};\r\n\r\nexport { getClientVal, sign };\r\n","import { Route, ViewType } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { getClientVal, sign } from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/program/:programId',\r\n    categories: ['multimedia'],\r\n    view: ViewType.Audios,\r\n    example: '/tingtingfm/program/M7VJv6Jj4R',\r\n    parameters: { programId: '节目 ID，可以在 URL 中找到' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: true,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['mobile.tingtingfm.com/v3/program/:programId'],\r\n        },\r\n    ],\r\n    name: '节目',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const programId = ctx.req.param('programId');\r\n    const apiBaseUrl = 'https://api-v3.tingtingfm.com';\r\n    const mobileBaseUrl = 'https://mobile.tingtingfm.com';\r\n\r\n    const params = {\r\n        version: 'h5_5.16',\r\n        client: getClientVal(30),\r\n        h_program_id: programId,\r\n    };\r\n\r\n    const radioInfo = await cache.tryGet(`tingtingfm:program:${programId}`, async () => {\r\n        // the double slash here and below is not a typo\r\n        const { data: response } = await got.post(`${apiBaseUrl}//broadcast/get_program_v3_8`, {\r\n            searchParams: {\r\n                ...params,\r\n                api_sign: sign(params),\r\n            },\r\n        });\r\n        if (response.errno !== 0) {\r\n            throw new Error(response.error);\r\n        }\r\n\r\n        return response.data.info;\r\n    });\r\n\r\n    const latestAudio = await cache.tryGet(\r\n        `tingtingfm:audio_list:${programId}`,\r\n        async () => {\r\n            const { data: response } = await got.post(`${apiBaseUrl}//broadcast/get_program_audio_list`, {\r\n                searchParams: {\r\n                    ...params,\r\n                    api_sign: sign(params),\r\n                },\r\n            });\r\n            if (response.errno !== 0) {\r\n                throw new Error(response.error);\r\n            }\r\n\r\n            return response.data[0];\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const audioList = await cache.tryGet(\r\n        `tingtingfm:play_audio:${programId}`,\r\n        async () => {\r\n            const playAudioParams = {\r\n                // remove h_program_id from params\r\n                ...Object.fromEntries(Object.entries(params).filter(([key]) => key !== 'h_program_id')),\r\n                type: '',\r\n                sort: '-1',\r\n                audio_id: latestAudio.h_audio_id,\r\n            };\r\n            const { data: response } = await got.post(`${apiBaseUrl}//albumaudio/play_audio`, {\r\n                searchParams: {\r\n                    ...playAudioParams,\r\n                    api_sign: sign(playAudioParams),\r\n                },\r\n            });\r\n            if (response.errno !== 0) {\r\n                throw new Error(response.error);\r\n            }\r\n\r\n            return { radioCover: response.data.info.radio_cover, list: response.data.list };\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const { radioCover, list } = audioList;\r\n\r\n    const items = list.map((audio) => ({\r\n        title: audio.title,\r\n        link: `${mobileBaseUrl}/v3/vod/2/${audio.h_audio_id}`,\r\n        description: art(path.join(__dirname, 'templates/audio.art'), {\r\n            url: audio.play_url,\r\n        }),\r\n        pubDate: parseDate(audio.add_time, 'X'),\r\n        itunes_item_image: radioCover,\r\n        itunes_duration: audio.duration,\r\n        enclosure_url: audio.play_url,\r\n        enclosure_type: 'audio/x-m4a',\r\n    }));\r\n\r\n    return {\r\n        title: `${radioInfo.title} - ${radioInfo.belong_radio}${radioInfo.belong_fm}`,\r\n        description: radioInfo.description,\r\n        link: `${mobileBaseUrl}/v3/program/${programId}`,\r\n        image: radioInfo.cover.split('?x-oss')[0],\r\n        itunes_author: radioInfo.anchor.join(', '),\r\n        itunes_category: radioInfo.category,\r\n        itunes_explicit: false,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"iiBAEA,MAEA,EAAA,GAAA,2DAIQ,EAAA,GAAA,4DAQJ,KAAA,EAAA,OAAA,GAAA,GAAA,IAGA,MAAA,MAAA,KAGJ,EAAA,GAAA,8BAGI,OADA,EAAA,OACA,EAAA,GAAA,EAAA,WAAA,qBCfS,EAAe,CACxB,KAAM,sBACN,WAAY,CAAC,cACb,KAAM,EAAS,OACf,QAAS,iCACT,WAAY,CAAE,UAAW,qBACzB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,iDAGjB,KAAM,KACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAY,EAAI,IAAI,MAAM,aAC1B,EAAa,gCACb,EAAgB,gCAEhB,EAAS,CACX,QAAS,UACT,OAAQ,EAAa,IACrB,aAAc,GAGZ,EAAY,MAAM,EAAM,OAAO,sBAAsB,IAAa,SAAY,CAEhF,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,KAAK,GAAG,EAAW,8BAA+B,CACnF,aAAc,CACV,GAAG,EACH,SAAU,EAAK,MAGvB,GAAI,EAAS,QAAU,EACnB,MAAU,MAAM,EAAS,OAG7B,OAAO,EAAS,KAAK,OAGnB,EAAc,MAAM,EAAM,OAC5B,yBAAyB,IACzB,SAAY,CACR,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,KAAK,GAAG,EAAW,oCAAqC,CACzF,aAAc,CACV,GAAG,EACH,SAAU,EAAK,MAGvB,GAAI,EAAS,QAAU,EACnB,MAAU,MAAM,EAAS,OAG7B,OAAO,EAAS,KAAK,IAEzB,EAAO,MAAM,YACb,IAGE,EAAY,MAAM,EAAM,OAC1B,yBAAyB,IACzB,SAAY,CACR,IAAM,EAAkB,CAEpB,GAAG,OAAO,YAAY,OAAO,QAAQ,GAAQ,QAAQ,CAAC,KAAS,IAAQ,iBACvE,KAAM,GACN,KAAM,KACN,SAAU,EAAY,YAEpB,CAAE,KAAM,GAAa,MAAM,EAAI,KAAK,GAAG,EAAW,yBAA0B,CAC9E,aAAc,CACV,GAAG,EACH,SAAU,EAAK,MAGvB,GAAI,EAAS,QAAU,EACnB,MAAU,MAAM,EAAS,OAG7B,MAAO,CAAE,WAAY,EAAS,KAAK,KAAK,YAAa,KAAM,EAAS,KAAK,OAE7E,EAAO,MAAM,YACb,IAGE,CAAE,aAAY,QAAS,EAEvB,EAAQ,EAAK,IAAK,IAAW,CAC/B,MAAO,EAAM,MACb,KAAM,GAAG,EAAc,YAAY,EAAM,aACzC,YAAa,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAC1D,IAAK,EAAM,WAEf,QAAS,EAAU,EAAM,SAAU,KACnC,kBAAmB,EACnB,gBAAiB,EAAM,SACvB,cAAe,EAAM,SACrB,eAAgB,iBAGpB,MAAO,CACH,MAAO,GAAG,EAAU,MAAM,KAAK,EAAU,eAAe,EAAU,YAClE,YAAa,EAAU,YACvB,KAAM,GAAG,EAAc,cAAc,IACrC,MAAO,EAAU,MAAM,MAAM,UAAU,GACvC,cAAe,EAAU,OAAO,KAAK,MACrC,gBAAiB,EAAU,SAC3B,gBAAiB,GACjB,KAAM"}