{"version":3,"file":"theverge-ySnoQP2k.js","names":[],"sources":["../../lib/routes/theverge/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport parser from '@/utils/rss-parser';\r\nimport { load } from 'cheerio';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\n\r\nexport const route: Route = {\r\n    path: '/:hub?',\r\n    categories: ['new-media'],\r\n    example: '/theverge',\r\n    parameters: { hub: 'Hub, see below, All Posts by default' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['theverge.com/:hub', 'theverge.com/'],\r\n        },\r\n    ],\r\n    name: 'Category',\r\n    maintainers: ['HenryQW', 'vbali'],\r\n    handler,\r\n    description: `| Hub         | Hub name            |\r\n| ----------- | ------------------- |\r\n|             | All Posts           |\r\n| android     | Android             |\r\n| apple       | Apple               |\r\n| apps        | Apps & Software     |\r\n| blackberry  | BlackBerry          |\r\n| culture     | Culture             |\r\n| gaming      | Gaming              |\r\n| hd          | HD & Home           |\r\n| microsoft   | Microsoft           |\r\n| photography | Photography & Video |\r\n| policy      | Policy & Law        |\r\n| web         | Web & Social        |\r\n\r\n  Provides a better reading experience (full text articles) over the official one.`,\r\n};\r\n\r\nconst renderBlock = (b) => {\r\n    switch (b.__typename) {\r\n        case 'CoreEmbedBlockType':\r\n            return b.embedHtml;\r\n        case 'CoreGalleryBlockType':\r\n            return b.images.map((i) => `<figure><img src=\"${i.image.thumbnails.horizontal.url.split('?')[0]}\" alt=\"${i.alt}\" /><figcaption>${i.caption.html}</figcaption></figure>`).join('');\r\n        case 'CoreHeadingBlockType':\r\n            return `<h${b.level}>${b.contents.html}</h${b.level}>`;\r\n        case 'CoreHTMLBlockType':\r\n            return b.markup;\r\n        case 'CoreImageBlockType':\r\n            return `<figure><img src=\"${b.thumbnail.url.split('?')[0]}\" alt=\"${b.alt}\" /><figcaption>${b.caption.html}</figcaption></figure>`;\r\n        case 'CoreListBlockType':\r\n            return `${b.ordered ? '<ol>' : '<ul>'}${b.items.map((i) => `<li>${i.contents.html}</li>`).join('')}${b.ordered ? '</ol>' : '</ul>'}`;\r\n        case 'CoreParagraphBlockType':\r\n            return b.contents.html;\r\n        case 'CorePullquoteBlockType':\r\n            return `<blockquote>${b.contents.html}</blockquote>`;\r\n        case 'CoreQuoteBlockType':\r\n            return `<blockquote>${b.children.map((child) => renderBlock(child)).join('')}</blockquote>`;\r\n        case 'CoreSeparatorBlockType':\r\n            return '<hr>';\r\n        case 'HighlightBlockType':\r\n            return b.children.map((c) => renderBlock(c)).join('');\r\n        case 'MethodologyAccordionBlockType':\r\n            return `<h2>${b.heading.html}</h2>${b.sections.map((s) => `<h3>${s.heading.html}</h3>${s.content.html}`).join('')}`;\r\n        default:\r\n            throw new Error(`Unsupported block type: ${b.__typename}`);\r\n    }\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const link = ctx.req.param('hub') ? `https://www.theverge.com/${ctx.req.param('hub')}/rss/index.xml` : 'https://www.theverge.com/rss/index.xml';\r\n\r\n    const feed = await parser.parseURL(link);\r\n\r\n    const items = await Promise.all(\r\n        feed.items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch(item.link);\r\n\r\n                const $ = load(response);\r\n\r\n                const nextData = JSON.parse($('script#__NEXT_DATA__').text());\r\n                const node = nextData.props.pageProps.hydration.responses.find((x) => x.operationName === 'PostLayoutQuery' || x.operationName === 'StreamLayoutQuery').data.node;\r\n\r\n                let description = art(path.join(__dirname, 'templates/header.art'), {\r\n                    featuredImage: node.featuredImage,\r\n                    ledeMediaData: node.ledeMediaData,\r\n                });\r\n\r\n                description += node.blocks\r\n                    .filter((b) => b.__typename !== 'NewsletterBlockType' && b.__typename !== 'RelatedPostsBlockType' && b.__typename !== 'ProductBlockType' && b.__typename !== 'TableOfContentsBlockType')\r\n                    .map((b) => renderBlock(b))\r\n                    .join('<br><br>');\r\n\r\n                if (node.__typename === 'StreamResourceType') {\r\n                    description += node.posts.edges\r\n                        .map(({ node: n }) => {\r\n                            let d =\r\n                                `<h2><a href=\"${n.permalink}\">${n.promo.headline || n.title}</a></h2>` +\r\n                                art(path.join(__dirname, 'templates/header.art'), {\r\n                                    ledeMediaData: n.ledeMediaData,\r\n                                });\r\n                            switch (n.__typename) {\r\n                                case 'PostResourceType':\r\n                                    d += n.excerpt.map((e) => e.contents.html).join('<br>');\r\n                                    break;\r\n                                case 'QuickPostResourceType':\r\n                                    d += n.blocks.map((b) => renderBlock(b)).join('<br>');\r\n                                    break;\r\n                                default:\r\n                                    break;\r\n                            }\r\n                            return d;\r\n                        })\r\n                        .join('<br>');\r\n                }\r\n\r\n                item.description = description;\r\n                item.category = node.categories;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: feed.title,\r\n        link: feed.link,\r\n        description: feed.description,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}