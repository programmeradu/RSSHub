{"version":3,"file":"topic-DkyvzZQI.js","names":["route: Route","cache","apiPath","signedHeader","response","got","link","pubDate: Date"],"sources":["../../lib/routes/zhihu/topic.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { header, processImage, getSignedHeader } from './utils';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/topic/:topicId/:isTop?',\r\n    categories: ['social-media'],\r\n    example: '/zhihu/topic/19828946',\r\n    parameters: { topicId: '话题 id', isTop: '仅精华，默认为否，其他值为是' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'ZHIHU_COOKIES',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.zhihu.com/topic/:topicId/:type'],\r\n            target: '/topic/:topicId',\r\n        },\r\n    ],\r\n    name: '话题',\r\n    maintainers: ['xyqfer'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { topicId, isTop = false } = ctx.req.param();\r\n    const link = `https://www.zhihu.com/topic/${topicId}/${isTop ? 'top-answers' : 'newest'}`;\r\n\r\n    const topicMeta = await cache.tryGet(`zhihu:topic:${topicId}`, async () => {\r\n        const url = `https://www.zhihu.com/topic/${topicId}`;\r\n        const apiPath = `/api/v4/topics/${topicId}/intro?include=content.meta.content.photos`;\r\n        const signedHeader = await getSignedHeader(url, apiPath);\r\n        const { data: response } = await got('https://www.zhihu.com' + apiPath, {\r\n            headers: signedHeader,\r\n        });\r\n        return response;\r\n    });\r\n\r\n    const apiPath = `/api/v5.1/topics/${topicId}/feeds/${isTop ? 'top_activity' : 'timeline_activity'}`;\r\n    const signedHeader = await getSignedHeader(link, apiPath);\r\n\r\n    const { data: response } = await got(`https://www.zhihu.com${apiPath}`, {\r\n        headers: {\r\n            ...header,\r\n            ...signedHeader,\r\n            Referer: link,\r\n        },\r\n    });\r\n\r\n    const items = response.data.map(({ target: item }) => {\r\n        const type = item.type;\r\n        let title = '';\r\n        let description = '';\r\n        let link = '';\r\n        let pubDate: Date;\r\n        let author = '';\r\n\r\n        switch (type) {\r\n            case 'answer':\r\n                title = `${item.question.title}-${item.author.name}的回答：${item.excerpt}`;\r\n                description = `<strong>${item.question.title}</strong><br>${item.author.name}的回答<br/>${processImage(item.content)}`;\r\n                link = `https://www.zhihu.com/question/${item.question.id}/answer/${item.id}`;\r\n                pubDate = parseDate(item.updated_time * 1000);\r\n                author = item.author.name;\r\n                break;\r\n\r\n            case 'question':\r\n                title = item.title;\r\n                description = item.title;\r\n                link = `https://www.zhihu.com/question/${item.id}`;\r\n                pubDate = parseDate(item.created * 1000);\r\n                break;\r\n\r\n            case 'article':\r\n                title = item.title;\r\n                description = processImage(item.content);\r\n                link = item.url;\r\n                pubDate = parseDate(item.created * 1000);\r\n                break;\r\n\r\n            case 'zvideo':\r\n                title = item.title;\r\n                description = `${item.description}<br>\r\n                <video controls poster=\"${item.video.thumbnail}\" preload=\"metadata\">\r\n                    <source src=\"${item.video.playlist.fhd?.url ?? item.video.playlist.hd?.url ?? item.video.playlist.ld?.url ?? item.video.playlist.sd?.url}\" type=\"video/mp4\">\r\n                </video>`;\r\n                link = item.url;\r\n                pubDate = parseDate(item.created_at * 1000);\r\n                break;\r\n\r\n            default:\r\n                description = '未知类型，请点击<a href=\"https://github.com/DIYgod/RSSHub/issues\">链接</a>提交issue';\r\n                pubDate = parseDate(Date.now());\r\n        }\r\n\r\n        return {\r\n            title,\r\n            description,\r\n            author,\r\n            pubDate,\r\n            guid: item.id.toString(),\r\n            link,\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `知乎话题-${topicId}-${isTop ? '精华' : '讨论'}`,\r\n        description: topicMeta.content.introduction,\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ubAMA,MAAaA,EAAe,CACxB,KAAM,0BACN,WAAY,CAAC,gBACb,QAAS,wBACT,WAAY,CAAE,QAAS,QAAS,MAAO,kBACvC,SAAU,CACN,cAAe,CACX,CACI,KAAM,gBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,sCACT,OAAQ,oBAGhB,KAAM,KACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,UAAS,QAAQ,IAAU,EAAI,IAAI,QACrC,EAAO,+BAA+B,EAAQ,GAAG,EAAQ,cAAgB,WAEzE,EAAY,MAAMC,EAAM,OAAO,eAAe,IAAW,SAAY,CACvE,IAAM,EAAM,+BAA+B,IACrCC,EAAU,kBAAkB,EAAQ,4CACpCC,EAAe,MAAM,EAAgB,EAAKD,GAC1C,CAAE,KAAME,GAAa,MAAMC,EAAI,wBAA0BH,EAAS,CACpE,QAASC,IAEb,OAAOC,IAGL,EAAU,oBAAoB,EAAQ,SAAS,EAAQ,eAAiB,sBACxE,EAAe,MAAM,EAAgB,EAAM,GAE3C,CAAE,KAAM,GAAa,MAAMC,EAAI,wBAAwB,IAAW,CACpE,QAAS,CACL,GAAG,EACH,GAAG,EACH,QAAS,KAIX,EAAQ,EAAS,KAAK,KAAK,CAAE,OAAQ,KAAW,CAClD,IAAM,EAAO,EAAK,KACd,EAAQ,GACR,EAAc,GACdC,EAAO,GACPC,EACA,EAAS,GAEb,OAAQ,EAAR,CACI,IAAK,SACD,EAAQ,GAAG,EAAK,SAAS,MAAM,GAAG,EAAK,OAAO,KAAK,MAAM,EAAK,UAC9D,EAAc,WAAW,EAAK,SAAS,MAAM,eAAe,EAAK,OAAO,KAAK,UAAU,EAAa,EAAK,WACzG,EAAO,kCAAkC,EAAK,SAAS,GAAG,UAAU,EAAK,KACzE,EAAU,EAAU,EAAK,aAAe,KACxC,EAAS,EAAK,OAAO,KACrB,MAEJ,IAAK,WACD,EAAQ,EAAK,MACb,EAAc,EAAK,MACnB,EAAO,kCAAkC,EAAK,KAC9C,EAAU,EAAU,EAAK,QAAU,KACnC,MAEJ,IAAK,UACD,EAAQ,EAAK,MACb,EAAc,EAAa,EAAK,SAChC,EAAO,EAAK,IACZ,EAAU,EAAU,EAAK,QAAU,KACnC,MAEJ,IAAK,SACD,EAAQ,EAAK,MACb,EAAc,GAAG,EAAK,YAAY;0CACR,EAAK,MAAM,UAAU;mCAC5B,EAAK,MAAM,SAAS,KAAK,KAAO,EAAK,MAAM,SAAS,IAAI,KAAO,EAAK,MAAM,SAAS,IAAI,KAAO,EAAK,MAAM,SAAS,IAAI,IAAI;0BAE7I,EAAO,EAAK,IACZ,EAAU,EAAU,EAAK,WAAa,KACtC,MAEJ,QACI,EAAc,0EACd,EAAU,EAAU,KAAK,OAGjC,MAAO,CACH,QACA,cACA,SACA,UACA,KAAM,EAAK,GAAG,WACd,KAAA,KAIR,MAAO,CACH,MAAO,QAAQ,EAAQ,GAAG,EAAQ,KAAO,OACzC,YAAa,EAAU,QAAQ,aAC/B,OACA,KAAM"}