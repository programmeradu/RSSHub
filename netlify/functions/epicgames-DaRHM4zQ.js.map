{"version":3,"file":"epicgames-DaRHM4zQ.js","names":[],"sources":["../../lib/routes/epicgames/index.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport dayjs from 'dayjs';\r\n\r\nexport const route: Route = {\r\n    path: '/freegames/:locale?/:country?',\r\n    categories: ['game'],\r\n    view: ViewType.Notifications,\r\n    example: '/epicgames/freegames/en-US/US',\r\n    parameters: {\r\n        locale: {\r\n            description: 'Locale',\r\n            default: 'en-US',\r\n        },\r\n        country: {\r\n            description: 'Country',\r\n            default: 'US',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['store.epicgames.com/:locale/free-games'],\r\n            target: '/freegames/:locale',\r\n        },\r\n    ],\r\n    name: 'Free games',\r\n    maintainers: ['DIYgod', 'NeverBehave', 'Zyx-A', 'junfengP', 'nczitzk', 'KotaHv'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const locale = ctx.req.param('locale') ?? 'en-US';\r\n    const country = ctx.req.param('country') ?? 'US';\r\n\r\n    const rootUrl = 'https://store.epicgames.com';\r\n    const currentUrl = `${rootUrl}/${locale}/free-games?lang=${locale}`;\r\n    const apiUrl = `https://store-site-backend-static-ipv4.ak.epicgames.com/freeGamesPromotions?locale=${locale}&country=${country}&allowCountries=${country}`;\r\n    const contentBaseUrl = `https://store-content-ipv4.ak.epicgames.com/api/${locale}/content`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: apiUrl,\r\n    });\r\n\r\n    const now = dayjs();\r\n    const items = response.data.data.Catalog.searchStore.elements\r\n        .filter(\r\n            (item) =>\r\n                item.promotions &&\r\n                item.promotions.promotionalOffers &&\r\n                item.promotions.promotionalOffers.length &&\r\n                item.promotions.promotionalOffers[0].promotionalOffers[0].discountSetting.discountType === 'PERCENTAGE' &&\r\n                item.promotions.promotionalOffers[0].promotionalOffers[0].discountSetting.discountPercentage === 0 &&\r\n                dayjs(item.promotions.promotionalOffers[0].promotionalOffers[0].startDate) <= now &&\r\n                dayjs(item.promotions.promotionalOffers[0].promotionalOffers[0].endDate) > now\r\n        )\r\n        .map(async (item) => {\r\n            let link = `${rootUrl}/${locale}/p/`;\r\n            let contentUrl = `${contentBaseUrl}/products/`;\r\n            let isBundles = false;\r\n            if (item.categories.some((category) => category.path === 'bundles')) {\r\n                link = `${rootUrl}/${locale}/bundles/`;\r\n                isBundles = true;\r\n                contentUrl = `${contentBaseUrl}/bundles/`;\r\n            }\r\n            let linkSlug =\r\n                item.catalogNs.mappings && item.catalogNs.mappings.length > 0\r\n                    ? item.catalogNs.mappings[0].pageSlug\r\n                    : item.offerMappings && item.offerMappings.length > 0\r\n                      ? item.offerMappings[0].pageSlug\r\n                      : (item.productSlug ?? item.urlSlug);\r\n            if (item.offerType === 'ADD_ON') {\r\n                linkSlug = item.offerMappings[0].pageSlug;\r\n            }\r\n            link += linkSlug;\r\n            contentUrl += linkSlug;\r\n            let description = item.description;\r\n            if (isBundles) {\r\n                const contentResp = await got({\r\n                    method: 'get',\r\n                    url: contentUrl,\r\n                });\r\n                description = contentResp.data.data.about.shortDescription;\r\n            }\r\n            let image = item.keyImages[0].url;\r\n            item.keyImages.some((keyImage) => {\r\n                if (keyImage.type === 'DieselStoreFrontWide') {\r\n                    image = keyImage.url;\r\n                    return true;\r\n                }\r\n                return false;\r\n            });\r\n            const endDate = dayjs(item.promotions.promotionalOffers[0].promotionalOffers[0].endDate).toISOString();\r\n            return {\r\n                title: item.title,\r\n                author: item.seller.name,\r\n                link,\r\n                description: art(path.join(__dirname, 'templates/description.art'), {\r\n                    description,\r\n                    image,\r\n                    endDate,\r\n                }),\r\n                pubDate: parseDate(item.promotions.promotionalOffers[0].promotionalOffers[0].startDate),\r\n            };\r\n        });\r\n    return {\r\n        title: 'Epic Games Store - Free Games',\r\n        link: currentUrl,\r\n        item: await Promise.all(items),\r\n    };\r\n}\r\n"],"mappings":"ycAQA,MAAa,EAAe,CACxB,KAAM,gCACN,WAAY,CAAC,QACb,KAAM,EAAS,cACf,QAAS,gCACT,WAAY,CACR,OAAQ,CACJ,YAAa,SACb,QAAS,SAEb,QAAS,CACL,YAAa,UACb,QAAS,OAGjB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,0CACT,OAAQ,uBAGhB,KAAM,aACN,YAAa,CAAC,SAAU,cAAe,QAAS,WAAY,UAAW,UACvE,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAI,IAAI,MAAM,WAAa,QACpC,EAAU,EAAI,IAAI,MAAM,YAAc,KAEtC,EAAU,8BACV,EAAa,GAAG,EAAQ,GAAG,EAAO,mBAAmB,IACrD,EAAS,sFAAsF,EAAO,WAAW,EAAQ,kBAAkB,IAC3I,EAAiB,mDAAmD,EAAO,UAE3E,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAM,IACN,EAAQ,EAAS,KAAK,KAAK,QAAQ,YAAY,SAChD,OACI,GACG,EAAK,YACL,EAAK,WAAW,mBAChB,EAAK,WAAW,kBAAkB,QAClC,EAAK,WAAW,kBAAkB,GAAG,kBAAkB,GAAG,gBAAgB,eAAiB,cAC3F,EAAK,WAAW,kBAAkB,GAAG,kBAAkB,GAAG,gBAAgB,qBAAuB,GACjG,EAAM,EAAK,WAAW,kBAAkB,GAAG,kBAAkB,GAAG,YAAc,GAC9E,EAAM,EAAK,WAAW,kBAAkB,GAAG,kBAAkB,GAAG,SAAW,GAElF,IAAI,KAAO,IAAS,CACjB,IAAI,EAAO,GAAG,EAAQ,GAAG,EAAO,KAC5B,EAAa,GAAG,EAAe,YAC/B,EAAY,GACZ,EAAK,WAAW,KAAM,GAAa,EAAS,OAAS,aACrD,EAAO,GAAG,EAAQ,GAAG,EAAO,WAC5B,EAAY,GACZ,EAAa,GAAG,EAAe,YAEnC,IAAI,EACA,EAAK,UAAU,UAAY,EAAK,UAAU,SAAS,OAAS,EACtD,EAAK,UAAU,SAAS,GAAG,SAC3B,EAAK,eAAiB,EAAK,cAAc,OAAS,EAChD,EAAK,cAAc,GAAG,SACrB,EAAK,aAAe,EAAK,QAClC,EAAK,YAAc,WACnB,EAAW,EAAK,cAAc,GAAG,UAErC,GAAQ,EACR,GAAc,EACd,IAAI,EAAc,EAAK,YACvB,GAAI,EAAW,CACX,IAAM,EAAc,MAAM,EAAI,CAC1B,OAAQ,MACR,IAAK,IAET,EAAc,EAAY,KAAK,KAAK,MAAM,iBAE9C,IAAI,EAAQ,EAAK,UAAU,GAAG,IAC9B,EAAK,UAAU,KAAM,GACb,EAAS,OAAS,wBAClB,EAAQ,EAAS,IACV,IAEJ,IAEX,IAAM,EAAU,EAAM,EAAK,WAAW,kBAAkB,GAAG,kBAAkB,GAAG,SAAS,cACzF,MAAO,CACH,MAAO,EAAK,MACZ,OAAQ,EAAK,OAAO,KACpB,OACA,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,cACA,QACA,YAEJ,QAAS,EAAU,EAAK,WAAW,kBAAkB,GAAG,kBAAkB,GAAG,cAGzF,MAAO,CACH,MAAO,gCACP,KAAM,EACN,KAAM,MAAM,QAAQ,IAAI"}