{"version":3,"file":"forum-CcOuNQsM.js","names":["path","apiUrl","cache","got"],"sources":["../../lib/routes/feng/utils.ts","../../lib/routes/feng/forum.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport CryptoJS from 'crypto-js';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nconst apiUrl = 'https://api.wfdata.club';\r\nconst baseUrl = 'https://www.feng.com';\r\nconst KEY = '2b7e151628aed2a6';\r\n\r\n// https://juejin.cn/post/6844904066468806664\r\nconst getXRequestId = (apiUrl) => {\r\n    const path = new URL(apiUrl).pathname; // split search params\r\n    const plainText = CryptoJS.enc.Utf8.parse('url=' + path + '$time=' + Date.now() + '000000');\r\n    const iv = CryptoJS.enc.Utf8.parse(KEY);\r\n    const encrypted = CryptoJS.AES.encrypt(plainText, iv, {\r\n        iv,\r\n        mode: CryptoJS.mode.CBC,\r\n        padding: CryptoJS.pad.Pkcs7,\r\n    }).toString();\r\n    return encrypted;\r\n};\r\n\r\nconst getCategory = (topicId) => {\r\n    const url = `${apiUrl}/v1/topic/category`;\r\n    return cache.tryGet(\r\n        url,\r\n        async () => {\r\n            const response = await got(url, {\r\n                headers: {\r\n                    Referer: `${baseUrl}/forum/${topicId}`,\r\n                    'X-Request-Id': getXRequestId(url),\r\n                },\r\n            });\r\n            return response.data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n};\r\n\r\nconst getForumMeta = async (topicId) => {\r\n    const categoryData = await getCategory(topicId);\r\n    return Object.values(categoryData.data.dataList).find((item) => item.dataList.find((i) => i.topicId === topicId));\r\n};\r\n\r\nconst getThreads = (topicId, type) => {\r\n    const url = `${apiUrl}/v1/topic/${topicId}/thread?topicId=${topicId}&type=${type}&pageCount=50&order=${type === 'newest' ? 'replyTime' : 'postTime'}&page=1`;\r\n    return cache.tryGet(\r\n        url,\r\n        async () => {\r\n            const response = await got(url, {\r\n                headers: {\r\n                    Referer: `${baseUrl}/forum/${topicId}`,\r\n                    'X-Request-Id': getXRequestId(url),\r\n                },\r\n            });\r\n            return response.data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n};\r\n\r\nconst getThread = (tid, topicId) => {\r\n    const url = `${apiUrl}/v1/thread/${tid}`;\r\n    return cache.tryGet(url, async () => {\r\n        const response = await got(url, {\r\n            headers: {\r\n                Referer: `${baseUrl}/forum/${topicId}`,\r\n                'X-Request-Id': getXRequestId(url),\r\n            },\r\n        });\r\n        return response.data;\r\n    });\r\n};\r\n\r\nexport { baseUrl, getForumMeta, getThreads, getThread };\r\n","import { Route } from '@/types';\r\n\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { baseUrl, getForumMeta, getThreads, getThread } from './utils';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/forum/:id/:type?',\r\n    categories: ['bbs'],\r\n    example: '/feng/forum/1',\r\n    parameters: { id: '版块 ID，可在版块 URL 找到', type: '排序，见下表，默认为 `all`' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['feng.com/forum/photo/:id', 'feng.com/forum/:id'],\r\n            target: '/forum/:id',\r\n        },\r\n    ],\r\n    name: '社区',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n    description: `| 最新回复 | 最新发布 | 热门 | 精华    |\r\n| -------- | -------- | ---- | ------- |\r\n| newest   | all      | hot  | essence |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const topicId = Number(ctx.req.param('id'));\r\n    const { type = 'all' } = ctx.req.param();\r\n\r\n    const forumMeta = await getForumMeta(topicId);\r\n    const topicMeta = forumMeta.dataList.find((data) => data.topicId === topicId);\r\n    const threads = (await getThreads(topicId, type)).data.dataList.map((data) => ({\r\n        title: data.title,\r\n        pubDate: parseDate(data.dateline * 1000),\r\n        author: data.userBaseInfo.userName,\r\n        link: `${baseUrl}/post/${data.tid}`,\r\n        tid: data.tid,\r\n    }));\r\n\r\n    const posts = await Promise.all(\r\n        threads.map(async (item) => {\r\n            const thread = await getThread(item.tid, topicId);\r\n            if (thread.status.code === 0) {\r\n                const img = art(path.join(__dirname, 'templates/img.art'), {\r\n                    images: thread.data.thread.fengTalkImage.length ? thread.data.thread.fengTalkImage : undefined,\r\n                });\r\n                item.description = thread.data.thread.message + img;\r\n            } else {\r\n                item.description = art(path.join(__dirname, 'templates/deleted.art'), {});\r\n            }\r\n            delete item.tid;\r\n            return item;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `${topicMeta.topicName} - 社区 - 威锋 - 千万果粉大本营`,\r\n        description: topicMeta.topicDescription,\r\n        link: `${baseUrl}/forum/${topicId}`,\r\n        item: posts,\r\n    };\r\n}\r\n"],"mappings":"meAIA,MAAA,EAAA,0BACA,EAAA,uBAIA,EAAA,GAAA,uMASI,OAAA,GAGJ,EAAA,GAAA,gCAEI,OAAA,EAAA,OAAA,EAAA,SAAA,4EASQ,OAAA,EAAA,+BAOZ,EAAA,KAAA,IAAA,kBAEI,OAAA,OAAA,OAAA,EAAA,KAAA,UAAA,KAAA,GAAA,EAAA,SAAA,KAAA,GAAA,EAAA,UAAA,KAGJ,GAAA,EAAA,IAAA,2HAEI,OAAA,EAAA,OAAA,EAAA,SAAA,4EASQ,OAAA,EAAA,+BAOZ,GAAA,EAAA,IAAA,6BAEI,OAAA,EAAA,OAAA,EAAA,SAAA,4EAOI,OAAA,EAAA,QChEK,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,OACb,QAAS,gBACT,WAAY,CAAE,GAAI,oBAAqB,KAAM,oBAC7C,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,2BAA4B,sBACrC,OAAQ,eAGhB,KAAM,KACN,YAAa,CAAC,UACd,UACA,YAAa;;2CAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,OAAO,EAAI,IAAI,MAAM,OAC/B,CAAE,OAAO,OAAU,EAAI,IAAI,QAE3B,EAAY,MAAM,EAAa,GAC/B,EAAY,EAAU,SAAS,KAAM,GAAS,EAAK,UAAY,GAC/D,GAAW,MAAM,EAAW,EAAS,IAAO,KAAK,SAAS,IAAK,IAAU,CAC3E,MAAO,EAAK,MACZ,QAAS,EAAU,EAAK,SAAW,KACnC,OAAQ,EAAK,aAAa,SAC1B,KAAM,GAAG,EAAQ,QAAQ,EAAK,MAC9B,IAAK,EAAK,OAGR,EAAQ,MAAM,QAAQ,IACxB,EAAQ,IAAI,KAAO,IAAS,CACxB,IAAM,EAAS,MAAM,EAAU,EAAK,IAAK,GACzC,GAAI,EAAO,OAAO,OAAS,EAAG,CAC1B,IAAM,EAAM,EAAI,EAAA,KAAA,EAAA,8BAA2C,CACvD,OAAQ,EAAO,KAAK,OAAO,cAAc,OAAS,EAAO,KAAK,OAAO,cAAgB,IAAA,KAEzF,EAAK,YAAc,EAAO,KAAK,OAAO,QAAU,OAEhD,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,kCAA+C,IAG1E,OADA,OAAO,EAAK,IACL,KAIf,MAAO,CACH,MAAO,GAAG,EAAU,UAAU,sBAC9B,YAAa,EAAU,iBACvB,KAAM,GAAG,EAAQ,SAAS,IAC1B,KAAM"}