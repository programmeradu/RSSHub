{"version":3,"file":"cast-DV6rTBEB.js","names":["cache","got","route: Route","items: any[]"],"sources":["../../lib/routes/cast/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nconst baseUrl = 'https://www.cast.org.cn';\r\n\r\nasync function parsePage(html: string) {\r\n    return await Promise.all(\r\n        load(html)('li')\r\n            .toArray()\r\n            .map((el) => {\r\n                const title = load(el)('a');\r\n                let articleUrl = title.attr('href');\r\n\r\n                if (articleUrl?.startsWith('http')) {\r\n                    return {\r\n                        title: title.text(),\r\n                        link: title.attr('href'),\r\n                    };\r\n                }\r\n                articleUrl = `${baseUrl}${title.attr('href')}`;\r\n\r\n                return cache.tryGet(articleUrl, async () => {\r\n                    const res = await got.get<string>(articleUrl!);\r\n                    const article = load(res.data);\r\n                    const pubDate = timezone(parseDate(article('meta[name=PubDate]').attr('content')!, 'YYYY-MM-DD HH:mm'), +8);\r\n\r\n                    return {\r\n                        title: title.text(),\r\n                        pubDate,\r\n                        description: article('#zoom').html(),\r\n                        link: articleUrl,\r\n                    };\r\n                });\r\n            })\r\n    );\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/:column/:subColumn/:category?',\r\n    categories: ['government'],\r\n    example: '/cast/xw/tzgg/ZH',\r\n    parameters: { column: '栏目编号，见下表', subColumn: '二级栏目编号', category: '分类' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['cast.org.cn/:column/:subColumn/:category/index.html', 'cast.org.cn/:column/:subColumn/index.html'],\r\n            target: '/:column/:subColumn/:category?',\r\n        },\r\n    ],\r\n    name: '通用',\r\n    maintainers: ['KarasuShin', 'TonyRL'],\r\n    handler,\r\n    description: `::: tip\r\n  在路由末尾处加上 \\`?limit=限制获取数目\\` 来限制获取条目数量，默认值为\\`10\\`\r\n:::\r\n\r\n| 分类     | 编码 |\r\n| -------- | ---- |\r\n| 全景科协 | qjkx |\r\n| 智库     | zk   |\r\n| 学术     | xs   |\r\n| 科普     | kp   |\r\n| 党建     | dj   |\r\n| 数据     | sj   |\r\n| 新闻     | xw   |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { column, subColumn, category } = ctx.req.param();\r\n    const { limit = 10 } = ctx.req.query();\r\n    let link = `${baseUrl}/${column}/${subColumn}`;\r\n    if (category) {\r\n        link += `/${category}/index.html`;\r\n    }\r\n    const { data: indexData } = await got.get<string>(link);\r\n\r\n    const $ = load(indexData);\r\n\r\n    let items: any[] = [];\r\n\r\n    // 新闻-视频首页特殊处理\r\n    if (column === 'xw' && subColumn === 'SP' && !category) {\r\n        items = await parsePage(indexData);\r\n    } else {\r\n        const buildUnitScript = $('script[parseType=\"bulidstatic\"]');\r\n        const queryUrl = `${baseUrl}${buildUnitScript.attr('url')}`;\r\n        const queryData = JSON.parse(buildUnitScript.attr('querydata')?.replace(/'/g, '\"') ?? '{}');\r\n        queryData.paramJson = `{\"pageNo\":1,\"pageSize\":${limit}}`;\r\n\r\n        const { data } = await got.get<{ data: { html: string } }>(queryUrl, {\r\n            searchParams: new URLSearchParams(queryData),\r\n        });\r\n\r\n        items = await parsePage(data.data.html);\r\n    }\r\n\r\n    const pageTitle = $('head title').text();\r\n\r\n    return {\r\n        title: pageTitle,\r\n        link,\r\n        image: 'https://www.cast.org.cn/favicon.ico',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"0ZAMA,MAAM,EAAU,0BAEhB,eAAe,EAAU,EAAc,CACnC,OAAO,MAAM,QAAQ,IACjB,EAAK,GAAM,MACN,UACA,IAAK,GAAO,CACT,IAAM,EAAQ,EAAK,GAAI,KACnB,EAAa,EAAM,KAAK,QAU5B,OARI,GAAY,WAAW,QAChB,CACH,MAAO,EAAM,OACb,KAAM,EAAM,KAAK,UAGzB,EAAa,GAAG,IAAU,EAAM,KAAK,UAE9BA,EAAM,OAAO,EAAY,SAAY,CACxC,IAAM,EAAM,MAAMC,EAAI,IAAY,GAC5B,EAAU,EAAK,EAAI,MACnB,EAAU,EAAS,EAAU,EAAQ,sBAAsB,KAAK,WAAa,oBAAqB,GAExG,MAAO,CACH,MAAO,EAAM,OACb,UACA,YAAa,EAAQ,SAAS,OAC9B,KAAM,SAO9B,MAAaC,EAAe,CACxB,KAAM,iCACN,WAAY,CAAC,cACb,QAAS,mBACT,WAAY,CAAE,OAAQ,WAAY,UAAW,SAAU,SAAU,MACjE,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,sDAAuD,6CAChE,OAAQ,mCAGhB,KAAM,KACN,YAAa,CAAC,aAAc,UAC5B,UACA,YAAa;;;;;;;;;;;;oBAejB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,SAAQ,YAAW,YAAa,EAAI,IAAI,QAC1C,CAAE,QAAQ,IAAO,EAAI,IAAI,QAC3B,EAAO,GAAG,EAAQ,GAAG,EAAO,GAAG,IAC/B,IACA,GAAQ,IAAI,EAAS,cAEzB,GAAM,CAAE,KAAM,GAAc,MAAMD,EAAI,IAAY,GAE5C,EAAI,EAAK,GAEXE,EAAe,GAGnB,GAAI,IAAW,MAAQ,IAAc,MAAQ,CAAC,EAC1C,EAAQ,MAAM,EAAU,OACrB,CACH,IAAM,EAAkB,EAAE,mCACpB,EAAW,GAAG,IAAU,EAAgB,KAAK,SAC7C,EAAY,KAAK,MAAM,EAAgB,KAAK,cAAc,QAAQ,KAAM,MAAQ,MACtF,EAAU,UAAY,0BAA0B,EAAM,GAEtD,GAAM,CAAE,QAAS,MAAMF,EAAI,IAAgC,EAAU,CACjE,aAAc,IAAI,gBAAgB,KAGtC,EAAQ,MAAM,EAAU,EAAK,KAAK,MAGtC,IAAM,EAAY,EAAE,cAAc,OAElC,MAAO,CACH,MAAO,EACP,OACA,MAAO,sCACP,KAAM"}