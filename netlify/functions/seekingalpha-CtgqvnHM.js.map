{"version":3,"file":"seekingalpha-CtgqvnHM.js","names":[],"sources":["../../lib/routes/seekingalpha/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { art } from '@/utils/render';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport path from 'node:path';\r\n\r\nconst baseUrl = 'https://seekingalpha.com';\r\n\r\nexport const route: Route = {\r\n    path: '/:symbol/:category?',\r\n    categories: ['finance'],\r\n    example: '/seekingalpha/TSM/transcripts',\r\n    parameters: { symbol: 'Stock symbol', category: 'Category, see below, `news` by default' },\r\n    features: {\r\n        antiCrawler: true,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['seekingalpha.com/symbol/:symbol/:category', 'seekingalpha.com/symbol/:symbol/earnings/:category'],\r\n            target: '/:symbol/:category',\r\n        },\r\n    ],\r\n    name: 'Summary',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n    description: `| Analysis | News | Transcripts | Press Releases | Related Analysis |\r\n| -------- | ---- | ----------- | -------------- | ---------------- |\r\n| analysis | news | transcripts | press-releases | related-analysis |`,\r\n};\r\n\r\nconst getMachineCookie = () =>\r\n    cache.tryGet('seekingalpha:machine_cookie', async () => {\r\n        const response = await ofetch.raw(baseUrl);\r\n        return response.headers.getSetCookie().map((c) => c.split(';')[0]);\r\n    });\r\n\r\nconst apiParams = {\r\n    article: {\r\n        slug: '/articles',\r\n        include: 'author,primaryTickers,secondaryTickers,otherTags,presentations,presentations.slides,author.authorResearch,author.userBioTags,co_authors,promotedService,sentiments',\r\n    },\r\n    news: {\r\n        slug: '/news',\r\n        include: 'author,primaryTickers,secondaryTickers,otherTags',\r\n    },\r\n    pr: {\r\n        slug: '/press_releases',\r\n        include: 'acquireService,primaryTickers',\r\n    },\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'news', symbol } = ctx.req.param();\r\n    const pageUrl = `${baseUrl}/symbol/${symbol.toUpperCase()}/${category === 'transcripts' ? `earnings/${category}` : category}`;\r\n\r\n    const machineCookie = await getMachineCookie();\r\n    const response = await ofetch(`${baseUrl}/api/v3/symbols/${symbol.toUpperCase()}/${category}`, {\r\n        headers: {\r\n            cookie: machineCookie.join('; '),\r\n        },\r\n        query: {\r\n            'filter[since]': 0,\r\n            'filter[until]': 0,\r\n            id: symbol.toLowerCase(),\r\n            include: 'author,primaryTickers,secondaryTickers,sentiments',\r\n            'page[size]': ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : category === 'news' ? 40 : 20,\r\n            'page[number]': 1,\r\n        },\r\n    });\r\n\r\n    const list = response.data?.map((item) => ({\r\n        title: item.attributes.title,\r\n        link: new URL(item.links.self, baseUrl).href,\r\n        pubDate: parseDate(item.attributes.publishOn),\r\n        author: response.included.find((i) => i.id === item.relationships.author.data.id).attributes.nick,\r\n        id: item.id,\r\n        articleType: item.links.self.split('/')[1],\r\n    }));\r\n\r\n    const items = list\r\n        ? await Promise.all(\r\n              list.map((item) =>\r\n                  cache.tryGet(item.link, async () => {\r\n                      const response = await ofetch(`${baseUrl}/api/v3${apiParams[item.articleType].slug}/${item.id}`, {\r\n                          headers: {\r\n                              cookie: machineCookie.join('; '),\r\n                          },\r\n                          query: {\r\n                              include: apiParams[item.articleType].include,\r\n                          },\r\n                      });\r\n\r\n                      item.category = response.included.filter((i) => i.type === 'tag').map((i) => (i.attributes.company ? `${i.attributes.company} (${i.attributes.name})` : i.attributes.name));\r\n                      item.description =\r\n                          (response.data.attributes.summary?.length\r\n                              ? art(path.join(__dirname, 'templates/summary.art'), {\r\n                                    summary: response.data.attributes.summary,\r\n                                })\r\n                              : '') + response.data.attributes.content;\r\n                      item.updated = parseDate(response.data.attributes.lastModified);\r\n\r\n                      return item;\r\n                  })\r\n              )\r\n          )\r\n        : [];\r\n\r\n    return {\r\n        title: response.meta.page.title,\r\n        description: response.meta.page.description,\r\n        link: pageUrl,\r\n        image: 'https://seekingalpha.com/samw/static/images/favicon.svg',\r\n        item: items,\r\n        allowEmpty: true,\r\n        language: 'en-US',\r\n    };\r\n}\r\n"],"mappings":"oYAOA,MAAM,EAAU,2BAEH,EAAe,CACxB,KAAM,sBACN,WAAY,CAAC,WACb,QAAS,gCACT,WAAY,CAAE,OAAQ,eAAgB,SAAU,0CAChD,SAAU,CACN,YAAa,IAEjB,MAAO,CACH,CACI,OAAQ,CAAC,4CAA6C,sDACtD,OAAQ,uBAGhB,KAAM,UACN,YAAa,CAAC,UACd,UACA,YAAa;;wEAKX,MACF,EAAM,OAAO,8BAA+B,SAAY,CACpD,IAAM,EAAW,MAAM,EAAO,IAAI,GAClC,OAAO,EAAS,QAAQ,eAAe,IAAK,GAAM,EAAE,MAAM,KAAK,MAGjE,EAAY,CACd,QAAS,CACL,KAAM,YACN,QAAS,sKAEb,KAAM,CACF,KAAM,QACN,QAAS,oDAEb,GAAI,CACA,KAAM,kBACN,QAAS,kCAIjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,OAAQ,UAAW,EAAI,IAAI,QACxC,EAAU,GAAG,EAAQ,UAAU,EAAO,cAAc,GAAG,IAAa,cAAgB,YAAY,IAAa,IAE7G,EAAgB,MAAM,IACtB,EAAW,MAAM,EAAO,GAAG,EAAQ,kBAAkB,EAAO,cAAc,GAAG,IAAY,CAC3F,QAAS,CACL,OAAQ,EAAc,KAAK,OAE/B,MAAO,CACH,gBAAiB,EACjB,gBAAiB,EACjB,GAAI,EAAO,cACX,QAAS,oDACT,aAAc,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,IAAa,OAAS,GAAK,GAChH,eAAgB,KAIlB,EAAO,EAAS,MAAM,IAAK,IAAU,CACvC,MAAO,EAAK,WAAW,MACvB,KAAM,IAAI,IAAI,EAAK,MAAM,KAAM,GAAS,KACxC,QAAS,EAAU,EAAK,WAAW,WACnC,OAAQ,EAAS,SAAS,KAAM,GAAM,EAAE,KAAO,EAAK,cAAc,OAAO,KAAK,IAAI,WAAW,KAC7F,GAAI,EAAK,GACT,YAAa,EAAK,MAAM,KAAK,MAAM,KAAK,MAGtC,EAAQ,EACR,MAAM,QAAQ,IACV,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAM,EAAO,GAAG,EAAQ,SAAS,EAAU,EAAK,aAAa,KAAK,GAAG,EAAK,KAAM,CAC7F,QAAS,CACL,OAAQ,EAAc,KAAK,OAE/B,MAAO,CACH,QAAS,EAAU,EAAK,aAAa,WAa7C,MATA,GAAK,SAAW,EAAS,SAAS,OAAQ,GAAM,EAAE,OAAS,OAAO,IAAK,GAAO,EAAE,WAAW,QAAU,GAAG,EAAE,WAAW,QAAQ,IAAI,EAAE,WAAW,KAAK,GAAK,EAAE,WAAW,MACrK,EAAK,aACA,EAAS,KAAK,WAAW,SAAS,OAC7B,EAAI,EAAA,KAAA,EAAA,kCAA+C,CAC/C,QAAS,EAAS,KAAK,WAAW,UAEtC,IAAM,EAAS,KAAK,WAAW,QACzC,EAAK,QAAU,EAAU,EAAS,KAAK,WAAW,cAE3C,MAInB,GAEN,MAAO,CACH,MAAO,EAAS,KAAK,KAAK,MAC1B,YAAa,EAAS,KAAK,KAAK,YAChC,KAAM,EACN,MAAO,0DACP,KAAM,EACN,WAAY,GACZ,SAAU"}