{"version":3,"file":"user-W5dwqmKt.js","names":["route: Route","cache","ofetch"],"sources":["../../lib/routes/civitai/user.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/user/:username/articles',\r\n    categories: ['program-update'],\r\n    example: '/civitai/user/Chenkin/articles',\r\n    parameters: { username: 'Username' },\r\n    radar: [\r\n        {\r\n            source: ['civitai.com/user/:username', 'civitai.com/user/:username/articles'],\r\n        },\r\n    ],\r\n    name: 'User Article',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { username } = ctx.req.param();\r\n\r\n    const userProfile = await cache.tryGet(`civitai:userProfile:${username}`, async () => {\r\n        const response = await ofetch('https://civitai.com/api/trpc/userProfile.get', {\r\n            query: {\r\n                input: JSON.stringify({ json: { username } }),\r\n            },\r\n        });\r\n        return response.result.data.json;\r\n    });\r\n\r\n    const article = await ofetch('https://civitai.com/api/trpc/article.getInfinite', {\r\n        query: {\r\n            input: JSON.stringify({\r\n                json: {\r\n                    period: 'AllTime',\r\n                    periodMode: 'published',\r\n                    sort: 'Newest',\r\n                    username,\r\n                    includeDrafts: false,\r\n                    pending: true,\r\n                    browsingLevel: 1,\r\n                    excludedTagIds: [415792, 426772, 5188, 5249, 130818, 130820, 133182],\r\n                    cursor: null,\r\n                },\r\n                meta: { values: { cursor: ['undefined'] } },\r\n            }),\r\n        },\r\n    });\r\n\r\n    if (!article.result.data.json.items.length) {\r\n        throw new Error('This user has no articles.');\r\n    }\r\n\r\n    const list = article.result.data.json.items.map((item) => ({\r\n        title: item.title,\r\n        link: `https://civitai.com/articles/${item.id}`,\r\n        id: item.id,\r\n        pubDate: parseDate(item.publishedAt),\r\n        updated: parseDate(item.publishedAt),\r\n        author: item.user?.username,\r\n        category: item.tags.map((tag) => tag.name),\r\n        image: `https://image.civitai.com/xG1nkqKTMzGDvpLrqFT7WA/${item.coverImage.url}/${item.coverImage.name}`,\r\n    }));\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch('https://civitai.com/api/trpc/article.getById', {\r\n                    query: {\r\n                        input: JSON.stringify({ json: { id: item.id } }),\r\n                    },\r\n                });\r\n\r\n                item.description = response.result.data.json.content;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${username} Creator Profile | Civitai`,\r\n        description: userProfile.profile.message.replaceAll('\\n', ' ') || userProfile.profile.bio,\r\n        link: `https://civitai.com/user/${username}/articles`,\r\n        image: userProfile.image,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"oRAKA,MAAaA,EAAe,CACxB,KAAM,2BACN,WAAY,CAAC,kBACb,QAAS,iCACT,WAAY,CAAE,SAAU,YACxB,MAAO,CACH,CACI,OAAQ,CAAC,6BAA8B,yCAG/C,KAAM,eACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,YAAa,EAAI,IAAI,QAEvB,EAAc,MAAMC,EAAM,OAAO,uBAAuB,IAAY,SAAY,CAClF,IAAM,EAAW,MAAMC,EAAO,+CAAgD,CAC1E,MAAO,CACH,MAAO,KAAK,UAAU,CAAE,KAAM,CAAE,iBAGxC,OAAO,EAAS,OAAO,KAAK,OAG1B,EAAU,MAAMA,EAAO,mDAAoD,CAC7E,MAAO,CACH,MAAO,KAAK,UAAU,CAClB,KAAM,CACF,OAAQ,UACR,WAAY,YACZ,KAAM,SACN,WACA,cAAe,GACf,QAAS,GACT,cAAe,EACf,eAAgB,CAAC,OAAQ,OAAQ,KAAM,KAAM,OAAQ,OAAQ,QAC7D,OAAQ,MAEZ,KAAM,CAAE,OAAQ,CAAE,OAAQ,CAAC,oBAKvC,GAAI,CAAC,EAAQ,OAAO,KAAK,KAAK,MAAM,OAChC,MAAU,MAAM,8BAGpB,IAAM,EAAO,EAAQ,OAAO,KAAK,KAAK,MAAM,IAAK,IAAU,CACvD,MAAO,EAAK,MACZ,KAAM,gCAAgC,EAAK,KAC3C,GAAI,EAAK,GACT,QAAS,EAAU,EAAK,aACxB,QAAS,EAAU,EAAK,aACxB,OAAQ,EAAK,MAAM,SACnB,SAAU,EAAK,KAAK,IAAK,GAAQ,EAAI,MACrC,MAAO,oDAAoD,EAAK,WAAW,IAAI,GAAG,EAAK,WAAW,UAGhG,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACND,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAMC,EAAO,+CAAgD,CAC1E,MAAO,CACH,MAAO,KAAK,UAAU,CAAE,KAAM,CAAE,GAAI,EAAK,SAMjD,MAFA,GAAK,YAAc,EAAS,OAAO,KAAK,KAAK,QAEtC,MAKnB,MAAO,CACH,MAAO,GAAG,EAAS,4BACnB,YAAa,EAAY,QAAQ,QAAQ,WAAW;EAAM,MAAQ,EAAY,QAAQ,IACtF,KAAM,4BAA4B,EAAS,WAC3C,MAAO,EAAY,MACnB,KAAM"}