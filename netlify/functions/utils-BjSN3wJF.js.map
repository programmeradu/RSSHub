{"version":3,"file":"utils-BjSN3wJF.js","names":[],"sources":["../../lib/routes/dw/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load, type CheerioAPI } from 'cheerio';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst formatId = '605';\r\n\r\nconst i18n = (word: string, lang: string) => {\r\n    switch (word) {\r\n        case 'Image':\r\n            switch (lang) {\r\n                case 'sq':\r\n                    return 'Fotografi';\r\n                case 'am':\r\n                    return 'ምስል';\r\n                case 'ar':\r\n                    return 'صورة من';\r\n                case 'bn':\r\n                    return 'ছবি';\r\n                case 'bs':\r\n                    return 'Foto';\r\n                case 'bg':\r\n                    return 'Снимка';\r\n                case 'zh':\r\n                    return '图像来源';\r\n                case 'zh-hant':\r\n                    return '圖片來源';\r\n                case 'hr':\r\n                    return 'Foto';\r\n                case 'fa-af':\r\n                    return 'عکس';\r\n                case 'en':\r\n                    return 'Image';\r\n                case 'fr':\r\n                    return 'Image';\r\n                case 'de':\r\n                    return 'Bild';\r\n                case 'el':\r\n                    return 'Εικόνα';\r\n                case 'ha':\r\n                    return 'Hoto';\r\n                case 'hi':\r\n                    return 'तस्वीर';\r\n                case 'id':\r\n                    return 'Foto';\r\n                case 'sw':\r\n                    return 'Picha';\r\n                case 'mk':\r\n                    return 'Фотографија';\r\n                case 'ps':\r\n                    return 'انځور';\r\n                case 'fa-ir':\r\n                    return 'عکس';\r\n                case 'pl':\r\n                    return 'Zdjęcie';\r\n                case 'pt-002':\r\n                    return 'Foto';\r\n                case 'pt-br':\r\n                    return 'Foto';\r\n                case 'ro':\r\n                    return 'Imagine';\r\n                case 'ru':\r\n                    return 'Фото';\r\n                case 'sr':\r\n                    return 'Foto';\r\n                case 'es':\r\n                    return 'Imagen';\r\n                case 'tr':\r\n                    return 'Fotoğraf';\r\n                case 'uk':\r\n                    return 'Фото';\r\n                case 'ur':\r\n                    return 'تصویر';\r\n                default:\r\n                    return 'Image';\r\n            }\r\n        default:\r\n            return word;\r\n    }\r\n};\r\n\r\nconst m3u8tomp4 = (src: string) =>\r\n    src.replace('https://hlsvod.dw.com/i/', 'https://tvdownloaddw-a.akamaihd.net/').replace(',AVC_480x270,AVC_512x288,AVC_640x360,AVC_960x540,AVC_1280x720,AVC_1920x1080,.mp4.csmil/master.m3u8', 'AVC_1920x1080.mp4');\r\n\r\nconst processHtml = ($: CheerioAPI, contentLinks) => {\r\n    $('img').each((_, elem) => {\r\n        try {\r\n            const id = $(elem).attr('data-id');\r\n            const contentLink = contentLinks.find((item) => String(item.targetId) === id);\r\n            $(elem).attr({\r\n                title: contentLink?.name,\r\n                alt: contentLink?.description,\r\n                src: `https://static.dw.com/image/${id}_${formatId}.jpg`,\r\n            });\r\n            $(elem).removeAttr('style');\r\n        } catch {\r\n            // no-empty\r\n        }\r\n    });\r\n    $('video').each((_, elem) => {\r\n        try {\r\n            $(elem).attr('poster', $(elem).attr('data-posterurl'));\r\n        } catch {\r\n            // no-empty\r\n        }\r\n    });\r\n    $('iframe').each((_, elem) => {\r\n        try {\r\n            $(elem).attr('src', $(elem).attr('data-src'));\r\n        } catch {\r\n            // no-empty\r\n        }\r\n    });\r\n    $('svg').remove(); // svg will screw up in a lot of rss readers\r\n};\r\n\r\nconst processContent = (item, content) => {\r\n    const $text = load(content.text);\r\n    processHtml($text, content.contentLinks);\r\n    const liveblog =\r\n        item.type === 'liveblog' && content.posts\r\n            ? art(path.join(__dirname, 'templates/liveblog.art'), {\r\n                  posts: content.posts.map((post) => {\r\n                      const $post = load(post.text);\r\n                      processHtml($post, content.contentLinks);\r\n                      post.text = $post.html();\r\n                      return post;\r\n                  }),\r\n              })\r\n            : undefined;\r\n    const video =\r\n        item.type === 'video' && content.hlsVideoSrc\r\n            ? art(path.join(__dirname, 'templates/video.art'), {\r\n                  hlsVideoSrc: content.hlsVideoSrc,\r\n                  mp4VideoSrc: m3u8tomp4(content.hlsVideoSrc),\r\n                  posterImageUrl: content.posterImageUrl,\r\n              })\r\n            : undefined;\r\n    item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n        teaser: content.teaser,\r\n        video,\r\n        mainImage: $text(`[data-id=\"${content.mainContentImageLink?.targetId}\"]`).length === 0 ? content.mainContentImageLink : undefined,\r\n        // occasionally the text html already includes the main image, testing to see if an image with the same id exists\r\n        text: $text.html(),\r\n        liveblog,\r\n        imageI18n: i18n('Image', item.language),\r\n        formatId,\r\n    });\r\n    if (content.trackingCategories) {\r\n        item.category = content.trackingCategories;\r\n    }\r\n    if (content.firstPersonArray) {\r\n        item.author = content.firstPersonArray.map((person) => person.fullName).join(', ');\r\n    }\r\n    return item;\r\n};\r\n\r\nexport const processItems = async (items) => {\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await got(`https://www.dw.com/graph-api/${item.language}/content/${item.type}/${item.id}`);\r\n                const content = response.data.data.content;\r\n                return processContent(item, content);\r\n            })\r\n        )\r\n    );\r\n    return items;\r\n};\r\n"],"mappings":"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"}