{"version":3,"file":"dsj-DPya9Nl4.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/gov/nrta/dsj.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport pMap from 'p-map';\r\n\r\nexport const route: Route = {\r\n    path: '/nrta/dsj/:category?',\r\n    categories: ['government'],\r\n    example: '/gov/nrta/dsj',\r\n    parameters: { category: '分类，见下表，默认为备案公示' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '电视剧政务平台',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 备案公示 | 发行许可通告 | 重大题材立项     | 重大题材摄制    | 变更通报 |\r\n| -------- | ------------ | ---------------- | --------------- | -------- |\r\n| note     | announce     | importantLixiang | importantShezhi | changing |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'note' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 15;\r\n\r\n    const rootUrl = 'https://dsj.nrta.gov.cn';\r\n    const currentUrl = new URL(`tims/site/views/applications.shanty?appName=${category}`, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    const items = $('img[src=\"/site/styles/default/images/icon_arrow_r.gif\"]')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item).next();\r\n\r\n            const pubDateMatches = item.text().match(/(\\d+年\\d+月)/);\r\n\r\n            return {\r\n                title: item.text(),\r\n                link: new URL(item.prop('href'), rootUrl).href,\r\n                pubDate: pubDateMatches ? parseDate(pubDateMatches[1], ['YYYY年MM月', 'YYYY年M月']) : undefined,\r\n            };\r\n        });\r\n\r\n    const results = await pMap(\r\n        items,\r\n        (item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                content('table').last().remove();\r\n\r\n                item.description = content('td.newstext').html() || content('table').last().parent().parent().html();\r\n\r\n                return item;\r\n            }),\r\n        { concurrency: 5 }\r\n    );\r\n\r\n    return {\r\n        item: results,\r\n        title: `${$('title').text()}-${$('div.headbottom_menu_selected').text()}`,\r\n        link: currentUrl,\r\n        description: $('td').last().text(),\r\n        language: 'zh-cn',\r\n        image: $('img').first().prop('src'),\r\n        author: '国家广播电影电视总局电视剧管理司',\r\n    };\r\n}\r\n"],"mappings":"6XAOA,MAAaA,EAAe,CACxB,KAAM,uBACN,WAAY,CAAC,cACb,QAAS,gBACT,WAAY,CAAE,SAAU,kBACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,UACN,YAAa,CAAC,WACd,UACA,YAAa;;8EAKjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,QAAW,EAAI,IAAI,QAChC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,0BACV,EAAa,IAAI,IAAI,+CAA+C,IAAY,GAAS,KAEzF,CAAE,KAAM,GAAa,MAAMC,EAAI,GAE/B,EAAI,EAAK,GAET,EAAQ,EAAE,2DACX,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAAM,OAEf,IAAM,EAAiB,EAAK,OAAO,MAAM,cAEzC,MAAO,CACH,MAAO,EAAK,OACZ,KAAM,IAAI,IAAI,EAAK,KAAK,QAAS,GAAS,KAC1C,QAAS,EAAiB,EAAU,EAAe,GAAI,CAAC,WAAY,YAAc,IAAA,MAIxF,EAAU,MAAM,EAClB,EACC,GACGC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAMD,EAAI,EAAK,MAE1C,EAAU,EAAK,GAMrB,OAJA,EAAQ,SAAS,OAAO,SAExB,EAAK,YAAc,EAAQ,eAAe,QAAU,EAAQ,SAAS,OAAO,SAAS,SAAS,OAEvF,IAEf,CAAE,YAAa,IAGnB,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAE,SAAS,OAAO,GAAG,EAAE,gCAAgC,SACjE,KAAM,EACN,YAAa,EAAE,MAAM,OAAO,OAC5B,SAAU,QACV,MAAO,EAAE,OAAO,QAAQ,KAAK,OAC7B,OAAQ"}