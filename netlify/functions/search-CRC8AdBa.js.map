{"version":3,"file":"search-CRC8AdBa.js","names":[],"sources":["../../lib/routes/pixabay/search.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/search/:q/:order?',\r\n    categories: ['picture'],\r\n    view: ViewType.Pictures,\r\n    example: '/pixabay/search/cat',\r\n    parameters: {\r\n        q: 'Search term',\r\n        order: {\r\n            description: 'Order',\r\n            options: [\r\n                { value: 'popular', label: 'popular' },\r\n                { value: 'latest', label: 'latest' },\r\n            ],\r\n            default: 'latest',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'PIXABAY_KEY',\r\n                optional: true,\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['pixabay.com/:searchType/search/:q'],\r\n            target: '/search/:q',\r\n        },\r\n    ],\r\n    name: 'Search',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { q, order = 'latest' } = ctx.req.param();\r\n    const key = config.pixabay?.key ?? '7329690-bbadad6d872ba577d5a358679';\r\n    const baseUrl = 'https://pixabay.com';\r\n\r\n    const data = await cache.tryGet(\r\n        `pixabay:search:${q}:${order}`,\r\n        async () => {\r\n            const { data } = await got(`${baseUrl}/api/`, {\r\n                searchParams: {\r\n                    key,\r\n                    q,\r\n                    order,\r\n                    per_page: ctx.req.query('limit') ?? 200,\r\n                },\r\n            });\r\n            return data;\r\n        },\r\n        Math.max(config.cache.contentExpire, 24 * 60 * 60), // required by Pixabay API\r\n        false\r\n    );\r\n\r\n    const items = data.hits.map((item) => {\r\n        const { pageURL, tags, user } = item;\r\n        return {\r\n            title: pageURL\r\n                .substring(pageURL.lastIndexOf('/', pageURL.lastIndexOf('/') - 1) + 1, pageURL.lastIndexOf('/'))\r\n                .replace(/(-\\d+)$/, '')\r\n                .replaceAll('-', ' '),\r\n            description: art(path.join(__dirname, 'templates/img.art'), { item }),\r\n            link: pageURL,\r\n            category: tags.split(', '),\r\n            author: user,\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `Search ${q} - Pixabay`,\r\n        description: 'Download & use free nature stock photos in high resolution ✓ New free images everyday ✓ HD to 4K ✓ Best nature pictures for all devices on Pixabay',\r\n        link: `${baseUrl}/images/search/${q}/${order === 'latest' ? '?order=latest' : ''}`,\r\n        image: `https://pixabay.com/apple-touch-icon.png`,\r\n        language: 'en',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ocAQA,MAAa,EAAe,CACxB,KAAM,qBACN,WAAY,CAAC,WACb,KAAM,EAAS,SACf,QAAS,sBACT,WAAY,CACR,EAAG,cACH,MAAO,CACH,YAAa,QACb,QAAS,CACL,CAAE,MAAO,UAAW,MAAO,WAC3B,CAAE,MAAO,SAAU,MAAO,WAE9B,QAAS,WAGjB,SAAU,CACN,cAAe,CACX,CACI,KAAM,cACN,SAAU,GACV,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,qCACT,OAAQ,eAGhB,KAAM,SACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,IAAG,QAAQ,UAAa,EAAI,IAAI,QAClC,EAAM,EAAO,SAAS,KAAO,oCAC7B,EAAU,sBAEV,EAAO,MAAM,EAAM,OACrB,kBAAkB,EAAE,GAAG,IACvB,SAAY,CACR,GAAM,CAAE,KAAA,GAAS,MAAM,EAAI,GAAG,EAAQ,OAAQ,CAC1C,aAAc,CACV,MACA,IACA,QACA,SAAU,EAAI,IAAI,MAAM,UAAY,OAG5C,OAAO,GAEX,KAAK,IAAI,EAAO,MAAM,cAAe,KAAU,IAC/C,IAGE,EAAQ,EAAK,KAAK,IAAK,GAAS,CAClC,GAAM,CAAE,UAAS,OAAM,QAAS,EAChC,MAAO,CACH,MAAO,EACF,UAAU,EAAQ,YAAY,IAAK,EAAQ,YAAY,KAAO,GAAK,EAAG,EAAQ,YAAY,MAC1F,QAAQ,UAAW,IACnB,WAAW,IAAK,KACrB,YAAa,EAAI,EAAA,KAAA,EAAA,8BAA2C,CAAE,SAC9D,KAAM,EACN,SAAU,EAAK,MAAM,MACrB,OAAQ,KAIhB,MAAO,CACH,MAAO,UAAU,EAAE,YACnB,YAAa,qJACb,KAAM,GAAG,EAAQ,iBAAiB,EAAE,GAAG,IAAU,SAAW,gBAAkB,KAC9E,MAAO,2CACP,SAAU,KACV,KAAM"}