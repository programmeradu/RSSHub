{"version":3,"file":"rsgis-Cu75eZim.js","names":["cache","ofetch","xyxwList: Array<Post>","tzggList: Array<Post>","xsdtList: Array<Post>","xsjzList: Array<Post>","jxdtList: Array<Post>","xgdtList: Array<Post>","urlList: Array<{ url: string; base: string }>","route: Route","itemList: Array<DataItem>"],"sources":["../../lib/routes/whu/rsgis.ts"],"sourcesContent":["import { Route, DataItem } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load, Cheerio, AnyNode } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { Context } from 'hono';\r\nimport cache from '@/utils/cache';\r\n\r\ninterface Post extends DataItem {\r\n    external: boolean;\r\n}\r\n\r\nconst baseUrl = 'https://rsgis.whu.edu.cn';\r\nconst categoryMap = {\r\n    index: {\r\n        name: '首页',\r\n        path: '',\r\n    },\r\n    xyxw: {\r\n        name: '学院新闻',\r\n        path: 'xyxw1',\r\n        sub: {\r\n            xyyw: {\r\n                name: '学院要闻',\r\n                path: 'xyyw2',\r\n            },\r\n            hzjl: {\r\n                name: '合作交流',\r\n                path: 'hzjl',\r\n            },\r\n            mtjj: {\r\n                name: '媒体聚焦',\r\n                path: 'mtjj',\r\n            },\r\n            xgyw: {\r\n                name: '学工要闻',\r\n                path: 'xgyw',\r\n            },\r\n        },\r\n    },\r\n    kxyj: {\r\n        name: '科学研究',\r\n        path: 'kxyj',\r\n        sub: {\r\n            xsbg: {\r\n                name: '学术报告',\r\n                path: 'xsbg',\r\n            },\r\n            xsjl: {\r\n                name: '学术交流',\r\n                path: 'xsjl',\r\n            },\r\n            kycg: {\r\n                name: '学术成果',\r\n                path: 'kycg',\r\n            },\r\n            sbxx: {\r\n                name: '申报信息',\r\n                path: 'sbxx',\r\n            },\r\n        },\r\n    },\r\n    tzgg: {\r\n        name: '通知公告',\r\n        path: 'tzgg1',\r\n        sub: {\r\n            xytz: {\r\n                name: '学院通知',\r\n                path: 'xytz',\r\n            },\r\n            jxdt: {\r\n                name: '教学动态',\r\n                path: 'jxdt',\r\n            },\r\n            xsdt: {\r\n                name: '学术动态',\r\n                path: 'xsdt',\r\n            },\r\n            rcyj: {\r\n                name: '人才引进',\r\n                path: 'rcyj',\r\n            },\r\n        },\r\n    },\r\n};\r\n\r\n/**\r\n * Check whether the link is external.\r\n *\r\n * @param link Post link\r\n * @returns Whether or not weixin post\r\n */\r\nfunction checkExternal(link: string): boolean {\r\n    const matchWeixin = link.match(/^((http:\\/\\/)|(https:\\/\\/))?([\\dA-Za-z]([\\dA-Za-z-]{0,61}[\\dA-Za-z])?\\.)+[A-Za-z]{2,6}(\\/)/);\r\n    return !!matchWeixin?.length;\r\n}\r\n\r\n/**\r\n * Get information from a list of paired link and date.\r\n *\r\n * @param element\r\n * @returns A list of RSS meta node.\r\n */\r\nfunction parseListLinkDateItem(element: Cheerio<AnyNode>, currentUrl: string) {\r\n    const linkElement = element.find('a').first();\r\n    const title = linkElement.text();\r\n    const href = linkElement.attr('href');\r\n    if (href === undefined) {\r\n        throw new Error('Cannot get link');\r\n    }\r\n    const external = checkExternal(href);\r\n    const link = external ? href : new URL(href, currentUrl).href;\r\n    const pubDate = element.find('div.date1').first().text();\r\n    return {\r\n        title,\r\n        link,\r\n        pubDate: timezone(parseDate(pubDate, 'YYYY-MM-DD'), +8),\r\n        description: title,\r\n        external,\r\n    };\r\n}\r\n\r\nasync function getDetail(item: Post): Promise<DataItem | any> {\r\n    const link = item.link;\r\n    return link\r\n        ? await cache.tryGet(`whu:rsgis:${link}`, async () => {\r\n              if (item.external) {\r\n                  item.description = `<a href=\"${link}\">阅读原文</a>`;\r\n              } else {\r\n                  const response = await ofetch(link);\r\n                  const $ = load(response);\r\n                  const title = $('div.content div.content_title h1').first().text();\r\n                  const content = $('div.content div.v_news_content').first().html();\r\n                  item.title = title;\r\n                  item.description = content || '';\r\n              }\r\n              return item;\r\n          })\r\n        : item;\r\n}\r\n\r\n/**\r\n * Process index type.\r\n */\r\nasync function handleIndex(): Promise<Array<Post>> {\r\n    const url = `${baseUrl}/index.htm`;\r\n    const response = await ofetch(url);\r\n    const $ = load(response);\r\n    // 学院新闻\r\n    const xyxwList: Array<Post> = $('div.main1 > div.newspaper:nth-child(1) > div.newspaper_list > ul > li')\r\n        .toArray()\r\n        .map((item) => parseListLinkDateItem($(item), baseUrl));\r\n    // 通知公告\r\n    const tzggList: Array<Post> = $('div.main1 > div.newspaper:nth-child(2) > div.newspaper_list > ul > li')\r\n        .toArray()\r\n        .map((item) => parseListLinkDateItem($(item), baseUrl));\r\n    // 学术动态\r\n    const xsdtList: Array<Post> = $('div.main3 div.inner > div.newspaper:nth-child(1) > ul.newspaper_list2 > li:nth-child(1) > ul > li')\r\n        .toArray()\r\n        .map((item) => parseListLinkDateItem($(item), baseUrl));\r\n    // 学术进展\r\n    const xsjzList: Array<Post> = $('div.main3 div.inner > div.newspaper:nth-child(1) > ul.newspaper_list2 > li:nth-child(2) > ul > li')\r\n        .toArray()\r\n        .map((item) => parseListLinkDateItem($(item), baseUrl));\r\n    // 教学动态\r\n    const jxdtList: Array<Post> = $('div.main3 div.inner > div.newspaper:nth-child(2) > div.newspaper_list2 > ul > li')\r\n        .toArray()\r\n        .map((item) => parseListLinkDateItem($(item), baseUrl));\r\n    // 学工动态\r\n    const xgdtList: Array<Post> = $('div.main3 div.inner > div.newspaper:nth-child(3) > div.newspaper_list2 > ul > li')\r\n        .toArray()\r\n        .map((item) => parseListLinkDateItem($(item), baseUrl));\r\n    // 组合所有新闻\r\n    const fullList = await Promise.all([...xyxwList, ...tzggList, ...xsdtList, ...xsjzList, ...jxdtList, ...xgdtList].map(async (item) => await getDetail(item)));\r\n    return fullList;\r\n}\r\n\r\n/**\r\n * Process non-index types.\r\n *\r\n * @param type Level 1 type\r\n * @param sub Level 2 type\r\n */\r\nasync function handlePostList(type: string, sub: string): Promise<Array<DataItem>> {\r\n    let urlList: Array<{ url: string; base: string }> = [];\r\n    const category = categoryMap[type];\r\n    if (sub === 'all') {\r\n        const subMap = category.sub;\r\n        urlList = Object.keys(subMap).map((key) => {\r\n            const subType = subMap[key];\r\n            return {\r\n                url: `${baseUrl}/${category.path}/${subType.path}.htm`,\r\n                base: `${baseUrl}/${category.path}`,\r\n            };\r\n        });\r\n    } else if (sub in category.sub) {\r\n        urlList.push({\r\n            url: `${baseUrl}/${category.path}/${category.sub[sub].path}.htm`,\r\n            base: `${baseUrl}/${category.path}`,\r\n        });\r\n    } else {\r\n        throw new Error('No such sub type.');\r\n    }\r\n    const urlPosts = await Promise.all(\r\n        urlList.map(async (url) => {\r\n            const response = await ofetch(url.url);\r\n            const $ = load(response);\r\n            return $('div.neiinner > div.nav_right > div.right_inner > div.list > ul > li')\r\n                .toArray()\r\n                .map((item) => parseListLinkDateItem($(item), url.base));\r\n        })\r\n    );\r\n    const fullList = await Promise.all(urlPosts.flat().map(async (item) => await getDetail(item)));\r\n    return fullList;\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/rsgis/:type/:sub?',\r\n    categories: ['university'],\r\n    example: '/whu/rsgis/index',\r\n    parameters: {\r\n        type: '栏目，详见表格',\r\n        sub: '子栏目。当 `type` 为 `index` 的时候不起效；当 `type` 为其他合法值时，默认为 `all` 表示所有子类，其他可选项见下表。',\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['rsgis.whu.edu.cn/index.htm'],\r\n            target: '/rsgis/index',\r\n        },\r\n    ],\r\n    name: '武汉大学遥感信息工程学院',\r\n    maintainers: ['HPDell'],\r\n    description: `\r\n\r\n|  分类名  | \\`type\\` 值 |  子类名  | \\`sub\\` 值 |\r\n| :------: | :-------- | :------: | :------- |\r\n|   首页   | \\`index\\`   |          |          |\r\n| 学院新闻 | \\`xyxw\\`    |   全部   | \\`all\\`    |\r\n|          |           | 学院要闻 | \\`xyyw\\`   |\r\n|          |           | 合作交流 | \\`hzjl\\`   |\r\n|          |           | 媒体聚焦 | \\`mtjj\\`   |\r\n|          |           | 学工要闻 | \\`xgyw\\`   |\r\n| 科学研究 | \\`kxyj\\`    |   全部   | \\`all\\`    |\r\n|          |           | 学术报告 | \\`xsbg\\`   |\r\n|          |           | 学术交流 | \\`xsjl\\`   |\r\n|          |           | 学术成果 | \\`kycg\\`   |\r\n|          |           | 申报信息 | \\`sbxx\\`   |\r\n| 通知公告 | \\`tzgg\\`    |   全部   | \\`all\\`    |\r\n|          |           | 学院通知 | \\`xytz\\`   |\r\n|          |           | 教学动态 | \\`jxdt\\`   |\r\n|          |           | 学术动态 | \\`xsdt\\`   |\r\n|          |           | 人才引进 | \\`rcyj\\`   |\r\n`,\r\n    handler: async (ctx: Context) => {\r\n        const { type = 'index', sub = 'all' } = ctx.req.param();\r\n        let itemList: Array<DataItem> = [];\r\n        switch (type) {\r\n            case 'index':\r\n                itemList = await handleIndex();\r\n                break;\r\n            case 'xyxw':\r\n            case 'kxyj':\r\n            case 'tzgg':\r\n                itemList = await handlePostList(type, sub);\r\n                break;\r\n            default:\r\n                throw new Error('No such type');\r\n        }\r\n\r\n        return {\r\n            title: `${categoryMap[type].name} - 武汉大学遥感信息工程学院`,\r\n            link: baseUrl,\r\n            description: `${categoryMap[type].name} - 武汉大学遥感信息工程学院`,\r\n            item: itemList,\r\n        };\r\n    },\r\n};\r\n"],"mappings":"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"}