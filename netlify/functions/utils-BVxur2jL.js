import{__dirname as e,init_esm_shims as t}from"./esm-shims-Dqvxr0BZ.js";import{cache_default as n}from"./cache-kimkMTWJ.js";import{art as r}from"./render-CxhTJIsl.js";import{parseDate as i}from"./parse-date-Bgabdhlb.js";import{ofetch_default as a}from"./ofetch-Bzt0BXUH.js";import{got_default as o}from"./got-CdvI2yKX.js";import s from"node:path";import{load as c}from"cheerio";import{destr as l}from"destr";t();const u=`https://www.bloomberg.com/feeds`,d={accept:`application/json`,"cache-control":`no-cache`,referer:`https://www.bloomberg.com`},f={articles:{url:`https://www.bloomberg.com/article/api/story/slug/`},features:{url:`https://www.bloomberg.com/article/api/story/slug/`},audio:{url:`https://www.bloomberg.com/news/audio/`,sel:`script#__NEXT_DATA__`},videos:{url:`https://www.bloomberg.com/news/videos/`,sel:`script`},newsletters:{url:`https://www.bloomberg.com/article/api/story/slug/`},"photo-essays":{url:`https://www.bloomberg.com/javelin/api/photo-essay_transporter/`,sel:`script[type = "application/json"][data-component-props]`},"features/":{url:`https://www.bloomberg.com/features/`,sel:`script[id^="article-info"][type="application/json"], script[class^="article-info"][type="application/json"], script#dvz-config`,prop:`id`}},p=/\/(?<page>[\w-]*?)\/(?<link>\d{4}-\d{2}-\d{2}\/.*)/,m=/(?<!news|politics)\/(?<page>features\/|graphics\/)(?<link>.*)/,h=[p,m],g=/<p>|<\/p>/g,_=/<p\b[^>]*>(&nbsp;|\s)<\/p>/g,v=e=>a.raw(e,{headers:d,parseResponse:e=>({data:l(e),body:e})}),y=async(e,t)=>{let n=await o(e),r=c(n.data,{xml:{xmlMode:!0}}),a=r(`urlset url`);return a.toArray().slice(0,t.req.query(`limit`)?Number.parseInt(t.req.query(`limit`)):50).map(e=>{e=r(e);let t={title:e.find(String.raw`news\:title`).text(),link:e.find(`loc`).text(),pubDate:i(e.find(String.raw`news\:publication_date`).text())};return t})},b=e=>n.tryGet(e.link,async()=>{let t=h.map(t=>t.exec(e.link)).filter(e=>e&&e.groups).map(e=>e&&e.groups)[0];if(t){let{page:n,link:r}=t;if(f[n]){let t={...f[n]},i;try{let e=`${t.url}${r}`;i=await v(e)}catch(t){if(t.name&&(t.name===`HTTPError`||t.name===`RequestError`||t.name===`FetchError`))try{i=await v(e.link)}catch{return{title:e.title,link:e.link,pubDate:e.pubDate}}}if(i.redirected&&new URL(i.url).pathname===`/tosv2.html`||i.status===404)return{title:e.title,link:e.link,pubDate:e.pubDate};switch(n){case`audio`:return x(i._data,t,e);case`videos`:return S(i._data,t,e);case`photo-essays`:return C(i._data,t,e);case`features/`:return w(i._data,t,e);default:return T(i._data.data,e)}}}return e}),x=async(e,t,n)=>{let r=JSON.parse(c(e.data)(t.sel).html()).props.pageProps,a=r.episode,o={title:a.title||n.title,link:r.pageInfo.canonicalUrl||n.link,guid:`bloomberg:${a.id}`,description:(await O(a.articleBody,r)).replaceAll(_,``),pubDate:i(a.publishedAt)||n.pubDate,author:r.hero.showTitle,media:{content:{url:a.image},thumbnails:{url:a.image}},enclosure_type:`audio/mpeg`,enclosure_url:a.url,itunes_item_image:a.image||r.pageInfo.image.url};return o},S=async(t,n,a)=>{let o=c(t.data),l=o(n.sel).filter((e,t)=>o(t).text().includes(`__PRELOADED_STATE__`)),u=l.text().trim().match(/window\.__PRELOADED_STATE__ = (.*?);/)?.[1],d=JSON.parse(u||`{}`),f=d.video?.videoStory??d.quicktakeVideo?.videoStory;if(f){let t=await k(f.video.bmmrId,f.summary.html.replaceAll(_,``)),n={title:f.headline.text||a.title,link:f.url||a.link,guid:`bloomberg:${f.id}`,description:r(s.join(e,`templates/video_media-ee86f8e3.art`),t),pubDate:i(f.publishedAt)||a.pubDate,media:{content:{url:f.video?.thumbnail.url||``},thumbnails:{url:f.video?.thumbnail.url||``}},category:t.keywords??[]};return n}return a},C=async(e,t,n)=>{let r=c(e.data.html),i={};for(let e of r(t.sel).toArray())Object.assign(i,JSON.parse(r(e).html()));let a={title:i.headline||n.title,link:i.canonical||n.link,guid:`bloomberg:${i.id}`,description:(await O(i.body,i)).replaceAll(_,``),pubDate:n.pubDate,author:i.authors?.map(e=>e.name).join(`, `)??[]};return a},w=async(e,t,n)=>{let r=c(e.data)(t.sel).text().trim(),i=JSON.parse(r)[t.prop];try{let e=await v(`https://www.bloomberg.com/article/api/story/id/${i}`);return await T(e._data,n)}catch(e){if(e.name&&(e.name===`HTTPError`||e.name===`RequestError`||e.name===`FetchError`))return{title:n.title,link:n.link,pubDate:n.pubDate}}},T=async(e,t)=>{let n=e.ledeImageUrl||Object.values(e.imageAttachments??{})[0]?.url,r={title:e.headline||t.title,link:e.url||t.link,guid:`bloomberg:${e.id}`,description:E(e)+await D(e)+await P(e.body||``),pubDate:i(e.publishedAt)||t.pubDate,author:e.authors?.map(e=>e.name).join(`, `)??[],category:e.mostRelevantTags??[],media:{content:{url:n},thumbnails:{url:n}}};return r},E=e=>{let t=e.dek||e.summary||e.headline||``,n=e.abstract?.map(e=>`<li>${e}</li>`).join(``);return n?t+`<ul>${n}</ul>`:t},D=async t=>{if(t.ledeMediaKind){let n=t.ledeMediaKind,i={kind:t.ledeMediaKind,caption:t.ledeCaption?.replaceAll(g,``)??``,description:t.ledeDescription?.replaceAll(g,``)??``,credit:t.ledeCredit?.replaceAll(g,``)??``,src:t.ledeImageUrl,video:n===`video`&&await k(t.ledeAttachment.bmmrId)};return r(s.join(e,`templates/lede_media-f0d122f0.art`),{media:i})}else if(t.lede){let n=t.lede,i={src:n.url,alt:n.alt||n.title,caption:n.caption?.replaceAll(g,``)??``,credit:n.credit?.replaceAll(g,``)??``};return r(s.join(e,`templates/image_figure-c0daa754.art`),i)}else if(t.imageAttachments){let n=Object.values(t.imageAttachments)[0];if(n){let t={src:n.baseUrl||n.url,alt:n.alt||n.title,caption:n.caption?.replaceAll(g,``)??``,credit:n.credit?.replaceAll(g,``)??``};return r(s.join(e,`templates/image_figure-c0daa754.art`),t)}return``}else if(t.type===`Lede`){let n=t.props,i={kind:n.media,caption:n.caption?.replaceAll(g,``)??``,description:n.dek?.replaceAll(g,``)??``,credit:n.credit?.replaceAll(g,``)??``,src:n.url};return r(s.join(e,`templates/lede_media-f0d122f0.art`),{media:i})}},O=async(t,n)=>{let i=[`meta`,`script`,`*[class$="-footnotes"]`,`*[class$="for-you"]`,`*[class$="-newsletter"]`,`*[class$="page-ad"]`,`*[class$="-recirc"]`,`*[data-ad-placeholder="Advertisement"]`],a=c(t);for(let e of i)a(e).remove();a(`.paywall`).removeAttr(`class`);for await(let t of a(`figure`)){let i=a(t).data(`image-type`),o=a(t).data(`type`),c=``;if(i===`audio`){let i={};if(n.audios){let e=n.audios.find(e=>e.id.toString()===a(t).data(`id`).toString());i={img:e.image?.url||a(t).find(`img`).attr(`src`),src:e.url||a(t).find(`audio source`).attr(`src`),caption:a(t).find(`[class$="text"]`).html()?.trim()??``,credit:a(t).find(`[class$="credit"]`).html()?.trim()??``}}if(n.episode){let e=n.episode;i={src:e.url,img:e.image||n.pageInfo.image.url,caption:e.description||(a(t).find(`[class$="text"]`).html()?.trim()??``),credit:(e.credits.map(e=>e.name).join(`, `)??[])||(a(t).find(`[class$="credit"]`).html()?.trim()??``)}}c=r(s.join(e,`templates/audio_media-3ad40417.art`),i)}else if(i===`video`){if(n.videoAttachments){let i=n.videoAttachments[a(t).data(`id`)],o=await k(i.bmmrId);c=r(s.join(e,`templates/video_media-ee86f8e3.art`),o)}}else if(i===`photo`||i===`image`||o===`image`){let i,o;if(n.imageAttachments){let e=n.imageAttachments[a(t).data(`id`)];o=e?.alt||a(t).find(`img`).attr(`alt`)?.trim(),i=e?.baseUrl}else o=a(t).find(`img`).attr(`alt`).trim(),i=a(t).find(`img`).data(`native-src`);let l=a(t).find(`[class$="text"], .caption, .photo-essay__text`).html()?.trim()??``,u=a(t).find(`[class$="credit"], .credit, .photo-essay__source`).html()?.trim()??``,d={src:i,alt:o,caption:l,credit:u};c=r(s.join(e,`templates/image_figure-c0daa754.art`),d)}a(c).insertAfter(t),a(t).remove()}return a.html()},k=async(e,t)=>{let n=`https://www.bloomberg.com/multimedia/api/embed?id=${e}`,r=await v(n);if(r.redirected&&new URL(r.url).pathname===`/tosv2.html`||r.status===404)return{stream:``,mp4:``,coverUrl:``,caption:t};if(r._data.data){let e=r._data.data;return{stream:e.streams?e.streams[0]?.url:``,mp4:e.downloadURLs?e.downloadURLs[600]:``,coverUrl:e.thumbnail?.baseUrl??``,caption:e.description||e.title||t}}return{stream:``,mp4:``,coverUrl:``,caption:t}},A={paragraph:async(e,t)=>`<p>${await t(e.content)}</p>`,text:e=>{let{attributes:t,value:n}=e;return t?.emphasis&&t?.strong?`<strong><em>${n}</em></strong>`:t?.emphasis?`<em>${n}</em>`:t?.strong?`<strong>${n}</strong>`:n},"inline-newsletter":async(e,t)=>`<div>${await t(e.content)}</div>`,"inline-recirc":async(e,t)=>`<div>${await t(e.content)}</div>`,heading:async(e,t)=>{let n=e.data;if(n.level===2||n.level===3)return`<h3>${await t(e.content)}</h3>`},link:async(e,t)=>{let n=e.data.destination,r=n.web,i=n.bbg,a=e.data.title;if(r)return`<a href="${r}" title="${a}" target="_blank">${await t(e.content)}</a>`;if(i&&i.startsWith(`bbg://news/stories`)){let n=i.split(`bbg://news/stories/`).pop(),r=`https://www.bloomberg.com/news/terminal/${n}`;return`<a href="${r}" title="${a}" target="_blank">${await t(e.content)}</a>`}return String(await t(e.content))},entity:async(e,t)=>{let n=e.subType,r=e.data.link.destination,i=r.web;if(n===`person`)return t(e.content);if(n===`story`){if(i)return`<a href="${i}" target="_blank">${await t(e.content)}</a>`;let n=e.data.story.identifiers.suid,r=`https://www.bloomberg.com/news/terminal/${n}`;return`<a href="${r}" target="_blank">${await t(e.content)}</a>`}if(n===`security`){let n=e.data.security.identifiers.parsekey;if(n){let r=n.split(` `),i=[...`https://www.bloomberg.com/quote/${r[0]}:`,r[1]];return`<a href="${i}" target="_blank">${await t(e.content)}</a>`}}return t(e.content)},br:()=>`<br/>`,hr:()=>`<br/>`,ad:()=>{},blockquote:async(e,t)=>`<blockquote>${await t(e.content)}</blockquote>`,quote:async(e,t)=>`<blockquote>${await t(e.content)}</blockquote>`,aside:async(e,t)=>`<aside>${await t(e.content)}</aside>`,list:async(e,t)=>{let n=e.subType;if(n===`unordered`)return`<ul>${await t(e.content)}</ul>`;if(n===`ordered`)return`<ol>${await t(e.content)}</ol>`},listItem:async(e,t)=>`<li>${await t(e.content)}</li>`,media:async t=>{let n=t.subType;if(n===`chart`&&t.data.attachment){if(t.data.attachment.creator===`TOASTER`){let n=t.data.chart,i={src:n&&n.fallback||``,chart:t.data.attachment,id:n&&n.id||``,alt:n&&n.alt||``},a=i.chart,o={source:a.source,footnote:a.footnote,url:a.url,title:a.title,subtitle:a.subtitle,chartId:`toaster-chart-${i.id}`,chartAlt:i.alt,fallback:i.src};return r(s.join(e,`templates/chart_media-12851ed6.art`),{chart:o})}let n={alt:t.data.attachment?.footnote||``,caption:t.data.attachment?.title+t.data.attachment.subtitle||``,credit:t.data.attachment?.source||``,src:t.data.chart?.fallback||``};return r(s.join(e,`templates/image_figure-c0daa754.art`),n)}if(n===`photo`){let n=t.data,i=``;if(n.attachment){let t={src:n.photo?.src,alt:n.photo?.alt,caption:n.photo?.caption,credit:n.photo?.credit};i=r(s.join(e,`templates/image_figure-c0daa754.art`),t)}if(n.link&&n.link.destination&&n.link.destination.web){let e=n.link.destination.web;return`<a href="${e}" target="_blank">${i}</a>`}return i}if(n===`video`){let n=t.data,i=n.attachment?.id;if(i){let t=await k(i,n.attachment?.title);return r(s.join(e,`templates/video_media-ee86f8e3.art`),t)}}if(n===`audio`&&t.data.attachment){let n=t.data.attachment,i=n.title,a=n.url,o=n.image;if(i&&a){let t={src:a,img:o.url,caption:i,credit:``};return r(s.join(e,`templates/audio_media-3ad40417.art`),t)}}return``},tabularData:async(e,t)=>`<table>${await t(e.content)}</table>`,columns:e=>{let t=e.data.definitions.map(e=>({title:e.title,span:e.colSpan||1,type:e.dataType})).map(e=>`<th colspan=${e.span}>${e.title}</th>`);return`<tr>${t}</tr>`},row:async(e,t)=>`<tr>${await t(e.content)}</tr>`,cell:async(e,t)=>{let n={"news-rsf-table-number":`number`,"news-rsf-table-string":`text`},r=n[e.data.class]||`text`;return`<td data-coltype=${r} colspan=${e.data.colspan}>${await t(e.content)}</td>`}},j=async e=>{let t=await N(e);return t},M=async(e,t)=>{if(!e.type||!A[e.type])return`<node>${e.type}</node>`;let n=await A[e.type](e,j,t);return n},N=async e=>{let t=await Promise.all(e.map(async(t,n)=>{let r=await M(t,{index:n,prev:e[n-1]?.type,next:e[n+1]?.type});return r}));return t.join(``)},P=async e=>{if(!e||!e.content)return``;let t=await N(e.content);return t};export{b as parseArticle,y as parseNewsList,u as rootUrl};
//# sourceMappingURL=utils-BVxur2jL.js.map