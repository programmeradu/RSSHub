{"version":3,"file":"mysql-cqDDKL_U.js","names":["limit: number","baseUrl: string","targetUrl: string","ofetch","$: CheerioAPI","items: DataItem[]","$monthlyEl: Cheerio<Element>","monthlyUrl: string | undefined","$$: CheerioAPI","$$el: Cheerio<Element>","title: string","linkUrl: string | undefined","pubDateStr: string | undefined","upDatedStr: string | undefined","processedItem: DataItem","cache","description: string | undefined","authorEls: Element[]","authors: DataItem['author']","$$authorEl: Cheerio<Element>","route: Route"],"sources":["../../lib/routes/taobao/mysql.ts"],"sourcesContent":["import { type Data, type DataItem, type Route, ViewType } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nimport { type CheerioAPI, type Cheerio, load } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport { type Context } from 'hono';\r\n\r\nexport const handler = async (ctx: Context): Promise<Data> => {\r\n    const limit: number = Number.parseInt(ctx.req.query('limit') ?? '30', 10);\r\n\r\n    const baseUrl: string = 'http://mysql.taobao.org';\r\n    const targetUrl: string = new URL('monthly/', baseUrl).href;\r\n\r\n    const response = await ofetch(targetUrl);\r\n    const $: CheerioAPI = load(response);\r\n    const language = $('html').attr('lang') ?? 'zh';\r\n\r\n    let items: DataItem[] = [];\r\n    let count = 0;\r\n\r\n    items = await Promise.all(\r\n        $('h3 a.main')\r\n            .toArray()\r\n            .map(async (monthlyEl): Promise<Element[] | undefined> => {\r\n                const $monthlyEl: Cheerio<Element> = $(monthlyEl);\r\n\r\n                const monthlyUrl: string | undefined = $monthlyEl.attr('href') ? new URL($monthlyEl.attr('href') as string, baseUrl).href : undefined;\r\n\r\n                if (!monthlyUrl) {\r\n                    return undefined;\r\n                }\r\n\r\n                const monthlyResponse = await ofetch(monthlyUrl);\r\n\r\n                const $$: CheerioAPI = load(monthlyResponse);\r\n\r\n                return $$('h3 a.main')\r\n                    .toArray()\r\n                    .map((el): Element => {\r\n                        if (count < limit) {\r\n                            const $$el: Cheerio<Element> = $$(el);\r\n\r\n                            const title: string = $$el.text();\r\n                            const linkUrl: string | undefined = $$el.attr('href');\r\n                            const pubDateStr: string | undefined = linkUrl?.split(/monthly\\//).pop();\r\n                            const upDatedStr: string | undefined = pubDateStr;\r\n\r\n                            const processedItem: DataItem = {\r\n                                title,\r\n                                pubDate: pubDateStr ? parseDate(pubDateStr) : undefined,\r\n                                link: linkUrl ? new URL(linkUrl, baseUrl).href : undefined,\r\n                                updated: upDatedStr ? parseDate(upDatedStr) : undefined,\r\n                                language,\r\n                            };\r\n                            count++;\r\n                            return processedItem;\r\n                        }\r\n                        return undefined;\r\n                    })\r\n                    .filter(Boolean);\r\n            })\r\n    );\r\n\r\n    items = await Promise.all(\r\n        items\r\n            .filter(Boolean)\r\n            .flat()\r\n            .slice(0, limit)\r\n            .map((item) => {\r\n                if (!item.link) {\r\n                    return item;\r\n                }\r\n\r\n                return cache.tryGet(item.link, async (): Promise<DataItem> => {\r\n                    const detailResponse = await ofetch(item.link);\r\n                    const $$: CheerioAPI = load(detailResponse);\r\n\r\n                    const title: string = $$('h2').first().text()?.trim() || item.title;\r\n                    const description: string | undefined = $$('div.content').html() ?? undefined;\r\n                    const pubDateStr: string | undefined = item.link.split(/monthly\\//).pop();\r\n                    const authorEls: Element[] = $$('div.block p').toArray();\r\n                    const authors: DataItem['author'] = authorEls.map((authorEl) => {\r\n                        const $$authorEl: Cheerio<Element> = $$(authorEl);\r\n\r\n                        return {\r\n                            name: $$authorEl.text().split(/:/).pop()?.trim() ?? '',\r\n                            url: undefined,\r\n                            avatar: undefined,\r\n                        };\r\n                    });\r\n                    const upDatedStr: string | undefined = pubDateStr;\r\n\r\n                    const processedItem: DataItem = {\r\n                        title,\r\n                        description,\r\n                        pubDate: pubDateStr ? parseDate(pubDateStr) : item.pubDate,\r\n                        author: authors,\r\n                        content: {\r\n                            html: description,\r\n                            text: description,\r\n                        },\r\n                        updated: upDatedStr ? parseDate(upDatedStr) : item.updated,\r\n                        language,\r\n                    };\r\n\r\n                    return {\r\n                        ...item,\r\n                        ...processedItem,\r\n                    };\r\n                });\r\n            })\r\n    );\r\n\r\n    const title: string = $('title').text();\r\n\r\n    return {\r\n        title,\r\n        description: $('meta[name=\"description\"]').attr('content'),\r\n        link: targetUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        author: title,\r\n        language,\r\n        id: targetUrl,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/mysql/monthly',\r\n    name: '数据库内核月报',\r\n    url: 'mysql.taobao.org',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/taobao/mysql/monthly',\r\n    parameters: undefined,\r\n    description: undefined,\r\n    categories: ['programming'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['mysql.taobao.org/monthly/'],\r\n            target: '/mysql/monthly',\r\n        },\r\n    ],\r\n    view: ViewType.Articles,\r\n};\r\n"],"mappings":"kWAUA,MAAa,EAAU,KAAO,IAAgC,CAC1D,IAAMA,EAAgB,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,KAAM,IAEhEC,EAAkB,0BAClBC,EAAoB,IAAI,IAAI,WAAY,GAAS,KAEjD,EAAW,MAAMC,EAAO,GACxBC,EAAgB,EAAK,GACrB,EAAW,EAAE,QAAQ,KAAK,SAAW,KAEvCC,EAAoB,GACpB,EAAQ,EAEZ,EAAQ,MAAM,QAAQ,IAClB,EAAE,aACG,UACA,IAAI,KAAO,IAA8C,CACtD,IAAMC,EAA+B,EAAE,GAEjCC,EAAiC,EAAW,KAAK,QAAU,IAAI,IAAI,EAAW,KAAK,QAAmB,GAAS,KAAO,IAAA,GAE5H,GAAI,CAAC,EACD,OAGJ,IAAM,EAAkB,MAAMJ,EAAO,GAE/BK,EAAiB,EAAK,GAE5B,OAAO,EAAG,aACL,UACA,IAAK,GAAgB,CAClB,GAAI,EAAQ,EAAO,CACf,IAAMC,EAAyB,EAAG,GAE5BC,EAAgB,EAAK,OACrBC,EAA8B,EAAK,KAAK,QACxCC,EAAiC,GAAS,MAAM,aAAa,MAC7DC,EAAiC,EAEjCC,EAA0B,CAC5B,MAAA,EACA,QAAS,EAAa,EAAU,GAAc,IAAA,GAC9C,KAAM,EAAU,IAAI,IAAI,EAAS,GAAS,KAAO,IAAA,GACjD,QAAS,EAAa,EAAU,GAAc,IAAA,GAC9C,YAGJ,MADA,KACO,KAId,OAAO,YAIxB,EAAQ,MAAM,QAAQ,IAClB,EACK,OAAO,SACP,OACA,MAAM,EAAG,GACT,IAAK,GACG,EAAK,KAIHC,EAAM,OAAO,EAAK,KAAM,SAA+B,CAC1D,IAAM,EAAiB,MAAMZ,EAAO,EAAK,MACnCK,EAAiB,EAAK,GAEtBE,EAAgB,EAAG,MAAM,QAAQ,QAAQ,QAAU,EAAK,MACxDM,EAAkC,EAAG,eAAe,QAAU,IAAA,GAC9DJ,EAAiC,EAAK,KAAK,MAAM,aAAa,MAC9DK,EAAuB,EAAG,eAAe,UACzCC,EAA8B,EAAU,IAAK,GAAa,CAC5D,IAAMC,EAA+B,EAAG,GAExC,MAAO,CACH,KAAM,EAAW,OAAO,MAAM,KAAK,OAAO,QAAU,GACpD,IAAK,IAAA,GACL,OAAQ,IAAA,MAGVN,EAAiC,EAEjCC,EAA0B,CAC5B,MAAA,EACA,cACA,QAAS,EAAa,EAAU,GAAc,EAAK,QACnD,OAAQ,EACR,QAAS,CACL,KAAM,EACN,KAAM,GAEV,QAAS,EAAa,EAAU,GAAc,EAAK,QACnD,YAGJ,MAAO,CACH,GAAG,EACH,GAAG,KArCA,IA2CvB,IAAMJ,EAAgB,EAAE,SAAS,OAEjC,MAAO,CACH,QACA,YAAa,EAAE,4BAA4B,KAAK,WAChD,KAAM,EACN,KAAM,EACN,WAAY,GACZ,OAAQ,EACR,WACA,GAAI,IAICU,EAAe,CACxB,KAAM,iBACN,KAAM,UACN,IAAK,mBACL,YAAa,CAAC,WACd,UACA,QAAS,wBACT,WAAY,IAAA,GACZ,YAAa,IAAA,GACb,WAAY,CAAC,eACb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,aAAc,GACd,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,6BACT,OAAQ,mBAGhB,KAAM,EAAS"}