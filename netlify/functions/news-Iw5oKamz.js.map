{"version":3,"file":"news-Iw5oKamz.js","names":["route: Route","got"],"sources":["../../lib/routes/wsj/utils.ts","../../lib/routes/wsj/news.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport randUserAgent from '@/utils/rand-user-agent';\r\n\r\nconst UA = randUserAgent({ browser: 'chrome', os: 'android', device: 'mobile' });\r\n\r\n// const chromeMobileUserAgent = 'Mozilla/5.0 (Linux; Android 7.0; SM-G892A Build/NRD90M; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/67.0.3396.87 Mobile Safari/537.36';\r\nconst parseArticle = (item) =>\r\n    cache.tryGet(item.link, async () => {\r\n        // Fetch the AMP version\r\n        const url = item.link.replace(/(?<=^https:\\/\\/\\w+\\.wsj\\.com)/, '/amp');\r\n        const response = await got({\r\n            url,\r\n            method: 'get',\r\n            headers: {\r\n                'User-Agent': UA,\r\n            },\r\n        });\r\n        const html = response.data;\r\n        const $ = load(html);\r\n\r\n        // Summary\r\n        const summary = $('head > meta[name=\"description\"]').attr('content');\r\n\r\n        // Metadata (categories & updatedAt)\r\n        const updatedAt = $('meta[itemprop=\"dateModified\"]').attr('content');\r\n        const publishedAt = $('meta[itemprop=\"datePublished\"]').attr('content');\r\n        const author = $('.author > a[rel=\"author\"]').text();\r\n\r\n        const categories = $('meta[name=\"keywords\"]')\r\n            .attr('content')\r\n            .split(',')\r\n            .map((c) => c.trim());\r\n\r\n        const article = $('article');\r\n        item.subTitle = $('h2.sub-head').html();\r\n\r\n        // Remove podcast\r\n        article.find('.media-object-podcast').remove();\r\n\r\n        // Authors\r\n        article.find('.bylineWrap').each((i, e) => {\r\n            $(e)\r\n                .find('p')\r\n                .each(function () {\r\n                    $(this).replaceWith($(this).html());\r\n                });\r\n        });\r\n\r\n        // Images\r\n        article.find('.bigTop-hero').each((i, e) => {\r\n            // console.log($(e).html());\r\n            const imgSrc = $(e).find('amp-img').attr('src');\r\n            const imgAlt = $(e).find('amp-img').attr('alt');\r\n            const figCaption = $(e).find('.imageCaption').text().trim();\r\n            const figCredit = $(e).find('.imageCredit').text().trim();\r\n            const fig = $(`<figure><img src=\"${imgSrc}\" alt=\"${imgAlt}\"><figcaption>${figCaption} <span>${figCredit}</span></figcaption></figure>`);\r\n            $(fig).insertBefore(e);\r\n            $(e).remove();\r\n        });\r\n        article.find('amp-img').each((i, e) => {\r\n            const img = $(`<img width=\"${e.attribs.width}\" height=\"${e.attribs.height}\" src=\"${e.attribs.src}\" alt=\"${e.attribs.alt}\">`);\r\n\r\n            // Caption follows, no need to handle caption\r\n            $(img).insertBefore(e);\r\n            $(e).remove();\r\n        });\r\n\r\n        // iframes (youtube videos and interactive elements)\r\n        article.find('amp-iframe').each((i, e) => {\r\n            const iframe = $(`<iframe width=\"${e.attribs.width}\" height=\"${e.attribs.height}\" src=\"${e.attribs.src}\">`);\r\n            $(iframe).insertBefore(e);\r\n            $(e).remove();\r\n        });\r\n\r\n        // Remove unwanted DOMs\r\n        const unwanted_element_selectors = ['amp-ad', '.wsj-ad', 'h1', 'h2', '.zonedModule', '.snippet', '.newsletter-inset'];\r\n        for (const selector of unwanted_element_selectors) {\r\n            article.find(selector).each((i, e) => {\r\n                $(e).remove();\r\n            });\r\n        }\r\n\r\n        // Paywall\r\n        article.find('.paywall').each((i, e) => {\r\n            // Caption follows, no need to handle caption\r\n            $(e.childNodes).insertBefore(e);\r\n            $(e).remove();\r\n        });\r\n        item.article = article.html();\r\n        item.description = art(path.join(__dirname, 'templates/article-description.art'), {\r\n            item,\r\n        });\r\n\r\n        return {\r\n            title: item.title,\r\n            pubDate: parseDate(publishedAt),\r\n            updated: parseDate(updatedAt),\r\n            author,\r\n            link: item.link,\r\n            summary,\r\n            description: item.description,\r\n            category: categories,\r\n            icon: 'https://s.wsj.net/media/wsj_launcher-icon-4x.png',\r\n            logo: 'https://vir.wsj.net/fp/assets/webpack4/img/wsj-logo-big-black.165e51cc.svg',\r\n        };\r\n    });\r\n\r\nexport { parseArticle };\r\n","import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseArticle } from './utils';\r\nimport pMap from 'p-map';\r\nconst hostMap = {\r\n    'en-us': 'https://www.wsj.com',\r\n    'zh-cn': 'https://cn.wsj.com/zh-hans',\r\n    'zh-tw': 'https://cn.wsj.com/zh-hant',\r\n};\r\nexport const route: Route = {\r\n    path: '/:lang/:category?',\r\n    categories: ['traditional-media'],\r\n    example: '/wsj/en-us/opinion',\r\n    parameters: { lang: 'Language, `en-us`, `zh-cn`, `zh-tw`', category: 'Category. See below' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'News',\r\n    maintainers: ['oppilate'],\r\n    handler,\r\n    description: `en\\_us\r\n\r\n| World | U.S. | Politics | Economy | Business | Tech       | Markets | Opinion | Books & Arts | Real Estate | Life & Work | Sytle               | Sports |\r\n| ----- | ---- | -------- | ------- | -------- | ---------- | ------- | ------- | ------------ | ----------- | ----------- | ------------------- | ------ |\r\n| world | us   | politics | economy | business | technology | markets | opinion | books-arts   | realestate  | life-work   | style-entertainment | sports |\r\n\r\n  zh-cn / zh-tw\r\n\r\n| 国际  | 中国  | 金融市场 | 经济    | 商业     | 科技       | 派        | 专栏与观点 |\r\n| ----- | ----- | -------- | ------- | -------- | ---------- | --------- | ---------- |\r\n| world | china | markets  | economy | business | technology | life-arts | opinion    |\r\n\r\n  Provide full article RSS for WSJ topics.`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const lang = ctx.req.param('lang');\r\n    const category = ctx.req.param('category') || '';\r\n    const host = hostMap[lang];\r\n    let subTitle = ` - ${lang.toUpperCase()}`;\r\n    let url = host;\r\n    if (category.length > 0) {\r\n        url = `${host}/news/${category}`;\r\n        subTitle = `${subTitle} - ${category}`;\r\n    }\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n    const contents = $('script:contains(\"window.__STATE__\")').text();\r\n    const data = JSON.parse(contents.match(/{.*}/)[0]).data;\r\n    const filteredKeys = Object.entries(data)\r\n        .filter(([key, value]) => {\r\n            if (!key.startsWith('article')) {\r\n                return false;\r\n            }\r\n            const link = value.data.data.url;\r\n            return link.includes('wsj.com/articles/');\r\n        })\r\n        .map(([key]) => key);\r\n    const list = filteredKeys.map((key) => {\r\n        const item = {};\r\n        item.title = data[key].data.data.headline;\r\n        item.link = data[key].data.data.url;\r\n        item.test = key;\r\n        return item;\r\n    });\r\n    const items = await pMap(list, (item) => parseArticle(item), { concurrency: 10 });\r\n\r\n    return {\r\n        title: `WSJ${subTitle}`,\r\n        link: url,\r\n        description: `WSJ${subTitle}`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}