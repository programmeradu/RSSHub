{"version":3,"file":"common-XV9NOkcV.js","names":[],"sources":["../../lib/routes/wnacg/common.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nconst categories = {\r\n    1: '同人誌 漢化',\r\n    2: '同人誌 CG畫集',\r\n    3: '同人誌 Cosplay',\r\n    5: '同人誌',\r\n    6: '單行本',\r\n    7: '雜誌&短篇',\r\n    9: '單行本 漢化',\r\n    10: '雜誌&短篇 漢化',\r\n    12: '同人誌 日語',\r\n    13: '單行本 日語',\r\n    14: '雜誌&短篇 日語',\r\n    16: '同人誌 English',\r\n    17: '單行本 English',\r\n    18: '雜誌&短篇 English',\r\n    19: '韓漫',\r\n    20: '韓漫 漢化',\r\n    21: '韓漫 生肉',\r\n    22: '同人誌 3D漫畫',\r\n};\r\n\r\nconst baseUrl = 'https://www.wnacg.com';\r\n\r\nexport async function handler(ctx) {\r\n    const { cid, tag } = ctx.req.param();\r\n    if (cid && !Object.keys(categories).includes(cid)) {\r\n        throw new InvalidParameterError('此分类不存在');\r\n    }\r\n\r\n    const url = `${baseUrl}/albums${cid ? `-index-cate-${cid}` : ''}${tag ? `-index-tag-${tag}` : ''}.html`;\r\n    const { data } = await got(url);\r\n    const $ = load(data);\r\n\r\n    const list = $('.gallary_item')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            const href = item.find('a').attr('href');\r\n            const aid = href.match(/^\\/photos-index-aid-(\\d+)\\.html$/)[1];\r\n            return {\r\n                title: item.find('a').attr('title'),\r\n                link: `${baseUrl}${href}`,\r\n                pubDate: parseDate(\r\n                    item\r\n                        .find('.info_col')\r\n                        .text()\r\n                        .replace(/\\d+張照片，\\n創建於/, ''),\r\n                    'YYYY-MM-DD'\r\n                ),\r\n                aid,\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: descRes } = await got(item.link, {\r\n                    headers: {\r\n                        referer: encodeURI(url),\r\n                    },\r\n                });\r\n                let $ = load(descRes);\r\n                const author = $('.uwuinfo p').first().text();\r\n                const category = $('.tagshow')\r\n                    .toArray()\r\n                    .map((item) => $(item).text());\r\n                $('.addtags').remove();\r\n                const description = $('.uwconn').html();\r\n\r\n                const { data } = await got(`${baseUrl}/photos-gallery-aid-${item.aid}.html`, {\r\n                    headers: {\r\n                        referer: `${baseUrl}/photos-slide-aid-${item.aid}.html`,\r\n                    },\r\n                });\r\n                $ = load(data);\r\n\r\n                const imgListMatch = $('script')\r\n                    .text()\r\n                    .match(/var imglist = (\\[.*]);\"\\);/)[1];\r\n\r\n                const imgList = JSON.parse(imgListMatch.replaceAll('url:', '\"url\":').replaceAll('caption:', '\"caption\":').replaceAll('fast_img_host+\\\\', '').replaceAll('\\\\', ''));\r\n\r\n                item.author = author;\r\n                item.category = category;\r\n                item.description = art(path.join(__dirname, 'templates/manga.art'), {\r\n                    description,\r\n                    imgList,\r\n                });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('head title').text(),\r\n        link: url,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"oZAQA,MAAM,EAAa,CACf,EAAG,SACH,EAAG,WACH,EAAG,cACH,EAAG,MACH,EAAG,MACH,EAAG,QACH,EAAG,SACH,GAAI,WACJ,GAAI,SACJ,GAAI,SACJ,GAAI,WACJ,GAAI,cACJ,GAAI,cACJ,GAAI,gBACJ,GAAI,KACJ,GAAI,QACJ,GAAI,QACJ,GAAI,YAGF,EAAU,wBAEhB,eAAsB,EAAQ,EAAK,CAC/B,GAAM,CAAE,MAAK,OAAQ,EAAI,IAAI,QAC7B,GAAI,GAAO,CAAC,OAAO,KAAK,GAAY,SAAS,GACzC,MAAM,IAAI,EAAsB,UAGpC,IAAM,EAAM,GAAG,EAAQ,SAAS,EAAM,eAAe,IAAQ,KAAK,EAAM,cAAc,IAAQ,GAAG,OAC3F,CAAE,QAAS,MAAM,EAAI,GACrB,EAAI,EAAK,GAET,EAAO,EAAE,iBACV,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GACT,IAAM,EAAO,EAAK,KAAK,KAAK,KAAK,QAC3B,EAAM,EAAK,MAAM,oCAAoC,GAC3D,MAAO,CACH,MAAO,EAAK,KAAK,KAAK,KAAK,SAC3B,KAAM,GAAG,IAAU,IACnB,QAAS,EACL,EACK,KAAK,aACL,OACA,QAAQ,eAAgB,IAC7B,cAEJ,SAIN,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAY,MAAM,EAAI,EAAK,KAAM,CAC3C,QAAS,CACL,QAAS,UAAU,MAGvB,EAAI,EAAK,GACP,EAAS,EAAE,cAAc,QAAQ,OACjC,EAAW,EAAE,YACd,UACA,IAAK,GAAS,EAAE,GAAM,QAC3B,EAAE,YAAY,SACd,IAAM,EAAc,EAAE,WAAW,OAE3B,CAAE,KAAA,GAAS,MAAM,EAAI,GAAG,EAAQ,sBAAsB,EAAK,IAAI,OAAQ,CACzE,QAAS,CACL,QAAS,GAAG,EAAQ,oBAAoB,EAAK,IAAI,UAGzD,EAAI,EAAK,GAET,IAAM,EAAe,EAAE,UAClB,OACA,MAAM,8BAA8B,GAEnC,EAAU,KAAK,MAAM,EAAa,WAAW,OAAQ,UAAU,WAAW,WAAY,cAAc,WAAW,mBAAoB,IAAI,WAAW,KAAM,KAS9J,MAPA,GAAK,OAAS,EACd,EAAK,SAAW,EAChB,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAChE,cACA,YAGG,MAKnB,MAAO,CACH,MAAO,EAAE,cAAc,OACvB,KAAM,EACN,KAAM"}