{"version":3,"file":"zeroday-DGqaX6xR.js","names":[],"sources":["../../lib/routes/hitcon/zeroday.ts"],"sourcesContent":["import type { Data, DataItem, Route } from '@/types';\r\nimport type { Context } from 'hono';\r\nimport { load } from 'cheerio';\r\nimport puppeteer from '@/utils/puppeteer';\r\nimport logger from '@/utils/logger';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    name: '漏洞',\r\n    categories: ['programming'],\r\n    path: '/zeroday/vulnerability/:status?',\r\n    example: '/hitcon/zeroday/vulnerability',\r\n    parameters: {\r\n        status: '漏洞状态，见下表',\r\n    },\r\n    maintainers: ['KarasuShin'],\r\n    radar: [\r\n        {\r\n            source: ['zeroday.hitcon.org/vulnerability/:status?'],\r\n        },\r\n    ],\r\n    features: {\r\n        requirePuppeteer: true,\r\n    },\r\n    handler,\r\n    description: `| 缺省   | all  | closed | disclosed | patching |\r\n| ------ | ---- | ------ | --------- | -------- |\r\n| 活動中 | 全部 | 關閉   | 公開      | 修補中   |`,\r\n};\r\n\r\nconst baseUrl = 'https://zeroday.hitcon.org/vulnerability';\r\n\r\nconst titleMap = {\r\n    all: '全部',\r\n    closed: '關閉',\r\n    disclosed: '公開',\r\n    patching: '修補中',\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    let url = baseUrl;\r\n    const status = ctx.req.param('status');\r\n    if (status) {\r\n        url += `/${status}`;\r\n    }\r\n\r\n    const browser = await puppeteer();\r\n    const page = await browser.newPage();\r\n    await page.setRequestInterception(true);\r\n\r\n    page.on('request', (request) => {\r\n        request.resourceType() === 'document' ? request.continue() : request.abort();\r\n    });\r\n\r\n    logger.http(`Requesting ${url}`);\r\n    await page.goto(url, {\r\n        waitUntil: 'domcontentloaded',\r\n    });\r\n\r\n    const response = await page.evaluate(() => document.documentElement.innerHTML);\r\n    await browser.close();\r\n\r\n    const $ = load(response);\r\n    const items: DataItem[] = $('.zdui-strip-list>li')\r\n        .toArray()\r\n        .map((el) => {\r\n            const title = $(el).find('.title a');\r\n            const vulData = $(el).find('.vul-data');\r\n            const code = vulData\r\n                .find('.code')\r\n                .contents()\r\n                .filter(function () {\r\n                    return this.nodeType === 3;\r\n                })\r\n                .text();\r\n            const risk = vulData.find('.risk span').eq(1).text();\r\n            const vender = vulData.find('.vender').find('.v-name-full').text();\r\n            const status = vulData.find('.status').text().replace('Status:', '').trim();\r\n            const date = vulData.find('.date').text().replace('Date:', '').trim();\r\n            const reporter = vulData.find('.zdui-author-badge').find('a>span').text();\r\n            const description = art(path.join(__dirname, 'templates/zeroday.art'), {\r\n                code,\r\n                risk,\r\n                vender,\r\n                status,\r\n                date,\r\n                reporter,\r\n            });\r\n\r\n            return {\r\n                title: title.text(),\r\n                link: title.attr('href'),\r\n                description,\r\n                pubDate: parseDate(date),\r\n            };\r\n        });\r\n\r\n    return {\r\n        title: status ? (titleMap[status] ?? 'ZeroDay') : '活動中',\r\n        link: url,\r\n        item: items,\r\n        image: 'https://zeroday.hitcon.org/images/favicon/favicon.png',\r\n    };\r\n}\r\n"],"mappings":"+YASA,MAAa,EAAe,CACxB,KAAM,KACN,WAAY,CAAC,eACb,KAAM,kCACN,QAAS,gCACT,WAAY,CACR,OAAQ,YAEZ,YAAa,CAAC,cACd,MAAO,CACH,CACI,OAAQ,CAAC,+CAGjB,SAAU,CACN,iBAAkB,IAEtB,UACA,YAAa;;wCAOX,EAAW,CACb,IAAK,KACL,OAAQ,KACR,UAAW,KACX,SAAU,OAGd,eAAe,EAAQ,EAA6B,CAChD,IAAI,EAAM,2CACJ,EAAS,EAAI,IAAI,MAAM,UACzB,IACA,GAAO,IAAI,KAGf,IAAM,EAAU,MAAM,IAChB,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAElC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,WAAa,EAAQ,WAAa,EAAQ,UAGzE,EAAO,KAAK,cAAc,KAC1B,MAAM,EAAK,KAAK,EAAK,CACjB,UAAW,qBAGf,IAAM,EAAW,MAAM,EAAK,aAAe,SAAS,gBAAgB,WACpE,MAAM,EAAQ,QAEd,IAAM,EAAI,EAAK,GACT,EAAoB,EAAE,uBACvB,UACA,IAAK,GAAO,CACT,IAAM,EAAQ,EAAE,GAAI,KAAK,YACnB,EAAU,EAAE,GAAI,KAAK,aACrB,EAAO,EACR,KAAK,SACL,WACA,OAAO,UAAY,CAChB,OAAO,KAAK,WAAa,IAE5B,OACC,EAAO,EAAQ,KAAK,cAAc,GAAG,GAAG,OACxC,EAAS,EAAQ,KAAK,WAAW,KAAK,gBAAgB,OACtD,EAAS,EAAQ,KAAK,WAAW,OAAO,QAAQ,UAAW,IAAI,OAC/D,EAAO,EAAQ,KAAK,SAAS,OAAO,QAAQ,QAAS,IAAI,OACzD,EAAW,EAAQ,KAAK,sBAAsB,KAAK,UAAU,OAC7D,EAAc,EAAI,EAAA,KAAA,EAAA,kCAA+C,CACnE,OACA,OACA,SACA,OAAA,EACA,OACA,aAGJ,MAAO,CACH,MAAO,EAAM,OACb,KAAM,EAAM,KAAK,QACjB,cACA,QAAS,EAAU,MAI/B,MAAO,CACH,MAAO,EAAU,EAAS,IAAW,UAAa,MAClD,KAAM,EACN,KAAM,EACN,MAAO"}