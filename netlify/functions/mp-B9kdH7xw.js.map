{"version":3,"file":"mp-B9kdH7xw.js","names":[],"sources":["../../lib/routes/sohu/mp.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport * as cheerio from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\nimport CryptoJS from 'crypto-js';\r\n\r\nexport const route: Route = {\r\n    path: '/mp/:xpt',\r\n    categories: ['new-media'],\r\n    example: '/sohu/mp/c29odXptdGhnbjZ3NEBzb2h1LmNvbQ==',\r\n    parameters: { xpt: '搜狐号 xpt ，可在URL中找到或搜狐号 ID' },\r\n    radar: [\r\n        {\r\n            source: ['mp.sohu.com/profile'],\r\n            target: (_params, url) => `/sohu/mp/${new URL(url).searchParams.get('xpt')}`,\r\n        },\r\n    ],\r\n    name: '最新',\r\n    maintainers: ['HenryQW'],\r\n    handler,\r\n    description: `搜狐号 ID 可以通过以下方式获取：\r\n  1.  通过浏览器搜索相关搜狐号 \\`果壳 site: mp.sohu.com\\`。\r\n  2.  通过浏览器控制台执行 \\`window.globalConst.mkeyConst_mkey\\`，返回的即为搜狐号 ID。`,\r\n};\r\n\r\nfunction randomString(length = 32) {\r\n    let r = '';\r\n    const e = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';\r\n    const n = e.length;\r\n    for (let i = 0; i < length; i++) {\r\n        r += e.charAt(Math.floor(Math.random() * n));\r\n    }\r\n    return r;\r\n}\r\nconst defaultSUV = '1612268936507kas0gk';\r\n\r\nfunction decryptImageUrl(cipherText) {\r\n    const key = CryptoJS.enc.Utf8.parse('www.sohu.com6666');\r\n    const cipher = CryptoJS.AES.decrypt(cipherText, key, {\r\n        mode: CryptoJS.mode.ECB,\r\n        padding: CryptoJS.pad.Pkcs7,\r\n    });\r\n    return cipher.toString(CryptoJS.enc.Utf8);\r\n}\r\n\r\nfunction createAuthToken() {\r\n    const t = Date.now();\r\n    const e = 't' + t;\r\n    return 'v1' + t + CryptoJS.HmacSHA1(e, '439642a904ef43d092d45509cdc4391c').toString();\r\n}\r\n\r\nfunction fetchArticle(item) {\r\n    return cache.tryGet(item.link, async () => {\r\n        const response = await ofetch(item.link);\r\n        const $ = cheerio.load(response);\r\n\r\n        $('.original-title, .lookall-box').remove();\r\n        item.author = item.author || $('span[data-role=\"original-link\"] a').text();\r\n        item.pubDate = timezone(parseDate($('meta[itemprop=\"dateUpdate\"]').attr('content')), 8);\r\n\r\n        if (/window\\.sohu_mp\\.article_video/.test($('script').text())) {\r\n            const videoSrc = $('script')\r\n                .text()\r\n                .match(/\\s*url: \"(.*?)\",/)?.[1];\r\n            item.description = art(path.join(__dirname, 'templates/video.art'), {\r\n                poster: $('script')\r\n                    .text()\r\n                    .match(/cover: \"(.*?)\",/)?.[1],\r\n                src: videoSrc,\r\n                type: videoSrc?.split('.').pop()?.toLowerCase(),\r\n            });\r\n        } else {\r\n            const article = $('#mp-editor');\r\n\r\n            article.find('#backsohucom, p[data-role=\"editor-name\"]').each((i, e) => {\r\n                $(e).remove();\r\n            });\r\n            article.find('img').each((_, e) => {\r\n                const $e = $(e);\r\n                if ($e.attr('data-src') && !$e.attr('src')) {\r\n                    $e.attr('src', decryptImageUrl($e.attr('data-src')));\r\n                    $e.removeAttr('data-src');\r\n                }\r\n            });\r\n\r\n            item.description = article.html();\r\n        }\r\n\r\n        return item;\r\n    });\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const xpt = ctx.req.param('xpt');\r\n    const isPureNumber = /^\\d+$/.test(xpt);\r\n    if (isPureNumber) {\r\n        return legacyIdHandler(ctx);\r\n    }\r\n\r\n    const pageResponse = await ofetch.raw('https://mp.sohu.com/profile', {\r\n        query: {\r\n            xpt,\r\n        },\r\n    });\r\n    const suv = pageResponse.headers\r\n        ?.getSetCookie()\r\n        .find((e) => e.startsWith('SUV'))\r\n        ?.split(';')[0];\r\n    const $ = cheerio.load(pageResponse._data);\r\n\r\n    const CBDRenderConst = JSON.parse(\r\n        $('script:contains(\"CBDRenderConst\")')\r\n            .text()\r\n            .trim()\r\n            .match(/CBDRenderConst\\s=\\s(.*)/)?.[1] || '{}'\r\n    );\r\n    const contentData = JSON.parse(\r\n        $('script:contains(\"contentData\")')\r\n            .toArray()\r\n            .map(\r\n                (e) =>\r\n                    $(e)\r\n                        .text()\r\n                        .match(/contentData = (.*)/)?.[1]\r\n            )\r\n            .sort((a: any, b: any) => b.length - a.length)[0] || '{}'\r\n    );\r\n    const blockRenderData = JSON.parse(\r\n        $('script:contains(\"column_2_text\")')\r\n            .text()\r\n            .match(/({.*})/)?.[1]\r\n    );\r\n    const renderData = blockRenderData[Object.keys(blockRenderData).find((e) => e.startsWith('FeedSlideloadAuthor'))];\r\n    const briefIntroductionCard = blockRenderData[Object.keys(blockRenderData).find((e) => e.startsWith('BriefIntroductionCard'))].param.data.list[0];\r\n\r\n    const globalConst = JSON.parse(\r\n        $('script:contains(\"globalConst\")')\r\n            .text()\r\n            .match(/globalConst\\s=\\s(.*)/)?.[1] || '{}'\r\n    );\r\n    const originalRequest = JSON.parse(\r\n        $('script:contains(\"originalRequest\")')\r\n            .text()\r\n            .match(/originalRequest\\s=\\s(.*)/)?.[1] || '{}'\r\n    );\r\n\r\n    const blockData = await ofetch('https://odin.sohu.com/odin/api/blockdata', {\r\n        method: 'POST',\r\n        headers: {\r\n            Cookie: Object.entries({\r\n                SUV: suv,\r\n                itssohu: 'true',\r\n                reqtype: 'pc',\r\n                t: Date.now(),\r\n            })\r\n                .map(([key, value]) => `${key}=${value}`)\r\n                .join('; '),\r\n        },\r\n        body: {\r\n            pvId: CBDRenderConst.COMMONCONFIG.pvId || `${Date.now()}_${randomString(7)}`,\r\n            pageId: `${Date.now()}_${defaultSUV?.slice(0, -5)}_${randomString(3)}`,\r\n            mainContent: {\r\n                productType: contentData.businessType || '13',\r\n                productId: contentData.id || '324',\r\n                secureScore: contentData.secureScore || '5',\r\n                categoryId: contentData.categoryId || '47',\r\n                adTags: contentData.adTags || '11111111',\r\n                authorId: contentData.account.id || 121_135_924,\r\n            },\r\n            resourceList: [\r\n                {\r\n                    tplCompKey: renderData.param.data2.reqParam.tplCompKey || 'FeedSlideloadAuthor_2_0_pc_1655965929143_data2',\r\n                    isServerRender: renderData.param.data2.reqParam.isServerRender || false,\r\n                    isSingleAd: renderData.param.data2.reqParam.isSingleAd || false,\r\n                    configSource: renderData.param.data2.reqParam.configSource || 'mp',\r\n                    content: {\r\n                        productId: renderData.param.data2.reqParam.content.productId || '325',\r\n                        productType: renderData.param.data2.reqParam.content.productType || '13',\r\n                        size: 20,\r\n                        pro: renderData.param.pro || '0,1,3,4,5',\r\n                        feedType: renderData.param.feedType || 'XTOPIC_SYNTHETICAL',\r\n                        view: 'operateFeedMode',\r\n                        innerTag: renderData.param.data2.reqParam.content.innerTag || 'work',\r\n                        spm: renderData.param.data2.reqParam.content.spm || 'smpc.channel_248.block3_308_hHsK47_2_fd',\r\n                        page: 1,\r\n                        requestId: `${Date.now()}${randomString(7)}_${contentData.id}`,\r\n                    },\r\n                    adInfo: {},\r\n                    context: {\r\n                        mkey: globalConst.mkeyConst_mkey, // legacy ID\r\n                    },\r\n                },\r\n            ],\r\n            asId: createAuthToken(),\r\n        },\r\n    });\r\n\r\n    const list = blockData.data[renderData.param.data2.reqParam.tplCompKey].list.map((item) => ({\r\n        title: item.title,\r\n        description: item.brief,\r\n        link: `https://www.sohu.com/a/${item.id}_${globalConst.mkeyConst_mkey}`,\r\n    }));\r\n\r\n    const items = await Promise.all(list.map((e) => fetchArticle(e)));\r\n\r\n    return {\r\n        title: `搜狐号 - ${globalConst.title}`,\r\n        description: briefIntroductionCard.column_9_text,\r\n        link: originalRequest.url,\r\n        image: `https:${briefIntroductionCard.column_2_image}`,\r\n        item: items,\r\n    };\r\n}\r\n\r\nasync function legacyIdHandler(ctx) {\r\n    const id = ctx.req.param('xpt');\r\n    const authorArticleAPI = `https://v2.sohu.com/author-page-api/author-articles/pc/${id}`;\r\n\r\n    const response = await ofetch(authorArticleAPI);\r\n    const list = response.data.pcArticleVOS.map((item) => ({\r\n        title: item.title,\r\n        link: item.link.startsWith('http') ? item.link : `https://${item.link}`,\r\n        pubDate: parseDate(item.publicTime),\r\n    }));\r\n\r\n    const items = await Promise.all(list.map((e) => fetchArticle(e)));\r\n\r\n    return {\r\n        title: `搜狐号 - ${id}`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}