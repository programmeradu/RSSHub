{"version":3,"file":"campaign-Df8NPwxu.js","names":["route: Route","InvalidParameterError","got","title","link","element","description"],"sources":["../../lib/routes/dlsite/campaign.ts"],"sourcesContent":["import InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\n\r\nconst host = 'https://www.dlsite.com';\r\nconst infos = {\r\n    // 全年齢向け\r\n    home: {\r\n        type: 'home',\r\n        name: '「DLsite 同人」',\r\n        url: '/home/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['doujin'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n    comic: {\r\n        type: 'comic',\r\n        name: '「DLsite コミック」',\r\n        url: '/comic/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['books'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n    soft: {\r\n        type: 'soft',\r\n        name: '「DLsite PCソフト」',\r\n        url: '/soft/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['pc'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n    // 成人向け( R18 )\r\n    maniax: {\r\n        type: 'maniax',\r\n        name: '「DLsite 同人 - R18」',\r\n        url: '/maniax/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['doujin'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n    books: {\r\n        type: 'books',\r\n        name: '「DLsite 成年コミック - R18」',\r\n        url: '/books/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['books'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n    pro: {\r\n        type: 'pro',\r\n        name: '「DLsite 美少女ゲーム」',\r\n        url: '/pro/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['pc'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n    // 女性向け\r\n    girls: {\r\n        type: 'girls',\r\n        name: '「DLsite 乙女」',\r\n        url: '/girls/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['doujin'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n    bl: {\r\n        type: 'bl',\r\n        name: '「DLsite BL」',\r\n        url: '/bl/fsr',\r\n        params: {\r\n            campaign: 'campaign',\r\n            work_category: ['doujin'],\r\n            order: ['cstart_d'],\r\n            per_page: 30,\r\n            show_type: 1,\r\n        },\r\n    },\r\n};\r\nconst setUrl = (info) => {\r\n    let paramsPath = `${info.url}/=/`;\r\n    const params = info.params;\r\n    for (const name in params) {\r\n        if (Array.isArray(params[name])) {\r\n            for (const index in params[name]) {\r\n                paramsPath += `${name}[${index}]/${params[name][index]}/`;\r\n            }\r\n        } else {\r\n            paramsPath += `${name}/${params[name]}/`;\r\n        }\r\n    }\r\n    return paramsPath.slice(1);\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/campaign/:type/:free?',\r\n    categories: ['anime'],\r\n    example: '/dlsite/campaign/home',\r\n    parameters: {\r\n        type: {\r\n            description: '类型',\r\n            options: Object.values(infos).map((info) => ({ value: info.type, label: info.name })),\r\n        },\r\n        free: {\r\n            description: '免费',\r\n            options: [{ value: '1', label: '是' }],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Discounted Works',\r\n    maintainers: ['cssxsh'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const info = infos[ctx.req.param('type')];\r\n    // 判断参数是否合理\r\n    if (info === undefined) {\r\n        throw new InvalidParameterError('不支持指定类型！');\r\n    }\r\n    if (ctx.req.param('free') !== undefined) {\r\n        info.params.is_free = 1;\r\n    }\r\n    const link = setUrl(info);\r\n\r\n    const response = await got(new URL(link, host), {\r\n        method: 'GET',\r\n    });\r\n    const data = response.data;\r\n    const $ = load(data);\r\n\r\n    const title = `${info.name} | 割引中の作品`;\r\n    const description = $('meta[name=\"description\"]').attr('content');\r\n    const list = $('tr[class]', '.n_worklist');\r\n    const item = list.toArray().map((element) => {\r\n        const title = $('.work_name', element).text();\r\n        const link = $('.work_name > a', element).attr('href');\r\n        // 使链接\r\n        $('a', element).each((_index, element) => {\r\n            $(element).attr('target', '_blank');\r\n        });\r\n        const description = $(element).html();\r\n        const arr = $('.search_tag', element);\r\n        const category = $('a', arr)\r\n            .toArray()\r\n            .map((a) => $(a).text());\r\n        const author = $('.maker_name', element).text();\r\n\r\n        const signle = {\r\n            title,\r\n            link,\r\n            description,\r\n            category,\r\n            author,\r\n        };\r\n        return signle;\r\n    });\r\n\r\n    return {\r\n        title,\r\n        link: `${host}/${link}`,\r\n        description,\r\n        language: 'ja-jp',\r\n        allowEmpty: true,\r\n        item,\r\n    };\r\n}\r\n"],"mappings":"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"}