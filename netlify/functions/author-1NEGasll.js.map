{"version":3,"file":"author-1NEGasll.js","names":["route: Route","ofetch","link","cache"],"sources":["../../lib/routes/cnki/author.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { ProcessItem } from './utils';\r\n\r\nexport const route: Route = {\r\n    name: '作者',\r\n    maintainers: ['Derekmini', 'harveyqiu'],\r\n    categories: ['journal'],\r\n    path: '/author/:name/:company',\r\n    parameters: { name: '作者姓名', company: '作者单位' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    example: '/cnki/author/丁晓东/中国人民大学',\r\n    description: `::: tip\r\n    可能仅限中国大陆服务器访问，以实际情况为准。\r\n:::`,\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const name = ctx.req.param('name');\r\n    const company = ctx.req.param('company');\r\n    const host = 'https://kns.cnki.net';\r\n    const link = `${host}/kns8s/AdvSearch?classid=WD0FTY92`;\r\n\r\n    const params = new URLSearchParams();\r\n    params.append('boolSearch', 'true');\r\n    params.append(\r\n        'QueryJson',\r\n        JSON.stringify({\r\n            Platform: '',\r\n            Resource: 'CROSSDB',\r\n            Classid: 'WD0FTY92',\r\n            Products: '',\r\n            QNode: {\r\n                QGroup: [\r\n                    {\r\n                        Key: 'Subject',\r\n                        Title: '',\r\n                        Logic: 0,\r\n                        Items: [],\r\n                        ChildItems: [\r\n                            {\r\n                                Key: 'input[data-tipid=gradetxt-1]',\r\n                                Title: '作者',\r\n                                Logic: 0,\r\n                                Items: [\r\n                                    {\r\n                                        Key: 'input[data-tipid=gradetxt-1]',\r\n                                        Title: '作者',\r\n                                        Logic: 0,\r\n                                        Field: 'AU',\r\n                                        Operator: 'DEFAULT',\r\n                                        Value: name,\r\n                                        Value2: '',\r\n                                    },\r\n                                ],\r\n                                ChildItems: [],\r\n                            },\r\n                            {\r\n                                Key: 'input[data-tipid=gradetxt-2]',\r\n                                Title: '作者单位',\r\n                                Logic: 0,\r\n                                Items: [\r\n                                    {\r\n                                        Key: 'input[data-tipid=gradetxt-2]',\r\n                                        Title: '作者单位',\r\n                                        Logic: 0,\r\n                                        Field: 'AF',\r\n                                        Operator: 'FUZZY',\r\n                                        Value: company,\r\n                                        Value2: '',\r\n                                    },\r\n                                ],\r\n                                ChildItems: [],\r\n                            },\r\n                        ],\r\n                    },\r\n                    {\r\n                        Key: 'ControlGroup',\r\n                        Title: '',\r\n                        Logic: 0,\r\n                        Items: [],\r\n                        ChildItems: [],\r\n                    },\r\n                ],\r\n            },\r\n            ExScope: '0',\r\n            SearchType: 3,\r\n            Rlang: 'CHINESE',\r\n            KuaKuCode: 'YSTT4HG0,LSTPFY1C,JUP3MUPD,MPMFIG1A,EMRPGLPA,WQ0UVIAA,BLZOG7CK,PWFIRAGL,NN3FJMUV,NLBO1Z6R',\r\n        })\r\n    );\r\n    params.append('pageNum', '1');\r\n    params.append('pageSize', '20');\r\n    params.append('sortField', 'PT');\r\n    params.append('sortType', 'desc');\r\n    params.append('dstyle', 'listmode');\r\n    params.append('productStr', 'YSTT4HG0,LSTPFY1C,RMJLXHZ3,JQIRZIYA,JUP3MUPD,1UR4K4HZ,BPBAFJ5S,R79MZMCB,MPMFIG1A,EMRPGLPA,J708GVCE,ML4DRIDX,WQ0UVIAA,NB3BWEHK,XVLO76FD,HR1YT1Z9,BLZOG7CK,PWFIRAGL,NN3FJMUV,NLBO1Z6R,');\r\n    params.append('aside', `（作者：${name}(精确)）AND（作者单位：${company}(模糊)）`);\r\n    params.append('searchFrom', '资源范围：总库;  时间范围：更新时间：不限;');\r\n    params.append('CurPage', '1');\r\n\r\n    const response = await ofetch(`${host}/kns8s/brief/grid`, {\r\n        method: 'POST',\r\n        headers: {\r\n            'content-type': 'application/x-www-form-urlencoded;charset=utf-8',\r\n            referer: `${host}/kns8s/AdvSearch?classid=WD0FTY92`,\r\n        },\r\n        body: params.toString(),\r\n    });\r\n    const $ = load(response);\r\n    const list = $('tr')\r\n        .toArray()\r\n        .slice(1)\r\n        .map((item) => {\r\n            const title = $(item).find('a.fz14').text();\r\n            const filename = $(item).find('a.icon-collect').attr('data-filename');\r\n            const link = `https://cnki.net/kcms/detail/detail.aspx?filename=${filename}&dbcode=CJFD`;\r\n            const pubDate = parseDate($(item).find('td.date').text(), 'YYYY-MM-DD');\r\n            return {\r\n                title,\r\n                link,\r\n                pubDate,\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(list.map((item) => cache.tryGet(item.link, () => ProcessItem(item))));\r\n\r\n    const processedItems = items\r\n        .filter((item): item is Record<string, any> => item !== null && typeof item === 'object')\r\n        .map((item) => ({\r\n            title: item.title || '',\r\n            link: item.link,\r\n            pubDate: item.pubDate,\r\n        }));\r\n\r\n    return {\r\n        title: `知网 ${name} ${company}`,\r\n        link,\r\n        item: processedItems,\r\n    };\r\n}\r\n"],"mappings":"0bAOA,MAAaA,EAAe,CACxB,KAAM,KACN,YAAa,CAAC,YAAa,aAC3B,WAAY,CAAC,WACb,KAAM,yBACN,WAAY,CAAE,KAAM,OAAQ,QAAS,QACrC,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,QAAS,0BACT,YAAa;;KAGb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,QACrB,EAAU,EAAI,IAAI,MAAM,WACxB,EAAO,uBACP,EAAO,GAAG,EAAK,mCAEf,EAAS,IAAI,gBACnB,EAAO,OAAO,aAAc,QAC5B,EAAO,OACH,YACA,KAAK,UAAU,CACX,SAAU,GACV,SAAU,UACV,QAAS,WACT,SAAU,GACV,MAAO,CACH,OAAQ,CACJ,CACI,IAAK,UACL,MAAO,GACP,MAAO,EACP,MAAO,GACP,WAAY,CACR,CACI,IAAK,+BACL,MAAO,KACP,MAAO,EACP,MAAO,CACH,CACI,IAAK,+BACL,MAAO,KACP,MAAO,EACP,MAAO,KACP,SAAU,UACV,MAAO,EACP,OAAQ,KAGhB,WAAY,IAEhB,CACI,IAAK,+BACL,MAAO,OACP,MAAO,EACP,MAAO,CACH,CACI,IAAK,+BACL,MAAO,OACP,MAAO,EACP,MAAO,KACP,SAAU,QACV,MAAO,EACP,OAAQ,KAGhB,WAAY,MAIxB,CACI,IAAK,eACL,MAAO,GACP,MAAO,EACP,MAAO,GACP,WAAY,MAIxB,QAAS,IACT,WAAY,EACZ,MAAO,UACP,UAAW,+FAGnB,EAAO,OAAO,UAAW,KACzB,EAAO,OAAO,WAAY,MAC1B,EAAO,OAAO,YAAa,MAC3B,EAAO,OAAO,WAAY,QAC1B,EAAO,OAAO,SAAU,YACxB,EAAO,OAAO,aAAc,wLAC5B,EAAO,OAAO,QAAS,OAAO,EAAK,gBAAgB,EAAQ,QAC3D,EAAO,OAAO,aAAc,2BAC5B,EAAO,OAAO,UAAW,KAEzB,IAAM,EAAW,MAAMC,EAAO,GAAG,EAAK,mBAAoB,CACtD,OAAQ,OACR,QAAS,CACL,eAAgB,kDAChB,QAAS,GAAG,EAAK,oCAErB,KAAM,EAAO,aAEX,EAAI,EAAK,GACT,EAAO,EAAE,MACV,UACA,MAAM,GACN,IAAK,GAAS,CACX,IAAM,EAAQ,EAAE,GAAM,KAAK,UAAU,OAC/B,EAAW,EAAE,GAAM,KAAK,kBAAkB,KAAK,iBAC/CC,EAAO,qDAAqD,EAAS,cACrE,EAAU,EAAU,EAAE,GAAM,KAAK,WAAW,OAAQ,cAC1D,MAAO,CACH,QACA,KAAA,EACA,aAIN,EAAQ,MAAM,QAAQ,IAAI,EAAK,IAAK,GAASC,EAAM,OAAO,EAAK,SAAY,EAAY,MAEvF,EAAiB,EAClB,OAAQ,GAAuD,OAAO,GAAS,YAAjC,GAC9C,IAAK,IAAU,CACZ,MAAO,EAAK,OAAS,GACrB,KAAM,EAAK,KACX,QAAS,EAAK,WAGtB,MAAO,CACH,MAAO,MAAM,EAAK,GAAG,IACrB,OACA,KAAM"}