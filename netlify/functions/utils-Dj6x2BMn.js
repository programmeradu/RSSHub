import{__dirname as e,init_esm_shims as t}from"./esm-shims-Dqvxr0BZ.js";import{config as n}from"./config-Dl8a1sIg.js";import{cache_default as r}from"./cache-kimkMTWJ.js";import{art as i}from"./render-CxhTJIsl.js";import{parseDate as a}from"./parse-date-Bgabdhlb.js";import{ofetch_default as o}from"./ofetch-Bzt0BXUH.js";import{not_found_default as s}from"./not-found-CRS5K6wf.js";import c from"node:path";import l from"dayjs";import u from"dayjs/plugin/duration.js";import*as d from"cheerio";import{google as f}from"googleapis";const{OAuth2:p}=f.auth;l.extend(u);let m=0;const h={};if(n.youtube&&n.youtube.key){let e=n.youtube.key.split(`,`);for(let[t,n]of e.entries())n&&(h[t]=f.youtube({version:`v3`,auth:n}),m=t+1)}let g=-1;const _=async e=>{let t;for(let n=0;n<m;n++){g++;try{t=await e(h[g%m]);break}catch{}}return t};let v;n.youtube&&n.youtube.clientId&&n.youtube.clientSecret&&n.youtube.refreshToken&&(v=new p(n.youtube.clientId,n.youtube.clientSecret,`https://developers.google.com/oauthplayground`),v.setCredentials({refresh_token:n.youtube.refreshToken}));const y=async({username:e,embed:t,filterShorts:n})=>{let i;e.startsWith(`@`)&&(i=await r.tryGet(`youtube:handle:${e}`,async()=>{let t=`https://www.youtube.com/${e}`,n=await o(t),i=d.load(n),a=JSON.parse(i(`script`).text().match(/ytInitialData = ({.*?});/)?.[1]||`{}`),s=a.metadata.channelMetadataRenderer,c=s.externalId,l=s.title,u=s.avatar?.thumbnails?.[0]?.url,f=s.description,p=(await L.getChannelWithId(c,`contentDetails`,r)).data.items[0].contentDetails.relatedPlaylists.uploads;return{channelName:l,image:u,description:f,playlistId:p}}));let c=await(async()=>{if(i?.playlistId){let e=i.playlistId;return L.getPlaylistWithShortsFilter(e,n)}else{let t=await L.getChannelWithUsername(e,`contentDetails`,r),i=t.data.items;if(!i)throw new s(`The channel https://www.youtube.com/user/${e} does not exist.`);let a=i[0].id;return n?L.getPlaylistWithShortsFilter(a,n):i[0].contentDetails.relatedPlaylists.uploads}})(),u=await L.getPlaylistItems(c,`snippet`,r);if(!u)throw new s(`This channel doesn't have any content.`);let f=u.data.items.map(e=>e.snippet.resourceId.videoId).join(`,`),p=await L.getVideos(f,`contentDetails`,r);return{title:`${i?.channelName||e} - YouTube`,link:e.startsWith(`@`)?`https://www.youtube.com/${e}`:`https://www.youtube.com/user/${e}`,description:i?.description||`YouTube user ${e}`,image:i?.image,item:u.data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=L.getThumbnail(n.thumbnails),o=p?.data.items.find(e=>e.id===r);return{title:n.title,description:L.renderDescription(t,r,i,L.formatDescription(n.description)),pubDate:a(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:P(r),mime_type:`text/html`,duration_in_seconds:o?.contentDetails.duration?l.duration(o.contentDetails.duration).asSeconds():void 0}]}})}},b=async({channelId:e,embed:t,filterShorts:n})=>{let i=n?null:(await L.getChannelWithId(e,`contentDetails`,r)).data.items[0].contentDetails.relatedPlaylists.uploads,o=n?L.getPlaylistWithShortsFilter(e):i,s=(await L.getPlaylistItems(o,`snippet`,r)).data.items,c=s.map(e=>e.snippet.resourceId.videoId).join(`,`),u=await L.getVideos(c,`contentDetails`,r);return{title:`${s[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/channel/${e}`,description:`YouTube channel ${s[0].snippet.channelTitle}`,item:s.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`).map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=L.getThumbnail(n.thumbnails),o=u?.data.items.find(e=>e.id===r);return{title:n.title,description:L.renderDescription(t,r,i,L.formatDescription(n.description)),pubDate:a(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:P(r),mime_type:`text/html`,duration_in_seconds:o?.contentDetails.duration?l.duration(o.contentDetails.duration).asSeconds():void 0}]}})}},x=async({playlistId:e,embed:t})=>{let n=(await L.getPlaylist(e,`snippet`,r)).data.items[0].snippet.title,i=(await L.getPlaylistItems(e,`snippet`,r)).data.items.filter(e=>e.snippet.title!==`Private video`&&e.snippet.title!==`Deleted video`),o=i.map(e=>e.snippet.resourceId.videoId).join(`,`),s=await L.getVideos(o,`contentDetails`,r);return{title:`${n} by ${i[0].snippet.channelTitle} - YouTube`,link:`https://www.youtube.com/playlist?list=${e}`,description:`${n} by ${i[0].snippet.channelTitle}`,item:i.map(e=>{let n=e.snippet,r=n.resourceId.videoId,i=L.getThumbnail(n.thumbnails),o=s?.data.items.find(e=>e.id===r);return{title:n.title,description:L.renderDescription(t,r,i,L.formatDescription(n.description)),pubDate:a(n.publishedAt),link:`https://www.youtube.com/watch?v=${r}`,author:n.videoOwnerChannelTitle,image:i.url,attachments:[{url:P(r),mime_type:`text/html`,duration_in_seconds:o?.contentDetails.duration?l.duration(o.contentDetails.duration).asSeconds():void 0}]}})}};t();const S=(e,t,r)=>r.tryGet(`youtube:getPlaylistItems:${e}`,async()=>{let n=await _(n=>n.playlistItems.list({part:t,playlistId:e,maxResults:50}));return n},n.cache.routeExpire,!1),C=(e,t,n)=>n.tryGet(`youtube:getPlaylist:${e}`,async()=>{let n=await _(n=>n.playlists.list({part:t,id:e}));return n}),w=(e,t,n)=>n.tryGet(`youtube:getChannelWithId:${e}`,async()=>{let n=await _(n=>n.channels.list({part:t,id:e}));return n}),T=(e,t,n)=>n.tryGet(`youtube:getChannelWithUsername:${e}`,async()=>{let n=await _(n=>n.channels.list({part:t,forUsername:e}));return n}),E=(e,t,n)=>n.tryGet(`youtube:getVideos:${e}`,async()=>{let n=await _(n=>n.videos.list({part:t,id:e}));return n}),D=e=>e.maxres||e.standard||e.high||e.medium||e.default,O=e=>e?.replaceAll(/\r\n|\r|\n/g,`<br>`),k=(t,n,r,a)=>i(c.join(e,`templates/description-88efae20.art`),{embed:t,videoId:n,img:r,description:a}),A=async(e,t)=>{let r=await t.get(`youtube:accessToken`,!1);if(!r){let e=await v.getAccessToken();r=e.token,await t.set(`youtube:accessToken`,r,3600)}return v.setCredentials({access_token:r,refresh_token:n.youtube.refreshToken}),t.tryGet(`youtube:getSubscriptions`,()=>j(e),n.cache.routeExpire,!1)};async function j(e,t){let n=await f.youtube(`v3`).subscriptions.list({auth:v,part:e,mine:!0,maxResults:50,pageToken:t??void 0});if(n.data.nextPageToken){let t=await j(e,n.data.nextPageToken);t.data.items&&(n.data.items=[...n.data.items||[],...t.data.items])}return n}const M=e=>/^UC[\w-]{21}[AQgw]$/.test(e),N=(e,t)=>t.tryGet(`youtube:getLive:${e}`,async()=>{let t=await _(t=>t.search.list({part:`snippet`,channelId:e,eventType:`live`,type:`video`}));return t}),P=e=>`https://www.youtube-nocookie.com/embed/${e}?controls=1&autoplay=1&mute=0`,F=(e,t=!0)=>t&&(e.startsWith(`UC`)||e.startsWith(`UU`))?`UULF`+e.slice(2):e,I=async({googleApi:e,youtubeiApi:t,params:r})=>{if(n.youtube?.key)try{return await e(r)}catch{return await t(r)}return await t(r)};var L={getPlaylistItems:S,getPlaylist:C,getChannelWithId:w,getChannelWithUsername:T,getVideos:E,getThumbnail:D,formatDescription:O,renderDescription:k,getSubscriptions:A,getSubscriptionsRecusive:j,isYouTubeChannelId:M,getLive:N,getVideoUrl:P,getPlaylistWithShortsFilter:F};export{I as callApi,b as getDataByChannelId,x as getDataByPlaylistId,y as getDataByUsername,P as getVideoUrl,M as isYouTubeChannelId,k as renderDescription,L as utils_default};
//# sourceMappingURL=utils-Dj6x2BMn.js.map