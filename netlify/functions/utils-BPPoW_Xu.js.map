{"version":3,"file":"utils-BPPoW_Xu.js","names":[],"sources":["../../lib/routes/yicai/utils.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst rootUrl = 'https://www.yicai.com';\r\n\r\nconst ProcessItems = async (apiUrl, tryGet) => {\r\n    const response = await got({\r\n        method: 'get',\r\n        url: apiUrl,\r\n    });\r\n\r\n    const items = response.data.map((item) => ({\r\n        title: item.NewsTitle,\r\n        link: item.url.startsWith('http') ? item.url : `${rootUrl}${item.AppID === 0 ? `/vip` : ''}${item.url}`,\r\n        author: item.NewsAuthor || item.NewsSource || item.CreaterName,\r\n        pubDate: timezone(parseDate(item.CreateDate), +8),\r\n        category: [item.ChannelName],\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            image: {\r\n                src: item.originPic,\r\n                alt: item.NewsTitle,\r\n            },\r\n            video: {\r\n                src: item.VideoUrl,\r\n                type: item.VideoUrl?.split(/\\./).pop() ?? undefined,\r\n            },\r\n            intro: item.NewsNotes,\r\n        }),\r\n    }));\r\n\r\n    return Promise.all(fetchFullArticles(items, tryGet));\r\n};\r\nfunction fetchFullArticles(items, tryGet) {\r\n    return items.map((item) =>\r\n        tryGet(item.link, async () => {\r\n            const detailResponse = await got({\r\n                method: 'get',\r\n                url: item.link,\r\n            });\r\n\r\n            const content = load(detailResponse.data);\r\n\r\n            if (!item.pubDate) {\r\n                const dataScript = content(\"script[src='/js/alert.min.js']\").next().text() || content('title').next().text();\r\n                const pb = new Map(JSON.parse(dataScript.match(/_pb = (\\[.*?]);/)[1].replaceAll(\"'\", '\"')));\r\n                item.pubDate = parseDate(`${pb.get('actime')}:00`);\r\n            }\r\n\r\n            content('h1').remove();\r\n            content('.u-btn6, .m-smallshare, .topic-hot').remove();\r\n\r\n            item.description = (item.description ?? '') + (content('.multiText, #multi-text, .txt').html() ?? '');\r\n\r\n            return item;\r\n        })\r\n    );\r\n}\r\nexport { rootUrl, ProcessItems, fetchFullArticles };\r\n"],"mappings":"sUAOA,MAAM,EAAU,wBAEV,EAAe,MAAO,EAAQ,IAAW,CAC3C,IAAM,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAQ,EAAS,KAAK,IAAK,IAAU,CACvC,MAAO,EAAK,UACZ,KAAM,EAAK,IAAI,WAAW,QAAU,EAAK,IAAM,GAAG,IAAU,EAAK,QAAU,EAAI,OAAS,KAAK,EAAK,MAClG,OAAQ,EAAK,YAAc,EAAK,YAAc,EAAK,YACnD,QAAS,EAAS,EAAU,EAAK,YAAa,GAC9C,SAAU,CAAC,EAAK,aAChB,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,CACH,IAAK,EAAK,UACV,IAAK,EAAK,WAEd,MAAO,CACH,IAAK,EAAK,SACV,KAAM,EAAK,UAAU,MAAM,MAAM,OAAS,IAAA,IAE9C,MAAO,EAAK,eAIpB,OAAO,QAAQ,IAAI,EAAkB,EAAO,KAEhD,SAAS,EAAkB,EAAO,EAAQ,CACtC,OAAO,EAAM,IAAK,GACd,EAAO,EAAK,KAAM,SAAY,CAC1B,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAe,MAEpC,GAAI,CAAC,EAAK,QAAS,CACf,IAAM,EAAa,EAAQ,kCAAkC,OAAO,QAAU,EAAQ,SAAS,OAAO,OAChG,EAAK,IAAI,IAAI,KAAK,MAAM,EAAW,MAAM,mBAAmB,GAAG,WAAW,IAAK,OACrF,EAAK,QAAU,EAAU,GAAG,EAAG,IAAI,UAAU,MAQjD,OALA,EAAQ,MAAM,SACd,EAAQ,sCAAsC,SAE9C,EAAK,aAAe,EAAK,aAAe,KAAO,EAAQ,iCAAiC,QAAU,IAE3F"}