{"version":3,"file":"utils-Cqb5RvVf.js","names":[],"sources":["../../lib/routes/sina/utils.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst getRollNewsList = (pageid, lid, limit) =>\r\n    got('https://feed.mix.sina.com.cn/api/roll/get', {\r\n        headers: {\r\n            referer: 'https://news.sina.com.cn/',\r\n        },\r\n        searchParams: {\r\n            pageid,\r\n            lid,\r\n            k: '',\r\n            num: limit,\r\n            page: 1,\r\n            r: Math.random(),\r\n            _: Date.now(),\r\n        },\r\n    });\r\n\r\nconst parseRollNewsList = (data) =>\r\n    data.map((item) => ({\r\n        title: item.title,\r\n        description: item.intro,\r\n        link: item.url.replace('http://', 'https://'),\r\n        author: item.media_name,\r\n        pubDate: parseDate(item.intime, 'X'),\r\n        updated: parseDate(item.mtime, 'X'),\r\n    }));\r\n\r\nconst parseArticle = (item, tryGet) =>\r\n    tryGet(item.link, async () => {\r\n        const detailResponse = await got(item.link);\r\n        const $ = load(detailResponse.data);\r\n        $('#left_hzh_ad, .appendQr_wrap, .app-kaihu-qr, .tech-quotation').remove();\r\n\r\n        const metaPublishTime = $('meta[property=\"article:published_time\"]');\r\n        const htmlPubDate = $('#pub_date, .date');\r\n        const htmlDate = htmlPubDate.length ? timezone(parseDate(htmlPubDate.text(), ['YYYY年MM月DD日 HH:mm', 'YYYY年MM月DD日HH:mm']), 8) : null;\r\n        const metaDate = metaPublishTime.length ? parseDate(metaPublishTime.attr('content')) : htmlDate; // 2023-05-08T08:39:31+08:00\r\n        item.pubDate = item.pubDate ?? metaDate;\r\n        item.author = $('meta[property=\"article:author\"]').attr('content');\r\n\r\n        if (item.link.startsWith('https://slide.sports.sina.com.cn/') || item.link.startsWith('https://slide.tech.sina.com.cn/')) {\r\n            const slideData = JSON.parse(\r\n                $('script')\r\n                    .text()\r\n                    .match(/var slide_data = ({.*?})\\s/)[1]\r\n            );\r\n            item.description = art(path.join(__dirname, 'templates/slide.art'), { slideData });\r\n        } else if (item.link.startsWith('https://video.sina.com.cn/')) {\r\n            const videoId = $('script')\r\n                .text()\r\n                .match(/video_id:'?(.*?)'?,/)[1];\r\n\r\n            const { data: videoResponse } = await got('https://api.ivideo.sina.com.cn/public/video/play', {\r\n                searchParams: {\r\n                    video_id: videoId,\r\n                    appver: 'V11220.210521.03',\r\n                    appname: 'sinaplayer_pc',\r\n                    applt: 'web',\r\n                    tags: 'sinaplayer_pc',\r\n                    jsonp: '',\r\n                    plid: 2_021_012_801,\r\n                    prid: '',\r\n                    uid: '',\r\n                    tid: '',\r\n                    pid: 1,\r\n                    ran: Math.random(),\r\n                    r: item.link,\r\n                    ssid: `gusr_pc_${Date.now()}`,\r\n                    preload: 0,\r\n                    uu: '',\r\n                    isAuto: 1,\r\n                },\r\n            });\r\n\r\n            const videoData = videoResponse.data;\r\n            const poster = videoData.image;\r\n            const videoUrl = videoData.videos.find((v) => v.type === 'mp4').dispatch_result.url;\r\n            item.description = art(path.join(__dirname, 'templates/video.art'), { poster, videoUrl });\r\n            item.pubDate = parseDate(videoData.create_time, 'X');\r\n        } else if (item.link.startsWith('https://news.sina.com.cn/') || item.link.startsWith('https://mil.news.sina.com.cn/')) {\r\n            item.description = $('#article').html();\r\n            item.category = $('meta[name=\"keywords\"]').attr('content').split(',');\r\n        } else {\r\n            // https://ent.sina.com.cn\r\n            // https://finance.sina.com.cn\r\n            // https://sports.sina.com.cn\r\n            item.description = $('#artibody').html();\r\n            item.category = $('#keywords').data('wbkey')?.split(',');\r\n        }\r\n\r\n        return item;\r\n    });\r\n\r\nexport { getRollNewsList, parseRollNewsList, parseArticle };\r\n"],"mappings":"sUAOA,MAAM,GAAmB,EAAQ,EAAK,IAClC,EAAI,4CAA6C,CAC7C,QAAS,CACL,QAAS,6BAEb,aAAc,CACV,SACA,MACA,EAAG,GACH,IAAK,EACL,KAAM,EACN,EAAG,KAAK,SACR,EAAG,KAAK,SAId,EAAqB,GACvB,EAAK,IAAK,IAAU,CAChB,MAAO,EAAK,MACZ,YAAa,EAAK,MAClB,KAAM,EAAK,IAAI,QAAQ,UAAW,YAClC,OAAQ,EAAK,WACb,QAAS,EAAU,EAAK,OAAQ,KAChC,QAAS,EAAU,EAAK,MAAO,QAGjC,GAAgB,EAAM,IACxB,EAAO,EAAK,KAAM,SAAY,CAC1B,IAAM,EAAiB,MAAM,EAAI,EAAK,MAChC,EAAI,EAAK,EAAe,MAC9B,EAAE,gEAAgE,SAElE,IAAM,EAAkB,EAAE,2CACpB,EAAc,EAAE,oBAChB,EAAW,EAAY,OAAS,EAAS,EAAU,EAAY,OAAQ,CAAC,oBAAqB,qBAAsB,GAAK,KACxH,EAAW,EAAgB,OAAS,EAAU,EAAgB,KAAK,YAAc,EAIvF,GAHA,EAAK,QAAU,EAAK,SAAW,EAC/B,EAAK,OAAS,EAAE,mCAAmC,KAAK,WAEpD,EAAK,KAAK,WAAW,sCAAwC,EAAK,KAAK,WAAW,mCAAoC,CACtH,IAAM,EAAY,KAAK,MACnB,EAAE,UACG,OACA,MAAM,8BAA8B,IAE7C,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAAE,sBAC/D,EAAK,KAAK,WAAW,8BAA+B,CAC3D,IAAM,EAAU,EAAE,UACb,OACA,MAAM,uBAAuB,GAE5B,CAAE,KAAM,GAAkB,MAAM,EAAI,mDAAoD,CAC1F,aAAc,CACV,SAAU,EACV,OAAQ,mBACR,QAAS,gBACT,MAAO,MACP,KAAM,gBACN,MAAO,GACP,KAAM,WACN,KAAM,GACN,IAAK,GACL,IAAK,GACL,IAAK,EACL,IAAK,KAAK,SACV,EAAG,EAAK,KACR,KAAM,WAAW,KAAK,QACtB,QAAS,EACT,GAAI,GACJ,OAAQ,KAIV,EAAY,EAAc,KAC1B,EAAS,EAAU,MACnB,EAAW,EAAU,OAAO,KAAM,GAAM,EAAE,OAAS,OAAO,gBAAgB,IAChF,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAAE,SAAQ,aAC9E,EAAK,QAAU,EAAU,EAAU,YAAa,UACzC,EAAK,KAAK,WAAW,8BAAgC,EAAK,KAAK,WAAW,kCACjF,EAAK,YAAc,EAAE,YAAY,OACjC,EAAK,SAAW,EAAE,yBAAyB,KAAK,WAAW,MAAM,OAKjE,EAAK,YAAc,EAAE,aAAa,OAClC,EAAK,SAAW,EAAE,aAAa,KAAK,UAAU,MAAM,MAGxD,OAAO"}