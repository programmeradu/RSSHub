import{__dirname as e,init_esm_shims as t}from"./esm-shims-Dqvxr0BZ.js";import{config as n}from"./config-Dl8a1sIg.js";import"./logger-CWOoofbD.js";import"./dist-IvUHtNe1.js";import{cache_default as r}from"./cache-kimkMTWJ.js";import{art as i}from"./render-CxhTJIsl.js";import{parseDate as a}from"./parse-date-Bgabdhlb.js";import{ofetch_default as o}from"./ofetch-Bzt0BXUH.js";import{invalid_parameter_default as s}from"./invalid-parameter-CUJdROXf.js";import{config_not_found_default as c}from"./config-not-found-BVqhRP9D.js";import{renderItems as l}from"./common-utils-lQ4FwDQy.js";import u from"node:path";import{CookieJar as d}from"tough-cookie";t();const f=`https://www.instagram.com`,p=f,m=async e=>{let t=await e.getCookieString(p);return t.match(/csrftoken=([^;]+)/)?.[1]},h=async e=>({"sec-fetch-dest":`empty`,"sec-fetch-mode":`cors`,"sec-fetch-site":`same-origin`,"x-asbd-id":359341,"x-csrftoken":await m(e),"x-ig-app-id":936619743392459,"x-ig-www-claim":`0`}),g=async e=>{let t=await o(`${f}/api/v1/web/fxcal/ig_sso_users/`,{headers:{"content-type":`application/x-www-form-urlencoded`,cookie:await e.getCookieString(p),...await h(e)},method:`POST`});return t.status===`ok`},_=async(e,t)=>{let n,i=await r.get(`instagram:getIdByUsername:${e}`),a=await r.get(`instagram:userInfo:${i}`);if(a=a&&typeof a==`string`?JSON.parse(a):a,!a)try{let a=await o.raw(`${f}/api/v1/users/web_profile_info/`,{headers:{cookie:await t.getCookieString(p),...await h(t)},query:{username:e}});if(a.url.includes(`/accounts/login/`))throw new c(`Invalid cookie`);n=a._data.data.user,i=n.id,await r.set(`instagram:getIdByUsername:${e}`,i,31536e3),await r.set(`instagram:userInfo:${i}`,n)}catch(e){throw e.message.includes(`Cookie not in this host's domain`)?new c(`Invalid cookie`):e}return a||n},v=(e,t,i)=>r.tryGet(`instagram:feed:${e}`,async()=>{let e=await o.raw(`${f}/api/v1/feed/user/${t}/username/`,{headers:{cookie:await i.getCookieString(p),...await h(i)},query:{count:30}});if(e.url.includes(`/accounts/login/`))throw new c(`Invalid cookie.
                Please also check if your account is being blocked by Instagram.`);return e._data.items},n.cache.routeExpire,!1),y=(e,t)=>r.tryGet(`instagram:tags:${e}`,async()=>{let n=await o(`${f}/api/v1/tags/web_info/`,{headers:{cookie:await t.getCookieString(p),...await h(t)},query:{tag_name:e}});return n.data},n.cache.routeExpire,!1),b=t=>{let n=(t,n)=>i(u.join(e,`templates/video-2b01879c.art`),{summary:n,image:t.display_url,video:{url:t.video_url,height:t.dimensions.height,width:t.dimensions.width}}),r=(t,n)=>i(u.join(e,`templates/images-4bd74d43.art`),{summary:n,images:[{url:t.display_url,height:t.dimensions.height,width:t.dimensions.width}]});return t.map(({node:e})=>{let t=e.__typename,i=e.edge_media_to_caption.edges[0]?.node.text??``,o=``;switch(t){case`GraphSidecar`:o=e.edge_sidecar_to_children?e.edge_sidecar_to_children.edges.map(({node:e},t)=>{let a=e.__typename;switch(a){case`GraphVideo`:return n(e,t===0?i:``);case`GraphImage`:return r(e,t===0?i:``);default:throw Error(`Instagram: Unhandled carousel type: ${a}`)}}).join(``):r(e,i);break;case`GraphVideo`:o=n(e,i);break;case`GraphImage`:o=r(e,i);break;default:throw Error(`Instagram: Unhandled feed type: ${t}`)}return{title:i.split(`
`)[0],id:e.id,pubDate:a(e.taken_at_timestamp,`X`),author:e.owner.username,link:`${f}/p/${e.shortcode}/`,summary:i,description:o}})},x={path:`/2/:category/:key`,categories:[`social-media`],example:`/instagram/2/user/stefaniejoosten`,parameters:{category:`Feed category, see table below`,key:`Username / Hashtag name`},features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!0,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`User Profile / Hashtag`,maintainers:[`TonyRL`],handler:S,description:`::: tip
You may need to setup cookie for a less restrictive rate limit and private profiles.
:::


| User timeline | Hashtag |
| ------------- | ------- |
| user          | tags    |`};async function S(e){let t=[`user`,`tags`],{category:i,key:a}=e.req.param(),{cookie:o}=n.instagram;if(!t.includes(i))throw new s(`Such feed is not supported.`);let u=await r.get(`instagram:cookieJar`),m=!u;if(m){if(u=new d,o)for await(let e of o.split(`; `))await u.setCookie(e,p)}else u=d.fromJSON(u);if(o&&!await g(u))throw new c(`Invalid cookie`);let h,x,S,C,w;switch(i){case`user`:{let e=await _(a,u),t=e.biography,n=e.full_name,r=e.id,i=e.username;h=`${n} (@${i}) - Instagram`,S=t,C=e.profile_pic_url_hd??e.hd_profile_pic_url_info?.url??e.profile_pic_url,x=`${f}/${i}`,w=o?await v(r,i,u):[...e.edge_felix_video_timeline.edges,...e.edge_owner_to_timeline_media.edges];break}case`tags`:{if(!n.instagram||!n.instagram.cookie)throw new c(`Instagram RSS is disabled due to the lack of <a href="https://docs.rsshub.app/deploy/config#route-specific-configurations">relevant config</a>`);let e=a;h=`#${e} - Instagram`,x=`${f}/explore/search/keyword/?q=%23${e}`;let t=await y(e,u);C=t.profile_pic_url,w=t.top.sections.flatMap(e=>(e.feed_type===`media`?e.layout_content.medias:[...e.layout_content.one_by_two_item.clips.items,...e.layout_content.fill_items]).map(e=>e.media));break}default:break}return await r.set(`instagram:cookieJar`,u.toJSON(),31536e3),{title:h,link:x,description:S,item:o?l(w):b(w),icon:`${f}/static/images/ico/xxhdpi_launcher.png/99cf3909d459.png`,logo:C,image:C,allowEmpty:!0}}export{x as route};
//# sourceMappingURL=web-api-YITebs7G.js.map