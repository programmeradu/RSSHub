{"version":3,"file":"weather-live-Dy4Th_CA.js","names":[],"sources":["../../lib/routes/121/weather-live.ts"],"sourcesContent":["import { type Data, type DataItem, type Route, ViewType } from '@/types';\r\n\r\nimport { art } from '@/utils/render';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nimport { type CheerioAPI, load } from 'cheerio';\r\nimport { type Context } from 'hono';\r\nimport path from 'node:path';\r\n\r\nexport const handler = async (ctx: Context): Promise<Data> => {\r\n    const limit: number = Number.parseInt(ctx.req.query('limit') ?? '100', 10);\r\n\r\n    const baseUrl: string = 'https://tf.121.com.cn';\r\n    const imgBaseUrl: string = 'https://wx.121.com.cn';\r\n    const targetUrl: string = new URL('web/weatherLive/', baseUrl).href;\r\n    const apiUrl: string = new URL('weather/weibo/message.js', baseUrl).href;\r\n\r\n    const targetResponse = await ofetch(targetUrl);\r\n    const $: CheerioAPI = load(targetResponse);\r\n    const language = $('html').attr('lang') ?? 'zh';\r\n\r\n    const response = await ofetch(apiUrl);\r\n    const messages = await response.text();\r\n\r\n    const items: DataItem[] = JSON.parse(messages.split(/var\\smessage=/).pop())\r\n        .slice(0, limit)\r\n        .map((item): DataItem => {\r\n            const title: string = item.Title;\r\n            const description: string | undefined = art(path.join(__dirname, 'templates/description.art'), {\r\n                description: item.Content,\r\n                images: item.Img?.map((img: string) => ({\r\n                    src: new URL(`WeChat/data/weiweb/images/lwspic/${img}`, imgBaseUrl).href,\r\n                    alt: title,\r\n                })),\r\n            });\r\n            const pubDate: number | string = item.DDatetime;\r\n            const linkUrl: string | undefined = targetUrl;\r\n            const guid: string = `121-${title}-${pubDate}`;\r\n            const image: string | undefined = item.Img?.length > 0 ? new URL(`WeChat/data/weiweb/images/lwspic/${item.Img[0]}`, imgBaseUrl).href : undefined;\r\n            const updated: number | string = pubDate;\r\n\r\n            const processedItem: DataItem = {\r\n                title,\r\n                description,\r\n                pubDate: pubDate ? parseDate(pubDate) : undefined,\r\n                link: linkUrl ?? new URL(item.id, baseUrl).href,\r\n                guid,\r\n                id: guid,\r\n                content: {\r\n                    html: description,\r\n                    text: description,\r\n                },\r\n                image,\r\n                banner: image,\r\n                updated: updated ? parseDate(updated) : undefined,\r\n                language,\r\n            };\r\n\r\n            return processedItem;\r\n        });\r\n\r\n    const title: string = $('title').text();\r\n\r\n    return {\r\n        title,\r\n        description: title,\r\n        link: targetUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: $('img').first().attr('src') ? new URL($('img').first().attr('src') as string, baseUrl).href : undefined,\r\n        author: $('div#webnameDiv').text(),\r\n        language,\r\n        id: targetUrl,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/weatherLive',\r\n    name: '深圳天气直播',\r\n    url: 'tf.121.com.cn',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/121/weatherLive',\r\n    parameters: undefined,\r\n    description: undefined,\r\n    categories: ['forecast'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['tf.121.com.cn', 'tf.121.com.cn/web/weatherLive'],\r\n            target: '/weatherLive',\r\n        },\r\n    ],\r\n    view: ViewType.Notifications,\r\n};\r\n"],"mappings":"8ZAUA,MAAa,EAAU,KAAO,IAAgC,CAC1D,IAAM,EAAgB,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,MAAO,IAEjE,EAAkB,wBAClB,EAAqB,wBACrB,EAAoB,IAAI,IAAI,mBAAoB,GAAS,KACzD,EAAiB,IAAI,IAAI,2BAA4B,GAAS,KAE9D,EAAiB,MAAM,EAAO,GAC9B,EAAgB,EAAK,GACrB,EAAW,EAAE,QAAQ,KAAK,SAAW,KAErC,EAAW,MAAM,EAAO,GACxB,EAAW,MAAM,EAAS,OAE1B,EAAoB,KAAK,MAAM,EAAS,MAAM,iBAAiB,OAChE,MAAM,EAAG,GACT,IAAK,GAAmB,CACrB,IAAM,EAAgB,EAAK,MACrB,EAAkC,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAC3F,YAAa,EAAK,QAClB,OAAQ,EAAK,KAAK,IAAK,IAAiB,CACpC,IAAK,IAAI,IAAI,oCAAoC,IAAO,GAAY,KACpE,IAAK,OAGP,EAA2B,EAAK,UAChC,EAA8B,EAC9B,EAAe,OAAO,EAAM,GAAG,IAC/B,EAA4B,EAAK,KAAK,OAAS,EAAI,IAAI,IAAI,oCAAoC,EAAK,IAAI,KAAM,GAAY,KAAO,IAAA,GACjI,EAA2B,EAE3B,EAA0B,CAC5B,MAAA,EACA,cACA,QAAS,EAAU,EAAU,GAAW,IAAA,GACxC,KAAM,GAAW,IAAI,IAAI,EAAK,GAAI,GAAS,KAC3C,OACA,GAAI,EACJ,QAAS,CACL,KAAM,EACN,KAAM,GAEV,QACA,OAAQ,EACR,QAAS,EAAU,EAAU,GAAW,IAAA,GACxC,YAGJ,OAAO,IAGT,EAAgB,EAAE,SAAS,OAEjC,MAAO,CACH,QACA,YAAa,EACb,KAAM,EACN,KAAM,EACN,WAAY,GACZ,MAAO,EAAE,OAAO,QAAQ,KAAK,OAAS,IAAI,IAAI,EAAE,OAAO,QAAQ,KAAK,OAAkB,GAAS,KAAO,IAAA,GACtG,OAAQ,EAAE,kBAAkB,OAC5B,WACA,GAAI,IAIC,EAAe,CACxB,KAAM,eACN,KAAM,SACN,IAAK,gBACL,YAAa,CAAC,WACd,UACA,QAAS,mBACT,WAAY,IAAA,GACZ,YAAa,IAAA,GACb,WAAY,CAAC,YACb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,aAAc,GACd,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,gBAAiB,iCAC1B,OAAQ,iBAGhB,KAAM,EAAS"}