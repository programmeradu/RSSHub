{"version":3,"file":"utils-ulRZsC01.js","names":["headers: HeadersInit","ofetch"],"sources":["../../lib/routes/yamibo/utils.ts"],"sourcesContent":["import { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { config } from '@/config';\r\nimport { JSDOM } from 'jsdom';\r\nimport type { Cheerio, Element } from 'cheerio';\r\n\r\nexport const bbsOrigin = 'https://bbs.yamibo.com';\r\n\r\nexport function getDate(date: string): Date {\r\n    return timezone(parseDate(date), 8);\r\n}\r\n\r\nexport async function fetchThread(\r\n    tid: string,\r\n    options?: {\r\n        ordertype?: string;\r\n        _dsign?: string;\r\n    },\r\n    retry = 0\r\n): Promise<{\r\n    link: string;\r\n    data?: string;\r\n}> {\r\n    const { auth, salt } = config.yamibo;\r\n    const params = new URLSearchParams();\r\n    params.set('mod', 'viewthread');\r\n    params.set('tid', tid);\r\n    if (options?.ordertype) {\r\n        params.set('ordertype', options.ordertype);\r\n    }\r\n    if (options?._dsign) {\r\n        params.set('_dsign', options._dsign);\r\n    }\r\n    const link = `https://bbs.yamibo.com/forum.php?${params.toString()}`;\r\n\r\n    const headers: HeadersInit = {};\r\n\r\n    if (auth && salt) {\r\n        headers.cookie = `EeqY_2132_saltkey=${salt}; EeqY_2132_auth=${auth}`;\r\n    }\r\n\r\n    const data = await ofetch<string>(link, { headers });\r\n\r\n    // sometimes may trigger anti-crawling measures\r\n    if (data.startsWith('<script type=\"text/javascript\">') && retry <= 3) {\r\n        let script = data.match(/<script type=\"text\\/javascript\">([\\S\\s]*?)<\\/script>/)![1];\r\n        script = script.replace(/= location;|=location;/, '=fakeLocation;');\r\n        script = script.replace('location.replace', 'foo');\r\n        script = script.replace('location.assign', 'foo');\r\n        script = script.replace(/location\\[[^\\]]*]\\(/, 'foo(');\r\n        script = script.replace(/location\\[[^\\]]*]=/, 'window.locationValue=');\r\n        script = script.replace('location.href=', 'window.locationValue=');\r\n        script = script.replace('location=', 'window.locationValue=');\r\n        const dom = new JSDOM(\r\n            `<script>\r\n                function foo(value) { window.locationValue = value; };\r\n                fakeLocation = { href: '', replace: foo, assign: foo };\r\n                Object.defineProperty(fakeLocation, 'href', {\r\n                    set: function (value) {\r\n                        window.locationValue = value;\r\n                    }\r\n                });\r\n                ${script}\r\n            </script>`,\r\n            {\r\n                runScripts: 'dangerously',\r\n            }\r\n        );\r\n        const locationValue = dom.window.locationValue;\r\n        if (locationValue) {\r\n            const searchParams = new URLSearchParams(locationValue);\r\n            const _dsign = searchParams.get('_dsign');\r\n            if (_dsign) {\r\n                options = {\r\n                    ...options,\r\n                    _dsign,\r\n                };\r\n            }\r\n        }\r\n        return await fetchThread(tid, options, ++retry);\r\n    }\r\n\r\n    return {\r\n        link,\r\n        data,\r\n    };\r\n}\r\n\r\nexport function generateDescription($item: Cheerio<Element>, postId: string) {\r\n    const content = $item.find(`#postmessage_${postId}`).parent();\r\n    content.find('img').each((_, img) => {\r\n        const src = img.attribs.zoomfile ?? img.attribs.src;\r\n        img.attribs.src = `${bbsOrigin}/${src}`;\r\n    });\r\n    let description = content.html() ?? '';\r\n\r\n    const images = $item.find('.pattl img').toArray();\r\n    for (const img of images) {\r\n        const src = img.attribs.zoomfile ?? img.attribs.src;\r\n        description += `<img src=\"${bbsOrigin}/${src}\" />`;\r\n    }\r\n\r\n    return description;\r\n}\r\n"],"mappings":"yOAOA,MAAa,EAAY,yBAEzB,SAAgB,EAAQ,EAAoB,CACxC,OAAO,EAAS,EAAU,GAAO,GAGrC,eAAsB,EAClB,EACA,EAIA,EAAQ,EAIT,CACC,GAAM,CAAE,OAAM,QAAS,EAAO,OACxB,EAAS,IAAI,gBACnB,EAAO,IAAI,MAAO,cAClB,EAAO,IAAI,MAAO,GACd,GAAS,WACT,EAAO,IAAI,YAAa,EAAQ,WAEhC,GAAS,QACT,EAAO,IAAI,SAAU,EAAQ,QAEjC,IAAM,EAAO,oCAAoC,EAAO,aAElDA,EAAuB,GAEzB,GAAQ,IACR,EAAQ,OAAS,qBAAqB,EAAK,mBAAmB,KAGlE,IAAM,EAAO,MAAMC,EAAe,EAAM,CAAE,YAG1C,GAAI,EAAK,WAAW,oCAAsC,GAAS,EAAG,CAClE,IAAI,EAAS,EAAK,MAAM,wDAAyD,GACjF,EAAS,EAAO,QAAQ,yBAA0B,kBAClD,EAAS,EAAO,QAAQ,mBAAoB,OAC5C,EAAS,EAAO,QAAQ,kBAAmB,OAC3C,EAAS,EAAO,QAAQ,sBAAuB,QAC/C,EAAS,EAAO,QAAQ,qBAAsB,yBAC9C,EAAS,EAAO,QAAQ,iBAAkB,yBAC1C,EAAS,EAAO,QAAQ,YAAa,yBACrC,IAAM,EAAM,IAAI,EACZ;;;;;;;;kBAQM,EAAO;wBAEb,CACI,WAAY,gBAGd,EAAgB,EAAI,OAAO,cACjC,GAAI,EAAe,CACf,IAAM,EAAe,IAAI,gBAAgB,GACnC,EAAS,EAAa,IAAI,UAC5B,IACA,EAAU,CACN,GAAG,EACH,WAIZ,OAAO,MAAM,EAAY,EAAK,EAAS,EAAE,GAG7C,MAAO,CACH,OACA,QAIR,SAAgB,EAAoB,EAAyB,EAAgB,CACzE,IAAM,EAAU,EAAM,KAAK,gBAAgB,KAAU,SACrD,EAAQ,KAAK,OAAO,MAAM,EAAG,IAAQ,CACjC,IAAM,EAAM,EAAI,QAAQ,UAAY,EAAI,QAAQ,IAChD,EAAI,QAAQ,IAAM,GAAG,EAAU,GAAG,MAEtC,IAAI,EAAc,EAAQ,QAAU,GAE9B,EAAS,EAAM,KAAK,cAAc,UACxC,IAAK,IAAM,KAAO,EAAQ,CACtB,IAAM,EAAM,EAAI,QAAQ,UAAY,EAAI,QAAQ,IAChD,GAAe,aAAa,EAAU,GAAG,EAAI,MAGjD,OAAO"}