{"version":3,"file":"sogou-D39hnjTo.js","names":["ofetch","error: unknown","route: Route","allItems: SogouItemInternal[]","resultItem: DataItem | SogouItemInternal","finalItem: DataItem","finalItems: DataItem[]"],"sources":["../../lib/routes/wechat/sogou.ts"],"sourcesContent":["import { Route, DataItem } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { finishArticleItem } from '@/utils/wechat-mp';\r\nimport logger from '@/utils/logger';\r\n\r\nconst host = 'https://weixin.sogou.com';\r\nconst hardcodedCookie = 'SNUID=78725B470A0EF2C3F97AA5EB0BBF95C1; ABTEST=0|1680917938|v1; SUID=8F7B1C682B83A20A000000006430C5B2; PHPSESSID=le2lak0vghad5c98ijd3t51ls4; IPLOC=USUS5';\r\n\r\ninterface SogouItemInternal extends DataItem {\r\n    _internal: {\r\n        isWeChatLink: boolean;\r\n    };\r\n}\r\n\r\nasync function fetchAndParsePage(wechatId: string): Promise<SogouItemInternal[]> {\r\n    const searchUrl = `${host}/weixin`;\r\n    let response;\r\n    try {\r\n        const responseHtml = await ofetch(searchUrl, {\r\n            query: {\r\n                ie: 'utf8',\r\n                s_from: 'input',\r\n                _sug_: 'n',\r\n                _sug_type_: '1',\r\n                type: '2',\r\n                query: wechatId,\r\n                page: '1',\r\n            },\r\n            headers: {\r\n                Referer: host,\r\n                Cookie: hardcodedCookie,\r\n            },\r\n        });\r\n        response = { data: responseHtml };\r\n    } catch (error) {\r\n        logger.error(`Failed to fetch Sogou search for ${wechatId}: ${error instanceof Error ? error.message : String(error)}`);\r\n        return [];\r\n    }\r\n\r\n    const $ = load(response.data);\r\n    const list = $('ul.news-list > li').toArray();\r\n\r\n    const pageItemsPromises = list.map(async (li): Promise<SogouItemInternal | null> => {\r\n        const $li = $(li);\r\n        const title = $li.find('h3 > a').text().trim();\r\n        const sogouLinkHref = $li.find('h3 > a').attr('href');\r\n        if (!sogouLinkHref) {\r\n            logger.warn(`Skipping item with missing link for wechatId: ${wechatId}`);\r\n            return null;\r\n        }\r\n        const sogouLink = host + sogouLinkHref;\r\n        const description = $li.find('p.txt-info').text().trim();\r\n\r\n        const timeScript = $li.find('span.s2 script').html();\r\n        const timeMatch = timeScript?.match(/timeConvert\\('(\\d+)'\\)/);\r\n        const pubDate = timeMatch ? parseDate(Number.parseInt(timeMatch[1]) * 1000) : undefined;\r\n\r\n        let realLink = sogouLink;\r\n        try {\r\n            const linkResponse = await ofetch.raw(sogouLink, {\r\n                headers: {\r\n                    Referer: searchUrl,\r\n                    Cookie: hardcodedCookie,\r\n                },\r\n                redirect: 'manual',\r\n                ignoreResponseError: true,\r\n            });\r\n\r\n            let location = linkResponse.headers?.get('location');\r\n\r\n            if (location) {\r\n                if (!location.startsWith('http')) {\r\n                    try {\r\n                        location = new URL(location, sogouLink).toString();\r\n                    } catch (error) {\r\n                        logger.warn(`Invalid redirect location \"${location}\" for title \"${title}\" (wechatId: ${wechatId}): ${error instanceof Error ? error.message : String(error)}`);\r\n                        location = null;\r\n                    }\r\n                }\r\n\r\n                if (typeof location === 'string' && location) {\r\n                    if (location.startsWith('http://mp.weixin.qq.com') || location.startsWith('https://mp.weixin.qq.com')) {\r\n                        realLink = location;\r\n                    } else {\r\n                        try {\r\n                            const intermediateResponse = await ofetch.raw(location, {\r\n                                headers: {\r\n                                    Referer: sogouLink,\r\n                                    Cookie: hardcodedCookie,\r\n                                },\r\n                                redirect: 'manual',\r\n                                ignoreResponseError: true,\r\n                            });\r\n                            const intermediateLocation = intermediateResponse.headers?.get('location');\r\n                            if (intermediateLocation && (intermediateLocation.startsWith('http://mp.weixin.qq.com') || intermediateLocation.startsWith('https://mp.weixin.qq.com'))) {\r\n                                realLink = intermediateLocation;\r\n                            } else {\r\n                                // logger.warn(`Could not resolve final WeChat link for title \"${title}\" (wechatId: ${wechatId}) after intermediate redirect`);\r\n                            }\r\n                        } catch (error) {\r\n                            logger.warn(`Failed to resolve intermediate redirect for title \"${title}\" (wechatId: ${wechatId}): ${error instanceof Error ? error.message : String(error)}`);\r\n                        }\r\n                    }\r\n                }\r\n            } else {\r\n                logger.debug(`No redirect location found for title \"${title}\" (wechatId: ${wechatId})`);\r\n            }\r\n        } catch (error: unknown) {\r\n            const errorMsg = error instanceof Error ? error.message : String(error);\r\n            if (typeof error === 'object' && error !== null && 'response' in error && typeof error.response === 'object' && error.response !== null && 'status' in error.response) {\r\n                logger.debug(`Redirect request failed for \"${title}\" (wechatId: ${wechatId}) with status ${error.response.status}: ${errorMsg}`);\r\n            } else {\r\n                logger.debug(`Redirect request failed for \"${title}\" (wechatId: ${wechatId}): ${errorMsg}`);\r\n            }\r\n        }\r\n\r\n        const isWeChatLink = realLink.startsWith('http://mp.weixin.qq.com') || realLink.startsWith('https://mp.weixin.qq.com');\r\n        const author = $li.find('span.all-time-y2').text().trim();\r\n\r\n        return {\r\n            title,\r\n            link: realLink,\r\n            description,\r\n            author,\r\n            pubDate,\r\n            guid: realLink,\r\n            _internal: {\r\n                isWeChatLink,\r\n            },\r\n        } as SogouItemInternal;\r\n    });\r\n\r\n    return (await Promise.all(pageItemsPromises)).filter((item): item is SogouItemInternal => item !== null);\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/sogou/:id',\r\n    categories: ['new-media'],\r\n    example: '/wechat/sogou/qimao0908',\r\n    parameters: { id: '公众号 id, 打开 weixin.sogou.com 并搜索相应公众号， 在 URL 中找到 id' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '公众号（搜狗来源）',\r\n    maintainers: ['EthanWng97', 'pseudoyu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const wechatId = ctx.req.param('id');\r\n\r\n    const allItems: SogouItemInternal[] = await fetchAndParsePage(wechatId);\r\n\r\n    const firstPageFirstItem = allItems[0];\r\n    const accountTitle = firstPageFirstItem?.author || wechatId;\r\n\r\n    const finalItemsPromises = allItems.map(async (item: SogouItemInternal): Promise<DataItem | null> => {\r\n        let resultItem: DataItem | SogouItemInternal = item;\r\n        if (item._internal.isWeChatLink) {\r\n            try {\r\n                resultItem = await finishArticleItem(item);\r\n            } catch (error) {\r\n                logger.debug(`finishArticleItem failed for ${item.link}: ${error instanceof Error ? error.message : String(error)}`);\r\n            }\r\n        }\r\n\r\n        if (resultItem && typeof resultItem === 'object') {\r\n            const finalItem: DataItem = {\r\n                title: resultItem.title,\r\n                link: resultItem.link,\r\n                description: resultItem.description,\r\n                author: resultItem.author,\r\n                pubDate: resultItem.pubDate,\r\n                guid: resultItem.guid,\r\n                ...(resultItem.content && { content: resultItem.content }),\r\n            };\r\n            return finalItem;\r\n        }\r\n        logger.debug(`Unexpected null or non-object item during final processing for link: ${item?.link}`);\r\n        return null;\r\n    });\r\n\r\n    const finalItems: DataItem[] = (await Promise.all(finalItemsPromises)).filter((item): item is DataItem => item !== null);\r\n\r\n    return {\r\n        title: `${accountTitle} 的微信公众号`,\r\n        link: `${host}/weixin?query=${wechatId}`,\r\n        description: `${accountTitle} 的微信公众号`,\r\n        item: finalItems,\r\n    };\r\n}\r\n"],"mappings":"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"}