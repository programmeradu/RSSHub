{"version":3,"file":"utils-D44IyZHM.js","names":["got","cache","url"],"sources":["../../lib/routes/dapenti/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport iconv from 'iconv-lite';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nexport default {\r\n    parseFeed: async ({ subjectid }) => {\r\n        const url = `https://www.dapenti.com/blog/blog.asp?name=xilei&subjectid=${subjectid}`;\r\n        const listRes = await got({\r\n            method: 'get',\r\n            url,\r\n            headers: {\r\n                Referer: url,\r\n            },\r\n            // 喷嚏网编码为GBK，需要转码\r\n            // 转码需要设定返回数据的格式，其可选项是arraybuffer,blob,document,json,text,stream\r\n            // 默认为json\r\n            responseType: 'buffer',\r\n        });\r\n        // 转码\r\n        const data = iconv.decode(listRes.data, 'gb2312');\r\n        const $ = load(data);\r\n        // 只取最近的三个，取全文rss\r\n        const list = $('li', 'ul').slice(0, 3).toArray();\r\n\r\n        const result_item = await Promise.all(\r\n            list.map((item) =>\r\n                cache.tryGet(`https://www.dapenti.com/blog/${$(item).find('a').attr('href')}`, async () => {\r\n                    const el = $(item);\r\n                    const url = `https://www.dapenti.com/blog/${el.find('a').attr('href')}`;\r\n                    const original_data = await got({\r\n                        method: 'get',\r\n                        url,\r\n                        headers: {\r\n                            Referer: url,\r\n                        },\r\n                        responseType: 'buffer',\r\n                    });\r\n                    const convert_data = iconv.decode(original_data.data, 'gbk');\r\n                    const description = load(convert_data, {\r\n                        decodeEntities: false,\r\n                    })('body > table > tbody > tr > td.oblog_t_2 > div > table > tbody > tr:nth-child(2) > td');\r\n                    const pubInfo = description.find('span span.oblog_text').text().split('发布于');\r\n                    description.find('table, .adsbygoogle').remove();\r\n\r\n                    // remove header\r\n                    const count = subjectid.toString() === '70' ? 7 : 3;\r\n                    for (let index = 0; index < count; index++) {\r\n                        description.children().first().remove();\r\n                    }\r\n\r\n                    // remove footer\r\n                    for (let index = 0; index < 8; index++) {\r\n                        description.children().last().remove();\r\n                    }\r\n                    const single = {\r\n                        title: el.text(),\r\n                        author: pubInfo[0].trim(),\r\n                        description: description.html(),\r\n                        pubDate: timezone(parseDate(pubInfo[1]?.trim()), +8),\r\n                        link: url,\r\n                    };\r\n                    return single;\r\n                })\r\n            )\r\n        );\r\n\r\n        return {\r\n            title: `喷嚏-${subjectid}`,\r\n            link: url,\r\n            item: result_item,\r\n        };\r\n    },\r\n};\r\n"],"mappings":"oQAOA,IAAA,EAAe,CACX,UAAW,MAAO,CAAE,eAAgB,CAChC,IAAM,EAAM,8DAA8D,IACpE,EAAU,MAAMA,EAAI,CACtB,OAAQ,MACR,MACA,QAAS,CACL,QAAS,GAKb,aAAc,WAGZ,EAAO,EAAM,OAAO,EAAQ,KAAM,UAClC,EAAI,EAAK,GAET,EAAO,EAAE,KAAM,MAAM,MAAM,EAAG,GAAG,UAEjC,EAAc,MAAM,QAAQ,IAC9B,EAAK,IAAK,GACNC,EAAM,OAAO,gCAAgC,EAAE,GAAM,KAAK,KAAK,KAAK,UAAW,SAAY,CACvF,IAAM,EAAK,EAAE,GACPC,EAAM,gCAAgC,EAAG,KAAK,KAAK,KAAK,UACxD,EAAgB,MAAMF,EAAI,CAC5B,OAAQ,MACR,IAAA,EACA,QAAS,CACL,QAASE,GAEb,aAAc,WAEZ,EAAe,EAAM,OAAO,EAAc,KAAM,OAChD,EAAc,EAAK,EAAc,CACnC,eAAgB,KACjB,yFACG,EAAU,EAAY,KAAK,wBAAwB,OAAO,MAAM,OACtE,EAAY,KAAK,uBAAuB,SAGxC,IAAM,EAAQ,EAAU,aAAe,KAAO,EAAI,EAClD,IAAK,IAAI,EAAQ,EAAG,EAAQ,EAAO,IAC/B,EAAY,WAAW,QAAQ,SAInC,IAAK,IAAI,EAAQ,EAAG,EAAQ,EAAG,IAC3B,EAAY,WAAW,OAAO,SAElC,IAAM,EAAS,CACX,MAAO,EAAG,OACV,OAAQ,EAAQ,GAAG,OACnB,YAAa,EAAY,OACzB,QAAS,EAAS,EAAU,EAAQ,IAAI,QAAS,GACjD,KAAMA,GAEV,OAAO,MAKnB,MAAO,CACH,MAAO,MAAM,IACb,KAAM,EACN,KAAM"}