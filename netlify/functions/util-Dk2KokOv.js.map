{"version":3,"file":"util-Dk2KokOv.js","names":[],"sources":["../../lib/routes/foresightnews/util.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport zlib from 'node:zlib';\r\n\r\nconst constants = {\r\n    labelHot: '热门',\r\n    labelImportant: '重要消息',\r\n    defaultType: 'article',\r\n};\r\n\r\nconst params = {\r\n    article: 'article',\r\n    event: 'timeline',\r\n    news: 'news',\r\n};\r\n\r\nconst rootUrl = 'https://foresightnews.pro';\r\nconst apiRootUrl = 'https://api.foresightnews.pro';\r\nconst imgRootUrl = 'https://img.foresightnews.pro';\r\n\r\nconst icon = new URL('foresight.ico', rootUrl).href;\r\nconst image = new URL('vertical_logo.png', imgRootUrl).href;\r\n\r\nconst processItems = async (apiUrl, limit, ...parameters) => {\r\n    let searchParams = {\r\n        size: limit,\r\n    };\r\n    for (const param of parameters) {\r\n        searchParams = {\r\n            ...searchParams,\r\n            ...param,\r\n        };\r\n    }\r\n\r\n    const info = {\r\n        column: '',\r\n    };\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams,\r\n    });\r\n\r\n    let items = JSON.parse(String(zlib.inflateSync(Buffer.from(response.data?.list ?? response.data, 'base64'))));\r\n\r\n    items = (items?.list ?? items).slice(0, limit).map((item) => {\r\n        const sourceType = item.source_type ?? (item.source_link ? (item.column?.title ? 'article' : 'news') : item.event_type ? 'event' : constants.defaultType);\r\n\r\n        item = item.source_type ? item[item.source_type] : item;\r\n\r\n        const column = item.column?.title;\r\n        info.column = info.column || column;\r\n\r\n        const categories = [\r\n            column,\r\n            item.event_type,\r\n            item.is_hot ? constants.labelHot : undefined,\r\n            item.is_important ? (item.important_tag?.name ?? constants.labelImportant) : '',\r\n            item.label,\r\n            ...(item.tags?.map((c) => c.name) ?? []),\r\n        ].filter((v, index, self) => v && self.indexOf(v) === index);\r\n\r\n        const link = new URL(`${params[sourceType]}/detail/${item.id}`, rootUrl).href;\r\n\r\n        return {\r\n            title: item.title,\r\n            link,\r\n            description: art(path.join(__dirname, 'templates/description.art'), {\r\n                image: item.img.split('?')[0],\r\n                description: item.content ?? item.brief,\r\n                source: item.source_link,\r\n            }),\r\n            author: item.column?.title ?? item.author?.username ?? undefined,\r\n            category: categories,\r\n            guid: `foresightnews-${sourceType}#${item.id}`,\r\n            pubDate: item.published_at ? parseDate(item.published_at * 1000) : undefined,\r\n            updated: item.last_update_at ? parseDate(item.last_update_at * 1000) : undefined,\r\n        };\r\n    });\r\n\r\n    return { items, info };\r\n};\r\n\r\nexport { icon, image, rootUrl, apiRootUrl, imgRootUrl, processItems };\r\n"],"mappings":"8QAMA,MAAM,EAAY,CACd,SAAU,KACV,eAAgB,OAChB,YAAa,WAGX,EAAS,CACX,QAAS,UACT,MAAO,WACP,KAAM,QAGJ,EAAU,4BACV,EAAa,gCAGb,EAAO,IAAI,IAAI,gBAAiB,GAAS,KACzC,EAAQ,IAAI,IAAI,oBAAqB,iCAAY,KAEjD,EAAe,MAAO,EAAQ,EAAO,GAAG,IAAe,CACzD,IAAI,EAAe,CACf,KAAM,GAEV,IAAK,IAAM,KAAS,EAChB,EAAe,CACX,GAAG,EACH,GAAG,GAIX,IAAM,EAAO,CACT,OAAQ,IAGN,CAAE,KAAM,GAAa,MAAM,EAAI,EAAQ,CACzC,iBAGA,EAAQ,KAAK,MAAM,OAAO,EAAK,YAAY,OAAO,KAAK,EAAS,MAAM,MAAQ,EAAS,KAAM,aAqCjG,MAnCA,IAAS,GAAO,MAAQ,GAAO,MAAM,EAAG,GAAO,IAAK,GAAS,CACzD,IAAM,EAAa,EAAK,cAAgB,EAAK,YAAe,EAAK,QAAQ,MAAQ,UAAY,OAAU,EAAK,WAAa,QAAU,EAAU,aAE7I,EAAO,EAAK,YAAc,EAAK,EAAK,aAAe,EAEnD,IAAM,EAAS,EAAK,QAAQ,MAC5B,EAAK,OAAS,EAAK,QAAU,EAE7B,IAAM,EAAa,CACf,EACA,EAAK,WACL,EAAK,OAAS,EAAU,SAAW,IAAA,GACnC,EAAK,aAAgB,EAAK,eAAe,MAAQ,EAAU,eAAkB,GAC7E,EAAK,MACL,GAAI,EAAK,MAAM,IAAK,GAAM,EAAE,OAAS,IACvC,QAAQ,EAAG,EAAO,IAAS,GAAK,EAAK,QAAQ,KAAO,GAEhD,EAAO,IAAI,IAAI,GAAG,EAAO,GAAY,UAAU,EAAK,KAAM,GAAS,KAEzE,MAAO,CACH,MAAO,EAAK,MACZ,OACA,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,EAAK,IAAI,MAAM,KAAK,GAC3B,YAAa,EAAK,SAAW,EAAK,MAClC,OAAQ,EAAK,cAEjB,OAAQ,EAAK,QAAQ,OAAS,EAAK,QAAQ,UAAY,IAAA,GACvD,SAAU,EACV,KAAM,iBAAiB,EAAW,GAAG,EAAK,KAC1C,QAAS,EAAK,aAAe,EAAU,EAAK,aAAe,KAAQ,IAAA,GACnE,QAAS,EAAK,eAAiB,EAAU,EAAK,eAAiB,KAAQ,IAAA,MAIxE,CAAE,QAAO"}