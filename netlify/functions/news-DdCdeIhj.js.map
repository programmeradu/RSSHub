{"version":3,"file":"news-DdCdeIhj.js","names":["route: Route","got","options: {\r\n        category: string[];\r\n        subcategory?: string | string[];\r\n        brand?: string | string[];\r\n    }","cache"],"sources":["../../lib/routes/idolmaster/news.ts"],"sourcesContent":["import { Route, Data, DataItem } from '@/types';\r\nimport type { Context } from 'hono';\r\nimport got from '@/utils/got';\r\nimport querystring from 'node:querystring';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\n\r\nexport const route: Route = {\r\n    url: 'idolmaster-official.jp/news',\r\n    path: '/news/:routeParams?',\r\n    categories: ['anime'],\r\n    example: '/idolmaster/news/brand=MILLIONLIVE&brand=SHINYCOLORS&category=GAME&category=ANIME',\r\n    parameters: {\r\n        routeParams: 'The `brand` and `category` params in the path. The available values are as follows.',\r\n    },\r\n    description: `**Brand**\r\n| THE IDOLM@STER | シンデレラガールズ | ミリオンライブ！ | SideM | シャイニーカラーズ | 学園アイドルマスター | その他 |\r\n| -------------- | --------------- | ------------- | ----- | --------------- | ----------------- | ----- |\r\n| IDOLMASTER | CINDERELLAGIRLS | MILLIONLIVE | SIDEM | SHINYCOLORS | GAKUEN | OTHER |\r\n\r\n**Category**\r\n| ゲーム | ライブ・イベント | アニメ | 配信番組 | ラジオ | グッズ | コラボ・キャンペーン | ミュージック | ブック・コミック | メディア | その他 |\r\n| ----- | ------------- | ----- | ------- | ----- | ----- | ----------------- | --------- | -------------- | ------ | ----- |\r\n| GAME | LIVE-EVENT | ANIME | LIVESTREAM | RADIO | GOODS | COLLABO-CAMP | CD | BOOK | MEDIA | OTHER |\r\n    `,\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['idolmaster-official.jp/news'],\r\n            target: '/news',\r\n        },\r\n    ],\r\n    name: 'ニュース News',\r\n    maintainers: ['keocheung'],\r\n    handler,\r\n};\r\n\r\nconst apiUrl = 'https://cmsapi-frontend.idolmaster-official.jp';\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const tokenUrl = `${apiUrl}/sitern/api/cmsbase/Token/get`;\r\n    const tokenRsp = await got(tokenUrl);\r\n    const token = tokenRsp.data.data.token;\r\n\r\n    const options: {\r\n        category: string[];\r\n        subcategory?: string | string[];\r\n        brand?: string | string[];\r\n    } = {\r\n        category: ['NEWS'],\r\n    };\r\n\r\n    const routeParams = ctx.req.param('routeParams');\r\n    if (routeParams) {\r\n        const queries = querystring.parse(routeParams);\r\n        options.subcategory = toUpperCase(queries.category);\r\n        options.brand = toUpperCase(queries.brand);\r\n    }\r\n\r\n    const limitParam = ctx.req.query('limit');\r\n    let limit = limitParam ? Number.parseInt(limitParam) : 12;\r\n    if (limit > 30) {\r\n        limit = 30;\r\n    }\r\n    const listUrl = `${apiUrl}/sitern/api/idolmaster/Article/list?site=jp&ip=idolmaster&token=${token}&sort=desc&data=${JSON.stringify(options)}&limit=${limit}&start=0`;\r\n    const listnRsp = await got(listUrl);\r\n    const articleList = listnRsp.data.data.article_list;\r\n\r\n    let items = articleList.map(\r\n        (article): DataItem => ({\r\n            title: article.title,\r\n            link: article.url,\r\n            pubDate: timezone(parseDate(article.dspdate), +9),\r\n            category: article.categories.subcategory.map((cat) => cat.name),\r\n        })\r\n    );\r\n\r\n    items = await Promise.all(\r\n        items.map((item: DataItem) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const rsp = await got(item.link);\r\n                const content = load(rsp.data);\r\n                const nextData = JSON.parse(content('script#__NEXT_DATA__').text());\r\n                item.description = `<div lang=\"ja\">${nextData.props.pageProps.data.content?.replaceAll('<img src=\"', `<img src=\"${apiUrl}/sitern/api/idolmaster/Image/get?path=`)}</div>`;\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: 'NEWS | アイドルマスター',\r\n        link: 'https://idolmaster-official.jp/news',\r\n        item: items,\r\n        language: 'ja',\r\n    };\r\n}\r\n\r\nfunction toUpperCase(input: string | string[] | undefined): string | string[] | undefined {\r\n    if (!input) {\r\n        return input;\r\n    }\r\n    return typeof input === 'string' ? input.toUpperCase() : input.map((item) => item.toUpperCase());\r\n}\r\n"],"mappings":"0bASA,MAAaA,EAAe,CACxB,IAAK,8BACL,KAAM,sBACN,WAAY,CAAC,SACb,QAAS,oFACT,WAAY,CACR,YAAa,uFAEjB,YAAa;;;;;;;;;MAUb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,+BACT,OAAQ,UAGhB,KAAM,YACN,YAAa,CAAC,aACd,WAGE,EAAS,iDAEf,eAAe,EAAQ,EAA6B,CAChD,IAAM,EAAW,GAAG,EAAO,+BACrB,EAAW,MAAMC,EAAI,GACrB,EAAQ,EAAS,KAAK,KAAK,MAE3BC,EAIF,CACA,SAAU,CAAC,SAGT,EAAc,EAAI,IAAI,MAAM,eAClC,GAAI,EAAa,CACb,IAAM,EAAU,EAAY,MAAM,GAClC,EAAQ,YAAc,EAAY,EAAQ,UAC1C,EAAQ,MAAQ,EAAY,EAAQ,OAGxC,IAAM,EAAa,EAAI,IAAI,MAAM,SAC7B,EAAQ,EAAa,OAAO,SAAS,GAAc,GACnD,EAAQ,KACR,EAAQ,IAEZ,IAAM,EAAU,GAAG,EAAO,kEAAkE,EAAM,kBAAkB,KAAK,UAAU,GAAS,SAAS,EAAM,UACrJ,EAAW,MAAMD,EAAI,GACrB,EAAc,EAAS,KAAK,KAAK,aAEnC,EAAQ,EAAY,IACnB,IAAuB,CACpB,MAAO,EAAQ,MACf,KAAM,EAAQ,IACd,QAAS,EAAS,EAAU,EAAQ,SAAU,GAC9C,SAAU,EAAQ,WAAW,YAAY,IAAK,GAAQ,EAAI,SAgBlE,MAZA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPE,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAM,MAAMF,EAAI,EAAK,MACrB,EAAU,EAAK,EAAI,MACnB,EAAW,KAAK,MAAM,EAAQ,wBAAwB,QAE5D,MADA,GAAK,YAAc,kBAAkB,EAAS,MAAM,UAAU,KAAK,SAAS,WAAW,aAAc,aAAa,EAAO,yCAAyC,QAC3J,MAKZ,CACH,MAAO,kBACP,KAAM,sCACN,KAAM,EACN,SAAU,MAIlB,SAAS,EAAY,EAAqE,CAItF,OAHK,IAGE,OAAO,GAAU,SAAW,EAAM,cAAgB,EAAM,IAAK,GAAS,EAAK"}