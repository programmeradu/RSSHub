{"version":3,"file":"app-a5cu0HeT.js","names":[],"sources":["../../lib/routes/washingtonpost/app.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { FetchError } from 'ofetch';\r\nimport dayjs from 'dayjs';\r\nimport utc from 'dayjs/plugin/utc.js';\r\nimport timezone from 'dayjs/plugin/timezone.js';\r\nimport advancedFormat from 'dayjs/plugin/advancedFormat.js';\r\n\r\nexport const route: Route = {\r\n    path: '/app/:category{.+}?',\r\n    categories: ['traditional-media'],\r\n    example: '/washingtonpost/app/national',\r\n    parameters: {\r\n        category: 'Category from the path of the URL of the corresponding site, see below',\r\n    },\r\n    features: {\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'App',\r\n    maintainers: ['quiniapiezoelectricity'],\r\n    radar: [\r\n        {\r\n            source: ['www.washingtonpost.com/:category'],\r\n            target: '/app/:category',\r\n        },\r\n    ],\r\n    handler,\r\n    description: `::: tip\r\nFor example, the category for https://www.washingtonpost.com/national/investigations would be /national/investigations.\r\n:::`,\r\n};\r\n\r\nfunction handleDuplicates(array) {\r\n    const objects = {};\r\n    for (const obj of array) {\r\n        objects[obj.id] = objects[obj.id] ? Object.assign(objects[obj.id], obj) : obj;\r\n    }\r\n    return Object.values(objects);\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category') ?? '';\r\n    const headers = {\r\n        Accept: '*/*',\r\n        Connection: 'keep-alive',\r\n        'User-Agent': 'Classic/6.70.0',\r\n    };\r\n    dayjs.extend(utc);\r\n    dayjs.extend(timezone);\r\n    dayjs.extend(advancedFormat);\r\n    art.defaults.imports.dayjs = dayjs;\r\n\r\n    const url = `https://jsonapp1.washingtonpost.com/fusion_prod/v2/${category}`;\r\n    const response = await got.get(url, { headers });\r\n    const title = response.data.tracking.page_title.includes('Washington Post') ? response.data.tracking.page_title : `The Washington Post - ${response.data.tracking.page_title}`;\r\n    const link = 'https://washingtonpost.com' + response.data.tracking.page_path;\r\n    const mains = response.data.regions[0].items.filter((item) => item.items);\r\n    const list = mains.flatMap((main) =>\r\n        main.items[0].items\r\n            .filter((item) => item.is_from_feed === true)\r\n            .map((item) => {\r\n                const object = {\r\n                    id: item.id,\r\n                    title: item.headline.text,\r\n                    link: item.link.url,\r\n                    pubDate: item.link.display_date,\r\n                    updated: item.link.last_modified,\r\n                };\r\n                if (item.blurbs?.items[0]?.text) {\r\n                    object.description = item.blurbs?.items[0]?.text;\r\n                }\r\n                return object;\r\n            })\r\n    );\r\n    const feed = handleDuplicates(list);\r\n    const items = await Promise.all(\r\n        feed.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                let response;\r\n                try {\r\n                    response = await got(`https://rainbowapi-a.wpdigital.net/rainbow-data-service/rainbow/content-by-url.json?followLinks=false&url=${item.link}`, { headers });\r\n                } catch (error) {\r\n                    if (error instanceof FetchError && error.statusCode === 415) {\r\n                        // Interactive or podcast contents will return 415 Unsupported Media Type. Keep calm and carry on.\r\n                        return item;\r\n                    } else {\r\n                        throw error;\r\n                    }\r\n                }\r\n                item.title = response.data.title ?? item.title;\r\n                item.author =\r\n                    response.data.items\r\n                        .filter((entry) => entry.type === 'byline')\r\n                        ?.flatMap((entry) => entry.authors.map((author) => author.name))\r\n                        ?.join(', ') ?? '';\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    content: response.data.items,\r\n                });\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"sjBAWA,MAAa,EAAe,CACxB,KAAM,sBACN,WAAY,CAAC,qBACb,QAAS,+BACT,WAAY,CACR,SAAU,0EAEd,SAAU,CACN,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,MACN,YAAa,CAAC,0BACd,MAAO,CACH,CACI,OAAQ,CAAC,oCACT,OAAQ,mBAGhB,UACA,YAAa;;MAKjB,SAAS,EAAiB,EAAO,CAC7B,IAAM,EAAU,GAChB,IAAK,IAAM,KAAO,EACd,EAAQ,EAAI,IAAM,EAAQ,EAAI,IAAM,OAAO,OAAO,EAAQ,EAAI,IAAK,GAAO,EAE9E,OAAO,OAAO,OAAO,GAGzB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,aAAe,GACxC,EAAU,CACZ,OAAQ,MACR,WAAY,aACZ,aAAc,kBAElB,EAAM,OAAO,GACb,EAAM,OAAO,GACb,EAAM,OAAO,GACb,EAAI,SAAS,QAAQ,MAAQ,EAE7B,IAAM,EAAM,sDAAsD,IAC5D,EAAW,MAAM,EAAI,IAAI,EAAK,CAAE,YAChC,EAAQ,EAAS,KAAK,SAAS,WAAW,SAAS,mBAAqB,EAAS,KAAK,SAAS,WAAa,yBAAyB,EAAS,KAAK,SAAS,aAC5J,EAAO,6BAA+B,EAAS,KAAK,SAAS,UAC7D,EAAQ,EAAS,KAAK,QAAQ,GAAG,MAAM,OAAQ,GAAS,EAAK,OAC7D,EAAO,EAAM,QAAS,GACxB,EAAK,MAAM,GAAG,MACT,OAAQ,GAAS,EAAK,eAAiB,IACvC,IAAK,GAAS,CACX,IAAM,EAAS,CACX,GAAI,EAAK,GACT,MAAO,EAAK,SAAS,KACrB,KAAM,EAAK,KAAK,IAChB,QAAS,EAAK,KAAK,aACnB,QAAS,EAAK,KAAK,eAKvB,OAHI,EAAK,QAAQ,MAAM,IAAI,OACvB,EAAO,YAAc,EAAK,QAAQ,MAAM,IAAI,MAEzC,KAGb,EAAO,EAAiB,GACxB,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAI,EACJ,GAAI,CACA,EAAW,MAAM,EAAI,6GAA6G,EAAK,OAAQ,CAAE,kBAC5I,EAAO,CACZ,GAAI,aAAiB,GAAc,EAAM,aAAe,IAEpD,OAAO,EAEP,MAAM,EAYd,MATA,GAAK,MAAQ,EAAS,KAAK,OAAS,EAAK,MACzC,EAAK,OACD,EAAS,KAAK,MACT,OAAQ,GAAU,EAAM,OAAS,WAChC,QAAS,GAAU,EAAM,QAAQ,IAAK,GAAW,EAAO,QACxD,KAAK,OAAS,GACxB,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACtE,QAAS,EAAS,KAAK,QAEpB,MAKnB,MAAO,CACH,QACA,OACA,KAAM"}