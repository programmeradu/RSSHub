{"version":3,"file":"cx-4qc9Umio.js","names":[],"sources":["../../lib/routes/tesla/cx.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/cx/:category?/:city?',\r\n    categories: ['shopping'],\r\n    example: '/tesla/cx/生活方式/北京',\r\n    parameters: { category: '分类，见下表，默认为空，即全部', city: '城市，默认为空，即全国' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '权益中心',\r\n    maintainers: ['simonsmh', 'nczitzk'],\r\n    handler,\r\n    description: `| 充电免停 | 酒店 | 美食 | 生活方式 |\r\n| -------- | ---- | ---- | -------- |\r\n\r\n::: tip\r\n  分类为 **充电免停** 时，城市参数不起作用\r\n:::\r\n\r\n<details>\r\n<summary>可选城市</summary>\r\n\r\n| 成都 | 深圳 | 洛阳 | 北京 | 南京 | 绍兴 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 西安 | 上海 | 阿坝藏族羌族自治州 | 重庆 | 郑州 | 天津 |\r\n| ---- | ---- | ------------------ | ---- | ---- | ---- |\r\n\r\n| 晋中 | 三亚 | 湖州 | 苏州 | 扬州 | 秦皇岛 |\r\n| ---- | ---- | ---- | ---- | ---- | ------ |\r\n\r\n| 长沙 | 武汉 | 安阳 | 温州 | 瑞安 | 石家庄 |\r\n| ---- | ---- | ---- | ---- | ---- | ------ |\r\n\r\n| 佛山 | 广州 | 杭州 | 烟台 | 沧州 | 张家港 |\r\n| ---- | ---- | ---- | ---- | ---- | ------ |\r\n\r\n| 金华 | 临沧 | 大理 | 南昌 | 贵阳 | 信阳 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 张家口 | 铜仁 | 沈阳 | 合肥 | 黔东 | 高邮 |\r\n| ------ | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 三河 | 安顺 | 莆田 | 阳江 | 南宁 | 台州 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 余姚 | 淄博 | 三明 | 中山 | 宁波 | 厦门 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 永康 | 慈溪 | 台山 | 福州 | 无锡 | 宜昌 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 泉州 | 肇庆 | 太仓 | 珠海 | 邢台 | 衡水 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 温岭 | 宜兴 | 东莞 | 威海 | 南通 | 舟山 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 都匀 | 长治 | 江阴 | 云浮 | 常州 | 唐山 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 平湖 | 商丘 | 保定 | 泰州 | 青岛 | 龙口 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 泰安 | 岳阳 | 惠州 | 徐州 | 哈尔滨 | 潍坊 |\r\n| ---- | ---- | ---- | ---- | ------ | ---- |\r\n\r\n| 大同 | 嘉兴 | 毕节 | 临汾 | 江门 | 诸暨 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 儋州 | 衢州 | 大连 | 昆山 | 靖江 | 常熟 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 罗定 | 丽江 | 晋江 | 乐清 | 茂名 | 福清 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 廊坊 | 兰溪 | 汕尾 | 滨州 | 昆明 | 玉环 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 绵阳 | 漳州 | 德州 | 聊城 | 龙岩 | 临沂 |\r\n| ---- | ---- | ---- | ---- | ---- | ---- |\r\n\r\n| 新沂 | 桐乡 | 迪庆藏族自治州 | 汕头 | 潮州 | 驻马店 |\r\n| ---- | ---- | -------------- | ---- | ---- | ------ |\r\n\r\n| 曲阜 | 郴州 | 济源 | 兴义 |\r\n| ---- | ---- | ---- | ---- |\r\n</details>`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category, city } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 10;\r\n\r\n    const rootUrl = 'https://cx.tesla.cn';\r\n    const rootApiUrl = 'https://community-api.tesla.cn';\r\n    const rootMediaApi = 'https://china-community-app.tesla.cn';\r\n\r\n    const currentUrl = new URL(`user-right/list${category ? `/${category}` : ''}`, rootUrl).href;\r\n    const apiUrl = new URL('api/voucherpackage/merchant', rootApiUrl).href;\r\n    const apiCategoryUrl = new URL('api/category', rootApiUrl).href;\r\n\r\n    const categoryToUrl = (category) => new URL(`user-right/list/${category}`, rootUrl).href;\r\n    const mediaToUrl = (media) => new URL(`community-media/${media}`, rootMediaApi).href;\r\n\r\n    art.defaults.imports.categoryToUrl = categoryToUrl;\r\n    art.defaults.imports.mediaToUrl = mediaToUrl;\r\n\r\n    const { data: categoryResponse } = await got(apiCategoryUrl, {\r\n        searchParams: {\r\n            type: 2,\r\n        },\r\n    });\r\n\r\n    const categoryObject = categoryResponse.data.findLast((c) => c.name === category);\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: {\r\n            pageSize: limit,\r\n            pageNumber: 0,\r\n            benefitCategoryId: categoryObject?.id ?? undefined,\r\n            category: categoryObject ? undefined : category === '充电免停' ? 2 : undefined,\r\n            city,\r\n        },\r\n    });\r\n\r\n    let items = response.data.pageDatas.slice(0, limit).map((item) => ({\r\n        title: item.venueName ?? item.title,\r\n        link: new URL(`user-right/detail/${item.id}`, rootUrl).href,\r\n        description: art(path.join(__dirname, 'templates/description.art'), {\r\n            image: item.coverImage\r\n                ? {\r\n                      src: item.coverImage,\r\n                      alt: item.venueName ?? item.title,\r\n                  }\r\n                : undefined,\r\n            description: item.description?.replace(/\\[\"|\"]/g, '') ?? undefined,\r\n            data: item.parkingLocationId\r\n                ? {\r\n                      title: item.venueName ?? item.title,\r\n                      categories: [category],\r\n                      description: `充电停车减免${item.parkingVoucherValue}小时`,\r\n                  }\r\n                : undefined,\r\n        }),\r\n        category: item.categories,\r\n        guid: item.id,\r\n        pubDate: parseDate(item.publishedAt),\r\n        parkingLocationId: item.parkingLocationId,\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                if (item.parkingLocationId) {\r\n                    item.guid = `tesla-user-right#${item.guid}`;\r\n\r\n                    delete item.parkingLocationId;\r\n\r\n                    return item;\r\n                }\r\n\r\n                const apiItemUrl = new URL(`api/voucherpackage/merchant/${item.guid}`, rootApiUrl).href;\r\n\r\n                const { data: detailResponse } = await got(apiItemUrl);\r\n\r\n                const data = detailResponse.data;\r\n\r\n                item.title = data.title ?? item.title;\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    data,\r\n                });\r\n                item.author = data.merchants ? data.merchants.map((a) => a.name).join('/') : undefined;\r\n                item.category = [...new Set([...item.category, ...data.categories])].filter(Boolean);\r\n                item.guid = `tesla-user-right#${item.guid}`;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const author = $('title').text();\r\n    const description = `${city ?? ''}${category ?? ''}`;\r\n    const icon = new URL($('link[rel=\"icon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: `${author}权益中心${description ? ` - ${description}` : ''}`,\r\n        link: currentUrl,\r\n        description,\r\n        language: $('html').prop('lang'),\r\n        image: $('meta[property=\"og:image\"]').prop('content'),\r\n        icon,\r\n        logo: icon,\r\n        subtitle: description,\r\n        author,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"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"}