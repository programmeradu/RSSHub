{"version":3,"file":"timeline-BVWmQ9oz.js","names":[],"sources":["../../lib/routes/jinse/timeline.ts"],"sourcesContent":["import { Route, ViewType } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/timeline/:category?',\r\n    categories: ['finance'],\r\n    view: ViewType.Articles,\r\n    example: '/jinse/timeline',\r\n    parameters: {\r\n        category: {\r\n            description: '分类',\r\n            options: [\r\n                { value: '头条', label: '头条' },\r\n                { value: '独家', label: '独家' },\r\n                { value: '铭文', label: '铭文' },\r\n                { value: '产业', label: '产业' },\r\n                { value: '项目', label: '项目' },\r\n                { value: '政策', label: '政策' },\r\n                { value: 'AI', label: 'AI' },\r\n                { value: 'Web 3.0', label: 'Web 3.0' },\r\n                { value: '以太坊 2.0', label: '以太坊 2.0' },\r\n                { value: 'DeFi', label: 'DeFi' },\r\n                { value: 'Layer2', label: 'Layer2' },\r\n                { value: 'NFT', label: 'NFT' },\r\n                { value: 'DAO', label: 'DAO' },\r\n                { value: '百科', label: '百科' },\r\n            ],\r\n            default: '头条',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '首页',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| 头条   | 独家 | 铭文    | 产业       | 项目 |\r\n| ------ | ---- | ------- | ---------- | ---- |\r\n| 政策   | AI   | Web 3.0 | 以太坊 2.0 | DeFi |\r\n| Layer2 | NFT  | DAO     | 百科       |      |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = '头条' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 50;\r\n\r\n    const rootUrl = 'https://www.jinse.cn';\r\n    const rootApiUrl = 'https://api.jinse.cn';\r\n    const apiUrl = new URL('noah/v3/timelines', rootApiUrl).href;\r\n    const currentUrl = rootUrl;\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: {\r\n            catelogue_key: category === '头条' ? 'www' : category,\r\n            limit,\r\n            information_id: 0,\r\n            flag: 'up',\r\n        },\r\n    });\r\n\r\n    let items = response.data.list.slice(0, limit).map((item) => {\r\n        item = item.object_1 ?? item.object_2;\r\n\r\n        return {\r\n            title: item.title,\r\n            link: item.jump_url,\r\n            description: art(path.join(__dirname, 'templates/description.art'), {\r\n                images: item.cover\r\n                    ? [\r\n                          {\r\n                              src: item.cover.replace(/_[^\\W_]+(\\.\\w+)$/, '_true$1'),\r\n                              alt: item.title,\r\n                          },\r\n                      ]\r\n                    : undefined,\r\n                intro: item.summary,\r\n                description: item.content,\r\n            }),\r\n            author: item.author.nickname,\r\n            guid: `jinse${/\\/lives\\//.test(item.jump_url) ? '-lives' : ''}-${item.id}`,\r\n            pubDate: parseDate(item.published_at, 'X'),\r\n            upvotes: item.up_counts ?? 0,\r\n            downvotes: item.down_counts ?? 0,\r\n            comments: item.comment_count ?? 0,\r\n        };\r\n    });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                if (/\\/lives\\//.test(item.link)) {\r\n                    return item;\r\n                }\r\n\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                item.description += art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: content('section.js-article-content').html() || content('div.js-article').html(),\r\n                });\r\n                item.category = content('section.js-article-tag_state_1 a span')\r\n                    .toArray()\r\n                    .map((c) => content(c).text());\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const author = $('meta[name=\"author\"]').prop('content');\r\n    const image = $('a.js-logoBox img').prop('src');\r\n    const icon = new URL($('link[rel=\"favicon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: `${author} - ${category}`,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"keywords\"]').prop('content'),\r\n        author,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"ugBASA,MAAa,EAAe,CACxB,KAAM,uBACN,WAAY,CAAC,WACb,KAAM,EAAS,SACf,QAAS,kBACT,WAAY,CACR,SAAU,CACN,YAAa,KACb,QAAS,CACL,CAAE,MAAO,KAAM,MAAO,MACtB,CAAE,MAAO,KAAM,MAAO,MACtB,CAAE,MAAO,KAAM,MAAO,MACtB,CAAE,MAAO,KAAM,MAAO,MACtB,CAAE,MAAO,KAAM,MAAO,MACtB,CAAE,MAAO,KAAM,MAAO,MACtB,CAAE,MAAO,KAAM,MAAO,MACtB,CAAE,MAAO,UAAW,MAAO,WAC3B,CAAE,MAAO,UAAW,MAAO,WAC3B,CAAE,MAAO,OAAQ,MAAO,QACxB,CAAE,MAAO,SAAU,MAAO,UAC1B,CAAE,MAAO,MAAO,MAAO,OACvB,CAAE,MAAO,MAAO,MAAO,OACvB,CAAE,MAAO,KAAM,MAAO,OAE1B,QAAS,OAGjB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,WACd,UACA,YAAa;;;gDAMjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,MAAS,EAAI,IAAI,QAC9B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,uBAEV,EAAS,IAAI,IAAI,oBAAqB,wBAAY,KAClD,EAAa,EAEb,CAAE,KAAM,GAAa,MAAM,EAAI,EAAQ,CACzC,aAAc,CACV,cAAe,IAAa,KAAO,MAAQ,EAC3C,QACA,eAAgB,EAChB,KAAM,QAIV,EAAQ,EAAS,KAAK,KAAK,MAAM,EAAG,GAAO,IAAK,IAChD,EAAO,EAAK,UAAY,EAAK,SAEtB,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,SACX,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,OAAQ,EAAK,MACP,CACI,CACI,IAAK,EAAK,MAAM,QAAQ,mBAAoB,WAC5C,IAAK,EAAK,QAGlB,IAAA,GACN,MAAO,EAAK,QACZ,YAAa,EAAK,UAEtB,OAAQ,EAAK,OAAO,SACpB,KAAM,QAAQ,YAAY,KAAK,EAAK,UAAY,SAAW,GAAG,GAAG,EAAK,KACtE,QAAS,EAAU,EAAK,aAAc,KACtC,QAAS,EAAK,WAAa,EAC3B,UAAW,EAAK,aAAe,EAC/B,SAAU,EAAK,eAAiB,KAIxC,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,YAAY,KAAK,EAAK,MACtB,OAAO,EAGX,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GASrB,MAPA,GAAK,aAAe,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACvE,YAAa,EAAQ,8BAA8B,QAAU,EAAQ,kBAAkB,SAE3F,EAAK,SAAW,EAAQ,yCACnB,UACA,IAAK,GAAM,EAAQ,GAAG,QAEpB,MAKnB,GAAM,CAAE,KAAM,GAAoB,MAAM,EAAI,GAEtC,EAAI,EAAK,GAET,EAAS,EAAE,uBAAuB,KAAK,WACvC,EAAQ,EAAE,oBAAoB,KAAK,OACnC,EAAO,IAAI,IAAI,EAAE,uBAAuB,KAAK,QAAS,GAAS,KAErE,MAAO,CACH,KAAM,EACN,MAAO,GAAG,EAAO,KAAK,IACtB,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,EAAE,QAAQ,KAAK,QACzB,QACA,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,SACA,WAAY"}