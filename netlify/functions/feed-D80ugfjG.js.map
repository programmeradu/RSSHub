{"version":3,"file":"feed-D80ugfjG.js","names":["route: Route","constants","getToken","cache","got"],"sources":["../../lib/routes/mangadex/user/feed.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport getToken from '../_access';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\nimport constants from '../_constants';\r\nimport { getMangaMetaByIds } from '../_feed';\r\nimport { getFilteredLanguages } from '../_profile';\r\nimport { toQueryString } from '../_utils';\r\n\r\nconst DEFAULT_LIMIT = 25;\r\n\r\nexport const route: Route = {\r\n    path: '/user/feed/follow/:lang?',\r\n    name: ' Follows Feed',\r\n    maintainers: ['chrisis58'],\r\n    description: 'Get the latest updates of all the manga you follow on MangaDex.',\r\n    example: '/mangadex/user/feed/follow/zh?limit=10',\r\n    radar: [\r\n        {\r\n            source: ['mangadex.org/titles/feed'],\r\n            target: '/user/feed/follow',\r\n        },\r\n    ],\r\n    categories: ['anime'],\r\n    parameters: {\r\n        lang: {\r\n            description: 'The language of the followed manga',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'MANGADEX_USERNAME',\r\n                description: 'MangaDex Username, required when refresh-token is not set',\r\n                optional: true,\r\n            },\r\n            {\r\n                name: 'MANGADEX_PASSWORD',\r\n                description: 'MangaDex Password, required when refresh-token is not set',\r\n                optional: true,\r\n            },\r\n            {\r\n                name: 'MANGADEX_CLIENT_ID',\r\n                description: 'MangaDex Client ID',\r\n                optional: false,\r\n            },\r\n            {\r\n                name: 'MANGADEX_CLIENT_SECRET',\r\n                description: 'MangaDex Client Secret',\r\n                optional: false,\r\n            },\r\n            {\r\n                name: 'MANGADEX_REFRESH_TOKEN',\r\n                description: 'MangaDex Refresh Token, required when username and password are not set',\r\n                optional: true,\r\n            },\r\n        ],\r\n    },\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const userFollowUrl = `${constants.API.BASE}/user/follows/manga/feed`;\r\n\r\n    const { lang } = ctx.req.param();\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : DEFAULT_LIMIT;\r\n\r\n    const accessToken = await getToken();\r\n\r\n    const languagesQuery = new Set([...(typeof lang === 'string' ? [lang] : lang || []), ...(await getFilteredLanguages())].filter(Boolean));\r\n\r\n    const feed = (await cache.tryGet(\r\n        'mangadex:user-follows',\r\n        async () => {\r\n            const response = await got.get(\r\n                `${userFollowUrl}${toQueryString({\r\n                    translatedLanguage: languagesQuery,\r\n                    order: {\r\n                        publishAt: 'desc',\r\n                    },\r\n                    limit,\r\n                })}`,\r\n                {\r\n                    headers: {\r\n                        Authorization: `Bearer ${accessToken}`,\r\n                        'User-Agent': config.trueUA,\r\n                    },\r\n                }\r\n            );\r\n\r\n            const followedChapterFeed = response?.data?.data;\r\n            if (!followedChapterFeed) {\r\n                throw new Error('Failed to retrieve user follows from MangaDex API.');\r\n            }\r\n\r\n            return followedChapterFeed;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    )) as Record<string, any>[];\r\n\r\n    const mangaIds = feed.map((chapter) => chapter?.relationships.find((relationship) => relationship.type === 'manga')?.id);\r\n\r\n    const mangaMetas = await getMangaMetaByIds(mangaIds);\r\n\r\n    return {\r\n        title: 'User Follows',\r\n        link: 'https://mangadex.org/titles/feed',\r\n        description: 'The latest updates of all the manga you follow on MangaDex.',\r\n        item: feed.map((chapter) => {\r\n            const mangaId = chapter.relationships.find((relationship) => relationship.type === 'manga')?.id;\r\n            const mangaMeta = mangaMetas.get(mangaId);\r\n            const chapterTitile = [chapter.attributes.volume ? `Vol. ${chapter.attributes.volume}` : null, chapter.attributes.chapter ? `Ch. ${chapter.attributes.chapter}` : null, chapter.attributes.title].filter(Boolean).join(' ');\r\n\r\n            return {\r\n                title: mangaMeta?.title || 'Unknown',\r\n                link: `${constants.API.MANGA_CHAPTERS}${chapter.id}`,\r\n                pubDate: new Date(chapter.attributes.publishAt),\r\n                description: chapterTitile,\r\n                image: mangaMeta?.cover,\r\n            };\r\n        }),\r\n    };\r\n}\r\n"],"mappings":"wfAUA,MAEaA,EAAe,CACxB,KAAM,2BACN,KAAM,gBACN,YAAa,CAAC,aACd,YAAa,kEACb,QAAS,yCACT,MAAO,CACH,CACI,OAAQ,CAAC,4BACT,OAAQ,sBAGhB,WAAY,CAAC,SACb,WAAY,CACR,KAAM,CACF,YAAa,uCAGrB,SAAU,CACN,cAAe,CACX,CACI,KAAM,oBACN,YAAa,4DACb,SAAU,IAEd,CACI,KAAM,oBACN,YAAa,4DACb,SAAU,IAEd,CACI,KAAM,qBACN,YAAa,qBACb,SAAU,IAEd,CACI,KAAM,yBACN,YAAa,yBACb,SAAU,IAEd,CACI,KAAM,yBACN,YAAa,0EACb,SAAU,MAItB,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAgB,GAAGC,EAAU,IAAI,KAAK,0BAEtC,CAAE,QAAS,EAAI,IAAI,QAEnB,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,GAE3E,EAAc,MAAMC,IAEpB,EAAiB,IAAI,IAAI,CAAC,GAAI,OAAO,GAAS,SAAW,CAAC,GAAQ,GAAQ,GAAK,GAAI,MAAM,KAAyB,OAAO,UAEzH,EAAQ,MAAMC,EAAM,OACtB,wBACA,SAAY,CACR,IAAM,EAAW,MAAMC,EAAI,IACvB,GAAG,IAAgB,EAAc,CAC7B,mBAAoB,EACpB,MAAO,CACH,UAAW,QAEf,YAEJ,CACI,QAAS,CACL,cAAe,UAAU,IACzB,aAAc,EAAO,UAK3B,EAAsB,GAAU,MAAM,KAC5C,GAAI,CAAC,EACD,MAAU,MAAM,sDAGpB,OAAO,GAEX,EAAO,MAAM,YACb,IAGE,EAAW,EAAK,IAAK,GAAY,GAAS,cAAc,KAAM,GAAiB,EAAa,OAAS,UAAU,IAE/G,EAAa,MAAM,EAAkB,GAE3C,MAAO,CACH,MAAO,eACP,KAAM,mCACN,YAAa,8DACb,KAAM,EAAK,IAAK,GAAY,CACxB,IAAM,EAAU,EAAQ,cAAc,KAAM,GAAiB,EAAa,OAAS,UAAU,GACvF,EAAY,EAAW,IAAI,GAC3B,EAAgB,CAAC,EAAQ,WAAW,OAAS,QAAQ,EAAQ,WAAW,SAAW,KAAM,EAAQ,WAAW,QAAU,OAAO,EAAQ,WAAW,UAAY,KAAM,EAAQ,WAAW,OAAO,OAAO,SAAS,KAAK,KAEvN,MAAO,CACH,MAAO,GAAW,OAAS,UAC3B,KAAM,GAAGH,EAAU,IAAI,iBAAiB,EAAQ,KAChD,QAAS,IAAI,KAAK,EAAQ,WAAW,WACrC,YAAa,EACb,MAAO,GAAW"}