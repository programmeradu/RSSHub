{"version":3,"file":"discount-CxLwMHJp.js","names":[],"sources":["../../lib/routes/jump/discount.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst discountUrl = 'https://switch.jumpvg.com/jump/discount/find4Discount/5/v2';\r\n// const detailUrl = 'https://switch.jumpvg.com/jump/game/detail';\r\n\r\n// 平台对应参数\r\nconst platformObject = {\r\n    switch: 1,\r\n    steam: 4,\r\n    ps4: 51,\r\n    ps5: 52,\r\n};\r\n\r\n// 各个平台分类参数\r\nconst filterObject = {\r\n    switch: {\r\n        jx: 16,\r\n        all: 17,\r\n        sd: 18,\r\n    },\r\n    steam: {\r\n        jx: 26,\r\n        all: 27,\r\n        dl: 28,\r\n        sd: 29,\r\n    },\r\n    ps4: {\r\n        jx: 19,\r\n        all: 20,\r\n        sd: 21,\r\n        vip: 22,\r\n    },\r\n    ps5: {\r\n        all: 23,\r\n        sd: 24,\r\n        vip: 25,\r\n    },\r\n};\r\n\r\n// 分类对应名\r\nconst filterName = {\r\n    jx: '精选',\r\n    sd: '史低',\r\n    all: '全部',\r\n    vip: '会员',\r\n    dl: '独立',\r\n};\r\n\r\nconst getDiscountNum = async (platform) => {\r\n    const response = await got.get(`https://switch.jumpvg.com/jump/platform/order/v2?needCount=1&needFilter=1&version=3`);\r\n    const data = response.data.data;\r\n    let totalNum = 0;\r\n    for (const index in data) {\r\n        if (data[index].platformAlias.toLocaleLowerCase() === platform.toLocaleLowerCase()) {\r\n            totalNum = data[index].gameNum;\r\n            break;\r\n        }\r\n    }\r\n    return totalNum;\r\n};\r\n\r\nconst getSinglePageDiscountItem = async (countries, offset, platform, termsId) => {\r\n    const response = await got.get(`${discountUrl}?countries=${countries}&offset=${offset}&platform=${platform}&size=10&termsId=${termsId}&version=3`);\r\n    return response.data.data;\r\n};\r\n\r\n// 防止触发反爬\r\nconst getAllPageDiscountItem = async (countries, platform, termsId, totalNum) => {\r\n    let allDiscountItem = [];\r\n    for (let idx = 0; idx <= Math.round(totalNum / 10); idx++) {\r\n        // eslint-disable-next-line no-await-in-loop\r\n        const itemList = await getSinglePageDiscountItem(countries, idx * 10, platform, termsId);\r\n        allDiscountItem = [...allDiscountItem, ...itemList];\r\n    }\r\n    return allDiscountItem;\r\n};\r\n\r\n// const getGameDetail = (item, caches) => caches.tryGet(`${item.platform}-${item.oldGameId}`, async () => {\r\n//     const response = await got.get(`${detailUrl}?clickFrom=-1&id=${item.oldGameId}&platform=${item.platform}&version=3`);\r\n//     return response.data.data;\r\n// });\r\n\r\n//  依次获取详情\r\n// const seqGetGameDetail = async (allDiscountItem, ctx) => {\r\n//     for (const idx in allDiscountItem) {\r\n//         logger.info(idx);\r\n//         // eslint-disable-next-line no-await-in-loop\r\n//         const detail = await getGameDetail(allDiscountItem[idx], cache);\r\n//         allDiscountItem[idx].detail = detail;\r\n//         logger.info(detail);\r\n//         };\r\n// };\r\n\r\nexport const route: Route = {\r\n    path: '/discount/:platform/:filter?/:countries?',\r\n    categories: ['game'],\r\n    example: '/jump/discount/ps5/all',\r\n    parameters: { platform: '平台:switch,ps4,ps5,xbox,steam,epic', filter: '过滤参数,all-全部，jx-精选，sd-史低，dl-独立，vip-会员', countries: '地区，具体支持较多，可自信查看地区简写' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '游戏折扣',\r\n    maintainers: ['zytomorrow'],\r\n    handler,\r\n    description: `| switch | ps4  | ps5  | xbox   | steam | epic   |\r\n| ------ | ---- | ---- | ------ | ----- | ------ |\r\n| 可用   | 可用 | 可用 | 不可用 | 可用  | 不可用 |\r\n\r\n| filter | switch | ps4 | ps5 | steam |\r\n| ------ | ------ | --- | --- | ----- |\r\n| all    | ✔     | ✔  | ✔  | ✔    |\r\n| jx     | ✔     | ✔  | ❌  | ✔    |\r\n| sd     | ✔     | ✔  | ✔  | ✔    |\r\n| dl     | ❌     | ✔  | ❌  | ✔    |\r\n| vip    | ❌     | ❌  | ✔  | ❌    |\r\n\r\n| 北美 | 欧洲（英语） | 法国 | 德国 | 日本 |\r\n| ---- | ------------ | ---- | ---- | ---- |\r\n| na   | eu           | fr   | de   | jp   |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const platform = ctx.req.param('platform');\r\n    const filter = ctx.req.param('filter') || 'all';\r\n    const countries = ctx.req.param('countries') || '';\r\n\r\n    const discountNum = await getDiscountNum(platform);\r\n    const allDiscountItem = await getAllPageDiscountItem(countries, platformObject[platform.toLocaleLowerCase()], filterObject[platform.toLocaleLowerCase()][filter], discountNum);\r\n\r\n    // 并发极易触发反爬，此处可选是否获取detail,detail也只能顺序获取--反爬严格，放弃\r\n    // if (needDeatail) {\r\n    //     await seqGetGameDetail(allDiscountItem, ctx);\r\n    // }\r\n\r\n    return {\r\n        title: `jump 折扣-${platform}-${filterName[filter]}${countries ? `-${countries}` : ''}`,\r\n        link: 'https://jumpvg.com/',\r\n        description: 'jump 发现游戏',\r\n        item: allDiscountItem.map((item) => ({\r\n            title: `${item.name}-${item.cutOff}%-￥${item.price}`,\r\n            description: art(path.resolve(__dirname, './templates/discount.art'), { item }),\r\n            link: item.banner,\r\n            guid: `${platform}-${item.oldGameId}-${item.cutOff}`, // 平台-打折id-打折率\r\n        })),\r\n    };\r\n}\r\n"],"mappings":"gVAMA,MAIM,EAAiB,CACnB,OAAQ,EACR,MAAO,EACP,IAAK,GACL,IAAK,IAIH,EAAe,CACjB,OAAQ,CACJ,GAAI,GACJ,IAAK,GACL,GAAI,IAER,MAAO,CACH,GAAI,GACJ,IAAK,GACL,GAAI,GACJ,GAAI,IAER,IAAK,CACD,GAAI,GACJ,IAAK,GACL,GAAI,GACJ,IAAK,IAET,IAAK,CACD,IAAK,GACL,GAAI,GACJ,IAAK,KAKP,EAAa,CACf,GAAI,KACJ,GAAI,KACJ,IAAK,KACL,IAAK,KACL,GAAI,MAGF,EAAiB,KAAO,IAAa,CACvC,IAAM,EAAW,MAAM,EAAI,IAAI,uFACzB,EAAO,EAAS,KAAK,KACvB,EAAW,EACf,IAAK,IAAM,KAAS,EAChB,GAAI,EAAK,GAAO,cAAc,sBAAwB,EAAS,oBAAqB,CAChF,EAAW,EAAK,GAAO,QACvB,MAGR,OAAO,GAGL,EAA4B,MAAO,EAAW,EAAQ,EAAU,IAAY,CAC9E,IAAM,EAAW,MAAM,EAAI,IAAI,wEAA4B,EAAU,UAAU,EAAO,YAAY,EAAS,mBAAmB,EAAQ,aACtI,OAAO,EAAS,KAAK,MAInB,EAAyB,MAAO,EAAW,EAAU,EAAS,IAAa,CAC7E,IAAI,EAAkB,GACtB,IAAK,IAAI,EAAM,EAAG,GAAO,KAAK,MAAM,EAAW,IAAK,IAAO,CAEvD,IAAM,EAAW,MAAM,EAA0B,EAAW,EAAM,GAAI,EAAU,GAChF,EAAkB,CAAC,GAAG,EAAiB,GAAG,GAE9C,OAAO,GAmBE,EAAe,CACxB,KAAM,2CACN,WAAY,CAAC,QACb,QAAS,yBACT,WAAY,CAAE,SAAU,oCAAqC,OAAQ,uCAAwC,UAAW,uBACxH,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,cACd,UACA,YAAa;;;;;;;;;;;;;;+CAiBjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,YACzB,EAAS,EAAI,IAAI,MAAM,WAAa,MACpC,EAAY,EAAI,IAAI,MAAM,cAAgB,GAE1C,EAAc,MAAM,EAAe,GACnC,EAAkB,MAAM,EAAuB,EAAW,EAAe,EAAS,qBAAsB,EAAa,EAAS,qBAAqB,GAAS,GAOlK,MAAO,CACH,MAAO,WAAW,EAAS,GAAG,EAAW,KAAU,EAAY,IAAI,IAAc,KACjF,KAAM,sBACN,YAAa,YACb,KAAM,EAAgB,IAAK,IAAU,CACjC,MAAO,GAAG,EAAK,KAAK,GAAG,EAAK,OAAO,KAAK,EAAK,QAC7C,YAAa,EAAI,EAAA,QAAA,EAAA,mCAAqD,CAAE,SACxE,KAAM,EAAK,OACX,KAAM,GAAG,EAAS,GAAG,EAAK,UAAU,GAAG,EAAK"}