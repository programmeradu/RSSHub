{"version":3,"file":"rank-DXGFrBRM.js","names":["route: Route","InvalidParameterError","got","cache","category"],"sources":["../../lib/routes/163/news/rank.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport iconv from 'iconv-lite';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nconst rootUrl = 'https://news.163.com';\r\n\r\nconst config = {\r\n    whole: {\r\n        link: '/special/0001386F/rank_whole.html',\r\n        title: '全站',\r\n    },\r\n    news: {\r\n        link: '/special/0001386F/rank_news.html',\r\n        title: '新闻',\r\n    },\r\n    entertainment: {\r\n        link: '/special/0001386F/rank_ent.html',\r\n        title: '娱乐',\r\n    },\r\n    sports: {\r\n        link: '/special/0001386F/rank_sports.html',\r\n        title: '体育',\r\n    },\r\n    money: {\r\n        link: 'https://money.163.com/special/002526BH/rank.html',\r\n        title: '财经',\r\n    },\r\n    tech: {\r\n        link: '/special/0001386F/rank_tech.html',\r\n        title: '科技',\r\n    },\r\n    auto: {\r\n        link: '/special/0001386F/rank_auto.html',\r\n        title: '汽车',\r\n    },\r\n    lady: {\r\n        link: '/special/0001386F/rank_lady.html',\r\n        title: '女人',\r\n    },\r\n    house: {\r\n        link: '/special/0001386F/rank_house.html',\r\n        title: '房产',\r\n    },\r\n    game: {\r\n        link: '/special/0001386F/game_rank.html',\r\n        title: '游戏',\r\n    },\r\n    travel: {\r\n        link: '/special/0001386F/rank_travel.html',\r\n        title: '旅游',\r\n    },\r\n    edu: {\r\n        link: '/special/0001386F/rank_edu.html',\r\n        title: '教育',\r\n    },\r\n};\r\n\r\nconst timeRange = {\r\n    hour: {\r\n        index: 0,\r\n        title: '1小时',\r\n    },\r\n    day: {\r\n        index: 1,\r\n        title: '24小时',\r\n    },\r\n    week: {\r\n        index: 2,\r\n        title: '本周',\r\n    },\r\n    month: {\r\n        index: 3,\r\n        title: '本月',\r\n    },\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/news/rank/:category?/:type?/:time?',\r\n    categories: ['new-media'],\r\n    example: '/163/news/rank/whole/click/day',\r\n    parameters: {\r\n        category: '新闻分类，参见下表，默认为“全站”',\r\n        type: '排行榜类型，“点击榜”对应`click`，“跟贴榜”对应`follow`，默认为“点击榜”',\r\n        time: '统计时间，“1小时”对应`hour`，“24小时”对应`day`，“本周”对应`week`，“本月”对应`month`，默认为“24小时”',\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '排行榜',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `::: tip\r\n  全站新闻 **点击榜** 的统计时间仅包含 “24 小时”、“本周”、“本月”，不包含 “1 小时”。即可用的\\`time\\`参数为\\`day\\`、\\`week\\`、\\`month\\`。\r\n\r\n  其他分类 **点击榜** 的统计时间仅包含 “1 小时”、“24 小时”、“本周”。即可用的\\`time\\`参数为\\`hour\\`、\\`day\\`、\\`week\\`。\r\n\r\n  而所有分类（包括全站）的 **跟贴榜** 的统计时间皆仅包含 “24 小时”、“本周”、“本月”。即可用的\\`time\\`参数为\\`day\\`、\\`week\\`、\\`month\\`。\r\n:::\r\n\r\n  新闻分类：\r\n\r\n| 全站  | 新闻 | 娱乐          | 体育   | 财经  | 科技 | 汽车 | 女人 | 房产  | 游戏 | 旅游   | 教育 |\r\n| ----- | ---- | ------------- | ------ | ----- | ---- | ---- | ---- | ----- | ---- | ------ | ---- |\r\n| whole | news | entertainment | sports | money | tech | auto | lady | house | game | travel | edu  |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category') || 'whole';\r\n    const type = ctx.req.param('type') || 'click';\r\n    const time = ctx.req.param('time') || 'day';\r\n\r\n    const cfg = config[category];\r\n    if (!cfg) {\r\n        throw new InvalidParameterError('Bad category. See <a href=\"https://docs.rsshub.app/routes/new-media#wang-yi-xin-wen-pai-hang-bang\">docs</a>');\r\n    } else if ((category !== 'whole' && type === 'click' && time === 'month') || (category === 'whole' && type === 'click' && time === 'hour') || (type === 'follow' && time === 'hour')) {\r\n        throw new InvalidParameterError('Bad timeRange range. See <a href=\"https://docs.rsshub.app/routes/new-media#wang-yi-xin-wen-pai-hang-bang\">docs</a>');\r\n    }\r\n\r\n    const currentUrl = category === 'money' ? cfg.link : `${rootUrl}${cfg.link}`;\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n        responseType: 'buffer',\r\n    });\r\n\r\n    const $ = load(iconv.decode(response.data, 'gbk'));\r\n\r\n    const list = $('div.tabContents')\r\n        .eq(timeRange[time].index + (category === 'whole' ? (type === 'click' ? -1 : 2) : type === 'click' ? 0 : 2))\r\n        .find('table tbody tr td a')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                link: item.attr('href'),\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                try {\r\n                    let link;\r\n                    if (category === 'auto' || category === 'house' || category === 'travel') {\r\n                        const category = item.link.split('.163.com')[0].split('//').pop().split('.').pop();\r\n                        link = `https://3g.163.com/${category}/article/${item.link.split('/').pop()}`;\r\n                    } else {\r\n                        const pathname = new URL(item.link).pathname;\r\n                        link = `https://3g.163.com${pathname}`;\r\n                    }\r\n\r\n                    const detailResponse = await got({\r\n                        method: 'get',\r\n                        url: link,\r\n                    });\r\n                    const content = load(detailResponse.data);\r\n\r\n                    content('.bot_word, .js-open-app, .s-img').remove();\r\n                    content('video').each(function () {\r\n                        content(this).attr('src', content(this).attr('data-src'));\r\n                    });\r\n                    content('.article-body .image-lazy').each((_, elem) => {\r\n                        elem.attribs.src = elem.attribs['data-src'] ?? elem.attribs.src;\r\n                    });\r\n\r\n                    item.title = content('meta[property=\"og:title\"]').attr('content').replace('_手机网易网', '');\r\n                    item.pubDate = parseDate(content('meta[property=\"og:release_date\"]').attr('content'));\r\n                    item.description = content('.article-body').html();\r\n                } catch {\r\n                    return '';\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `网易新闻${timeRange[time].title}${type === 'click' ? '点击' : '跟帖'}榜 - ${cfg.title}`,\r\n        link: currentUrl,\r\n        item: items.filter(Boolean),\r\n    };\r\n}\r\n"],"mappings":"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"}