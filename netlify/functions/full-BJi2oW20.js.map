{"version":3,"file":"full-BJi2oW20.js","names":["cache","got","route: Route","parser"],"sources":["../../lib/routes/npr/full.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport parser from '@/utils/rss-parser';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\n\r\nconst getArticleDetail = (link) =>\r\n    cache.tryGet(link, async () => {\r\n        const response = await got(link);\r\n        const $ = load(response.data);\r\n\r\n        const categories = $('.slug').text().trim();\r\n\r\n        // ignore item until audio is available\r\n        if ($('.audio-availability-message').length > 0) {\r\n            return null;\r\n        }\r\n\r\n        // handle multiple audios\r\n        for (const x of $('.audio-module').toArray()) {\r\n            const audioLink = $($(x).find('.audio-tool-download a')).attr('href');\r\n            const audio_tag = `<audio controls><source src=\"${audioLink}\" type=\"audio/mp3\"></audio>`;\r\n            $(x).replaceWith(audio_tag);\r\n        }\r\n\r\n        // primaryaudio is not in `.storytext`, prepend to it\r\n        const primaryaudio = $('#primaryaudio');\r\n        const audio = primaryaudio.length > 0 ? $('#primaryaudio').html() : '';\r\n\r\n        // replace video\r\n        const regex = /\\?storyId=(\\d+)&amp;mediaId=(\\d+)/;\r\n        const m = $.html().match(regex);\r\n        if (m) {\r\n            const storyId = m[1];\r\n            const mediaId = m[2];\r\n            const video_tag = `<iframe width=\"740\" height=\"416\" src=\"https://www.npr.org/embedded-video?storyId=${storyId}&mediaId=${mediaId}&jwMediaType=music\" frameborder=\"0\" scrolling=\"no\"></iframe>`;\r\n            const nprVideo = $('.npr-video');\r\n            if (nprVideo.length === 1) {\r\n                nprVideo.replaceWith(video_tag);\r\n            }\r\n        }\r\n\r\n        // remove duplicate caption and images\r\n        $('.enlarge_measure').remove();\r\n        $('.enlarge_html').remove();\r\n        $('.hide-caption').remove();\r\n        $('.toggle-caption').remove();\r\n        $('.credit-caption b.credit').remove();\r\n        $('.credit-caption span.credit').wrap('<figcaption></figcaption>');\r\n        $('.caption > p').wrap('<figcaption></figcaption>');\r\n\r\n        const article =\r\n            audio +\r\n            $('.storytext')\r\n                .toArray()\r\n                .map((el) => $(el).html())\r\n                .join('');\r\n\r\n        return { article, categories };\r\n    });\r\n\r\nexport const route: Route = {\r\n    path: '/:endpoint?',\r\n    categories: ['traditional-media'],\r\n    example: '/npr/1001',\r\n    parameters: { endpoint: 'Channel ID, can be found in Official RSS URL, `1001` by default' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'News',\r\n    maintainers: ['bennyyip'],\r\n    handler,\r\n    description: `Provide full article RSS for CBC topics.`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const endpoint = ctx.req.param('endpoint') || '1001';\r\n    const feed = await parser.parseURL(`https://feeds.npr.org/${endpoint}/rss.xml`);\r\n\r\n    const items = (\r\n        await Promise.all(\r\n            feed.items.map(async (item) => {\r\n                const itemDetails = await getArticleDetail(item.link);\r\n                if (itemDetails === null) {\r\n                    return null;\r\n                }\r\n                return {\r\n                    ...item,\r\n                    description: itemDetails.article,\r\n                    category: itemDetails.categories,\r\n                };\r\n            })\r\n        )\r\n    ).filter(Boolean);\r\n\r\n    return {\r\n        title: feed.title,\r\n        link: feed.link,\r\n        description: feed.description,\r\n        icon: 'https://media.npr.org/images/podcasts/primary/npr_generic_image_300.jpg?s=200',\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"iXAMA,MAAM,EAAoB,GACtBA,EAAM,OAAO,EAAM,SAAY,CAC3B,IAAM,EAAW,MAAMC,EAAI,GACrB,EAAI,EAAK,EAAS,MAElB,EAAa,EAAE,SAAS,OAAO,OAGrC,GAAI,EAAE,+BAA+B,OAAS,EAC1C,OAAO,KAIX,IAAK,IAAM,KAAK,EAAE,iBAAiB,UAAW,CAC1C,IAAM,EAAY,EAAE,EAAE,GAAG,KAAK,2BAA2B,KAAK,QACxD,EAAY,gCAAgC,EAAU,6BAC5D,EAAE,GAAG,YAAY,GAIrB,IAAM,EAAe,EAAE,iBACjB,EAAQ,EAAa,OAAS,EAAI,EAAE,iBAAiB,OAAS,GAG9D,EAAQ,oCACR,EAAI,EAAE,OAAO,MAAM,GACzB,GAAI,EAAG,CACH,IAAM,EAAU,EAAE,GACZ,EAAU,EAAE,GACZ,EAAY,oFAAoF,EAAQ,WAAW,EAAQ,8DAC3H,EAAW,EAAE,cACf,EAAS,SAAW,GACpB,EAAS,YAAY,GAK7B,EAAE,oBAAoB,SACtB,EAAE,iBAAiB,SACnB,EAAE,iBAAiB,SACnB,EAAE,mBAAmB,SACrB,EAAE,4BAA4B,SAC9B,EAAE,+BAA+B,KAAK,6BACtC,EAAE,gBAAgB,KAAK,6BAEvB,IAAM,EACF,EACA,EAAE,cACG,UACA,IAAK,GAAO,EAAE,GAAI,QAClB,KAAK,IAEd,MAAO,CAAE,UAAS,gBAGbC,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,qBACb,QAAS,YACT,WAAY,CAAE,SAAU,mEACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,YACd,UACA,YAAa,4CAGjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,aAAe,OACxC,EAAO,MAAMC,EAAO,SAAS,yBAAyB,EAAS,WAE/D,GACF,MAAM,QAAQ,IACV,EAAK,MAAM,IAAI,KAAO,IAAS,CAC3B,IAAM,EAAc,MAAM,EAAiB,EAAK,MAIhD,OAHI,IAAgB,KACT,KAEJ,CACH,GAAG,EACH,YAAa,EAAY,QACzB,SAAU,EAAY,gBAIpC,OAAO,SAET,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,YAAa,EAAK,YAClB,KAAM,gFACN,KAAM"}