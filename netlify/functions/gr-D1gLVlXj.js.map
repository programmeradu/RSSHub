{"version":3,"file":"gr-D1gLVlXj.js","names":["route: Route","InvalidParameterError","ofetch","cache"],"sources":["../../lib/routes/uestc/gr.ts"],"sourcesContent":["import { Data, DataItem, Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport type { Context } from 'hono';\r\n\r\nconst baseUrl = 'https://gr.uestc.edu.cn/';\r\nconst detailUrl = 'https://gr.uestc.edu.cn/';\r\n\r\nconst dateTimeRegex = /(\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2})/;\r\n\r\nconst typeUrlMap = {\r\n    important: 'tongzhi/',\r\n    teaching: 'tongzhi/119',\r\n    degree: 'tongzhi/129',\r\n    student: 'tongzhi/122',\r\n    practice: 'tongzhi/123',\r\n};\r\n\r\nconst typeNameMap = {\r\n    important: '重要公告',\r\n    teaching: '教学管理',\r\n    degree: '学位管理',\r\n    student: '学生管理',\r\n    practice: '就业实践',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/gr/:type?',\r\n    categories: ['university'],\r\n    example: '/uestc/gr/student',\r\n    parameters: { type: '默认为 `important`' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['gr.uestc.edu.cn/'],\r\n        },\r\n    ],\r\n    name: '研究生院',\r\n    maintainers: ['huyyi', 'mobyw'],\r\n    handler,\r\n    url: 'gr.uestc.edu.cn/',\r\n    description: `\\\r\n| 重要公告  | 教学管理 | 学位管理 | 学生管理 | 就业实践 |\r\n| --------- | -------- | -------- | -------- | -------- |\r\n| important | teaching | degree   | student  | practice |`,\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    const type = ctx.req.param('type') || 'important';\r\n    if (type in typeUrlMap === false) {\r\n        throw new InvalidParameterError('type not supported');\r\n    }\r\n    const typeName = typeNameMap[type];\r\n\r\n    const indexContent = await ofetch(baseUrl + typeUrlMap[type]);\r\n\r\n    const $ = load(indexContent);\r\n    const entries = $('div.title').toArray();\r\n\r\n    const items = entries.map(async (entry) => {\r\n        const element = $(entry);\r\n        const newsTitle = element.find('a').text() ?? '';\r\n        const newsLink = detailUrl + element.find('a').attr('href');\r\n\r\n        const newsDetail = await cache.tryGet(newsLink, async () => {\r\n            const newsContent = await ofetch(newsLink);\r\n            const content = load(newsContent);\r\n\r\n            const basicInfo = content('div.topic_detail_header').find('div.info').text();\r\n            const match = dateTimeRegex.exec(basicInfo);\r\n\r\n            return {\r\n                title: newsTitle,\r\n                link: newsLink,\r\n                pubDate: match ? timezone(parseDate(match[1]), +8) : null,\r\n                description: content('div.content').html(),\r\n            };\r\n        });\r\n\r\n        return newsDetail;\r\n    });\r\n\r\n    const out = await Promise.all(items);\r\n\r\n    return {\r\n        title: `研究生院通知（${typeName}）`,\r\n        link: baseUrl,\r\n        description: `电子科技大学研究生院通知（${typeName}）`,\r\n        item: out as DataItem[],\r\n    };\r\n}\r\n"],"mappings":"ibASA,MAAM,EAAU,2BAGV,EAAgB,kCAEhB,EAAa,CACf,UAAW,WACX,SAAU,cACV,OAAQ,cACR,QAAS,cACT,SAAU,eAGR,EAAc,CAChB,UAAW,OACX,SAAU,OACV,OAAQ,OACR,QAAS,OACT,SAAU,QAGDA,EAAe,CACxB,KAAM,aACN,WAAY,CAAC,cACb,QAAS,oBACT,WAAY,CAAE,KAAM,mBACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,sBAGjB,KAAM,OACN,YAAa,CAAC,QAAS,SACvB,UACA,IAAK,mBACL,YAAa;;4DAMjB,eAAe,EAAQ,EAA6B,CAChD,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,YACtC,GAAI,OAAQ,GACR,MAAM,IAAIC,EAAsB,sBAEpC,IAAM,EAAW,EAAY,GAEvB,EAAe,MAAMC,EAAO,EAAU,EAAW,IAEjD,EAAI,EAAK,GACT,EAAU,EAAE,aAAa,UAEzB,EAAQ,EAAQ,IAAI,KAAO,IAAU,CACvC,IAAM,EAAU,EAAE,GACZ,EAAY,EAAQ,KAAK,KAAK,QAAU,GACxC,EAAW,2BAAY,EAAQ,KAAK,KAAK,KAAK,QAE9C,EAAa,MAAMC,EAAM,OAAO,EAAU,SAAY,CACxD,IAAM,EAAc,MAAMD,EAAO,GAC3B,EAAU,EAAK,GAEf,EAAY,EAAQ,2BAA2B,KAAK,YAAY,OAChE,EAAQ,EAAc,KAAK,GAEjC,MAAO,CACH,MAAO,EACP,KAAM,EACN,QAAS,EAAQ,EAAS,EAAU,EAAM,IAAK,GAAM,KACrD,YAAa,EAAQ,eAAe,UAI5C,OAAO,IAGL,EAAM,MAAM,QAAQ,IAAI,GAE9B,MAAO,CACH,MAAO,UAAU,EAAS,GAC1B,KAAM,EACN,YAAa,gBAAgB,EAAS,GACtC,KAAM"}