{"version":3,"file":"vsearch-BfyCC3Od.js","names":["route: Route","utils","cacheIn","got"],"sources":["../../lib/routes/bilibili/vsearch.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport utils from './utils';\r\nimport cacheIn from './cache';\r\n\r\nexport const route: Route = {\r\n    path: '/vsearch/:kw/:order?/:embed?/:tid?',\r\n    categories: ['social-media'],\r\n    example: '/bilibili/vsearch/RSSHub',\r\n    parameters: {\r\n        kw: '检索关键字',\r\n        order: '排序方式, 综合:totalrank 最多点击:click 最新发布:pubdate(缺省) 最多弹幕:dm 最多收藏:stow',\r\n        embed: '默认为开启内嵌视频, 任意值为关闭',\r\n        tid: '分区 id',\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'BILIBILI_COOKIE_*',\r\n                optional: true,\r\n                description: `如果没有此配置，那么必须开启 puppeteer 支持；BILIBILI_COOKIE_{uid}: 用于用户关注动态系列路由，对应 uid 的 b 站用户登录后的 Cookie 值，\\`{uid}\\` 替换为 uid，如 \\`BILIBILI_COOKIE_2267573\\`，获取方式：\r\n1.  打开 [https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8](https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid=0&type=8)\r\n2.  打开控制台，切换到 Network 面板，刷新\r\n3.  点击 dynamic_new 请求，找到 Cookie\r\n4.  视频和专栏，UP 主粉丝及关注只要求 \\`SESSDATA\\` 字段，动态需复制整段 Cookie`,\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '视频搜索',\r\n    maintainers: ['pcrtool', 'DIYgod'],\r\n    handler,\r\n    description: `分区 id 的取值请参考下表：\r\n\r\n| 全部分区 | 动画 | 番剧 | 国创 | 音乐 | 舞蹈 | 游戏 | 知识 | 科技 | 运动 | 汽车 | 生活 | 美食 | 动物圈 | 鬼畜 | 时尚 | 资讯 | 娱乐 | 影视 | 纪录片 | 电影 | 电视剧 |\r\n| -------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ------ | ---- | ---- | ---- | ---- | ---- | ------ | ---- | ------ |\r\n| 0        | 1    | 13   | 167  | 3    | 129  | 4    | 36   | 188  | 234  | 223  | 160  | 211  | 217    | 119  | 155  | 202  | 5    | 181  | 177    | 23   | 11     |`,\r\n};\r\n\r\nconst getIframe = (data, embed: boolean = true) => {\r\n    if (!embed) {\r\n        return '';\r\n    }\r\n    const aid = data?.aid;\r\n    const bvid = data?.bvid;\r\n    if (aid === undefined && bvid === undefined) {\r\n        return '';\r\n    }\r\n    return utils.renderUGCDescription(embed, '', '', aid, undefined, bvid);\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const kw = ctx.req.param('kw');\r\n    const order = ctx.req.param('order') || 'pubdate';\r\n    const embed = !ctx.req.param('embed');\r\n    const kw_url = encodeURIComponent(kw);\r\n    const tids = ctx.req.param('tid') ?? 0;\r\n    const cookie = await cacheIn.getCookie();\r\n\r\n    const response = await got('https://api.bilibili.com/x/web-interface/search/type', {\r\n        headers: {\r\n            Referer: `https://search.bilibili.com/all?keyword=${kw_url}`,\r\n            Cookie: cookie,\r\n        },\r\n        searchParams: {\r\n            search_type: 'video',\r\n            highlight: 1,\r\n            keyword: kw,\r\n            order,\r\n            tids,\r\n        },\r\n    });\r\n    const data = response.data.data.result;\r\n\r\n    return {\r\n        title: `${kw} - bilibili`,\r\n        link: `https://search.bilibili.com/all?keyword=${kw}&order=${order}`,\r\n        description: `Result from ${kw} bilibili search, ordered by ${order}.`,\r\n        item: data.map((item) => {\r\n            const l = item.duration\r\n                .split(':')\r\n                .map((i) => [i.length > 1 ? i : ('00' + i).slice(-2)])\r\n                .join(':');\r\n            const des = item.description.replaceAll('\\n', '<br/>');\r\n            const img = item.pic.replaceAll(/^\\/\\//g, 'http://');\r\n            return {\r\n                title: item.title.replaceAll(/<[ /]?em[^>]*>/g, ''),\r\n                author: item.author,\r\n                category: [...item.tag.split(','), item.typename],\r\n                description:\r\n                    `Length: ${l}<br/>` +\r\n                    `AuthorID: ${item.mid}<br/>` +\r\n                    `Play: ${item.play}    Favorite: ${item.favorites}<br/>` +\r\n                    `Danmaku: ${item.video_review}    Comment: ${item.review}<br/>` +\r\n                    `<br/>${des}<br/>` +\r\n                    `<img src=\"${img}\"><br/>` +\r\n                    `Match By: ${item.hit_columns?.join(',') || ''}` +\r\n                    getIframe(item, embed),\r\n                pubDate: parseDate(item.pubdate, 'X'),\r\n                guid: item.arcurl,\r\n                link: item.arcurl,\r\n            };\r\n        }),\r\n    };\r\n}\r\n"],"mappings":"4gBAMA,MAAaA,EAAe,CACxB,KAAM,qCACN,WAAY,CAAC,gBACb,QAAS,2BACT,WAAY,CACR,GAAI,QACJ,MAAO,mEACP,MAAO,oBACP,IAAK,SAET,SAAU,CACN,cAAe,CACX,CACI,KAAM,oBACN,SAAU,GACV,YAAa,gbAOrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,UAAW,UACzB,UACA,YAAa;;;;wKAOX,GAAa,EAAM,EAAiB,KAAS,CAC/C,GAAI,CAAC,EACD,MAAO,GAEX,IAAM,EAAM,GAAM,IACZ,EAAO,GAAM,KAInB,OAHI,IAAQ,IAAA,IAAa,IAAS,IAAA,GACvB,GAEJC,EAAM,qBAAqB,EAAO,GAAI,GAAI,EAAK,IAAA,GAAW,IAGrE,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAQ,EAAI,IAAI,MAAM,UAAY,UAClC,EAAQ,CAAC,EAAI,IAAI,MAAM,SACvB,EAAS,mBAAmB,GAC5B,EAAO,EAAI,IAAI,MAAM,QAAU,EAC/B,EAAS,MAAMC,EAAQ,YAEvB,EAAW,MAAMC,EAAI,uDAAwD,CAC/E,QAAS,CACL,QAAS,2CAA2C,IACpD,OAAQ,GAEZ,aAAc,CACV,YAAa,QACb,UAAW,EACX,QAAS,EACT,QACA,UAGF,EAAO,EAAS,KAAK,KAAK,OAEhC,MAAO,CACH,MAAO,GAAG,EAAG,aACb,KAAM,2CAA2C,EAAG,SAAS,IAC7D,YAAa,eAAe,EAAG,+BAA+B,EAAM,GACpE,KAAM,EAAK,IAAK,GAAS,CACrB,IAAM,EAAI,EAAK,SACV,MAAM,KACN,IAAK,GAAM,CAAC,EAAE,OAAS,EAAI,GAAK,KAAO,GAAG,MAAM,MAChD,KAAK,KACJ,EAAM,EAAK,YAAY,WAAW;EAAM,SACxC,EAAM,EAAK,IAAI,WAAW,SAAU,WAC1C,MAAO,CACH,MAAO,EAAK,MAAM,WAAW,kBAAmB,IAChD,OAAQ,EAAK,OACb,SAAU,CAAC,GAAG,EAAK,IAAI,MAAM,KAAM,EAAK,UACxC,YACI,WAAW,EAAE,iBACA,EAAK,IAAI,aACb,EAAK,KAAK,gBAAgB,EAAK,UAAU,gBACtC,EAAK,aAAa,eAAe,EAAK,OAAO,YACjD,EAAI,iBACC,EAAI,mBACJ,EAAK,aAAa,KAAK,MAAQ,KAC5C,EAAU,EAAM,GACpB,QAAS,EAAU,EAAK,QAAS,KACjC,KAAM,EAAK,OACX,KAAM,EAAK"}