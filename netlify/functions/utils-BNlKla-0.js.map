{"version":3,"file":"utils-BNlKla-0.js","names":["got","description: string | undefined"],"sources":["../../lib/routes/zsxq/utils.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport type { TopicImage, Topic, BasicResponse, ResponseData } from './types';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport type { DataItem } from '@/types';\r\n\r\nexport async function customFetch<T extends BasicResponse<ResponseData>>(path: string, retryCount = 0): Promise<T['resp_data']> {\r\n    const apiUrl = 'https://api.zsxq.com/v2';\r\n\r\n    const response = await got(apiUrl + path, {\r\n        headers: {\r\n            cookie: `zsxq_access_token=${config.zsxq.accessToken};`,\r\n        },\r\n    });\r\n    const { succeeded, code, resp_data } = response.data as T;\r\n    if (succeeded) {\r\n        return resp_data;\r\n    }\r\n    // sometimes the request will fail with code 1059, retry will solve the problem\r\n    if (code === 1059 && retryCount < 3) {\r\n        return customFetch(path, ++retryCount);\r\n    }\r\n    throw new Error('something wrong');\r\n}\r\n\r\nfunction parseTopicContent(text: string = '', images: TopicImage[] = []) {\r\n    let result = text.replaceAll('\\n', '<br>');\r\n    result = result.replaceAll(/<e type=\"web\" href=\"(.*?)\" title=\"(.*?)\" style=\"(.*?)\" \\/>/g, (_, p1, p2) => `<a href=${decodeURIComponent(p1)}>${decodeURIComponent(p2)}</a>`);\r\n    result = result.replaceAll(/<e type=\"hashtag\".*?title=\"(.*?)\" \\/>/g, (_, p1) => {\r\n        const title = decodeURIComponent(p1);\r\n        return `<span>${title}</span>`;\r\n    });\r\n    result += images.map((image) => `<img src=\"${image.original?.url ?? image.large?.url ?? image.thumbnail?.url}\">`).join('<br>');\r\n    return result;\r\n}\r\n\r\nexport function generateTopicDataItem(topics: Topic[]): DataItem[] {\r\n    return topics.map((topic) => {\r\n        let description: string | undefined;\r\n        let title = '';\r\n        const url = `https://wx.zsxq.com/topic/${topic.topic_id}`;\r\n        switch (topic.type) {\r\n            case 'talk':\r\n                title = topic.talk?.text?.split('\\n')[0] ?? '文章';\r\n                description = parseTopicContent(topic.talk?.text, topic.talk?.images);\r\n                break;\r\n            case 'q&a':\r\n                title = topic.question?.text?.split('\\n')[0] ?? '问答';\r\n                description = parseTopicContent(topic.question?.text, topic.question?.images);\r\n                description = `<blockquote>${String(topic.question?.owner?.name ?? '匿名用户')} 提问：${description}</blockquote>`;\r\n                if (topic.answered) {\r\n                    description += '<br>' + topic.answer?.owner.name + ' 回答：<br><br>';\r\n                    description += parseTopicContent(topic.answer?.text, topic.answer?.images);\r\n                }\r\n                break;\r\n            case 'task':\r\n                title = topic.task?.text?.split('\\n')[0] ?? '作业';\r\n                description = parseTopicContent(topic.task?.text, topic.task?.images);\r\n                break;\r\n            case 'solution':\r\n                title = topic.solution?.text?.split('\\n')[0] ?? '写作业';\r\n                description = parseTopicContent(topic.solution?.text, topic.solution?.images);\r\n                break;\r\n            default:\r\n        }\r\n        return {\r\n            title: topic.title ?? title,\r\n            description,\r\n            pubDate: parseDate(topic.create_time),\r\n            link: url,\r\n        };\r\n    });\r\n}\r\n"],"mappings":"mJAMA,eAAsB,EAAmD,EAAc,EAAa,EAA4B,CAC5H,IAEM,EAAW,MAAMA,EAAI,0BAAS,EAAM,CACtC,QAAS,CACL,OAAQ,qBAAqB,EAAO,KAAK,YAAY,MAGvD,CAAE,YAAW,OAAM,aAAc,EAAS,KAChD,GAAI,EACA,OAAO,EAGX,GAAI,IAAS,MAAQ,EAAa,EAC9B,OAAO,EAAY,EAAM,EAAE,GAE/B,MAAU,MAAM,mBAGpB,SAAS,EAAkB,EAAe,GAAI,EAAuB,GAAI,CACrE,IAAI,EAAS,EAAK,WAAW;EAAM,QAOnC,MANA,GAAS,EAAO,WAAW,+DAAgE,EAAG,EAAI,IAAO,WAAW,mBAAmB,GAAI,GAAG,mBAAmB,GAAI,OACrK,EAAS,EAAO,WAAW,0CAA2C,EAAG,IAAO,CAC5E,IAAM,EAAQ,mBAAmB,GACjC,MAAO,SAAS,EAAM,WAE1B,GAAU,EAAO,IAAK,GAAU,aAAa,EAAM,UAAU,KAAO,EAAM,OAAO,KAAO,EAAM,WAAW,IAAI,KAAK,KAAK,QAChH,EAGX,SAAgB,EAAsB,EAA6B,CAC/D,OAAO,EAAO,IAAK,GAAU,CACzB,IAAIC,EACA,EAAQ,GACN,EAAM,6BAA6B,EAAM,WAC/C,OAAQ,EAAM,KAAd,CACI,IAAK,OACD,EAAQ,EAAM,MAAM,MAAM,MAAM;GAAM,IAAM,KAC5C,EAAc,EAAkB,EAAM,MAAM,KAAM,EAAM,MAAM,QAC9D,MACJ,IAAK,MACD,EAAQ,EAAM,UAAU,MAAM,MAAM;GAAM,IAAM,KAChD,EAAc,EAAkB,EAAM,UAAU,KAAM,EAAM,UAAU,QACtE,EAAc,eAAe,OAAO,EAAM,UAAU,OAAO,MAAQ,QAAQ,MAAM,EAAY,eACzF,EAAM,WACN,GAAe,OAAS,EAAM,QAAQ,MAAM,KAAO,eACnD,GAAe,EAAkB,EAAM,QAAQ,KAAM,EAAM,QAAQ,SAEvE,MACJ,IAAK,OACD,EAAQ,EAAM,MAAM,MAAM,MAAM;GAAM,IAAM,KAC5C,EAAc,EAAkB,EAAM,MAAM,KAAM,EAAM,MAAM,QAC9D,MACJ,IAAK,WACD,EAAQ,EAAM,UAAU,MAAM,MAAM;GAAM,IAAM,MAChD,EAAc,EAAkB,EAAM,UAAU,KAAM,EAAM,UAAU,QACtE,MACJ,SAEJ,MAAO,CACH,MAAO,EAAM,OAAS,EACtB,cACA,QAAS,EAAU,EAAM,aACzB,KAAM"}