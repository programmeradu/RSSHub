{"version":3,"file":"paper-YRLGKWC_.js","names":[],"sources":["../../lib/routes/cntheory/paper.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/paper/:id?',\r\n    categories: ['traditional-media'],\r\n    example: '/cntheory/paper',\r\n    parameters: { id: '板块，默认为全部' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '学习时报',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `如订阅 **第 A1 版：国内大局**，路由为 [\\`/cntheory/paper/国内大局\\`](https://rsshub.app/cntheory/paper/国内大局)。`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n\r\n    const rootUrl = 'https://paper.cntheory.com';\r\n\r\n    let response = await got({\r\n        method: 'get',\r\n        url: rootUrl,\r\n    });\r\n\r\n    response = await got({\r\n        method: 'get',\r\n        url: `${rootUrl}/${response.data.match(/URL=(.*)\"/)[1]}`,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    const matches = response.data.match(/images\\/(\\d{4}-\\d{2}\\/\\d{2})\\/\\w+\\/\\w+_brief/);\r\n    const link = `${rootUrl}/html/${matches[1]}`;\r\n\r\n    let items = [];\r\n\r\n    await Promise.all(\r\n        $('#pageLink')\r\n            .toArray()\r\n            .filter((p) => (id ? $(p).text().split('：').pop() === id : true))\r\n            .map((p) => `${link}/${$(p).attr('href').replace(/\\.\\//, '')}`)\r\n            .map(async (p) => {\r\n                const pageResponse = await got({\r\n                    method: 'get',\r\n                    url: p,\r\n                });\r\n\r\n                const page = load(pageResponse.data);\r\n\r\n                items.push(\r\n                    ...page('table')\r\n                        .last()\r\n                        .find('a')\r\n                        .toArray()\r\n                        .map((a) => `${link}/${$(a).attr('href')}`)\r\n                );\r\n            })\r\n    );\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item,\r\n                });\r\n\r\n                const content = load(detailResponse.data);\r\n\r\n                return {\r\n                    link: item,\r\n                    title: content('h1').text(),\r\n                    pubDate: parseDate(matches[1], 'YYYY-MM/DD'),\r\n                    enclosure_url: `${rootUrl}${\r\n                        content('.ban_t a')\r\n                            .first()\r\n                            .attr('href')\r\n                            .match(/(\\/images.*)/)[1]\r\n                    }`,\r\n                    description: art(path.join(__dirname, 'templates/description.art'), {\r\n                        resource: content('#reslist').html().replaceAll('display:none;', ''),\r\n                        description: content('founder-content').html(),\r\n                    }),\r\n                };\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `学习时报${id ? ` - ${id}` : ''}`,\r\n        link: rootUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,qBACb,QAAS,kBACT,WAAY,CAAE,GAAI,YAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,WACd,UACA,YAAa,6FAGjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MAEnB,EAAU,6BAEZ,EAAW,MAAM,EAAI,CACrB,OAAQ,MACR,IAAK,IAGT,EAAW,MAAM,EAAI,CACjB,OAAQ,MACR,IAAK,GAAG,EAAQ,GAAG,EAAS,KAAK,MAAM,aAAa,OAGxD,IAAM,EAAI,EAAK,EAAS,MAElB,EAAU,EAAS,KAAK,MAAM,gDAC9B,EAAO,GAAG,EAAQ,QAAQ,EAAQ,KAEpC,EAAQ,GAsDZ,OApDA,MAAM,QAAQ,IACV,EAAE,aACG,UACA,OAAQ,GAAO,EAAK,EAAE,GAAG,OAAO,MAAM,KAAK,QAAU,EAAK,IAC1D,IAAK,GAAM,GAAG,EAAK,GAAG,EAAE,GAAG,KAAK,QAAQ,QAAQ,OAAQ,OACxD,IAAI,KAAO,IAAM,CACd,IAAM,EAAe,MAAM,EAAI,CAC3B,OAAQ,MACR,IAAK,IAGH,EAAO,EAAK,EAAa,MAE/B,EAAM,KACF,GAAG,EAAK,SACH,OACA,KAAK,KACL,UACA,IAAK,GAAM,GAAG,EAAK,GAAG,EAAE,GAAG,KAAK,eAKrD,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAM,SAAY,CAC3B,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,IAGH,EAAU,EAAK,EAAe,MAEpC,MAAO,CACH,KAAM,EACN,MAAO,EAAQ,MAAM,OACrB,QAAS,EAAU,EAAQ,GAAI,cAC/B,cAAe,GAAG,IACd,EAAQ,YACH,QACA,KAAK,QACL,MAAM,gBAAgB,KAE/B,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,SAAU,EAAQ,YAAY,OAAO,WAAW,gBAAiB,IACjE,YAAa,EAAQ,mBAAmB,cAOrD,CACH,MAAO,OAAO,EAAK,MAAM,IAAO,KAChC,KAAM,EACN,KAAM,EACN,WAAY"}