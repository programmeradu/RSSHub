{"version":3,"file":"news-BmtccF19.js","names":["got"],"sources":["../../lib/routes/hoyolab/constant.ts","../../lib/routes/hoyolab/utils.ts","../../lib/routes/hoyolab/news.ts"],"sourcesContent":["// 域名\r\nconst HOST = 'https://bbs-api-os.hoyolab.com';\r\n// 活动列接口\r\nconst EVENT_LIST = '/community/community_contribution/wapi/event/list';\r\n// 活动详情接口\r\nconst POST_FULL = '/community/post/wapi/getPostFull';\r\n// 公告和资讯接口\r\nconst NEW_LIST = '/community/post/wapi/getNewsList';\r\n\r\n// 源网站链接\r\nconst LINK = 'https://www.hoyolab.com';\r\n\r\n// 部分图片使用了禁止公开访问的域名\r\nconst PRIVATE_IMG = '<img src=\"https://hoyolab-upload-private.hoyolab.com/upload';\r\n// 使用以下域名可以替换\r\nconst PUBLIC_IMG = '<img src=\"https://upload-os-bbs.hoyolab.com/upload';\r\n\r\n// 公告类型\r\nconst OFFICIAL_PAGE_TYPE = {\r\n    2: 27,\r\n    6: 39,\r\n    8: 47,\r\n    1: 31,\r\n    4: 35,\r\n    5: 43,\r\n};\r\n\r\nexport { PRIVATE_IMG, PUBLIC_IMG, LINK, POST_FULL, HOST, EVENT_LIST, NEW_LIST, OFFICIAL_PAGE_TYPE };\r\n","import got from '@/utils/got';\r\n\r\nconst getGameInfoList = (tryGet) =>\r\n    tryGet('hoyolab:gameNameList', async () => {\r\n        const { data } = await got('https://bbs-api-os-static.hoyolab.com/community/apihub/static/api/getAppConfig');\r\n        return JSON.parse(data.data.config.hoyolab_game_info_list);\r\n    });\r\n\r\nconst getI18nGameInfo = async (gid, language, tryGet) => {\r\n    const gameNameList = await getGameInfoList(tryGet);\r\n    const game = gameNameList.find((item) => item.game_id === Number.parseInt(gid, 10));\r\n    return {\r\n        name: game?.game_name_list.find((item) => item.locale === language)?.raw_name ?? game?.game_name_list.find((item) => item.locale === 'en-us')?.raw_name,\r\n        icon: game?.game_icon,\r\n    };\r\n};\r\n\r\nconst getI18nType = (language, tryGet) =>\r\n    tryGet(`hoyolab:type:${language}`, async () => {\r\n        const { data } = await got(`https://webstatic.hoyoverse.com/admin/mi18n/bbs_oversea/m07281525151831/m07281525151831-${language}.json`);\r\n\r\n        return {\r\n            1: { title: data.official_notify, sort: 'notices' },\r\n            2: { title: data.official_activity, sort: 'events' },\r\n            3: { title: data.official_info, sort: 'news' },\r\n        };\r\n    });\r\n\r\nexport { getI18nGameInfo, getI18nType };\r\n","import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport logger from '@/utils/logger';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { HOST, NEW_LIST, OFFICIAL_PAGE_TYPE, POST_FULL, LINK, PUBLIC_IMG, PRIVATE_IMG } from './constant';\r\nimport { getI18nGameInfo, getI18nType } from './utils';\r\n\r\nconst getEventList = async ({ type, gids, size, language }) => {\r\n    const query = new URLSearchParams({\r\n        type,\r\n        gids,\r\n        page_size: size,\r\n    }).toString();\r\n    const url = `${HOST}${NEW_LIST}?${query}`;\r\n    const res = await got({\r\n        method: 'get',\r\n        url,\r\n        headers: {\r\n            'X-Rpc-Language': language,\r\n        },\r\n    });\r\n    const list = res?.data?.data?.list || [];\r\n    return list;\r\n};\r\n\r\nconst replaceImgDomain = (content) => content.replaceAll(PRIVATE_IMG, PUBLIC_IMG);\r\n\r\nconst getPostContent = (list, { language }) =>\r\n    Promise.all(\r\n        list.map(async (row) => {\r\n            const post = row.post;\r\n            const post_id = post.post_id;\r\n            const query = new URLSearchParams({\r\n                post_id,\r\n                language, // language为了区分缓存，对接口并无意义\r\n            }).toString();\r\n            const url = `${HOST}${POST_FULL}?${query}`;\r\n            return await cache.tryGet(url, async () => {\r\n                const res = await got({\r\n                    method: 'get',\r\n                    url,\r\n                    headers: {\r\n                        'X-Rpc-Language': language,\r\n                    },\r\n                });\r\n                const author = res?.data?.data?.post?.user?.nickname || '';\r\n                let content = res?.data?.data?.post?.post?.content || '';\r\n                if (content === language || !content) {\r\n                    content = post.content;\r\n                }\r\n                const description = art(path.join(__dirname, 'templates/post.art'), {\r\n                    hasCover: post.has_cover,\r\n                    coverList: row.cover_list,\r\n                    content: replaceImgDomain(content),\r\n                });\r\n                return {\r\n                    // 文章标题\r\n                    title: post.subject,\r\n                    // 文章链接\r\n                    link: `${LINK}/article/${post_id}`,\r\n                    // 文章正文\r\n                    description,\r\n                    // 文章发布日期\r\n                    pubDate: parseDate(post.created_at * 1000),\r\n                    author,\r\n                };\r\n            });\r\n        })\r\n    );\r\n\r\nexport const route: Route = {\r\n    path: '/news/:language/:gids/:type',\r\n    categories: ['game'],\r\n    example: '/hoyolab/news/zh-cn/2/2',\r\n    parameters: { language: 'Language', gids: 'Game ID', type: 'Announcement type' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Official Announcement',\r\n    maintainers: ['ZenoTian'],\r\n    handler,\r\n    description: `| Language         | Code  |\r\n| ---------------- | ----- |\r\n| 简体中文         | zh-cn |\r\n| 繁體中文         | zh-tw |\r\n| 日本語           | ja-jp |\r\n| 한국어           | ko-kr |\r\n| English (US)     | en-us |\r\n| Español (EU)     | es-es |\r\n| Français         | fr-fr |\r\n| Deutsch          | de-de |\r\n| Русский          | ru-ru |\r\n| Português        | pt-pt |\r\n| Español (Latino) | es-mx |\r\n| Indonesia        | id-id |\r\n| Tiếng Việt       | vi-vn |\r\n| ภาษาไทย          | th-th |\r\n\r\n| Honkai Impact 3rd | Genshin Impact | Tears of Themis | HoYoLAB | Honkai: Star Rail | Zenless Zone Zero |\r\n| ----------------- | -------------- | --------------- | ------- | ----------------- | ----------------- |\r\n| 1                 | 2              | 4               | 5       | 6                 | 8                 |\r\n\r\n| Notices | Events | Info |\r\n| ------- | ------ | ---- |\r\n| 1       | 2      | 3    |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    try {\r\n        const { type, gids, language } = ctx.req.param();\r\n        const params = {\r\n            type,\r\n            gids,\r\n            language,\r\n            size: Number.parseInt(ctx.req.query('limit')) || 15,\r\n        };\r\n        const gameInfo = await getI18nGameInfo(gids, language, cache.tryGet);\r\n        const typeInfo = await getI18nType(language, cache.tryGet);\r\n        const list = await getEventList(params);\r\n        const items = await getPostContent(list, params);\r\n        return {\r\n            title: `HoYoLAB-${gameInfo.name}-${typeInfo[type].title}`,\r\n            link: `${LINK}/circles/${gids}/${OFFICIAL_PAGE_TYPE[gids]}/official?page_type=${OFFICIAL_PAGE_TYPE[gids]}&page_sort=${typeInfo[type].sort}`,\r\n            item: items,\r\n            image: gameInfo.icon,\r\n            icon: gameInfo.icon,\r\n            logo: gameInfo.icon,\r\n        };\r\n    } catch (error) {\r\n        logger.error(error);\r\n    }\r\n}\r\n"],"mappings":"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"}