{"version":3,"file":"news-BcEA-Hqp.js","names":["route: Route","puppeteer","cache"],"sources":["../../lib/routes/fortnite/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport logger from '@/utils/logger';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nexport const route: Route = {\r\n    path: '/news/:options?',\r\n    categories: ['game'],\r\n    example: '/fortnite/news',\r\n    parameters: { options: 'Params' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'News',\r\n    maintainers: ['lyqluis'],\r\n    handler,\r\n    description: `-   \\`options.lang\\`, optional, language, eg. \\`/fortnite/news/lang=en-US\\`, common languages are listed below, more languages are available one the [official website](https://www.fortnite.com/news)\r\n\r\n| English (default) | Spanish | Japanese | French | Korean | Polish |\r\n| ----------------- | ------- | -------- | ------ | ------ | ------ |\r\n| en-US             | es-ES   | ja       | fr     | ko     | pl     |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const options = ctx.req\r\n        .param('options')\r\n        ?.split('&')\r\n        .map((op) => op.split('='));\r\n\r\n    const rootUrl = 'https://www.fortnite.com';\r\n    const path = 'news';\r\n    const language = options?.find((op) => op[0] === 'lang')[1] ?? 'en-US';\r\n    const link = `${rootUrl}/${path}?lang=${language}`;\r\n    const apiUrl = `https://www.fortnite.com/api/blog/getPosts?category=&postsPerPage=0&offset=0&locale=${language}&rootPageSlug=blog`;\r\n\r\n    // using puppeteer instead instead of got\r\n    // whitch may be blocked by anti-crawling script with response code 403\r\n    const browser = await puppeteer();\r\n    const page = await browser.newPage();\r\n\r\n    // intercept all requests\r\n    await page.setRequestInterception(true);\r\n    // only document is allowed\r\n    page.on('request', (request) => {\r\n        request.resourceType() === 'document' ? request.continue() : request.abort();\r\n    });\r\n\r\n    // get json data in response event handler\r\n    let data;\r\n    page.on('response', async (res) => {\r\n        data = await res.json();\r\n    });\r\n\r\n    // log manually (necessary for puppeteer)\r\n    logger.http(`Requesting ${apiUrl}`);\r\n    await page.goto(apiUrl, {\r\n        waitUntil: 'networkidle0', // if use 'domcontentloaded', `await page.content()` is necessary\r\n    });\r\n\r\n    await page.close();\r\n    await browser.close();\r\n\r\n    const { blogList: list } = data;\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, () => ({\r\n                title: item.title,\r\n                link: `${rootUrl}/${path}/${item.slug}?lang=${language}`,\r\n                pubDate: parseDate(item.date),\r\n                author: item.author,\r\n                description: item.content, // includes <img /> & full text\r\n            }))\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: 'Fortnite News',\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"oRAMA,MAAaA,EAAe,CACxB,KAAM,kBACN,WAAY,CAAC,QACb,QAAS,iBACT,WAAY,CAAE,QAAS,UACvB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,WACd,UACA,YAAa;;;;wEAOjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,EAAI,IACf,MAAM,YACL,MAAM,KACP,IAAK,GAAO,EAAG,MAAM,MAEpB,EAAU,2BACV,EAAO,OACP,EAAW,GAAS,KAAM,GAAO,EAAG,KAAO,QAAQ,IAAM,QACzD,EAAO,GAAG,EAAQ,GAAG,EAAK,QAAQ,IAClC,EAAS,uFAAuF,EAAS,oBAIzG,EAAU,MAAMC,IAChB,EAAO,MAAM,EAAQ,UAG3B,MAAM,EAAK,uBAAuB,IAElC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,WAAa,EAAQ,WAAa,EAAQ,UAIzE,IAAI,EACJ,EAAK,GAAG,WAAY,KAAO,IAAQ,CAC/B,EAAO,MAAM,EAAI,SAIrB,EAAO,KAAK,cAAc,KAC1B,MAAM,EAAK,KAAK,EAAQ,CACpB,UAAW,iBAGf,MAAM,EAAK,QACX,MAAM,EAAQ,QAEd,GAAM,CAAE,SAAU,GAAS,EACrB,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,UAAa,CAC3B,MAAO,EAAK,MACZ,KAAM,GAAG,EAAQ,GAAG,EAAK,GAAG,EAAK,KAAK,QAAQ,IAC9C,QAAS,EAAU,EAAK,MACxB,OAAQ,EAAK,OACb,YAAa,EAAK,aAK9B,MAAO,CACH,MAAO,gBACP,OACA,KAAM"}