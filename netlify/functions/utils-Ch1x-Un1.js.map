{"version":3,"file":"utils-Ch1x-Un1.js","names":[],"sources":["../../lib/routes/aeon/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { config } from '@/config';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const getBuildId = () =>\r\n    cache.tryGet(\r\n        'aeon:buildId',\r\n        async () => {\r\n            const response = await ofetch('https://aeon.co');\r\n            const $ = load(response);\r\n            const nextData = JSON.parse($('script#__NEXT_DATA__').text());\r\n            return nextData.buildId;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\nconst getData = async (list) => {\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const buildId = await getBuildId();\r\n                const response = await ofetch(`https://aeon.co/_next/data/${buildId}/${item.type}s/${item.slug}.json?id=${item.slug}`);\r\n\r\n                const data = response.pageProps.article;\r\n                const type = data.type.toLowerCase();\r\n\r\n                item.pubDate = parseDate(data.publishedAt);\r\n\r\n                if (type === 'video') {\r\n                    item.description = art(path.join(__dirname, 'templates/video.art'), { article: data });\r\n                } else {\r\n                    if (data.audio?.id) {\r\n                        const response = await ofetch('https://api.aeonmedia.co/graphql', {\r\n                            method: 'POST',\r\n                            body: {\r\n                                query: `query getAudio($audioId: ID!) {\r\n                                    audio(id: $audioId) {\r\n                                        id\r\n                                        streamUrl\r\n                                    }\r\n                                }`,\r\n                                variables: {\r\n                                    audioId: data.audio.id,\r\n                                },\r\n                                operationName: 'getAudio',\r\n                            },\r\n                        });\r\n\r\n                        delete item.image;\r\n                        item.enclosure_url = response.data.audio.streamUrl;\r\n                        item.enclosure_type = 'audio/mpeg';\r\n                    }\r\n\r\n                    // Besides, it seems that the method based on __NEXT_DATA__\r\n                    // does not include the information of the two-column\r\n                    // images in the article body,\r\n                    // e.g. https://aeon.co/essays/how-to-mourn-a-forest-a-lesson-from-west-papua .\r\n                    // But that's very rare.\r\n\r\n                    const capture = load(data.body, null, false);\r\n                    const banner = data.image;\r\n                    capture('p.pullquote').remove();\r\n\r\n                    const authorsBio = data.authors.map((author) => '<p>' + author.name + author.authorBio.replaceAll(/^<p>/g, ' ')).join('');\r\n\r\n                    item.description = art(path.join(__dirname, 'templates/essay.art'), { banner, authorsBio, content: capture.html() });\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return items;\r\n};\r\n\r\nexport { getData };\r\n"],"mappings":"4XAQA,MAAa,MACT,EAAM,OACF,eACA,SAAY,CACR,IAAM,EAAW,MAAM,EAAO,mBACxB,EAAI,EAAK,GACT,EAAW,KAAK,MAAM,EAAE,wBAAwB,QACtD,OAAO,EAAS,SAEpB,EAAO,MAAM,YACb,IAGF,EAAU,KAAO,IAAS,CAC5B,IAAM,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAU,MAAM,IAChB,EAAW,MAAM,EAAO,8BAA8B,EAAQ,GAAG,EAAK,KAAK,IAAI,EAAK,KAAK,WAAW,EAAK,QAEzG,EAAO,EAAS,UAAU,QAC1B,EAAO,EAAK,KAAK,cAIvB,GAFA,EAAK,QAAU,EAAU,EAAK,aAE1B,IAAS,QACT,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAAE,QAAS,QAC5E,CACH,GAAI,EAAK,OAAO,GAAI,CAChB,IAAM,EAAW,MAAM,EAAO,mCAAoC,CAC9D,OAAQ,OACR,KAAM,CACF,MAAO;;;;;mCAMP,UAAW,CACP,QAAS,EAAK,MAAM,IAExB,cAAe,cAIvB,OAAO,EAAK,MACZ,EAAK,cAAgB,EAAS,KAAK,MAAM,UACzC,EAAK,eAAiB,aAS1B,IAAM,EAAU,EAAK,EAAK,KAAM,KAAM,IAChC,EAAS,EAAK,MACpB,EAAQ,eAAe,SAEvB,IAAM,EAAa,EAAK,QAAQ,IAAK,GAAW,MAAQ,EAAO,KAAO,EAAO,UAAU,WAAW,QAAS,MAAM,KAAK,IAEtH,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAAE,SAAQ,aAAY,QAAS,EAAQ,SAG/G,OAAO,MAKnB,OAAO"}