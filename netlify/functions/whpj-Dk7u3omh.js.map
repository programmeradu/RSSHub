{"version":3,"file":"whpj-Dk7u3omh.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/cib/whpj.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport https from 'node:https';\r\nimport crypto from 'node:crypto';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/whpj/:format?',\r\n    categories: ['other'],\r\n    example: '/cib/whpj/xh?filter_title=USD',\r\n    parameters: { format: '输出的标题格式，默认为标题 + 所有价格。短格式仅包含货币名称。' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['cib.com.cn/'],\r\n            target: '/whpj',\r\n        },\r\n    ],\r\n    name: '外汇牌价',\r\n    maintainers: ['Qixingchen'],\r\n    handler,\r\n    url: 'cib.com.cn/',\r\n    description: `| 短格式 | 现汇买卖 | 现钞买卖 | 现汇买入 | 现汇卖出 | 现钞买入 | 现钞卖出 |\r\n| ------ | -------- | -------- | -------- | -------- | -------- | -------- |\r\n| short  | xh       | xc       | xhmr     | xhmc     | xcmr     | xcmc     |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    // fix unsafe legacy renegotiation disabled\r\n    const agent = new https.Agent({\r\n        secureOptions: crypto.constants.SSL_OP_LEGACY_SERVER_CONNECT,\r\n    });\r\n\r\n    const response = await got('https://personalbank.cib.com.cn/pers/main/pubinfo/ifxQuotationQuery.do', { agent: { https: agent } });\r\n    const cookies = response.headers['set-cookie'].map((item) => item.split(';')[0]).join(';');\r\n\r\n    const $ = load(response.data);\r\n    let date = $('div.main-body').find('div.labe_text').text();\r\n    date = date.split('\\n\\t')[1].replace('日期：', '').trim();\r\n    date = date.slice(0, 11) + date.slice(15);\r\n\r\n    const link = 'https://personalbank.cib.com.cn/pers/main/pubinfo/ifxQuotationQuery/list?_search=false&dataSet.rows=80&dataSet.page=1&dataSet.sidx=&dataSet.sord=asc';\r\n    const data = await cache.tryGet(\r\n        link,\r\n        async () => {\r\n            const detailResponse = await got(link, {\r\n                headers: {\r\n                    Cookie: cookies,\r\n                },\r\n                agent: { https: agent },\r\n            });\r\n            return detailResponse.data;\r\n        },\r\n        config.cache.contentExpire,\r\n        false\r\n    );\r\n\r\n    const format = ctx.req.param('format');\r\n\r\n    return {\r\n        title: '中国兴业银行外汇牌价',\r\n        link: 'https://personalbank.cib.com.cn/pers/main/pubinfo/ifxQuotationQuery.do',\r\n        item: data.rows.map((item) => {\r\n            const name = `${item.cell[0]} ${item.cell[1]}`;\r\n\r\n            const xhmr = `现汇买入价：${item.cell[3]}`;\r\n\r\n            const xcmr = `现钞买入价：${item.cell[5]}`;\r\n\r\n            const xhmc = `现汇卖出价：${item.cell[4]}`;\r\n\r\n            const xcmc = `现钞卖出价：${item.cell[6]}`;\r\n\r\n            const content = `${xhmr} ${xcmr} ${xhmc} ${xcmc}`;\r\n\r\n            return {\r\n                title: formatTitle(name, xhmr, xcmr, xhmc, xcmc, content, format),\r\n                pubDate: parseDate(date, 'YYYY年MM月DD日 HH:mm:ss'),\r\n                description: content.replaceAll(/\\s/g, '<br>'),\r\n                guid: `${item.cell[0]} ${item.cell[1]} ${date}`,\r\n            };\r\n        }),\r\n    };\r\n}\r\n\r\nfunction formatTitle(name, xhmr, xcmr, xhmc, xcmc, content, format) {\r\n    switch (format) {\r\n        case 'short':\r\n            return name;\r\n        case 'xh':\r\n            return `${name} ${xhmr} ${xhmc}`;\r\n        case 'xc':\r\n            return `${name} ${xcmr} ${xcmc}`;\r\n        case 'xhmr':\r\n            return `${name} ${xhmr}`;\r\n        case 'xhmc':\r\n            return `${name} ${xhmc}`;\r\n        case 'xcmr':\r\n            return `${name} ${xcmr}`;\r\n        case 'xcmc':\r\n            return `${name} ${xcmc}`;\r\n        default:\r\n            return `${name} ${content}`;\r\n    }\r\n}\r\n"],"mappings":"8aASA,MAAaA,EAAe,CACxB,KAAM,iBACN,WAAY,CAAC,SACb,QAAS,gCACT,WAAY,CAAE,OAAQ,oCACtB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,eACT,OAAQ,UAGhB,KAAM,OACN,YAAa,CAAC,cACd,UACA,IAAK,cACL,YAAa;;+EAKjB,eAAe,EAAQ,EAAK,CAExB,IAAM,EAAQ,IAAI,EAAM,MAAM,CAC1B,cAAe,EAAO,UAAU,+BAG9B,EAAW,MAAMC,EAAI,yEAA0E,CAAE,MAAO,CAAE,MAAO,KACjH,EAAU,EAAS,QAAQ,cAAc,IAAK,GAAS,EAAK,MAAM,KAAK,IAAI,KAAK,KAEhF,EAAI,EAAK,EAAS,MACpB,EAAO,EAAE,iBAAiB,KAAK,iBAAiB,OACpD,EAAO,EAAK,MAAM;IAAQ,GAAG,QAAQ,MAAO,IAAI,OAChD,EAAO,EAAK,MAAM,EAAG,IAAM,EAAK,MAAM,IAEtC,IAAM,EAAO,uJACP,EAAO,MAAMC,EAAM,OACrB,EACA,SAAY,CACR,IAAM,EAAiB,MAAMD,EAAI,EAAM,CACnC,QAAS,CACL,OAAQ,GAEZ,MAAO,CAAE,MAAO,KAEpB,OAAO,EAAe,MAE1B,EAAO,MAAM,cACb,IAGE,EAAS,EAAI,IAAI,MAAM,UAE7B,MAAO,CACH,MAAO,aACP,KAAM,yEACN,KAAM,EAAK,KAAK,IAAK,GAAS,CAC1B,IAAM,EAAO,GAAG,EAAK,KAAK,GAAG,GAAG,EAAK,KAAK,KAEpC,EAAO,SAAS,EAAK,KAAK,KAE1B,EAAO,SAAS,EAAK,KAAK,KAE1B,EAAO,SAAS,EAAK,KAAK,KAE1B,EAAO,SAAS,EAAK,KAAK,KAE1B,EAAU,GAAG,EAAK,GAAG,EAAK,GAAG,EAAK,GAAG,IAE3C,MAAO,CACH,MAAO,EAAY,EAAM,EAAM,EAAM,EAAM,EAAM,EAAS,GAC1D,QAAS,EAAU,EAAM,wBACzB,YAAa,EAAQ,WAAW,MAAO,QACvC,KAAM,GAAG,EAAK,KAAK,GAAG,GAAG,EAAK,KAAK,GAAG,GAAG,QAMzD,SAAS,EAAY,EAAM,EAAM,EAAM,EAAM,EAAM,EAAS,EAAQ,CAChE,OAAQ,EAAR,CACI,IAAK,QACD,OAAO,EACX,IAAK,KACD,MAAO,GAAG,EAAK,GAAG,EAAK,GAAG,IAC9B,IAAK,KACD,MAAO,GAAG,EAAK,GAAG,EAAK,GAAG,IAC9B,IAAK,OACD,MAAO,GAAG,EAAK,GAAG,IACtB,IAAK,OACD,MAAO,GAAG,EAAK,GAAG,IACtB,IAAK,OACD,MAAO,GAAG,EAAK,GAAG,IACtB,IAAK,OACD,MAAO,GAAG,EAAK,GAAG,IACtB,QACI,MAAO,GAAG,EAAK,GAAG"}