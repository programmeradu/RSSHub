{"version":3,"file":"mittrchina-YbvhqBow.js","names":[],"sources":["../../lib/routes/mittrchina/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/:type?',\r\n    categories: ['new-media'],\r\n    example: '/mittrchina/index',\r\n    parameters: { type: '类型，见下表，默认为首页资讯' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '首页',\r\n    maintainers: ['EsuRt', 'queensferryme'],\r\n    handler,\r\n    description: `| 快讯     | 本周热文 | 首页资讯 | 视频  |\r\n| -------- | -------- | -------- | ----- |\r\n| breaking | hot      | index    | video |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const typeMap = {\r\n        breaking: {\r\n            title: '快讯',\r\n            apiPath: '/flash',\r\n        },\r\n        hot: {\r\n            title: '本周热榜',\r\n            apiPath: '/information/hot',\r\n        },\r\n        index: {\r\n            title: '首页资讯',\r\n            apiPath: '/information/index',\r\n        },\r\n        video: {\r\n            title: '视频',\r\n            apiPath: '/movie/index',\r\n        },\r\n    };\r\n\r\n    const { type = 'index' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 10;\r\n\r\n    const link = `https://apii.web.mittrchina.com${typeMap[type].apiPath}`;\r\n    const { data: response } =\r\n        type === 'breaking'\r\n            ? await got.post(link, {\r\n                  form: {\r\n                      page: 1,\r\n                      size: limit,\r\n                  },\r\n              })\r\n            : await got(link, {\r\n                  searchParams: {\r\n                      limit,\r\n                  },\r\n              });\r\n\r\n    const articles = type === 'hot' ? response.data : response.data.items;\r\n\r\n    const list = articles.map((article) => ({\r\n        title: article.name || article.title,\r\n        author: (article.authors || article.author || []).map((author) => author.username).join(', '),\r\n        category: article.typeName,\r\n        description:\r\n            type === 'video'\r\n                ? art(path.join(__dirname, 'templates/movie.art'), {\r\n                      poster: article.img,\r\n                      video: {\r\n                          address: article.address,\r\n                          type: article.address.split('.').pop(),\r\n                      },\r\n                  })\r\n                : type === 'breaking'\r\n                  ? article.content\r\n                  : article.summary,\r\n        pubDate: article.start_time ? parseDate(article.start_time, 'X') : article.push_time ? parseDate(article.push_time, 'X') : undefined,\r\n        id: article.id,\r\n        link: `https://www.mittrchina.com/news/detail/${article.id}`,\r\n    }));\r\n\r\n    let items = list;\r\n    if (type !== 'video' && type !== 'breaking') {\r\n        items = await Promise.all(\r\n            list.map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const {\r\n                        data: { data: details },\r\n                    } = await got(`https://apii.web.mittrchina.com/information/details?id=${item.id}`);\r\n\r\n                    item.description = details.content;\r\n\r\n                    if (!item.author) {\r\n                        item.author = details.authors.map((a) => a.username).join(', ');\r\n                    }\r\n                    if (!item.pubDate) {\r\n                        item.pubDate = parseDate(details.start_time, 'X');\r\n                    }\r\n\r\n                    if (details.cover) {\r\n                        item.enclosure_url = details.cover;\r\n                        item.enclosure_type = `image/${details.cover.split('.').pop()}`;\r\n                    }\r\n\r\n                    return item;\r\n                })\r\n            )\r\n        );\r\n    }\r\n\r\n    return {\r\n        title: `MIT 科技评论 - ${typeMap[type].title}`,\r\n        link: `https://www.mittrchina.com/${type}`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ybAQA,MAAa,EAAe,CACxB,KAAM,UACN,WAAY,CAAC,aACb,QAAS,oBACT,WAAY,CAAE,KAAM,kBACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,QAAS,iBACvB,UACA,YAAa;;6CAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,CACZ,SAAU,CACN,MAAO,KACP,QAAS,UAEb,IAAK,CACD,MAAO,OACP,QAAS,oBAEb,MAAO,CACH,MAAO,OACP,QAAS,sBAEb,MAAO,CACH,MAAO,KACP,QAAS,iBAIX,CAAE,OAAO,SAAY,EAAI,IAAI,QAC7B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAO,kCAAkC,EAAQ,GAAM,UACvD,CAAE,KAAM,GACV,IAAS,WACH,MAAM,EAAI,KAAK,EAAM,CACjB,KAAM,CACF,KAAM,EACN,KAAM,KAGd,MAAM,EAAI,EAAM,CACZ,aAAc,CACV,WAIZ,EAAW,IAAS,MAAQ,EAAS,KAAO,EAAS,KAAK,MAE1D,EAAO,EAAS,IAAK,IAAa,CACpC,MAAO,EAAQ,MAAQ,EAAQ,MAC/B,QAAS,EAAQ,SAAW,EAAQ,QAAU,IAAI,IAAK,GAAW,EAAO,UAAU,KAAK,MACxF,SAAU,EAAQ,SAClB,YACI,IAAS,QACH,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAC7C,OAAQ,EAAQ,IAChB,MAAO,CACH,QAAS,EAAQ,QACjB,KAAM,EAAQ,QAAQ,MAAM,KAAK,SAGzC,IAAS,WACP,EAAQ,QACR,EAAQ,QACpB,QAAS,EAAQ,WAAa,EAAU,EAAQ,WAAY,KAAO,EAAQ,UAAY,EAAU,EAAQ,UAAW,KAAO,IAAA,GAC3H,GAAI,EAAQ,GACZ,KAAM,0CAA0C,EAAQ,QAGxD,EAAQ,EA6BZ,OA5BI,IAAS,SAAW,IAAS,aAC7B,EAAQ,MAAM,QAAQ,IAClB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CACF,KAAM,CAAE,KAAM,IACd,MAAM,EAAI,0DAA0D,EAAK,MAgB7E,MAdA,GAAK,YAAc,EAAQ,QAEtB,EAAK,SACN,EAAK,OAAS,EAAQ,QAAQ,IAAK,GAAM,EAAE,UAAU,KAAK,OAEzD,EAAK,UACN,EAAK,QAAU,EAAU,EAAQ,WAAY,MAG7C,EAAQ,QACR,EAAK,cAAgB,EAAQ,MAC7B,EAAK,eAAiB,SAAS,EAAQ,MAAM,MAAM,KAAK,SAGrD,OAMhB,CACH,MAAO,cAAc,EAAQ,GAAM,QACnC,KAAM,8BAA8B,IACpC,KAAM"}