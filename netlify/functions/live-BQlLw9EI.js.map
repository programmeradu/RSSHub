{"version":3,"file":"live-BQlLw9EI.js","names":["route: Route","InvalidParameterError","cache","roomInfo","puppeteer"],"sources":["../../lib/routes/douyin/live.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\nimport { getOriginAvatar } from './utils';\r\nimport logger from '@/utils/logger';\r\nimport puppeteer from '@/utils/puppeteer';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/live/:rid',\r\n    categories: ['live'],\r\n    example: '/douyin/live/685317364746',\r\n    parameters: { rid: '直播间 id, 可在主播直播间页 URL 中找到' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['live.douyin.com/:rid'],\r\n        },\r\n    ],\r\n    name: '直播间开播',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const rid = ctx.req.param('rid');\r\n    if (Number.isNaN(rid)) {\r\n        throw new InvalidParameterError('Invalid room ID. Room ID should be a number.');\r\n    }\r\n\r\n    const pageUrl = `https://live.douyin.com/${rid}`;\r\n\r\n    const renderData = await cache.tryGet(\r\n        `douyin:live:${rid}`,\r\n        async () => {\r\n            let roomInfo;\r\n            const browser = await puppeteer();\r\n            const page = await browser.newPage();\r\n            await page.setRequestInterception(true);\r\n\r\n            page.on('request', (request) => {\r\n                request.resourceType() === 'document' || request.resourceType() === 'stylesheet' || request.resourceType() === 'script' || request.resourceType() === 'xhr' ? request.continue() : request.abort();\r\n            });\r\n            page.on('response', async (response) => {\r\n                const request = response.request();\r\n                if (request.url().includes('/webcast/room/web/enter')) {\r\n                    roomInfo = await response.json();\r\n                }\r\n            });\r\n            logger.http(`Requesting ${pageUrl}`);\r\n            await page.goto(pageUrl, {\r\n                waitUntil: 'networkidle2',\r\n            });\r\n            await browser.close();\r\n\r\n            return roomInfo;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    if (renderData.status_code !== 0) {\r\n        throw new Error(`Status code ${renderData.status_code}`);\r\n    }\r\n\r\n    const roomInfo = renderData.data.data[0];\r\n    const roomOwner = renderData.data.user;\r\n    const nickname = roomOwner.nickname;\r\n    const userAvatar = roomOwner.avatar_thumb.url_list[0];\r\n\r\n    const items = [];\r\n    if (roomInfo.id_str) {\r\n        if (roomInfo.status === 2) {\r\n            items.push({\r\n                title: `开播：${roomInfo.title}`,\r\n                description: `<img src=\"${roomInfo.cover.url_list[0]}\">`,\r\n                link: pageUrl,\r\n                author: nickname,\r\n                guid: roomInfo.id_str, // roomId is unique for each live event\r\n            });\r\n        } else if (roomInfo.status === 4) {\r\n            items.push({\r\n                title: `当前直播已结束，期待下一场：${roomInfo.title}`,\r\n                link: `https://www.douyin.com/user/${roomOwner.sec_uid}`,\r\n                author: nickname,\r\n                guid: roomInfo.id_str,\r\n            });\r\n        }\r\n    }\r\n\r\n    return {\r\n        title: `${nickname}的抖音直播间 - 抖音直播`,\r\n        description: `欢迎来到${nickname}的抖音直播间，${nickname}与大家一起记录美好生活 - 抖音直播`,\r\n        image: getOriginAvatar(userAvatar),\r\n        link: pageUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"kZAQA,MAAaA,EAAe,CACxB,KAAM,aACN,WAAY,CAAC,QACb,QAAS,4BACT,WAAY,CAAE,IAAK,4BACnB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,0BAGjB,KAAM,QACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAM,EAAI,IAAI,MAAM,OAC1B,GAAI,OAAO,MAAM,GACb,MAAM,IAAIC,EAAsB,gDAGpC,IAAM,EAAU,2BAA2B,IAErC,EAAa,MAAMC,EAAM,OAC3B,eAAe,IACf,SAAY,CACR,IAAIC,EACE,EAAU,MAAMC,IAChB,EAAO,MAAM,EAAQ,UAkB3B,OAjBA,MAAM,EAAK,uBAAuB,IAElC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,cAAgB,EAAQ,iBAAmB,UAAY,EAAQ,iBAAmB,MAAQ,EAAQ,WAAa,EAAQ,UAE/L,EAAK,GAAG,WAAY,KAAO,IAAa,CACpC,IAAM,EAAU,EAAS,UACrB,EAAQ,MAAM,SAAS,6BACvB,EAAW,MAAM,EAAS,UAGlC,EAAO,KAAK,cAAc,KAC1B,MAAM,EAAK,KAAK,EAAS,CACrB,UAAW,iBAEf,MAAM,EAAQ,QAEPD,GAEX,EAAO,MAAM,YACb,IAGJ,GAAI,EAAW,cAAgB,EAC3B,MAAU,MAAM,eAAe,EAAW,eAG9C,IAAM,EAAW,EAAW,KAAK,KAAK,GAChC,EAAY,EAAW,KAAK,KAC5B,EAAW,EAAU,SACrB,EAAa,EAAU,aAAa,SAAS,GAE7C,EAAQ,GAoBd,OAnBI,EAAS,SACL,EAAS,SAAW,EACpB,EAAM,KAAK,CACP,MAAO,MAAM,EAAS,QACtB,YAAa,aAAa,EAAS,MAAM,SAAS,GAAG,IACrD,KAAM,EACN,OAAQ,EACR,KAAM,EAAS,SAEZ,EAAS,SAAW,GAC3B,EAAM,KAAK,CACP,MAAO,iBAAiB,EAAS,QACjC,KAAM,+BAA+B,EAAU,UAC/C,OAAQ,EACR,KAAM,EAAS,UAKpB,CACH,MAAO,GAAG,EAAS,eACnB,YAAa,OAAO,EAAS,SAAS,EAAS,oBAC/C,MAAO,EAAgB,GACvB,KAAM,EACN,KAAM,EACN,WAAY"}