{"version":3,"file":"app-RI_GIngP.js","names":[],"sources":["../../lib/routes/theinitium/app.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load, type CheerioAPI } from 'cheerio';\r\nimport type { Element } from 'domhandler';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { config } from '@/config';\r\n\r\nconst appUrl = 'https://app.theinitium.com/';\r\nconst userAgent = 'PugpigBolt v4.1.8 (iPhone, iOS 18.2.1) on phone (model iPhone15,2)';\r\n\r\nexport const route: Route = {\r\n    path: '/app/:category?',\r\n    categories: ['new-media'],\r\n    example: '/theinitium/app',\r\n    parameters: {\r\n        category: 'Category, see below, latest_sc by default',\r\n    },\r\n    features: {\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'App',\r\n    maintainers: ['quiniapiezoelectricity'],\r\n    radar: [\r\n        {\r\n            source: ['app.theinitium.com/t/latest/:category'],\r\n            target: '/app/:category',\r\n        },\r\n    ],\r\n    handler,\r\n    description: `抓取[The Initium App](https://app.theinitium.com/)的文章列表\r\n\r\n::: warning\r\n此路由暂不支持登陆认证\r\n:::\r\n\r\nCategory 栏目：\r\n\r\n| ----- | 简体中文     | 繁體中文      |\r\n| ----- | ----------------- | ---------------- |\r\n| 最新   | latest_sc | latest_tc |\r\n| 日报   | daily_brief_sc | daily_brief_tc |\r\n| 速递   | whats_new_sc | whats_new_tc |\r\n| 专题   | report_sc | report_tc |\r\n| 评论   | opinion_sc | opinion_tc |\r\n| 国际   | international_sc | international_tc |\r\n| 大陆   | mainland_sc | mainland_tc |\r\n| 香港   | hongkong_sc | hongkong_tc |\r\n| 台湾   | taiwan_sc | taiwan_tc |\r\n| 播客   | article_audio_sc | article_audio_tc |`,\r\n};\r\n\r\nconst resolveRelativeLink = ($: CheerioAPI, elem: Element, attr: string, appUrl?: string) => {\r\n    // code from @/middleware/paratmeter.ts\r\n    const $elem = $(elem);\r\n\r\n    if (appUrl) {\r\n        try {\r\n            const oldAttr = $elem.attr(attr);\r\n            if (oldAttr) {\r\n                // e.g. <video><source src=\"https://example.com\"></video> should leave <video> unchanged\r\n                $elem.attr(attr, new URL(oldAttr, appUrl).href);\r\n            }\r\n        } catch {\r\n            // no-empty\r\n        }\r\n    }\r\n};\r\n\r\nasync function getUA(url: string) {\r\n    return await got({\r\n        method: 'get',\r\n        url,\r\n        headers: {\r\n            'User-Agent': userAgent,\r\n        },\r\n    });\r\n}\r\n\r\nasync function fetchAppPage(url: URL) {\r\n    const response = await getUA(url.href);\r\n    const $ = load(response.data);\r\n    // resolve relative links with app.theinitium.com\r\n    // code from @/middleware/paratmeter.ts\r\n    $('a, area').each((_, elem) => {\r\n        resolveRelativeLink($, elem, 'href', appUrl);\r\n        // $(elem).attr('rel', 'noreferrer');  // currently no such a need\r\n    });\r\n    // https://www.w3schools.com/tags/att_src.asp\r\n    $('img, video, audio, source, iframe, embed, track').each((_, elem) => {\r\n        resolveRelativeLink($, elem, 'src', appUrl);\r\n        $(elem).removeAttr('srcset');\r\n    });\r\n    $('video[poster]').each((_, elem) => {\r\n        resolveRelativeLink($, elem, 'poster', appUrl);\r\n    });\r\n    const article = $('.pp-article__body');\r\n    article.find('.block-related-articles').remove();\r\n    article.find('.copyright').wrapInner('<small></small>').wrapInner('<figure></figure>');\r\n    article.find('figure.wp-block-pullquote').children().unwrap();\r\n    article.find('div.block-explanation-note').wrapInner('<blockquote></blockquote>');\r\n    article.find('div.wp-block-tcc-author-note').wrapInner('<em></em>').after('<hr>');\r\n    article.find('p.has-small-font-size').wrapInner('<small></small>');\r\n    return art(path.join(__dirname, 'templates/description.art'), {\r\n        standfirst: $('.pp-header-group__standfirst').html(),\r\n        coverImage: $('.pp-media__image').attr('src'),\r\n        coverCaption: $('.pp-media__caption').html(),\r\n        article: article.html(),\r\n    });\r\n}\r\n\r\nasync function fetchWebPage(url: URL) {\r\n    const response = await got(url.href);\r\n    const $ = load(response.data);\r\n    const article = $('.entry-content');\r\n    article.find('.block-related-articles').remove();\r\n    article.find('.cta-subscription').remove();\r\n    article.find('.entry-copyright').wrapInner('<small></small>').wrapInner('<figure></figure>');\r\n    article.find('figure.wp-block-pullquote').children().unwrap();\r\n    article.find('div.block-explanation-note').wrapInner('<blockquote></blockquote>');\r\n    article.find('div.wp-block-tcc-author-note').wrapInner('<em></em>').after('<hr>');\r\n    article.find('p.has-small-font-size').wrapInner('<small></small>');\r\n    return art(path.join(__dirname, 'templates/description.art'), {\r\n        standfirst: $('span.caption1').html(),\r\n        coverImage: $('.wp-post-image').attr('src'),\r\n        coverCaption: $('.image-caption').html(),\r\n        article: article.html(),\r\n    });\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category') ?? 'latest_sc';\r\n\r\n    const feeds = await cache.tryGet(new URL('timelines.json', appUrl).href, async () => await getUA(new URL('timelines.json', appUrl).href), config.cache.routeExpire, false);\r\n    const metadata = feeds.data.timelines.find((timeline) => timeline.id === category);\r\n    const response = await getUA(new URL(metadata.feed, appUrl).href);\r\n    const feed = response.data.stories.filter((item) => item.type === 'article');\r\n\r\n    const items = await Promise.all(\r\n        feed.map((item) =>\r\n            cache.tryGet(item.shareurl, async () => {\r\n                const url = new URL(item.shareurl);\r\n                item.link = url.href;\r\n                item.description = item.summary;\r\n                item.pubDate = item.published;\r\n                item.category = [];\r\n                if (item.section) {\r\n                    item.category = [...item.category, item.section];\r\n                }\r\n                if (item.taxonomy) {\r\n                    if (item.taxonomy.collection_tag) {\r\n                        item.category = [...item.category, ...item.taxonomy.collection_tag];\r\n                    }\r\n                    if (item.taxonomy.sections) {\r\n                        item.category = [...item.category, ...item.taxonomy.sections];\r\n                    }\r\n                }\r\n                item.category = [...new Set(item.category)];\r\n                switch (url.hostname) {\r\n                    case 'app.theinitium.com':\r\n                        item.description = await fetchAppPage(url);\r\n                        break;\r\n                    case 'theinitium.com':\r\n                        item.description = await fetchWebPage(url);\r\n                        break;\r\n                    default:\r\n                        break;\r\n                }\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    let lang = 'zh-hans';\r\n    let name = '端传媒';\r\n    if (metadata.timeline_sets[0] === 'chinese-traditional') {\r\n        lang = 'zh-hant';\r\n        name = '端傳媒';\r\n    }\r\n\r\n    return {\r\n        title: `${name} - ${metadata.title}`,\r\n        link: `https://app.theinitium.com/t/latest/${category}/`,\r\n        language: lang,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}