{"version":3,"file":"utils-BbwiFSn2.js","names":["cookie","cache","ofetch"],"sources":["../../lib/routes/cw/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { getCookies, setCookies } from '@/utils/puppeteer-utils';\r\nimport logger from '@/utils/logger';\r\nlet cookie;\r\nimport ofetch from '@/utils/ofetch';\r\n\r\nconst baseUrl = 'https://www.cw.com.tw';\r\n\r\nconst pathMap = {\r\n    today: {\r\n        pageUrl: () => '/today',\r\n        limit: 30,\r\n    },\r\n    master: {\r\n        pageUrl: (channel) => `/masterChannel.action?idMasterChannel=${channel}`,\r\n        limit: 12,\r\n    },\r\n    sub: {\r\n        pageUrl: (channel) => `/subchannel.action?idSubChannel=${channel}`,\r\n        limit: 12,\r\n    },\r\n    author: {\r\n        pageUrl: (channel) => `/author/${channel}`,\r\n        limit: 10,\r\n    },\r\n};\r\n\r\nconst getCookie = async (browser, tryGet) => {\r\n    if (!cookie) {\r\n        cookie = await tryGet('cw:cookie', async () => {\r\n            const page = await browser.newPage();\r\n            await page.setRequestInterception(true);\r\n            page.on('request', (request) => {\r\n                request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n            });\r\n            logger.http(`Requesting ${baseUrl}/user/get/cookie-bar`);\r\n            await page.goto(`${baseUrl}/user/get/cookie-bar`, {\r\n                waitUntil: 'domcontentloaded',\r\n            });\r\n            cookie = await getCookies(page);\r\n            await page.close();\r\n            return cookie;\r\n        });\r\n    }\r\n    return cookie;\r\n};\r\n\r\nconst parsePage = async (path, browser, ctx) => {\r\n    const pageUrl = `${baseUrl}${pathMap[path].pageUrl(ctx.req.param('channel'))}`;\r\n\r\n    const cookie = await getCookie(browser, cache.tryGet);\r\n    const page = await browser.newPage();\r\n    await page.setRequestInterception(true);\r\n    page.on('request', (request) => {\r\n        request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n    });\r\n    await setCookies(page, cookie, 'cw.com.tw');\r\n    logger.http(`Requesting ${pageUrl}`);\r\n    await page.goto(pageUrl, {\r\n        waitUntil: 'domcontentloaded',\r\n    });\r\n\r\n    await page.waitForSelector('.caption');\r\n    const response = await page.evaluate(() => document.documentElement.innerHTML);\r\n    await page.close();\r\n    const $ = load(response);\r\n\r\n    const list = parseList($, ctx.req.query('limit') ? Number(ctx.req.query('limit')) : pathMap[path].limit);\r\n    const items = await parseItems(list, browser, cache.tryGet);\r\n\r\n    return { $, items };\r\n};\r\n\r\nconst parseList = ($, limit) =>\r\n    $('.caption')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.find('h3').text(),\r\n                link: item.find('h3 a').attr('href'),\r\n                pubDate: parseDate(item.find('time').text()),\r\n            };\r\n        })\r\n        .slice(0, limit);\r\n\r\nconst parseItems = (list, browser, tryGet) =>\r\n    Promise.all(\r\n        list.map((item) =>\r\n            tryGet(item.link, async () => {\r\n                const response = await ofetch(item.link, {\r\n                    headers: {\r\n                        Cookie: await getCookie(browser, tryGet),\r\n                        'User-Agent': browser.userAgent(),\r\n                    },\r\n                });\r\n                const $ = load(response);\r\n\r\n                const meta = JSON.parse($('head script[type=\"application/ld+json\"]').eq(0).text());\r\n                $('.article__head .breadcrumb, .article__head h1, .article__provideViews, .ad').remove();\r\n                $('img.lazyload').each((_, img) => {\r\n                    if (img.attribs['data-src']) {\r\n                        img.attribs.src = img.attribs['data-src'];\r\n                        delete img.attribs['data-src'];\r\n                    }\r\n                });\r\n\r\n                item.title = $('head title').text();\r\n                item.category = $('meta[name=keywords]').attr('content').split(',');\r\n                item.pubDate = parseDate(meta.datePublished);\r\n                item.author = meta.author.name.replace(',', ' ') || meta.publisher.name;\r\n                item.description = $('.article__head .container').html() + $('.article__content').html();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\nexport { baseUrl, pathMap, getCookie, parsePage, parseList, parseItems };\r\n\r\nexport { setCookies } from '@/utils/puppeteer-utils';\r\n"],"mappings":"+TAKA,IAAI,EAGJ,MAAM,EAAU,wBAEV,EAAU,CACZ,MAAO,CACH,YAAe,SACf,MAAO,IAEX,OAAQ,CACJ,QAAU,GAAY,yCAAyC,IAC/D,MAAO,IAEX,IAAK,CACD,QAAU,GAAY,mCAAmC,IACzD,MAAO,IAEX,OAAQ,CACJ,QAAU,GAAY,WAAW,IACjC,MAAO,KAIT,EAAY,MAAO,EAAS,KACzB,IACD,EAAS,MAAM,EAAO,YAAa,SAAY,CAC3C,IAAM,EAAO,MAAM,EAAQ,UAW3B,OAVA,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,EAAO,KAAK,cAAc,EAAQ,uBAClC,MAAM,EAAK,KAAK,GAAG,EAAQ,sBAAuB,CAC9C,UAAW,qBAEf,EAAS,MAAM,EAAW,GAC1B,MAAM,EAAK,QACJ,KAGR,GAGL,EAAY,MAAO,EAAM,EAAS,IAAQ,CAC5C,IAAM,EAAU,GAAG,IAAU,EAAQ,GAAM,QAAQ,EAAI,IAAI,MAAM,cAE3DA,EAAS,MAAM,EAAU,EAASC,EAAM,QACxC,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,MAAM,EAAW,EAAMD,EAAQ,aAC/B,EAAO,KAAK,cAAc,KAC1B,MAAM,EAAK,KAAK,EAAS,CACrB,UAAW,qBAGf,MAAM,EAAK,gBAAgB,YAC3B,IAAM,EAAW,MAAM,EAAK,aAAe,SAAS,gBAAgB,WACpE,MAAM,EAAK,QACX,IAAM,EAAI,EAAK,GAET,EAAO,EAAU,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,EAAI,IAAI,MAAM,UAAY,EAAQ,GAAM,OAC5F,EAAQ,MAAM,EAAW,EAAM,EAASC,EAAM,QAEpD,MAAO,CAAE,IAAG,UAGV,GAAa,EAAG,IAClB,EAAE,YACG,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,KAAK,MAAM,OACvB,KAAM,EAAK,KAAK,QAAQ,KAAK,QAC7B,QAAS,EAAU,EAAK,KAAK,QAAQ,WAG5C,MAAM,EAAG,GAEZ,GAAc,EAAM,EAAS,IAC/B,QAAQ,IACJ,EAAK,IAAK,GACN,EAAO,EAAK,KAAM,SAAY,CAC1B,IAAM,EAAW,MAAMC,EAAO,EAAK,KAAM,CACrC,QAAS,CACL,OAAQ,MAAM,EAAU,EAAS,GACjC,aAAc,EAAQ,eAGxB,EAAI,EAAK,GAET,EAAO,KAAK,MAAM,EAAE,2CAA2C,GAAG,GAAG,QAe3E,OAdA,EAAE,8EAA8E,SAChF,EAAE,gBAAgB,MAAM,EAAG,IAAQ,CAC3B,EAAI,QAAQ,cACZ,EAAI,QAAQ,IAAM,EAAI,QAAQ,YAC9B,OAAO,EAAI,QAAQ,eAI3B,EAAK,MAAQ,EAAE,cAAc,OAC7B,EAAK,SAAW,EAAE,uBAAuB,KAAK,WAAW,MAAM,KAC/D,EAAK,QAAU,EAAU,EAAK,eAC9B,EAAK,OAAS,EAAK,OAAO,KAAK,QAAQ,IAAK,MAAQ,EAAK,UAAU,KACnE,EAAK,YAAc,EAAE,6BAA6B,OAAS,EAAE,qBAAqB,OAE3E"}