{"version":3,"file":"common-DVTHh5kj.js","names":[],"sources":["../../lib/routes/jiemian/common.ts"],"sourcesContent":["import { Data } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const handler = async (ctx): Promise<Data> => {\r\n    const { category = '' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 50;\r\n\r\n    const rootUrl = 'https://www.jiemian.com';\r\n    const currentUrl = new URL(category ? `${category}.html` : '', rootUrl).href;\r\n\r\n    const response = await ofetch(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    let items = {};\r\n    const links = $('a').toArray();\r\n    for (const el of links) {\r\n        const item = $(el);\r\n        const href = item.prop('href');\r\n        const link = href ? (href.startsWith('/') ? new URL(href, rootUrl).href : href) : undefined;\r\n\r\n        if (link && /\\/(article|video)\\/\\w+\\.html/.test(link)) {\r\n            items[link] = {\r\n                title: item.text(),\r\n                link,\r\n            };\r\n        }\r\n    }\r\n\r\n    items = await Promise.all(\r\n        Object.values(items)\r\n            .slice(0, limit)\r\n            .map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const detailResponse = await ofetch(item.link);\r\n\r\n                    const content = load(detailResponse);\r\n                    const image = content('div.article-img img').first();\r\n                    const video = content('#video-player').first();\r\n\r\n                    item.title = content('div.article-header h1').eq(0).text();\r\n                    item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                        image: image\r\n                            ? {\r\n                                  src: image.prop('src'),\r\n                                  alt: image.next('p').text() || item.title,\r\n                              }\r\n                            : undefined,\r\n                        video: video\r\n                            ? {\r\n                                  src: video.prop('data-url'),\r\n                                  poster: video.prop('data-poster'),\r\n                                  width: video.prop('width'),\r\n                                  height: video.prop('height'),\r\n                              }\r\n                            : undefined,\r\n                        intro: content('div.article-header p').text(),\r\n                        description: content('div.article-content').html(),\r\n                    });\r\n                    item.author = content('span.author')\r\n                        .first()\r\n                        .find('a')\r\n                        .toArray()\r\n                        .map((a) => content(a).text())\r\n                        .join('/');\r\n                    item.category = content('meta.meta-container a')\r\n                        .toArray()\r\n                        .map((c) => content(c).text());\r\n                    item.pubDate = parseDate(content('div.article-info span[data-article-publish-time]').prop('data-article-publish-time'), 'X');\r\n                    item.upvotes = content('span.opt-praise__count').text() ? Number.parseInt(content('span.opt-praise__count').text(), 10) : 0;\r\n                    item.comments = content('span.opt-comment__count').text() ? Number.parseInt(content('span.opt-comment__count').text(), 10) : 0;\r\n\r\n                    return item;\r\n                })\r\n            )\r\n    );\r\n\r\n    const title = $('title').text();\r\n    const titleSplits = title.split(/_/);\r\n    const image = $('div.logo img').prop('src');\r\n    const icon = new URL($('link[rel=\"icon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: titleSplits[0],\r\n        author: titleSplits.pop(),\r\n    };\r\n};\r\n"],"mappings":"8UASA,MAAa,EAAU,KAAO,IAAuB,CACjD,GAAM,CAAE,WAAW,IAAO,EAAI,IAAI,QAC5B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,0BACV,EAAa,IAAI,IAAI,EAAW,GAAG,EAAS,OAAS,GAAI,GAAS,KAElE,EAAW,MAAM,EAAO,GAExB,EAAI,EAAK,GAEX,EAAQ,GACN,EAAQ,EAAE,KAAK,UACrB,IAAK,IAAM,KAAM,EAAO,CACpB,IAAM,EAAO,EAAE,GACT,EAAO,EAAK,KAAK,QACjB,EAAO,EAAQ,EAAK,WAAW,KAAO,IAAI,IAAI,EAAM,GAAS,KAAO,EAAQ,IAAA,GAE9E,GAAQ,+BAA+B,KAAK,KAC5C,EAAM,GAAQ,CACV,MAAO,EAAK,OACZ,SAKZ,EAAQ,MAAM,QAAQ,IAClB,OAAO,OAAO,GACT,MAAM,EAAG,GACT,IAAK,GACF,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAO,EAAK,MAEnC,EAAU,EAAK,GACf,EAAQ,EAAQ,uBAAuB,QACvC,EAAQ,EAAQ,iBAAiB,QAkCvC,MAhCA,GAAK,MAAQ,EAAQ,yBAAyB,GAAG,GAAG,OACpD,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACtE,MAAO,EACD,CACI,IAAK,EAAM,KAAK,OAChB,IAAK,EAAM,KAAK,KAAK,QAAU,EAAK,OAExC,IAAA,GACN,MAAO,EACD,CACI,IAAK,EAAM,KAAK,YAChB,OAAQ,EAAM,KAAK,eACnB,MAAO,EAAM,KAAK,SAClB,OAAQ,EAAM,KAAK,WAEvB,IAAA,GACN,MAAO,EAAQ,wBAAwB,OACvC,YAAa,EAAQ,uBAAuB,SAEhD,EAAK,OAAS,EAAQ,eACjB,QACA,KAAK,KACL,UACA,IAAK,GAAM,EAAQ,GAAG,QACtB,KAAK,KACV,EAAK,SAAW,EAAQ,yBACnB,UACA,IAAK,GAAM,EAAQ,GAAG,QAC3B,EAAK,QAAU,EAAU,EAAQ,oDAAoD,KAAK,6BAA8B,KACxH,EAAK,QAAU,EAAQ,0BAA0B,OAAS,OAAO,SAAS,EAAQ,0BAA0B,OAAQ,IAAM,EAC1H,EAAK,SAAW,EAAQ,2BAA2B,OAAS,OAAO,SAAS,EAAQ,2BAA2B,OAAQ,IAAM,EAEtH,MAKvB,IAAM,EAAQ,EAAE,SAAS,OACnB,EAAc,EAAM,MAAM,KAC1B,EAAQ,EAAE,gBAAgB,KAAK,OAC/B,EAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,QAAS,GAAS,KAElE,MAAO,CACH,KAAM,EACN,QACA,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,EAAE,QAAQ,KAAK,QACzB,QACA,OACA,KAAM,EACN,SAAU,EAAY,GACtB,OAAQ,EAAY"}