import{__dirname as e,init_esm_shims as t}from"./esm-shims-Dqvxr0BZ.js";import"./config-Dl8a1sIg.js";import"./logger-CWOoofbD.js";import"./dist-IvUHtNe1.js";import{cache_default as n}from"./cache-kimkMTWJ.js";import{art as r}from"./render-CxhTJIsl.js";import{parseDate as i}from"./parse-date-Bgabdhlb.js";import{ofetch_default as a}from"./ofetch-Bzt0BXUH.js";import o from"node:path";import{Buffer as s}from"node:buffer";import c from"node:crypto";import{v4 as l}from"uuid";t();const u=`https://api.mercari.jp/`,d=`${u}v2/entities:search`,f=`${u}items/get`,p=`${u}v1/marketplaces/shops/products/`,m={default:``,onsale:`STATUS_ON_SALE`,soldout:`STATUS_SOLD_OUT`},h={default:`SORT_DEFAULT`,create_time:`SORT_CREATED_TIME`,like:`SORT_NUM_LIKES`,score:`SORT_SCORE`,price:`SORT_PRICE`},g={desc:`ORDER_DESC`,asc:`ORDER_ASC`};function _(e){return e.toString(`base64`).replaceAll(`+`,`-`).replaceAll(`/`,`_`).replaceAll(`=`,``)}function v(e){return _(s.from(e,`utf-8`))}function y(e){let t=e.export({format:`jwk`});return{crv:`P-256`,kty:`EC`,x:t.x,y:t.y}}function b(e){return{typ:`dpop+jwt`,alg:`ES256`,jwk:y(e)}}function x(e){let t=0;if(e[t++]!==48)throw Error(`Invalid DER signature`);let n=S(e,t);if(t+=n.bytesRead,e[t++]!==2)throw Error(`Expected INTEGER for R`);let r=S(e,t);t+=r.bytesRead;let i=e.subarray(t,t+r.length);if(t+=r.length,e[t++]!==2)throw Error(`Expected INTEGER for S`);let a=S(e,t);t+=a.bytesRead;let o=e.subarray(t,t+a.length);if(t+=a.length,t!==e.length)throw Error(`Extra bytes in DER signature`);return{r:C(i,32),s:C(o,32)}}function S(e,t){let n=e[t];if(n<128)return{length:n,bytesRead:1};let r=n&127;if(r>4)throw Error(`DER length too long`);let i=0;for(let n=0;n<r;n++)i=i<<8|e[t+1+n];return{length:i,bytesRead:1+r}}function C(e,t){if(e.length>t){let n=e.length-t;return e.subarray(n)}return e.length<t?s.concat([Uint8Array.from(s.alloc(t-e.length)),Uint8Array.from(e)]):e}function w({uuid:e,method:t,url:n}){let{privateKey:r,publicKey:i}=c.generateKeyPairSync(`ec`,{namedCurve:`prime256v1`}),a={iat:Math.floor(Date.now()/1e3),jti:e,htu:n,htm:t.toUpperCase()},o=b(i),l=v(JSON.stringify(o)),u=v(JSON.stringify(a)),d=`${l}.${u}`,f=c.createSign(`SHA256`);f.update(d);let p=f.sign(r),{r:m,s:h}=x(p),g=_(s.concat([Uint8Array.from(m),Uint8Array.from(h)]));return`${d}.${g}`}const T=async(e,t,n=`POST`)=>{let r=w({uuid:l(),method:n,url:e}),i=new Headers({DPOP:r,"X-Platform":`web`,"Accept-Encoding":`gzip, deflate`,"Content-Type":`application/json; charset=utf-8`}),o={method:n,headers:i,body:n===`POST`?JSON.stringify(t):void 0,query:n===`GET`?t:void 0};try{return await a(e,o)}catch(e){throw Error(`API request failed: ${e}`)}},E=e=>e===0?``:`v1:${e}`,D=async(e,t,n,r)=>{let i={userId:`MERCARI_BOT_${l()}`,pageSize:120,pageToken:E(0),searchSessionId:l(),indexRouting:`INDEX_ROUTING_UNSPECIFIED`,thumbnailTypes:[],searchCondition:{keyword:r,excludeKeyword:``,sort:e,order:t,status:[],sizeId:[],categoryId:[],brandId:[],sellerId:[],priceMin:0,priceMax:0,itemConditionId:[],shippingPayerId:[],shippingFromArea:[],shippingMethod:[],colorId:[],hasCoupon:!1,attributes:[],itemTypes:[],skuIds:[],shopIds:[],excludeShippingMethodIds:[]},serviceFrom:`suruga`,withItemBrand:!0,withItemSize:!1,withItemPromotions:!0,withItemSizes:!0,withShopname:!1,useDynamicAttribute:!0,withSuggestedItems:!0,withOfferPricePromotion:!0,withProductSuggest:!0,withParentProducts:!1,withProductArticles:!0,withSearchConditionId:!0,withAuction:!0};return await T(d,i,`POST`)},O=(e,t,n)=>t===`ITEM_TYPE_BEYOND`?T(p+e,{view:`FULL`,imageType:`JPEG`},`GET`):T(f,{id:e,country_code:n,include_item_attributes:!0,include_product_page_component:!0,include_non_ui_item_attributes:!0,include_donation:!0,include_offer_like_coupon_display:!0,include_offer_coupon_display:!0,include_item_attributes_sections:!0,include_auction:!1},`GET`),k=t=>{if(t.displayName){let n=t;return{title:n.displayName,description:r(o.join(e,`templates/shopItem-688c586e.art`),n),pubDate:i(n.createTime),guid:n.name,link:`https://jp.mercari.com/shops/product/${n.name}`,image:n.thumbnail,language:`ja`,author:n.productDetail.shop.displayName,updated:i(n.updateTime)}}let n=t;return{title:n.data.name,description:r(o.join(e,`templates/item-0e24ebcc.art`),n),pubDate:i(n.data.created*1e3),guid:n.data.id,link:`https://jp.mercari.com/item/${n.data.id}`,image:n.data.thumbnails[0],language:`ja`,author:n.data.seller.name,updated:i(n.data.updated*1e3)}},A={path:`/:sort/:order/:status/:keyword`,categories:[`shopping`],parameters:{sort:{description:`排序方式`,default:`default`,options:[{value:`default`,label:`默认排序`},{value:`create_time`,label:`发布时间`},{value:`score`,label:`评分`},{value:`like`,label:`点赞`},{value:`price`,label:`价格`}]},order:{description:`排序顺序`,default:`desc`,options:[{value:`desc`,label:`降序`},{value:`asc`,label:`升序`}]},status:{description:`商品状态`,default:`default`,options:[{value:`default`,label:`全部`},{value:`onsale`,label:`在售`},{value:`soldout`,label:`已售`}]},keyword:{description:`关键词`}},example:`/mercari/create_time/desc/default/ふもふも`,features:{requireConfig:!1,requirePuppeteer:!1,antiCrawler:!1,supportBT:!1,supportPodcast:!1,supportScihub:!1},name:`关键词`,maintainers:[`yana9i`],url:`jp.mercari.com`,handler:j};async function j(e){let{sort:t,order:r,status:i,keyword:a}=e.req.param(),o=(await D(h[t],g[r],m[i],a)).items,s=await Promise.all(o.map(e=>n.tryGet(`mercari:${e.id}`,async()=>await O(e.id,e.itemType).then(e=>k(e)))));return{title:`${a} の検索結果`,link:`https://jp.mercari.com/search?sort=${h[t]}&order=${g[r]}&status=${m[i]}&keyword=${encodeURIComponent(a)}`,description:`Search results for keyword: ${a}`,item:s}}export{A as route};
//# sourceMappingURL=keyword-DISCAYIE.js.map