{"version":3,"file":"discuz-BP_dyKJv.js","names":["ofetch","description","route: Route","ConfigNotFoundError","cache","InvalidParameterError"],"sources":["../../lib/routes/discuz/discuz.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport iconv from 'iconv-lite';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nfunction fixUrl(itemLink, baseUrl) {\r\n    // 处理相对链接\r\n    if (itemLink) {\r\n        if (baseUrl && !/^https?:\\/\\//.test(baseUrl)) {\r\n            baseUrl = /^\\/\\//.test(baseUrl) ? 'http:' + baseUrl : 'http://' + baseUrl;\r\n        }\r\n        itemLink = new URL(itemLink, baseUrl).href;\r\n    }\r\n    return itemLink;\r\n}\r\n\r\n// discuz 7.x 与 discuz x系列 通用文章内容抓取\r\nasync function loadContent(itemLink, charset, header) {\r\n    // 处理编码问题\r\n    const response = await ofetch.raw(itemLink, {\r\n        method: 'get',\r\n        responseType: 'arrayBuffer',\r\n        headers: header,\r\n    });\r\n\r\n    const responseData = iconv.decode(Buffer.from(response._data), charset ?? 'utf-8');\r\n    if (!responseData) {\r\n        const description = '获取详细内容失败';\r\n        return { description };\r\n    }\r\n\r\n    const $ = load(responseData);\r\n\r\n    const post = $('div#postlist div[id^=post] td[id^=postmessage]').first();\r\n\r\n    // fix lazyload image\r\n    post.find('img').each((_, img) => {\r\n        img = $(img);\r\n        if (img.attr('src')?.endsWith('none.gif') && img.attr('file')) {\r\n            img.attr('src', img.attr('file') || img.attr('zoomfile'));\r\n            img.removeAttr('file');\r\n            img.removeAttr('zoomfile');\r\n        }\r\n    });\r\n\r\n    // 只抓取论坛1楼消息\r\n    const description = post.html();\r\n\r\n    return { description };\r\n}\r\n\r\nexport const route: Route = {\r\n    path: ['/:ver{[7x]}/:cid{[0-9]{2}}/:link{.+}', '/:ver{[7x]}/:link{.+}', '/:link{.+}'],\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    let link = ctx.req.param('link');\r\n    const ver = ctx.req.param('ver') ? ctx.req.param('ver').toUpperCase() : undefined;\r\n    const cid = ctx.req.param('cid');\r\n    link = link.replace(/:\\/\\//, ':/').replace(/:\\//, '://');\r\n\r\n    const cookie = cid === undefined ? '' : config.discuz.cookies[cid];\r\n    if (cookie === undefined) {\r\n        throw new ConfigNotFoundError('缺少对应论坛的cookie.');\r\n    }\r\n\r\n    const header = {\r\n        Cookie: cookie,\r\n    };\r\n\r\n    const response = await ofetch.raw(link, {\r\n        method: 'get',\r\n        responseType: 'arrayBuffer',\r\n        headers: header,\r\n    });\r\n\r\n    const responseData = Buffer.from(response._data);\r\n    // 若没有指定编码，则默认utf-8\r\n    const contentType = response.headers['content-type'] || '';\r\n    let $ = load(iconv.decode(responseData, 'utf-8'));\r\n    const charset = contentType.match(/charset=([^;]*)/)?.[1] ?? $('meta[charset]').attr('charset') ?? $('meta[http-equiv=\"Content-Type\"]').attr('content')?.split('charset=')?.[1];\r\n    if (charset?.toLowerCase() !== 'utf-8') {\r\n        $ = load(iconv.decode(responseData, charset ?? 'utf-8'));\r\n    }\r\n\r\n    const version = ver ? `DISCUZ! ${ver}` : $('head > meta[name=generator]').attr('content');\r\n\r\n    let items;\r\n    if (version.toUpperCase().startsWith('DISCUZ! 7')) {\r\n        // discuz 7.x 系列\r\n        // 支持全文抓取，限制抓取页面5个\r\n        const list = $('tbody[id^=\"normalthread\"] > tr')\r\n            .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 5)\r\n            .toArray()\r\n            .map((item) => {\r\n                item = $(item);\r\n                const a = item.find('span[id^=thread] a');\r\n                return {\r\n                    title: a.text().trim(),\r\n                    link: fixUrl(a.attr('href'), link),\r\n                    pubDate: item.find('td.author em').length ? parseDate(item.find('td.author em').text().trim()) : undefined,\r\n                    author: item.find('td.author cite a').text().trim(),\r\n                };\r\n            });\r\n\r\n        items = await Promise.all(\r\n            list.map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const { description } = await loadContent(item.link, charset, header);\r\n\r\n                    item.description = description;\r\n                    return item;\r\n                })\r\n            )\r\n        );\r\n    } else if (version.toUpperCase().startsWith('DISCUZ! X')) {\r\n        // discuz X 系列\r\n        // 支持全文抓取，限制抓取页面5个\r\n        const list = $('tbody[id^=\"normalthread\"] > tr')\r\n            .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 5)\r\n            .toArray()\r\n            .map((item) => {\r\n                item = $(item);\r\n                const a = item.find('a.xst');\r\n                return {\r\n                    title: a.text(),\r\n                    link: fixUrl(a.attr('href'), link),\r\n                    pubDate: item.find('td.by:nth-child(3) em span').last().length ? parseDate(item.find('td.by:nth-child(3) em span').last().text().trim()) : undefined,\r\n                    author: item.find('td.by:nth-child(3) cite a').text().trim(),\r\n                };\r\n            });\r\n\r\n        items = await Promise.all(\r\n            list.map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const { description } = await loadContent(item.link, charset, header);\r\n\r\n                    item.description = description;\r\n                    return item;\r\n                })\r\n            )\r\n        );\r\n    } else {\r\n        throw new InvalidParameterError('不支持当前Discuz版本.');\r\n    }\r\n\r\n    return {\r\n        title: $('head > title').text(),\r\n        description: $('head > meta[name=description]').attr('content'),\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}