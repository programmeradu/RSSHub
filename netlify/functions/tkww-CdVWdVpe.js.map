{"version":3,"file":"tkww-CdVWdVpe.js","names":["route: Route","cache","got","InvalidParameterError"],"sources":["../../lib/routes/tkww/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/:column{.+}?',\r\n    categories: ['traditional-media'],\r\n    example: '/tkww/hong_kong',\r\n    parameters: {\r\n        column: '欄目，默認為 home (首頁)',\r\n    },\r\n    features: {\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '新聞',\r\n    maintainers: ['quiniapiezoelectricity'],\r\n    radar: [\r\n        {\r\n            source: ['www.tkww.hk/:column'],\r\n            target: '/:column',\r\n        },\r\n    ],\r\n    handler,\r\n    description: `\r\n::: tip\r\n欄目可用\\`名稱\\`或對應網頁的\\`path\\`，\r\n如 \\`https://www.tkww.hk/hong_kong\\` 的欄目可以填\\`香港\\`或是\\`hong_kong\\`\r\n而 \\`https://www.tkww.hk/china/shanghai\\` 的欄目則需填\\`china/shanghai\\`\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const column = ctx.req.param('column') ?? 'home';\r\n\r\n    const columns = await cache.tryGet('https://www.tkww.hk/columns.json', async () => await got('https://www.tkww.hk/columns.json'), config.cache.routeExpire, false);\r\n\r\n    let metadata;\r\n    let scope = columns.data.data;\r\n    for (const segment of column.split('/').filter((item) => typeof item === 'string')) {\r\n        metadata = scope.find((item) => item.name === segment || item.dirname === segment);\r\n        scope = metadata?.children ?? [];\r\n    }\r\n\r\n    if (metadata === undefined) {\r\n        throw new InvalidParameterError(`Invalid Column: ${column}`);\r\n    }\r\n\r\n    const stories = await got(`https://www.tkww.hk/columns/${metadata.uuid}/tkww/app/stories.json`);\r\n\r\n    const items = await Promise.all(\r\n        stories.data.data.stories.map((item) =>\r\n            cache.tryGet(item.url, async () => {\r\n                item.link = item.url;\r\n                item.description = item.summary;\r\n                item.pubDate = item.publishTime;\r\n                item.category = [];\r\n                if (item.keywords) {\r\n                    item.category = [...item.category, ...item.keywords];\r\n                }\r\n                if (item.tags) {\r\n                    item.category = [...item.category, ...item.tags];\r\n                }\r\n                item.category = [...new Set(item.category)];\r\n                const response = await got(item.jsonUrl);\r\n                item.description = response.data.data.content;\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: metadata.seoTitle,\r\n        description: metadata.seoDescription,\r\n        link: metadata.url,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"iXAMA,MAAaA,EAAe,CACxB,KAAM,gBACN,WAAY,CAAC,qBACb,QAAS,kBACT,WAAY,CACR,OAAQ,oBAEZ,SAAU,CACN,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,KACN,YAAa,CAAC,0BACd,MAAO,CACH,CACI,OAAQ,CAAC,uBACT,OAAQ,aAGhB,UACA,YAAa,mKAQjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAI,IAAI,MAAM,WAAa,OAEpC,EAAU,MAAMC,EAAM,OAAO,mCAAoC,SAAY,MAAMC,EAAI,oCAAqC,EAAO,MAAM,YAAa,IAExJ,EACA,EAAQ,EAAQ,KAAK,KACzB,IAAK,IAAM,KAAW,EAAO,MAAM,KAAK,OAAQ,GAAS,OAAO,GAAS,UACrE,EAAW,EAAM,KAAM,GAAS,EAAK,OAAS,GAAW,EAAK,UAAY,GAC1E,EAAQ,GAAU,UAAY,GAGlC,GAAI,IAAa,IAAA,GACb,MAAM,IAAIC,EAAsB,mBAAmB,KAGvD,IAAM,EAAU,MAAMD,EAAI,+BAA+B,EAAS,KAAK,yBAEjE,EAAQ,MAAM,QAAQ,IACxB,EAAQ,KAAK,KAAK,QAAQ,IAAK,GAC3BD,EAAM,OAAO,EAAK,IAAK,SAAY,CAC/B,EAAK,KAAO,EAAK,IACjB,EAAK,YAAc,EAAK,QACxB,EAAK,QAAU,EAAK,YACpB,EAAK,SAAW,GACZ,EAAK,WACL,EAAK,SAAW,CAAC,GAAG,EAAK,SAAU,GAAG,EAAK,WAE3C,EAAK,OACL,EAAK,SAAW,CAAC,GAAG,EAAK,SAAU,GAAG,EAAK,OAE/C,EAAK,SAAW,CAAC,GAAG,IAAI,IAAI,EAAK,WACjC,IAAM,EAAW,MAAMC,EAAI,EAAK,SAEhC,MADA,GAAK,YAAc,EAAS,KAAK,KAAK,QAC/B,MAKnB,MAAO,CACH,MAAO,EAAS,SAChB,YAAa,EAAS,eACtB,KAAM,EAAS,IACf,KAAM"}