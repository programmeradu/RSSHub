{"version":3,"file":"subject-D55z5W8n.js","names":[],"sources":["../../lib/routes/cls/subject.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nimport { rootUrl, getSearchParams } from './utils';\r\n\r\nexport const handler = async (ctx) => {\r\n    const { id = '1103' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 20;\r\n\r\n    const currentUrl = new URL(`subject/${id}`, rootUrl).href;\r\n    const apiUrl = new URL(`api/subject/${id}/article`, rootUrl).href;\r\n\r\n    const { data: response } = await got(apiUrl, {\r\n        searchParams: getSearchParams({\r\n            Subject_Id: id,\r\n        }),\r\n    });\r\n\r\n    let items = response.data.slice(0, limit).map((item) => {\r\n        const title = item.article_title;\r\n        const description = art(path.join(__dirname, 'templates/description.art'), {\r\n            intro: item.article_brief,\r\n        });\r\n        const guid = `cls-${item.article_id}`;\r\n        const image = item.article_img;\r\n\r\n        return {\r\n            title,\r\n            description,\r\n            pubDate: parseDate(item.article_time, 'X'),\r\n            link: new URL(`detail/${item.article_id}`, rootUrl).href,\r\n            category: item.subjects.map((s) => s.subject_name),\r\n            author: item.article_author,\r\n            guid,\r\n            id: guid,\r\n            content: {\r\n                html: description,\r\n                text: item.article_brief,\r\n            },\r\n            image,\r\n            banner: image,\r\n        };\r\n    });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const $$ = load(detailResponse);\r\n\r\n                const data = JSON.parse($$('script#__NEXT_DATA__').text())?.props?.initialState?.detail?.articleDetail ?? undefined;\r\n\r\n                if (!data) {\r\n                    return item;\r\n                }\r\n\r\n                const title = data.title;\r\n                const description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    images: data.images.map((i) => ({\r\n                        src: i,\r\n                        alt: title,\r\n                    })),\r\n                    intro: data.brief,\r\n                    description: data.content,\r\n                });\r\n                const guid = `cls-${data.id}`;\r\n                const image = data.images?.[0] ?? undefined;\r\n\r\n                item.title = title;\r\n                item.description = description;\r\n                item.pubDate = parseDate(data.ctime, 'X');\r\n                item.category = [...new Set(data.subject?.flatMap((s) => [s.name, ...(s.subjectCategory?.flatMap((c) => [c.columnName || [], c.name || []]) ?? [])]) ?? [])].filter(Boolean);\r\n                item.author = data.author?.name ?? item.author;\r\n                item.guid = guid;\r\n                item.id = guid;\r\n                item.content = {\r\n                    html: description,\r\n                    text: data.content,\r\n                };\r\n                item.image = image;\r\n                item.banner = image;\r\n                item.enclosure_url = data.audioUrl;\r\n                item.enclosure_type = item.enclosure_url ? `audio/${item.enclosure_url.split(/\\./).pop()}` : undefined;\r\n                item.enclosure_title = title;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const data = JSON.parse($('script#__NEXT_DATA__').text())?.props?.initialProps?.pageProps?.subjectDetail ?? undefined;\r\n\r\n    const author = '财联社';\r\n    const image = data?.img ?? undefined;\r\n\r\n    return {\r\n        title: `${author} - ${data?.name ?? $('title').text()}`,\r\n        description: data?.description ?? undefined,\r\n        link: currentUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image,\r\n        author,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/subject/:id?',\r\n    name: '话题',\r\n    url: 'www.cls.cn',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/cls/subject/1103',\r\n    parameters: { category: '分类，默认为 1103，即A股盘面直播，可在对应话题页 URL 中找到' },\r\n    description: `::: tip\r\n  若订阅 [有声早报](https://www.cls.cn/subject/1151)，网址为 \\`https://www.cls.cn/subject/1151\\`。截取 \\`https://www.cls.cn/subject/\\` 到末尾的部分 \\`1151\\` 作为参数填入，此时路由为 [\\`/cls/subject/1151\\`](https://rsshub.app/cls/subject/1151)。\r\n:::\r\n    `,\r\n    categories: ['finance'],\r\n\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.cls.cn/subject/:id'],\r\n            target: (params) => {\r\n                const id = params.id;\r\n\r\n                return `/subject${id ? `/${id}` : ''}`;\r\n            },\r\n        },\r\n    ],\r\n};\r\n"],"mappings":"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"}