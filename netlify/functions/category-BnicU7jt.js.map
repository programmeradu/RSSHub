{"version":3,"file":"category-BnicU7jt.js","names":[],"sources":["../../lib/routes/famitsu/category.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport * as cheerio from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { config } from '@/config';\r\nimport { ArticleDetail, Category, CategoryArticle } from './types';\r\n\r\nconst baseUrl = 'https://www.famitsu.com';\r\n\r\nexport const route: Route = {\r\n    path: '/category/:category?',\r\n    categories: ['game'],\r\n    example: '/famitsu/category/new-article',\r\n    parameters: { category: 'Category, see table below, `new-article` by default' },\r\n    radar: [\r\n        {\r\n            source: ['www.famitsu.com/category/:category/page/1'],\r\n        },\r\n    ],\r\n    name: 'Category',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n    description: `| 新着        | Switch | PS5 | PS4 | PC ゲーム | ニュース | 動画   | 特集・企画記事  | インタビュー | 取材・リポート | レビュー | インディーゲーム |\r\n| ----------- | ------ | --- | --- | --------- | -------- | ------ | --------------- | ------------ | -------------- | -------- | ---------------- |\r\n| new-article | switch | ps5 | ps4 | pc-game   | news     | videos | special-article | interview    | event-report   | review   | indie-game       |`,\r\n};\r\n\r\nfunction getBuildId() {\r\n    return cache.tryGet(\r\n        'famitsu:buildId',\r\n        async () => {\r\n            const data = await ofetch(baseUrl);\r\n            const $ = cheerio.load(data);\r\n            const nextData = JSON.parse($('#__NEXT_DATA__').text());\r\n            return nextData.buildId;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n}\r\n\r\nfunction render(data) {\r\n    return art(path.join(__dirname, 'templates/description.art'), data);\r\n}\r\n\r\nfunction renderJSON(c) {\r\n    if (Array.isArray(c.content)) {\r\n        return c.content.map((con) => con.type && renderJSON(con)).join('');\r\n    }\r\n\r\n    switch (c.type) {\r\n        case 'B':\r\n        case 'INTERVIEWEE':\r\n        case 'STRONG':\r\n            return `<b>${c.content}</b>`;\r\n        case 'HEAD':\r\n            return `<h2>${c.content}</h2>`;\r\n        case 'SHEAD':\r\n            return `<h3>${c.content}</h3>`;\r\n        case 'LINK_B':\r\n        case 'LINK_B_TAB':\r\n            return `<a href=\"${c.url}\"><b>${c.content}</b></a><br>`;\r\n        case 'IMAGE':\r\n            return `<img src=\"${c.path}\">`;\r\n        case 'NEWS':\r\n            return `<a href=\"${c.url}\">${c.content}<br>${c.description}</a><br>`;\r\n        case 'HTML':\r\n            return c.content;\r\n        case 'ANNOTATION':\r\n        case 'CAPTION':\r\n        case 'ITEMIZATION':\r\n        case 'ITEMIZATION_NUM':\r\n        case 'NOLINK':\r\n        case 'STRING':\r\n        case 'TWITTER':\r\n        case 'YOUTUBE':\r\n            return `<div><span>${c.content}</span></div>`;\r\n        case 'BUTTON':\r\n        case 'BUTTON_ANDROID':\r\n        case 'BUTTON_EC':\r\n        case 'BUTTON_IOS':\r\n        case 'BUTTON_TAB':\r\n        case 'LINK':\r\n        case 'LINK_TAB':\r\n            return `<a href=\"${c.url}\">${c.content}</a><br>`;\r\n        default:\r\n            throw new Error(`Unhandle type: ${c.type}`);\r\n    }\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'new-article' } = ctx.req.param();\r\n    const url = `${baseUrl}/category/${category}/page/1`;\r\n\r\n    const buildId = await getBuildId();\r\n\r\n    const data = await ofetch(`https://www.famitsu.com/_next/data/${buildId}/category/${category}/page/1.json`, {\r\n        query: {\r\n            categoryCode: category,\r\n            pageNumber: 1,\r\n        },\r\n    });\r\n\r\n    const list = (data.pageProps.categoryArticleDataForPc as CategoryArticle[])\r\n        .filter((item) => !item.advertiserName)\r\n        .map((item) => {\r\n            const publicationDate = item.publishedAt?.slice(0, 7).replace('-', '');\r\n            return {\r\n                title: item.title,\r\n                link: `https://www.famitsu.com/article/${publicationDate}/${item.id}`,\r\n                pubDate: parseDate(item.publishedAt!),\r\n                category: [...new Set([item.mainCategory.nameJa, ...(item.subCategories?.map((c) => c.nameJa) ?? [])])],\r\n                publicationDate,\r\n                articleId: item.id,\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const data = await ofetch(`https://www.famitsu.com/_next/data/${buildId}/article/${item.publicationDate}/${item.articleId}.json`, {\r\n                    query: {\r\n                        publicationDate: item.publicationDate,\r\n                        articleId: item.articleId,\r\n                    },\r\n                });\r\n\r\n                const articleDetail = data.pageProps.articleDetailData as ArticleDetail;\r\n                item.author = articleDetail.authors?.map((a) => a.name_ja).join(', ') ?? articleDetail.user.name_ja;\r\n                item.description = render({\r\n                    bannerImage: articleDetail.ogpImageUrl ?? articleDetail.thumbnailUrl,\r\n                    content: articleDetail.content.flatMap((c) => c.contents.map((con) => renderJSON(con))).join(''),\r\n                });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${(data.pageProps.targetCategory as Category).nameJa}の最新記事 | ゲーム・エンタメ最新情報のファミ通.com`,\r\n        image: 'https://www.famitsu.com/img/1812/favicons/apple-touch-icon.png',\r\n        link: url,\r\n        item: items,\r\n        language: 'ja',\r\n    };\r\n}\r\n"],"mappings":"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"}