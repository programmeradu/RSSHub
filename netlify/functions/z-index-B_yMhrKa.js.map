{"version":3,"file":"z-index-B_yMhrKa.js","names":["route: Route"],"sources":["../../lib/routes/dlsite/utils.ts","../../lib/routes/dlsite/z-index/index.ts"],"sourcesContent":["import { getSubPath } from '@/utils/common-utils';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport dayjs from 'dayjs';\r\nimport path from 'node:path';\r\n\r\nconst rootUrl = 'https://www.dlsite.com';\r\n\r\nconst defaultFilters = {\r\n    show_type: 1,\r\n    show_layout: 1,\r\n    per_page: 100,\r\n};\r\n\r\nconst formatDate = (date, format) => dayjs(date).format(format);\r\n\r\nconst addFilters = (url, filters) => {\r\n    const keys = Object.keys(filters);\r\n    const filterStr = keys.map((k) => `/${k}/${filters[k]}`).join('');\r\n    const newUrl = url.replaceAll(new RegExp(`(/${keys.join(String.raw`/\\w+|/`)}/\\\\w+)`, 'g'), '');\r\n    return `${newUrl}${/=/.test(newUrl) ? '' : '/='}${filterStr}`;\r\n};\r\n\r\nconst getPubDate = (raw) => {\r\n    const dateMatches = raw.match(/(\\d{4}).*(\\d{2}).*(\\d{2})/);\r\n    if (dateMatches) {\r\n        return parseDate(`${dateMatches[1]}-${dateMatches[2]}-${dateMatches[3]}`, 'YYYY-MM-DD');\r\n    }\r\n    return parseDate(raw.split(':').pop().trim(), 'MMM/DD/YYYY');\r\n};\r\n\r\nconst getDetails = async (works) => {\r\n    const apiUrl = `${rootUrl}/home-touch/product/info/ajax?product_id=${works}`;\r\n\r\n    const detailResponse = await got({\r\n        method: 'get',\r\n        url: apiUrl,\r\n    });\r\n\r\n    return detailResponse.data;\r\n};\r\n\r\nconst ProcessItems = async (ctx) => {\r\n    art.defaults.imports.formatDate = formatDate;\r\n\r\n    const subPath = getSubPath(ctx) === '/' ? '/home/new' : getSubPath(ctx);\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 100;\r\n\r\n    const currentUrl = `${rootUrl}${addFilters(subPath, defaultFilters)}`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    const works = $('dt.work_name').slice(0, limit);\r\n    const updatedDate = $('.work_update').length === 0 ? undefined : getPubDate($('.work_update').text());\r\n\r\n    const details = await getDetails(\r\n        works\r\n            .toArray()\r\n            .map(\r\n                (item) =>\r\n                    $(item)\r\n                        .find('a')\r\n                        .attr('href')\r\n                        .match(/_id\\/(.*?)\\.html/)[1]\r\n            )\r\n            .join(',')\r\n    );\r\n\r\n    const items = works.toArray().map((item) => {\r\n        item = $(item).parentsUntil('tbody, ul');\r\n\r\n        const a = item.find('.work_name a');\r\n\r\n        const title = a.text();\r\n        const link = a.attr('href');\r\n        const guid = link.match(/_id\\/(.*?)\\.html/)[1];\r\n\r\n        const description = item.find('.work_text').text();\r\n        const authors = item\r\n            .find('.maker_name a')\r\n            .toArray()\r\n            .map((a) => ({\r\n                name: $(a).text(),\r\n                link: $(a).attr('href'),\r\n            }));\r\n        let images = item.find('div[data-samples]').length === 0 ? [] : JSON.parse(item.find('div[data-samples]').attr('data-samples').replaceAll(\"'\", '\"')).map((s) => s.thumb);\r\n\r\n        const workCategories = item\r\n            .find('.work_category')\r\n            .find('a')\r\n            .toArray()\r\n            .map((i) => ({\r\n                text: $(i).text(),\r\n                link: $(i).attr('href'),\r\n            }));\r\n\r\n        const workGenres = item\r\n            .find('.work_genre')\r\n            .find('span[title]')\r\n            .toArray()\r\n            .map((i) => ({\r\n                text: $(i).text(),\r\n            }));\r\n\r\n        const searchTags = item\r\n            .find('.search_tag')\r\n            .find('a')\r\n            .toArray()\r\n            .map((i) => ({\r\n                text: $(i).text(),\r\n                link: $(i).attr('href'),\r\n            }));\r\n\r\n        const nameTags = item\r\n            .find('.icon_wrap')\r\n            .find('span[title]')\r\n            .toArray()\r\n            .map((i) => ({\r\n                text: $(i).text(),\r\n            }));\r\n\r\n        const detail = details[guid];\r\n\r\n        const pubDate = timezone(parseDate(detail.regist_date), +9);\r\n        const discountRate = detail.discount_rate;\r\n        const discountEndDate = detail.discount_end_date ? timezone(parseDate(detail.discount_end_date, 'MM/DD HH:mm'), +9) : undefined;\r\n        images = images.length === 0 ? [detail.work_image] : images;\r\n\r\n        return {\r\n            title: `${\r\n                discountRate\r\n                    ? `${discountRate}% OFF\r\n                        ${` ${discountEndDate ? `${dayjs(discountEndDate).format('YYYY-MM-DD HH:mm')} まで` : ''}`}`\r\n                    : ' '\r\n            }${title}`,\r\n            link,\r\n            pubDate,\r\n            author: authors.map((a) => a.name).join(' / '),\r\n            category: [...workCategories.map((i) => i.text), ...workGenres.map((i) => i.text), ...searchTags.map((i) => i.text), ...nameTags.map((i) => i.text)],\r\n            guid: `dlsite-${guid}`,\r\n            description: art(path.join(__dirname, 'templates/description.art'), {\r\n                detail,\r\n                images,\r\n                authors,\r\n                discountRate,\r\n                discountEndDate,\r\n                updatedDate,\r\n                pubDate,\r\n                workCategories,\r\n                workGenres,\r\n                searchTags,\r\n                description,\r\n            }),\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        description: $('meta[name=\"description\"]').attr('content'),\r\n        link: currentUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n    };\r\n};\r\n\r\nexport { ProcessItems };\r\n","import { Route } from '@/types';\r\nimport { ProcessItems } from '../utils';\r\n\r\nexport const route: Route = {\r\n    path: '*',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    return await ProcessItems(ctx);\r\n}\r\n"],"mappings":"miBASA,MAAM,EAAU,yBAEV,EAAiB,CACnB,UAAW,EACX,YAAa,EACb,SAAU,KAGR,GAAc,EAAM,IAAW,EAAM,GAAM,OAAO,GAElD,GAAc,EAAK,IAAY,CACjC,IAAM,EAAO,OAAO,KAAK,GACnB,EAAY,EAAK,IAAK,GAAM,IAAI,EAAE,GAAG,EAAQ,MAAM,KAAK,IACxD,EAAS,EAAI,WAAe,OAAO,KAAK,EAAK,KAAK,OAAO,GAAG,UAAU,QAAS,KAAM,IAC3F,MAAO,GAAG,IAAS,IAAI,KAAK,GAAU,GAAK,OAAO,KAGhD,EAAc,GAAQ,CACxB,IAAM,EAAc,EAAI,MAAM,6BAI9B,OAHI,EACO,EAAU,GAAG,EAAY,GAAG,GAAG,EAAY,GAAG,GAAG,EAAY,KAAM,cAEvE,EAAU,EAAI,MAAM,KAAK,MAAM,OAAQ,gBAG5C,EAAa,KAAO,IAAU,CAChC,IAAM,EAAS,GAAG,EAAQ,2CAA2C,IAE/D,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,IAGT,OAAO,EAAe,MAGpB,EAAe,KAAO,IAAQ,CAChC,EAAI,SAAS,QAAQ,WAAa,EAElC,IAAM,EAAU,EAAW,KAAS,IAAM,YAAc,EAAW,GAE7D,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAE3E,EAAa,GAAG,IAAU,EAAW,EAAS,KAE9C,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MAElB,EAAQ,EAAE,gBAAgB,MAAM,EAAG,GACnC,EAAc,EAAE,gBAAgB,SAAW,EAAI,IAAA,GAAY,EAAW,EAAE,gBAAgB,QAExF,EAAU,MAAM,EAClB,EACK,UACA,IACI,GACG,EAAE,GACG,KAAK,KACL,KAAK,QACL,MAAM,oBAAoB,IAEtC,KAAK,MAGR,EAAQ,EAAM,UAAU,IAAK,GAAS,CACxC,EAAO,EAAE,GAAM,aAAa,aAE5B,IAAM,EAAI,EAAK,KAAK,gBAEd,EAAQ,EAAE,OACV,EAAO,EAAE,KAAK,QACd,EAAO,EAAK,MAAM,oBAAoB,GAEtC,EAAc,EAAK,KAAK,cAAc,OACtC,EAAU,EACX,KAAK,iBACL,UACA,IAAK,IAAO,CACT,KAAM,EAAE,GAAG,OACX,KAAM,EAAE,GAAG,KAAK,WAEpB,EAAS,EAAK,KAAK,qBAAqB,SAAW,EAAI,GAAK,KAAK,MAAM,EAAK,KAAK,qBAAqB,KAAK,gBAAgB,WAAW,IAAK,MAAM,IAAK,GAAM,EAAE,OAE5J,EAAiB,EAClB,KAAK,kBACL,KAAK,KACL,UACA,IAAK,IAAO,CACT,KAAM,EAAE,GAAG,OACX,KAAM,EAAE,GAAG,KAAK,WAGlB,EAAa,EACd,KAAK,eACL,KAAK,eACL,UACA,IAAK,IAAO,CACT,KAAM,EAAE,GAAG,UAGb,EAAa,EACd,KAAK,eACL,KAAK,KACL,UACA,IAAK,IAAO,CACT,KAAM,EAAE,GAAG,OACX,KAAM,EAAE,GAAG,KAAK,WAGlB,EAAW,EACZ,KAAK,cACL,KAAK,eACL,UACA,IAAK,IAAO,CACT,KAAM,EAAE,GAAG,UAGb,EAAS,EAAQ,GAEjB,EAAU,EAAS,EAAU,EAAO,aAAc,GAClD,EAAe,EAAO,cACtB,EAAkB,EAAO,kBAAoB,EAAS,EAAU,EAAO,kBAAmB,eAAgB,GAAM,IAAA,GAGtH,MAFA,GAAS,EAAO,SAAW,EAAI,CAAC,EAAO,YAAc,EAE9C,CACH,MAAO,GACH,EACM,GAAG,EAAa;0BACZ,IAAI,EAAkB,GAAG,EAAM,GAAiB,OAAO,oBAAoB,KAAO,OACtF,MACP,IACH,OACA,UACA,OAAQ,EAAQ,IAAK,GAAM,EAAE,MAAM,KAAK,OACxC,SAAU,CAAC,GAAG,EAAe,IAAK,GAAM,EAAE,MAAO,GAAG,EAAW,IAAK,GAAM,EAAE,MAAO,GAAG,EAAW,IAAK,GAAM,EAAE,MAAO,GAAG,EAAS,IAAK,GAAM,EAAE,OAC9I,KAAM,UAAU,IAChB,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,SACA,SACA,UACA,eACA,kBACA,cACA,UACA,iBACA,aACA,aACA,mBAKZ,MAAO,CACH,MAAO,EAAE,SAAS,OAClB,YAAa,EAAE,4BAA4B,KAAK,WAChD,KAAM,EACN,KAAM,EACN,WAAY,KCvKPA,EAAe,CACxB,KAAM,IACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,OAAO,MAAM,EAAa"}