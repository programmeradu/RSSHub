{"version":3,"file":"utils-UZ1EzmlJ.js","names":["got","cache"],"sources":["../../lib/routes/ruancan/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst fetchFeed = async (ctx, currentUrl) => {\r\n    const rootUrl = 'https://www.ruancan.com';\r\n    currentUrl = `${rootUrl}${currentUrl}`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    let items = $('.item-title a')\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 15)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                title: item.text(),\r\n                link: item.attr('href'),\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                });\r\n\r\n                const content = load(detailResponse.data);\r\n\r\n                content('.entry-copyright').remove();\r\n\r\n                content('.entry-content div').each(function () {\r\n                    if (/^ruanc-\\d+/.test(content(this).attr('id'))) {\r\n                        content(this).remove();\r\n                    }\r\n                });\r\n\r\n                content('figure').each(function () {\r\n                    content(this).html(`<img src=\"${content(this).find('a').attr('href')}\">`);\r\n                });\r\n\r\n                item.description = content('.entry-content').html();\r\n                item.category = content('.entry-info a[rel=\"category tag\"]')\r\n                    .toArray()\r\n                    .map((c) => content(c).text());\r\n                item.pubDate = parseDate(content('.entry-info .entry-date').attr('datetime'));\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n};\r\nexport default fetchFeed;\r\n"],"mappings":"wLAKA,MAAM,EAAY,MAAO,EAAK,IAAe,CAEzC,EAAa,0BAAa,IAE1B,IAAM,EAAW,MAAMA,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MAEpB,EAAQ,EAAE,iBACT,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAC5E,UACA,IAAK,IACF,EAAO,EAAE,GAEF,CACH,MAAO,EAAK,OACZ,KAAM,EAAK,KAAK,WAqC5B,MAjCA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAMD,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAe,MAoBpC,OAlBA,EAAQ,oBAAoB,SAE5B,EAAQ,sBAAsB,KAAK,UAAY,CACvC,aAAa,KAAK,EAAQ,MAAM,KAAK,QACrC,EAAQ,MAAM,WAItB,EAAQ,UAAU,KAAK,UAAY,CAC/B,EAAQ,MAAM,KAAK,aAAa,EAAQ,MAAM,KAAK,KAAK,KAAK,QAAQ,OAGzE,EAAK,YAAc,EAAQ,kBAAkB,OAC7C,EAAK,SAAW,EAAQ,qCACnB,UACA,IAAK,GAAM,EAAQ,GAAG,QAC3B,EAAK,QAAU,EAAU,EAAQ,2BAA2B,KAAK,aAE1D,MAKZ,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM,IAGd,IAAA,EAAe"}