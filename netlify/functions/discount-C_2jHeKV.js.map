{"version":3,"file":"discount-C_2jHeKV.js","names":["route: Route","ofetch"],"sources":["../../lib/routes/xiaoheihe/discount.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { calculate } from './util';\r\n\r\nexport const route: Route = {\r\n    path: '/discount/:platform',\r\n    categories: ['game'],\r\n    example: '/xiaoheihe/discount/pc',\r\n    parameters: { platform: '平台分类，见下表' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '游戏折扣',\r\n    maintainers: ['tssujt'],\r\n    handler,\r\n    description: `| PC  | Switch  | PSN   | Xbox |\r\n| ----- | ------ | ----- | ----- |\r\n| pc    | switch | psn   | xbox  |`,\r\n};\r\n\r\nconst PLATFORM_MAP = {\r\n    pc: {\r\n        key: 'pc',\r\n        desc: 'PC',\r\n    },\r\n    switch: {\r\n        key: 'switch',\r\n        desc: 'Switch',\r\n    },\r\n    psn: {\r\n        key: 'ps4',\r\n        desc: 'PSN',\r\n    },\r\n    xbox: {\r\n        key: 'xbox',\r\n        desc: 'Xbox',\r\n    },\r\n};\r\n\r\nfunction getDiscountDesc(discount) {\r\n    return `${(100 - discount) / 10}折`;\r\n}\r\n\r\nfunction getLowestDesc(priceInfo, isSuperLowest = false) {\r\n    if (!('is_lowest' in priceInfo) || priceInfo.is_lowest === 0) {\r\n        return '';\r\n    } else if (isSuperLowest) {\r\n        return '[超史低]';\r\n    } else if (priceInfo.is_lowest && priceInfo.is_lowest === 1 && priceInfo.new_lowest && priceInfo.new_lowest === 1) {\r\n        return '[新史低]';\r\n    } else if (priceInfo.is_lowest && priceInfo.is_lowest === 1) {\r\n        return '[史低]';\r\n    }\r\n}\r\n\r\nfunction getHeyboxPriceDesc(heyboxPriceInfo) {\r\n    if (heyboxPriceInfo.coupon_info) {\r\n        let discountPrice = heyboxPriceInfo.cost_coin / 1000;\r\n        discountPrice = discountPrice - heyboxPriceInfo.coupon_info.max_reduce;\r\n        const formatPrice = Number.isInteger(discountPrice) ? discountPrice.toFixed(0) : discountPrice.toFixed(2);\r\n        return `| 券后价: ${formatPrice} [${heyboxPriceInfo.coupon_info.coupon_desc}]`;\r\n    } else {\r\n        return '';\r\n    }\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const platformInfo = PLATFORM_MAP[ctx.req.param('platform')];\r\n\r\n    const dataUrl = calculate(\r\n        `https://api.xiaoheihe.cn/game/get_game_list_v3/?filter_head=${platformInfo.key}&offset=0&limit=30&os_type=web&app=heybox&client_type=mobile&version=999.0.3&x_client_type=web&x_os_type=Mac&x_app=heybox&heybox_id=-1&include_filter=-1`\r\n    );\r\n    const response = await ofetch(dataUrl);\r\n    const data = response.result.games;\r\n\r\n    const items = data.map((item) => {\r\n        const title = `${item.name}${item.name_en ? '/' + item.name_en : ''}`;\r\n        let description = `\r\n                <img src=\"${item.image}\"/> <br/>\r\n            `;\r\n        if (item.platform_infos) {\r\n            for (const platform of item.platform_infos) {\r\n                if (platform.price) {\r\n                    if (platform.key) {\r\n                        description += `平台: ${platform.key.toUpperCase()}<br/>`;\r\n                    }\r\n                    if (platform.price.current) {\r\n                        description += `当前价格: ${platform.price.current} ${getLowestDesc(platform.price)}<br/>`;\r\n                    }\r\n                    if (platform.price.initial) {\r\n                        description += `原价: ${platform.price.initial}<br/>`;\r\n                    }\r\n                    if (platform.price.discount && platform.price.discount > 0) {\r\n                        description += `折扣力度: ${getDiscountDesc(platform.price.discount)}<br/>`;\r\n                    }\r\n                    if (platform.price.deadline_date) {\r\n                        description += `截止时间: ${platform.price.deadline_date}<br/>`;\r\n                    }\r\n                }\r\n            }\r\n        } else {\r\n            if (item.price) {\r\n                description += `平台: ${platformInfo.desc}<br/>`;\r\n                if (item.heybox_price) {\r\n                    description += `当前价格: ${item.price.current} ${getHeyboxPriceDesc(item.heybox_price)} ${getLowestDesc(item.price, item.heybox_price.super_lowest)}<br/>`;\r\n                } else if (item.price.current) {\r\n                    description += `当前价格: ${item.price.current} ${getLowestDesc(item.price)}<br/>`;\r\n                }\r\n                if (item.price.initial) {\r\n                    description += `原价: ${item.price.initial}<br/>`;\r\n                }\r\n                if (item.price.discount && item.price.discount > 0) {\r\n                    description += `折扣力度: ${getDiscountDesc(item.price.discount)}<br/>`;\r\n                }\r\n                if (item.price.deadline_date) {\r\n                    description += `截止时间: ${item.price.deadline_date}<br/>`;\r\n                }\r\n            }\r\n        }\r\n        if (item.score) {\r\n            description += `评分: ${item.score}<br/>`;\r\n        }\r\n        description += '<br/>';\r\n\r\n        let link = `https://api.xiaoheihe.cn/game/share_game_detail?appid=${item.steam_appid}`;\r\n        if (platformInfo.key === 'pc') {\r\n            link = `https://store.steampowered.com/app/${item.steam_appid}`;\r\n        }\r\n        return {\r\n            title,\r\n            description,\r\n            link,\r\n        };\r\n    });\r\n\r\n    return {\r\n        title: `小黑盒 ${platformInfo.desc} 游戏折扣`,\r\n        link: `https://xiaoheihe.cn`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"0NAIA,MAAaA,EAAe,CACxB,KAAM,sBACN,WAAY,CAAC,QACb,QAAS,yBACT,WAAY,CAAE,SAAU,YACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,UACd,UACA,YAAa;;qCAKX,EAAe,CACjB,GAAI,CACA,IAAK,KACL,KAAM,MAEV,OAAQ,CACJ,IAAK,SACL,KAAM,UAEV,IAAK,CACD,IAAK,MACL,KAAM,OAEV,KAAM,CACF,IAAK,OACL,KAAM,SAId,SAAS,EAAgB,EAAU,CAC/B,MAAO,IAAI,IAAM,GAAY,GAAG,GAGpC,SAAS,EAAc,EAAW,EAAgB,GAAO,CACrD,GAAI,EAAE,cAAe,IAAc,EAAU,YAAc,EACvD,MAAO,MACA,EACP,MAAO,WACA,EAAU,WAAa,EAAU,YAAc,GAAK,EAAU,YAAc,EAAU,aAAe,EAC5G,MAAO,WACA,EAAU,WAAa,EAAU,YAAc,EACtD,MAAO,OAIf,SAAS,EAAmB,EAAiB,CACzC,GAAI,EAAgB,YAAa,CAC7B,IAAI,EAAgB,EAAgB,UAAY,IAChD,GAAgC,EAAgB,YAAY,WAC5D,IAAM,EAAc,OAAO,UAAU,GAAiB,EAAc,QAAQ,GAAK,EAAc,QAAQ,GACvG,MAAO,UAAU,EAAY,IAAI,EAAgB,YAAY,YAAY,QAEzE,MAAO,GAIf,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAe,EAAa,EAAI,IAAI,MAAM,aAE1C,EAAU,EACZ,+DAA+D,EAAa,IAAI,2JAE9E,EAAW,MAAMC,EAAO,GACxB,EAAO,EAAS,OAAO,MAEvB,EAAQ,EAAK,IAAK,GAAS,CAC7B,IAAM,EAAQ,GAAG,EAAK,OAAO,EAAK,QAAU,IAAM,EAAK,QAAU,KAC7D,EAAc;4BACE,EAAK,MAAM;cAE/B,GAAI,EAAK,mBACA,IAAM,KAAY,EAAK,eACpB,EAAS,QACL,EAAS,MACT,GAAe,OAAO,EAAS,IAAI,cAAc,QAEjD,EAAS,MAAM,UACf,GAAe,SAAS,EAAS,MAAM,QAAQ,GAAG,EAAc,EAAS,OAAO,QAEhF,EAAS,MAAM,UACf,GAAe,OAAO,EAAS,MAAM,QAAQ,QAE7C,EAAS,MAAM,UAAY,EAAS,MAAM,SAAW,IACrD,GAAe,SAAS,EAAgB,EAAS,MAAM,UAAU,QAEjE,EAAS,MAAM,gBACf,GAAe,SAAS,EAAS,MAAM,cAAc,cAK7D,EAAK,QACL,GAAe,OAAO,EAAa,KAAK,OACpC,EAAK,aACL,GAAe,SAAS,EAAK,MAAM,QAAQ,GAAG,EAAmB,EAAK,cAAc,GAAG,EAAc,EAAK,MAAO,EAAK,aAAa,cAAc,OAC1I,EAAK,MAAM,UAClB,GAAe,SAAS,EAAK,MAAM,QAAQ,GAAG,EAAc,EAAK,OAAO,QAExE,EAAK,MAAM,UACX,GAAe,OAAO,EAAK,MAAM,QAAQ,QAEzC,EAAK,MAAM,UAAY,EAAK,MAAM,SAAW,IAC7C,GAAe,SAAS,EAAgB,EAAK,MAAM,UAAU,QAE7D,EAAK,MAAM,gBACX,GAAe,SAAS,EAAK,MAAM,cAAc,SAIzD,EAAK,QACL,GAAe,OAAO,EAAK,MAAM,QAErC,GAAe,QAEf,IAAI,EAAO,yDAAyD,EAAK,cAIzE,OAHI,EAAa,MAAQ,OACrB,EAAO,sCAAsC,EAAK,eAE/C,CACH,QACA,cACA,UAIR,MAAO,CACH,MAAO,OAAO,EAAa,KAAK,OAChC,KAAM,uBACN,KAAM"}