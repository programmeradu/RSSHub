{"version":3,"file":"stats-BFy_j6dB.js","names":[],"sources":["../../lib/routes/gov/stats/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport { getSubPath } from '@/utils/common-utils';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/stats/*',\r\n    name: '国家统计局 通用',\r\n    url: 'www.stats.gov.cn',\r\n    categories: ['government'],\r\n    maintainers: ['bigfei', 'nczitzk', 'reply2future'],\r\n    example: '/gov/stats/sj/zxfb',\r\n    handler,\r\n    radar: [\r\n        {\r\n            title: '国家统计局 通用',\r\n            source: ['www.stats.gov.cn/*path'],\r\n            target: '/gov/stats/*path',\r\n        },\r\n    ],\r\n    description: `::: tip\r\n路径处填写对应页面 URL 中 \\`http://www.stats.gov.cn/\\` 后的字段。下面是一个例子。\r\n\r\n若订阅 [数据 > 数据解读](http://www.stats.gov.cn/sj/sjjd/)\r\n则将对应页面 URL \\`http://www.stats.gov.cn/sj/sjjd/\\` 中 \\`http://www.stats.gov.cn/\\` 后的字段 \\`sj/sjjd\\` 作为路径填入。\r\n此时路由为 [\\`/gov/stats/sj/sjjd\\`](https://rsshub.app/gov/stats/sj/sjjd)\r\n\r\n若订阅 [新闻 > 时政要闻 > 中央精神](http://www.stats.gov.cn/xw/szyw/zyjs/)\r\n则将对应页面 URL \\`http://www.stats.gov.cn/xw/szyw/zyjs/\\` 中 \\`http://www.stats.gov.cn/\\`\r\n后的字段 \\`xw/szyw/zyjs\\` 作为路径填入。此时路由为 [\\`/gov/stats/xw/szyw/zyjs\\`](https://rsshub.app/gov/stats/xw/szyw/zyjs)\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 15;\r\n    const rootUrl = 'http://www.stats.gov.cn';\r\n\r\n    const { headers } = await ofetch.raw(rootUrl);\r\n    const sid = headers\r\n        ?.getSetCookie()\r\n        .find((s) => s.startsWith('wzws_sessionid='))\r\n        ?.split(';')[0] as string;\r\n\r\n    const pathname = getSubPath(ctx) === '/stats' ? '/sj/zxfb/' : getSubPath(ctx).replace(/^\\/stats(.*)/, '$1');\r\n    const currentUrl = `${rootUrl}${pathname.endsWith('/') ? pathname : pathname + '/'}`;\r\n\r\n    const response = await ofetch(currentUrl, {\r\n        headers: {\r\n            Cookie: sid,\r\n            Referer: currentUrl,\r\n        },\r\n    });\r\n\r\n    const $ = load(response);\r\n\r\n    let items = $($('a.pchide').length === 0 ? 'a[title]' : '.list-content a.pchide')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                title: item.attr('title'),\r\n                link: new URL(item.attr('href'), currentUrl).href,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await ofetch(item.link, {\r\n                    headers: {\r\n                        Cookie: sid,\r\n                        Referer: rootUrl,\r\n                    },\r\n                });\r\n\r\n                const content = load(detailResponse);\r\n\r\n                // articles from www.news.cn or www.gov.cn\r\n\r\n                if (/(news\\.cn|www\\.gov\\.cn)/.test(item.link)) {\r\n                    if (content('.year').text()) {\r\n                        item.pubDate = timezone(parseDate(`${content('.year').text()}/${content('.day').text()} ${content('.time').text()}`, 'YYYY/MM/DD HH:mm:ss'), +8);\r\n                        item.author = content('.source')\r\n                            .text()\r\n                            .replace(/来源：/, '')\r\n                            .trim();\r\n                    } else {\r\n                        content('.pages_print').remove();\r\n\r\n                        const info = content('.info, .pages-date').text().split('来源：');\r\n                        item.pubDate = timezone(parseDate(info[0].trim()), +8);\r\n                        item.author = info.pop();\r\n                    }\r\n\r\n                    item.title = item.title || content('h1').first().text() || content('h2').first().text();\r\n                    item.description = content('#detail, .xlcontent, .pages_content').html();\r\n\r\n                    return item;\r\n                }\r\n\r\n                item.author = detailResponse.match(/来源：(.*?)</)?.[1]?.trim();\r\n\r\n                content('.pchide').remove();\r\n\r\n                item.title = item.title || content('div.detail-title h1').text();\r\n                item.pubDate = timezone(parseDate(content('div.detail-title-des h2 p, .info').first().text().trim()), +8);\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    description: content('.TRS_Editor').html() || content('.TRS_UEDITOR').html(),\r\n                    attachments: content('a[oldsrc]')\r\n                        .toArray()\r\n                        .map((a) => {\r\n                            a = $(a);\r\n                            return {\r\n                                link: new URL(a.attr('href'), item.link).href,\r\n                                name: a.text().trim(),\r\n                            };\r\n                        }),\r\n                });\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"6gBAWA,MAAa,EAAe,CACxB,KAAM,WACN,KAAM,WACN,IAAK,mBACL,WAAY,CAAC,cACb,YAAa,CAAC,SAAU,UAAW,gBACnC,QAAS,qBACT,UACA,MAAO,CACH,CACI,MAAO,WACP,OAAQ,CAAC,0BACT,OAAQ,qBAGhB,YAAa,iiBAajB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,GAC3E,EAAU,0BAEV,CAAE,WAAY,MAAM,EAAO,IAAI,GAC/B,EAAM,GACN,eACD,KAAM,GAAM,EAAE,WAAW,qBACxB,MAAM,KAAK,GAEX,EAAW,EAAW,KAAS,SAAW,YAAc,EAAW,GAAK,QAAQ,eAAgB,MAChG,EAAa,GAAG,IAAU,EAAS,SAAS,KAAO,EAAW,EAAW,MAEzE,EAAW,MAAM,EAAO,EAAY,CACtC,QAAS,CACL,OAAQ,EACR,QAAS,KAIX,EAAI,EAAK,GAEX,EAAQ,EAAE,EAAE,YAAY,SAAW,EAAI,WAAa,0BACnD,MAAM,EAAG,GACT,UACA,IAAK,IACF,EAAO,EAAE,GAEF,CACH,MAAO,EAAK,KAAK,SACjB,KAAM,IAAI,IAAI,EAAK,KAAK,QAAS,GAAY,QA+DzD,MA3DA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAO,EAAK,KAAM,CAC3C,QAAS,CACL,OAAQ,EACR,QAAS,KAIX,EAAU,EAAK,GAIrB,GAAI,0BAA0B,KAAK,EAAK,MAAO,CAC3C,GAAI,EAAQ,SAAS,OACjB,EAAK,QAAU,EAAS,EAAU,GAAG,EAAQ,SAAS,OAAO,GAAG,EAAQ,QAAQ,OAAO,GAAG,EAAQ,SAAS,SAAU,uBAAwB,GAC7I,EAAK,OAAS,EAAQ,WACjB,OACA,QAAQ,MAAO,IACf,WACF,CACH,EAAQ,gBAAgB,SAExB,IAAM,EAAO,EAAQ,sBAAsB,OAAO,MAAM,OACxD,EAAK,QAAU,EAAS,EAAU,EAAK,GAAG,QAAS,GACnD,EAAK,OAAS,EAAK,MAMvB,MAHA,GAAK,MAAQ,EAAK,OAAS,EAAQ,MAAM,QAAQ,QAAU,EAAQ,MAAM,QAAQ,OACjF,EAAK,YAAc,EAAQ,uCAAuC,OAE3D,EAsBX,MAnBA,GAAK,OAAS,EAAe,MAAM,eAAe,IAAI,OAEtD,EAAQ,WAAW,SAEnB,EAAK,MAAQ,EAAK,OAAS,EAAQ,uBAAuB,OAC1D,EAAK,QAAU,EAAS,EAAU,EAAQ,oCAAoC,QAAQ,OAAO,QAAS,GACtG,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACtE,YAAa,EAAQ,eAAe,QAAU,EAAQ,gBAAgB,OACtE,YAAa,EAAQ,aAChB,UACA,IAAK,IACF,EAAI,EAAE,GACC,CACH,KAAM,IAAI,IAAI,EAAE,KAAK,QAAS,EAAK,MAAM,KACzC,KAAM,EAAE,OAAO,YAKxB,MAKZ,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM"}