{"version":3,"file":"geekpark-tUKK9wcG.js","names":[],"sources":["../../lib/routes/geekpark/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const handler = async (ctx) => {\r\n    const { column } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 20;\r\n\r\n    const rootUrl = 'https://geekpark.net';\r\n    const apiRootUrl = 'https://mainssl.geekpark.net';\r\n    const currentUrl = new URL(column ? `column/${column}` : '', rootUrl).href;\r\n    const apiUrl = new URL(column ? `api/v1/columns/${column}` : 'api/v2', apiRootUrl).href;\r\n\r\n    const { data: response } = await got(apiUrl);\r\n\r\n    let items = (response.homepage_posts ?? response.column.posts).slice(0, limit).map((item) => {\r\n        item = item.post ?? item;\r\n\r\n        const title = item.title;\r\n        const image = item.cover_url;\r\n        const description = art(path.join(__dirname, 'templates/description.art'), {\r\n            image: image\r\n                ? [\r\n                      {\r\n                          src: image,\r\n                          alt: title,\r\n                      },\r\n                  ]\r\n                : undefined,\r\n            intro: item.abstract,\r\n        });\r\n        const guid = `geekpark-${item.id}`;\r\n\r\n        return {\r\n            title,\r\n            description,\r\n            pubDate: parseDate(item.published_timestamp, 'X'),\r\n            link: new URL(`api/v1/posts/${item.id}`, apiRootUrl).href,\r\n            category: [...new Set([...item.tags, item.column?.title])].filter(Boolean),\r\n            author: item.authors.map((a) => a.realname ?? a.nickname).join('/'),\r\n            guid,\r\n            id: guid,\r\n            content: {\r\n                html: description,\r\n                text: item.abstract,\r\n            },\r\n            image,\r\n            banner: image,\r\n        };\r\n    });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const data = detailResponse.post;\r\n\r\n                const title = data.title;\r\n                const image = data.cover_url;\r\n                const description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    image: image\r\n                        ? [\r\n                              {\r\n                                  src: image,\r\n                                  alt: title,\r\n                              },\r\n                          ]\r\n                        : undefined,\r\n                    intro: data.abstract,\r\n                    description: data.content,\r\n                });\r\n                const guid = `geekpark-${data.id}`;\r\n\r\n                item.title = title;\r\n                item.description = description;\r\n                item.pubDate = parseDate(data.published_timestamp, 'X');\r\n                item.link = new URL(`news/${data.id}`, rootUrl).href;\r\n                item.category = [...new Set([...data.tags, data.column?.title])].filter(Boolean);\r\n                item.author = data.authors.map((a) => a.realname ?? a.nickname).join('/');\r\n                item.guid = guid;\r\n                item.id = guid;\r\n                item.content = {\r\n                    html: description,\r\n                    text: data.content,\r\n                };\r\n                item.image = image;\r\n                item.banner = image;\r\n                item.updated = parseDate(data.updated_at);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const data = {\r\n        title: '',\r\n        description: '',\r\n        link: currentUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image: '',\r\n        author: '',\r\n    };\r\n\r\n    if (column) {\r\n        data.title = `${response.column.title} | 极客公园`;\r\n        data.description = response.column.description;\r\n        data.image = response.column.banner_url;\r\n    } else {\r\n        const { data: currentResponse } = await got(currentUrl);\r\n\r\n        const $ = load(currentResponse);\r\n\r\n        data.title = $('title').text();\r\n        data.description = $('meta[property=\"og:description\"]').prop('content');\r\n        data.image = `https:${$('meta[name=\"og:image\"]').prop('content')}`;\r\n        data.author = $('meta[property=\"og:site_name\"]').prop('content');\r\n    }\r\n\r\n    return data;\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:column?',\r\n    name: '栏目',\r\n    url: 'geekpark.net',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/geekpark',\r\n    parameters: { column: '栏目 id，默认为空，即首页资讯，可在对应栏目页 URL 中找到' },\r\n    description: `::: tip\r\n  若订阅 [综合报道](https://www.geekpark.net/column/179)，网址为 \\`https://www.geekpark.net/column/179\\`。截取 \\`https://www.geekpark.net/column/\\` 到末尾的部分 \\`179\\` 作为参数填入，此时路由为 [\\`/geekpark/179\\`](https://rsshub.app/geekpark/179)。\r\n:::\r\n\r\n| 栏目                                                         | ID                                     |\r\n| ------------------------------------------------------------ | -------------------------------------- |\r\n| [综合报道](https://www.geekpark.net/column/179)              | [179](https://rsshub.app/geekpark/179) |\r\n| [AI新浪潮观察](https://www.geekpark.net/column/304)          | [304](https://rsshub.app/geekpark/304) |\r\n| [新造车观察](https://www.geekpark.net/column/305)            | [305](https://rsshub.app/geekpark/305) |\r\n| [财报解读](https://www.geekpark.net/column/271)              | [271](https://rsshub.app/geekpark/271) |\r\n| [底稿对话CEO系列](https://www.geekpark.net/column/308)       | [308](https://rsshub.app/geekpark/308) |\r\n| [Geek Insight 特稿系列](https://www.geekpark.net/column/306) | [306](https://rsshub.app/geekpark/306) |\r\n| [心科技](https://www.geekpark.net/column/307)                | [307](https://rsshub.app/geekpark/307) |\r\n| [行业资讯](https://www.geekpark.net/column/2)                | [2](https://rsshub.app/geekpark/2)     |\r\n  `,\r\n    categories: ['new-media'],\r\n\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['geekpark.net'],\r\n            target: '/',\r\n        },\r\n        {\r\n            source: ['geekpark.net/column/:column?'],\r\n            target: (params) => {\r\n                const column = params.column;\r\n\r\n                return column ? `/${column}` : '';\r\n            },\r\n        },\r\n        {\r\n            title: '综合报道',\r\n            source: ['www.geekpark.net/column/179'],\r\n            target: '/179',\r\n        },\r\n        {\r\n            title: 'AI新浪潮观察',\r\n            source: ['www.geekpark.net/column/304'],\r\n            target: '/304',\r\n        },\r\n        {\r\n            title: '新造车观察',\r\n            source: ['www.geekpark.net/column/305'],\r\n            target: '/305',\r\n        },\r\n        {\r\n            title: '财报解读',\r\n            source: ['www.geekpark.net/column/271'],\r\n            target: '/271',\r\n        },\r\n        {\r\n            title: '底稿对话CEO系列',\r\n            source: ['www.geekpark.net/column/308'],\r\n            target: '/308',\r\n        },\r\n        {\r\n            title: 'Geek Insight 特稿系列',\r\n            source: ['www.geekpark.net/column/306'],\r\n            target: '/306',\r\n        },\r\n        {\r\n            title: '心科技',\r\n            source: ['www.geekpark.net/column/307'],\r\n            target: '/307',\r\n        },\r\n        {\r\n            title: '行业资讯',\r\n            source: ['www.geekpark.net/column/2'],\r\n            target: '/2',\r\n        },\r\n    ],\r\n};\r\n"],"mappings":"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"}