{"version":3,"file":"subscriptions-CxU36r7K.js","names":["route: Route","ConfigNotFoundError","utils","cache"],"sources":["../../lib/routes/youtube/subscriptions.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\nimport utils from './utils';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport pMap from 'p-map';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/subscriptions/:embed?',\r\n    categories: ['social-media'],\r\n    example: '/youtube/subscriptions',\r\n    parameters: { embed: 'Default to embed the video, set to any value to disable embedding' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'YOUTUBE_KEY',\r\n                description: '',\r\n            },\r\n            {\r\n                name: 'YOUTUBE_CLIENT_ID',\r\n                description: '',\r\n            },\r\n            {\r\n                name: 'YOUTUBE_CLIENT_SECRET',\r\n                description: '',\r\n            },\r\n            {\r\n                name: 'YOUTUBE_REFRESH_TOKEN',\r\n                description: '',\r\n            },\r\n        ],\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.youtube.com/feed/subscriptions', 'www.youtube.com/feed/channels'],\r\n            target: '/subscriptions',\r\n        },\r\n    ],\r\n    name: 'Subscriptions',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n    url: 'www.youtube.com/feed/subscriptions',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.youtube || !config.youtube.key || !config.youtube.clientId || !config.youtube.clientSecret || !config.youtube.refreshToken) {\r\n        throw new ConfigNotFoundError('YouTube RSS is disabled due to the lack of <a href=\"https://docs.rsshub.app/deploy/config#route-specific-configurations\">relevant config</a>');\r\n    }\r\n    const embed = !ctx.req.param('embed');\r\n\r\n    const channelIds = (await utils.getSubscriptions('snippet', cache)).data.items.map((item) => item.snippet.resourceId.channelId);\r\n\r\n    const playlistIds = await pMap(channelIds, async (channelId) => (await utils.getChannelWithId(channelId, 'contentDetails', cache)).data.items[0].contentDetails.relatedPlaylists.uploads, { concurrency: 30 });\r\n\r\n    let items = await pMap(playlistIds, async (playlistId) => (await utils.getPlaylistItems(playlistId, 'snippet', cache))?.data.items, { concurrency: 30 });\r\n\r\n    items = items.flat();\r\n\r\n    items = items\r\n        .filter((i) => i && !i.error && i.snippet.title !== 'Private video' && i.snippet.title !== 'Deleted video')\r\n        .map((item) => {\r\n            const snippet = item.snippet;\r\n            const videoId = snippet.resourceId.videoId;\r\n            const img = utils.getThumbnail(snippet.thumbnails);\r\n            return {\r\n                title: snippet.title,\r\n                description: utils.renderDescription(embed, videoId, img, utils.formatDescription(snippet.description)),\r\n                pubDate: parseDate(snippet.publishedAt),\r\n                link: `https://www.youtube.com/watch?v=${videoId}`,\r\n                author: snippet.videoOwnerChannelTitle,\r\n                image: img.url,\r\n            };\r\n        });\r\n\r\n    const ret = {\r\n        title: 'Subscriptions - YouTube',\r\n        description: 'YouTube Subscriptions',\r\n        link: 'www.youtube.com/feed/subscriptions',\r\n        item: items,\r\n    };\r\n\r\n    ctx.set('json', {\r\n        ...ret,\r\n        channelIds,\r\n        playlistIds,\r\n    });\r\n    return ret;\r\n}\r\n"],"mappings":"4dAQA,MAAaA,EAAe,CACxB,KAAM,yBACN,WAAY,CAAC,gBACb,QAAS,yBACT,WAAY,CAAE,MAAO,qEACrB,SAAU,CACN,cAAe,CACX,CACI,KAAM,cACN,YAAa,IAEjB,CACI,KAAM,oBACN,YAAa,IAEjB,CACI,KAAM,wBACN,YAAa,IAEjB,CACI,KAAM,wBACN,YAAa,MAIzB,MAAO,CACH,CACI,OAAQ,CAAC,qCAAsC,iCAC/C,OAAQ,mBAGhB,KAAM,gBACN,YAAa,CAAC,UACd,UACA,IAAK,sCAGT,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,SAAW,CAAC,EAAO,QAAQ,KAAO,CAAC,EAAO,QAAQ,UAAY,CAAC,EAAO,QAAQ,cAAgB,CAAC,EAAO,QAAQ,aACtH,MAAM,IAAIC,EAAoB,gJAElC,IAAM,EAAQ,CAAC,EAAI,IAAI,MAAM,SAEvB,GAAc,MAAMC,EAAM,iBAAiB,UAAWC,IAAQ,KAAK,MAAM,IAAK,GAAS,EAAK,QAAQ,WAAW,WAE/G,EAAc,MAAM,EAAK,EAAY,KAAO,KAAe,MAAMD,EAAM,iBAAiB,EAAW,iBAAkBC,IAAQ,KAAK,MAAM,GAAG,eAAe,iBAAiB,QAAS,CAAE,YAAa,KAErM,EAAQ,MAAM,EAAK,EAAa,KAAO,KAAgB,MAAMD,EAAM,iBAAiB,EAAY,UAAWC,KAAS,KAAK,MAAO,CAAE,YAAa,KAEnJ,EAAQ,EAAM,OAEd,EAAQ,EACH,OAAQ,GAAM,GAAK,CAAC,EAAE,OAAS,EAAE,QAAQ,QAAU,iBAAmB,EAAE,QAAQ,QAAU,iBAC1F,IAAK,GAAS,CACX,IAAM,EAAU,EAAK,QACf,EAAU,EAAQ,WAAW,QAC7B,EAAMD,EAAM,aAAa,EAAQ,YACvC,MAAO,CACH,MAAO,EAAQ,MACf,YAAaA,EAAM,kBAAkB,EAAO,EAAS,EAAKA,EAAM,kBAAkB,EAAQ,cAC1F,QAAS,EAAU,EAAQ,aAC3B,KAAM,mCAAmC,IACzC,OAAQ,EAAQ,uBAChB,MAAO,EAAI,OAIvB,IAAM,EAAM,CACR,MAAO,0BACP,YAAa,wBACb,KAAM,qCACN,KAAM,GAQV,OALA,EAAI,IAAI,OAAQ,CACZ,GAAG,EACH,aACA,gBAEG"}