{"version":3,"file":"book-series-DUzL5iPR.js","names":[],"sources":["../../lib/routes/routledge/book-series.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/:bookName/book-series/:bookId',\r\n    radar: [\r\n        {\r\n            source: ['routledge.com/:bookName/book-series/:bookId'],\r\n        },\r\n    ],\r\n    name: 'Unknown',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { bookName, bookId } = ctx.req.param();\r\n    const baseUrl = 'https://www.routledge.com';\r\n    const pageUrl = `${baseUrl}/${bookName}/book-series/${bookId}`;\r\n    const { data: response } = await got(pageUrl, {\r\n        headers: {\r\n            accept: 'text/html, */*; q=0.01',\r\n        },\r\n        searchParams: {\r\n            publishedFilter: 'alltitles',\r\n            pd: 'published,forthcoming',\r\n            pg: 1,\r\n            pp: 12,\r\n            so: 'pub',\r\n            view: 'list',\r\n        },\r\n    });\r\n    const $ = load(response);\r\n\r\n    const list = $('.row.book')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            const title = item.find('h3 a');\r\n            const description = item.find('p.description');\r\n            const meta = item.find('p.description').prev().text().split('\\n');\r\n            return {\r\n                title: title.text(),\r\n                link: title.attr('href'),\r\n                description: description.text(),\r\n                pubDate: parseDate(meta.pop().trim(), 'MMMM DD, YYYY'),\r\n                author: meta\r\n                    .map((i) => i.trim())\r\n                    .filter(Boolean)\r\n                    .join(', '),\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data } = await got(item.link);\r\n                const $ = load(data);\r\n                const isbn = $('meta[property=\"books:isbn\"]').attr('content');\r\n                const { data: image } = await got('https://productimages.routledge.com', {\r\n                    searchParams: {\r\n                        isbn,\r\n                        size: 'amazon',\r\n                        ext: 'jpg',\r\n                    },\r\n                });\r\n\r\n                const description = $('.sticky-div');\r\n                description.find('button.accordion-button').contents().unwrap();\r\n                description.find('.fa-shopping-cart').parent().parent().remove();\r\n\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    image,\r\n                    description: description.html(),\r\n                });\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('head title').text(),\r\n        description: $('head meta[name=\"description\"]').attr('content'),\r\n        link: pageUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,iCACN,MAAO,CACH,CACI,OAAQ,CAAC,iDAGjB,KAAM,UACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAU,UAAW,EAAI,IAAI,QAE/B,EAAU,6BAAc,EAAS,eAAe,IAChD,CAAE,KAAM,GAAa,MAAM,EAAI,EAAS,CAC1C,QAAS,CACL,OAAQ,0BAEZ,aAAc,CACV,gBAAiB,YACjB,GAAI,wBACJ,GAAI,EACJ,GAAI,GACJ,GAAI,MACJ,KAAM,UAGR,EAAI,EAAK,GAET,EAAO,EAAE,aACV,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GACT,IAAM,EAAQ,EAAK,KAAK,QAClB,EAAc,EAAK,KAAK,iBACxB,EAAO,EAAK,KAAK,iBAAiB,OAAO,OAAO,MAAM;GAC5D,MAAO,CACH,MAAO,EAAM,OACb,KAAM,EAAM,KAAK,QACjB,YAAa,EAAY,OACzB,QAAS,EAAU,EAAK,MAAM,OAAQ,iBACtC,OAAQ,EACH,IAAK,GAAM,EAAE,QACb,OAAO,SACP,KAAK,SAIhB,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,QAAS,MAAM,EAAI,EAAK,MAC1B,EAAI,EAAK,GACT,EAAO,EAAE,+BAA+B,KAAK,WAC7C,CAAE,KAAM,GAAU,MAAM,EAAI,sCAAuC,CACrE,aAAc,CACV,OACA,KAAM,SACN,IAAK,SAIP,EAAc,EAAE,eAQtB,OAPA,EAAY,KAAK,2BAA2B,WAAW,SACvD,EAAY,KAAK,qBAAqB,SAAS,SAAS,SAExD,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACtE,QACA,YAAa,EAAY,SAEtB,MAKnB,MAAO,CACH,MAAO,EAAE,cAAc,OACvB,YAAa,EAAE,iCAAiC,KAAK,WACrD,KAAM,EACN,KAAM"}