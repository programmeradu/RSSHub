{"version":3,"file":"cloudflareyes-B2UiI0F1.js","names":[],"sources":["../../lib/routes/hostmonit/cloudflareyes.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst lines = {\r\n    CM: '中国移动',\r\n    CU: '中国联通',\r\n    CT: '中国电信',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/cloudflareyes/:type?',\r\n    categories: ['other'],\r\n    example: '/hostmonit/cloudflareyes',\r\n    parameters: { type: '类型，见下表，默认为 v4' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'CloudFlareYes',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    description: `| v4 | v6 |\r\n| -- | -- |\r\n|    | v6 |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { type = 'v4' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 30;\r\n\r\n    const domain = 'hostmonit.com';\r\n    const title = `CloudFlareYes${type === 'v6' ? type.toUpperCase() : ''}`;\r\n\r\n    const rootUrl = `https://stock.${domain}`;\r\n    const rootApiUrl = `https://api.${domain}`;\r\n    const apiUrl = new URL('get_optimization_ip', rootApiUrl).href;\r\n    const currentUrl = new URL(title, rootUrl).href;\r\n\r\n    const key = 'iDetkOys';\r\n\r\n    const { data: response } = await got.post(apiUrl, {\r\n        json: {\r\n            key,\r\n            ...(type === 'v6'\r\n                ? {\r\n                      type: 'v6',\r\n                  }\r\n                : {}),\r\n        },\r\n    });\r\n\r\n    const items = response.info.slice(0, limit).map((item) => {\r\n        const ip = item.ip;\r\n        const latency = item.latency === undefined ? undefined : `${item.latency}ms`;\r\n        const line = item.line === undefined ? undefined : Object.hasOwn(lines, item.line) ? lines[item.line] : item.line;\r\n        const loss = item.loss === undefined ? undefined : `${item.loss}%`;\r\n        const node = item.node;\r\n        const speed = item.speed === undefined ? undefined : `${item.speed} KB/s`;\r\n        const pubDate = timezone(parseDate(item.time), +8);\r\n\r\n        return {\r\n            title: art(path.join(__dirname, 'templates/title.art'), {\r\n                line,\r\n                latency,\r\n                loss,\r\n                speed,\r\n                node,\r\n                ip,\r\n            }),\r\n            link: currentUrl,\r\n            description: art(path.join(__dirname, 'templates/description.art'), {\r\n                line,\r\n                node,\r\n                ip,\r\n                latency,\r\n                loss,\r\n                speed,\r\n            }),\r\n            author: node,\r\n            category: [line, latency, loss, node].filter(Boolean),\r\n            guid: `${domain}-${title}-${ip}#${pubDate.toISOString()}`,\r\n            pubDate,\r\n        };\r\n    });\r\n\r\n    const { data: currentResponse } = await got(currentUrl);\r\n\r\n    const $ = load(currentResponse);\r\n\r\n    const icon = new URL($('link[rel=\"icon\"]').prop('href'), rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title: $('title').text().replace(/- .*$/, `- ${title}`),\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        icon,\r\n        logo: icon,\r\n        subtitle: title,\r\n        author: $('title').text().split(/\\s-/)[0],\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"sdASA,MAAM,EAAQ,CACV,GAAI,OACJ,GAAI,OACJ,GAAI,QAGK,EAAe,CACxB,KAAM,wBACN,WAAY,CAAC,SACb,QAAS,2BACT,WAAY,CAAE,KAAM,iBACpB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,gBACN,YAAa,CAAC,WACd,UACA,YAAa;;cAKjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAO,MAAS,EAAI,IAAI,QAC1B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAS,gBACT,EAAQ,gBAAgB,IAAS,KAAO,EAAK,cAAgB,KAE7D,EAAU,iBAAiB,IAC3B,EAAa,eAAe,IAC5B,EAAS,IAAI,IAAI,sBAAuB,GAAY,KACpD,EAAa,IAAI,IAAI,EAAO,GAAS,KAIrC,CAAE,KAAM,GAAa,MAAM,EAAI,KAAK,EAAQ,CAC9C,KAAM,CACF,eACA,GAAI,IAAS,KACP,CACI,KAAM,MAEV,MAIR,EAAQ,EAAS,KAAK,MAAM,EAAG,GAAO,IAAK,GAAS,CACtD,IAAM,EAAK,EAAK,GACV,EAAU,EAAK,UAAY,IAAA,GAAY,IAAA,GAAY,GAAG,EAAK,QAAQ,IACnE,EAAO,EAAK,OAAS,IAAA,GAAY,IAAA,GAAY,OAAO,OAAO,EAAO,EAAK,MAAQ,EAAM,EAAK,MAAQ,EAAK,KACvG,EAAO,EAAK,OAAS,IAAA,GAAY,IAAA,GAAY,GAAG,EAAK,KAAK,GAC1D,EAAO,EAAK,KACZ,EAAQ,EAAK,QAAU,IAAA,GAAY,IAAA,GAAY,GAAG,EAAK,MAAM,OAC7D,EAAU,EAAS,EAAU,EAAK,MAAO,GAE/C,MAAO,CACH,MAAO,EAAI,EAAA,KAAA,EAAA,gCAA6C,CACpD,OACA,UACA,OACA,QACA,OACA,OAEJ,KAAM,EACN,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,OACA,OACA,KACA,UACA,OACA,UAEJ,OAAQ,EACR,SAAU,CAAC,EAAM,EAAS,EAAM,GAAM,OAAO,SAC7C,KAAM,GAAG,EAAO,GAAG,EAAM,GAAG,EAAG,GAAG,EAAQ,gBAC1C,aAIF,CAAE,KAAM,GAAoB,MAAM,EAAI,GAEtC,EAAI,EAAK,GAET,EAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,QAAS,GAAS,KAElE,MAAO,CACH,KAAM,EACN,MAAO,EAAE,SAAS,OAAO,QAAQ,QAAS,KAAK,KAC/C,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,EAAE,QAAQ,KAAK,QACzB,OACA,KAAM,EACN,SAAU,EACV,OAAQ,EAAE,SAAS,OAAO,MAAM,OAAO,GACvC,WAAY"}