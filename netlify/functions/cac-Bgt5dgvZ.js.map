{"version":3,"file":"cac-Bgt5dgvZ.js","names":["route: Route","cache","got","path"],"sources":["../../lib/routes/gov/cac/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/cac/*',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const path = ctx.params[0];\r\n    const host = 'http://www.cac.gov.cn';\r\n    const homepage = `${host}/index.htm`;\r\n    // 在首页查找出所有的目录完整路径，比如http://www.cac.gov.cn/xxh/A0906index_1.htm\r\n    // xxh --> {\"path\": \"/xxh\", \"completeUrl\": \"http://www.cac.gov.cn/xxh/A0906index_1.htm\"}\r\n    const pathList = await cache.tryGet(\r\n        'gov:cac:pathList',\r\n        async () => {\r\n            const { data: homepageResponse } = await got(homepage);\r\n            const $ = load(homepageResponse);\r\n            return $('a')\r\n                .toArray()\r\n                .map((item) => {\r\n                    const href = $(item).attr('href');\r\n                    if (href && /(?:http:)?\\/\\/www\\.cac\\.gov\\.cn(.*?)\\/(A.*?\\.htm)/.test(href)) {\r\n                        const matchArray = href.match(/(?:http:)?\\/\\/www\\.cac\\.gov\\.cn(.*?)\\/(A.*?\\.htm)/);\r\n                        if (matchArray && matchArray.length > 2) {\r\n                            const path = matchArray[1];\r\n                            const htmlName = matchArray[2];\r\n                            return {\r\n                                path,\r\n                                completeUrl: `${host}${path}/${htmlName}`,\r\n                            };\r\n                        }\r\n                    }\r\n                    return null;\r\n                })\r\n                .filter(Boolean);\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const completeUrl = pathList.find((item) => item && item.path === path).completeUrl;\r\n    const { data: channelResponse } = await got(completeUrl);\r\n    const $1 = load(channelResponse);\r\n    const items = $1('div#loadingInfoPage li')\r\n        .toArray()\r\n        .map((item) => {\r\n            const c = $1(item);\r\n            const a = c.find('a');\r\n            const articleHref = a.attr('href');\r\n            const title = a.text();\r\n            const date = parseDate(c.find('.times').text());\r\n            return {\r\n                link: articleHref,\r\n                pubDate: timezone(date),\r\n                title,\r\n                description: title,\r\n            };\r\n        });\r\n    return {\r\n        title: $1('head title').text(),\r\n        link: completeUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"2aAQA,MAAaA,EAAe,CACxB,KAAM,SACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,OAAO,GAClB,EAAO,wBACP,EAAW,GAAG,EAAK,YAGnB,EAAW,MAAMC,EAAM,OACzB,mBACA,SAAY,CACR,GAAM,CAAE,KAAM,GAAqB,MAAMC,EAAI,GACvC,EAAI,EAAK,GACf,OAAO,EAAE,KACJ,UACA,IAAK,GAAS,CACX,IAAM,EAAO,EAAE,GAAM,KAAK,QAC1B,GAAI,GAAQ,oDAAoD,KAAK,GAAO,CACxE,IAAM,EAAa,EAAK,MAAM,qDAC9B,GAAI,GAAc,EAAW,OAAS,EAAG,CACrC,IAAMC,EAAO,EAAW,GAClB,EAAW,EAAW,GAC5B,MAAO,CACH,KAAA,EACA,YAAa,GAAG,IAAOA,EAAK,GAAG,MAI3C,OAAO,OAEV,OAAO,UAEhB,EAAO,MAAM,YACb,IAGE,EAAc,EAAS,KAAM,GAAS,GAAQ,EAAK,OAAS,GAAM,YAClE,CAAE,KAAM,GAAoB,MAAMD,EAAI,GACtC,EAAK,EAAK,GACV,EAAQ,EAAG,0BACZ,UACA,IAAK,GAAS,CACX,IAAM,EAAI,EAAG,GACP,EAAI,EAAE,KAAK,KACX,EAAc,EAAE,KAAK,QACrB,EAAQ,EAAE,OACV,EAAO,EAAU,EAAE,KAAK,UAAU,QACxC,MAAO,CACH,KAAM,EACN,QAAS,EAAS,GAClB,QACA,YAAa,KAGzB,MAAO,CACH,MAAO,EAAG,cAAc,OACxB,KAAM,EACN,KAAM"}