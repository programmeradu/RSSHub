{"version":3,"file":"common-config-CDg6Z-H3.js","names":["parseDate","_parseDate","timezone","_timezone","ofetch"],"sources":["../../lib/utils/common-config.ts"],"sourcesContent":["import { load } from 'cheerio';\r\nimport ofetch from '@/utils/ofetch';\r\nimport iconv from 'iconv-lite';\r\nimport { parseDate as _parseDate } from '@/utils/parse-date';\r\nimport _timezone from '@/utils/timezone';\r\n\r\nfunction transElemText($, prop) {\r\n    const regex = /\\$\\((.*)\\)/g;\r\n    let result = prop;\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const parseDate = _parseDate;\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const timezone = _timezone;\r\n    if (regex.test(result)) {\r\n        // eslint-disable-next-line no-eval\r\n        result = eval(result);\r\n    }\r\n    return result;\r\n}\r\n\r\nfunction replaceParams(data, prop, $) {\r\n    const regex = /%(.*)%/g;\r\n    let result = prop;\r\n    let group = regex.exec(prop);\r\n    while (group) {\r\n        // FIXME Multi vars\r\n        result = result.replace(group[0], transElemText($, data.params[group[1]]));\r\n        group = regex.exec(prop);\r\n    }\r\n    return result;\r\n}\r\n\r\nfunction getProp(data, prop, $) {\r\n    let result = data;\r\n    if (Array.isArray(prop)) {\r\n        for (const e of prop) {\r\n            result = transElemText($, result[e]);\r\n        }\r\n    } else {\r\n        result = transElemText($, result[prop]);\r\n    }\r\n    return replaceParams(data, result, $);\r\n}\r\n\r\nasync function buildData(data) {\r\n    const response = await ofetch.raw(data.url);\r\n    const contentType = response.headers.get('content-type') || '';\r\n    // 若没有指定编码，则默认utf-8\r\n    let charset = 'utf-8';\r\n    for (const attr of contentType.split(';')) {\r\n        if (attr.includes('charset=')) {\r\n            charset = (attr.split('=').pop() || 'utf-8').toLowerCase();\r\n        }\r\n    }\r\n    // @ts-expect-error custom property\r\n    const responseData = charset === 'utf-8' ? response._data : iconv.decode(await ofetch(data.url, { responseType: 'buffer' }), charset);\r\n    const $ = load(responseData);\r\n    const $item = $(data.item.item);\r\n    // 这里应该是可以通过参数注入一些代码的，不过应该无伤大雅\r\n    return {\r\n        link: data.link,\r\n        title: getProp(data, 'title', $),\r\n        description: getProp(data, 'description', $),\r\n        allowEmpty: data.allowEmpty || false,\r\n        item: $item.toArray().map((e) => {\r\n            const $elem = (selector) => $(e).find(selector);\r\n            return {\r\n                title: getProp(data, ['item', 'title'], $elem),\r\n                description: getProp(data, ['item', 'description'], $elem),\r\n                pubDate: getProp(data, ['item', 'pubDate'], $elem),\r\n                link: getProp(data, ['item', 'link'], $elem),\r\n                guid: getProp(data, ['item', 'guid'], $elem),\r\n            };\r\n        }),\r\n    };\r\n}\r\n\r\nexport default buildData;\r\nexport { transElemText, replaceParams, getProp };\r\n"],"mappings":"sMAMA,SAAS,cAAc,EAAG,KAAM,CAC5B,IAAM,MAAQ,cACV,OAAS,KAEPA,YAAYC,UAEZC,WAAWC,SAKjB,OAJI,MAAM,KAAK,UAEX,OAAS,KAAK,SAEX,OAGX,SAAS,cAAc,KAAM,KAAM,EAAG,CAClC,IAAM,MAAQ,UACV,OAAS,KACT,MAAQ,MAAM,KAAK,MACvB,KAAO,OAEH,OAAS,OAAO,QAAQ,MAAM,GAAI,cAAc,EAAG,KAAK,OAAO,MAAM,MACrE,MAAQ,MAAM,KAAK,MAEvB,OAAO,OAGX,SAAS,QAAQ,KAAM,KAAM,EAAG,CAC5B,IAAI,OAAS,KACb,GAAI,MAAM,QAAQ,MACd,IAAK,IAAM,KAAK,KACZ,OAAS,cAAc,EAAG,OAAO,SAGrC,OAAS,cAAc,EAAG,OAAO,OAErC,OAAO,cAAc,KAAM,OAAQ,GAGvC,eAAe,UAAU,KAAM,CAC3B,IAAM,SAAW,MAAMC,eAAO,IAAI,KAAK,KACjC,YAAc,SAAS,QAAQ,IAAI,iBAAmB,GAExD,QAAU,QACd,IAAK,IAAM,QAAQ,YAAY,MAAM,KAC7B,KAAK,SAAS,cACd,SAAW,KAAK,MAAM,KAAK,OAAS,SAAS,eAIrD,IAAM,aAAe,UAAY,QAAU,SAAS,MAAQ,MAAM,OAAO,MAAMA,eAAO,KAAK,IAAK,CAAE,aAAc,WAAa,SACvH,EAAI,KAAK,cACT,MAAQ,EAAE,KAAK,KAAK,MAE1B,MAAO,CACH,KAAM,KAAK,KACX,MAAO,QAAQ,KAAM,QAAS,GAC9B,YAAa,QAAQ,KAAM,cAAe,GAC1C,WAAY,KAAK,YAAc,GAC/B,KAAM,MAAM,UAAU,IAAK,GAAM,CAC7B,IAAM,MAAS,UAAa,EAAE,GAAG,KAAK,UACtC,MAAO,CACH,MAAO,QAAQ,KAAM,CAAC,OAAQ,SAAU,OACxC,YAAa,QAAQ,KAAM,CAAC,OAAQ,eAAgB,OACpD,QAAS,QAAQ,KAAM,CAAC,OAAQ,WAAY,OAC5C,KAAM,QAAQ,KAAM,CAAC,OAAQ,QAAS,OACtC,KAAM,QAAQ,KAAM,CAAC,OAAQ,QAAS,WAMtD,IAAA,sBAAe"}