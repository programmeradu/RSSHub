{"version":3,"file":"danmaku-CuZXb0F8.js","names":["route: Route","cache","got","zlib"],"sources":["../../lib/routes/bilibili/danmaku.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport { load } from 'cheerio';\r\nimport cache from './cache';\r\nimport got from '@/utils/got';\r\nimport zlib from 'node:zlib';\r\n\r\nconst processFloatTime = (time) => {\r\n    const totalSeconds = Number.parseInt(time);\r\n    const seconds = totalSeconds % 60;\r\n    const minutes = ((totalSeconds - seconds) / 60) % 60;\r\n    const hours = (totalSeconds - seconds - 60 * minutes) / 3600;\r\n    return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/video/danmaku/:bvid/:pid?',\r\n    categories: ['social-media'],\r\n    example: '/bilibili/video/danmaku/BV1vA411b7ip/1',\r\n    parameters: { bvid: '视频AV号,可在视频页 URL 中找到', pid: '分P号,不填默认为1' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '视频弹幕',\r\n    maintainers: ['Qixingchen'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    let bvid = ctx.req.param('bvid');\r\n    let aid;\r\n    if (!bvid.startsWith('BV')) {\r\n        aid = bvid;\r\n        bvid = null;\r\n    }\r\n    const pid = Number(ctx.req.param('pid') || 1);\r\n    const limit = 50;\r\n    const cid = await cache.getCidFromId(aid, pid, bvid);\r\n\r\n    const videoName = await cache.getVideoNameFromId(aid, bvid);\r\n\r\n    const link = `https://www.bilibili.com/video/${bvid || `av${aid}`}`;\r\n    const danmakuResponse = await got.get(`https://comment.bilibili.com/${cid}.xml`, {\r\n        decompress: false,\r\n        responseType: 'buffer',\r\n        headers: {\r\n            Referer: link,\r\n        },\r\n    });\r\n\r\n    let danmakuText = danmakuResponse.body;\r\n\r\n    danmakuText = await ((danmakuText[0] & 0x0F) === 0x08 ? zlib.inflateSync(danmakuText) : zlib.inflateRawSync(danmakuText));\r\n\r\n    let danmakuList = [];\r\n    const $ = load(danmakuText, { xmlMode: true });\r\n    $('d').each((index, item) => {\r\n        danmakuList.push({ p: $(item).attr('p'), text: $(item).text() });\r\n    });\r\n\r\n    danmakuList = danmakuList.toReversed().slice(0, limit);\r\n\r\n    return {\r\n        title: `${videoName} 的 弹幕动态`,\r\n        link,\r\n        description: `${videoName} 的 弹幕动态`,\r\n        item: danmakuList.map((item) => ({\r\n            title: `[${processFloatTime(item.p.split(',')[0])}] ${item.text}`,\r\n            pubDate: new Date(item.p.split(',')[4] * 1000).toUTCString(),\r\n            guid: `${cid}-${item.p.split(',')[4]}-${item.p.split(',')[7]}`,\r\n            link,\r\n        })),\r\n    };\r\n}\r\n"],"mappings":"ufAMA,MAAM,EAAoB,GAAS,CAC/B,IAAM,EAAe,OAAO,SAAS,GAC/B,EAAU,EAAe,GACzB,GAAY,EAAe,GAAW,GAAM,GAC5C,GAAS,EAAe,EAAU,GAAK,GAAW,KACxD,MAAO,GAAG,EAAM,GAAG,EAAQ,WAAW,SAAS,EAAG,KAAK,GAAG,EAAQ,WAAW,SAAS,EAAG,QAGhFA,EAAe,CACxB,KAAM,6BACN,WAAY,CAAC,gBACb,QAAS,yCACT,WAAY,CAAE,KAAM,sBAAuB,IAAK,cAChD,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,cACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAI,EAAO,EAAI,IAAI,MAAM,QACrB,EACC,EAAK,WAAW,QACjB,EAAM,EACN,EAAO,MAEX,IAAM,EAAM,OAAO,EAAI,IAAI,MAAM,QAAU,GAErC,EAAM,MAAMC,EAAM,aAAa,EAAK,EAAK,GAEzC,EAAY,MAAMA,EAAM,mBAAmB,EAAK,GAEhD,EAAO,kCAAkC,GAAQ,KAAK,MACtD,EAAkB,MAAMC,EAAI,IAAI,gCAAgC,EAAI,MAAO,CAC7E,WAAY,GACZ,aAAc,SACd,QAAS,CACL,QAAS,KAIb,EAAc,EAAgB,KAElC,EAAc,OAAQ,EAAY,GAAK,KAAU,EAAOC,EAAK,YAAY,GAAeA,EAAK,eAAe,IAE5G,IAAI,EAAc,GACZ,EAAI,EAAK,EAAa,CAAE,QAAS,KAOvC,OANA,EAAE,KAAK,MAAM,EAAO,IAAS,CACzB,EAAY,KAAK,CAAE,EAAG,EAAE,GAAM,KAAK,KAAM,KAAM,EAAE,GAAM,WAG3D,EAAc,EAAY,aAAa,MAAM,EAAG,IAEzC,CACH,MAAO,GAAG,EAAU,SACpB,OACA,YAAa,GAAG,EAAU,SAC1B,KAAM,EAAY,IAAK,IAAU,CAC7B,MAAO,IAAI,EAAiB,EAAK,EAAE,MAAM,KAAK,IAAI,IAAI,EAAK,OAC3D,QAAS,IAAI,KAAK,EAAK,EAAE,MAAM,KAAK,GAAK,KAAM,cAC/C,KAAM,GAAG,EAAI,GAAG,EAAK,EAAE,MAAM,KAAK,GAAG,GAAG,EAAK,EAAE,MAAM,KAAK,KAC1D"}