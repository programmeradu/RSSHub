{"version":3,"file":"tgchannel-DvgV_d3F.js","names":["route: Route","got"],"sources":["../../lib/routes/wechat/tgchannel.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { finishArticleItem } from '@/utils/wechat-mp';\r\n\r\nexport const route: Route = {\r\n    path: '/tgchannel/:id/:mpName?/:searchQueryType?',\r\n    categories: ['new-media'],\r\n    example: '/wechat/tgchannel/lifeweek',\r\n    parameters: { id: 'å…¬ä¼—å·ç»‘å®šé¢‘é“ id', mpName: 'æ¬²ç­›é€‰çš„å…¬ä¼—å·å…¨åï¼ˆURL-encodedï¼Œç²¾ç¡®åŒ¹é…ï¼‰ï¼Œåœ¨é¢‘é“è®¢é˜…äº†å¤šä¸ªå…¬ä¼—å·æ—¶å¯é€‰ç”¨', searchQueryType: 'æœç´¢æŸ¥è¯¢ç±»å‹ï¼Œè§ä¸‹è¡¨' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'å…¬ä¼—å·ï¼ˆTelegram é¢‘é“æ¥æºï¼‰',\r\n    maintainers: ['LogicJake', 'Rongronggg9'],\r\n    handler,\r\n    description: `| æœç´¢æŸ¥è¯¢ç±»å‹ | å°†ä½¿ç”¨çš„æœç´¢å…³é”®å­— |            é€‚ç”¨äº           |\r\n| :----------: | :----------------: | :-------------------------: |\r\n|      \\`0\\`     |     (ç¦ç”¨æœç´¢)     |       æ‰€æœ‰æƒ…å†µ (é»˜è®¤)       |\r\n|      \\`1\\`     |     å…¬ä¼—å·å…¨å     | æœªå¯ç”¨ efb-patch-middleware |\r\n|      \\`2\\`     |     #å…¬ä¼—å·å…¨å    | å·²å¯ç”¨ efb-patch-middleware |\r\n\r\n::: tip\r\n  å¯ç”¨æœç´¢æœ‰åŠ©äºåœ¨è®¢é˜…äº†è¿‡å¤šå…¬ä¼—å·çš„é¢‘é“é‡Œæœ‰æ•ˆç­›é€‰ï¼Œä¸æ˜“å› ä¸ºå¤§é‡å…¬ä¼—å·åŒæ—¶æ¨é€å¯¼è‡´ä¸€äº›å…¬ä¼—å·æ¶ˆæ¯è¢«é—æ¼ï¼Œä½†å¿…é¡»æ­£ç¡®é€‰æ‹©æœç´¢æŸ¥è¯¢ç±»å‹ï¼Œå¦åˆ™ä¼šæœç´¢å¤±è´¥ã€‚\r\n:::\r\n\r\n::: warning\r\n  è¯¥æ–¹æ³•éœ€è¦é€šè¿‡ efb è¿›è¡Œé¢‘é“ç»‘å®šï¼Œå…·ä½“æ“ä½œè§ [https://github.com/DIYgod/RSSHub/issues/2172](https://github.com/DIYgod/RSSHub/issues/2172)\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    const mpName = ctx.req.param('mpName') ?? '';\r\n    let searchQueryType = ctx.req.param('searchQueryType') ?? '0';\r\n    if (searchQueryType !== '0' && searchQueryType !== '1' && searchQueryType !== '2') {\r\n        searchQueryType = '0';\r\n    }\r\n    searchQueryType = +searchQueryType; // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—\r\n\r\n    const channelUrl = `https://t.me/s/${id}`;\r\n    const searchQuery = mpName && searchQueryType ? (searchQueryType === 2 ? `?q=%23${mpName}` : `?q=${mpName}`) : '';\r\n    const { data } = await got.get(`${channelUrl}${searchQuery}`);\r\n    const $ = load(data);\r\n    const list = $('.tgme_widget_message_wrap').slice(-20);\r\n\r\n    const out = await Promise.all(\r\n        list.toArray().map(async (item) => {\r\n            item = $(item);\r\n\r\n            if (searchQuery) {\r\n                // åˆ é™¤å…³é”®å­—é«˜äº® <mark class=\"highlight\">\r\n                const highlightMarks = item.find('mark.highlight').toArray();\r\n                if (highlightMarks) {\r\n                    for (let mark of highlightMarks) {\r\n                        mark = $(mark);\r\n                        const markInnerHtml = mark.html();\r\n                        mark.replaceWith(markInnerHtml);\r\n                    }\r\n                    item = $(item.html()); // åˆ é™¤å…³é”®å­—é«˜äº®åï¼Œç›¸é‚»çš„è£¸æ–‡æœ¬èŠ‚ç‚¹ä¸ä¼šè¢«è‡ªåŠ¨åˆå¹¶ï¼Œé‡æ–°ç”Ÿæˆ cheerio å¯¹è±¡ä»¥ç¡®ä¿åç»­æµç¨‹æ­£å¸¸è¿è¡Œ\r\n                }\r\n            }\r\n\r\n            // [ div.tgme_widget_message_text æ ¼å¼ç®€ç•¥è¯´æ˜ ]\r\n            // è‹¥é¢‘é“åªè®¢é˜…ä¸€ä¸ªå…¬ä¼—å·ï¼š\r\n            // ç¬¬ 1 ä¸ªå…ƒç´ : <a href=\"${ç”¨äº link priview çš„é¢„è§ˆå›¾ url}\"><i><b>ğŸ”—</b></i></a>\r\n            // ç¬¬ 2 ä¸ªå…ƒç´ : <a href=\"${æ–‡ç«  url}\">${æ–‡ç« æ ‡é¢˜}</a>\r\n            // (ä½™ä¸‹æ˜¯æ–‡ç« ç®€ä»‹ï¼Œä¸€èˆ¬æ˜¯è£¸æ–‡æœ¬ï¼Œè¿™é‡Œç”¨ä¸åˆ°)\r\n            //\r\n            // è‹¥é¢‘é“è®¢é˜…å¤šäºä¸€ä¸ªå…¬ä¼—å·ï¼š\r\n            // ç¬¬ 1 ä¸ªå…ƒç´ : <i><b>${emoji(æ ‡æ³¨æ¶ˆæ¯æ¥æºäºä»€ä¹ˆ slaveï¼Œè¿™é‡Œæ˜¯è¡¨ç¤ºå¾®ä¿¡çš„ğŸ’¬)}</b></i>\r\n            // ç¬¬ 2 ä¸ªå…ƒç´ : <i><b>${emoji(æ ‡æ³¨å¯¹è¯ç±»å‹ï¼Œè¿™é‡Œæ˜¯è¡¨ç¤ºç§èŠçš„ğŸ‘¤)</b></i>\r\n            // è£¸æ–‡æœ¬: (åŠè§’ç©ºæ ¼)${å…¬ä¼—å·å}(åŠè§’å†’å·)\r\n            // ç¬¬ 3 ä¸ªå…ƒç´ : <br />\r\n            // ç¬¬ 4 ä¸ªå…ƒç´ : <a href=\"${ç”¨äº link priview çš„é¢„è§ˆå›¾ url}\"><i><b>ğŸ”—</b></i></a>\r\n            // ç¬¬ 5 ä¸ªå…ƒç´ : <a href=\"${æ–‡ç«  url}\">${æ–‡ç« æ ‡é¢˜}</a>\r\n            // (ä½™ä¸‹æ˜¯æ–‡ç« ç®€ä»‹ï¼Œä¸€èˆ¬æ˜¯è£¸æ–‡æœ¬ï¼Œè¿™é‡Œç”¨ä¸åˆ°)\r\n            //\r\n            // è‹¥å¯ç”¨ efb-patch-middleware ä¸”é¢‘é“è®¢é˜…å¤šäºä¸€ä¸ªå…¬ä¼—å·ï¼š\r\n            // ç¬¬ 1 ä¸ªå…ƒç´ : <i><b>${emoji(æ ‡æ³¨æ¶ˆæ¯æ¥æºäºä»€ä¹ˆ slaveï¼Œè¿™é‡Œæ˜¯è¡¨ç¤ºå¾®ä¿¡çš„ğŸ’¬)}</b></i>\r\n            // ç¬¬ 2 ä¸ªå…ƒç´ : <i><b>${emoji(æ ‡æ³¨å¯¹è¯ç±»å‹ï¼Œè¿™é‡Œæ˜¯è¡¨ç¤ºç§èŠçš„ğŸ‘¤)</b></i>\r\n            // ç¬¬ 3 ä¸ªå…ƒç´ : <a href=\"${?q=%23url-encodedå…¬ä¼—å·å}\">#${å…¬ä¼—å·å}</a>\r\n            // è£¸æ–‡æœ¬: ${å…¬ä¼—å·åä½™ä¸‹éƒ¨åˆ† (è‹¥ hashtag ä¸åˆæ³• (é‡åˆ°ç©ºæ ¼ã€æ ‡ç‚¹) å¯¼è‡´è¢«æˆªæ–­æ‰ä¼šæœ‰)}(åŠè§’å†’å·)\r\n            // ç¬¬ 4 ä¸ªå…ƒç´ : <br />\r\n            // ç¬¬ 5 ä¸ªå…ƒç´ : <a href=\"${ç”¨äº link priview çš„é¢„è§ˆå›¾ url}\"><i><b>ğŸ”—</b></i></a>\r\n            // ç¬¬ 6 ä¸ªå…ƒç´ : <a href=\"${æ–‡ç«  url}\">${æ–‡ç« æ ‡é¢˜}</a>\r\n            // (ä½™ä¸‹æ˜¯æ–‡ç« ç®€ä»‹ï¼Œä¸€èˆ¬æ˜¯è£¸æ–‡æœ¬ï¼Œè¿™é‡Œç”¨ä¸åˆ°)\r\n\r\n            let author = '';\r\n            let titleElemIs3thA = false;\r\n\r\n            const brNode = item.find('.tgme_widget_message_text > br:nth-of-type(1)').get(0); // è·å–ç¬¬ä¸€ä¸ªæ¢è¡Œ\r\n            const authorNode = brNode && brNode.prev; // brNode ä¸ä¸º undefined æ—¶è·å–å®ƒçš„å‰ä¸€ä¸ªèŠ‚ç‚¹\r\n            const authorNodePrev = authorNode && authorNode.prev; // authorNode ä¸ä¸º undefined æ—¶è·å–å®ƒçš„å‰ä¸€ä¸ªèŠ‚ç‚¹\r\n            if (authorNode && authorNode.type === 'text') {\r\n                // åªæœ‰è¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªè£¸æ–‡æœ¬æ—¶å®ƒæ‰å¯èƒ½æ˜¯å…¬ä¼—å·åï¼Œå¼€å§‹æ‰¾å¯»å…¬ä¼—å·å\r\n                if (authorNodePrev && authorNodePrev.type === 'tag' && authorNodePrev.name === 'a' && authorNodePrev.attribs.href && authorNodePrev.attribs.href.startsWith('?q=%23')) {\r\n                    // authorNode å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯é“¾æ¥, ä¸”æ˜¯ä¸ª hashtagï¼Œè¡¨ç¤ºå¯ç”¨äº† efb-patch-middlewareï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯å…¬ä¼—å·å\r\n                    // æœ‰ä¸¤ç§å¯èƒ½ï¼š\r\n                    // å¸¦ # çš„å®Œæ•´å…¬ä¼—å·å (efb-patch-middleware å¯ç”¨ï¼Œä¸” hashtag å®Œå…¨åˆæ³•)\r\n                    // è¢«æˆªæ–­çš„å…¬ä¼—å·åå‰åŠéƒ¨åˆ† (efb-patch-middleware å¯ç”¨ï¼Œä½† hashtag è¢«ç©ºæ ¼æˆ–æ ‡ç‚¹æˆªæ–­)\r\n                    // (è‹¥ efb-patch-middleware æœªå¯ç”¨ï¼Œæˆ– hashtag å®Œå…¨ä¸åˆæ³•ï¼Œä¸ä¼šè¿›å…¥æ­¤æµç¨‹)\r\n                    titleElemIs3thA = true;\r\n                    author += $(authorNodePrev).text();\r\n                }\r\n\r\n                const spaceIndex = authorNode.data.indexOf(' ');\r\n                const colonIndex = authorNode.data.indexOf(':');\r\n                if (authorNode.data.length > 1 && colonIndex !== -1 && (spaceIndex !== -1 || titleElemIs3thA)) {\r\n                    // æœ‰ä¸‰ç§å¯èƒ½ï¼š\r\n                    // ä¸å¸¦ # çš„å®Œæ•´å…¬ä¼—å·å (efb-patch-middleware æœªå¯ç”¨)\r\n                    // å¸¦ # çš„å®Œæ•´å…¬ä¼—å·å (efb-patch-middleware å¯ç”¨ï¼Œä½† hashtag å®Œå…¨ä¸åˆæ³•)\r\n                    // è¢«æˆªæ–­çš„å…¬ä¼—å·åååŠéƒ¨åˆ† (efb-patch-middleware å¯ç”¨ï¼Œä½† hashtag è¢«ç©ºæ ¼æˆ–æ ‡ç‚¹æˆªæ–­ï¼Œæ­¤æ—¶ç©ºæ ¼æœ‰æ„ä¹‰)\r\n                    // (è‹¥ efb-patch-middleware å¯ç”¨ï¼Œä¸” hashtag å®Œå…¨åˆæ³•ï¼Œä¸ä¼šè¿›å…¥æ­¤æµç¨‹)\r\n                    const sliceStart = titleElemIs3thA ? 0 : spaceIndex + 1;\r\n                    author += authorNode.data.slice(sliceStart, colonIndex); // æå–ä½œè€…\r\n                }\r\n\r\n                if (author.startsWith('#')) {\r\n                    author = author.slice(1); // å»æ‰å¼€å¤´çš„ #\r\n                }\r\n            }\r\n\r\n            // å¦‚æœå¯ç”¨äº† efb-patch-middleware ä¸” hashtag (éƒ¨åˆ†)åˆæ³•ï¼Œç¬¬ä¸‰ä¸ª a å…ƒç´ ä¼šæ˜¯æ–‡ç« é“¾æ¥ï¼Œå¦åˆ™æ˜¯ç¬¬äºŒä¸ª\r\n            const titleElemNth = titleElemIs3thA ? 3 : 2;\r\n            const titleElem = item.find(`.tgme_widget_message_text > a:nth-of-type(${titleElemNth})`);\r\n\r\n            if (titleElem.length === 0) {\r\n                // è·å–ä¸åˆ°æ ‡é¢˜ a å…ƒç´ ï¼Œè¿™å¯èƒ½æ˜¯å…¬ä¼—å·å‘çš„æœåŠ¡æ¶ˆæ¯ï¼Œä¸¢å¼ƒå®ƒ\r\n                return;\r\n            }\r\n\r\n            let title = titleElem.text();\r\n            const link = titleElem.attr('href');\r\n\r\n            if (mpName && author !== mpName) {\r\n                // æŒ‡å®šäº†è¦ç­›é€‰çš„å…¬ä¼—å·åï¼Œä¸”è¯¥æ–‡ç« ä¸æ˜¯è¯¥å…¬ä¼—å·å‘çš„\r\n                return; // ä¸¢å¼ƒ\r\n            } else if (!mpName && author) {\r\n                // æ²¡æœ‰æŒ‡å®šè¦ç­›é€‰çš„å…¬ä¼—å·åï¼Œä¸”åŒ¹é…åˆ°äº†ä½œè€…\r\n                title = author + ': ' + title; // ç»™æ ‡é¢˜é‡ŒåŠ ä¸Šè·å–åˆ°çš„ä½œè€…\r\n            }\r\n\r\n            const pubDate = new Date(item.find('.tgme_widget_message_date time').attr('datetime')).toUTCString();\r\n\r\n            /*\r\n             * Since 2024/4/20, t.me/s/ mistakenly have every '&' in **hyperlinks** replaced by '&amp;'.\r\n             * wechat-mp will take care of this, so no need to fix it here.\r\n             * However, once the bug is eventually fixed, all guid will be changed again.\r\n             * Considering that this is almost certain to happen, let's break guid consistency now by using\r\n             * normalized URL from wechat-mp as guid to avoid similar issues in the future.\r\n             */\r\n            const single = {\r\n                title,\r\n                pubDate,\r\n                link,\r\n                // guid: link,\r\n            };\r\n\r\n            if (link !== undefined) {\r\n                try {\r\n                    return await finishArticleItem(single);\r\n                } catch {\r\n                    single.description = item.find('.tgme_widget_message_text').html();\r\n                }\r\n            }\r\n            return single;\r\n        })\r\n    );\r\n\r\n    out.reverse();\r\n    return {\r\n        title: mpName || $('.tgme_channel_info_header_title').text(),\r\n        link: `https://t.me/s/${id}`,\r\n        item: out.filter(Boolean),\r\n        allowEmpty: !!mpName,\r\n    };\r\n}\r\n"],"mappings":"wXAKA,MAAaA,EAAe,CACxB,KAAM,4CACN,WAAY,CAAC,aACb,QAAS,6BACT,WAAY,CAAE,GAAI,aAAc,OAAQ,8CAA+C,gBAAiB,cACxG,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,qBACN,YAAa,CAAC,YAAa,eAC3B,UACA,YAAa;;;;;;;;;;;;MAejB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACnB,EAAS,EAAI,IAAI,MAAM,WAAa,GACtC,EAAkB,EAAI,IAAI,MAAM,oBAAsB,IACtD,IAAoB,KAAO,IAAoB,KAAO,IAAoB,MAC1E,EAAkB,KAEtB,EAAkB,CAAC,EAEnB,IAAM,EAAa,kBAAkB,IAC/B,EAAc,GAAU,EAAmB,IAAoB,EAAI,SAAS,IAAW,MAAM,IAAY,GACzG,CAAE,QAAS,MAAMC,EAAI,IAAI,GAAG,IAAa,KACzC,EAAI,EAAK,GACT,EAAO,EAAE,6BAA6B,MAAM,KAE5C,EAAM,MAAM,QAAQ,IACtB,EAAK,UAAU,IAAI,KAAO,IAAS,CAG/B,GAFA,EAAO,EAAE,GAEL,EAAa,CAEb,IAAM,EAAiB,EAAK,KAAK,kBAAkB,UACnD,GAAI,EAAgB,CAChB,IAAK,IAAI,KAAQ,EAAgB,CAC7B,EAAO,EAAE,GACT,IAAM,EAAgB,EAAK,OAC3B,EAAK,YAAY,GAErB,EAAO,EAAE,EAAK,SA6BtB,IAAI,EAAS,GACT,EAAkB,GAEhB,EAAS,EAAK,KAAK,iDAAiD,IAAI,GACxE,EAAa,GAAU,EAAO,KAC9B,EAAiB,GAAc,EAAW,KAChD,GAAI,GAAc,EAAW,OAAS,OAAQ,CAEtC,GAAkB,EAAe,OAAS,OAAS,EAAe,OAAS,KAAO,EAAe,QAAQ,MAAQ,EAAe,QAAQ,KAAK,WAAW,YAMxJ,EAAkB,GAClB,GAAU,EAAE,GAAgB,QAGhC,IAAM,EAAa,EAAW,KAAK,QAAQ,KACrC,EAAa,EAAW,KAAK,QAAQ,KAC3C,GAAI,EAAW,KAAK,OAAS,GAAK,IAAe,KAAO,IAAe,IAAM,GAAkB,CAM3F,IAAM,EAAa,EAAkB,EAAI,EAAa,EACtD,GAAU,EAAW,KAAK,MAAM,EAAY,GAG5C,EAAO,WAAW,OAClB,EAAS,EAAO,MAAM,IAK9B,IAAM,EAAe,EAAkB,EAAI,EACrC,EAAY,EAAK,KAAK,6CAA6C,EAAa,IAEtF,GAAI,EAAU,SAAW,EAErB,OAGJ,IAAI,EAAQ,EAAU,OAChB,EAAO,EAAU,KAAK,QAE5B,GAAI,GAAU,IAAW,EAErB,OACO,CAAC,GAAU,IAElB,EAAQ,EAAS,KAAO,GAG5B,IAAM,EAAU,IAAI,KAAK,EAAK,KAAK,kCAAkC,KAAK,aAAa,cASjF,EAAS,CACX,QACA,UACA,QAIJ,GAAI,IAAS,IAAA,GACT,GAAI,CACA,OAAO,MAAM,EAAkB,QAC3B,CACJ,EAAO,YAAc,EAAK,KAAK,6BAA6B,OAGpE,OAAO,KAKf,OADA,EAAI,UACG,CACH,MAAO,GAAU,EAAE,mCAAmC,OACtD,KAAM,kBAAkB,IACxB,KAAM,EAAI,OAAO,SACjB,WAAY,CAAC,CAAC"}