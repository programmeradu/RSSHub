{"version":3,"file":"report-lCgm9R9e.js","names":[],"sources":["../../lib/routes/eastmoney/utils.ts","../../lib/routes/eastmoney/report/index.ts"],"sourcesContent":["function getRatingChangeStr(ratingChange) {\r\n    let ratingChangeName = '';\r\n    switch (String(ratingChange)) {\r\n        case '0':\r\n            ratingChangeName = '调高';\r\n            break;\r\n        case '1':\r\n            ratingChangeName = '调低';\r\n            break;\r\n        case '2':\r\n            ratingChangeName = '首次';\r\n            break;\r\n        case '3':\r\n            ratingChangeName = '维持';\r\n            break;\r\n        case '4':\r\n            ratingChangeName = '无';\r\n            break;\r\n        default:\r\n            ratingChangeName = '-';\r\n            break;\r\n    }\r\n    return ratingChangeName;\r\n}\r\n\r\n// 按照东方财富的 js 规则：收益是保留三位小数，市盈率是保留两位小数\r\nfunction getEpsOrPeStr(epsOrPe, keepDecimal) {\r\n    let EpsOrPeStr = '';\r\n    if (epsOrPe !== undefined) {\r\n        EpsOrPeStr = epsOrPe === '' ? '' : Number(epsOrPe).toFixed(keepDecimal);\r\n    }\r\n    return EpsOrPeStr;\r\n}\r\n\r\nexport { getRatingChangeStr, getEpsOrPeStr };\r\n","import { Route, ViewType } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { getRatingChangeStr, getEpsOrPeStr } from '../utils';\r\n\r\nexport const route: Route = {\r\n    path: '/report/:category',\r\n    categories: ['finance'],\r\n    view: ViewType.Articles,\r\n    example: '/eastmoney/report/strategyreport',\r\n    parameters: {\r\n        category: {\r\n            description: '研报类型',\r\n            options: [\r\n                { value: 'strategyreport', label: '策略报告' },\r\n                { value: 'macresearch', label: '宏观研究' },\r\n                { value: 'brokerreport', label: '券商晨报' },\r\n                { value: 'industry', label: '行业研报' },\r\n                { value: 'stock', label: '个股研报' },\r\n            ],\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['data.eastmoney.com/report/:category'],\r\n        },\r\n    ],\r\n    name: '研究报告',\r\n    maintainers: ['syzq'],\r\n    handler,\r\n    description: `| 策略报告       | 宏观研究    | 券商晨报     | 行业研究 | 个股研报 |\r\n| -------------- | ----------- | ------------ | -------- | -------- |\r\n| strategyreport | macresearch | brokerreport | industry | stock    |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const baseUrl = 'https://data.eastmoney.com';\r\n    const { category = 'strategyreport' } = ctx.req.param();\r\n\r\n    const reportType = {\r\n        brokerreport: '券商晨报',\r\n        industry: '行业研报',\r\n        macresearch: '宏观研究',\r\n        strategyreport: '策略报告',\r\n        stock: '个股研报',\r\n    };\r\n    const linkType = {\r\n        brokerreport: 'zw_brokerreport',\r\n        industry: 'zw_industry',\r\n        macresearch: 'zw_macresearch',\r\n        strategyreport: 'zw_strategy',\r\n        stock: 'info',\r\n    };\r\n\r\n    const res = await got(`${baseUrl}/report/${category}`);\r\n    const $ = load(res.data);\r\n\r\n    const initData = JSON.parse(\r\n        $('script')\r\n            .text()\r\n            .match(/var initdata(.=?)(.*?);/)[2]\r\n    );\r\n\r\n    const list = initData.data.map((item) => {\r\n        const stockName = category === 'stock' ? `[${item.stockName}]` : '';\r\n        return {\r\n            title: `[${item.orgSName}]${stockName}${item.title}`,\r\n            link: `${baseUrl}/report/${linkType[category]}` + (category === 'stock' ? `/${item.infoCode}.html` : `.jshtml?encodeUrl=${item.encodeUrl}`),\r\n            pubDate: parseDate(item.publishDate),\r\n            author: item.researcher,\r\n            originItem: item, // temp use\r\n        };\r\n    });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) => {\r\n            const tempOriginItem = item.originItem;\r\n            delete item.originItem; // temp use\r\n\r\n            return cache.tryGet(item.link, async () => {\r\n                try {\r\n                    const { data: response } = await got(item.link);\r\n                    const $ = load(response);\r\n\r\n                    if (category === 'stock') {\r\n                        const { title, stockName, stockCode, emRatingName, ratingChange, orgSName, indvInduName } = tempOriginItem;\r\n                        const ratingChangeStr = getRatingChangeStr(ratingChange);\r\n                        const currentYear = new Date().getFullYear();\r\n                        const nextYear = currentYear + 1;\r\n                        const description = $('.newsContent').html();\r\n                        const enclosureUrl = $('#ContentBody .rightlab').attr('href');\r\n                        const predictThisYearEps = getEpsOrPeStr(tempOriginItem.predictThisYearEps, 3);\r\n                        const predictThisYearPe = getEpsOrPeStr(tempOriginItem.predictThisYearPe, 2);\r\n                        const predictNextYearEps = getEpsOrPeStr(tempOriginItem.predictNextYearEps, 3);\r\n                        const predictNextYearPe = getEpsOrPeStr(tempOriginItem.predictNextYearPe, 2);\r\n\r\n                        item.enclosure_url = enclosureUrl;\r\n                        item.description = art(path.join(__dirname, '../templates/stock_description.art'), {\r\n                            title,\r\n                            stockName,\r\n                            stockCode,\r\n                            emRatingName,\r\n                            ratingChangeStr,\r\n                            description,\r\n                            orgSName,\r\n                            predictThisYearEps,\r\n                            predictThisYearPe,\r\n                            predictNextYearEps,\r\n                            predictNextYearPe,\r\n                            indvInduName,\r\n                            currentYear,\r\n                            nextYear,\r\n                            enclosureUrl,\r\n                        });\r\n                    } else {\r\n                        item.link = $('.pdf-link').attr('href');\r\n                        item.description = $('.ctx-content').text();\r\n                    }\r\n                    return item;\r\n                } catch {\r\n                    return item;\r\n                }\r\n            });\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `东方财富网-${reportType[category]}`,\r\n        link: baseUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ugBAAA,SAAA,EAAA,EAAA,UAEI,OAAA,OAAA,GAAA,SAEQ,EAAA,KACA,cAEA,EAAA,KACA,cAEA,EAAA,KACA,cAEA,EAAA,KACA,cAEA,EAAA,IACA,cAEA,EAAA,IACA,MAER,OAAA,EAIJ,SAAA,EAAA,EAAA,EAAA,UAKI,OAHA,IAAA,IAAA,KAAA,EAAA,IAAA,GAAA,GAAA,OAAA,GAAA,QAAA,IAGA,ECtBJ,MAAa,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,WACb,KAAM,EAAS,SACf,QAAS,mCACT,WAAY,CACR,SAAU,CACN,YAAa,OACb,QAAS,CACL,CAAE,MAAO,iBAAkB,MAAO,QAClC,CAAE,MAAO,cAAe,MAAO,QAC/B,CAAE,MAAO,eAAgB,MAAO,QAChC,CAAE,MAAO,WAAY,MAAO,QAC5B,CAAE,MAAO,QAAS,MAAO,WAIrC,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,yCAGjB,KAAM,OACN,YAAa,CAAC,QACd,UACA,YAAa;;wEAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,6BACV,CAAE,WAAW,kBAAqB,EAAI,IAAI,QAE1C,EAAa,CACf,aAAc,OACd,SAAU,OACV,YAAa,OACb,eAAgB,OAChB,MAAO,QAEL,EAAW,CACb,aAAc,kBACd,SAAU,cACV,YAAa,iBACb,eAAgB,cAChB,MAAO,QAGL,EAAM,MAAM,EAAI,GAAG,EAAQ,UAAU,KACrC,EAAI,EAAK,EAAI,MAEb,EAAW,KAAK,MAClB,EAAE,UACG,OACA,MAAM,2BAA2B,IAGpC,EAAO,EAAS,KAAK,IAAK,GAAS,CACrC,IAAM,EAAY,IAAa,QAAU,IAAI,EAAK,UAAU,GAAK,GACjE,MAAO,CACH,MAAO,IAAI,EAAK,SAAS,GAAG,IAAY,EAAK,QAC7C,KAAM,GAAG,EAAQ,UAAU,EAAS,MAAe,IAAa,QAAU,IAAI,EAAK,SAAS,OAAS,qBAAqB,EAAK,aAC/H,QAAS,EAAU,EAAK,aACxB,OAAQ,EAAK,WACb,WAAY,KAId,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GAAS,CACf,IAAM,EAAiB,EAAK,WAG5B,OAFA,OAAO,EAAK,WAEL,EAAM,OAAO,EAAK,KAAM,SAAY,CACvC,GAAI,CACA,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,EAAK,MACpC,EAAI,EAAK,GAEf,GAAI,IAAa,QAAS,CACtB,GAAM,CAAE,QAAO,YAAW,YAAW,eAAc,eAAc,WAAU,gBAAiB,EACtF,EAAkB,EAAmB,GACrC,EAAc,IAAI,OAAO,cACzB,EAAW,EAAc,EACzB,EAAc,EAAE,gBAAgB,OAChC,EAAe,EAAE,0BAA0B,KAAK,QAChD,EAAqB,EAAc,EAAe,mBAAoB,GACtE,EAAoB,EAAc,EAAe,kBAAmB,GACpE,EAAqB,EAAc,EAAe,mBAAoB,GACtE,EAAoB,EAAc,EAAe,kBAAmB,GAE1E,EAAK,cAAgB,EACrB,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,4CAA4D,CAC/E,QACA,YACA,YACA,eACA,kBACA,cACA,WACA,qBACA,oBACA,qBACA,oBACA,eACA,cACA,WACA,sBAGJ,EAAK,KAAO,EAAE,aAAa,KAAK,QAChC,EAAK,YAAc,EAAE,gBAAgB,OAEzC,OAAO,OACH,CACJ,OAAO,QAMvB,MAAO,CACH,MAAO,SAAS,EAAW,KAC3B,KAAM,EACN,KAAM"}