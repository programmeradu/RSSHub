{"version":3,"file":"post-Bhx8GvtH.js","names":["route: Route","got","pageUrls: string[]","cache","$"],"sources":["../../lib/routes/t66y/post.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport * as cheerio from 'cheerio';\r\nimport got from '@/utils/got';\r\nimport cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { baseUrl, parseContent } from './utils';\r\n\r\nfunction parseItems(tid: string, $: cheerio.CheerioAPI) {\r\n    return $('.tr1:nth-child(1)')\r\n        .toArray()\r\n        .map((item) => {\r\n            const $item = $(item);\r\n\r\n            const content = parseContent($item.html());\r\n            const footer = $item.next();\r\n            const pid = footer.find('.tipad a[title]').attr('id')?.slice(2);\r\n\r\n            return {\r\n                title: content?.split('<br>')[0],\r\n                description: content,\r\n                author: $item\r\n                    .find('b')\r\n                    .contents()\r\n                    .filter((_, ele) => ele.type === 'text')\r\n                    .text()\r\n                    .trim(),\r\n                pubDate: parseDate(String(footer.find('span[data-timestamp]').data('timestamp')), 'X'),\r\n                link: `${baseUrl}/read.php?tid=${tid}${pid ? `&pid=${pid}` : ''}`,\r\n            };\r\n        });\r\n}\r\n\r\nexport const route: Route = {\r\n    path: '/post/:tid',\r\n    categories: ['multimedia'],\r\n    example: '/t66y/post/3286088',\r\n    parameters: { tid: '帖子 id, 可在帖子 URL 中找到' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '帖子跟踪',\r\n    maintainers: ['cnzgray'],\r\n    handler,\r\n    description: `::: tip\r\n  帖子 id 查找办法:\r\n\r\n  打开想跟踪的帖子，比如：\\`https://t66y.com/htm_data/20/1811/3286088.html\\` 其中 \\`3286088\\` 就是帖子 id。\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const tid = ctx.req.param('tid') as string;\r\n    const { data: response } = await got(`${baseUrl}/read.php?tid=${tid}`);\r\n    // 跟踪重定向\r\n    let $ = cheerio.load(response);\r\n    const redirect = $('a:last-child').attr('href');\r\n    if (!redirect) {\r\n        throw new Error('Cannot get the redirect link');\r\n    }\r\n\r\n    const { data: redirectedResponse, url: link } = await got(new URL(redirect, baseUrl).href);\r\n    $ = cheerio.load(redirectedResponse);\r\n\r\n    const firstPage = parseItems(tid, $);\r\n\r\n    const pageSize = $('.w70 input').eq(0).attr('value')?.split('/')[1];\r\n    let pageUrls: string[] = [];\r\n    if (pageSize) {\r\n        const length = Number.parseInt(pageSize);\r\n        pageUrls = Array.from({ length }, (_, i) => `${baseUrl}/read.php?tid=${tid}&page=${i + 1}`).slice(1);\r\n    }\r\n\r\n    // 请求帖子\r\n    const nextPages = pageSize\r\n        ? await Promise.all(\r\n              pageUrls.map((url) =>\r\n                  cache.tryGet(url, async () => {\r\n                      const { data: res } = await got(url);\r\n                      const $ = cheerio.load(res);\r\n\r\n                      return parseItems(tid, $);\r\n                  })\r\n              )\r\n          )\r\n        : [];\r\n\r\n    const items = [...firstPage, ...nextPages.flat()];\r\n\r\n    return {\r\n        title: $('head title').text(),\r\n        link,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"maAOA,SAAS,EAAW,EAAa,EAAuB,CACpD,OAAO,EAAE,qBACJ,UACA,IAAK,GAAS,CACX,IAAM,EAAQ,EAAE,GAEV,EAAU,EAAa,EAAM,QAC7B,EAAS,EAAM,OACf,EAAM,EAAO,KAAK,mBAAmB,KAAK,OAAO,MAAM,GAE7D,MAAO,CACH,MAAO,GAAS,MAAM,QAAQ,GAC9B,YAAa,EACb,OAAQ,EACH,KAAK,KACL,WACA,QAAQ,EAAG,IAAQ,EAAI,OAAS,QAChC,OACA,OACL,QAAS,EAAU,OAAO,EAAO,KAAK,wBAAwB,KAAK,cAAe,KAClF,KAAM,GAAG,EAAQ,gBAAgB,IAAM,EAAM,QAAQ,IAAQ,QAK7E,MAAaA,EAAe,CACxB,KAAM,aACN,WAAY,CAAC,cACb,QAAS,qBACT,WAAY,CAAE,IAAK,uBACnB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,WACd,UACA,YAAa;;;;MAOjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAM,EAAI,IAAI,MAAM,OACpB,CAAE,KAAM,GAAa,MAAMC,EAAI,GAAG,EAAQ,gBAAgB,KAE5D,EAAI,EAAQ,KAAK,GACf,EAAW,EAAE,gBAAgB,KAAK,QACxC,GAAI,CAAC,EACD,MAAU,MAAM,gCAGpB,GAAM,CAAE,KAAM,EAAoB,IAAK,GAAS,MAAMA,EAAI,IAAI,IAAI,EAAU,GAAS,MACrF,EAAI,EAAQ,KAAK,GAEjB,IAAM,EAAY,EAAW,EAAK,GAE5B,EAAW,EAAE,cAAc,GAAG,GAAG,KAAK,UAAU,MAAM,KAAK,GAC7DC,EAAqB,GACzB,GAAI,EAAU,CACV,IAAM,EAAS,OAAO,SAAS,GAC/B,EAAW,MAAM,KAAK,CAAE,WAAW,EAAG,IAAM,GAAG,EAAQ,gBAAgB,EAAI,QAAQ,EAAI,KAAK,MAAM,GAItG,IAAM,EAAY,EACZ,MAAM,QAAQ,IACV,EAAS,IAAK,GACVC,EAAM,OAAO,EAAK,SAAY,CAC1B,GAAM,CAAE,KAAM,GAAQ,MAAMF,EAAI,GAC1BG,EAAI,EAAQ,KAAK,GAEvB,OAAO,EAAW,EAAKA,OAInC,GAEA,EAAQ,CAAC,GAAG,EAAW,GAAG,EAAU,QAE1C,MAAO,CACH,MAAO,EAAE,cAAc,OACvB,OACA,KAAM"}