{"version":3,"file":"home-timeline-DLuhZWMn.js","names":["route: Route","ConfigNotFoundError","utils","got"],"sources":["../../lib/routes/misskey/home-timeline.ts"],"sourcesContent":["import { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nimport { Route, ViewType } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { queryToBoolean } from '@/utils/readable-social';\r\nimport querystring from 'node:querystring';\r\nimport utils from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/timeline/home/:site/:routeParams?',\r\n    categories: ['social-media'],\r\n    view: ViewType.SocialMedia,\r\n    example: '/misskey/timeline/home/misskey.io',\r\n    parameters: {\r\n        site: 'instance address, domain only, without `http://` or `https://` protocol header',\r\n        routeParams: `\r\n| Key                  | Description                             | Accepted Values | Default |\r\n| -------------------- | --------------------------------------- | --------------- | ------- |\r\n| limit                | Number of notes to return               | integer         | 10      |\r\n| withFiles            | Only return notes containing files      | 0/1/true/false  | false   |\r\n| withRenotes          | Include renotes in the timeline         | 0/1/true/false  | true    |\r\n| allowPartial         | Allow partial results                   | 0/1/true/false  | true    |\r\n| simplifyAuthor       | Simplify author field in feed items     | 0/1/true/false  | true    |\r\n\r\nNote: If \\`withFiles\\` is set to true, renotes will not be included in the timeline regardless of the value of \\`withRenotes\\`.\r\n\r\nExamples:\r\n- /misskey/timeline/home/misskey.io/limit=20&withFiles=true\r\n- /misskey/timeline/home/misskey.io/withRenotes=false\r\n        `,\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'MISSKEY_ACCESS_TOKEN',\r\n                optional: false,\r\n                description: `\r\n                    Access token for Misskey API. Requires \\`read:account\\` access.\r\n\r\n                    Visit the specified site's settings page to obtain an access token. E.g. https://misskey.io/settings/api\r\n                `,\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['misskey.io'],\r\n        },\r\n    ],\r\n    name: 'Home Timeline',\r\n    maintainers: ['HanaokaYuzu'],\r\n    handler,\r\n    description: `::: warning\r\n    This route is only available for self-hosted instances.\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const access_token = config.misskey.accessToken;\r\n    if (!access_token) {\r\n        throw new ConfigNotFoundError('Missing access token for Misskey API. Please set `MISSKEY_ACCESS_TOKEN` environment variable.');\r\n    }\r\n\r\n    const site = ctx.req.param('site');\r\n    if (!config.feature.allow_user_supply_unsafe_domain && !utils.allowSiteList.includes(site)) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n\r\n    // docs on: https://misskey.io/api-doc#tag/notes/operation/notes___timeline\r\n    const url = `https://${site}/api/notes/timeline`;\r\n    const routeParams = querystring.parse(ctx.req.param('routeParams'));\r\n    const response = await got({\r\n        method: 'post',\r\n        url,\r\n        headers: {\r\n            Authorization: `Bearer ${access_token}`,\r\n        },\r\n        json: {\r\n            limit: Number(routeParams.limit ?? 10),\r\n            withFiles: queryToBoolean(routeParams.withFiles ?? false),\r\n            withRenotes: queryToBoolean(routeParams.withRenotes ?? true),\r\n            allowPartial: queryToBoolean(routeParams.allowPartial ?? true),\r\n        },\r\n    });\r\n\r\n    const list = response.data;\r\n    const simplifyAuthor = queryToBoolean(routeParams.simplifyAuthor ?? true);\r\n\r\n    return {\r\n        title: `Home Timeline on ${site}`,\r\n        link: `https://${site}`,\r\n        item: utils.parseNotes(list, site, simplifyAuthor),\r\n    };\r\n}\r\n"],"mappings":"ulBAQA,MAAaA,EAAe,CACxB,KAAM,qCACN,WAAY,CAAC,gBACb,KAAM,EAAS,YACf,QAAS,oCACT,WAAY,CACR,KAAM,iFACN,YAAa;;;;;;;;;;;;;;WAgBjB,SAAU,CACN,cAAe,CACX,CACI,KAAM,uBACN,SAAU,GACV,YAAa;;;;oBAOrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,gBAGjB,KAAM,gBACN,YAAa,CAAC,eACd,UACA,YAAa;;MAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAe,EAAO,QAAQ,YACpC,GAAI,CAAC,EACD,MAAM,IAAIC,EAAoB,iGAGlC,IAAM,EAAO,EAAI,IAAI,MAAM,QAC3B,GAAI,CAAC,EAAO,QAAQ,iCAAmC,CAACC,EAAM,cAAc,SAAS,GACjF,MAAM,IAAID,EAAoB,mFAIlC,IAAM,EAAM,WAAW,EAAK,qBACtB,EAAc,EAAY,MAAM,EAAI,IAAI,MAAM,gBAC9C,EAAW,MAAME,EAAI,CACvB,OAAQ,OACR,MACA,QAAS,CACL,cAAe,UAAU,KAE7B,KAAM,CACF,MAAO,OAAO,EAAY,OAAS,IACnC,UAAW,EAAe,EAAY,WAAa,IACnD,YAAa,EAAe,EAAY,aAAe,IACvD,aAAc,EAAe,EAAY,cAAgB,OAI3D,EAAO,EAAS,KAChB,EAAiB,EAAe,EAAY,gBAAkB,IAEpE,MAAO,CACH,MAAO,oBAAoB,IAC3B,KAAM,WAAW,IACjB,KAAMD,EAAM,WAAW,EAAM,EAAM"}