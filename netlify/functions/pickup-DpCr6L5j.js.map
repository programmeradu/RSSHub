{"version":3,"file":"pickup-DpCr6L5j.js","names":["cache","got","route: Route"],"sources":["../../lib/routes/xiaoyuzhou/pickup.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\n\r\nconst XIAOYUZHOU_ITEMS = 'xiaoyuzhou_items';\r\n\r\nconst isToday = (date) => {\r\n    date = new Date(date);\r\n    const today = new Date();\r\n    return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();\r\n};\r\n\r\nconst ProcessFeed = async () => {\r\n    const device_id = config.xiaoyuzhou.device_id || 'f5d56d9a-8530-49a4-a6d2-cfb4b7a31240';\r\n    const refresh_token =\r\n        (await cache.get('XIAOYUZHOU_TOKEN')) ||\r\n        config.xiaoyuzhou.refresh_token ||\r\n        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjoiVzhieXB2dTJtT24xZWNqcEppN2p6R2xhMDBhMHYxellLaHFcL0ZXVWVkdDcxNlh3bnJnOFE0cFpGbVJmVFJQQ29ESWsxMmVuY3RcLzNqQWNjeFU3aTZNbkM4MUtWcUlmWWJJbVBKdXJDTXVYc1dHa2x0SE5TK3llNnJvTldLSWN1M1ZFTGY5WFE0cGhnK2crQld6bFloM2g0VUtONlNKWWlUSGtkaHowd0RJYXIrdTlzOE5PaEJPYXdJXC80NEFZcW41RjJqUXNnU3o1TExDSGtuTENuUFppRXllaTNwcVFwRkgweWFWbk03bmQ2RFhrUmVmUExVMTVpMXcwRnpkXC9wWDEiLCJ2IjozLCJpdiI6IkJiVGFjXC9KTG9BU1NYY0tPMkk3M0JBPT0iLCJpYXQiOjE1OTQ1NzIyOTEuODE2fQ.aQm7A6A1R3P94s88vWBWTbIeek9nJ-q9ztfCB7o1uK0';\r\n\r\n    const headers = {\r\n        applicationid: 'app.podcast.cosmos',\r\n        'app-version': '1.6.0',\r\n        'x-jike-device-id': device_id,\r\n        'user-agent': 'okhttp/4.7.2',\r\n    };\r\n\r\n    const token_updated = await got({\r\n        method: 'post',\r\n        url: 'https://api.xiaoyuzhoufm.com/app_auth_tokens.refresh',\r\n        headers: {\r\n            ...headers,\r\n            'x-jike-refresh-token': refresh_token,\r\n        },\r\n    });\r\n    cache.set('XIAOYUZHOU_TOKEN', token_updated.data['x-jike-refresh-token']);\r\n\r\n    const response = await got({\r\n        method: 'post',\r\n        url: 'https://api.xiaoyuzhoufm.com/v1/editor-pick/list',\r\n        headers: {\r\n            ...headers,\r\n            'x-jike-access-token': token_updated.data['x-jike-access-token'],\r\n        },\r\n    });\r\n\r\n    const data = response.data.data;\r\n    const playList = [];\r\n    for (const dailyPicks of data) {\r\n        const pubDate = new Date(dailyPicks.date + ' 00:00:00 +0800').toUTCString();\r\n        for (const pick of dailyPicks.picks) {\r\n            pick.pubDate = pubDate;\r\n            playList.push(pick);\r\n        }\r\n    }\r\n\r\n    return playList.map((item) => {\r\n        const title = item.episode.title + ' - ' + item.episode.podcast.title;\r\n        const eid = item.episode.eid;\r\n        const itunes_item_image = item.episode.image ? item.episode.image.picUrl : item.episode.podcast.image ? item.episode.podcast.image.picUrl : '';\r\n        const link = `https://www.xiaoyuzhoufm.com/episode/${eid}`;\r\n        const pubDate = item.pubDate;\r\n        const itunes_duration = item.episode.duration;\r\n        const enclosure_url = item.episode.enclosure.url;\r\n        const desc = `<p><strong>${item.comment.author.nickname}：</strong>${item.comment.text}</p><hr>` + item.episode.shownotes;\r\n        const author = item.episode.podcast.author;\r\n\r\n        return {\r\n            title,\r\n            description: desc,\r\n            link,\r\n            author,\r\n            pubDate,\r\n            enclosure_url,\r\n            itunes_duration,\r\n            itunes_item_image,\r\n            enclosure_type: 'audio/mpeg',\r\n        };\r\n    });\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/',\r\n    radar: [\r\n        {\r\n            source: ['xiaoyuzhoufm.com/'],\r\n            target: '',\r\n        },\r\n    ],\r\n    name: 'Unknown',\r\n    maintainers: ['prnake', 'Maecenas'],\r\n    handler,\r\n    url: 'xiaoyuzhoufm.com/',\r\n};\r\n\r\nasync function handler() {\r\n    let resultItems = await cache.tryGet(XIAOYUZHOU_ITEMS, () => ProcessFeed());\r\n    if (!isToday(resultItems[0].pubDate)) {\r\n        // force refresh cache\r\n        resultItems = await ProcessFeed();\r\n        cache.set(XIAOYUZHOU_ITEMS, resultItems);\r\n    }\r\n    return {\r\n        title: '小宇宙 - 发现',\r\n        link: 'https://www.xiaoyuzhoufm.com/',\r\n        description: '小宇宙的编辑精选',\r\n        image: 'https://www.xiaoyuzhoufm.com/apple-touch-icon.png',\r\n        itunes_author: '小宇宙',\r\n        itunes_category: 'Society & Culture',\r\n        item: resultItems,\r\n    };\r\n}\r\n"],"mappings":"qSAKA,MAAM,EAAmB,mBAEnB,EAAW,GAAS,CACtB,EAAO,IAAI,KAAK,GAChB,IAAM,EAAQ,IAAI,KAClB,OAAO,EAAK,YAAc,EAAM,WAAa,EAAK,aAAe,EAAM,YAAc,EAAK,gBAAkB,EAAM,eAGhH,EAAc,SAAY,CAC5B,IAAM,EAAY,EAAO,WAAW,WAAa,uCAC3C,EACD,MAAMA,EAAM,IAAI,qBACjB,EAAO,WAAW,eAClB,8gBAEE,EAAU,CACZ,cAAe,qBACf,cAAe,QACf,mBAAoB,EACpB,aAAc,gBAGZ,EAAgB,MAAMC,EAAI,CAC5B,OAAQ,OACR,IAAK,uDACL,QAAS,CACL,GAAG,EACH,uBAAwB,KAGhC,EAAM,IAAI,mBAAoB,EAAc,KAAK,yBAEjD,IAAM,EAAW,MAAMA,EAAI,CACvB,OAAQ,OACR,IAAK,mDACL,QAAS,CACL,GAAG,EACH,sBAAuB,EAAc,KAAK,0BAI5C,EAAO,EAAS,KAAK,KACrB,EAAW,GACjB,IAAK,IAAM,KAAc,EAAM,CAC3B,IAAM,EAAU,IAAI,KAAK,EAAW,KAAO,mBAAmB,cAC9D,IAAK,IAAM,KAAQ,EAAW,MAC1B,EAAK,QAAU,EACf,EAAS,KAAK,GAItB,OAAO,EAAS,IAAK,GAAS,CAC1B,IAAM,EAAQ,EAAK,QAAQ,MAAQ,MAAQ,EAAK,QAAQ,QAAQ,MAC1D,EAAM,EAAK,QAAQ,IACnB,EAAoB,EAAK,QAAQ,MAAQ,EAAK,QAAQ,MAAM,OAAS,EAAK,QAAQ,QAAQ,MAAQ,EAAK,QAAQ,QAAQ,MAAM,OAAS,GACtI,EAAO,wCAAwC,IAC/C,EAAU,EAAK,QACf,EAAkB,EAAK,QAAQ,SAC/B,EAAgB,EAAK,QAAQ,UAAU,IACvC,EAAO,cAAc,EAAK,QAAQ,OAAO,SAAS,YAAY,EAAK,QAAQ,KAAK,UAAY,EAAK,QAAQ,UACzG,EAAS,EAAK,QAAQ,QAAQ,OAEpC,MAAO,CACH,QACA,YAAa,EACb,OACA,SACA,UACA,gBACA,kBACA,oBACA,eAAgB,iBAKfC,EAAe,CACxB,KAAM,IACN,MAAO,CACH,CACI,OAAQ,CAAC,qBACT,OAAQ,KAGhB,KAAM,UACN,YAAa,CAAC,SAAU,YACxB,UACA,IAAK,qBAGT,eAAe,GAAU,CACrB,IAAI,EAAc,MAAMF,EAAM,OAAO,MAAwB,KAM7D,OALK,EAAQ,EAAY,GAAG,WAExB,EAAc,MAAM,IACpB,EAAM,IAAI,EAAkB,IAEzB,CACH,MAAO,WACP,KAAM,gCACN,YAAa,WACb,MAAO,oDACP,cAAe,MACf,gBAAiB,oBACjB,KAAM"}