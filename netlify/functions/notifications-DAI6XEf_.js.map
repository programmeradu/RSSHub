{"version":3,"file":"notifications-DAI6XEf_.js","names":["route: Route","ofetch","cache"],"sources":["../../lib/routes/discourse/notifications.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { getConfig } from './utils';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/:configId/notifications/:fulltext?',\r\n    categories: ['bbs'],\r\n    example: '/discourse/0/notifications',\r\n    parameters: { configId: 'Environment variable configuration id, see above', fulltext: 'Fetch the content if the notification points to a post. This is disabled by default, set it to `1` to enable it.' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'DISCOURSE_CONFIG_*',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Notifications',\r\n    maintainers: [],\r\n    handler,\r\n    description: `::: warning\r\nIf you opt to enable \\`fulltext\\` feature, consider adding \\`limit\\` parameter to your query to avoid sending too many request.\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { link, key } = getConfig(ctx);\r\n\r\n    const response = await ofetch(`${link}/notifications.json`, { headers: { 'User-Api-Key': key } });\r\n    let items = response.notifications.slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 10).map((e) => ({\r\n        title: e.fancy_title ?? e.data.badge_name,\r\n        link: `${link}/${Object.hasOwn(e.data, 'badge_id') ? `badges/${e.data.badge_id}/${e.data.badge_slug}?username=${e.data.username}` : `t/topic/${e.topic_id}/${e.post_number}`}`,\r\n        pubDate: new Date(e.created_at),\r\n        author: e.data.display_username ?? e.data.username,\r\n        category: [`notification_type:${e.notification_type}`, `read:${e.read}`, `high_priority:${e.high_priority}`],\r\n        original_post_id: e.data.original_post_id,\r\n    }));\r\n\r\n    if (ctx.req.param('fulltext') === '1') {\r\n        items = await Promise.all(\r\n            items.map((e) => {\r\n                if (e.original_post_id) {\r\n                    const post_link = `${link}/posts/${e.original_post_id}.json`;\r\n                    return cache.tryGet(post_link, async () => {\r\n                        const { cooked } = await ofetch(post_link, { headers: { 'User-Api-Key': key } });\r\n                        return { ...e, description: cooked };\r\n                    });\r\n                } else {\r\n                    return e;\r\n                }\r\n            })\r\n        );\r\n    }\r\n\r\n    const { about } = await cache.tryGet(link, async () => await ofetch(`${link}/about.json`, { headers: { 'User-Api-Key': key } }), config.cache.routeExpire, false);\r\n    return {\r\n        title: `${about.title} - Notifications`,\r\n        description: about.description,\r\n        item: items,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"uUAMA,MAAaA,EAAe,CACxB,KAAM,sCACN,WAAY,CAAC,OACb,QAAS,6BACT,WAAY,CAAE,SAAU,mDAAoD,SAAU,oHACtF,SAAU,CACN,cAAe,CACX,CACI,KAAM,qBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,gBACN,YAAa,GACb,UACA,YAAa,iJAKjB,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAM,OAAQ,EAAU,GAE1B,EAAW,MAAMC,EAAO,GAAG,EAAK,qBAAsB,CAAE,QAAS,CAAE,eAAgB,KACrF,EAAQ,EAAS,cAAc,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAAI,IAAK,IAAO,CAC3H,MAAO,EAAE,aAAe,EAAE,KAAK,WAC/B,KAAM,GAAG,EAAK,GAAG,OAAO,OAAO,EAAE,KAAM,YAAc,UAAU,EAAE,KAAK,SAAS,GAAG,EAAE,KAAK,WAAW,YAAY,EAAE,KAAK,WAAa,WAAW,EAAE,SAAS,GAAG,EAAE,gBAC/J,QAAS,IAAI,KAAK,EAAE,YACpB,OAAQ,EAAE,KAAK,kBAAoB,EAAE,KAAK,SAC1C,SAAU,CAAC,qBAAqB,EAAE,oBAAqB,QAAQ,EAAE,OAAQ,iBAAiB,EAAE,iBAC5F,iBAAkB,EAAE,KAAK,oBAGzB,EAAI,IAAI,MAAM,cAAgB,MAC9B,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GAAM,CACb,GAAI,EAAE,iBAAkB,CACpB,IAAM,EAAY,GAAG,EAAK,SAAS,EAAE,iBAAiB,OACtD,OAAOC,EAAM,OAAO,EAAW,SAAY,CACvC,GAAM,CAAE,UAAW,MAAMD,EAAO,EAAW,CAAE,QAAS,CAAE,eAAgB,KACxE,MAAO,CAAE,GAAG,EAAG,YAAa,UAGhC,OAAO,MAMvB,GAAM,CAAE,SAAU,MAAMC,EAAM,OAAO,EAAM,SAAY,MAAMD,EAAO,GAAG,EAAK,aAAc,CAAE,QAAS,CAAE,eAAgB,KAAU,EAAO,MAAM,YAAa,IAC3J,MAAO,CACH,MAAO,GAAG,EAAM,MAAM,kBACtB,YAAa,EAAM,YACnB,KAAM,EACN,WAAY"}