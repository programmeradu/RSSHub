{"version":3,"file":"utils-BHXgz0H0.js","names":[],"sources":["../../lib/routes/1point3acres/utils.ts"],"sourcesContent":["import got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport type { BBobCoreTagNodeTree } from '@bbob/types';\r\nimport bbobHTML from '@bbob/html';\r\nimport presetHTML5 from '@bbob/preset-html5';\r\n\r\nconst rootUrl = 'https://instant.1point3acres.com';\r\nconst apiRootUrl = 'https://api.1point3acres.com';\r\n\r\nconst types = {\r\n    new: '最新帖子',\r\n    hot: '热门帖子',\r\n};\r\n\r\nconst swapLinebreak = (tree: BBobCoreTagNodeTree) =>\r\n    tree.walk((node) => {\r\n        if (typeof node === 'string' && node === '\\n') {\r\n            return {\r\n                tag: 'br',\r\n                content: null,\r\n            };\r\n        }\r\n        return node;\r\n    });\r\n\r\nconst ProcessThreads = async (tryGet, apiUrl, order) => {\r\n    const response = await got({\r\n        method: 'get',\r\n        url: apiUrl,\r\n        headers: {\r\n            referer: rootUrl,\r\n        },\r\n    });\r\n\r\n    const items = await Promise.all(\r\n        response.data.threads.map((item) => {\r\n            const result = {\r\n                guid: item.tid,\r\n                title: item.subject,\r\n                author: item.author,\r\n                link: `${rootUrl}/thread/${item.tid}`,\r\n                description: item.summary,\r\n                pubDate: parseDate((order === '' ? item.lastpost : item.dateline) * 1000),\r\n                category: [item.forum_name, ...item.tags.map((t) => t.displayname)],\r\n            };\r\n\r\n            return tryGet(result.link, async () => {\r\n                try {\r\n                    const detailResponse = await got({\r\n                        method: 'get',\r\n                        url: `${apiRootUrl}/api/v3/threads/${result.guid}`,\r\n                        headers: {\r\n                            referer: rootUrl,\r\n                        },\r\n                    });\r\n\r\n                    const thread = detailResponse.data.thread;\r\n\r\n                    const customPreset = presetHTML5.extend((tags) => ({\r\n                        ...tags,\r\n                        attach: (node, { render }) => {\r\n                            const id = render(node.content);\r\n                            const attachment = thread.attachment_list.find((a) => a.aid === Number.parseInt(id));\r\n\r\n                            if (attachment.isimage) {\r\n                                return {\r\n                                    tag: 'img',\r\n                                    attrs: {\r\n                                        src: attachment.url,\r\n                                    },\r\n                                };\r\n                            }\r\n\r\n                            return {\r\n                                tag: 'a',\r\n                                attrs: {\r\n                                    href: `https://www.1point3acres.com/bbs/plugin.php?id=attachcenter:page&aid=${id}`,\r\n                                    rel: 'noopener',\r\n                                    target: '_blank',\r\n                                },\r\n                                content: `https://www.1point3acres.com/bbs/plugin.php?id=attachcenter:page&aid=${id}`,\r\n                            };\r\n                        },\r\n                        url: (node) => {\r\n                            const link = Object.keys(node.attrs as Record<string, string>)[0];\r\n                            if (link.startsWith('https://link.1p3a.com/?url=')) {\r\n                                const url = decodeURIComponent(link.replace('https://link.1p3a.com/?url=', ''));\r\n                                return {\r\n                                    tag: 'a',\r\n                                    attrs: {\r\n                                        href: url,\r\n                                        rel: 'noopener',\r\n                                        target: '_blank',\r\n                                    },\r\n                                    content: node.content,\r\n                                };\r\n                            }\r\n\r\n                            return {\r\n                                tag: 'a',\r\n                                attrs: {\r\n                                    href: link,\r\n                                    rel: 'noopener',\r\n                                    target: '_blank',\r\n                                },\r\n                                content: node.content,\r\n                            };\r\n                        },\r\n                    }));\r\n\r\n                    result.description = bbobHTML(thread.message_bbcode, [customPreset(), swapLinebreak]);\r\n\r\n                    if (!thread.message_bbcode.includes('[attach]') && thread.attachment_list.length > 0) {\r\n                        for (const a of thread.attachment_list) {\r\n                            result.description +=\r\n                                a.isimage === 1\r\n                                    ? '<br>' +\r\n                                      art(path.join(__dirname, 'templates/image.art'), {\r\n                                          url: a.url,\r\n                                          height: a.height,\r\n                                          width: a.width,\r\n                                      })\r\n                                    : '';\r\n                        }\r\n                    }\r\n                } catch {\r\n                    // no-empty\r\n                }\r\n\r\n                return result;\r\n            });\r\n        })\r\n    );\r\n\r\n    return items;\r\n};\r\n\r\nexport { rootUrl, apiRootUrl, types, ProcessThreads };\r\n"],"mappings":"iTAQA,MAAM,EAAU,mCACV,EAAa,+BAEb,EAAQ,CACV,IAAK,OACL,IAAK,QAGH,EAAiB,GACnB,EAAK,KAAM,GACH,OAAO,GAAS,UAAY,IAAS;EAC9B,CACH,IAAK,KACL,QAAS,MAGV,GAGT,EAAiB,MAAO,EAAQ,EAAQ,IAAU,CACpD,IAAM,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,EACL,QAAS,CACL,QAAS,KAIX,EAAQ,MAAM,QAAQ,IACxB,EAAS,KAAK,QAAQ,IAAK,GAAS,CAChC,IAAM,EAAS,CACX,KAAM,EAAK,IACX,MAAO,EAAK,QACZ,OAAQ,EAAK,OACb,KAAM,GAAG,EAAQ,UAAU,EAAK,MAChC,YAAa,EAAK,QAClB,QAAS,GAAW,IAAU,GAAK,EAAK,SAAW,EAAK,UAAY,KACpE,SAAU,CAAC,EAAK,WAAY,GAAG,EAAK,KAAK,IAAK,GAAM,EAAE,eAG1D,OAAO,EAAO,EAAO,KAAM,SAAY,CACnC,GAAI,CACA,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,GAAG,EAAW,kBAAkB,EAAO,OAC5C,QAAS,CACL,QAAS,KAIX,EAAS,EAAe,KAAK,OAE7B,EAAe,EAAY,OAAQ,IAAU,CAC/C,GAAG,EACH,QAAS,EAAM,CAAE,YAAa,CAC1B,IAAM,EAAK,EAAO,EAAK,SACjB,EAAa,EAAO,gBAAgB,KAAM,GAAM,EAAE,MAAQ,OAAO,SAAS,IAWhF,OATI,EAAW,QACJ,CACH,IAAK,MACL,MAAO,CACH,IAAK,EAAW,MAKrB,CACH,IAAK,IACL,MAAO,CACH,KAAM,wEAAwE,IAC9E,IAAK,WACL,OAAQ,UAEZ,QAAS,wEAAwE,MAGzF,IAAM,GAAS,CACX,IAAM,EAAO,OAAO,KAAK,EAAK,OAAiC,GAC/D,GAAI,EAAK,WAAW,+BAAgC,CAChD,IAAM,EAAM,mBAAmB,EAAK,QAAQ,8BAA+B,KAC3E,MAAO,CACH,IAAK,IACL,MAAO,CACH,KAAM,EACN,IAAK,WACL,OAAQ,UAEZ,QAAS,EAAK,SAItB,MAAO,CACH,IAAK,IACL,MAAO,CACH,KAAM,EACN,IAAK,WACL,OAAQ,UAEZ,QAAS,EAAK,aAO1B,GAFA,EAAO,YAAc,EAAS,EAAO,eAAgB,CAAC,IAAgB,IAElE,CAAC,EAAO,eAAe,SAAS,aAAe,EAAO,gBAAgB,OAAS,EAC/E,IAAK,IAAM,KAAK,EAAO,gBACnB,EAAO,aACH,EAAE,UAAY,EACR,OACA,EAAI,EAAA,KAAA,EAAA,gCAA6C,CAC7C,IAAK,EAAE,IACP,OAAQ,EAAE,OACV,MAAO,EAAE,QAEb,QAGd,EAIR,OAAO,OAKnB,OAAO"}