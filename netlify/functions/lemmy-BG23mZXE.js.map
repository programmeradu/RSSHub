{"version":3,"file":"lemmy-BG23mZXE.js","names":["MarkdownIt","route: Route","InvalidParameterError","ConfigNotFoundError","cache","got"],"sources":["../../lib/routes/lemmy/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport MarkdownIt from 'markdown-it';\r\nconst md = MarkdownIt({ html: true });\r\nimport { config } from '@/config';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/:community/:sort?',\r\n    categories: ['social-media'],\r\n    example: '/lemmy/technology@lemmy.world/Hot',\r\n    parameters: {\r\n        community: 'Lemmmy community, for example technology@lemmy.world',\r\n        sort: {\r\n            description: 'Sort by',\r\n            options: [\r\n                { value: 'Active', label: 'Active' },\r\n                { value: 'Hot', label: 'Hot' },\r\n                { value: 'New', label: 'New' },\r\n                { value: 'Old', label: 'Old' },\r\n                { value: 'TopDay', label: 'TopDay' },\r\n                { value: 'TopWeek', label: 'TopWeek' },\r\n                { value: 'TopMonth', label: 'TopMonth' },\r\n                { value: 'TopYear', label: 'TopYear' },\r\n                { value: 'TopAll', label: 'TopAll' },\r\n                { value: 'MostComments', label: 'MostComments' },\r\n                { value: 'NewComments', label: 'NewComments' },\r\n                { value: 'TopHour', label: 'TopHour' },\r\n                { value: 'TopSixHour', label: 'TopSixHour' },\r\n                { value: 'TopTwelveHour', label: 'TopTwelveHour' },\r\n                { value: 'TopThreeMonths', label: 'TopThreeMonths' },\r\n                { value: 'TopSixMonths', label: 'TopSixMonths' },\r\n                { value: 'TopNineMonths', label: 'TopNineMonths' },\r\n                { value: 'Controversial', label: 'Controversial' },\r\n                { value: 'Scaled', label: 'Scaled' },\r\n            ],\r\n            default: 'Active',\r\n        },\r\n    },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Community',\r\n    maintainers: ['wb14123', 'pseudoyu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const sort = ctx.req.param('sort') ?? 'Active';\r\n    const community = ctx.req.param('community');\r\n    const communitySlices = community.split('@');\r\n    if (communitySlices.length !== 2) {\r\n        throw new InvalidParameterError(`Invalid community: ${community}`);\r\n    }\r\n    const instance = community.split('@')[1];\r\n    const allowedDomain = ['lemmy.world', 'lemm.ee', 'lemmy.ml', 'sh.itjust.works', 'feddit.de', 'hexbear.net', 'beehaw.org', 'lemmynsfw.com', 'lemmy.ca', 'programming.dev'];\r\n    if (!config.feature.allow_user_supply_unsafe_domain && !allowedDomain.includes(new URL(`http://${instance}/`).hostname)) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n\r\n    const communityUrl = `https://${instance}/api/v3/community?name=${community}`;\r\n    const communityData = await cache.tryGet(communityUrl, async () => {\r\n        const result = await got({ method: 'get', url: communityUrl, headers: { 'Content-Type': 'application/json' } });\r\n        return result.data.community_view.community;\r\n    });\r\n\r\n    const postUrl = `https://${instance}/api/v3/post/list?type_=All&sort=${sort}&community_name=${community}&limit=50`;\r\n    const postData = await cache.tryGet(\r\n        postUrl,\r\n        async () => {\r\n            const result = await got({ method: 'get', url: postUrl, headers: { 'Content-Type': 'application/json' } });\r\n            return result.data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const items = postData.posts.map((e) => {\r\n        const post = e.post;\r\n        const creator = e.creator;\r\n        const counts = e.counts;\r\n        const item = {};\r\n        item.title = post.name;\r\n        item.author = creator.name;\r\n        item.pubDate = parseDate(post.published);\r\n        item.link = post.ap_id;\r\n        const url = post.url;\r\n        const urlContent = url ? `<p><a href=\"${url}\">${url}</a></p>` : '';\r\n        const body = post.body ? md.render(post.body) : '';\r\n        item.description = urlContent + body;\r\n        item.comments = counts.comments;\r\n        item.upvotes = counts.upvotes;\r\n        item.downvotes = counts.downvotes;\r\n        return item;\r\n    });\r\n\r\n    return {\r\n        title: `${community} - ${sort} posts`,\r\n        description: communityData.description,\r\n        link: communityData.actor_id,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"2gBAKA,MAAM,EAAKA,EAAW,CAAE,KAAM,KAKjBC,EAAe,CACxB,KAAM,qBACN,WAAY,CAAC,gBACb,QAAS,oCACT,WAAY,CACR,UAAW,uDACX,KAAM,CACF,YAAa,UACb,QAAS,CACL,CAAE,MAAO,SAAU,MAAO,UAC1B,CAAE,MAAO,MAAO,MAAO,OACvB,CAAE,MAAO,MAAO,MAAO,OACvB,CAAE,MAAO,MAAO,MAAO,OACvB,CAAE,MAAO,SAAU,MAAO,UAC1B,CAAE,MAAO,UAAW,MAAO,WAC3B,CAAE,MAAO,WAAY,MAAO,YAC5B,CAAE,MAAO,UAAW,MAAO,WAC3B,CAAE,MAAO,SAAU,MAAO,UAC1B,CAAE,MAAO,eAAgB,MAAO,gBAChC,CAAE,MAAO,cAAe,MAAO,eAC/B,CAAE,MAAO,UAAW,MAAO,WAC3B,CAAE,MAAO,aAAc,MAAO,cAC9B,CAAE,MAAO,gBAAiB,MAAO,iBACjC,CAAE,MAAO,iBAAkB,MAAO,kBAClC,CAAE,MAAO,eAAgB,MAAO,gBAChC,CAAE,MAAO,gBAAiB,MAAO,iBACjC,CAAE,MAAO,gBAAiB,MAAO,iBACjC,CAAE,MAAO,SAAU,MAAO,WAE9B,QAAS,WAGjB,SAAU,CACN,cAAe,CACX,CACI,KAAM,kCACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,YACN,YAAa,CAAC,UAAW,YACzB,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,SAChC,EAAY,EAAI,IAAI,MAAM,aAC1B,EAAkB,EAAU,MAAM,KACxC,GAAI,EAAgB,SAAW,EAC3B,MAAM,IAAIC,EAAsB,sBAAsB,KAE1D,IAAM,EAAW,EAAU,MAAM,KAAK,GAChC,EAAgB,CAAC,cAAe,UAAW,WAAY,kBAAmB,YAAa,cAAe,aAAc,gBAAiB,WAAY,mBACvJ,GAAI,CAAC,EAAO,QAAQ,iCAAmC,CAAC,EAAc,SAAS,IAAI,IAAI,UAAU,EAAS,IAAI,UAC1G,MAAM,IAAIC,EAAoB,mFAGlC,IAAM,EAAe,WAAW,EAAS,yBAAyB,IAC5D,EAAgB,MAAMC,EAAM,OAAO,EAAc,SAAY,CAC/D,IAAM,EAAS,MAAMC,EAAI,CAAE,OAAQ,MAAO,IAAK,EAAc,QAAS,CAAE,eAAgB,sBACxF,OAAO,EAAO,KAAK,eAAe,YAGhC,EAAU,WAAW,EAAS,mCAAmC,EAAK,kBAAkB,EAAU,WAClG,EAAW,MAAMD,EAAM,OACzB,EACA,SAAY,CACR,IAAM,EAAS,MAAMC,EAAI,CAAE,OAAQ,MAAO,IAAK,EAAS,QAAS,CAAE,eAAgB,sBACnF,OAAO,EAAO,MAElB,EAAO,MAAM,YACb,IAGE,EAAQ,EAAS,MAAM,IAAK,GAAM,CACpC,IAAM,EAAO,EAAE,KACT,EAAU,EAAE,QACZ,EAAS,EAAE,OACX,EAAO,GACb,EAAK,MAAQ,EAAK,KAClB,EAAK,OAAS,EAAQ,KACtB,EAAK,QAAU,EAAU,EAAK,WAC9B,EAAK,KAAO,EAAK,MACjB,IAAM,EAAM,EAAK,IACX,EAAa,EAAM,eAAe,EAAI,IAAI,EAAI,UAAY,GAC1D,EAAO,EAAK,KAAO,EAAG,OAAO,EAAK,MAAQ,GAKhD,MAJA,GAAK,YAAc,EAAa,EAChC,EAAK,SAAW,EAAO,SACvB,EAAK,QAAU,EAAO,QACtB,EAAK,UAAY,EAAO,UACjB,IAGX,MAAO,CACH,MAAO,GAAG,EAAU,KAAK,EAAK,QAC9B,YAAa,EAAc,YAC3B,KAAM,EAAc,SACpB,KAAM"}