{"version":3,"file":"btzj-mtocB8gJ.js","names":[],"sources":["../../lib/routes/btzj/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nconst allowDomain = new Set(['2btjia.com', '88btbtt.com', 'btbtt15.com', 'btbtt20.com']);\r\n\r\nexport const route: Route = {\r\n    path: '/:category?',\r\n    categories: ['multimedia'],\r\n    example: '/btzj',\r\n    parameters: { category: '分类，可在对应分类页 URL 中找到，默认为首页' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['btbtt20.com/'],\r\n        },\r\n    ],\r\n    name: '分类',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    url: 'btbtt20.com/',\r\n    description: `::: tip\r\n  分类页中域名末尾到 \\`.htm\\` 前的字段即为对应分类，如 [电影](https://www.btbtt20.com/forum-index-fid-951.htm) \\`https://www.btbtt20.com/forum-index-fid-951.htm\\` 中域名末尾到 \\`.htm\\` 前的字段为 \\`forum-index-fid-951\\`，所以路由应为 [\\`/btzj/forum-index-fid-951\\`](https://rsshub.app/btzj/forum-index-fid-951)\r\n\r\n  部分分类页，如 [电影](https://www.btbtt20.com/forum-index-fid-951.htm)、[剧集](https://www.btbtt20.com/forum-index-fid-950.htm) 等，提供了更复杂的分类筛选。你可以将选项选中后，获得结果分类页 URL 中分类参数，构成路由。如选中分类 [高清电影 - 年份：2021 - 地区：欧美](https://www.btbtt20.com/forum-index-fid-1183-typeid1-0-typeid2-738-typeid3-10086-typeid4-0.htm) \\`https://www.btbtt20.com/forum-index-fid-1183-typeid1-0-typeid2-738-typeid3-10086-typeid4-0.htm\\` 中域名末尾到 \\`.htm\\` 前的字段为 \\`forum-index-fid-1183-typeid1-0-typeid2-738-typeid3-10086-typeid4-0\\`，所以路由应为 [\\`/btzj/forum-index-fid-1183-typeid1-0-typeid2-738-typeid3-10086-typeid4-0\\`](https://rsshub.app/btzj/forum-index-fid-1183-typeid1-0-typeid2-738-typeid3-10086-typeid4-0)\r\n:::\r\n\r\n  基础分类如下：\r\n\r\n| 交流                | 电影                | 剧集                | 高清电影             |\r\n| ------------------- | ------------------- | ------------------- | -------------------- |\r\n| forum-index-fid-975 | forum-index-fid-951 | forum-index-fid-950 | forum-index-fid-1183 |\r\n\r\n| 音乐                | 动漫                | 游戏                | 综艺                 |\r\n| ------------------- | ------------------- | ------------------- | -------------------- |\r\n| forum-index-fid-953 | forum-index-fid-981 | forum-index-fid-955 | forum-index-fid-1106 |\r\n\r\n| 图书                 | 美图                | 站务              | 科技                |\r\n| -------------------- | ------------------- | ----------------- | ------------------- |\r\n| forum-index-fid-1151 | forum-index-fid-957 | forum-index-fid-2 | forum-index-fid-952 |\r\n\r\n| 求助                 | 音轨字幕             |\r\n| -------------------- | -------------------- |\r\n| forum-index-fid-1187 | forum-index-fid-1191 |\r\n\r\n::: tip\r\n  BT 之家的域名会变更，本路由以 \\`https://www.btbtt20.com\\` 为默认域名，若该域名无法访问，可以通过在路由后方加上 \\`?domain=<域名>\\` 指定路由访问的域名。如指定域名为 \\`https://www.btbtt15.com\\`，则在 \\`/btzj\\` 后加上 \\`?domain=btbtt15.com\\` 即可，此时路由为 [\\`/btzj?domain=btbtt15.com\\`](https://rsshub.app/btzj?domain=btbtt15.com)\r\n\r\n  如果加入了分类参数，直接在分类参数后加入 \\`?domain=<域名>\\` 即可。如指定分类 [剧集](https://www.btbtt20.com/forum-index-fid-950.htm) \\`https://www.btbtt20.com/forum-index-fid-950.htm\\` 并指定域名为 \\`https://www.btbtt15.com\\`，即在 \\`/btzj/forum-index-fid-950\\` 后加上 \\`?domain=btbtt15.com\\`，此时路由为 [\\`/btzj/forum-index-fid-950?domain=btbtt15.com\\`](https://rsshub.app/btzj/forum-index-fid-950?domain=btbtt15.com)\r\n\r\n  目前，你可以选择的域名有 \\`btbtt10-20.com\\` 共 10 个，或 \\`88btbbt.com\\`，该站也提供了专用网址查询工具。详见 [此贴](https://www.btbtt20.com/thread-index-fid-2-tid-4550191.htm)\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    let category = ctx.req.param('category') ?? '';\r\n    let domain = ctx.req.query('domain') ?? 'btbtt15.com';\r\n    if (!config.feature.allow_user_supply_unsafe_domain && !allowDomain.has(new URL(`http://${domain}/`).hostname)) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n\r\n    if (category === 'base') {\r\n        category = '';\r\n        domain = '88btbtt.com';\r\n    } else if (category === 'govern') {\r\n        category = '';\r\n        domain = '2btjia.com';\r\n    }\r\n\r\n    const rootUrl = `https://www.${domain}`;\r\n    const currentUrl = `${rootUrl}${category ? `/${category}.htm` : ''}`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    $('.bg2').prevAll('table').remove();\r\n\r\n    let items = $('#threadlist table')\r\n        .toArray()\r\n        .map((item) => {\r\n            const a = $(item).find('.subject_link');\r\n\r\n            return {\r\n                title: a.text(),\r\n                link: `${rootUrl}/${a.attr('href')}`,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'get',\r\n                    url: item.link,\r\n                });\r\n\r\n                const content = load(detailResponse.data);\r\n\r\n                content('h2, .message').remove();\r\n\r\n                content('.attachlist')\r\n                    .find('a')\r\n                    .each(function () {\r\n                        content(this)\r\n                            .children('img')\r\n                            .attr('src', `${rootUrl}${content(this).children('img').attr('src')}`);\r\n                        content(this).attr(\r\n                            'href',\r\n                            `${rootUrl}/${content(this)\r\n                                .attr('href')\r\n                                .replace(/^attach-dialog/, 'attach-download')}`\r\n                        );\r\n                    });\r\n\r\n                const torrents = content('.attachlist').find('a');\r\n\r\n                item.description = content('.post').html();\r\n                item.author = content('.purple, .grey').first().prev().text();\r\n                item.pubDate = timezone(parseDate(content('.bg2 b').first().text()), +8);\r\n\r\n                if (torrents.length > 0) {\r\n                    item.description += art(path.join(__dirname, 'templates/torrents.art'), {\r\n                        torrents: torrents.toArray().map((t) => content(t).parent().html()),\r\n                    });\r\n                    item.enclosure_type = 'application/x-bittorrent';\r\n                    item.enclosure_url = torrents.first().attr('href');\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${$('#menu, #threadtype')\r\n            .find('.checked')\r\n            .toArray()\r\n            .map((c) => $(c).text())\r\n            .filter((c) => c !== '全部')\r\n            .join('|')} - BT之家`,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"qmBAWA,MAAM,EAAc,IAAI,IAAI,CAAC,aAAc,cAAe,cAAe,gBAE5D,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,cACb,QAAS,QACT,WAAY,CAAE,SAAU,4BACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,kBAGjB,KAAM,KACN,YAAa,CAAC,WACd,UACA,IAAK,eACL,YAAa,smFAiCjB,eAAe,EAAQ,EAAK,CACxB,IAAI,EAAW,EAAI,IAAI,MAAM,aAAe,GACxC,EAAS,EAAI,IAAI,MAAM,WAAa,cACxC,GAAI,CAAC,EAAO,QAAQ,iCAAmC,CAAC,EAAY,IAAI,IAAI,IAAI,UAAU,EAAO,IAAI,UACjG,MAAM,IAAI,EAAoB,mFAG9B,IAAa,QACb,EAAW,GACX,EAAS,eACF,IAAa,WACpB,EAAW,GACX,EAAS,cAGb,IAAM,EAAU,eAAe,IACzB,EAAa,GAAG,IAAU,EAAW,IAAI,EAAS,MAAQ,KAE1D,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MAExB,EAAE,QAAQ,QAAQ,SAAS,SAE3B,IAAI,EAAQ,EAAE,qBACT,UACA,IAAK,GAAS,CACX,IAAM,EAAI,EAAE,GAAM,KAAK,iBAEvB,MAAO,CACH,MAAO,EAAE,OACT,KAAM,GAAG,EAAQ,GAAG,EAAE,KAAK,aAiDvC,MA7CA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAe,MAEpC,EAAQ,gBAAgB,SAExB,EAAQ,eACH,KAAK,KACL,KAAK,UAAY,CACd,EAAQ,MACH,SAAS,OACT,KAAK,MAAO,GAAG,IAAU,EAAQ,MAAM,SAAS,OAAO,KAAK,UACjE,EAAQ,MAAM,KACV,OACA,GAAG,EAAQ,GAAG,EAAQ,MACjB,KAAK,QACL,QAAQ,iBAAkB,wBAI3C,IAAM,EAAW,EAAQ,eAAe,KAAK,KAc7C,MAZA,GAAK,YAAc,EAAQ,SAAS,OACpC,EAAK,OAAS,EAAQ,kBAAkB,QAAQ,OAAO,OACvD,EAAK,QAAU,EAAS,EAAU,EAAQ,UAAU,QAAQ,QAAS,GAEjE,EAAS,OAAS,IAClB,EAAK,aAAe,EAAI,EAAA,KAAA,EAAA,mCAAgD,CACpE,SAAU,EAAS,UAAU,IAAK,GAAM,EAAQ,GAAG,SAAS,UAEhE,EAAK,eAAiB,2BACtB,EAAK,cAAgB,EAAS,QAAQ,KAAK,SAGxC,MAKZ,CACH,MAAO,GAAG,EAAE,sBACP,KAAK,YACL,UACA,IAAK,GAAM,EAAE,GAAG,QAChB,OAAQ,GAAM,IAAM,MACpB,KAAK,KAAK,SACf,KAAM,EACN,KAAM"}