{"version":3,"file":"news-BJnV7llQ.js","names":["route: Route","ofetch","cache","$"],"sources":["../../lib/routes/now/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst mainCategories = {\r\n    local: 119,\r\n    international: 120,\r\n    entertainment: 500,\r\n    life: 501,\r\n    technology: 502,\r\n    finance: 121,\r\n};\r\n\r\nconst categories = {\r\n    tracker: 123,\r\n    feature: 124,\r\n    opinion: 125,\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/news/:category?/:id?',\r\n    categories: ['traditional-media'],\r\n    example: '/now/news',\r\n    parameters: { category: '分类，见下表，默认为首页', id: '编号，可在对应专题/节目页 URL 中找到 topicId' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['news.now.com/home/:category?', 'news.now.com/'],\r\n            target: '/news/:category?',\r\n        },\r\n    ],\r\n    name: '新聞',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    url: 'news.now.com/',\r\n    description: `::: tip\r\n  **编号** 仅对事件追蹤、評論節目、新聞專題三个分类起作用，例子如下：\r\n\r\n  对于 [事件追蹤](https://news.now.com/home/tracker) 中的 [塔利班奪權](https://news.now.com/home/tracker/detail?catCode=123\\&topicId=1056) 话题，其网址为 \\`https://news.now.com/home/tracker/detail?catCode=123&topicId=1056\\`，其中 \\`topicId\\` 为 1056，则对应路由为 [\\`/now/news/tracker/1056\\`](https://rsshub.app/now/news/tracker/1056)\r\n:::\r\n\r\n| 首頁 | 港聞  | 兩岸國際      | 娛樂          |\r\n| ---- | ----- | ------------- | ------------- |\r\n|      | local | international | entertainment |\r\n\r\n| 生活 | 科技       | 財經    | 體育   |\r\n| ---- | ---------- | ------- | ------ |\r\n| life | technology | finance | sports |\r\n\r\n| 事件追蹤 | 評論節目 | 新聞專題 |\r\n| -------- | -------- | -------- |\r\n| tracker  | feature  | opinion  |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = '', id = '' } = ctx.req.param();\r\n    const limit = Number.parseInt(ctx.req.query('limit') || '20', 10);\r\n    const hasTopicId = id && Object.hasOwn(categories, category);\r\n\r\n    const rootUrl = 'https://news.now.com';\r\n\r\n    const pageUrl = hasTopicId ? `${rootUrl}/home/${category}/detail?catCode=${categories[category]}&topicId=${id}` : `${rootUrl}/home${category ? `/${category}` : ''}`;\r\n\r\n    let apiUrl;\r\n    if (hasTopicId) {\r\n        apiUrl = pageUrl;\r\n    } else if (category === 'sports') {\r\n        apiUrl = `https://sportsapi.now.com/api/getNewsList?pageSize=${limit}&pageNo=1&searchTagsKey=allSportsSearchTags`;\r\n    } else if (category) {\r\n        apiUrl = `https://d3sli7vh0lsda4.cloudfront.net/api/getNewsList?category=${mainCategories[category]}&pageNo=1&pageSize=${limit}`;\r\n    } else {\r\n        apiUrl = pageUrl;\r\n    }\r\n\r\n    const response = await ofetch(apiUrl);\r\n    const isApi = typeof response === 'object' && Array.isArray(response);\r\n    const $ = load(response);\r\n\r\n    let list;\r\n    if (isApi) {\r\n        list =\r\n            category === 'sports'\r\n                ? response.map((item) => {\r\n                      const image = item.newsPhotos\r\n                          ?.filter((p) => p.sizeType === '3')\r\n                          ?.map((p) => `<img src=\"${p.imageFileUrl}\">`)\r\n                          .join('');\r\n                      return {\r\n                          title: item.headlineChi,\r\n                          description: image,\r\n                          link: `https://news.now.com/home/${category}/player?newsId=${item.newsId}`,\r\n                          pubDate: parseDate(item.publishDate, 'x'),\r\n                          category: [...item.sportTypes.map((t) => t.sportTypeNameChi), ...item.players.map((p) => p.playerFullNameChi), ...item.teams.map((t) => t.teamCodeChi)],\r\n                          image: item.newsPhotos?.filter((p) => p.sizeType === '3')?.[0]?.imageUrl,\r\n                          newsId: item.newsId,\r\n                      };\r\n                  })\r\n                : response.map((item) => {\r\n                      const image = item.image2Url ?? item.imageUrl ?? item.image3Url;\r\n                      return {\r\n                          title: item.title,\r\n                          description: (image ? `<img src=\"${image}\">` : '') + item.leading + item.summary,\r\n                          link: `https://news.now.com/home/${category}/player?newsId=${item.newsId}`,\r\n                          pubDate: parseDate(item.publishDate, 'x'),\r\n                          updated: parseDate(item.lastModifyDate, 'x'),\r\n                          category: item.newsTags.map((t) => t.tag),\r\n                          image,\r\n                      };\r\n                  });\r\n    } else {\r\n        list = $(`${category === '' ? '.homeFeaturedNews ' : '.newsCategoryColLeft '}.newsTitle`)\r\n            .toArray()\r\n            .slice(0, limit)\r\n            .map((item) => {\r\n                item = $(item);\r\n\r\n                return {\r\n                    title: item.text(),\r\n                    link: `${rootUrl}${item.parent().parent().attr('href')}`,\r\n                };\r\n            });\r\n    }\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                if (!item.pubDate || item.newsId) {\r\n                    const detailResponse = await ofetch(item.link);\r\n                    const $ = load(detailResponse);\r\n\r\n                    const newsData = JSON.parse(\r\n                        $('script:contains(\"var newsData\")')\r\n                            .text()\r\n                            .match(/var newsData = (.*?);/)?.[1] || '{}'\r\n                    );\r\n\r\n                    const images = newsData.imageList ? newsData.imageList.map((img) => `<img src=\"${img.image2Url}\">`).join('') : '';\r\n\r\n                    item.description = item.description ? item.description + ($('.img_caption').prop('outerHTML') ?? '') + $('.newsLeading').html() : images + $('.newsLeading').html();\r\n                    item.pubDate ||= parseDate(newsData.publishDate, 'x');\r\n                    item.updated ||= parseDate(newsData.lastModifyDate, 'x');\r\n                    item.category ||= [...new Set([newsData.categoryName, ...newsData.newsTags.map((t) => t.tag), ...newsData.newsTopics.map((t) => t.topicName)])];\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: Object.hasOwn(categories, category) ? $('title').text() : ($('.smallSpace.active').text() || '首頁') + ' | Now 新聞',\r\n        link: pageUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"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"}