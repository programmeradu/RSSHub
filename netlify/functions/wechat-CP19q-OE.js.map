{"version":3,"file":"wechat-CP19q-OE.js","names":["route: Route","ConfigNotFoundError","utils","got"],"sources":["../../lib/routes/newrank/wechat.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { finishArticleItem } from '@/utils/wechat-mp';\r\nimport { load } from 'cheerio';\r\nimport utils from './utils';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/wechat/:wxid',\r\n    categories: ['social-media'],\r\n    example: '/newrank/wechat/chijiread',\r\n    parameters: { wxid: '微信号，若微信号与新榜信息不一致，以新榜为准' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'NEWRANK_COOKIE',\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '微信公众号',\r\n    maintainers: ['lessmoe', 'pseudoyu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.newrank || !config.newrank.cookie) {\r\n        throw new ConfigNotFoundError('newrank RSS is disabled due to the lack of <a href=\"https://docs.rsshub.app/deploy/config#route-specific-configurations\">relevant config</a>');\r\n    }\r\n    const uid = ctx.req.param('wxid');\r\n    const nonce = utils.random_nonce(9);\r\n    const { data: summaryHTML } = await got({\r\n        method: 'get',\r\n        url: `https://www.newrank.cn/new/readDetial?account=${uid}`,\r\n        headers: {\r\n            Connection: 'keep-alive',\r\n            Cookie: config.newrank.cookie,\r\n        },\r\n    });\r\n    const summary$ = load(summaryHTML);\r\n    const mainsrc = summary$('script')\r\n        .toArray()\r\n        .find((item) => (item.attribs.src || '').startsWith('/new/static/js/main.')).attribs.src;\r\n    const { data: mainScript } = await got({\r\n        method: 'get',\r\n        url: `https://www.newrank.cn${mainsrc}`,\r\n    });\r\n    const N_TOKEN_match = mainScript.match(/\"N-Token\":\"([^\"]+)/);\r\n    if (!N_TOKEN_match) {\r\n        throw new Error('Cannot find n-token');\r\n    }\r\n    const N_TOKEN = N_TOKEN_match[1];\r\n    const response = await got({\r\n        method: 'post',\r\n        url: 'https://gw.newrank.cn/api/wechat/xdnphb/detail/v1/rank/article/lists',\r\n        headers: {\r\n            Connection: 'keep-alive',\r\n            Cookie: config.newrank.cookie,\r\n            'n-token': N_TOKEN,\r\n        },\r\n        form: {\r\n            account: uid,\r\n            nonce,\r\n            xyz: utils.decrypt_wechat_detail_xyz(uid, nonce),\r\n        },\r\n    });\r\n\r\n    const name = response.data.value.user.name;\r\n    const realTimeArticles = utils.flatten(response.data.value.realTimeArticles);\r\n    const articles = utils.flatten(response.data.value.articles);\r\n    const newArticles = [...realTimeArticles, ...articles];\r\n\r\n    const items = newArticles.map((item) => ({\r\n        id: item.id,\r\n        title: item.title,\r\n        description: '',\r\n        link: item.url,\r\n        pubDate: item.publicTime,\r\n    }));\r\n\r\n    // TODO: link is empty\r\n    await Promise.all(items.map((item) => finishArticleItem(item)));\r\n\r\n    return {\r\n        title: name + ' - 微信公众号',\r\n        link: `https://www.newrank.cn/new/readDetial?account=${uid}`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"iiBAQA,MAAaA,EAAe,CACxB,KAAM,gBACN,WAAY,CAAC,gBACb,QAAS,4BACT,WAAY,CAAE,KAAM,0BACpB,SAAU,CACN,cAAe,CACX,CACI,KAAM,iBACN,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,QACN,YAAa,CAAC,UAAW,YACzB,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,SAAW,CAAC,EAAO,QAAQ,OACnC,MAAM,IAAIC,EAAoB,gJAElC,IAAM,EAAM,EAAI,IAAI,MAAM,QACpB,EAAQC,EAAM,aAAa,GAC3B,CAAE,KAAM,GAAgB,MAAMC,EAAI,CACpC,OAAQ,MACR,IAAK,iDAAiD,IACtD,QAAS,CACL,WAAY,aACZ,OAAQ,EAAO,QAAQ,UAGzB,EAAW,EAAK,GAChB,EAAU,EAAS,UACpB,UACA,KAAM,IAAU,EAAK,QAAQ,KAAO,IAAI,WAAW,yBAAyB,QAAQ,IACnF,CAAE,KAAM,GAAe,MAAMA,EAAI,CACnC,OAAQ,MACR,IAAK,yBAAyB,MAE5B,EAAgB,EAAW,MAAM,sBACvC,GAAI,CAAC,EACD,MAAU,MAAM,uBAEpB,IAAM,EAAU,EAAc,GACxB,EAAW,MAAMA,EAAI,CACvB,OAAQ,OACR,IAAK,uEACL,QAAS,CACL,WAAY,aACZ,OAAQ,EAAO,QAAQ,OACvB,UAAW,GAEf,KAAM,CACF,QAAS,EACT,QACA,IAAKD,EAAM,0BAA0B,EAAK,MAI5C,EAAO,EAAS,KAAK,MAAM,KAAK,KAChC,EAAmBA,EAAM,QAAQ,EAAS,KAAK,MAAM,kBACrD,EAAWA,EAAM,QAAQ,EAAS,KAAK,MAAM,UAC7C,EAAc,CAAC,GAAG,EAAkB,GAAG,GAEvC,EAAQ,EAAY,IAAK,IAAU,CACrC,GAAI,EAAK,GACT,MAAO,EAAK,MACZ,YAAa,GACb,KAAM,EAAK,IACX,QAAS,EAAK,cAMlB,OAFA,MAAM,QAAQ,IAAI,EAAM,IAAK,GAAS,EAAkB,KAEjD,CACH,MAAO,EAAO,WACd,KAAM,iDAAiD,IACvD,KAAM"}