{"version":3,"file":"forum-Dln1Em-T.js","names":[],"sources":["../../lib/routes/4ksj/forum.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport md5 from '@/utils/md5';\r\n\r\nexport const route: Route = {\r\n    path: '/:id?',\r\n    name: '分类',\r\n    url: '4ksj.com',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/4ksj/4k-uhd-1',\r\n    parameters: { id: '分类 id，默认为最新4K电影' },\r\n    description: `::: tip\r\n  若订阅 [最新 4K 电影](https://www.4ksj.com/4k-uhd-1.html)，网址为 \\`https://www.4ksj.com/4k-uhd-1.html\\`。截取 \\`https://www.4ksj.com/\\` 到末尾 \\`.html\\` 的部分 \\`4k-uhd-1\\` 作为参数，此时路由为 [\\`/4ksj/4k-uhd-1\\`](https://rsshub.app/4ksj/4k-uhd-1)。\r\n\r\n  若订阅子分类 [Dolby Vision 动作 4K 电影](https://www.4ksj.com/4k-uhd-s7-display-3-dytypes-1-1.html)，网址为 \\`https://www.4ksj.com/4k-uhd-s7-display-3-dytypes-1-1.html\\`。截取 \\`https://www.4ksj.com/forum-\\` 到末尾 \\`.html\\` 的部分 \\`4kdianying-s7-dianyingbiaozhun-3-dytypes-9-1\\` 作为参数，此时路由为 [\\`/4ksj/4k-uhd-s7-display-3-dytypes-1-1\\`](https://rsshub.app/4ksj/4k-uhd-s7-display-3-dytypes-1-1)。\r\n:::`,\r\n    categories: ['multimedia'],\r\n};\r\n\r\nfunction stringtoHex(acSTR) {\r\n    let val = '';\r\n    for (let i = 0; i <= acSTR.length - 1; i++) {\r\n        const str = acSTR.charAt(i);\r\n        const code = str.codePointAt();\r\n        val += code;\r\n    }\r\n    return val;\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const { id = '4k-uhd-1' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 25;\r\n\r\n    const rootUrl = 'https://www.4ksj.com';\r\n    const currentUrl = new URL(`${id}.html`, rootUrl).href;\r\n\r\n    const response = await ofetch(currentUrl, {\r\n        responseType: 'arrayBuffer',\r\n    });\r\n\r\n    const decoder = new TextDecoder('gbk');\r\n\r\n    const $ = load(decoder.decode(response));\r\n\r\n    const language = 'zh';\r\n    const image = $('div.nexlogo img').prop('src');\r\n\r\n    let items = $('div.nex_cmo_piv a')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                link: new URL(item.prop('href'), rootUrl).href,\r\n            };\r\n        });\r\n\r\n    const getCookie = () =>\r\n        cache.tryGet('4ksj:cookie', async () => {\r\n            const response = await ofetch(items[0].link);\r\n            const $ = load(response);\r\n            const scriptPath = $('script').attr('src')!;\r\n            const scriptUrl = new URL(scriptPath, rootUrl).href;\r\n\r\n            const scriptResponse = await ofetch(scriptUrl);\r\n            const key = scriptResponse.match(/{var key=\"(.*?)\"/)?.[1];\r\n            const value = scriptResponse.match(/\",value=\"(.*?)\"/)?.[1];\r\n            const getPath = scriptResponse.match(/\\.get\\(\"(.*?&key=)\"/)?.[1];\r\n\r\n            if (!key || !value || !getPath) {\r\n                throw new Error('Failed to get cookie');\r\n            }\r\n\r\n            const cookieResponse = await ofetch.raw(`${rootUrl}${getPath}${key}&value=${md5(stringtoHex(value))}`);\r\n            return cookieResponse.headers\r\n                .getSetCookie()\r\n                .map((c) => c.split(';')[0])\r\n                .join('; ');\r\n        });\r\n\r\n    const cookie = await getCookie();\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await ofetch(item.link, {\r\n                    responseType: 'arrayBuffer',\r\n                    headers: {\r\n                        Cookie: cookie as string,\r\n                    },\r\n                });\r\n\r\n                const $$ = load(decoder.decode(detailResponse));\r\n\r\n                $$('div.nex_drama_intros em').first().remove();\r\n                $$('strong font').each((_, el) => {\r\n                    el = $$(el);\r\n\r\n                    el.parent().remove();\r\n                });\r\n\r\n                const title = $$('div.nex_drama_Top h5').text();\r\n                const description = $$('div.nex_drama_intros').html();\r\n                const picture =\r\n                    $$('div.nex_drama_pic')\r\n                        .html()\r\n                        .match(/background:url\\((.*?)\\)/)?.[1] ?? '';\r\n\r\n                const details = $$('li.nex_drama_Detail_li, li.nex_drama_Detail_lis dd')\r\n                    .toArray()\r\n                    .map((li) => {\r\n                        li = $$(li);\r\n\r\n                        const key = li.find('em').text().replaceAll(/：|\\s/g, '');\r\n                        const value = li.find('span').length === 0 ? li.contents().last().text().trim() : li.find('span').text().trim();\r\n\r\n                        return { [key]: value };\r\n                    });\r\n                const mergedDetails = Object.assign({}, ...details);\r\n\r\n                const links =\r\n                    $$('td.t_f ignore_js_op').length === 0\r\n                        ? $$('td.t_f strong')\r\n                              .toArray()\r\n                              .map((l) => {\r\n                                  l = $$(l);\r\n\r\n                                  const title = l.contents().first().text();\r\n                                  const link = l.next().prop('href') ?? l.nextUntil('a').next().prop('href');\r\n\r\n                                  item.enclosure_url = item.enclosure_url ?? link;\r\n                                  item.enclosure_type = item.enclosure_type ?? 'application/x-bittorrent';\r\n                                  item.enclosure_title = item.enclosure_title ?? title;\r\n\r\n                                  return {\r\n                                      title,\r\n                                      tags: l\r\n                                          .contents()\r\n                                          .last()\r\n                                          .text()\r\n                                          .match(/【(.*?)】/g),\r\n                                      link,\r\n                                  };\r\n                              })\r\n                        : $$('div.newfujian')\r\n                              .toArray()\r\n                              .map((l) => {\r\n                                  l = $$(l);\r\n\r\n                                  return {\r\n                                      title: l.find('p.filename').prop('title') || l.find('p.filename').text(),\r\n                                      tags: l\r\n                                          .find('div.fileaq')\r\n                                          .text()\r\n                                          .match(/【(.*?)】/g),\r\n                                      link: l.find('div.down_2 a').prop('href'),\r\n                                  };\r\n                              });\r\n\r\n                const pubDateEl = $$('table.boxtable em').first();\r\n                const pubDate =\r\n                    pubDateEl.find('span[title]').length === 0\r\n                        ? pubDateEl\r\n                              .first()\r\n                              .text()\r\n                              .replace(/发表于\\s/, '')\r\n                        : pubDateEl.find('span[title]').prop('title');\r\n\r\n                item.title = title;\r\n                item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    images: picture\r\n                        ? [\r\n                              {\r\n                                  src: picture,\r\n                                  alt: title,\r\n                              },\r\n                          ]\r\n                        : undefined,\r\n                    title,\r\n                    keys: Object.keys(mergedDetails),\r\n                    details: mergedDetails,\r\n                    description,\r\n                    info: $$('div.nex_drama_sums').html(),\r\n                    links,\r\n                });\r\n                item.pubDate = timezone(parseDate(pubDate, 'YYYY-M-D HH:mm:ss'), +8);\r\n                item.category = Object.values(mergedDetails)\r\n                    .flatMap((c) => c.split(/\\s/))\r\n                    .filter(Boolean);\r\n                item.author = mergedDetails['导演'];\r\n                item.content = {\r\n                    html: description,\r\n                    text: $$('div.nex_drama_intros').text(),\r\n                };\r\n                item.image = picture;\r\n                item.banner = picture;\r\n                item.language = language;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `4k世界 - ${\r\n            $('#fontsearch ul.cl li.a')\r\n                .toArray()\r\n                .map((a) => $(a).text())\r\n                .join('+') || '不限'\r\n        }`,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        link: currentUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image,\r\n        author: $('meta[name=\"application-name\"]').prop('content'),\r\n        language,\r\n    };\r\n}\r\n"],"mappings":"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"}