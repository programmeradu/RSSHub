{"version":3,"file":"wallhaven-rlgD0RlL.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/wallhaven/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst rootUrl = 'https://wallhaven.cc';\r\n\r\nexport const route: Route = {\r\n    path: ['/search/:filter?/:needDetails?', '/:filter?/:needDetails?'],\r\n    categories: ['picture'],\r\n    example: '/wallhaven/search/categories=110&purity=110&sorting=date_added&order=desc',\r\n    parameters: { filter: 'Filter, empty by default', needDetails: 'Need Details, `true`/`yes` as yes, no by default' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['wallhaven.cc/'],\r\n        },\r\n    ],\r\n    name: 'Search',\r\n    maintainers: ['nczitzk', 'Fatpandac'],\r\n    handler,\r\n    url: 'wallhaven.cc/',\r\n    description: `::: tip\r\n  Subscribe pages starting with \\`https://wallhaven.cc/search\\`, fill the text after \\`?\\` as \\`filter\\` in the route. The following is an example:\r\n\r\n  The text after \\`?\\` is \\`q=id%3A711&sorting=random&ref=fp&seed=8g0dgd\\` for [Wallpaper Search: #landscape - wallhaven.cc](https://wallhaven.cc/search?q=id%3A711\\&sorting=random\\&ref=fp\\&seed=8g0dgd), so the route is [/wallhaven/q=id%3A711\\&sorting=random\\&ref=fp\\&seed=8g0dgd](https://rsshub.app/wallhaven/q=id%3A711\\&sorting=random\\&ref=fp\\&seed=8g0dgd)\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const filter = ctx.req.param('filter') ?? 'latest';\r\n    const needDetails = /t|y/i.test(ctx.req.param('needDetails') ?? 'false');\r\n    const url = `${rootUrl}/${filter.indexOf('=') > 0 ? `search?${filter.replaceAll(/page=\\d+/g, 'page=1')}` : filter}`;\r\n\r\n    const response = await got.get(url);\r\n    const $ = load(response.data);\r\n\r\n    let items = $('li > figure.thumb')\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 24)\r\n        .toArray()\r\n        .map((item) => ({\r\n            title: $(item).find('img.lazyload').attr('data-src').split('/').pop(),\r\n            description: $(item)\r\n                .html()\r\n                .match(/<img.*?>/)[0],\r\n            link: $(item).find('a.preview').attr('href'),\r\n        }));\r\n    if (needDetails) {\r\n        items = await Promise.all(\r\n            items.map((item) =>\r\n                cache.tryGet(item.link, async () => {\r\n                    const detailResponse = await got({\r\n                        method: 'get',\r\n                        url: item.link,\r\n                    });\r\n\r\n                    const content = load(detailResponse.data);\r\n\r\n                    item.title = content('meta[name=\"title\"]').attr('content');\r\n                    item.author = content('.username').text();\r\n                    item.pubDate = parseDate(content('time').attr('datetime'));\r\n                    item.category = content('.tagname')\r\n                        .toArray()\r\n                        .map((tag) => content(tag).text());\r\n                    item.description = content('div.scrollbox').html();\r\n\r\n                    return item;\r\n                })\r\n            )\r\n        );\r\n    }\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: url,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"wWAMA,MAEaA,EAAe,CACxB,KAAM,CAAC,iCAAkC,2BACzC,WAAY,CAAC,WACb,QAAS,4EACT,WAAY,CAAE,OAAQ,2BAA4B,YAAa,oDAC/D,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,mBAGjB,KAAM,SACN,YAAa,CAAC,UAAW,aACzB,UACA,IAAK,gBACL,YAAa,2fAOjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAS,EAAI,IAAI,MAAM,WAAa,SACpC,EAAc,OAAO,KAAK,EAAI,IAAI,MAAM,gBAAkB,SAC1D,EAAM,wBAAc,EAAO,QAAQ,KAAO,EAAI,UAAU,EAAO,WAAW,YAAa,YAAc,IAErG,EAAW,MAAMC,EAAI,IAAI,GACzB,EAAI,EAAK,EAAS,MAEpB,EAAQ,EAAE,qBACT,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAC5E,UACA,IAAK,IAAU,CACZ,MAAO,EAAE,GAAM,KAAK,gBAAgB,KAAK,YAAY,MAAM,KAAK,MAChE,YAAa,EAAE,GACV,OACA,MAAM,YAAY,GACvB,KAAM,EAAE,GAAM,KAAK,aAAa,KAAK,WA2B7C,OAzBI,IACA,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAMD,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAe,MAUpC,MARA,GAAK,MAAQ,EAAQ,sBAAsB,KAAK,WAChD,EAAK,OAAS,EAAQ,aAAa,OACnC,EAAK,QAAU,EAAU,EAAQ,QAAQ,KAAK,aAC9C,EAAK,SAAW,EAAQ,YACnB,UACA,IAAK,GAAQ,EAAQ,GAAK,QAC/B,EAAK,YAAc,EAAQ,iBAAiB,OAErC,OAMhB,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM"}