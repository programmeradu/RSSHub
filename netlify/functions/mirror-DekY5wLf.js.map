{"version":3,"file":"mirror-DekY5wLf.js","names":["MarkdownIt","route: Route","InvalidParameterError","got"],"sources":["../../lib/routes/mirror/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport MarkdownIt from 'markdown-it';\r\nconst md = MarkdownIt({\r\n    html: true,\r\n    linkify: true,\r\n});\r\nimport { isValidHost } from '@/utils/valid-host';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/:id',\r\n    categories: ['new-media'],\r\n    example: '/mirror/tingfei.eth',\r\n    parameters: { id: 'user id' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'User',\r\n    maintainers: ['fifteen42', 'rde9', 'nczitzk'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n    if (!id.endsWith('.eth') && !isValidHost(id)) {\r\n        throw new InvalidParameterError('Invalid id');\r\n    }\r\n    const rootUrl = 'https://mirror.xyz';\r\n    const currentUrl = id.endsWith('.eth') ? `${rootUrl}/${id}` : `https://${id}.mirror.xyz`;\r\n\r\n    const response = await got(currentUrl);\r\n\r\n    const data = JSON.parse(response.data.match(/\"__NEXT_DATA__\" type=\"application\\/json\">({\"props\":.*})<\\/script>/)[1]);\r\n\r\n    const items = Object.keys(data.props.pageProps.__APOLLO_STATE__)\r\n        .filter((key) => key.startsWith('entry:'))\r\n        .map((key) => {\r\n            const item = data.props.pageProps.__APOLLO_STATE__[key];\r\n            return {\r\n                title: item.title,\r\n                description: md.render(item.body),\r\n                link: `${currentUrl}/${item._id}`,\r\n                pubDate: parseDate(item.publishedAtTimestamp, 'X'),\r\n                author: data.props.pageProps.publicationLayoutProject.displayName,\r\n            };\r\n        });\r\n\r\n    return {\r\n        title: `${data.props.pageProps.publicationLayoutProject.displayName} - Mirror`,\r\n        description: data.props.pageProps.publicationLayoutProject.description,\r\n        image: data.props.pageProps.publicationLayoutProject.avatarURL,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"mbAIA,MAAM,EAAKA,EAAW,CAClB,KAAM,GACN,QAAS,KAKAC,EAAe,CACxB,KAAM,OACN,WAAY,CAAC,aACb,QAAS,sBACT,WAAY,CAAE,GAAI,WAClB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,YAAa,OAAQ,WACnC,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MACzB,GAAI,CAAC,EAAG,SAAS,SAAW,CAAC,EAAY,GACrC,MAAM,IAAIC,EAAsB,cAEpC,IACM,EAAa,EAAG,SAAS,QAAU,sBAAc,IAAO,WAAW,EAAG,aAEtE,EAAW,MAAMC,EAAI,GAErB,EAAO,KAAK,MAAM,EAAS,KAAK,MAAM,qEAAqE,IAE3G,EAAQ,OAAO,KAAK,EAAK,MAAM,UAAU,kBAC1C,OAAQ,GAAQ,EAAI,WAAW,WAC/B,IAAK,GAAQ,CACV,IAAM,EAAO,EAAK,MAAM,UAAU,iBAAiB,GACnD,MAAO,CACH,MAAO,EAAK,MACZ,YAAa,EAAG,OAAO,EAAK,MAC5B,KAAM,GAAG,EAAW,GAAG,EAAK,MAC5B,QAAS,EAAU,EAAK,qBAAsB,KAC9C,OAAQ,EAAK,MAAM,UAAU,yBAAyB,eAIlE,MAAO,CACH,MAAO,GAAG,EAAK,MAAM,UAAU,yBAAyB,YAAY,WACpE,YAAa,EAAK,MAAM,UAAU,yBAAyB,YAC3D,MAAO,EAAK,MAAM,UAAU,yBAAyB,UACrD,KAAM,EACN,KAAM"}