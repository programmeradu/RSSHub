{"version":3,"file":"utils-CHdCxFgg.js","names":["got","cache","response"],"sources":["../../lib/routes/dongqiudi/utils.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport got from '@/utils/got';\r\nimport { JSDOM } from 'jsdom';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst ProcessVideo = (content) => {\r\n    content('div.video').each((i, v) => {\r\n        let link = new URL(v.attribs.src);\r\n        if (link.host === 'm.miguvideo.com') {\r\n            content(`<a href=\"${link.href}\"> ▶️ 观看视频 </a><br>`).insertAfter(v);\r\n            content(v).remove();\r\n        } else {\r\n            link = v.attribs.src;\r\n            switch (v.attribs.site) {\r\n                case 'qiniu':\r\n                    content(`<video width=\"100%\" controls=\"controls\"> <source src=\"${link}\" type=\"video/mp4\"> Your RSS reader does not support video playback. </video>`).insertAfter(v);\r\n                    content(v).remove();\r\n                    break;\r\n                case 'youku':\r\n                    content(`<iframe height='100%' width='100%' src='${link}' frameborder=0 scrolling=no webkitallowfullscreen=true allowfullscreen=true></iframe>`).insertAfter(v);\r\n                    content(v).remove();\r\n                    break;\r\n                default:\r\n                    break;\r\n            }\r\n        }\r\n    });\r\n\r\n    // Process iframes\r\n    content('iframe.media-iframe, .edui-faked-video').each((i, v) => {\r\n        const link = v.attribs.src;\r\n        if (link.startsWith('http://ssports.iqiyi.com/')) {\r\n            content(`<a href=\"${link.link}\"> ▶️ 观看视频 </a><br>`).insertAfter(v);\r\n        }\r\n\r\n        content(v).remove();\r\n    });\r\n\r\n    return content;\r\n};\r\n\r\nconst ProcessHref = (content) => {\r\n    content.each((j, y) => {\r\n        if (y.attribs.href) {\r\n            y.attribs.href = y.attribs.href.replace('dongqiudi:///news', 'https://www.dongqiudi.com/article');\r\n        }\r\n    });\r\n};\r\n\r\nconst ProcessImg = (content) => {\r\n    content.each((_, img) => {\r\n        if (img.attribs['data-gif-src'] && img.attribs['data-gif-src'].length) {\r\n            img.attribs = { src: img.attribs['data-gif-src'] };\r\n        }\r\n        if (img.attribs['orig-src'] && img.attribs['orig-src'].length) {\r\n            img.attribs.src = img.attribs['orig-src'];\r\n            delete img.attribs['orig-src'];\r\n            delete img.attribs['data-src'];\r\n        }\r\n        img.attribs.src = img.attribs.src.includes('?watermark') ? img.attribs.src.split('?watermark')[0] : img.attribs.src;\r\n    });\r\n};\r\n\r\nconst ProcessFeed = async (ctx, type, id) => {\r\n    const link = `https://www.dongqiudi.com/${type}/${id}.html`;\r\n    const apiUrl = `https://api.dongqiudi.com/v3/archive/app/channel/feeds`;\r\n    const { data: response } = await got(link);\r\n\r\n    let name;\r\n\r\n    const { window } = new JSDOM(response, {\r\n        runScripts: 'dangerously',\r\n    });\r\n\r\n    const typeInfo = window.__NUXT__.data[0][`${type}Detail`].base_info;\r\n    if (type === 'team') {\r\n        name = typeInfo.team_name;\r\n    } else if (type === 'player') {\r\n        name = typeInfo.person_name;\r\n    }\r\n\r\n    const { data } = await got(apiUrl, {\r\n        searchParams: {\r\n            id,\r\n            type,\r\n            size: 20,\r\n            platform: 'web',\r\n            version: '',\r\n        },\r\n    });\r\n\r\n    const list = data.data.articles.map((article) => ({\r\n        title: article.title,\r\n        link: `https://www.dongqiudi.com/articles/${article.id}.html`,\r\n        category: [article.category, ...(article.secondary_category ?? [])],\r\n        pubDate: parseDate(article.show_time),\r\n    }));\r\n\r\n    const out = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: response } = await got(item.link);\r\n\r\n                ProcessFeedType2(item, response);\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${name} - 相关新闻`,\r\n        link,\r\n        image: type === 'team' ? typeInfo.team_logo : typeInfo.person_logo,\r\n        item: out,\r\n    };\r\n};\r\n\r\nconst ProcessFeedType2 = (item, response) => {\r\n    const dom = new JSDOM(response, {\r\n        runScripts: 'dangerously',\r\n    });\r\n\r\n    const data = dom.window.__NUXT__.data[0].newData;\r\n\r\n    // filter out undefined item\r\n    if (!data) {\r\n        return;\r\n    }\r\n\r\n    if (Object.keys(data).length > 0) {\r\n        const body = ProcessVideo(load(data.body, null, false));\r\n        ProcessHref(body('a'));\r\n        ProcessImg(body('img'));\r\n        item.description = body.html();\r\n        item.author = data.writer;\r\n        item.pubDate = parseDate(data.show_time, 'X');\r\n    }\r\n};\r\n\r\nconst ProcessFeedType3 = (item, response) => {\r\n    const $ = load(response);\r\n    const initialState = JSON.parse(\r\n        $('script:contains(\"window.__INITIAL_STATE__\")')\r\n            .text()\r\n            .match(/window\\.__INITIAL_STATE__\\s*=\\s*(.*?);\\(/)[1]\r\n    );\r\n\r\n    // filter out undefined item\r\n    if (!initialState) {\r\n        return;\r\n    }\r\n\r\n    if (Object.keys(initialState.articleContent).length) {\r\n        const data = Object.values(initialState.articleContent)[0];\r\n        const body = ProcessVideo(load(data.body, null, false));\r\n        ProcessHref(body('a'));\r\n        ProcessImg(body('img'));\r\n        item.description = body.html();\r\n        item.author = data.writer;\r\n    }\r\n};\r\n\r\nexport default { ProcessVideo, ProcessFeed, ProcessFeedType2, ProcessFeedType3, ProcessHref, ProcessImg };\r\n"],"mappings":"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"}