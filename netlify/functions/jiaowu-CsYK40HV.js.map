{"version":3,"file":"jiaowu-CsYK40HV.js","names":["route: Route","got","$","cache"],"sources":["../../lib/routes/buaa/jiaowu.ts"],"sourcesContent":["import { Data, Route } from '@/types';\r\nimport { Context } from 'hono';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport timezone from '@/utils/timezone';\r\n\r\nconst BASE_URL = 'https://jiaowu.buaa.edu.cn/bhjwc2.0/index/newsList.do';\r\n\r\nexport const route: Route = {\r\n    path: '/jiaowu/:cddm?',\r\n    name: '教务部',\r\n    url: 'jiaowu.buaa.edu.cn',\r\n    maintainers: ['OverflowCat'],\r\n    handler,\r\n    example: '/buaa/jiaowu/02',\r\n    parameters: {\r\n        cddm: '菜单代码，可以是 2 位或者 4 位，默认为 `02`（通知公告）',\r\n    },\r\n    description: `::: tip\r\n\r\n菜单代码（\\`cddm\\`）应填写链接中调用的 newsList 接口的参数，可以是 2 位或者 4 位数字。若为 2 位，则为 \\`fcd\\`（父菜单）；若为 4 位，则为 \\`cddm\\`（菜单代码），其中前 2 位为 \\`fcd\\`。\r\n示例：\r\n\r\n1. 新闻快讯页面的链接中 \\`onclick=\"javascript:onNewsList('03');return false;\"\\`，对应的路径参数为 \\`03\\`，完整路由为 \\`/buaa/jiaowu/03\\`；\r\n2. 通知公告 > 公示专区页面的链接中 \\`onclick=\"javascript:onNewsList2('0203','2');return false;\"\\`，对应的路径参数为 \\`0203\\`，完整路由为 \\`/buaa/jiaowu/0203\\`。\r\n:::`,\r\n    categories: ['university'],\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n};\r\n\r\nasync function handler(ctx: Context): Promise<Data> {\r\n    let cddm = ctx.req.param('cddm');\r\n    if (!cddm) {\r\n        cddm = '02';\r\n    }\r\n    if (cddm.length !== 2 && cddm.length !== 4) {\r\n        throw new Error('cddm should be 2 or 4 digits');\r\n    }\r\n\r\n    const { title, list } = await getList(BASE_URL, {\r\n        id: '',\r\n        fcdTab: cddm.slice(0, 2),\r\n        cddmTab: cddm,\r\n        xsfsTab: '2',\r\n        tplbid: '',\r\n        xwid: '',\r\n        zydm: '',\r\n        zymc: '',\r\n        yxdm: '',\r\n        pyzy: '',\r\n        szzqdm: '',\r\n    });\r\n    const item = await getItems(list);\r\n\r\n    return {\r\n        title,\r\n        item,\r\n        link: BASE_URL,\r\n        author: '北航教务部',\r\n        language: 'zh-CN',\r\n    };\r\n}\r\n\r\nfunction getArticleUrl(onclick?: string) {\r\n    if (!onclick) {\r\n        return null;\r\n    }\r\n    const xwid = onclick.match(/'(\\d+)'/)?.at(1);\r\n    if (!xwid) {\r\n        return null;\r\n    }\r\n    return `http://jiaowu.buaa.edu.cn/bhjwc2.0/index/newsView.do?xwid=${xwid}`;\r\n}\r\n\r\nasync function getList(url: string | URL, form: Record<string, string> = {}) {\r\n    const { body } = await got.post(url, { form });\r\n    const $ = load(body);\r\n    const title = $('#main > div.dqwz > a').last().text() || '北京航空航天大学教务部';\r\n    const list = $('#main div.news_list > ul > li')\r\n        .toArray()\r\n        .map((item) => {\r\n            const $ = load(item);\r\n            const link = getArticleUrl($('a').attr('onclick'));\r\n            if (link === null) {\r\n                return null;\r\n            }\r\n            return {\r\n                title: $('a').text(),\r\n                link,\r\n                pubDate: timezone(parseDate($('span.Floatright').text()), +8),\r\n            };\r\n        })\r\n        .filter((item) => item !== null);\r\n\r\n    return {\r\n        title,\r\n        list,\r\n    };\r\n}\r\n\r\nfunction getItems(list) {\r\n    return Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: descrptionResponse } = await got(item.link);\r\n                const $descrption = load(descrptionResponse);\r\n                const desc = $descrption('#main > div.content > div.search_height > div.search_con:has(p)').html();\r\n                item.description = desc?.replace(/(\\r|\\n)+/g, '<br />');\r\n                item.author = $descrption('#main > div.content > div.search_height > span.search_con').text().split('发布者:').at(-1) || '教务部';\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n}\r\n"],"mappings":"0ZAQA,MAAM,EAAW,wDAEJA,EAAe,CACxB,KAAM,iBACN,KAAM,MACN,IAAK,qBACL,YAAa,CAAC,eACd,UACA,QAAS,kBACT,WAAY,CACR,KAAM,qCAEV,YAAa,wXAQb,WAAY,CAAC,cACb,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,aAAc,GACd,UAAW,GACX,eAAgB,GAChB,cAAe,KAIvB,eAAe,EAAQ,EAA6B,CAChD,IAAI,EAAO,EAAI,IAAI,MAAM,QAIzB,GAHK,IACD,EAAO,MAEP,EAAK,SAAW,GAAK,EAAK,SAAW,EACrC,MAAU,MAAM,gCAGpB,GAAM,CAAE,QAAO,QAAS,MAAM,EAAQ,EAAU,CAC5C,GAAI,GACJ,OAAQ,EAAK,MAAM,EAAG,GACtB,QAAS,EACT,QAAS,IACT,OAAQ,GACR,KAAM,GACN,KAAM,GACN,KAAM,GACN,KAAM,GACN,KAAM,GACN,OAAQ,KAEN,EAAO,MAAM,EAAS,GAE5B,MAAO,CACH,QACA,OACA,KAAM,EACN,OAAQ,QACR,SAAU,SAIlB,SAAS,EAAc,EAAkB,CACrC,GAAI,CAAC,EACD,OAAO,KAEX,IAAM,EAAO,EAAQ,MAAM,YAAY,GAAG,GAI1C,OAHK,EAGE,6DAA6D,IAFzD,KAKf,eAAe,EAAQ,EAAmB,EAA+B,GAAI,CACzE,GAAM,CAAE,QAAS,MAAMC,EAAI,KAAK,EAAK,CAAE,SACjC,EAAI,EAAK,GACT,EAAQ,EAAE,wBAAwB,OAAO,QAAU,cACnD,EAAO,EAAE,iCACV,UACA,IAAK,GAAS,CACX,IAAMC,EAAI,EAAK,GACT,EAAO,EAAcA,EAAE,KAAK,KAAK,YAIvC,OAHI,IAAS,KACF,KAEJ,CACH,MAAOA,EAAE,KAAK,OACd,OACA,QAAS,EAAS,EAAUA,EAAE,mBAAmB,QAAS,MAGjE,OAAQ,GAAS,IAAS,MAE/B,MAAO,CACH,QACA,QAIR,SAAS,EAAS,EAAM,CACpB,OAAO,QAAQ,IACX,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAuB,MAAMF,EAAI,EAAK,MAC9C,EAAc,EAAK,GACnB,EAAO,EAAY,mEAAmE,OAG5F,MAFA,GAAK,YAAc,GAAM,QAAQ,YAAa,UAC9C,EAAK,OAAS,EAAY,6DAA6D,OAAO,MAAM,QAAQ,GAAG,KAAO,MAC/G"}