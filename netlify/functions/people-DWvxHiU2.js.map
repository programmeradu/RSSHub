{"version":3,"file":"people-DWvxHiU2.js","names":["route: Route","InvalidParameterError","ofetch","cache"],"sources":["../../lib/routes/people/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport iconv from 'iconv-lite';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { isValidHost } from '@/utils/valid-host';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/:site?/:category{.+}?',\r\n    name: '首页头条',\r\n    maintainers: ['nczitzk', 'pseudoyu'],\r\n    example: '/people',\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { site = 'www' } = ctx.req.param();\r\n    let { category = site === 'www' ? '59476' : '' } = ctx.req.param();\r\n    category = site === 'cpc' && category === '24h' ? '87228' : category;\r\n\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 30;\r\n\r\n    if (!isValidHost(site)) {\r\n        throw new InvalidParameterError('Invalid site');\r\n    }\r\n    const rootUrl = `http://${site}.people.com.cn`;\r\n    const currentUrl = new URL(`GB/${category}`, rootUrl).href;\r\n\r\n    const response = await ofetch(currentUrl, {\r\n        responseType: 'arrayBuffer',\r\n    });\r\n\r\n    // try to parse charset from meta tag\r\n    let decodedResponse = iconv.decode(Buffer.from(response), 'utf-8');\r\n    const parsedCharset = decodedResponse.match(/<meta.*?charset=[\"']?([^\"'>]+)[\"']?/i);\r\n    const encoding = parsedCharset ? parsedCharset[1].toLowerCase() : 'utf-8';\r\n    decodedResponse = encoding === 'utf-8' ? decodedResponse : iconv.decode(Buffer.from(response), encoding);\r\n    const $ = load(decodedResponse);\r\n\r\n    $('em').remove();\r\n    $('.bshare-more, .page_n, .page').remove();\r\n\r\n    $('a img, h3 img').each((_, e) => {\r\n        $(e).parent().remove();\r\n    });\r\n\r\n    let items = $('.p6, div.p2j_list, div.headingNews, div.ej_list_box, .leftItem')\r\n        .find('a')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const link = item.attr('href').trim();\r\n\r\n            return {\r\n                title: item.text(),\r\n                link: link.indexOf('http') === 0 ? link : new URL(link.replace(/^\\.\\./, ''), rootUrl).href,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                try {\r\n                    const detailResponse = await ofetch(item.link, {\r\n                        responseType: 'arrayBuffer',\r\n                    });\r\n\r\n                    const data = iconv.decode(Buffer.from(detailResponse), encoding);\r\n                    const content = load(data);\r\n\r\n                    content('.paper_num, #rwb_tjyd').remove();\r\n\r\n                    item.description = content('#rwb_zw').html();\r\n                    item.pubDate = timezone(parseDate(data.match(/(\\d{4}年\\d{2}月\\d{2}日\\d{2}:\\d{2})/)?.[1] || '', 'YYYY年MM月DD日 HH:mm'), +8);\r\n                } catch (error) {\r\n                    item.description = String(error);\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('title').text(),\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"kgBAUA,MAAaA,EAAe,CACxB,KAAM,yBACN,KAAM,OACN,YAAa,CAAC,UAAW,YACzB,QAAS,UACT,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,OAAO,OAAU,EAAI,IAAI,QAC7B,CAAE,WAAW,IAAS,MAAQ,QAAU,IAAO,EAAI,IAAI,QAC3D,EAAW,IAAS,OAAS,IAAa,MAAQ,QAAU,EAE5D,IAAM,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAErF,GAAI,CAAC,EAAY,GACb,MAAM,IAAIC,EAAsB,gBAEpC,IAAM,EAAU,UAAU,EAAK,gBACzB,EAAa,IAAI,IAAI,MAAM,IAAY,GAAS,KAEhD,EAAW,MAAMC,EAAO,EAAY,CACtC,aAAc,gBAId,EAAkB,EAAM,OAAO,OAAO,KAAK,GAAW,SACpD,EAAgB,EAAgB,MAAM,wCACtC,EAAW,EAAgB,EAAc,GAAG,cAAgB,QAClE,EAAkB,IAAa,QAAU,EAAkB,EAAM,OAAO,OAAO,KAAK,GAAW,GAC/F,IAAM,EAAI,EAAK,GAEf,EAAE,MAAM,SACR,EAAE,gCAAgC,SAElC,EAAE,iBAAiB,MAAM,EAAG,IAAM,CAC9B,EAAE,GAAG,SAAS,WAGlB,IAAI,EAAQ,EAAE,kEACT,KAAK,KACL,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAO,EAAK,KAAK,QAAQ,OAE/B,MAAO,CACH,MAAO,EAAK,OACZ,KAAM,EAAK,QAAQ,UAAY,EAAI,EAAO,IAAI,IAAI,EAAK,QAAQ,QAAS,IAAK,GAAS,QA4BlG,MAxBA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,CACA,IAAM,EAAiB,MAAMD,EAAO,EAAK,KAAM,CAC3C,aAAc,gBAGZ,EAAO,EAAM,OAAO,OAAO,KAAK,GAAiB,GACjD,EAAU,EAAK,GAErB,EAAQ,yBAAyB,SAEjC,EAAK,YAAc,EAAQ,WAAW,OACtC,EAAK,QAAU,EAAS,EAAU,EAAK,MAAM,qCAAqC,IAAM,GAAI,qBAAsB,SAC7G,EAAO,CACZ,EAAK,YAAc,OAAO,GAG9B,OAAO,MAKZ,CACH,MAAO,EAAE,SAAS,OAClB,KAAM,EACN,KAAM"}