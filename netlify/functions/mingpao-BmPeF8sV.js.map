{"version":3,"file":"mingpao-BmPeF8sV.js","names":[],"sources":["../../lib/routes/mingpao/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport ofetch from '@/utils/ofetch';\r\nimport parser from '@/utils/rss-parser';\r\nimport * as cheerio from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst renderFanBox = (media) =>\r\n    art(path.join(__dirname, 'templates/fancybox.art'), {\r\n        media,\r\n    });\r\n\r\nconst renderDesc = (media, desc) =>\r\n    art(path.join(__dirname, 'templates/description.art'), {\r\n        media: renderFanBox(media),\r\n        desc,\r\n    });\r\n\r\nconst fixFancybox = (element, $) => {\r\n    const $e = $(element);\r\n    const url = new URL($e.attr('href'));\r\n    let video;\r\n    if (url.hostname === 'videop.mingpao.com') {\r\n        video = new URL(url.searchParams.get('file'));\r\n        video.hostname = 'cfrvideo.mingpao.com'; // use cloudflare cdn\r\n        video = video.href;\r\n    }\r\n    return {\r\n        href: url.href,\r\n        title: $e.attr('title'),\r\n        video,\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:type?/:category?',\r\n    name: '新聞',\r\n    example: '/mingpao/ins/all',\r\n    parameters: {\r\n        type: {\r\n            description: '新聞類型',\r\n            default: 'ins',\r\n            options: [\r\n                { value: 'ins', label: '即時新聞' },\r\n                { value: 'pns', label: '每日明報' },\r\n            ],\r\n        },\r\n        category: '頻道，見下表',\r\n    },\r\n    radar: [\r\n        {\r\n            title: '即時新聞',\r\n            source: ['news.mingpao.com/ins/:categoryName/section/:date/:category'],\r\n            target: '/mingpao/ins/:category',\r\n        },\r\n        {\r\n            title: '每日明報',\r\n            source: ['news.mingpao.com/pns/:categoryName/section/:date/:category'],\r\n            target: '/mingpao/pns/:category',\r\n        },\r\n    ],\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n    description: `| category | 即時新聞頻道 |\r\n| -------- | ------------ |\r\n| all      | 總目錄       |\r\n| s00001   | 港聞         |\r\n| s00002   | 經濟         |\r\n| s00003   | 地產         |\r\n| s00004   | 兩岸         |\r\n| s00005   | 國際         |\r\n| s00006   | 體育         |\r\n| s00007   | 娛樂         |\r\n| s00022   | 文摘         |\r\n| s00024   | 熱點         |\r\n\r\n| category | 每日明報頻道 |\r\n| -------- | ------------ |\r\n| s00001   | 要聞         |\r\n| s00002   | 港聞         |\r\n| s00003   | 社評         |\r\n| s00004   | 經濟         |\r\n| s00005   | 副刊         |\r\n| s00011   | 教育         |\r\n| s00012   | 觀點         |\r\n| s00013   | 中國         |\r\n| s00014   | 國際         |\r\n| s00015   | 體育         |\r\n| s00016   | 娛樂         |\r\n| s00017   | English      |\r\n| s00018   | 作家專欄     |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const type = ctx.req.param('type') ?? 'ins';\r\n    const category = ctx.req.param('category') ?? (type === 'ins' ? 'all' : 's00001');\r\n    const link = `https://news.mingpao.com/rss/${type}/${category}.xml`;\r\n\r\n    const feed = await parser.parseURL(link);\r\n    const items = await Promise.all(\r\n        feed.items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const response = await ofetch(item.link, {\r\n                    headers: {\r\n                        Referer: 'https://news.mingpao.com/',\r\n                    },\r\n                });\r\n\r\n                const $ = cheerio.load(response);\r\n                const topVideo = $('#topvideo').length\r\n                    ? $('#topvideo iframe')\r\n                          .toArray()\r\n                          .map((e) => $(e).attr('href', $(e).attr('src')))\r\n                          .map((e) => fixFancybox(e, $))\r\n                    : [];\r\n                const fancyboxImg = $('a.fancybox').length ? $('a.fancybox') : $('a.fancybox-buttons');\r\n\r\n                // remove unwanted elements\r\n                $('div.ad300ins_m').remove();\r\n                $('div.clear, div.inReadLrecGroup, div.clr').remove();\r\n                $('div#ssm2').remove();\r\n                $('iframe').remove();\r\n                $('p[dir=ltr]').remove();\r\n\r\n                // extract categories\r\n                item.category = item.categories;\r\n\r\n                // fix fancybox image\r\n                let fancybox = [...topVideo, ...fancyboxImg.toArray().map((e) => fixFancybox(e, $))];\r\n                const script = $('script')\r\n                    .toArray()\r\n                    .find((e) => $(e).text()?.includes(\"$('#lower').prepend('\"));\r\n                const lowerContent = script\r\n                    ? $(script)\r\n                          .text()\r\n                          ?.match(/\\$\\('#lower'\\)\\.prepend\\('(.*)'\\);/)?.[1]\r\n                          ?.replaceAll(/\\\\\"/g, '\"')\r\n                    : '';\r\n                if (lowerContent) {\r\n                    const $ = cheerio.load(lowerContent, null, false);\r\n                    fancybox = [\r\n                        ...fancybox,\r\n                        ...$('a.fancybox')\r\n                            .toArray()\r\n                            .map((e) => fixFancybox(e, $)),\r\n                    ];\r\n                }\r\n\r\n                // remove unwanted key value\r\n                delete item.categories;\r\n                delete item.content;\r\n                delete item.contentSnippet;\r\n                delete item.creator;\r\n                delete item.isoDate;\r\n\r\n                item.description = renderDesc(fancybox, $('.txt4').html() ?? $('.article_content.line_1_5em').html() ?? $('.txt3').html());\r\n                item.pubDate = parseDate(item.pubDate);\r\n                item.guid = item.link.includes('?') ? item.link : item.link.slice(0, item.link.lastIndexOf('/'));\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: feed.title,\r\n        link: feed.link,\r\n        description: feed.description,\r\n        item: items,\r\n        image: feed.image.url,\r\n        language: feed.language,\r\n    };\r\n}\r\n"],"mappings":"4dAUA,MAAM,EAAgB,GAClB,EAAI,EAAA,KAAA,EAAA,mCAAgD,CAChD,UAGF,GAAc,EAAO,IACvB,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACnD,MAAO,EAAa,GACpB,SAGF,GAAe,EAAS,IAAM,CAChC,IAAM,EAAK,EAAE,GACP,EAAM,IAAI,IAAI,EAAG,KAAK,SACxB,EAMJ,OALI,EAAI,WAAa,uBACjB,EAAQ,IAAI,IAAI,EAAI,aAAa,IAAI,SACrC,EAAM,SAAW,uBACjB,EAAQ,EAAM,MAEX,CACH,KAAM,EAAI,KACV,MAAO,EAAG,KAAK,SACf,UAIK,EAAe,CACxB,KAAM,qBACN,KAAM,KACN,QAAS,mBACT,WAAY,CACR,KAAM,CACF,YAAa,OACb,QAAS,MACT,QAAS,CACL,CAAE,MAAO,MAAO,MAAO,QACvB,CAAE,MAAO,MAAO,MAAO,UAG/B,SAAU,UAEd,MAAO,CACH,CACI,MAAO,OACP,OAAQ,CAAC,8DACT,OAAQ,0BAEZ,CACI,MAAO,OACP,OAAQ,CAAC,8DACT,OAAQ,2BAGhB,YAAa,CAAC,UACd,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;0BA8BjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,MAChC,EAAW,EAAI,IAAI,MAAM,cAAgB,IAAS,MAAQ,MAAQ,UAClE,EAAO,gCAAgC,EAAK,GAAG,EAAS,MAExD,EAAO,MAAM,EAAO,SAAS,GAC7B,EAAQ,MAAM,QAAQ,IACxB,EAAK,MAAM,IAAK,GACZ,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAW,MAAM,EAAO,EAAK,KAAM,CACrC,QAAS,CACL,QAAS,+BAIX,EAAI,EAAQ,KAAK,GACjB,EAAW,EAAE,aAAa,OAC1B,EAAE,oBACG,UACA,IAAK,GAAM,EAAE,GAAG,KAAK,OAAQ,EAAE,GAAG,KAAK,SACvC,IAAK,GAAM,EAAY,EAAG,IAC/B,GACA,EAAc,EAAE,cAAc,OAAS,EAAE,cAAgB,EAAE,sBAGjE,EAAE,kBAAkB,SACpB,EAAE,2CAA2C,SAC7C,EAAE,YAAY,SACd,EAAE,UAAU,SACZ,EAAE,cAAc,SAGhB,EAAK,SAAW,EAAK,WAGrB,IAAI,EAAW,CAAC,GAAG,EAAU,GAAG,EAAY,UAAU,IAAK,GAAM,EAAY,EAAG,KAC1E,EAAS,EAAE,UACZ,UACA,KAAM,GAAM,EAAE,GAAG,QAAQ,SAAS,0BACjC,EAAe,EACf,EAAE,GACG,QACC,MAAM,wCAAwC,IAC9C,WAAW,OAAQ,KACzB,GACN,GAAI,EAAc,CACd,IAAM,EAAI,EAAQ,KAAK,EAAc,KAAM,IAC3C,EAAW,CACP,GAAG,EACH,GAAG,EAAE,cACA,UACA,IAAK,GAAM,EAAY,EAAG,KAevC,OAVA,OAAO,EAAK,WACZ,OAAO,EAAK,QACZ,OAAO,EAAK,eACZ,OAAO,EAAK,QACZ,OAAO,EAAK,QAEZ,EAAK,YAAc,EAAW,EAAU,EAAE,SAAS,QAAU,EAAE,+BAA+B,QAAU,EAAE,SAAS,QACnH,EAAK,QAAU,EAAU,EAAK,SAC9B,EAAK,KAAO,EAAK,KAAK,SAAS,KAAO,EAAK,KAAO,EAAK,KAAK,MAAM,EAAG,EAAK,KAAK,YAAY,MAEpF,MAKnB,MAAO,CACH,MAAO,EAAK,MACZ,KAAM,EAAK,KACX,YAAa,EAAK,YAClB,KAAM,EACN,MAAO,EAAK,MAAM,IAClB,SAAU,EAAK"}