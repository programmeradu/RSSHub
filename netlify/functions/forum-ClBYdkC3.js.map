{"version":3,"file":"forum-ClBYdkC3.js","names":["got","cache","route: Route"],"sources":["../../lib/routes/flyert/util.ts","../../lib/routes/flyert/forum.ts"],"sourcesContent":["import { CheerioAPI } from 'cheerio';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nconst rootUrl = 'https://www.flyert.com.cn';\r\n\r\n/**\r\n * Parses a list of articles based on a CheerioAPI object and a limit.\r\n * @param $ The CheerioAPI object.\r\n * @param limit The maximum number of articles to parse.\r\n * @returns An array of parsed article objects.\r\n */\r\nconst parseArticleList = ($: CheerioAPI, limit: number) =>\r\n    $('div.comiis_wzli')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const title = item.find('div.wzbt').text().trim();\r\n            const image = item.find('div.wzpic img').prop('src');\r\n            const description = art(path.join(__dirname, 'templates/description.art'), {\r\n                images: image\r\n                    ? [\r\n                          {\r\n                              src: image,\r\n                              alt: title,\r\n                          },\r\n                      ]\r\n                    : undefined,\r\n                description: item.find('div.wznr').html(),\r\n            });\r\n            const pubDate = item.find('div.subcat span.y').contents()?.eq(2)?.text().trim() ?? undefined;\r\n            const link = new URL(item.find('div.wzbt a').prop('href'), rootUrl).href;\r\n\r\n            return {\r\n                title,\r\n                description,\r\n                pubDate: pubDate ? parseDate(pubDate) : undefined,\r\n                link,\r\n                author: item.find('div.subcat span.y a').first().text(),\r\n                content: {\r\n                    html: description,\r\n                    text: item.find('div.wznr').text(),\r\n                },\r\n                image,\r\n                banner: image,\r\n            };\r\n        });\r\n\r\n/**\r\n * Parses a list of posts based on a CheerioAPI object and a limit.\r\n * @param $ The CheerioAPI object.\r\n * @param limit The maximum number of posts to parse.\r\n * @returns An array of parsed post objects.\r\n */\r\nconst parsePostList = ($: CheerioAPI, limit: number) =>\r\n    $('div.comiis_postlist')\r\n        .toArray()\r\n        .filter((item) => {\r\n            item = $(item);\r\n\r\n            return item\r\n                .find('span.comiis_common a[data-track]')\r\n                .toArray()\r\n                .some((a) => {\r\n                    a = $(a);\r\n\r\n                    const dataTrack = a.attr('data-track') || '';\r\n                    return dataTrack.endsWith('文章');\r\n                });\r\n        })\r\n        .slice(0, limit)\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const aEl = $(\r\n                item\r\n                    .find('span.comiis_common a[data-track]')\r\n                    .toArray()\r\n                    .find((a) => {\r\n                        a = $(a);\r\n\r\n                        const dataTrack = a.attr('data-track') || '';\r\n                        return dataTrack.endsWith('文章');\r\n                    })\r\n            );\r\n\r\n            const pubDate = item.find('span.author_b span').prop('title') || undefined;\r\n\r\n            return {\r\n                title: aEl.text().trim(),\r\n                pubDate: pubDate ? parseDate(pubDate) : undefined,\r\n                link: new URL(aEl.prop('href'), rootUrl).href,\r\n                author: item.find('a.author_t').text().trim(),\r\n            };\r\n        });\r\n\r\n/**\r\n * Parses an article based on a CheerioAPI object and an item.\r\n * @param $$ The CheerioAPI object.\r\n * @param item The item to parse.\r\n * @returns The parsed article object.\r\n */\r\nconst parseArticle = ($$: CheerioAPI, item) => {\r\n    const title = $$('h1.ph').text().trim();\r\n    const description = art(path.join(__dirname, 'templates/description.art'), {\r\n        intro: $$('div.s').text() || undefined,\r\n        description: $$('div#artMain').html(),\r\n    });\r\n    const pubDate =\r\n        $$('p.xg1')\r\n            .contents()\r\n            .first()\r\n            .text()\r\n            .trim()\r\n            ?.match(/(\\d{4}-\\d{1,2}-\\d{1,2}\\s\\d{2}:\\d{2})/)?.[1] ?? undefined;\r\n    const guid = `flyert-${item.link.split(/=/).pop()}`;\r\n\r\n    item.title = title;\r\n    item.description = description;\r\n    item.pubDate = pubDate ? timezone(parseDate(pubDate), +8) : item.pubDate;\r\n    item.author = $$('p.xg1 a').first().text();\r\n    item.guid = guid;\r\n    item.id = guid;\r\n    item.content = {\r\n        html: description,\r\n        text: $$('div#artMain').text(),\r\n    };\r\n\r\n    return item;\r\n};\r\n\r\n/**\r\n * Parses a post based on a CheerioAPI object and an item.\r\n * @param $$ The CheerioAPI object.\r\n * @param item The item to parse.\r\n * @returns The parsed post object.\r\n */\r\nconst parsePost = ($$: CheerioAPI, item) => {\r\n    $$('img.zoom').each((_, el) => {\r\n        el = $$(el);\r\n\r\n        el.replaceWith(\r\n            art(path.join(__dirname, 'templates/description.art'), {\r\n                images:\r\n                    el.prop('zoomfile') || el.prop('file')\r\n                        ? [\r\n                              {\r\n                                  src: el.prop('zoomfile') || el.prop('file'),\r\n                                  alt: el.prop('alt') || el.prop('title'),\r\n                              },\r\n                          ]\r\n                        : undefined,\r\n            })\r\n        );\r\n    });\r\n\r\n    $$('i.pstatus').remove();\r\n    $$('div.tip').remove();\r\n\r\n    const title = $$('span#thread_subject').text().trim();\r\n    const description = $$('div.post_message').first().html();\r\n    const pubDate = $$('span[title]').first().prop('title');\r\n\r\n    const tid = item.link.match(/tid=(\\d+)/)?.[1] ?? undefined;\r\n    const guid = tid ? `flyert-${tid}` : undefined;\r\n\r\n    item.title = title;\r\n    item.description = description;\r\n    item.pubDate = pubDate ? timezone(parseDate(pubDate), +8) : item.pubDate;\r\n    item.author = $$('a.kmxi2').first().text();\r\n    item.guid = guid;\r\n    item.id = guid;\r\n    item.content = {\r\n        html: description,\r\n        text: $$('div.post_message').first().text(),\r\n    };\r\n\r\n    return item;\r\n};\r\n\r\nexport { rootUrl, parseArticleList, parsePostList, parseArticle, parsePost };\r\n","import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport iconv from 'iconv-lite';\r\nimport { load } from 'cheerio';\r\nimport { rootUrl, parseArticleList, parsePostList, parseArticle, parsePost } from './util';\r\n\r\nexport const handler = async (ctx) => {\r\n    const { params } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 5;\r\n\r\n    const decodedParams = params\r\n        ? decodeURIComponent(params)\r\n              .split(/&/)\r\n              .filter((p) => p.split(/=/).length === 2)\r\n              .join('&')\r\n        : undefined;\r\n\r\n    const currentUrl = new URL(`forum.php${decodedParams ? `?${decodedParams}` : ''}`, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl, {\r\n        responseType: 'buffer',\r\n    });\r\n\r\n    const $ = load(iconv.decode(response, 'gbk'));\r\n\r\n    const language = $('meta[http-equiv=\"Content-Language\"]').prop('content');\r\n\r\n    let items = $('table#threadlisttableid').length === 0 ? parseArticleList($, limit) : parsePostList($, limit);\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link, {\r\n                    responseType: 'buffer',\r\n                });\r\n\r\n                const $$ = load(iconv.decode(detailResponse, 'gbk').replaceAll(/<\\/?ignore_js_op>/g, ''));\r\n\r\n                item = $$('div.firstpost').length === 0 ? parseArticle($$, item) : parsePost($$, item);\r\n\r\n                item.language = language;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const image = `https:${$('div.wp h2 a img').prop('src')}`;\r\n\r\n    return {\r\n        title: `飞客 - ${$('a.forum_name, li.a, li.cur, li.xw1, div.z > a.xw1')\r\n            .toArray()\r\n            .map((a) => $(a).text())\r\n            .join(' - ')}`,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        link: currentUrl,\r\n        item: items,\r\n        allowEmpty: true,\r\n        image,\r\n        author: $('meta[name=\"application-name\"]').prop('content'),\r\n    };\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/forum/:params{.+}?',\r\n    name: '会员说',\r\n    url: 'www.flyert.com.cn',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    example: '/flyert/forum',\r\n    parameters: { params: '参数，默认为空，可在对应分类页 URL 中找到' },\r\n    description: `::: tip\r\n  若订阅 [酒店集团优惠](https://www.flyert.com.cn/forum.php?mod=forumdisplay&sum=all&fid=all&catid=322&filter=sortid&sortid=144&searchsort=1&youhui_type=19)，网址为 \\`https://www.flyert.com.cn/forum.php?mod=forumdisplay&sum=all&fid=all&catid=322&filter=sortid&sortid=144&searchsort=1&youhui_type=19\\`。截取 \\`https://www.flyert.com.cn/forum.php?\\` 到末尾的部分 \\`mod=forumdisplay&sum=all&fid=all&catid=322&filter=sortid&sortid=144&searchsort=1&youhui_type=19\\` **进行 UrlEncode 编码** 后作为参数填入，此时路由为 [\\`/flyert/forum/mod%3Dforumdisplay%26sum%3Dall%26fid%3Dall%26catid%3D322%26filter%3Dsortid%26sortid%3D144%26searchsort%3D1%26youhui_type%3D226\\`](https://rsshub.app/flyert/forum/mod%3Dforumdisplay%26sum%3Dall%26fid%3Dall%26catid%3D322%26filter%3Dsortid%26sortid%3D144%26searchsort%3D1%26youhui_type%3D226)。\r\n:::\r\n    `,\r\n    categories: ['bbs'],\r\n\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportRadar: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.flyert.com.cn/forum.php'],\r\n            target: (_, url) => {\r\n                const params = [...url.searchParams.entries()].map(([key, value]) => key + '=' + value).join('&');\r\n\r\n                return `/forum${params ? `/${encodeURIComponent(params)}` : ''}`;\r\n            },\r\n        },\r\n    ],\r\n};\r\n"],"mappings":"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"}