{"version":3,"file":"logclub-OfPd9LVE.js","names":[],"sources":["../../lib/routes/logclub/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/:category{.+}?',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'news' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 11;\r\n\r\n    const rootUrl = 'https://www.logclub.com';\r\n    const currentUrl = new URL(category, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl);\r\n\r\n    const $ = load(response);\r\n\r\n    let items = $('li.layui-row, li.layui-timeline-item')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            const a = item.find('div.newslist-txt h3 a, a.article_title').first();\r\n            const image = item.find('img.img-hover').prop('src')?.split(/\\?/)[0] ?? undefined;\r\n\r\n            return {\r\n                title: a.text(),\r\n                link: new URL(a.prop('href'), rootUrl).href,\r\n                description: art(path.join(__dirname, 'templates/description.art'), {\r\n                    image: {\r\n                        src: image,\r\n                        alt: a.text(),\r\n                    },\r\n                    intro: item.find('p.newslist-intro, div.newslist-info-intro').text(),\r\n                }),\r\n                itunes_item_image: image,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: detailResponse } = await got(item.link);\r\n\r\n                const content = load(detailResponse);\r\n\r\n                content('a.dl_file').each((_, el) => {\r\n                    el = content(el);\r\n                    el.parent().remove();\r\n                });\r\n                content('img').each((_, el) => {\r\n                    el = content(el);\r\n                    el.replaceWith(\r\n                        art(path.join(__dirname, 'templates/description.art'), {\r\n                            image: {\r\n                                src: el.prop('src')?.split(/\\?/)[0] ?? undefined,\r\n                                alt: el.prop('title'),\r\n                            },\r\n                        })\r\n                    );\r\n                });\r\n\r\n                item.title = content('h1, div.current_video_title').first().text();\r\n\r\n                item.enclosure_url = content('video#ref_video').prop('src');\r\n                if (item.enclosure_url) {\r\n                    item.enclosure_type = `video/${item.enclosure_url.split(/\\./).pop()}`;\r\n                }\r\n\r\n                item.description += art(path.join(__dirname, 'templates/description.art'), {\r\n                    video: {\r\n                        poster: item.itunes_item_image,\r\n                        src: item.enclosure_url,\r\n                        type: item.enclosure_type,\r\n                    },\r\n                    description: content('div.article-cont').html(),\r\n                });\r\n                item.author = content('div.article-info-r a')\r\n                    .toArray()\r\n                    .map((a) => content(a).text())\r\n                    .join('/');\r\n                item.category = [\r\n                    ...new Set([\r\n                        ...content('div.article-label-r a.label')\r\n                            .toArray()\r\n                            .map((c) => content(c).text()),\r\n                        ...(content('meta[name=\"keywords\"]')\r\n                            .prop('content')\r\n                            ?.split(/\\s?,\\s?/) ?? []),\r\n                    ]),\r\n                ].filter(Boolean);\r\n\r\n                item.pubDate =\r\n                    content('span.aritlceIn-time').length === 0\r\n                        ? parseDate(\r\n                              content(\r\n                                  content('div.video_info_item, div.lc-infos div')\r\n                                      .toArray()\r\n                                      .findLast((i) => /\\d{4}-\\d{2}-\\d{2}/.test(content(i).text()))\r\n                              )\r\n                                  .text()\r\n                                  .split(/ï¼š/)\r\n                                  .pop()\r\n                                  .trim()\r\n                          )\r\n                        : parseDate(content('span.aritlceIn-time').text().trim());\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const icon = new URL($('link[rel=\"shortcut icon\"]').prop('href'), rootUrl).href;\r\n    const subtitle = $('meta[name=\"keywords\"]').prop('content');\r\n    const author = subtitle.split(/,/)[0];\r\n\r\n    return {\r\n        item: items,\r\n        title: $('title').text().split(/-/)[0].trim(),\r\n        link: currentUrl,\r\n        description: $('meta[name=\"description\"]').prop('content'),\r\n        language: 'zh',\r\n        image: new URL($('div.logo_img img').prop('src'), rootUrl).href,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: subtitle.replaceAll(',', ''),\r\n        author,\r\n        itunes_author: author,\r\n        itunes_category: 'News',\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,kBACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,QAAW,EAAI,IAAI,QAChC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,0BACV,EAAa,IAAI,IAAI,EAAU,GAAS,KAExC,CAAE,KAAM,GAAa,MAAM,EAAI,GAE/B,EAAI,EAAK,GAEX,EAAQ,EAAE,wCACT,MAAM,EAAG,GACT,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAET,IAAM,EAAI,EAAK,KAAK,0CAA0C,QACxD,EAAQ,EAAK,KAAK,iBAAiB,KAAK,QAAQ,MAAM,MAAM,IAAM,IAAA,GAExE,MAAO,CACH,MAAO,EAAE,OACT,KAAM,IAAI,IAAI,EAAE,KAAK,QAAS,GAAS,KACvC,YAAa,EAAI,EAAA,KAAA,EAAA,sCAAmD,CAChE,MAAO,CACH,IAAK,EACL,IAAK,EAAE,QAEX,MAAO,EAAK,KAAK,6CAA6C,SAElE,kBAAmB,KAI/B,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAmB,MAAM,EAAI,EAAK,MAE1C,EAAU,EAAK,GA+DrB,OA7DA,EAAQ,aAAa,MAAM,EAAG,IAAO,CACjC,EAAK,EAAQ,GACb,EAAG,SAAS,WAEhB,EAAQ,OAAO,MAAM,EAAG,IAAO,CAC3B,EAAK,EAAQ,GACb,EAAG,YACC,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACnD,MAAO,CACH,IAAK,EAAG,KAAK,QAAQ,MAAM,MAAM,IAAM,IAAA,GACvC,IAAK,EAAG,KAAK,eAM7B,EAAK,MAAQ,EAAQ,+BAA+B,QAAQ,OAE5D,EAAK,cAAgB,EAAQ,mBAAmB,KAAK,OACjD,EAAK,gBACL,EAAK,eAAiB,SAAS,EAAK,cAAc,MAAM,MAAM,SAGlE,EAAK,aAAe,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACvE,MAAO,CACH,OAAQ,EAAK,kBACb,IAAK,EAAK,cACV,KAAM,EAAK,gBAEf,YAAa,EAAQ,oBAAoB,SAE7C,EAAK,OAAS,EAAQ,wBACjB,UACA,IAAK,GAAM,EAAQ,GAAG,QACtB,KAAK,KACV,EAAK,SAAW,CACZ,GAAG,IAAI,IAAI,CACP,GAAG,EAAQ,+BACN,UACA,IAAK,GAAM,EAAQ,GAAG,QAC3B,GAAI,EAAQ,yBACP,KAAK,YACJ,MAAM,YAAc,MAEhC,OAAO,SAET,EAAK,QACD,EAAQ,uBAAuB,SAAW,EACpC,EACI,EACI,EAAQ,yCACH,UACA,SAAU,GAAM,oBAAoB,KAAK,EAAQ,GAAG,UAExD,OACA,MAAM,KACN,MACA,QAET,EAAU,EAAQ,uBAAuB,OAAO,QAEnD,MAKnB,IAAM,EAAO,IAAI,IAAI,EAAE,6BAA6B,KAAK,QAAS,GAAS,KACrE,EAAW,EAAE,yBAAyB,KAAK,WAC3C,EAAS,EAAS,MAAM,KAAK,GAEnC,MAAO,CACH,KAAM,EACN,MAAO,EAAE,SAAS,OAAO,MAAM,KAAK,GAAG,OACvC,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,KACV,MAAO,IAAI,IAAI,EAAE,oBAAoB,KAAK,OAAQ,GAAS,KAC3D,OACA,KAAM,EACN,SAAU,EAAS,WAAW,IAAK,IACnC,SACA,cAAe,EACf,gBAAiB"}