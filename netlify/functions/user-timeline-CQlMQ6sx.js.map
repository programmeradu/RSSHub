{"version":3,"file":"user-timeline-CQlMQ6sx.js","names":["route: Route","InvalidParameterError","utils","ConfigNotFoundError"],"sources":["../../lib/routes/misskey/user-timeline.ts"],"sourcesContent":["import { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\nimport { Data, Route, ViewType } from '@/types';\r\nimport { fallback, queryToBoolean } from '@/utils/readable-social';\r\nimport querystring from 'node:querystring';\r\nimport utils from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/users/notes/:username/:routeParams?',\r\n    categories: ['social-media'],\r\n    view: ViewType.SocialMedia,\r\n    example: '/misskey/users/notes/support@misskey.io',\r\n    parameters: {\r\n        username: 'Misskey username in the format of username@instance.domain',\r\n        routeParams: `\r\n| Key               | Description                             | Accepted Values | Default |\r\n| ----------------- | --------------------------------------- | --------------- | ------- |\r\n| withRenotes       | Include renotes in the timeline         | 0/1/true/false  | false   |\r\n| mediaOnly         | Only return posts containing media      | 0/1/true/false  | false   |\r\n| simplifyAuthor    | Simplify author field in feed items     | 0/1/true/false  | false   |\r\n\r\nNote: \\`withRenotes\\` and \\`mediaOnly\\` are mutually exclusive and cannot both be set to true.\r\n\r\nExamples:\r\n- /misskey/users/notes/mttb2ccp@misskey.io/withRenotes=true\r\n- /misskey/users/notes/mttb2ccp@misskey.io/mediaOnly=true`,\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'User timeline',\r\n    maintainers: ['siygle', 'SnowAgar25', 'HanaokaYuzu'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx): Promise<Data> {\r\n    const username = ctx.req.param('username');\r\n    const [, pureUsername, site] = username.match(/@?(\\w+)@(\\w+\\.\\w+)/) || [];\r\n    if (!pureUsername || !site) {\r\n        throw new InvalidParameterError('Provide a valid Misskey username');\r\n    }\r\n    if (!config.feature.allow_user_supply_unsafe_domain && !utils.allowSiteList.includes(site)) {\r\n        throw new ConfigNotFoundError(`This RSS is disabled unless 'ALLOW_USER_SUPPLY_UNSAFE_DOMAIN' is set to 'true'.`);\r\n    }\r\n\r\n    const routeParams = querystring.parse(ctx.req.param('routeParams'));\r\n    const withRenotes = fallback(undefined, queryToBoolean(routeParams.withRenotes), false);\r\n    const mediaOnly = fallback(undefined, queryToBoolean(routeParams.mediaOnly), false);\r\n    const simplifyAuthor = fallback(undefined, queryToBoolean(routeParams.simplifyAuthor), false);\r\n\r\n    // Check for conflicting parameters\r\n    if (withRenotes && mediaOnly) {\r\n        throw new InvalidParameterError('withRenotes and mediaOnly cannot both be true.');\r\n    }\r\n\r\n    const { accountData, avatarUrl } = await utils.getUserTimelineByUsername(pureUsername, site, {\r\n        withRenotes,\r\n        mediaOnly,\r\n    });\r\n\r\n    return {\r\n        title: `User timeline for ${username} on ${site}`,\r\n        link: `https://${site}/@${pureUsername}`,\r\n        image: avatarUrl ?? '',\r\n        item: utils.parseNotes(accountData, site, simplifyAuthor),\r\n    };\r\n}\r\n"],"mappings":"2pBAQA,MAAaA,EAAe,CACxB,KAAM,uCACN,WAAY,CAAC,gBACb,KAAM,EAAS,YACf,QAAS,0CACT,WAAY,CACR,SAAU,6DACV,YAAa;;;;;;;;;;;4DAajB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,gBACN,YAAa,CAAC,SAAU,aAAc,eACtC,WAGJ,eAAe,EAAQ,EAAoB,CACvC,IAAM,EAAW,EAAI,IAAI,MAAM,YACzB,EAAG,EAAc,GAAQ,EAAS,MAAM,uBAAyB,GACvE,GAAI,CAAC,GAAgB,CAAC,EAClB,MAAM,IAAIC,EAAsB,oCAEpC,GAAI,CAAC,EAAO,QAAQ,iCAAmC,CAACC,EAAM,cAAc,SAAS,GACjF,MAAM,IAAIC,EAAoB,mFAGlC,IAAM,EAAc,EAAY,MAAM,EAAI,IAAI,MAAM,gBAC9C,EAAc,EAAS,IAAA,GAAW,EAAe,EAAY,aAAc,IAC3E,EAAY,EAAS,IAAA,GAAW,EAAe,EAAY,WAAY,IACvE,EAAiB,EAAS,IAAA,GAAW,EAAe,EAAY,gBAAiB,IAGvF,GAAI,GAAe,EACf,MAAM,IAAIF,EAAsB,kDAGpC,GAAM,CAAE,cAAa,aAAc,MAAMC,EAAM,0BAA0B,EAAc,EAAM,CACzF,cACA,cAGJ,MAAO,CACH,MAAO,qBAAqB,EAAS,MAAM,IAC3C,KAAM,WAAW,EAAK,IAAI,IAC1B,MAAO,GAAa,GACpB,KAAMA,EAAM,WAAW,EAAa,EAAM"}