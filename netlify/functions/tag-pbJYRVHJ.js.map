{"version":3,"file":"tag-pbJYRVHJ.js","names":["route: Route","InvalidParameterError","got","cache","$","data","tag"],"sources":["../../lib/routes/gamme/tag.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { isValidHost } from '@/utils/valid-host';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nexport const route: Route = {\r\n    path: '/:domain/tag/:tag',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { domain = 'news', tag } = ctx.req.param();\r\n    if (!isValidHost(domain)) {\r\n        throw new InvalidParameterError('Invalid domain');\r\n    }\r\n    const baseUrl = `https://${domain}.gamme.com.tw`;\r\n    const pageUrl = `${baseUrl}/tag/${tag}`;\r\n\r\n    const { data } = await got(pageUrl);\r\n    const $ = load(data);\r\n\r\n    const list = $('#category_new li a, .List-4 h3 a')\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.attr('title') || item.text(),\r\n                link: item.attr('href'),\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data } = await got(item.link);\r\n                const $ = load(data);\r\n\r\n                $('.entry img').each((_, img) => {\r\n                    if (img.attribs['data-original'] || img.attribs['data-src']) {\r\n                        img.attribs.src = img.attribs['data-original'] || img.attribs['data-src'];\r\n                        delete img.attribs['data-original'];\r\n                        delete img.attribs['data-src'];\r\n                    }\r\n                });\r\n\r\n                item.author = $('.author_name').text().trim();\r\n                item.category = $('.tags a')\r\n                    .toArray()\r\n                    .map((tag) => $(tag).text());\r\n                $('.social_block, .tags').remove();\r\n                item.pubDate = parseDate($('.postDate').attr('content'));\r\n                item.description = $('.entry').html();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${tag} | ${domain === 'news' ? '宅宅新聞' : '西斯新聞'}`,\r\n        description: $('meta[name=description]').attr('content'),\r\n        link: pageUrl,\r\n        image: domain === 'news' ? `${baseUrl}/blogico.ico` : `${baseUrl}/favicon.ico`,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"2eAQA,MAAaA,EAAe,CACxB,KAAM,oBACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,SAAS,OAAQ,OAAQ,EAAI,IAAI,QACzC,GAAI,CAAC,EAAY,GACb,MAAM,IAAIC,EAAsB,kBAEpC,IAAM,EAAU,WAAW,EAAO,eAC5B,EAAU,GAAG,EAAQ,OAAO,IAE5B,CAAE,QAAS,MAAMC,EAAI,GACrB,EAAI,EAAK,GAET,EAAO,EAAE,oCACV,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,KAAK,UAAY,EAAK,OAClC,KAAM,EAAK,KAAK,WAItB,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAA,GAAS,MAAMD,EAAI,EAAK,MAC1BE,EAAI,EAAKC,GAkBf,OAhBA,EAAE,cAAc,MAAM,EAAG,IAAQ,EACzB,EAAI,QAAQ,kBAAoB,EAAI,QAAQ,eAC5C,EAAI,QAAQ,IAAM,EAAI,QAAQ,kBAAoB,EAAI,QAAQ,YAC9D,OAAO,EAAI,QAAQ,iBACnB,OAAO,EAAI,QAAQ,eAI3B,EAAK,OAASD,EAAE,gBAAgB,OAAO,OACvC,EAAK,SAAWA,EAAE,WACb,UACA,IAAK,GAAQA,EAAEE,GAAK,QACzB,EAAE,wBAAwB,SAC1B,EAAK,QAAU,EAAUF,EAAE,aAAa,KAAK,YAC7C,EAAK,YAAcA,EAAE,UAAU,OAExB,MAKnB,MAAO,CACH,MAAO,GAAG,EAAI,KAAK,IAAW,OAAS,OAAS,SAChD,YAAa,EAAE,0BAA0B,KAAK,WAC9C,KAAM,EACN,MAAO,IAAW,OAAS,GAAG,EAAQ,cAAgB,GAAG,EAAQ,cACjE,KAAM"}