{"version":3,"file":"section-BJtUhgij.js","names":["route: Route","puppeteer","cache","utils"],"sources":["../../lib/routes/dcard/utils.ts","../../lib/routes/dcard/section.ts"],"sourcesContent":["import pMap from 'p-map';\r\n\r\nconst ProcessFeed = async (items, cookies, browser, limit, cache) => {\r\n    let newCookies = [];\r\n    const result = await pMap(\r\n        items.slice(0, limit),\r\n        async (i) => {\r\n            const url = `https://www.dcard.tw/service/api/v2/posts/${i.id}`;\r\n            const content = await cache.tryGet(`dcard:${i.id}`, async () => {\r\n                let response;\r\n                // try catch 处理被删除的帖子\r\n                try {\r\n                    const page = await browser.newPage();\r\n                    await page.setRequestInterception(true);\r\n                    page.on('request', (request) => {\r\n                        request.resourceType() === 'document' || request.resourceType() === 'script' || request.resourceType() === 'fetch' || request.resourceType() === 'xhr' ? request.continue() : request.abort();\r\n                    });\r\n                    await page.setExtraHTTPHeaders({\r\n                        referer: `https://www.dcard.tw/f/${i.forumAlias}/p/${i.id}`,\r\n                    });\r\n                    await page.setCookie(...cookies);\r\n                    await page.goto(url);\r\n                    await page.waitForSelector('body > pre');\r\n                    response = await page.evaluate(() => document.querySelector('body > pre').textContent);\r\n                    newCookies = await page.cookies();\r\n                    await page.close();\r\n\r\n                    const data = JSON.parse(response);\r\n                    let body = data.content;\r\n                    body = body.replaceAll(/(?=https?:\\/\\/).*?(?<=\\.(jpe?g|gif|png))/gi, (m) => `<img src=\"${m}\">`);\r\n                    body = body.replaceAll(/(?=https?:\\/\\/).*(?<!jpe?g\"?>?)$/gim, (m) => `<a href=\"${m}\">${m}</a>`);\r\n                    body = body.replaceAll('\\n', '<br>');\r\n\r\n                    return body;\r\n                } catch {\r\n                    return '';\r\n                }\r\n            });\r\n\r\n            i.description = content;\r\n            return i;\r\n        },\r\n        { concurrency: 3 }\r\n    );\r\n    await cache.set('dcard:cookies', newCookies, 3600);\r\n    return [...result, ...items.slice(limit)];\r\n};\r\n\r\nexport default { ProcessFeed };\r\n","import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport utils from './utils';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nexport const route: Route = {\r\n    path: '/:section/:type?',\r\n    categories: ['bbs'],\r\n    example: '/dcard/funny/popular',\r\n    parameters: { section: '板塊名稱，URL 中獲得', type: '排序，popular 熱門；latest 最新，默認為 latest' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '板塊帖子',\r\n    maintainers: ['HenryQW'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { type = 'latest', section = 'posts' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number(ctx.req.query('limit')) : 30;\r\n    const browser = await puppeteer();\r\n\r\n    let link = `https://www.dcard.tw/f`;\r\n    let api = `https://www.dcard.tw/service/api/v2`;\r\n    let title = `Dcard - `;\r\n\r\n    if (section !== 'posts' && section !== 'popular' && section !== 'latest') {\r\n        link += `/${section}`;\r\n        api += `/forums/${section}`;\r\n        title += `${section} - `;\r\n    }\r\n    api += `/posts`;\r\n    if (type === 'popular') {\r\n        link += '?latest=false';\r\n        api += '?popular=true';\r\n        title += '熱門';\r\n    } else {\r\n        link += '?latest=true';\r\n        api += '?popular=false';\r\n        title += '最新';\r\n    }\r\n\r\n    const page = await browser.newPage();\r\n    await page.setRequestInterception(true);\r\n    page.on('request', (request) => {\r\n        request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n    });\r\n    await page.setExtraHTTPHeaders({\r\n        referer: `https://www.dcard.tw/f/${section}`,\r\n    });\r\n\r\n    await page.goto(`${api}&limit=100`);\r\n    await page.waitForSelector('body > pre');\r\n    const response = await page.evaluate(() => document.querySelector('body > pre').textContent);\r\n    const cookies = await cache.tryGet('dcard:cookies', () => page.cookies(), 3600, false);\r\n    await page.close();\r\n\r\n    const data = JSON.parse(response);\r\n    const items = data.map((item) => ({\r\n        title: `「${item.forumName}」${item.title}`,\r\n        link: `https://www.dcard.tw/f/${item.forumAlias}/p/${item.id}`,\r\n        description: item.excerpt,\r\n        author: `${item.school || '匿名'}．${item.gender === 'M' ? '男' : '女'}`,\r\n        pubDate: parseDate(item.createdAt),\r\n        category: [item.forumName, ...item.topics],\r\n        forumAlias: item.forumAlias,\r\n        id: item.id,\r\n    }));\r\n\r\n    // parse fulltext for first `limit` items\r\n    const result = await utils.ProcessFeed(items, cookies, browser, limit, cache);\r\n    await browser.close();\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        description: '不想錯過任何有趣的話題嗎？趕快加入我們吧！',\r\n        item: result,\r\n    };\r\n}\r\n"],"mappings":"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"}