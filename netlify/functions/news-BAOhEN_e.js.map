{"version":3,"file":"news-BAOhEN_e.js","names":["route: Route","cache","got"],"sources":["../../lib/routes/dw/news.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport { processItems } from './utils';\r\nimport got from '@/utils/got';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\n\r\nexport const route: Route = {\r\n    path: '/news/:lang?/:id?',\r\n    categories: ['traditional-media'],\r\n    example: '/dw/news',\r\n    parameters: {\r\n        lang: 'Language, see below, default to en',\r\n        id: 'Category ID, see below, default to the id of the Top Stories Page of the language chosen',\r\n    },\r\n    features: {\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n        requireConfig: false,\r\n    },\r\n    name: 'News',\r\n    maintainers: ['quiniapiezoelectricity'],\r\n    handler,\r\n    description: `\r\n::: tip\r\nParameters can be obtained from the official website, for instance:\r\nFor the site https://www.dw.com/de/deutschland/s-12321 the language code would be \\`de\\` and the category ID would be \\`s-1432\\`.\r\n:::\r\n`,\r\n    radar: [\r\n        {\r\n            source: ['www.dw.com/:lang/:name/:id'],\r\n            target: '/news/:lang/:id',\r\n        },\r\n    ],\r\n};\r\n\r\nconst defaultUrl = `https://www.dw.com/graph-api/en/content/navigation/9097`;\r\nconst typenames = new Set(['Article', 'Liveblog', 'Video']);\r\n\r\nasync function handler(ctx) {\r\n    const lang = ctx.req.param('lang') ?? 'en';\r\n    let id = ctx.req.param('id');\r\n\r\n    if (/^s-\\d+$/.test(id)) {\r\n        id = id.match(/^s-(\\d+)$/i)[1]; // convert s-1234 id to 1234\r\n    } else if (id === undefined) {\r\n        // Look up the id of the Top Stories Page of the selected language if id is not specified in the URL.\r\n        const navigation = await cache.tryGet(\r\n            'dw:navigation',\r\n            async () => {\r\n                const res = await got(defaultUrl);\r\n                return res.data.data.content.topStoriesNavigations;\r\n            },\r\n            config.cache.routeExpire,\r\n            false\r\n        );\r\n        id = navigation\r\n            .map((item) => item.namedUrl.split('/'))\r\n            .find((item) => item[1] === lang)[3]\r\n            .match(/^s-(\\d+)$/i)[1];\r\n    }\r\n\r\n    const response = await got(`https://www.dw.com/graph-api/${lang}/content/navigation/${id}`);\r\n    const feed = response.data.data.content;\r\n    cache.set('dw:navigation', feed.topStoriesNavigations, config.cache.routeExpire);\r\n\r\n    const list = feed.contentComposition.informationSpaces.flatMap((section) => Object.values(section).flatMap((component) => component[0]?.contents || [])).filter((item) => typenames.has(item.__typename) && item.id);\r\n    const items = await processItems(\r\n        list.map((item) => {\r\n            item.link = new URL(item.namedUrl, 'https://www.dw.com').href;\r\n            item.pubDate = item.contentDate;\r\n            item.description = item.teaser;\r\n            item.language = lang;\r\n            item.type = item.__typename.toLowerCase();\r\n            return item;\r\n        })\r\n    );\r\n\r\n    return {\r\n        title: `DW | ${feed.title}`,\r\n        link: feed.canonicalUrl,\r\n        description: feed.metaDescription,\r\n        language: feed.topStoriesNavigations.find((item) => item.namedUrl.startsWith(`/${lang}/`))?.localeLang ?? lang,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"qXAMA,MAAaA,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,qBACb,QAAS,WACT,WAAY,CACR,KAAM,qCACN,GAAI,4FAER,SAAU,CACN,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,GACf,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,0BACd,UACA,YAAa;;;;;EAMb,MAAO,CACH,CACI,OAAQ,CAAC,8BACT,OAAQ,qBAMd,EAAY,IAAI,IAAI,CAAC,UAAW,WAAY,UAElD,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAO,EAAI,IAAI,MAAM,SAAW,KAClC,EAAK,EAAI,IAAI,MAAM,MAEvB,GAAI,UAAU,KAAK,GACf,EAAK,EAAG,MAAM,cAAc,WACrB,IAAO,IAAA,GAAW,CAEzB,IAAM,EAAa,MAAMC,EAAM,OAC3B,gBACA,SAAY,CACR,IAAM,EAAM,MAAMC,EAAI,2DACtB,OAAO,EAAI,KAAK,KAAK,QAAQ,uBAEjC,EAAO,MAAM,YACb,IAEJ,EAAK,EACA,IAAK,GAAS,EAAK,SAAS,MAAM,MAClC,KAAM,GAAS,EAAK,KAAO,GAAM,GACjC,MAAM,cAAc,GAG7B,IAAM,EAAW,MAAMA,EAAI,gCAAgC,EAAK,sBAAsB,KAChF,EAAO,EAAS,KAAK,KAAK,QAChC,EAAM,IAAI,gBAAiB,EAAK,sBAAuB,EAAO,MAAM,aAEpE,IAAM,EAAO,EAAK,mBAAmB,kBAAkB,QAAS,GAAY,OAAO,OAAO,GAAS,QAAS,GAAc,EAAU,IAAI,UAAY,KAAK,OAAQ,GAAS,EAAU,IAAI,EAAK,aAAe,EAAK,IAC3M,EAAQ,MAAM,EAChB,EAAK,IAAK,IACN,EAAK,KAAO,IAAI,IAAI,EAAK,SAAU,sBAAsB,KACzD,EAAK,QAAU,EAAK,YACpB,EAAK,YAAc,EAAK,OACxB,EAAK,SAAW,EAChB,EAAK,KAAO,EAAK,WAAW,cACrB,KAIf,MAAO,CACH,MAAO,QAAQ,EAAK,QACpB,KAAM,EAAK,aACX,YAAa,EAAK,gBAClB,SAAU,EAAK,sBAAsB,KAAM,GAAS,EAAK,SAAS,WAAW,IAAI,EAAK,MAAM,YAAc,EAC1G,KAAM"}