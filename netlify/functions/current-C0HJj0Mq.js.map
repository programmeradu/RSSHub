{"version":3,"file":"current-C0HJj0Mq.js","names":["route: Route","puppeteer","cache","page","response","$"],"sources":["../../lib/routes/uchicago/current.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { getCookies, setCookies } from '@/utils/puppeteer-utils';\r\nimport logger from '@/utils/logger';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nexport const route: Route = {\r\n    path: '/journals/current/:journal',\r\n    categories: ['journal'],\r\n    example: '/uchicago/journals/current/jpe',\r\n    parameters: { journal: 'Journal id, can be found in URL. [Browse journals by title](https://www.journals.uchicago.edu/action/showPublications)' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['journals.uchicago.edu/toc/:journal/current', 'journals.uchicago.edu/journal/:journal'],\r\n        },\r\n    ],\r\n    name: 'Current Issue',\r\n    maintainers: ['TonyRL'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const journal = ctx.req.param('journal');\r\n    const baseUrl = 'https://www.journals.uchicago.edu';\r\n    const link = `${baseUrl}/toc/${journal}/current`;\r\n\r\n    const browser = await puppeteer();\r\n    const page = await browser.newPage();\r\n    await page.setRequestInterception(true);\r\n    page.on('request', (request) => {\r\n        request.resourceType() === 'document' ? request.continue() : request.abort();\r\n    });\r\n    logger.http(`Requesting ${link}`);\r\n    await page.goto(link, {\r\n        waitUntil: 'domcontentloaded',\r\n    });\r\n    const response = await page.evaluate(() => document.documentElement.innerHTML);\r\n    const cookies = await getCookies(page);\r\n    await page.close();\r\n    const $ = load(response);\r\n\r\n    const list = $('.issue-item__title')\r\n        .toArray()\r\n        .map((item) => ({ link: `${baseUrl}${$(item).find('a').attr('href')}` }));\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const page = await browser.newPage();\r\n                await setCookies(page, cookies, 'journals.uchicago.edu');\r\n                await page.setRequestInterception(true);\r\n                page.on('request', (request) => {\r\n                    request.resourceType() === 'document' ? request.continue() : request.abort();\r\n                });\r\n                logger.http(`Requesting ${item.link}`);\r\n                await page.goto(item.link, {\r\n                    waitUntil: 'domcontentloaded',\r\n                    referer: link,\r\n                });\r\n                const response = await page.evaluate(() => document.documentElement.innerHTML);\r\n                await page.close();\r\n\r\n                const $ = load(response);\r\n\r\n                item.title = $('head title').text();\r\n                item.pubDate = parseDate($('head meta[name=\"dc.Date\"]').attr('content'));\r\n                item.doi = $('head meta[scheme=\"doi\"]').attr('content');\r\n                item.author = $('.author-name span')\r\n                    .toArray()\r\n                    .map((author) => $(author).text())\r\n                    .join(', ');\r\n\r\n                $('.figure__image').each((_, elem) => {\r\n                    if (elem.attribs['data-lg-src']) {\r\n                        $(elem).attr('src', `${baseUrl}${elem.attribs['data-lg-src']}`);\r\n                        delete elem.attribs['data-lg-src'];\r\n                    }\r\n                });\r\n\r\n                item.description = $('.article__body').html();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    await browser.close();\r\n\r\n    return {\r\n        title: $('head title').text(),\r\n        description: $('.jumbotron-journal-info').text(),\r\n        link,\r\n        image: $('head meta[property=\"og:image\"]').attr('content'),\r\n        item: items,\r\n        language: $('html').attr('lang'),\r\n    };\r\n}\r\n"],"mappings":"8XAQA,MAAaA,EAAe,CACxB,KAAM,6BACN,WAAY,CAAC,WACb,QAAS,iCACT,WAAY,CAAE,QAAS,0HACvB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,6CAA8C,4CAG/D,KAAM,gBACN,YAAa,CAAC,UACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,EAAI,IAAI,MAAM,WACxB,EAAU,oCACV,EAAO,GAAG,EAAQ,OAAO,EAAQ,UAEjC,EAAU,MAAMC,IAChB,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,WAAa,EAAQ,WAAa,EAAQ,UAEzE,EAAO,KAAK,cAAc,KAC1B,MAAM,EAAK,KAAK,EAAM,CAClB,UAAW,qBAEf,IAAM,EAAW,MAAM,EAAK,aAAe,SAAS,gBAAgB,WAC9D,EAAU,MAAM,EAAW,GACjC,MAAM,EAAK,QACX,IAAM,EAAI,EAAK,GAET,EAAO,EAAE,sBACV,UACA,IAAK,IAAU,CAAE,KAAM,GAAG,IAAU,EAAE,GAAM,KAAK,KAAK,KAAK,aAE1D,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAMC,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAWA,EAAM,EAAS,yBAChC,MAAMA,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,WAAa,EAAQ,WAAa,EAAQ,UAEzE,EAAO,KAAK,cAAc,EAAK,QAC/B,MAAMA,EAAK,KAAK,EAAK,KAAM,CACvB,UAAW,mBACX,QAAS,IAEb,IAAMC,EAAW,MAAMD,EAAK,aAAe,SAAS,gBAAgB,WACpE,MAAMA,EAAK,QAEX,IAAME,EAAI,EAAKD,GAmBf,MAjBA,GAAK,MAAQC,EAAE,cAAc,OAC7B,EAAK,QAAU,EAAUA,EAAE,6BAA6B,KAAK,YAC7D,EAAK,IAAMA,EAAE,2BAA2B,KAAK,WAC7C,EAAK,OAASA,EAAE,qBACX,UACA,IAAK,GAAWA,EAAE,GAAQ,QAC1B,KAAK,MAEV,EAAE,kBAAkB,MAAM,EAAG,IAAS,CAC9B,EAAK,QAAQ,iBACb,EAAE,GAAM,KAAK,MAAO,GAAG,IAAU,EAAK,QAAQ,kBAC9C,OAAO,EAAK,QAAQ,kBAI5B,EAAK,YAAcA,EAAE,kBAAkB,OAEhC,MAOnB,OAFA,MAAM,EAAQ,QAEP,CACH,MAAO,EAAE,cAAc,OACvB,YAAa,EAAE,2BAA2B,OAC1C,OACA,MAAO,EAAE,kCAAkC,KAAK,WAChD,KAAM,EACN,SAAU,EAAE,QAAQ,KAAK"}