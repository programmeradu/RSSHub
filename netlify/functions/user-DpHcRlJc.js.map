{"version":3,"file":"user-DpHcRlJc.js","names":["route: Route","ofetch","cache","html","$"],"sources":["../../lib/routes/picnob/utils.ts","../../lib/routes/picnob/user.ts"],"sourcesContent":["import { getPuppeteerPage } from '@/utils/puppeteer';\r\n\r\nconst puppeteerGet = async (url) => {\r\n    let data;\r\n    const { destory } = await getPuppeteerPage(url, {\r\n        onBeforeLoad: async (page) => {\r\n            await page.setRequestInterception(true);\r\n            page.on('request', (request) => {\r\n                request.resourceType() === 'document' ? request.continue() : request.abort();\r\n            });\r\n            page.on('response', async (response) => {\r\n                data = await (response.request().url().includes('/api/posts') ? response.json() : response.text());\r\n            });\r\n        },\r\n    });\r\n    await destory();\r\n    return data;\r\n};\r\n\r\nexport { puppeteerGet };\r\n","import { Route, ViewType } from '@/types';\r\n\r\nimport ofetch from '@/utils/ofetch';\r\nimport { load } from 'cheerio';\r\nimport { parseRelativeDate } from '@/utils/parse-date';\r\nimport { puppeteerGet } from './utils';\r\nimport sanitizeHtml from 'sanitize-html';\r\nimport cache from '@/utils/cache';\r\n\r\nexport const route: Route = {\r\n    path: '/user/:id/:type?',\r\n    categories: ['social-media'],\r\n    example: '/picnob/user/xlisa_olivex',\r\n    parameters: {\r\n        id: 'Instagram id',\r\n        type: 'Type of profile page (profile or tagged)',\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: true,\r\n        antiCrawler: true,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['www.pixnoy.com/profile/:id'],\r\n            target: '/user/:id',\r\n        },\r\n        {\r\n            source: ['www.pixnoy.com/profile/:id/tagged'],\r\n            target: '/user/:id/tagged',\r\n        },\r\n    ],\r\n    name: 'User Profile - Picnob',\r\n    maintainers: ['TonyRL', 'micheal-death', 'AiraNadih', 'DIYgod'],\r\n    handler,\r\n    view: ViewType.Pictures,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    // NOTE: 'picnob' is still available, but all requests to 'picnob' will be redirected to 'pixnoy' eventually\r\n    const baseUrl = 'https://www.pixnoy.com';\r\n    const id = ctx.req.param('id');\r\n    const type = ctx.req.param('type') ?? 'profile';\r\n    const profileUrl = `${baseUrl}/profile/${id}/${type === 'tagged' ? 'tagged/' : ''}`;\r\n\r\n    // TODO: can't bypass cloudflare 403 error without puppeteer\r\n    let html;\r\n    let usePuppeteer = false;\r\n    try {\r\n        const data = await ofetch(profileUrl);\r\n        html = data;\r\n    } catch {\r\n        html = await puppeteerGet(profileUrl);\r\n        usePuppeteer = true;\r\n    }\r\n    const $ = load(html);\r\n\r\n    const list = $('.post_box')\r\n        .toArray()\r\n        .map((item) => {\r\n            const $item = $(item);\r\n            const sum = $item.find('.sum').text();\r\n            const coverLink = $item.find('.cover_link').attr('href');\r\n            const shortcode = coverLink?.split('/')?.[2];\r\n\r\n            return {\r\n                title: sanitizeHtml(sum.split('\\n')[0], { allowedTags: [], allowedAttributes: {} }),\r\n                description: `<img src=\"${$item.find('.preview_w img').attr('data-src')}\" /><br />${sum.replaceAll('\\n', '<br>')}`,\r\n                link: `${baseUrl}${coverLink}`,\r\n                guid: shortcode,\r\n                pubDate: parseRelativeDate($item.find('.time .txt').text()),\r\n            };\r\n        });\r\n\r\n    const newDescription = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(`picnob:user:${id}:${item.guid}`, async () => {\r\n                try {\r\n                    const html = usePuppeteer\r\n                        ? await puppeteerGet(item.link)\r\n                        : await ofetch(item.link, {\r\n                              headers: {\r\n                                  'user-agent': 'PostmanRuntime/7.44.0',\r\n                              },\r\n                          });\r\n                    const $ = load(html);\r\n                    if ($('.video_img').length > 0) {\r\n                        return `<video src=\"${$('.video_img a').attr('href')}\" poster=\"${$('.video_img img').attr('data-src')}\"></video><br />${$('.sum_full').text()}`;\r\n                    } else {\r\n                        let description = '';\r\n                        for (const slide of $('.swiper-slide').toArray()) {\r\n                            const $slide = $(slide);\r\n                            description += `<img src=\"${$slide.find('.pic img').attr('data-src')}\" /><br />`;\r\n                        }\r\n                        description += $('.sum_full').text();\r\n                        return description;\r\n                    }\r\n                } catch {\r\n                    return '';\r\n                }\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${$('h1.fullname').text()} (@${id}) ${type === 'tagged' ? 'tagged' : 'public'} posts - Picnob`,\r\n        description: $('.info .sum').text(),\r\n        link: profileUrl,\r\n        image: $('.ava .pic img').attr('src'),\r\n        item: list.map((item, index) => ({\r\n            ...item,\r\n            description: newDescription[index] || item.description,\r\n        })),\r\n    };\r\n}\r\n"],"mappings":"8dAEA,MAAM,EAAe,KAAO,IAAQ,CAChC,IAAI,EACE,CAAE,WAAY,MAAM,EAAiB,EAAK,CAC5C,aAAc,KAAO,IAAS,CAC1B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,WAAa,EAAQ,WAAa,EAAQ,UAEzE,EAAK,GAAG,WAAY,KAAO,IAAa,CACpC,EAAO,MAAO,EAAS,UAAU,MAAM,SAAS,cAAgB,EAAS,OAAS,EAAS,aAKvG,OADA,MAAM,IACC,GCPEA,EAAe,CACxB,KAAM,mBACN,WAAY,CAAC,gBACb,QAAS,4BACT,WAAY,CACR,GAAI,eACJ,KAAM,4CAEV,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,8BACT,OAAQ,aAEZ,CACI,OAAQ,CAAC,qCACT,OAAQ,qBAGhB,KAAM,wBACN,YAAa,CAAC,SAAU,gBAAiB,YAAa,UACtD,UACA,KAAM,EAAS,UAGnB,eAAe,EAAQ,EAAK,CAExB,IAAM,EAAU,yBACV,EAAK,EAAI,IAAI,MAAM,MACnB,EAAO,EAAI,IAAI,MAAM,SAAW,UAChC,EAAa,GAAG,EAAQ,WAAW,EAAG,GAAG,IAAS,SAAW,UAAY,KAG3E,EACA,EAAe,GACnB,GAAI,CACA,IAAM,EAAO,MAAMC,EAAO,GAC1B,EAAO,OACH,CACJ,EAAO,MAAM,EAAa,GAC1B,EAAe,GAEnB,IAAM,EAAI,EAAK,GAET,EAAO,EAAE,aACV,UACA,IAAK,GAAS,CACX,IAAM,EAAQ,EAAE,GACV,EAAM,EAAM,KAAK,QAAQ,OACzB,EAAY,EAAM,KAAK,eAAe,KAAK,QAC3C,EAAY,GAAW,MAAM,OAAO,GAE1C,MAAO,CACH,MAAO,EAAa,EAAI,MAAM;GAAM,GAAI,CAAE,YAAa,GAAI,kBAAmB,KAC9E,YAAa,aAAa,EAAM,KAAK,kBAAkB,KAAK,YAAY,YAAY,EAAI,WAAW;EAAM,UACzG,KAAM,GAAG,IAAU,IACnB,KAAM,EACN,QAAS,EAAkB,EAAM,KAAK,cAAc,WAI1D,EAAiB,MAAM,QAAQ,IACjC,EAAK,IAAK,GACNC,EAAM,OAAO,eAAe,EAAG,GAAG,EAAK,OAAQ,SAAY,CACvD,GAAI,CACA,IAAMC,EAAO,EACP,MAAM,EAAa,EAAK,MACxB,MAAMF,EAAO,EAAK,KAAM,CACpB,QAAS,CACL,aAAc,2BAGtBG,EAAI,EAAKD,GACf,GAAIC,EAAE,cAAc,OAAS,EACzB,MAAO,eAAeA,EAAE,gBAAgB,KAAK,QAAQ,YAAYA,EAAE,kBAAkB,KAAK,YAAY,kBAAkBA,EAAE,aAAa,SACpI,CACH,IAAI,EAAc,GAClB,IAAK,IAAM,KAASA,EAAE,iBAAiB,UAAW,CAC9C,IAAM,EAASA,EAAE,GACjB,GAAe,aAAa,EAAO,KAAK,YAAY,KAAK,YAAY,YAGzE,MADA,IAAeA,EAAE,aAAa,OACvB,QAEP,CACJ,MAAO,QAMvB,MAAO,CACH,MAAO,GAAG,EAAE,eAAe,OAAO,KAAK,EAAG,IAAI,IAAS,SAAW,SAAW,SAAS,iBACtF,YAAa,EAAE,cAAc,OAC7B,KAAM,EACN,MAAO,EAAE,iBAAiB,KAAK,OAC/B,KAAM,EAAK,KAAK,EAAM,KAAW,CAC7B,GAAG,EACH,YAAa,EAAe,IAAU,EAAK"}