{"version":3,"file":"collection-BLI6Sudh.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/lofter/collection.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport cache from '@/utils/cache';\r\nimport { config } from '@/config';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nexport const route: Route = {\r\n    path: '/collection/:collectionID',\r\n    categories: ['social-media'],\r\n    example: '/lofter/collection/552041',\r\n    parameters: { collectionID: 'Lofter collection ID, can be found in the share URL' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'Collection',\r\n    maintainers: ['SrakhiuMeow'],\r\n    handler,\r\n};\r\n\r\nasync function fetchCollection(collectionID, limit, offset = 0) {\r\n    const response = await got({\r\n        method: 'post',\r\n        url: 'https://api.lofter.com/v1.1/postCollection.api?product=lofter-android-7.6.12',\r\n        body: new URLSearchParams({\r\n            collectionid: collectionID,\r\n            limit: limit.toString(),\r\n            method: 'getCollectionDetail',\r\n            offset: offset.toString(),\r\n            order: '0',\r\n        }),\r\n    });\r\n\r\n    if (!response.data.response) {\r\n        throw new Error('Collection Not Found');\r\n    }\r\n\r\n    const data = response.data.response;\r\n\r\n    return {\r\n        title: data.collection.name || 'Lofter Collection',\r\n        link: data.blogInfo.homePageUrl || 'https://www.lofter.com/',\r\n        description: data.collection.description || 'No description provided.',\r\n        items: data.items,\r\n    } as object;\r\n}\r\n\r\nasync function handler(ctx) {\r\n    const collectionID = ctx.req.param('collectionID');\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : '50';\r\n\r\n    const response = await cache.tryGet(collectionID, () => fetchCollection(collectionID, Number(limit)), config.cache.routeExpire, false);\r\n\r\n    const { title, link, description, items } = response;\r\n\r\n    const itemsArray = items.map((item) => ({\r\n        title: item.post.title || item.post.noticeLinkTitle,\r\n        link: item.post.blogPageUrl,\r\n        description:\r\n            JSON.parse(item.post.photoLinks || `[]`)\r\n                .map((photo) => {\r\n                    if (photo.raw?.match(/\\/\\/nos\\.netease\\.com\\//)) {\r\n                        photo.raw = `https://${photo.raw.match(/(imglf\\d)/)[0]}.lf127.net${photo.raw.match(/\\/\\/nos\\.netease\\.com\\/imglf\\d(.*)/)[1]}`;\r\n                    }\r\n                    return `<img src='${photo.raw || photo.orign}'>`;\r\n                })\r\n                .join('') +\r\n            JSON.parse(item.post.embed ? `[${item.post.embed}]` : `[]`)\r\n                .map((video) => `<video src='${video.originUrl}' poster='${video.video_img_url}' controls='controls'></video>`)\r\n                .join('') +\r\n            item.post.content,\r\n        pubDate: parseDate(item.post.publishTime),\r\n        author: item.post.blogInfo.blogNickName,\r\n        category: item.post.tag.split(','),\r\n    }));\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        item: itemsArray,\r\n        description,\r\n    };\r\n}\r\n"],"mappings":"0VAMA,MAAaA,EAAe,CACxB,KAAM,4BACN,WAAY,CAAC,gBACb,QAAS,4BACT,WAAY,CAAE,aAAc,uDAC5B,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,aACN,YAAa,CAAC,eACd,WAGJ,eAAe,EAAgB,EAAc,EAAO,EAAS,EAAG,CAC5D,IAAM,EAAW,MAAMC,EAAI,CACvB,OAAQ,OACR,IAAK,+EACL,KAAM,IAAI,gBAAgB,CACtB,aAAc,EACd,MAAO,EAAM,WACb,OAAQ,sBACR,OAAQ,EAAO,WACf,MAAO,QAIf,GAAI,CAAC,EAAS,KAAK,SACf,MAAU,MAAM,wBAGpB,IAAM,EAAO,EAAS,KAAK,SAE3B,MAAO,CACH,MAAO,EAAK,WAAW,MAAQ,oBAC/B,KAAM,EAAK,SAAS,aAAe,0BACnC,YAAa,EAAK,WAAW,aAAe,2BAC5C,MAAO,EAAK,OAIpB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAe,EAAI,IAAI,MAAM,gBAC7B,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,KAE3E,EAAW,MAAMC,EAAM,OAAO,MAAoB,EAAgB,EAAc,OAAO,IAAS,EAAO,MAAM,YAAa,IAE1H,CAAE,QAAO,OAAM,cAAa,SAAU,EAEtC,EAAa,EAAM,IAAK,IAAU,CACpC,MAAO,EAAK,KAAK,OAAS,EAAK,KAAK,gBACpC,KAAM,EAAK,KAAK,YAChB,YACI,KAAK,MAAM,EAAK,KAAK,YAAc,MAC9B,IAAK,IACE,EAAM,KAAK,MAAM,6BACjB,EAAM,IAAM,WAAW,EAAM,IAAI,MAAM,aAAa,GAAG,YAAY,EAAM,IAAI,MAAM,sCAAsC,MAEtH,aAAa,EAAM,KAAO,EAAM,MAAM,MAEhD,KAAK,IACV,KAAK,MAAM,EAAK,KAAK,MAAQ,IAAI,EAAK,KAAK,MAAM,GAAK,MACjD,IAAK,GAAU,eAAe,EAAM,UAAU,YAAY,EAAM,cAAc,iCAC9E,KAAK,IACV,EAAK,KAAK,QACd,QAAS,EAAU,EAAK,KAAK,aAC7B,OAAQ,EAAK,KAAK,SAAS,aAC3B,SAAU,EAAK,KAAK,IAAI,MAAM,QAGlC,MAAO,CACH,QACA,OACA,KAAM,EACN"}