{"version":3,"file":"explore-WFSXX1ml.js","names":[],"sources":["../../lib/routes/oshwhub/explore.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport path from 'node:path';\r\nimport { art } from '@/utils/render';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport MarkdownIt from 'markdown-it';\r\nconst md = MarkdownIt({\r\n    html: true,\r\n    linkify: true,\r\n});\r\n\r\nconst requestImages = (url, tryGet) =>\r\n    tryGet(url, async () => {\r\n        const response = await got({\r\n            method: 'get',\r\n            url,\r\n        });\r\n\r\n        const images = {};\r\n        const boms = [];\r\n\r\n        const imgData = response.data;\r\n\r\n        if (imgData?.result?.boards) {\r\n            for (const board of imgData.result.boards) {\r\n                const name = board.name;\r\n                if (images[name] === undefined) {\r\n                    images[name] = [];\r\n                }\r\n\r\n                if (board.schematic?.documents) {\r\n                    for (const val of board.schematic.documents) {\r\n                        if (val.thumb) {\r\n                            images[name].push(val.thumb);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (board.pcb_info?.thumb) {\r\n                    images[name].push(board.pcb_info.thumb);\r\n                }\r\n                if (board.pcb_info?.boms?.boms) {\r\n                    boms.push(...JSON.parse(board.pcb_info.boms.boms));\r\n                }\r\n            }\r\n        }\r\n        return { images, boms };\r\n    });\r\n\r\nexport const route: Route = {\r\n    path: '/:sortType?',\r\n    categories: ['other'],\r\n    example: '/oshwhub',\r\n    parameters: { sortType: 'sortType' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'OpenSource Square',\r\n    maintainers: ['tylinux'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const baseUrl = 'https://oshwhub.com';\r\n    const sortType = ctx.req.param('sortType') ?? 'updatedTime';\r\n\r\n    const url = `${baseUrl}/explore?projectSort=${sortType}`;\r\n    const response = await got({\r\n        method: 'get',\r\n        url,\r\n    });\r\n\r\n    const html = response.data;\r\n    const $ = load(html);\r\n    const title = $('title').text();\r\n    const projects = $('a[class=\"project-link\"]');\r\n\r\n    const items = await Promise.all(\r\n        projects.map((id, item) => {\r\n            const detailUrl = `${baseUrl}${item.attribs.href}`;\r\n            return cache.tryGet(detailUrl, async () => {\r\n                const response = await got({\r\n                    method: 'get',\r\n                    url: detailUrl,\r\n                });\r\n\r\n                const html = response.data;\r\n                const $$ = load(html);\r\n                const projectDetail = $$('div[class=\"projects-left-top\"]');\r\n\r\n                const title = $$(projectDetail).find('span[class=\"title\"]').text();\r\n                const author = $$(projectDetail).find('div[class=\"member-items\"] > ul > li > a > span').first().text().trim();\r\n                const publishTime = $$(projectDetail).find('div[class=\"establish-time\"] > span').text();\r\n                const pubDate = timezone(parseDate(publishTime.trim().split('\\n')[1].trim(), 'YYYY/MM/DD HH:mm:ss'), 0);\r\n\r\n                const coverImg = $$(projectDetail).find('div[class=\"img-cover\"] > img').attr('src')?.trim();\r\n                const introduction = $$(projectDetail).find('p[class=\"introduction\"]').text().trim();\r\n                const content = $$(projectDetail).find('div[class*=\"html-content\"]').attr('data-markdown');\r\n\r\n                // request images\r\n                const dataUuid = $$('div[class=\"projects-detail\"]').attr()['data-uuid'];\r\n                const { images, boms } = await requestImages(`${baseUrl}/api/project/${dataUuid}/pro_images`, cache.tryGet);\r\n\r\n                const description = art(path.join(__dirname, 'templates/description.art'), {\r\n                    title,\r\n                    author,\r\n                    publishTime,\r\n                    coverImg,\r\n                    introduction,\r\n                    content: md.render(content) || 'No Content',\r\n                    images,\r\n                    boms,\r\n                });\r\n\r\n                const single = {\r\n                    title,\r\n                    description,\r\n                    pubDate,\r\n                    link: detailUrl,\r\n                    author,\r\n                };\r\n\r\n                return single;\r\n            });\r\n        })\r\n    );\r\n\r\n    return {\r\n        title,\r\n        link: url,\r\n        description: title,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"qiBAUA,MAAM,EAAK,EAAW,CAClB,KAAM,GACN,QAAS,KAGP,GAAiB,EAAK,IACxB,EAAO,EAAK,SAAY,CACpB,IAAM,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,QAGE,EAAS,GACT,EAAO,GAEP,EAAU,EAAS,KAEzB,GAAI,GAAS,QAAQ,OACjB,IAAK,IAAM,KAAS,EAAQ,OAAO,OAAQ,CACvC,IAAM,EAAO,EAAM,KAKnB,GAJI,EAAO,KAAU,IAAA,KACjB,EAAO,GAAQ,IAGf,EAAM,WAAW,cACZ,IAAM,KAAO,EAAM,UAAU,UAC1B,EAAI,OACJ,EAAO,GAAM,KAAK,EAAI,OAK9B,EAAM,UAAU,OAChB,EAAO,GAAM,KAAK,EAAM,SAAS,OAEjC,EAAM,UAAU,MAAM,MACtB,EAAK,KAAK,GAAG,KAAK,MAAM,EAAM,SAAS,KAAK,OAIxD,MAAO,CAAE,SAAQ,UAGZ,EAAe,CACxB,KAAM,cACN,WAAY,CAAC,SACb,QAAS,WACT,WAAY,CAAE,SAAU,YACxB,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,oBACN,YAAa,CAAC,WACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,sBACV,EAAW,EAAI,IAAI,MAAM,aAAe,cAExC,EAAM,GAAG,EAAQ,uBAAuB,IACxC,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,QAGE,EAAO,EAAS,KAChB,EAAI,EAAK,GACT,EAAQ,EAAE,SAAS,OACnB,EAAW,EAAE,2BAEb,EAAQ,MAAM,QAAQ,IACxB,EAAS,KAAK,EAAI,IAAS,CACvB,IAAM,EAAY,GAAG,IAAU,EAAK,QAAQ,OAC5C,OAAO,EAAM,OAAO,EAAW,SAAY,CACvC,IAAM,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAO,EAAS,KAChB,EAAK,EAAK,GACV,EAAgB,EAAG,kCAEnB,EAAQ,EAAG,GAAe,KAAK,uBAAuB,OACtD,EAAS,EAAG,GAAe,KAAK,kDAAkD,QAAQ,OAAO,OACjG,EAAc,EAAG,GAAe,KAAK,sCAAsC,OAC3E,EAAU,EAAS,EAAU,EAAY,OAAO,MAAM;GAAM,GAAG,OAAQ,uBAAwB,GAE/F,EAAW,EAAG,GAAe,KAAK,gCAAgC,KAAK,QAAQ,OAC/E,EAAe,EAAG,GAAe,KAAK,2BAA2B,OAAO,OACxE,EAAU,EAAG,GAAe,KAAK,8BAA8B,KAAK,iBAGpE,EAAW,EAAG,gCAAgC,OAAO,aACrD,CAAE,SAAQ,QAAS,MAAM,EAAc,GAAG,EAAQ,eAAe,EAAS,aAAc,EAAM,QAE9F,EAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACvE,MAAA,EACA,SACA,cACA,WACA,eACA,QAAS,EAAG,OAAO,IAAY,aAC/B,SACA,SAGE,EAAS,CACX,MAAA,EACA,cACA,UACA,KAAM,EACN,UAGJ,OAAO,OAKnB,MAAO,CACH,QACA,KAAM,EACN,YAAa,EACb,KAAM"}