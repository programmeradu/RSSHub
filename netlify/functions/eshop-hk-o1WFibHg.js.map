{"version":3,"file":"eshop-hk-o1WFibHg.js","names":[],"sources":["../../lib/routes/nintendo/eshop-hk.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nexport const route: Route = {\r\n    path: '/eshop/hk',\r\n    radar: [\r\n        {\r\n            source: ['nintendo.com.hk/software/switch', 'nintendo.com.hk/'],\r\n        },\r\n    ],\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n    url: 'nintendo.com.hk/software/switch',\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const response = await got('https://www.nintendo.com.hk/data/json/switch_software.json');\r\n    const data = response.data.filter(({ link }) => link.startsWith('https://')).slice(0, ctx.req.query('limit') ? Number(ctx.req.query('limit')) : 30);\r\n\r\n    // 获取游戏描述\r\n    const result = await Promise.all(\r\n        data.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const { data: response } = await got(item.link);\r\n                const $ = load(response);\r\n\r\n                let description;\r\n                if (item.link.startsWith('https://store.nintendo.com.hk/')) {\r\n                    const attributes = {\r\n                        platform: $('.platform .product-attribute-val').text(),\r\n                        game_category: $('.game_category .product-attribute-val').text(),\r\n                        release_date: $('.release_date .product-attribute-val').text(),\r\n                        publisher: $('.publisher .product-attribute-val').text(),\r\n                        no_of_players: $('.no_of_players .product-attribute-val').text(),\r\n                        supported_languages: $('.supported_languages .product-attribute-val').text(),\r\n                        required_space: $('.required_space .product-attribute-val').text(),\r\n                        supported_controllers: $('.supported_controllers .product-attribute-val').text(),\r\n                        supported_play_modes: $('.supported_play_modes .product-attribute-val').text(),\r\n                        disclaimer: $('.disclaimer .product-attribute-val p').text(),\r\n                        price: $('meta[property=\"product:price:amount\"]').attr('content'),\r\n                        currency: $('meta[property=\"product:price:currency\"]').attr('content'),\r\n                    };\r\n                    const gallery = JSON.parse(\r\n                        $('[type=text/x-magento-init]')\r\n                            .text()\r\n                            .match(/{\\n\\s+\"\\[data-gal{2}ery-role=gal{2}ery-placeholder]\": {\\n\\s+\"mage(?:\\/gal{2}ery){2}\".*?}{4}(?:\\s+}\\n){3}/s)\r\n                    );\r\n\r\n                    description = art(path.join(__dirname, 'templates/eshop_hk.art'), {\r\n                        attributes,\r\n                        description: $('.description').html(),\r\n                        gallery: gallery['[data-gallery-role=gallery-placeholder]']['mage/gallery/gallery'].data,\r\n                        host: 'store.nintendo.com.hk',\r\n                    });\r\n                } else if (item.link.startsWith('https://ec.nintendo.com/')) {\r\n                    const jsonData = JSON.parse(response.match(/NXSTORE\\.titleDetail\\.jsonData = ({.*?});/)[1]);\r\n                    const { data: priceData } = await got('https://ec.nintendo.com/api/HK/zh/guest_prices', {\r\n                        searchParams: {\r\n                            ns_uids: jsonData.id,\r\n                        },\r\n                    });\r\n\r\n                    description = art(path.join(__dirname, 'templates/eshop_hk.art'), {\r\n                        host: 'ec.nintendo.com',\r\n                        jsonData,\r\n                        priceData: priceData[0],\r\n                    });\r\n                } else {\r\n                    // not implemented\r\n                }\r\n\r\n                return {\r\n                    title: item.title,\r\n                    description,\r\n                    link: item.link,\r\n                    pubDate: parseDate(item.release_date, 'YYYY.M.D'),\r\n                };\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: 'Nintendo eShop（港服）新游戏',\r\n        link: 'https://www.nintendo.com.hk/software/switch/',\r\n        description: 'Nintendo eShop（港服）新上架的游戏',\r\n        item: result,\r\n    };\r\n}\r\n"],"mappings":"wdASA,MAAa,EAAe,CACxB,KAAM,YACN,MAAO,CACH,CACI,OAAQ,CAAC,kCAAmC,sBAGpD,KAAM,UACN,YAAa,GACb,UACA,IAAK,mCAGT,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,MAAM,EAAI,8DACrB,EAAO,EAAS,KAAK,QAAQ,CAAE,UAAW,EAAK,WAAW,aAAa,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,EAAI,IAAI,MAAM,UAAY,IAG1I,EAAS,MAAM,QAAQ,IACzB,EAAK,IAAK,GACN,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAM,CAAE,KAAM,GAAa,MAAM,EAAI,EAAK,MACpC,EAAI,EAAK,GAEX,EACJ,GAAI,EAAK,KAAK,WAAW,kCAAmC,CACxD,IAAM,EAAa,CACf,SAAU,EAAE,oCAAoC,OAChD,cAAe,EAAE,yCAAyC,OAC1D,aAAc,EAAE,wCAAwC,OACxD,UAAW,EAAE,qCAAqC,OAClD,cAAe,EAAE,yCAAyC,OAC1D,oBAAqB,EAAE,+CAA+C,OACtE,eAAgB,EAAE,0CAA0C,OAC5D,sBAAuB,EAAE,iDAAiD,OAC1E,qBAAsB,EAAE,gDAAgD,OACxE,WAAY,EAAE,wCAAwC,OACtD,MAAO,EAAE,yCAAyC,KAAK,WACvD,SAAU,EAAE,2CAA2C,KAAK,YAE1D,EAAU,KAAK,MACjB,EAAE,8BACG,OACA,MAAM,8GAGf,EAAc,EAAI,EAAA,KAAA,EAAA,mCAAgD,CAC9D,aACA,YAAa,EAAE,gBAAgB,OAC/B,QAAS,EAAQ,2CAA2C,wBAAwB,KACpF,KAAM,kCAEH,EAAK,KAAK,WAAW,4BAA6B,CACzD,IAAM,EAAW,KAAK,MAAM,EAAS,MAAM,6CAA6C,IAClF,CAAE,KAAM,GAAc,MAAM,EAAI,iDAAkD,CACpF,aAAc,CACV,QAAS,EAAS,MAI1B,EAAc,EAAI,EAAA,KAAA,EAAA,mCAAgD,CAC9D,KAAM,kBACN,WACA,UAAW,EAAU,KAM7B,MAAO,CACH,MAAO,EAAK,MACZ,cACA,KAAM,EAAK,KACX,QAAS,EAAU,EAAK,aAAc,iBAMtD,MAAO,CACH,MAAO,wBACP,KAAM,+CACN,YAAa,2BACb,KAAM"}