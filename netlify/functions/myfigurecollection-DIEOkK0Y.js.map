{"version":3,"file":"myfigurecollection-DIEOkK0Y.js","names":[],"sources":["../../lib/routes/myfigurecollection/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { isValidHost } from '@/utils/valid-host';\r\nimport InvalidParameterError from '@/errors/types/invalid-parameter';\r\n\r\nconst shortcuts = {\r\n    potd: 'picture/browse/potd/',\r\n    potw: 'picture/browse/potw/',\r\n    potm: 'picture/browse/potm/',\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:category?/:language?',\r\n    categories: ['shopping'],\r\n    example: '/myfigurecollection/potd',\r\n    parameters: { category: '分类，默认为每日圖片', language: '语言，见上表，默认为空，即 `en`' },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['zh.myfigurecollection.net/browse', 'zh.myfigurecollection.net/'],\r\n        },\r\n    ],\r\n    name: '圖片',\r\n    maintainers: ['nczitzk'],\r\n    handler,\r\n    url: 'zh.myfigurecollection.net/browse',\r\n    description: `| 每日圖片 | 每週圖片 | 每月圖片 |\r\n| -------- | -------- | -------- |\r\n| potd     | potw     | potm     |`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const language = ctx.req.param('language') ?? '';\r\n    const category = ctx.req.param('category') ?? 'figure';\r\n    if (language && !isValidHost(language)) {\r\n        throw new InvalidParameterError('Invalid language');\r\n    }\r\n\r\n    const rootUrl = `https://${language === 'en' || language === '' ? '' : `${language}.`}myfigurecollection.net`;\r\n    const currentUrl = `${rootUrl}/${Object.hasOwn(shortcuts, category) ? shortcuts[category] : category}`;\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: currentUrl,\r\n    });\r\n\r\n    const $ = load(response.data);\r\n\r\n    let items = $('.item-icon, .picture-icon')\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 25)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item).find('a');\r\n\r\n            const link = item.attr('href');\r\n\r\n            return {\r\n                link: link.startsWith('http') ? link : `${rootUrl}${link}`,\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                try {\r\n                    const detailResponse = await got({\r\n                        method: 'get',\r\n                        url: item.link,\r\n                    });\r\n\r\n                    const content = load(detailResponse.data);\r\n\r\n                    item.title = content('.headline').text();\r\n                    item.description = art(path.join(__dirname, 'templates/description.art'), {\r\n                        pictures: /myfigurecollection\\.net\\/picture\\//.test(item.link)\r\n                            ? [{ src: content('meta[property=\"og:image\"]').attr('content') }]\r\n                            : JSON.parse(decodeURIComponent(content('meta[name=\"pictures\"]').attr('content'))),\r\n                        fields: content('.form-field')\r\n                            .toArray()\r\n                            .map((f) => ({\r\n                                key: content(f).find('.form-label').text(),\r\n                                value: content(f).find('.form-input').text(),\r\n                            })),\r\n                    });\r\n                } catch {\r\n                    item.title = `Item #${item.link.split('/').pop()}`;\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: $('title')\r\n            .text()\r\n            .replace(/ \\(.*\\)/, ''),\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"siBAUA,MAAM,EAAY,CACd,KAAM,uBACN,KAAM,uBACN,KAAM,wBAGG,EAAe,CACxB,KAAM,yBACN,WAAY,CAAC,YACb,QAAS,2BACT,WAAY,CAAE,SAAU,aAAc,SAAU,sBAChD,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,mCAAoC,gCAGrD,KAAM,KACN,YAAa,CAAC,WACd,UACA,IAAK,mCACL,YAAa;;qCAKjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,aAAe,GACxC,EAAW,EAAI,IAAI,MAAM,aAAe,SAC9C,GAAI,GAAY,CAAC,EAAY,GACzB,MAAM,IAAI,EAAsB,oBAGpC,IAAM,EAAU,WAAW,IAAa,MAAQ,IAAa,GAAK,GAAK,GAAG,EAAS,GAAG,wBAChF,EAAa,GAAG,EAAQ,GAAG,OAAO,OAAO,EAAW,GAAY,EAAU,GAAY,IAEtF,EAAW,MAAM,EAAI,CACvB,OAAQ,MACR,IAAK,IAGH,EAAI,EAAK,EAAS,MAEpB,EAAQ,EAAE,6BACT,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAC5E,UACA,IAAK,GAAS,CACX,EAAO,EAAE,GAAM,KAAK,KAEpB,IAAM,EAAO,EAAK,KAAK,QAEvB,MAAO,CACH,KAAM,EAAK,WAAW,QAAU,EAAO,GAAG,IAAU,OAoChE,MAhCA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,CACA,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,MACR,IAAK,EAAK,OAGR,EAAU,EAAK,EAAe,MAEpC,EAAK,MAAQ,EAAQ,aAAa,OAClC,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,sCAAmD,CACtE,SAAU,qCAAqC,KAAK,EAAK,MACnD,CAAC,CAAE,IAAK,EAAQ,6BAA6B,KAAK,aAClD,KAAK,MAAM,mBAAmB,EAAQ,yBAAyB,KAAK,aAC1E,OAAQ,EAAQ,eACX,UACA,IAAK,IAAO,CACT,IAAK,EAAQ,GAAG,KAAK,eAAe,OACpC,MAAO,EAAQ,GAAG,KAAK,eAAe,iBAG9C,CACJ,EAAK,MAAQ,SAAS,EAAK,KAAK,MAAM,KAAK,QAG/C,OAAO,MAKZ,CACH,MAAO,EAAE,SACJ,OACA,QAAQ,UAAW,IACxB,KAAM,EACN,KAAM"}