{"version":3,"file":"in-app-purchase-C619lx22.js","names":["route: Route","got","title"],"sources":["../../lib/routes/appstore/in-app-purchase.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport got from '@/utils/got';\r\nimport * as url from 'node:url';\r\nimport { load } from 'cheerio';\r\n\r\nexport const route: Route = {\r\n    path: '/iap/:country/:id',\r\n    categories: ['program-update'],\r\n    example: '/appstore/iap/us/id953286746',\r\n    parameters: {\r\n        country: 'App Store Country, obtain from the app URL https://apps.apple.com/us/app/id953286746, in this case, `us`',\r\n        id: 'App Store app id, obtain from the app URL https://apps.apple.com/us/app/id953286746, in this case, `id953286746`',\r\n    },\r\n    features: {\r\n        requireConfig: false,\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: 'In-App-Purchase Price Drop Alert',\r\n    maintainers: ['HenryQW'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const country = ctx.req.param('country');\r\n    const id = ctx.req.param('id');\r\n    const link = `https://apps.apple.com/${country}/app/${id}`;\r\n    const target = url.resolve(link, '?mt=8#see-all/in-app-purchases');\r\n\r\n    const res = await got.get(target);\r\n    const $ = load(res.data);\r\n    const lang = $('html').attr('lang');\r\n\r\n    const apiResponse = (\r\n        await got({\r\n            method: 'get',\r\n            url: `https://amp-api.apps.apple.com/v1/catalog/${country}/apps/${id.replace('id', '')}?platform=web&include=Cmerchandised-in-apps%2Ctop-in-apps%2Ceula&l=${lang}`,\r\n            headers: {\r\n                authorization:\r\n                    'Bearer eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6IkNSRjVITkJHUFEifQ.eyJpc3MiOiI4Q1UyNk1LTFM0IiwiaWF0IjoxNjA3MDMxMTcwLCJleHAiOjE2MTAwNTUxNzB9.qzq2PKkPBNDwHbShoBY3T7J2IjgWsR_MyAvTnZtQB5FZjsH_ZY5esBa0qXbA9kUiq_90GkRoNVMR03meOQQ7SQ',\r\n                authority: 'amp-api.apps.apple.com',\r\n                referer: target,\r\n            },\r\n        })\r\n    ).data.data[0];\r\n\r\n    const attributes = apiResponse.attributes;\r\n    const titleTemp = attributes.name;\r\n\r\n    const platform = attributes.deviceFamilies.includes('mac') ? 'macOS' : 'iOS';\r\n    let title;\r\n    let item = [];\r\n\r\n    const iap = apiResponse.relationships['top-in-apps'].data;\r\n    if (iap) {\r\n        title = `${country === 'cn' ? '内购限免提醒' : 'IAP price watcher'}: ${titleTemp} for ${platform}`;\r\n\r\n        item = iap.map((e) => {\r\n            const title = `${e.attributes.name} is now ${e.attributes.offers[0].priceFormatted}`;\r\n\r\n            const result = {\r\n                link,\r\n                guid: e.attributes.url,\r\n                description: e.attributes.artwork ? e.attributes.description.standard + `<br><img src=${e.attributes.artwork.url.replace('{w}x{h}{c}.{f}', '320x0w.jpg')}>` : e.attributes.description.standard,\r\n                title,\r\n                pubDate: new Date().toUTCString(),\r\n            };\r\n            return result;\r\n        });\r\n    }\r\n\r\n    return {\r\n        title,\r\n        link,\r\n        item,\r\n    };\r\n}\r\n"],"mappings":"0RAKA,MAAaA,EAAe,CACxB,KAAM,oBACN,WAAY,CAAC,kBACb,QAAS,+BACT,WAAY,CACR,QAAS,2GACT,GAAI,oHAER,SAAU,CACN,cAAe,GACf,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,mCACN,YAAa,CAAC,WACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAU,EAAI,IAAI,MAAM,WACxB,EAAK,EAAI,IAAI,MAAM,MACnB,EAAO,0BAA0B,EAAQ,OAAO,IAChD,EAAS,EAAI,QAAQ,EAAM,kCAE3B,EAAM,MAAMC,EAAI,IAAI,GACpB,EAAI,EAAK,EAAI,MACb,EAAO,EAAE,QAAQ,KAAK,QAEtB,GACF,MAAMA,EAAI,CACN,OAAQ,MACR,IAAK,6CAA6C,EAAQ,QAAQ,EAAG,QAAQ,KAAM,IAAI,qEAAqE,IAC5J,QAAS,CACL,cACI,wOACJ,UAAW,yBACX,QAAS,MAGnB,KAAK,KAAK,GAEN,EAAa,EAAY,WACzB,EAAY,EAAW,KAEvB,EAAW,EAAW,eAAe,SAAS,OAAS,QAAU,MACnE,EACA,EAAO,GAEL,EAAM,EAAY,cAAc,eAAe,KAkBrD,OAjBI,IACA,EAAQ,GAAG,IAAY,KAAO,SAAW,oBAAoB,IAAI,EAAU,OAAO,IAElF,EAAO,EAAI,IAAK,GAAM,CAClB,IAAMC,EAAQ,GAAG,EAAE,WAAW,KAAK,UAAU,EAAE,WAAW,OAAO,GAAG,iBAE9D,EAAS,CACX,OACA,KAAM,EAAE,WAAW,IACnB,YAAa,EAAE,WAAW,QAAU,EAAE,WAAW,YAAY,SAAW,gBAAgB,EAAE,WAAW,QAAQ,IAAI,QAAQ,iBAAkB,cAAc,GAAK,EAAE,WAAW,YAAY,SACvL,MAAA,EACA,QAAS,IAAI,OAAO,eAExB,OAAO,KAIR,CACH,QACA,OACA"}