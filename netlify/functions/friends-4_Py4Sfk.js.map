{"version":3,"file":"friends-4_Py4Sfk.js","names":["route: Route","ConfigNotFoundError","cache","got","weiboUtils"],"sources":["../../lib/routes/weibo/friends.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport querystring from 'node:querystring';\r\nimport got from '@/utils/got';\r\nimport { config } from '@/config';\r\nimport weiboUtils from './utils';\r\nimport { fallback, queryToBoolean } from '@/utils/readable-social';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nexport const route: Route = {\r\n    path: '/friends/:routeParams?',\r\n    categories: ['social-media'],\r\n    example: '/weibo/friends',\r\n    parameters: { routeParams: '额外参数；请参阅上面的说明和表格' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'WEIBO_COOKIES',\r\n                optional: true,\r\n                description: '',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    radar: [\r\n        {\r\n            source: ['weibo.com/'],\r\n            target: '/friends',\r\n        },\r\n    ],\r\n    name: '最新关注时间线',\r\n    maintainers: ['CaoMeiYouRen'],\r\n    handler,\r\n    url: 'weibo.com/',\r\n    description: `::: warning\r\n  此方案必须使用用户\\`Cookie\\`进行抓取\r\n\r\n  因微博 cookies 的过期与更新方案未经验证，部署一次 Cookie 的有效时长未知\r\n\r\n  微博用户 Cookie 的配置可参照部署文档\r\n:::`,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.weibo.cookies) {\r\n        throw new ConfigNotFoundError('Weibo Friends Timeline is not available due to the absense of [Weibo Cookies]. Check <a href=\"https://docs.rsshub.app/deploy/config#route-specific-configurations\">relevant config tutorial</a>');\r\n    }\r\n\r\n    let displayVideo = '1';\r\n    let displayArticle = '0';\r\n    let displayComments = '0';\r\n    if (ctx.req.param('routeParams')) {\r\n        if (ctx.req.param('routeParams') === '1' || ctx.req.param('routeParams') === '0') {\r\n            displayVideo = ctx.req.param('routeParams');\r\n        } else {\r\n            const routeParams = querystring.parse(ctx.req.param('routeParams'));\r\n            displayVideo = fallback(undefined, queryToBoolean(routeParams.displayVideo), true) ? '1' : '0';\r\n            displayArticle = fallback(undefined, queryToBoolean(routeParams.displayArticle), false) ? '1' : '0';\r\n            displayComments = fallback(undefined, queryToBoolean(routeParams.displayComments), false) ? '1' : '0';\r\n        }\r\n    }\r\n\r\n    const uid = await cache.tryGet(\r\n        `weibo:friends:login-user`,\r\n        async () => {\r\n            const _r = await got({\r\n                method: 'get',\r\n                url: 'https://m.weibo.cn/api/config',\r\n                headers: {\r\n                    Referer: `https://m.weibo.cn/`,\r\n                    'MWeibo-Pwa': 1,\r\n                    'X-Requested-With': 'XMLHttpRequest',\r\n                    Cookie: config.weibo.cookies,\r\n                },\r\n            });\r\n            return _r.data.data.uid;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const containerData = await cache.tryGet(\r\n        `weibo:user:index:${uid}`,\r\n        async () => {\r\n            const _r = await got({\r\n                method: 'get',\r\n                url: `https://m.weibo.cn/api/container/getIndex?type=uid&value=${uid}`,\r\n                headers: {\r\n                    Referer: `https://m.weibo.cn/u/${uid}`,\r\n                    'MWeibo-Pwa': 1,\r\n                    'X-Requested-With': 'XMLHttpRequest',\r\n                    Cookie: config.weibo.cookies,\r\n                },\r\n            });\r\n            return _r.data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n\r\n    const name = containerData.data.userInfo.screen_name;\r\n    const title = `${name} 的 最新关注时间线`;\r\n\r\n    const responseData = await cache.tryGet(\r\n        `weibo:friends:index:${uid}`,\r\n        async () => {\r\n            const _r = await got({\r\n                method: 'get',\r\n                url: 'https://m.weibo.cn/feed/friends',\r\n                headers: {\r\n                    Referer: `https://m.weibo.cn/`,\r\n                    'MWeibo-Pwa': 1,\r\n                    'X-Requested-With': 'XMLHttpRequest',\r\n                    Cookie: config.weibo.cookies,\r\n                },\r\n            });\r\n            return _r.data.data;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    );\r\n    const resultItems = await Promise.all(\r\n        responseData.statuses.map(async (item) => {\r\n            const retweet = item.retweeted_status;\r\n            if (retweet && retweet.isLongText) {\r\n                const retweetData = await cache.tryGet(`weibo:retweeted:${retweet.user.id}:${retweet.bid}`, () => weiboUtils.getShowData(retweet.user.id, retweet.bid));\r\n                if (retweetData !== undefined && retweetData.text) {\r\n                    item.retweeted_status.text = retweetData.text;\r\n                }\r\n            }\r\n\r\n            const formatExtended = weiboUtils.formatExtended(ctx, item);\r\n            let description = formatExtended.description;\r\n\r\n            if (displayVideo === '1') {\r\n                description = item.retweeted_status ? weiboUtils.formatVideo(description, item.retweeted_status) : weiboUtils.formatVideo(description, item);\r\n            }\r\n\r\n            if (displayComments === '1') {\r\n                description = await weiboUtils.formatComments(ctx, description, item, '0');\r\n            }\r\n\r\n            if (displayArticle === '1') {\r\n                description = await (item.retweeted_status ? weiboUtils.formatArticle(ctx, description, item.retweeted_status) : weiboUtils.formatArticle(ctx, description, item));\r\n            }\r\n\r\n            return {\r\n                ...formatExtended,\r\n                description,\r\n            };\r\n        })\r\n    );\r\n\r\n    return weiboUtils.sinaimgTvax({\r\n        title,\r\n        link: `https://weibo.com`,\r\n        item: resultItems,\r\n    });\r\n}\r\n"],"mappings":"ghBASA,MAAaA,EAAe,CACxB,KAAM,yBACN,WAAY,CAAC,gBACb,QAAS,iBACT,WAAY,CAAE,YAAa,oBAC3B,SAAU,CACN,cAAe,CACX,CACI,KAAM,gBACN,SAAU,GACV,YAAa,KAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,MAAO,CACH,CACI,OAAQ,CAAC,cACT,OAAQ,aAGhB,KAAM,UACN,YAAa,CAAC,gBACd,UACA,IAAK,aACL,YAAa;;;;;;MASjB,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,MAAM,QACd,MAAM,IAAIC,EAAoB,mMAGlC,IAAI,EAAe,IACf,EAAiB,IACjB,EAAkB,IACtB,GAAI,EAAI,IAAI,MAAM,eACd,GAAI,EAAI,IAAI,MAAM,iBAAmB,KAAO,EAAI,IAAI,MAAM,iBAAmB,IACzE,EAAe,EAAI,IAAI,MAAM,mBAC1B,CACH,IAAM,EAAc,EAAY,MAAM,EAAI,IAAI,MAAM,gBACpD,EAAe,EAAS,IAAA,GAAW,EAAe,EAAY,cAAe,IAAQ,IAAM,IAC3F,EAAiB,EAAS,IAAA,GAAW,EAAe,EAAY,gBAAiB,IAAS,IAAM,IAChG,EAAkB,EAAS,IAAA,GAAW,EAAe,EAAY,iBAAkB,IAAS,IAAM,IAI1G,IAAM,EAAM,MAAMC,EAAM,OACpB,2BACA,SAAY,CACR,IAAM,EAAK,MAAMC,EAAI,CACjB,OAAQ,MACR,IAAK,gCACL,QAAS,CACL,QAAS,sBACT,aAAc,EACd,mBAAoB,iBACpB,OAAQ,EAAO,MAAM,WAG7B,OAAO,EAAG,KAAK,KAAK,KAExB,EAAO,MAAM,YACb,IAGE,EAAgB,MAAMD,EAAM,OAC9B,oBAAoB,IACpB,SAAY,CACR,IAAM,EAAK,MAAMC,EAAI,CACjB,OAAQ,MACR,IAAK,4DAA4D,IACjE,QAAS,CACL,QAAS,wBAAwB,IACjC,aAAc,EACd,mBAAoB,iBACpB,OAAQ,EAAO,MAAM,WAG7B,OAAO,EAAG,MAEd,EAAO,MAAM,YACb,IAGE,EAAO,EAAc,KAAK,SAAS,YACnC,EAAQ,GAAG,EAAK,YAEhB,EAAe,MAAMD,EAAM,OAC7B,uBAAuB,IACvB,SAAY,CACR,IAAM,EAAK,MAAMC,EAAI,CACjB,OAAQ,MACR,IAAK,kCACL,QAAS,CACL,QAAS,sBACT,aAAc,EACd,mBAAoB,iBACpB,OAAQ,EAAO,MAAM,WAG7B,OAAO,EAAG,KAAK,MAEnB,EAAO,MAAM,YACb,IAEE,EAAc,MAAM,QAAQ,IAC9B,EAAa,SAAS,IAAI,KAAO,IAAS,CACtC,IAAM,EAAU,EAAK,iBACrB,GAAI,GAAW,EAAQ,WAAY,CAC/B,IAAM,EAAc,MAAMD,EAAM,OAAO,mBAAmB,EAAQ,KAAK,GAAG,GAAG,EAAQ,UAAaE,EAAW,YAAY,EAAQ,KAAK,GAAI,EAAQ,MAC9I,IAAgB,IAAA,IAAa,EAAY,OACzC,EAAK,iBAAiB,KAAO,EAAY,MAIjD,IAAM,EAAiBA,EAAW,eAAe,EAAK,GAClD,EAAc,EAAe,YAcjC,OAZI,IAAiB,MACjB,EAAc,EAAK,iBAAmBA,EAAW,YAAY,EAAa,EAAK,kBAAoBA,EAAW,YAAY,EAAa,IAGvI,IAAoB,MACpB,EAAc,MAAMA,EAAW,eAAe,EAAK,EAAa,EAAM,MAGtE,IAAmB,MACnB,EAAc,MAAO,EAAK,iBAAmBA,EAAW,cAAc,EAAK,EAAa,EAAK,kBAAoBA,EAAW,cAAc,EAAK,EAAa,KAGzJ,CACH,GAAG,EACH,kBAKZ,OAAOA,EAAW,YAAY,CAC1B,QACA,KAAM,oBACN,KAAM"}