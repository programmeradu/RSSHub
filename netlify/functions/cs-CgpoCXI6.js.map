{"version":3,"file":"cs-CgpoCXI6.js","names":["route: Route","got","cache"],"sources":["../../lib/routes/cs/index.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport iconv from 'iconv-lite';\r\nimport timezone from '@/utils/timezone';\r\nimport { parseDate } from '@/utils/parse-date';\r\n\r\nconst decodeBufferByCharset = (buffer) => {\r\n    const isGBK = /charset=\"?'?gb/i.test(buffer.toString());\r\n    const encoding = isGBK ? 'gbk' : 'utf-8';\r\n\r\n    return iconv.decode(buffer, encoding);\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/:category{.+}?',\r\n    name: '栏目',\r\n    parameters: { category: '分类，见下表，默认为首页' },\r\n    maintainers: ['nczitzk'],\r\n    description: `| 要闻 | 公司 | 市场 | 基金 |\r\n| ---- | ---- | ---- | ---- |\r\n| xwzx | ssgs | gppd | tzjj |\r\n\r\n| 科创 | 产经   | 期货     | 海外   |\r\n| ---- | ------ | -------- | ------ |\r\n| 5g   | cj2020 | zzqh2020 | hw2020 |\r\n\r\n<details>\r\n<summary>更多栏目</summary>\r\n\r\n#### 要闻\r\n\r\n| 财经要闻 | 观点评论 | 民生消费  |\r\n| -------- | -------- | --------- |\r\n| xwzx/hg  | xwzx/jr  | xwzx/msxf |\r\n\r\n#### 公司\r\n\r\n| 公司要闻  | 公司深度  | 公司巡礼  |\r\n| --------- | --------- | --------- |\r\n| ssgs/gsxw | ssgs/gssd | ssgs/gsxl |\r\n\r\n#### 市场\r\n\r\n| A 股市场  | 港股资讯  | 债市研究  | 海外报道  | 期货报道  |\r\n| --------- | --------- | --------- | --------- | --------- |\r\n| gppd/gsyj | gppd/ggzx | gppd/zqxw | gppd/hwbd | gppd/qhbd |\r\n\r\n#### 基金\r\n\r\n| 基金动态  | 基金视点  | 基金持仓  | 私募基金  | 基民学苑  |\r\n| --------- | --------- | --------- | --------- | --------- |\r\n| tzjj/jjdt | tzjj/jjks | tzjj/jjcs | tzjj/smjj | tzjj/tjdh |\r\n\r\n#### 机构\r\n\r\n| 券商 | 银行 | 保险 |\r\n| ---- | ---- | ---- |\r\n| qs   | yh   | bx   |\r\n\r\n#### 其他\r\n\r\n| 中证快讯 7x24 | IPO 鉴真 | 公司能见度 |\r\n| ------------- | -------- | ---------- |\r\n| sylm/jsbd     | yc/ipojz | yc/gsnjd   |\r\n</details>`,\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const { category = 'xwzx' } = ctx.req.param();\r\n    const limit = ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit'), 10) : 30;\r\n\r\n    const rootUrl = 'https://www.cs.com.cn';\r\n    const currentUrl = new URL(category.endsWith('/') ? category : `${category}/`, rootUrl).href;\r\n\r\n    const { data: response } = await got(currentUrl, {\r\n        responseType: 'buffer',\r\n    });\r\n\r\n    const $ = load(decodeBufferByCharset(response));\r\n\r\n    let items = $('ul.ch_type3_list li a')\r\n        .slice(0, limit)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n\r\n            return {\r\n                title: item.find('h3').text().trim(),\r\n                link: new URL(item.prop('href'), currentUrl).href,\r\n                pubDate: timezone(parseDate(item.find('em').text()), +8),\r\n            };\r\n        });\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                try {\r\n                    const { data: detailResponse } = await got(item.link, {\r\n                        responseType: 'buffer',\r\n                    });\r\n\r\n                    const content = load(decodeBufferByCharset(detailResponse));\r\n\r\n                    item.title = content('article.cont_article header h1').text().trim();\r\n                    item.description = content('article.cont_article section').html();\r\n                    item.author = content('div.artc_info em').text().trim();\r\n                    item.category = content('div.artc_route div a')\r\n                        .slice(1)\r\n                        .toArray()\r\n                        .map((c) => content(c).prop('title') ?? content(c).text());\r\n                    item.pubDate = timezone(parseDate(content('.time').prop('datetime')), +8);\r\n                } catch {\r\n                    // no-empty\r\n                }\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    const title = $('title').text();\r\n    const image = new URL($('div.logo_cs a img').prop('src'), currentUrl).href;\r\n    const icon = new URL('favicon.ico', rootUrl).href;\r\n\r\n    return {\r\n        item: items,\r\n        title,\r\n        link: currentUrl,\r\n        description: $('meta[name=\"Description\"]').prop('content'),\r\n        language: $('html').prop('lang'),\r\n        image,\r\n        icon,\r\n        logo: icon,\r\n        subtitle: $('meta[name=\"Keywords\"]').prop('content'),\r\n        author: title.split('-').pop().trim(),\r\n    };\r\n}\r\n"],"mappings":"obAQA,MAAM,EAAyB,GAAW,CACtC,IAAM,EAAQ,kBAAkB,KAAK,EAAO,YACtC,EAAW,EAAQ,MAAQ,QAEjC,OAAO,EAAM,OAAO,EAAQ,IAGnBA,EAAe,CACxB,KAAM,kBACN,KAAM,KACN,WAAY,CAAE,SAAU,gBACxB,YAAa,CAAC,WACd,YAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;YA+Cb,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAM,CAAE,WAAW,QAAW,EAAI,IAAI,QAChC,EAAQ,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,SAAU,IAAM,GAE/E,EAAU,wBACV,EAAa,IAAI,IAAI,EAAS,SAAS,KAAO,EAAW,GAAG,EAAS,GAAI,GAAS,KAElF,CAAE,KAAM,GAAa,MAAMC,EAAI,EAAY,CAC7C,aAAc,WAGZ,EAAI,EAAK,EAAsB,IAEjC,EAAQ,EAAE,yBACT,MAAM,EAAG,GACT,UACA,IAAK,IACF,EAAO,EAAE,GAEF,CACH,MAAO,EAAK,KAAK,MAAM,OAAO,OAC9B,KAAM,IAAI,IAAI,EAAK,KAAK,QAAS,GAAY,KAC7C,QAAS,EAAS,EAAU,EAAK,KAAK,MAAM,QAAS,MAIjE,EAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACPC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,GAAI,CACA,GAAM,CAAE,KAAM,GAAmB,MAAMD,EAAI,EAAK,KAAM,CAClD,aAAc,WAGZ,EAAU,EAAK,EAAsB,IAE3C,EAAK,MAAQ,EAAQ,kCAAkC,OAAO,OAC9D,EAAK,YAAc,EAAQ,gCAAgC,OAC3D,EAAK,OAAS,EAAQ,oBAAoB,OAAO,OACjD,EAAK,SAAW,EAAQ,wBACnB,MAAM,GACN,UACA,IAAK,GAAM,EAAQ,GAAG,KAAK,UAAY,EAAQ,GAAG,QACvD,EAAK,QAAU,EAAS,EAAU,EAAQ,SAAS,KAAK,aAAc,QAClE,EAIR,OAAO,MAKnB,IAAM,EAAQ,EAAE,SAAS,OACnB,EAAQ,IAAI,IAAI,EAAE,qBAAqB,KAAK,OAAQ,GAAY,KAChE,EAAO,IAAI,IAAI,cAAe,GAAS,KAE7C,MAAO,CACH,KAAM,EACN,QACA,KAAM,EACN,YAAa,EAAE,4BAA4B,KAAK,WAChD,SAAU,EAAE,QAAQ,KAAK,QACzB,QACA,OACA,KAAM,EACN,SAAU,EAAE,yBAAyB,KAAK,WAC1C,OAAQ,EAAM,MAAM,KAAK,MAAM"}