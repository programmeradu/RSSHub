{"version":3,"file":"topic-BhzbKnlt.js","names":["route: Route","got","cache","$"],"sources":["../../lib/routes/kanxue/topic.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { load } from 'cheerio';\r\nimport { parseRelativeDate, parseDate } from '@/utils/parse-date';\r\n\r\nconst baseUrl = 'https://bbs.kanxue.com/';\r\nconst categoryId = {\r\n    iot: [128, '智能设备'],\r\n    android: [161, 'Android安全'],\r\n    ios: [166, 'iOS安全'],\r\n    harmonyos: [178, 'HarmonyOS安全'],\r\n    re: [4, '软件逆向'],\r\n    coding: [41, '编程技术'],\r\n    unpack: [88, '加壳脱壳'],\r\n    crypto: [132, '密码应用'],\r\n    vuln: [150, '二进制漏洞'],\r\n    ctf: [37, 'CTF对抗'],\r\n    pwn: [171, 'Pwn'],\r\n    web: [151, 'WEB安全'],\r\n    chat: [45, '茶余饭后'],\r\n    geekzone: [172, '极客空间'],\r\n    translate: [32, '外文翻译'],\r\n};\r\n\r\nexport const route: Route = {\r\n    path: '/topic/:category?/:type?',\r\n    categories: ['bbs'],\r\n    example: '/kanxue/topic/android/digest',\r\n    parameters: { category: '版块, 缺省为`all`', type: '类型, 缺省为`latest`' },\r\n    name: '论坛',\r\n    maintainers: ['renzhexigua'],\r\n    handler,\r\n    description: `| 版块           | category  |\r\n| -------------- | --------- |\r\n| 智能设备       | iot       |\r\n| Android 安全   | android   |\r\n| iOS 安全       | ios       |\r\n| HarmonyOS 安全 | harmonyos |\r\n| 软件逆向       | re        |\r\n| 编程技术       | coding    |\r\n| 加壳脱壳       | unpack    |\r\n| 密码应用       | crypto    |\r\n| 二进制漏洞     | vuln      |\r\n| CTF 对抗       | ctf       |\r\n| Pwn            | pwn       |\r\n| WEB 安全       | web       |\r\n| 茶余饭后       | chat      |\r\n| 极客空间       | geekzone  |\r\n| 外文翻译       | translate |\r\n| 全站           | all       |\r\n\r\n| 类型     | type   |\r\n| -------- | ------ |\r\n| 最新主题 | latest |\r\n| 精华主题 | digest |`,\r\n};\r\n\r\nconst timeDiff = 1000 * 60 * 60 * 24 * 3;\r\n\r\nasync function handler(ctx) {\r\n    const category = ctx.req.param('category') || 'all';\r\n    const type = ctx.req.param('type') || 'latest';\r\n    let path;\r\n    let title;\r\n    if (Object.hasOwn(categoryId, category)) {\r\n        if (type === 'digest') {\r\n            // type为digest时只获取精华帖\r\n            path = `forum-${categoryId[category][0]}-1.htm?digest=1`;\r\n            title = `看雪论坛精华主题 - ${categoryId[category][1]}`;\r\n        } else {\r\n            // type为空/非法/latest时则只获取最新帖\r\n            path = `forum-${categoryId[category][0]}.html`;\r\n            title = `看雪论坛最新主题 - ${categoryId[category][1]}`;\r\n        }\r\n    } else {\r\n        // category未知时则获取全站最新帖\r\n        if (category === 'digest') {\r\n            path = 'new-digest.htm';\r\n            title = '看雪论坛精华主题';\r\n        } else {\r\n            path = 'new-tid.htm';\r\n            title = '看雪论坛最新主题';\r\n        }\r\n    }\r\n\r\n    const response = await got({\r\n        method: 'get',\r\n        url: baseUrl + path,\r\n        headers: {\r\n            Referer: baseUrl,\r\n        },\r\n    });\r\n\r\n    const $ = load(response.data);\r\n    const list = $('.thread');\r\n\r\n    const resultItem = await Promise.all(\r\n        list\r\n            ? list\r\n                  // fix .thread .top_3\r\n                  .toArray()\r\n                  .filter((elem) => {\r\n                      const timeStr = $('.date', elem).eq(0).text();\r\n                      const pubDate = timeStr.endsWith('前') ? parseRelativeDate(timeStr) : parseDate(timeStr.slice(1));\r\n                      return !elem.attribs.class.includes('top') || Date.now() - pubDate.valueOf() < timeDiff;\r\n                  })\r\n                  .map((elem) => {\r\n                      const subject = $('.subject a', elem).eq(1);\r\n                      const timeStr = $('.date', elem).eq(0).text();\r\n                      const pubDate = timeStr.endsWith('前') ? parseRelativeDate(timeStr) : parseDate(timeStr.slice(1));\r\n\r\n                      const link = `${baseUrl}${subject.attr('href')}`;\r\n                      const key = `kanxue: ${link}`;\r\n\r\n                      return cache.tryGet(key, async () => {\r\n                          const postDetail = await got({\r\n                              method: 'get',\r\n                              url: link,\r\n                          });\r\n                          const $ = load(postDetail.data);\r\n                          $('.card')\r\n                              .eq(0)\r\n                              .find('.message img')\r\n                              .each((_, item) => {\r\n                                  item = $(item);\r\n\r\n                                  const src = item.attr('src');\r\n                                  if (src !== undefined && !src.startsWith('https://') && !src.startsWith('http://')) {\r\n                                      item.attr('src', `https://bbs.kanxue.com/${src}`);\r\n                                  }\r\n                              });\r\n\r\n                          const description = $('.card').eq(0).find('.message').html();\r\n\r\n                          return {\r\n                              title: subject.text(),\r\n                              link,\r\n                              pubDate,\r\n                              description,\r\n                          };\r\n                      });\r\n                  })\r\n            : []\r\n    );\r\n\r\n    return {\r\n        title,\r\n        link: baseUrl + path,\r\n        item: resultItem,\r\n        allowEmpty: true,\r\n    };\r\n}\r\n"],"mappings":"+XAMA,MAAM,EAAU,0BACV,EAAa,CACf,IAAK,CAAC,IAAK,QACX,QAAS,CAAC,IAAK,aACf,IAAK,CAAC,IAAK,SACX,UAAW,CAAC,IAAK,eACjB,GAAI,CAAC,EAAG,QACR,OAAQ,CAAC,GAAI,QACb,OAAQ,CAAC,GAAI,QACb,OAAQ,CAAC,IAAK,QACd,KAAM,CAAC,IAAK,SACZ,IAAK,CAAC,GAAI,SACV,IAAK,CAAC,IAAK,OACX,IAAK,CAAC,IAAK,SACX,KAAM,CAAC,GAAI,QACX,SAAU,CAAC,IAAK,QAChB,UAAW,CAAC,GAAI,SAGPA,EAAe,CACxB,KAAM,2BACN,WAAY,CAAC,OACb,QAAS,+BACT,WAAY,CAAE,SAAU,eAAgB,KAAM,mBAC9C,KAAM,KACN,YAAa,CAAC,eACd,UACA,YAAa;;;;;;;;;;;;;;;;;;;;;;oBA2BjB,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAW,EAAI,IAAI,MAAM,aAAe,MACxC,EAAO,EAAI,IAAI,MAAM,SAAW,SAClC,EACA,EACA,OAAO,OAAO,EAAY,GACtB,IAAS,UAET,EAAO,SAAS,EAAW,GAAU,GAAG,iBACxC,EAAQ,cAAc,EAAW,GAAU,OAG3C,EAAO,SAAS,EAAW,GAAU,GAAG,OACxC,EAAQ,cAAc,EAAW,GAAU,MAI3C,IAAa,UACb,EAAO,iBACP,EAAQ,aAER,EAAO,cACP,EAAQ,YAIhB,IAAM,EAAW,MAAMC,EAAI,CACvB,OAAQ,MACR,IAAK,EAAU,EACf,QAAS,CACL,QAAS,KAIX,EAAI,EAAK,EAAS,MAClB,EAAO,EAAE,WAET,EAAa,MAAM,QAAQ,IAC7B,EACM,EAEK,UACA,OAAQ,GAAS,CACd,IAAM,EAAU,EAAE,QAAS,GAAM,GAAG,GAAG,OACjC,EAAU,EAAQ,SAAS,KAAO,EAAkB,GAAW,EAAU,EAAQ,MAAM,IAC7F,MAAO,CAAC,EAAK,QAAQ,MAAM,SAAS,QAAU,KAAK,MAAQ,EAAQ,UAAY,SAElF,IAAK,GAAS,CACX,IAAM,EAAU,EAAE,aAAc,GAAM,GAAG,GACnC,EAAU,EAAE,QAAS,GAAM,GAAG,GAAG,OACjC,EAAU,EAAQ,SAAS,KAAO,EAAkB,GAAW,EAAU,EAAQ,MAAM,IAEvF,EAAO,GAAG,IAAU,EAAQ,KAAK,UACjC,EAAM,WAAW,IAEvB,OAAOC,EAAM,OAAO,EAAK,SAAY,CACjC,IAAM,EAAa,MAAMD,EAAI,CACzB,OAAQ,MACR,IAAK,IAEHE,EAAI,EAAK,EAAW,MAC1B,EAAE,SACG,GAAG,GACH,KAAK,gBACL,MAAM,EAAG,IAAS,CACf,EAAOA,EAAE,GAET,IAAM,EAAM,EAAK,KAAK,OAClB,IAAQ,IAAA,IAAa,CAAC,EAAI,WAAW,aAAe,CAAC,EAAI,WAAW,YACpE,EAAK,KAAK,MAAO,0BAA0B,OAIvD,IAAM,EAAcA,EAAE,SAAS,GAAG,GAAG,KAAK,YAAY,OAEtD,MAAO,CACH,MAAO,EAAQ,OACf,OACA,UACA,mBAIhB,IAGV,MAAO,CACH,QACA,KAAM,EAAU,EAChB,KAAM,EACN,WAAY"}