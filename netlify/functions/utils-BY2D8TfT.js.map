{"version":3,"file":"utils-BY2D8TfT.js","names":[],"sources":["../../lib/routes/bilibili/utils.ts"],"sourcesContent":["import { config } from '@/config';\r\nimport md5 from '@/utils/md5';\r\nimport ofetch from '@/utils/ofetch';\r\nimport { art } from '@/utils/render';\r\nimport CryptoJS from 'crypto-js';\r\nimport path from 'node:path';\r\nimport { MediaResult, ResultResponse, SeasonResult } from './types';\r\n\r\n// a\r\nfunction randomHexStr(length) {\r\n    let string = '';\r\n    for (let r = 0; r < length; r++) {\r\n        string += dec2HexUpper(16 * Math.random());\r\n    }\r\n    return padStringWithZeros(string, length);\r\n}\r\n\r\n// o\r\nfunction dec2HexUpper(e) {\r\n    return Math.ceil(e).toString(16).toUpperCase();\r\n}\r\n\r\n// s\r\nfunction padStringWithZeros(string, length) {\r\n    let padding = '';\r\n    if (string.length < length) {\r\n        for (let n = 0; n < length - string.length; n++) {\r\n            padding += '0';\r\n        }\r\n    }\r\n    return padding + string;\r\n}\r\n\r\nfunction lsid() {\r\n    const e = Date.now().toString(16).toUpperCase();\r\n    const lsid = randomHexStr(8) + '_' + e;\r\n    return lsid;\r\n}\r\n\r\nfunction _uuid() {\r\n    const e = randomHexStr(8);\r\n    const t = randomHexStr(4);\r\n    const r = randomHexStr(4);\r\n    const n = randomHexStr(4);\r\n    const o = randomHexStr(12);\r\n    const i = Date.now();\r\n    return e + '-' + t + '-' + r + '-' + n + '-' + o + padStringWithZeros((i % 100000).toString(), 5) + 'infoc';\r\n}\r\n\r\n// P\r\nfunction shiftCharByOne(string) {\r\n    let shiftedStr = '';\r\n    for (let n = 0; n < string.length; n++) {\r\n        shiftedStr += String.fromCharCode(string.charCodeAt(n) - 1);\r\n    }\r\n    return shiftedStr;\r\n}\r\n\r\n// o\r\nfunction hexsign(e) {\r\n    const n = 'YhxToH[2q';\r\n    const r = CryptoJS.HmacSHA256('ts'.concat(e), shiftCharByOne(n));\r\n    const o = CryptoJS.enc.Hex.stringify(r);\r\n    return o;\r\n}\r\n\r\nfunction addRenderData(params, renderData) {\r\n    return `${params}&w_webid=${encodeURIComponent(renderData)}`;\r\n}\r\n\r\nfunction addWbiVerifyInfo(params, wbiVerifyString) {\r\n    const searchParams = new URLSearchParams(params);\r\n    searchParams.sort();\r\n    const verifyParam = searchParams.toString();\r\n    const wts = Math.round(Date.now() / 1000);\r\n    const w_rid = md5(`${verifyParam}&wts=${wts}${wbiVerifyString}`);\r\n    return `${params}&w_rid=${w_rid}&wts=${wts}`;\r\n}\r\n\r\n// https://github.com/errcw/gaussian/blob/master/lib/box-muller.js\r\nfunction generateGaussianInteger(mean, std) {\r\n    const _2PI = Math.PI * 2;\r\n    const u1 = Math.random();\r\n    const u2 = Math.random();\r\n\r\n    const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(_2PI * u2);\r\n\r\n    return Math.round(z0 * std + mean);\r\n}\r\n\r\nfunction getDmImgList() {\r\n    if (config.bilibili.dmImgList !== undefined) {\r\n        const dmImgList = JSON.parse(config.bilibili.dmImgList);\r\n        return JSON.stringify([dmImgList[Math.floor(Math.random() * dmImgList.length)]]);\r\n    }\r\n    const x = Math.max(generateGaussianInteger(1245, 5), 0);\r\n    const y = Math.max(generateGaussianInteger(1285, 5), 0);\r\n    const path = [\r\n        {\r\n            x: 3 * x + 2 * y,\r\n            y: 4 * x - 5 * y,\r\n            z: 0,\r\n            timestamp: Math.max(generateGaussianInteger(30, 5), 0),\r\n            type: 0,\r\n        },\r\n    ];\r\n    return JSON.stringify(path);\r\n}\r\n\r\nfunction getDmImgInter() {\r\n    if (config.bilibili.dmImgInter !== undefined) {\r\n        const dmImgInter = JSON.parse(config.bilibili.dmImgInter);\r\n        return JSON.stringify([dmImgInter[Math.floor(Math.random() * dmImgInter.length)]]);\r\n    }\r\n    const p1 = getDmImgInterWh(274, 601);\r\n    const s1 = getDmImgInterOf(134, 30);\r\n    const p2 = getDmImgInterWh(332, 64);\r\n    const s2 = getDmImgInterOf(1101, 338);\r\n    const of = getDmImgInterOf(0, 0);\r\n    const wh = getDmImgInterWh(1245, 1285);\r\n    const ds = [\r\n        {\r\n            t: getDmImgInterT('div'),\r\n            c: getDmImgInterC('clearfix g-search search-container'),\r\n            p: [p1[0], p1[2], p1[1]],\r\n            s: [s1[2], s1[0], s1[1]],\r\n        },\r\n        {\r\n            t: getDmImgInterT('div'),\r\n            c: getDmImgInterC('wrapper'),\r\n            p: [p2[0], p2[2], p2[1]],\r\n            s: [s2[2], s2[0], s2[1]],\r\n        },\r\n    ];\r\n    return JSON.stringify({ ds, wh, of });\r\n}\r\n\r\nfunction getDmImgInterT(tag: string) {\r\n    return {\r\n        a: 4,\r\n        article: 29,\r\n        button: 7,\r\n        div: 2,\r\n        em: 27,\r\n        form: 17,\r\n        h1: 11,\r\n        h2: 12,\r\n        h3: 13,\r\n        h4: 14,\r\n        h5: 15,\r\n        h6: 16,\r\n        img: 5,\r\n        input: 6,\r\n        label: 25,\r\n        li: 10,\r\n        ol: 9,\r\n        option: 20,\r\n        p: 3,\r\n        section: 28,\r\n        select: 19,\r\n        span: 1,\r\n        strong: 26,\r\n        table: 21,\r\n        td: 23,\r\n        textarea: 18,\r\n        th: 24,\r\n        tr: 22,\r\n        ul: 8,\r\n    }[tag];\r\n}\r\n\r\nfunction getDmImgInterC(className: string) {\r\n    return Buffer.from(className).toString('base64').slice(0, -2);\r\n}\r\n\r\nfunction getDmImgInterOf(top: number, left: number) {\r\n    const seed = Math.floor(514 * Math.random());\r\n    return [3 * top + 2 * left + seed, 4 * top - 4 * left + 2 * seed, seed];\r\n}\r\n\r\nfunction getDmImgInterWh(width: number, height: number) {\r\n    const seed = Math.floor(114 * Math.random());\r\n    return [2 * width + 2 * height + 3 * seed, 4 * width - height + seed, seed];\r\n}\r\n\r\nfunction addDmVerifyInfo(params: string, dmImgList: string) {\r\n    const dmImgStr = Buffer.from('no webgl').toString('base64').slice(0, -2);\r\n    const dmCoverImgStr = Buffer.from('no webgl').toString('base64').slice(0, -2);\r\n    return `${params}&dm_img_list=${dmImgList}&dm_img_str=${dmImgStr}&dm_cover_img_str=${dmCoverImgStr}`;\r\n}\r\n\r\nfunction addDmVerifyInfoWithInter(params: string, dmImgList: string, dmImgInter: string) {\r\n    return `${addDmVerifyInfo(params, dmImgList)}&dm_img_inter=${dmImgInter}`;\r\n}\r\n\r\nconst bvidTime = 1_589_990_400;\r\n\r\n/**\r\n * 获取番剧信息并缓存\r\n *\r\n * @param {string} id - 番剧 ID。\r\n * @param cache - 缓存 module。\r\n * @returns {Promise<MediaResult>} 番剧信息。\r\n */\r\nexport const getBangumi = (id: string, cache): Promise<MediaResult> =>\r\n    cache.tryGet(\r\n        `bilibili:getBangumi:${id}`,\r\n        async () => {\r\n            const res = await ofetch<ResultResponse<MediaResult>>('https://api.bilibili.com/pgc/view/web/media', {\r\n                query: {\r\n                    media_id: id,\r\n                },\r\n            });\r\n            if (res.result.share_url === undefined) {\r\n                // reference: https://api.bilibili.com/pgc/review/user?media_id=${id}\r\n                res.result.share_url = `https://www.bilibili.com/bangumi/media/md${res.result.media_id}`;\r\n            }\r\n            return res.result;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    ) as Promise<MediaResult>;\r\n\r\n/**\r\n * 获取番剧分集信息并缓存\r\n *\r\n * @param {string} id - 番剧 ID。\r\n * @param cache - 缓存 module。\r\n * @returns {Promise<SeasonResult>} 番剧分集信息。\r\n */\r\nexport const getBangumiItems = (id: string, cache): Promise<SeasonResult> =>\r\n    cache.tryGet(\r\n        `bilibili:getBangumiItems:${id}`,\r\n        async () => {\r\n            const res = await ofetch<ResultResponse<SeasonResult>>('https://api.bilibili.com/pgc/web/season/section', {\r\n                query: {\r\n                    season_id: id,\r\n                },\r\n            });\r\n            return res.result;\r\n        },\r\n        config.cache.routeExpire,\r\n        false\r\n    ) as Promise<SeasonResult>;\r\n\r\n/**\r\n * 使用模板渲染 UGC（用户生成内容）描述。\r\n *\r\n * @param {boolean} embed - 是否嵌入视频。\r\n * @param {string} img - 要包含在描述中的图片 URL。\r\n * @param {string} description - UGC 的文本描述。\r\n * @param {string} [aid] - 可选。UGC 的 aid。\r\n * @param {string} [cid] - 可选。UGC 的 cid。\r\n * @param {string} [bvid] - 可选。UGC 的 bvid。\r\n * @returns {string} 渲染的 UGC 描述。\r\n *\r\n * @see https://player.bilibili.com/ 获取更多信息。\r\n */\r\nexport const renderUGCDescription = (embed: boolean, img: string, description: string, aid?: string, cid?: string, bvid?: string): string => {\r\n    // docs: https://player.bilibili.com/\r\n    const rendered = art(path.join(__dirname, 'templates/description.art'), {\r\n        embed,\r\n        ugc: true,\r\n        aid,\r\n        cid,\r\n        bvid,\r\n        img: img.replace('http://', 'https://'),\r\n        description,\r\n    });\r\n    return rendered;\r\n};\r\n\r\n/**\r\n * 使用模板渲染 OGV（原创视频）描述。\r\n *\r\n * @param {boolean} embed - 是否嵌入视频。\r\n * @param {string} img - 要包含在描述中的图片 URL。\r\n * @param {string} description - OGV 的文本描述。\r\n * @param {string} [seasonId] - 可选。OGV 的季 ID。\r\n * @param {string} [episodeId] - 可选。OGV 的集 ID。\r\n * @returns {string} 渲染的 OGV 描述。\r\n *\r\n * @see https://player.bilibili.com/ 获取更多信息。\r\n */\r\nexport const renderOGVDescription = (embed: boolean, img: string, description: string, seasonId?: string, episodeId?: string): string => {\r\n    // docs: https://player.bilibili.com/\r\n    const rendered = art(path.join(__dirname, 'templates/description.art'), {\r\n        embed,\r\n        ogv: true,\r\n        seasonId,\r\n        episodeId,\r\n        img: img.replace('http://', 'https://'),\r\n        description,\r\n    });\r\n    return rendered;\r\n};\r\n\r\nexport function getVideoUrl(bvid: string): string;\r\nexport function getVideoUrl(bvid?: string): string | undefined;\r\nexport function getVideoUrl(bvid?: string): string | undefined {\r\n    return bvid ? `https://www.bilibili.com/blackboard/newplayer.html?isOutside=true&autoplay=true&danmaku=true&muted=false&highQuality=true&bvid=${bvid}` : undefined;\r\n}\r\nexport const getLiveUrl = (roomId?: string) => (roomId ? `https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=${roomId}` : undefined);\r\n\r\nexport default {\r\n    lsid,\r\n    _uuid,\r\n    hexsign,\r\n    addWbiVerifyInfo,\r\n    getDmImgList,\r\n    getDmImgInter,\r\n    addDmVerifyInfo,\r\n    addDmVerifyInfoWithInter,\r\n    bvidTime,\r\n    addRenderData,\r\n    getBangumi,\r\n    getBangumiItems,\r\n    renderUGCDescription,\r\n    renderOGVDescription,\r\n    getVideoUrl,\r\n};\r\n"],"mappings":"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"}