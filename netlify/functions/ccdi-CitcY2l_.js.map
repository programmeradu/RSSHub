{"version":3,"file":"ccdi-CitcY2l_.js","names":["got","c","cache","route: Route"],"sources":["../../lib/routes/gov/ccdi/utils.ts","../../lib/routes/gov/ccdi/index.ts"],"sourcesContent":["import cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport got from '@/utils/got';\r\nimport timezone from '@/utils/timezone';\r\n\r\nimport { CookieJar, Cookie } from 'tough-cookie';\r\nconst cookieJar = new CookieJar();\r\n\r\nconst owner = '中央纪委国家监委网站';\r\nconst rootUrl = 'https://www.ccdi.gov.cn';\r\nconst regex = /(?<key>[A-Z_]+)=(?<value>(?:.*?(?=; max-age)|[\\dA-Fa-f]+))/gm;\r\n\r\nconst parseCookie = async (body) => {\r\n    let m;\r\n    const cookies = [];\r\n    while ((m = regex.exec(body)) !== null) {\r\n        // This is necessary to avoid infinite loops with zero-width matches\r\n        if (m.index === regex.lastIndex) {\r\n            regex.lastIndex++;\r\n        }\r\n        const { key, value } = m.groups;\r\n        cookies.push(new Cookie({ key, value }));\r\n    }\r\n    await Promise.all(cookies.map((c) => cookieJar.setCookie(c, rootUrl)));\r\n};\r\n\r\nconst parseNewsList = async (url, selector, ctx) => {\r\n    const response = await got(url, { cookieJar });\r\n    const data = response.data;\r\n    await parseCookie(data);\r\n\r\n    const $ = load(data);\r\n    const list = $(selector)\r\n        .slice(0, ctx.req.query('limit') ? Number.parseInt(ctx.req.query('limit')) : 20)\r\n        .toArray()\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.find('a').first().text().trim(),\r\n                link: new URL(item.find('a').first().attr('href'), url).href,\r\n                pubDate: parseDate(item.find('.more').text(), 'YYYY-MM-DD'),\r\n            };\r\n        });\r\n    const title = $('.other_Location')\r\n        .text()\r\n        .replace(/(.+)首页/, owner);\r\n    return { list, title };\r\n};\r\n\r\nconst changeTrCookie = async () => {\r\n    const cookies = await cookieJar.getCookies(rootUrl);\r\n    const c = cookies.find((c) => c.key === 'HOY_TR');\r\n    if (c) {\r\n        const value = c.value;\r\n        const tr_array = value.split(',');\r\n        const csr = tr_array[0];\r\n        const cnv = [...tr_array[1]];\r\n        const otr = [...tr_array[2]];\r\n        otr[0] = csr.charAt(Number.parseInt(cnv[0], 16));\r\n        const nc = new Cookie({ key: 'HOY_TR', value: csr + ',' + cnv.join('') + ',' + otr.join('') + ',0' });\r\n        await cookieJar.setCookie(nc, rootUrl);\r\n    }\r\n};\r\n\r\nconst parseArticle = async (item) => {\r\n    await changeTrCookie();\r\n    return cache.tryGet(item.link, async () => {\r\n        const response = await got(item.link, { cookieJar });\r\n        const data = response.data;\r\n        await parseCookie(data);\r\n\r\n        const $ = load(data);\r\n        const title = $('.daty, .source-box').text().trim();\r\n        item.author = title.match(/来源：(.*)发布时间/s)?.[1].trim() ?? owner;\r\n        item.pubDate = timezone(parseDate(title.match(/发布时间：(.*)分享/s)?.[1].trim() ?? item.pubDate), +8);\r\n\r\n        // Change the img src from relative to absolute for a better compatibility\r\n        $('.content, .bom-box')\r\n            .find('img')\r\n            .each((_, el) => {\r\n                $(el).attr('src', new URL($(el).attr('src'), item.link).href);\r\n                // oldsrc is causing freshrss imageproxy not to work correctly\r\n                $(el).removeAttr('oldsrc').removeAttr('alt');\r\n            });\r\n        item.description = $('.content, .bom-box').html();\r\n        return item;\r\n    });\r\n};\r\n\r\nexport { rootUrl, parseNewsList, parseArticle };\r\n","import { Route } from '@/types';\r\nimport { getSubPath } from '@/utils/common-utils';\r\nimport { rootUrl, parseNewsList, parseArticle } from './utils';\r\n\r\nexport const route: Route = {\r\n    path: '/ccdi/*',\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const defaultPath = '/yaowenn/';\r\n\r\n    let pathname = getSubPath(ctx).replaceAll(/(^\\/ccdi|\\/$)/g, '');\r\n    pathname = pathname === '' ? defaultPath : pathname.endsWith('/') ? pathname : pathname + '/';\r\n    const currentUrl = `${rootUrl}${pathname}`;\r\n\r\n    const { list, title } = await parseNewsList(currentUrl, '.list_news_dl2 li', ctx);\r\n    const items = await Promise.all(list.map((item) => parseArticle(item)));\r\n\r\n    return {\r\n        title,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"ugBAOA,MAAM,EAAY,IAAI,EAEhB,EAAQ,aACR,EAAU,0BACV,EAAQ,+DAER,EAAc,KAAO,IAAS,CAChC,IAAI,EACE,EAAU,GAChB,MAAQ,EAAI,EAAM,KAAK,MAAW,MAAM,CAEhC,EAAE,QAAU,EAAM,WAClB,EAAM,YAEV,GAAM,CAAE,MAAK,SAAU,EAAE,OACzB,EAAQ,KAAK,IAAI,EAAO,CAAE,MAAK,WAEnC,MAAM,QAAQ,IAAI,EAAQ,IAAK,GAAM,EAAU,UAAU,EAAG,MAG1D,EAAgB,MAAO,EAAK,EAAU,IAAQ,CAChD,IAAM,EAAW,MAAMA,EAAI,EAAK,CAAE,cAC5B,EAAO,EAAS,KACtB,MAAM,EAAY,GAElB,IAAM,EAAI,EAAK,GACT,EAAO,EAAE,GACV,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,SAAS,EAAI,IAAI,MAAM,UAAY,IAC5E,UACA,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,KAAK,KAAK,QAAQ,OAAO,OACrC,KAAM,IAAI,IAAI,EAAK,KAAK,KAAK,QAAQ,KAAK,QAAS,GAAK,KACxD,QAAS,EAAU,EAAK,KAAK,SAAS,OAAQ,iBAGpD,EAAQ,EAAE,mBACX,OACA,QAAQ,SAAU,GACvB,MAAO,CAAE,OAAM,UAGb,EAAiB,SAAY,CAC/B,IAAM,EAAU,MAAM,EAAU,WAAW,GACrC,EAAI,EAAQ,KAAM,GAAMC,EAAE,MAAQ,UACxC,GAAI,EAAG,CACH,IAAM,EAAQ,EAAE,MACV,EAAW,EAAM,MAAM,KACvB,EAAM,EAAS,GACf,EAAM,CAAC,GAAG,EAAS,IACnB,EAAM,CAAC,GAAG,EAAS,IACzB,EAAI,GAAK,EAAI,OAAO,OAAO,SAAS,EAAI,GAAI,KAC5C,IAAM,EAAK,IAAI,EAAO,CAAE,IAAK,SAAU,MAAO,EAAM,IAAM,EAAI,KAAK,IAAM,IAAM,EAAI,KAAK,IAAM,OAC9F,MAAM,EAAU,UAAU,EAAI,KAIhC,EAAe,KAAO,KACxB,MAAM,IACCC,EAAM,OAAO,EAAK,KAAM,SAAY,CACvC,IAAM,EAAW,MAAMF,EAAI,EAAK,KAAM,CAAE,cAClC,EAAO,EAAS,KACtB,MAAM,EAAY,GAElB,IAAM,EAAI,EAAK,GACT,EAAQ,EAAE,sBAAsB,OAAO,OAa7C,MAZA,GAAK,OAAS,EAAM,MAAM,kBAAkB,GAAG,QAAU,EACzD,EAAK,QAAU,EAAS,EAAU,EAAM,MAAM,kBAAkB,GAAG,QAAU,EAAK,SAAU,GAG5F,EAAE,sBACG,KAAK,OACL,MAAM,EAAG,IAAO,CACb,EAAE,GAAI,KAAK,MAAO,IAAI,IAAI,EAAE,GAAI,KAAK,OAAQ,EAAK,MAAM,MAExD,EAAE,GAAI,WAAW,UAAU,WAAW,SAE9C,EAAK,YAAc,EAAE,sBAAsB,OACpC,KClFFG,EAAe,CACxB,KAAM,UACN,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAEI,EAAW,EAAW,GAAK,WAAW,iBAAkB,IAC5D,EAAW,IAAa,GAAK,YAAc,EAAS,SAAS,KAAO,EAAW,EAAW,IAC1F,IAAM,EAAa,GAAG,IAAU,IAE1B,CAAE,OAAM,SAAU,MAAM,EAAc,EAAY,oBAAqB,GACvE,EAAQ,MAAM,QAAQ,IAAI,EAAK,IAAK,GAAS,EAAa,KAEhE,MAAO,CACH,QACA,KAAM,EACN,KAAM"}