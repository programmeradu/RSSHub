{"version":3,"file":"publications-B5589p8q.js","names":["route: Route","puppeteer","cache","page"],"sources":["../../lib/routes/researchgate/publications.ts"],"sourcesContent":["import { Route } from '@/types';\r\nimport cache from '@/utils/cache';\r\nimport { load } from 'cheerio';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport puppeteer from '@/utils/puppeteer';\r\n\r\nexport const route: Route = {\r\n    path: '/publications/:id',\r\n    radar: [\r\n        {\r\n            source: ['researchgate.net/profile/:username'],\r\n            target: '/publications/:username',\r\n        },\r\n    ],\r\n    name: 'Unknown',\r\n    maintainers: [],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id');\r\n\r\n    const rootUrl = 'https://www.researchgate.net';\r\n    const currentUrl = `${rootUrl}/profile/${id}`;\r\n    const browser = await puppeteer();\r\n    const page = await browser.newPage();\r\n    await page.setRequestInterception(true);\r\n    page.on('request', (request) => {\r\n        request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n    });\r\n    await page.goto(currentUrl);\r\n    const response = await page.evaluate(() => document.documentElement.innerHTML);\r\n    await page.close();\r\n\r\n    const $ = load(response);\r\n\r\n    const list = $('div[itemprop=\"headline\"] a')\r\n        .toArray()\r\n        .slice(0, ctx.req.query('limit') ? Number(ctx.req.query('limit')) : 15)\r\n        .map((item) => {\r\n            item = $(item);\r\n            return {\r\n                title: item.text(),\r\n                link: item.attr('href'),\r\n            };\r\n        });\r\n\r\n    const items = await Promise.all(\r\n        list.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const page = await browser.newPage();\r\n                await page.setRequestInterception(true);\r\n                page.on('request', (request) => {\r\n                    request.resourceType() === 'document' || request.resourceType() === 'script' ? request.continue() : request.abort();\r\n                });\r\n                await page.goto(item.link);\r\n                const detailResponse = await page.evaluate(() => document.documentElement.innerHTML);\r\n                await page.close();\r\n                const content = load(detailResponse);\r\n\r\n                item.doi = content('meta[property=\"citation_doi\"]').attr('content');\r\n                item.pubDate = parseDate(content('meta[property=\"citation_publication_date\"]').attr('content'));\r\n\r\n                const authors = [];\r\n\r\n                content('meta[property=\"citation_author\"]').each(function () {\r\n                    authors.push(content(this).attr('content'));\r\n                });\r\n\r\n                item.author = authors.join(', ');\r\n\r\n                item.description = content('div[itemprop=\"description\"]').html();\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    await browser.close();\r\n\r\n    return {\r\n        title: `${$('meta[property=\"profile:username\"]').attr('content')}'s Publications - ResearchGate`,\r\n        link: currentUrl,\r\n        item: items,\r\n    };\r\n}\r\n"],"mappings":"0RAMA,MAAaA,EAAe,CACxB,KAAM,oBACN,MAAO,CACH,CACI,OAAQ,CAAC,sCACT,OAAQ,4BAGhB,KAAM,UACN,YAAa,GACb,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,MAGnB,EAAa,wCAAsB,IACnC,EAAU,MAAMC,IAChB,EAAO,MAAM,EAAQ,UAC3B,MAAM,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,MAAM,EAAK,KAAK,GAChB,IAAM,EAAW,MAAM,EAAK,aAAe,SAAS,gBAAgB,WACpE,MAAM,EAAK,QAEX,IAAM,EAAI,EAAK,GAET,EAAO,EAAE,8BACV,UACA,MAAM,EAAG,EAAI,IAAI,MAAM,SAAW,OAAO,EAAI,IAAI,MAAM,UAAY,IACnE,IAAK,IACF,EAAO,EAAE,GACF,CACH,MAAO,EAAK,OACZ,KAAM,EAAK,KAAK,WAItB,EAAQ,MAAM,QAAQ,IACxB,EAAK,IAAK,GACNC,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAMC,EAAO,MAAM,EAAQ,UAC3B,MAAMA,EAAK,uBAAuB,IAClC,EAAK,GAAG,UAAY,GAAY,CAC5B,EAAQ,iBAAmB,YAAc,EAAQ,iBAAmB,SAAW,EAAQ,WAAa,EAAQ,UAEhH,MAAMA,EAAK,KAAK,EAAK,MACrB,IAAM,EAAiB,MAAMA,EAAK,aAAe,SAAS,gBAAgB,WAC1E,MAAMA,EAAK,QACX,IAAM,EAAU,EAAK,GAErB,EAAK,IAAM,EAAQ,iCAAiC,KAAK,WACzD,EAAK,QAAU,EAAU,EAAQ,8CAA8C,KAAK,YAEpF,IAAM,EAAU,GAUhB,OARA,EAAQ,oCAAoC,KAAK,UAAY,CACzD,EAAQ,KAAK,EAAQ,MAAM,KAAK,cAGpC,EAAK,OAAS,EAAQ,KAAK,MAE3B,EAAK,YAAc,EAAQ,+BAA+B,OAEnD,MAOnB,OAFA,MAAM,EAAQ,QAEP,CACH,MAAO,GAAG,EAAE,qCAAqC,KAAK,WAAW,gCACjE,KAAM,EACN,KAAM"}