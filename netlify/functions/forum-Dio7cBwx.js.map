{"version":3,"file":"forum-Dio7cBwx.js","names":[],"sources":["../../lib/routes/lkong/forum.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\n\r\nimport { viewForum, viewThread } from './query';\r\n\r\nexport const route: Route = {\r\n    path: '/forum/:id?/:digest?',\r\n    radar: [\r\n        {\r\n            source: ['lkong.com/forum/:id', 'lkong.com/'],\r\n        },\r\n    ],\r\n    name: 'Unknown',\r\n    maintainers: ['nczitzk', 'ma6254'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    const id = ctx.req.param('id') ?? '8';\r\n    const digest = ctx.req.param('digest');\r\n\r\n    const rootUrl = 'https://www.lkong.com';\r\n    const apiUrl = 'https://api.lkong.com/api';\r\n    const currentUrl = `${rootUrl}/forum/${id}`;\r\n\r\n    const response = await got({\r\n        method: 'post',\r\n        url: apiUrl,\r\n        json: viewForum(id),\r\n    });\r\n\r\n    let items = response.data.data[digest ? 'hots' : 'threads'].map((item) => ({\r\n        guid: item.tid,\r\n        title: item.title,\r\n        link: `${rootUrl}/thread/${item.tid}`,\r\n    }));\r\n\r\n    items = await Promise.all(\r\n        items.map((item) =>\r\n            cache.tryGet(item.link, async () => {\r\n                const detailResponse = await got({\r\n                    method: 'post',\r\n                    url: apiUrl,\r\n                    json: viewThread(item.guid, 1),\r\n                });\r\n\r\n                item.author = detailResponse.data.data.thread?.author.name;\r\n                item.pubDate = parseDate(detailResponse.data.data.thread?.dateline);\r\n                item.description = art(path.join(__dirname, 'templates/content.art'), {\r\n                    content: JSON.parse(detailResponse.data.data.posts[0].content),\r\n                });\r\n                delete item.guid;\r\n\r\n                return item;\r\n            })\r\n        )\r\n    );\r\n\r\n    return {\r\n        title: `${response.data.data.forum.name} - 龙空`,\r\n        link: currentUrl,\r\n        item: items,\r\n        description: response.data.data.forumCount.info,\r\n    };\r\n}\r\n"],"mappings":"yfAUA,MAAa,EAAe,CACxB,KAAM,uBACN,MAAO,CACH,CACI,OAAQ,CAAC,sBAAuB,gBAGxC,KAAM,UACN,YAAa,CAAC,UAAW,UACzB,WAGJ,eAAe,EAAQ,EAAK,CACxB,IAAM,EAAK,EAAI,IAAI,MAAM,OAAS,IAC5B,EAAS,EAAI,IAAI,MAAM,UAEvB,EAAU,wBACV,EAAS,4BACT,EAAa,GAAG,EAAQ,SAAS,IAEjC,EAAW,MAAM,EAAI,CACvB,OAAQ,OACR,IAAK,EACL,KAAM,EAAU,KAGhB,EAAQ,EAAS,KAAK,KAAK,EAAS,OAAS,WAAW,IAAK,IAAU,CACvE,KAAM,EAAK,IACX,MAAO,EAAK,MACZ,KAAM,GAAG,EAAQ,UAAU,EAAK,SAwBpC,MArBA,GAAQ,MAAM,QAAQ,IAClB,EAAM,IAAK,GACP,EAAM,OAAO,EAAK,KAAM,SAAY,CAChC,IAAM,EAAiB,MAAM,EAAI,CAC7B,OAAQ,OACR,IAAK,EACL,KAAM,EAAW,EAAK,KAAM,KAUhC,MAPA,GAAK,OAAS,EAAe,KAAK,KAAK,QAAQ,OAAO,KACtD,EAAK,QAAU,EAAU,EAAe,KAAK,KAAK,QAAQ,UAC1D,EAAK,YAAc,EAAI,EAAA,KAAA,EAAA,kCAA+C,CAClE,QAAS,KAAK,MAAM,EAAe,KAAK,KAAK,MAAM,GAAG,WAE1D,OAAO,EAAK,KAEL,MAKZ,CACH,MAAO,GAAG,EAAS,KAAK,KAAK,MAAM,KAAK,OACxC,KAAM,EACN,KAAM,EACN,YAAa,EAAS,KAAK,KAAK,WAAW"}