{"version":3,"file":"now-B4gt2B5W.js","names":[],"sources":["../../lib/routes/qweather/now.ts"],"sourcesContent":["import { Route } from '@/types';\r\n\r\nimport cache from '@/utils/cache';\r\nimport got from '@/utils/got';\r\nimport { art } from '@/utils/render';\r\nimport path from 'node:path';\r\nimport { parseDate } from '@/utils/parse-date';\r\nimport { config } from '@/config';\r\nimport ConfigNotFoundError from '@/errors/types/config-not-found';\r\n\r\nconst rootUrl = 'https://devapi.qweather.com/v7/weather/now?';\r\n\r\nexport const route: Route = {\r\n    path: '/now/:location',\r\n    categories: ['forecast'],\r\n    example: '/qweather/now/广州',\r\n    parameters: { location: 'N' },\r\n    features: {\r\n        requireConfig: [\r\n            {\r\n                name: 'HEFENG_KEY',\r\n                description: '访问 `https://www.qweather.com/` 注册开发 API Key。',\r\n            },\r\n        ],\r\n        requirePuppeteer: false,\r\n        antiCrawler: false,\r\n        supportBT: false,\r\n        supportPodcast: false,\r\n        supportScihub: false,\r\n    },\r\n    name: '实时天气',\r\n    maintainers: ['Rein-Ou'],\r\n    handler,\r\n};\r\n\r\nasync function handler(ctx) {\r\n    if (!config.hefeng.key) {\r\n        throw new ConfigNotFoundError('QWeather RSS is disabled due to the lack of <a href=\"https://docs.rsshub.app/zh/install/config#%E5%92%8C%E9%A3%8E%E5%A4%A9%E6%B0%94\">relevant config</a>');\r\n    }\r\n\r\n    const id = await cache.tryGet('qweather:' + ctx.req.param('location') + ':id', async () => {\r\n        const response = await got(`https://geoapi.qweather.com/v2/city/lookup?location=${ctx.req.param('location')}&key=${config.hefeng.key}`);\r\n        const data = response.data.location.map((loc) => loc);\r\n        return data[0].id;\r\n    });\r\n    const requestUrl = rootUrl + 'key=' + config.hefeng.key + '&location=' + id;\r\n    const responseData = await cache.tryGet(\r\n        'qweather:' + ctx.req.param('location') + ':now',\r\n        async () => {\r\n            const response = await got(requestUrl);\r\n            return response.data;\r\n        },\r\n        3600, // second\r\n        false\r\n    );\r\n\r\n    const data = [responseData.now];\r\n\r\n    const timeObj = parseDate(responseData.updateTime);\r\n\r\n    const time_show = timeObj.toLocaleString();\r\n\r\n    return {\r\n        title: ctx.req.param('location') + '实时天气',\r\n        description: ctx.req.param('location') + '实时天气状况',\r\n        item: data.map((item) => ({\r\n            title: '观测时间：' + time_show,\r\n            description: art(path.join(__dirname, 'templates/now.art'), { item }),\r\n            pubDate: timeObj,\r\n            guid: '位置:' + ctx.req.param('location') + '--时间：' + time_show,\r\n            link: responseData.fxLink,\r\n        })),\r\n        link: responseData.fxLink,\r\n    };\r\n}\r\n"],"mappings":"ohBAUA,MAEa,EAAe,CACxB,KAAM,iBACN,WAAY,CAAC,YACb,QAAS,mBACT,WAAY,CAAE,SAAU,KACxB,SAAU,CACN,cAAe,CACX,CACI,KAAM,aACN,YAAa,iDAGrB,iBAAkB,GAClB,YAAa,GACb,UAAW,GACX,eAAgB,GAChB,cAAe,IAEnB,KAAM,OACN,YAAa,CAAC,WACd,WAGJ,eAAe,EAAQ,EAAK,CACxB,GAAI,CAAC,EAAO,OAAO,IACf,MAAM,IAAI,EAAoB,4JAGlC,IAAM,EAAK,MAAM,EAAM,OAAO,YAAc,EAAI,IAAI,MAAM,YAAc,MAAO,SAAY,CACvF,IAAM,EAAW,MAAM,EAAI,uDAAuD,EAAI,IAAI,MAAM,YAAY,OAAO,EAAO,OAAO,OAC3H,EAAO,EAAS,KAAK,SAAS,IAAK,GAAQ,GACjD,OAAO,EAAK,GAAG,KAEb,EAAa,kDAAmB,EAAO,OAAO,IAAM,aAAe,EACnE,EAAe,MAAM,EAAM,OAC7B,YAAc,EAAI,IAAI,MAAM,YAAc,OAC1C,SAAY,CACR,IAAM,EAAW,MAAM,EAAI,GAC3B,OAAO,EAAS,MAEpB,KACA,IAGE,EAAO,CAAC,EAAa,KAErB,EAAU,EAAU,EAAa,YAEjC,EAAY,EAAQ,iBAE1B,MAAO,CACH,MAAO,EAAI,IAAI,MAAM,YAAc,OACnC,YAAa,EAAI,IAAI,MAAM,YAAc,SACzC,KAAM,EAAK,IAAK,IAAU,CACtB,MAAO,QAAU,EACjB,YAAa,EAAI,EAAA,KAAA,EAAA,8BAA2C,CAAE,SAC9D,QAAS,EACT,KAAM,MAAQ,EAAI,IAAI,MAAM,YAAc,QAAU,EACpD,KAAM,EAAa,UAEvB,KAAM,EAAa"}